# Nixpacks configuration for Flirt Hair & Beauty
# Provides build environment, SQLite3 compilation handled by postinstall script

[phases.setup]
nixPkgs = ['nodejs_22', 'python3', 'python3Packages.setuptools', 'pkg-config', 'sqlite', 'gcc', 'gnumake']

[phases.install]
cmds = ['npm ci']

[phases.build]
cmds = [
  'echo "=== Build Phase Diagnostics ==="',
  'ls -la data/ || echo "âŒ Data directory not found"',
  'ls -la data/*.json 2>/dev/null | wc -l | xargs -I {} echo "ðŸ“ Found {} JSON files"',
  'echo "ðŸ“ Ensuring data files are preserved for runtime..."',
  'mkdir -p /tmp/data-backup',
  'cp -r data/* /tmp/data-backup/ 2>/dev/null || echo "No data files to backup"',
  'echo "ðŸ Checking Python distutils compatibility..."',
  'python3 -c "import distutils; print(\"âœ… distutils available\")" || echo "âš ï¸ distutils missing"',
  'echo "ðŸ”§ Rebuilding SQLite3 for Linux platform..."',
  'npm rebuild sqlite3 --build-from-source || echo "âš ï¸ SQLite3 rebuild failed - will use JSON fallback"',
  'echo "ðŸ“ Restoring data files after build..."',
  'mkdir -p data',
  'cp -r /tmp/data-backup/* data/ 2>/dev/null || echo "No backup files to restore"',
  'ls -la data/ | head -5',
  'echo "âœ… Build complete"'
]

[start]
cmd = 'npm start'