<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FL!RT - Admin Console</title>
    <!-- Flirt Brand Favicon -->
    <link rel="icon" type="image/svg+xml" href="/icons/icon-72x72.svg">
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192x192.png">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    <!-- Google Fonts - Flirt Brand Typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@300;400;600&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js for dashboard charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Flirt Brand Colors - from Style Guide */
            --brand-pink: #F67599;          /* Primary - Pantone 190 C */
            --brand-pink-dark: #e05a7f;     /* Darker pink for hover states */
            --brand-charcoal: #414042;      /* Secondary - Pantone Black 7 C */
            --brand-white: #ffffff;         /* Base color */
            --primary: #F67599;
            --primary-light: rgba(246, 117, 153, 0.12);

            /* Legacy variable mapping */
            --primary-black: #414042;
            --primary-white: #ffffff;
            --accent-pink: #F67599;
            --accent-gold: #F67599;
            --gray-dark: #414042;
            --gray-medium: #6d6e70;
            --gray-light: #f8f8f8;
            --success: #4CAF50;
            --warning: #FF9800;
            --danger: #e74c3c;
            --info: #2196F3;
            --shadow: rgba(65, 64, 66, 0.1);
            --sidebar-width: 260px;
            --text-muted: rgba(65, 64, 66, 0.75);
            --text-subtle: rgba(65, 64, 66, 0.6);
            --border-soft: rgba(65, 64, 66, 0.16);
            --brand-gradient: linear-gradient(135deg, var(--brand-pink) 0%, var(--brand-pink-dark) 100%);
            --surface-muted: #f5f5f5;
            --dark: #414042;
        }

        body {
            font-family: 'Open Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--gray-light);
            color: var(--brand-charcoal);
            line-height: 1.6;
        }

        /* Brand Typography */
        h1, h2, h3, .sidebar-logo, .page-title {
            font-family: 'Josefin Sans', 'Helvetica Neue', Arial, sans-serif;
            letter-spacing: 0.1em;
        }

        /* Layout */
        .admin-layout {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--brand-charcoal);
            color: white;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            transition: transform 0.3s;
            z-index: 100;
        }

        .sidebar-header {
            padding: 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--brand-pink);
            padding: 20px 24px;
            position: relative;
        }

        .sidebar-logo::after {
            content: '';
            position: absolute;
            bottom: -20px;
            left: 0;
            right: 0;
            height: 40px;
            background: var(--brand-pink);
            clip-path: polygon(0 0, 100% 0, 100% 50%, 50% 100%, 0 50%);
        }

        .sidebar-logo img {
            height: 55px;
            width: auto;
            position: relative;
            z-index: 1;
        }

        .sidebar-subtitle {
            font-family: 'Josefin Sans', Arial, sans-serif;
            font-size: 11px;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            color: rgba(255,255,255,0.5);
            margin-top: 30px;
            padding: 0 24px;
            text-align: center;
        }

        .sidebar-nav {
            padding: 20px 0;
        }

        .nav-section {
            padding: 0 20px;
            margin-bottom: 10px;
        }

        .nav-section-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--gray-medium);
            margin-bottom: 10px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            transition: all 0.3s;
            cursor: pointer;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.05);
            color: white;
        }

        .nav-item.active {
            background: rgba(246, 117, 153, 0.1);
            color: var(--brand-pink);
            border-left-color: var(--brand-pink);
        }

        .nav-icon {
            width: 20px;
            height: 20px;
        }

        .nav-badge {
            margin-left: auto;
            background: var(--brand-pink);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            min-height: 100vh;
        }

        /* Top Bar */
        .top-bar {
            background: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px var(--shadow);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .page-title {
            font-size: 24px;
            font-weight: 600;
        }

        .top-bar-actions {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .search-box {
            display: flex;
            align-items: center;
            background: var(--gray-light);
            border-radius: 25px;
            padding: 8px 15px;
            gap: 10px;
        }

        .search-box input {
            border: none;
            background: none;
            outline: none;
            width: 200px;
        }

        .notification-btn {
            position: relative;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
        }

        .notification-dot {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 8px;
            height: 8px;
            background: var(--danger);
            border-radius: 50%;
        }

        .admin-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .admin-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--brand-pink);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .admin-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            min-width: 180px;
            z-index: 1000;
            padding: 8px 0;
        }

        .admin-dropdown.show {
            display: block;
        }

        .admin-dropdown button {
            display: block;
            width: 100%;
            padding: 10px 16px;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            color: var(--brand-charcoal);
        }

        .admin-dropdown button:hover {
            background: var(--gray-light);
        }

        .top-bar-actions {
            position: relative;
        }

        .search-results {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            margin-top: 5px;
            min-width: 300px;
        }

        .search-results.show {
            display: block;
        }

        .search-result-group {
            padding: 8px 0;
            border-bottom: 1px solid var(--border-soft);
        }

        .search-result-group:last-child {
            border-bottom: none;
        }

        .search-result-group-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            padding: 4px 12px;
            text-transform: uppercase;
        }

        .search-result-item {
            padding: 10px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-result-item:hover {
            background: var(--gray-light);
        }

        .search-result-item .icon {
            font-size: 16px;
        }

        .search-result-item .details {
            flex: 1;
        }

        .search-result-item .name {
            font-weight: 500;
            font-size: 14px;
        }

        .search-result-item .meta {
            font-size: 12px;
            color: var(--text-muted);
        }

        .search-no-results {
            padding: 20px;
            text-align: center;
            color: var(--text-muted);
        }

        /* Content Area */
        .content-area {
            padding: 30px;
        }

        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dashboard Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 2px 10px var(--shadow);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .stat-icon.pink { background: rgba(246, 117, 153, 0.1); color: var(--brand-pink); }
        .stat-icon.gold { background: rgba(212, 175, 55, 0.1); color: var(--accent-gold); }
        .stat-icon.green { background: rgba(76, 175, 80, 0.1); color: var(--success); }
        .stat-icon.blue { background: rgba(33, 150, 243, 0.1); color: var(--info); }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary-black);
        }

        .stat-label {
            color: var(--gray-medium);
            font-size: 14px;
        }

        .stat-change {
            font-size: 13px;
            margin-top: 10px;
        }

        .stat-change.positive { color: var(--success); }
        .stat-change.negative { color: var(--danger); }

        /* Data Tables */
        .data-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 2px 10px var(--shadow);
            overflow: hidden;
            margin-bottom: 20px;
        }

        .data-card-header {
            padding: 20px 25px;
            border-bottom: 1px solid var(--gray-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .data-card-title {
            font-size: 18px;
            font-weight: 600;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 15px 20px;
            text-align: left;
            border-bottom: 1px solid var(--gray-light);
        }

        .data-table th {
            background: var(--gray-light);
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            color: var(--gray-medium);
        }

        .data-table tr:hover {
            background: rgba(246, 117, 153, 0.02);
        }

        .data-table tr.customer-row:hover {
            background: rgba(246, 117, 153, 0.08);
            transition: background 0.2s ease;
        }

        .data-table tr.customer-row td:first-child {
            border-left: 3px solid transparent;
            transition: border-color 0.2s ease;
        }

        .data-table tr.customer-row:hover td:first-child {
            border-left-color: var(--brand-pink);
        }

        .data-table .tier-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            margin-top: 2px;
        }

        .data-table .tier-badge.tier-bronze {
            background: linear-gradient(135deg, #CD7F32, #A0522D);
            color: white;
        }

        .data-table .tier-badge.tier-silver {
            background: linear-gradient(135deg, #C0C0C0, #A8A8A8);
            color: #333;
        }

        .data-table .tier-badge.tier-gold {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #333;
        }

        .data-table .tier-badge.tier-platinum {
            background: linear-gradient(135deg, #E5E4E2, #B4B4B4);
            color: #333;
            box-shadow: 0 0 8px rgba(229, 228, 226, 0.5);
        }

        .data-table .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .data-table .avatar-placeholder {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--brand-pink);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        /* Status Badges */
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .status-badge.active { background: rgba(76, 175, 80, 0.1); color: var(--success); }
        .status-badge.pending { background: rgba(255, 152, 0, 0.1); color: var(--warning); }
        .status-badge.completed { background: rgba(33, 150, 243, 0.1); color: var(--info); }
        .status-badge.cancelled { background: rgba(244, 67, 54, 0.1); color: var(--danger); }
        .status-badge.sale { background: rgba(244, 67, 54, 0.1); color: var(--danger); }

        /* Payment status badges */
        .status-badge.status-paid { background: rgba(76, 175, 80, 0.15); color: #388e3c; }
        .status-badge.status-pending { background: rgba(255, 152, 0, 0.15); color: #f57c00; }
        .status-badge.status-unpaid { background: rgba(158, 158, 158, 0.15); color: #757575; }

        /* Action Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--brand-pink);
            color: white;
        }

        .btn-primary:hover {
            background: var(--brand-pink-dark);
        }

        .btn-secondary {
            background: var(--primary-black);
            color: white;
        }

        .btn-outline {
            background: white;
            border: 2px solid var(--gray-light);
            color: var(--gray-dark);
        }

        .btn-outline:hover {
            border-color: var(--brand-pink);
            color: var(--brand-pink);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }

        .action-btns {
            display: flex;
            gap: 8px;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--gray-dark);
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--gray-light);
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--brand-pink);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        /* Higher z-index for stacked modals (e.g., customer modal on top of booking modal) */
        .modal-overlay.stacked {
            z-index: 1100;
        }

        .modal {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlide 0.3s ease;
        }

        @keyframes modalSlide {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            padding: 25px;
            border-bottom: 1px solid var(--gray-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray-medium);
        }

        /* Admin toast */
        .admin-toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1100;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .admin-toast {
            min-width: 240px;
            max-width: 360px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
            padding: 12px 14px;
            border-left: 4px solid var(--brand-pink);
            font-size: 14px;
            color: var(--brand-charcoal);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .admin-toast.success { border-color: var(--success); }
        .admin-toast.error { border-color: var(--danger); }
        .admin-toast .toast-close {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-subtle);
            font-size: 16px;
        }

        .modal-body {
            padding: 25px;
        }

        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid var(--gray-light);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Charts placeholder */
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 2px 10px var(--shadow);
            margin-bottom: 20px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-placeholder {
            height: 300px;
            background: linear-gradient(135deg, var(--gray-light) 0%, #e8e8e8 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-medium);
        }

        /* Dashboard Alert */
        .dashboard-alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .dashboard-alert.error {
            background: #ffebee;
            border: 1px solid #ef9a9a;
            color: #c62828;
        }
        .dashboard-alert.warning {
            background: #fff3e0;
            border: 1px solid #ffcc80;
            color: #ef6c00;
        }
        .dashboard-alert.info {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            color: #1565c0;
        }

        /* Stat card loading state */
        .stat-card.loading .stat-value {
            color: var(--gray-medium);
        }
        .stat-card.error .stat-value {
            color: var(--danger);
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .quick-action-btn {
            background: white;
            border: 2px solid var(--gray-light);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quick-action-btn:hover {
            border-color: var(--brand-pink);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px var(--shadow);
        }

        .quick-action-icon {
            width: 45px;
            height: 45px;
            border-radius: 10px;
            background: rgba(246, 117, 153, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .quick-action-text {
            font-weight: 600;
        }

        /* Filters */
        .filters-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 10px 15px;
            border: 2px solid var(--gray-light);
            border-radius: 8px;
            background: white;
            font-size: 14px;
            cursor: pointer;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gray-light);
            border-radius: 26px;
            transition: 0.3s;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
        }

        .toggle-switch input:checked + .toggle-slider {
            background: var(--success);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        /* Chat Panel */
        .chat-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .chat-item {
            padding: 15px 20px;
            border-bottom: 1px solid var(--gray-light);
            cursor: pointer;
            display: flex;
            gap: 15px;
            transition: background 0.3s;
        }

        .chat-item:hover {
            background: var(--gray-light);
        }

        .chat-item.unread {
            background: rgba(246, 117, 153, 0.05);
        }

        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--brand-pink);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .chat-preview {
            color: var(--gray-medium);
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-time {
            font-size: 12px;
            color: var(--gray-medium);
        }

        .chat-unread-badge {
            background: var(--brand-pink);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
        }

        /* Image Upload */
        .image-upload {
            border: 2px dashed var(--gray-light);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .image-upload:hover {
            border-color: var(--brand-pink);
            background: rgba(246, 117, 153, 0.02);
        }

        .image-preview {
            width: 100px;
            height: 100px;
            border-radius: 10px;
            object-fit: cover;
            margin-top: 15px;
        }

        /* ============================================
           INVOICE MANAGEMENT STYLES
           ============================================ */

        /* Invoice Section Header */
        .invoice-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 24px;
            margin-bottom: 24px;
        }

        .invoice-header-left h1 {
            font-size: 28px;
            font-weight: 600;
            color: var(--brand-charcoal);
            margin-bottom: 4px;
        }

        .invoice-header-left p {
            color: var(--text-muted);
            font-size: 14px;
        }

        .invoice-header-actions {
            display: flex;
            gap: 12px;
        }

        /* Invoice Stats Row */
        .invoice-stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .invoice-stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border: 1px solid var(--border-soft);
            transition: all 0.2s ease;
        }

        .invoice-stat-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .invoice-stat-card .stat-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .invoice-stat-card .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--brand-charcoal);
        }

        .invoice-stat-card .stat-subtext {
            font-size: 13px;
            color: var(--text-subtle);
            margin-top: 4px;
        }

        .invoice-stat-card.highlight {
            background: linear-gradient(135deg, var(--brand-pink) 0%, var(--brand-pink-dark) 100%);
            border: none;
        }

        .invoice-stat-card.highlight .stat-label,
        .invoice-stat-card.highlight .stat-value,
        .invoice-stat-card.highlight .stat-subtext {
            color: white;
        }

        /* Invoice Filters */
        .invoice-filters {
            background: white;
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border: 1px solid var(--border-soft);
        }

        .invoice-filters-row {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .invoice-search-wrapper {
            flex: 1;
            min-width: 280px;
            position: relative;
        }

        .invoice-search-wrapper svg {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-subtle);
            width: 18px;
            height: 18px;
        }

        .invoice-search-input {
            width: 100%;
            padding: 12px 14px 12px 42px;
            border: 2px solid var(--border-soft);
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.2s ease;
            background: var(--gray-light);
        }

        .invoice-search-input:focus {
            outline: none;
            border-color: var(--brand-pink);
            background: white;
            box-shadow: 0 0 0 3px rgba(246, 117, 153, 0.1);
        }

        .invoice-filter-select {
            padding: 12px 36px 12px 14px;
            border: 2px solid var(--border-soft);
            border-radius: 10px;
            font-size: 14px;
            background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23414042' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E") no-repeat right 12px center;
            cursor: pointer;
            transition: all 0.2s ease;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .invoice-filter-select:focus {
            outline: none;
            border-color: var(--brand-pink);
        }

        .invoice-filter-select:hover {
            border-color: var(--brand-pink);
        }

        /* Invoice List Container */
        .invoice-list-wrapper {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border: 1px solid var(--border-soft);
            overflow: hidden;
        }

        .invoice-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-soft);
            background: var(--gray-light);
        }

        .invoice-list-header h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--brand-charcoal);
        }

        .invoice-list-actions {
            display: flex;
            gap: 8px;
        }

        /* Invoice Table */
        .invoice-table {
            width: 100%;
            border-collapse: collapse;
        }

        .invoice-table th {
            padding: 14px 16px;
            text-align: left;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            background: var(--surface-muted);
            border-bottom: 1px solid var(--border-soft);
        }

        .invoice-table td {
            padding: 16px;
            border-bottom: 1px solid var(--border-soft);
            vertical-align: middle;
        }

        .invoice-table tbody tr {
            transition: background 0.15s ease;
        }

        .invoice-table tbody tr:hover {
            background: rgba(246, 117, 153, 0.03);
        }

        .invoice-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* Invoice Row Styles */
        .invoice-number {
            font-weight: 600;
            color: var(--brand-pink);
            font-size: 14px;
        }

        .invoice-customer {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .invoice-customer-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--brand-pink) 0%, var(--brand-pink-dark) 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 13px;
        }

        .invoice-customer-info .name {
            font-weight: 500;
            color: var(--brand-charcoal);
            font-size: 14px;
        }

        .invoice-customer-info .email {
            font-size: 12px;
            color: var(--text-subtle);
        }

        .invoice-amount {
            font-weight: 700;
            font-size: 15px;
            color: var(--brand-charcoal);
        }

        .invoice-date {
            font-size: 13px;
            color: var(--text-muted);
        }

        /* Invoice Status Badges */
        .invoice-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .invoice-status.draft {
            background: rgba(158, 158, 158, 0.12);
            color: #757575;
        }

        .invoice-status.finalized {
            background: rgba(33, 150, 243, 0.12);
            color: #1976d2;
        }

        .invoice-status.sent {
            background: rgba(156, 39, 176, 0.12);
            color: #7b1fa2;
        }

        .invoice-status.cancelled {
            background: rgba(244, 67, 54, 0.12);
            color: #d32f2f;
        }

        .payment-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .payment-status.unpaid {
            background: rgba(255, 152, 0, 0.12);
            color: #f57c00;
        }

        .payment-status.partial {
            background: rgba(255, 193, 7, 0.12);
            color: #ffa000;
        }

        .payment-status.paid {
            background: rgba(76, 175, 80, 0.12);
            color: #388e3c;
        }

        .payment-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        /* Invoice Actions */
        .invoice-actions {
            display: flex;
            gap: 6px;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }

        .invoice-table tbody tr:hover .invoice-actions {
            opacity: 1;
        }

        .invoice-action-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 8px;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            color: var(--text-muted);
        }

        .invoice-action-btn:hover {
            background: var(--surface-muted);
            color: var(--brand-pink);
        }

        .invoice-action-btn.danger:hover {
            background: rgba(244, 67, 54, 0.1);
            color: var(--danger);
        }

        .invoice-action-btn svg {
            width: 16px;
            height: 16px;
        }

        /* Empty State */
        .invoice-empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .invoice-empty-state svg {
            width: 80px;
            height: 80px;
            color: var(--border-soft);
            margin-bottom: 16px;
        }

        .invoice-empty-state h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--brand-charcoal);
            margin-bottom: 8px;
        }

        .invoice-empty-state p {
            color: var(--text-muted);
            font-size: 14px;
            margin-bottom: 20px;
        }

        /* Invoice Modal Redesign */
        .modal.invoice-modal-content {
            max-width: 1100px;
            width: 95%;
            max-height: 92vh;
            border-radius: 16px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .invoice-modal-header {
            padding: 20px 24px;
            background: linear-gradient(135deg, var(--brand-pink) 0%, var(--brand-pink-dark) 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .invoice-modal-header h2 {
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .invoice-modal-header .modal-close {
            color: white;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .invoice-modal-header .modal-close:hover {
            opacity: 1;
        }

        .invoice-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        /* Invoice Form Layout */
        .invoice-form-layout {
            display: grid;
            grid-template-columns: 1fr 340px;
            min-height: 100%;
        }

        .invoice-form-main {
            padding: 24px;
            border-right: 1px solid var(--border-soft);
            overflow-y: auto;
        }

        .invoice-form-sidebar {
            background: var(--surface-muted);
            padding: 24px;
            display: flex;
            flex-direction: column;
        }

        /* Form Sections */
        .invoice-form-section {
            margin-bottom: 28px;
        }

        .invoice-form-section:last-child {
            margin-bottom: 0;
        }

        .invoice-form-section-title {
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-soft);
        }

        .invoice-form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .invoice-form-group {
            margin-bottom: 16px;
        }

        .invoice-form-group:last-child {
            margin-bottom: 0;
        }

        .invoice-form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--brand-charcoal);
            margin-bottom: 6px;
        }

        .invoice-form-label .required {
            color: var(--danger);
        }

        .invoice-form-input,
        .invoice-form-select,
        .invoice-form-textarea {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid var(--border-soft);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s ease;
            background: white;
        }

        .invoice-form-input:focus,
        .invoice-form-select:focus,
        .invoice-form-textarea:focus {
            outline: none;
            border-color: var(--brand-pink);
            box-shadow: 0 0 0 3px rgba(246, 117, 153, 0.1);
        }

        .invoice-form-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23414042' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E") no-repeat right 12px center;
            padding-right: 36px;
            cursor: pointer;
        }

        /* Line Items */
        .invoice-line-items {
            border: 1px solid var(--border-soft);
            border-radius: 10px;
            overflow: hidden;
            background: white;
        }

        .invoice-line-items-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--surface-muted);
            border-bottom: 1px solid var(--border-soft);
        }

        .invoice-line-items-header h4 {
            font-size: 14px;
            font-weight: 600;
            color: var(--brand-charcoal);
        }

        .invoice-add-item-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: var(--brand-pink);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .invoice-add-item-btn:hover {
            background: var(--brand-pink-dark);
        }

        .invoice-add-item-btn svg {
            width: 14px;
            height: 14px;
        }

        .invoice-line-items-body {
            min-height: 80px;
        }

        .invoice-line-item {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            gap: 12px;
            align-items: center;
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-soft);
        }

        .invoice-line-item:last-child {
            border-bottom: none;
        }

        .invoice-line-item-info h5 {
            font-size: 14px;
            font-weight: 500;
            color: var(--brand-charcoal);
            margin-bottom: 2px;
        }

        .invoice-line-item-info span {
            font-size: 12px;
            color: var(--text-subtle);
        }

        .invoice-line-item-qty {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .invoice-line-item-qty input {
            width: 50px;
            padding: 6px 8px;
            border: 1px solid var(--border-soft);
            border-radius: 6px;
            text-align: center;
            font-size: 13px;
        }

        .invoice-line-item-price {
            font-weight: 600;
            font-size: 14px;
            color: var(--brand-charcoal);
            min-width: 80px;
            text-align: right;
        }

        .invoice-line-item-remove {
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            color: var(--text-subtle);
            cursor: pointer;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .invoice-line-item-remove:hover {
            background: rgba(244, 67, 54, 0.1);
            color: var(--danger);
        }

        .invoice-line-items-empty {
            text-align: center;
            padding: 32px 16px;
            color: var(--text-subtle);
            font-size: 13px;
        }

        .invoice-line-items-empty svg {
            width: 40px;
            height: 40px;
            color: var(--border-soft);
            margin-bottom: 8px;
        }

        /* Sidebar Totals */
        .invoice-totals-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }

        .invoice-totals-card h4 {
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        .invoice-totals-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-soft);
        }

        .invoice-totals-row:last-child {
            border-bottom: none;
        }

        .invoice-totals-row.total {
            padding-top: 14px;
            margin-top: 6px;
            border-top: 2px solid var(--brand-pink);
            border-bottom: none;
        }

        .invoice-totals-row .label {
            font-size: 13px;
            color: var(--text-muted);
        }

        .invoice-totals-row .value {
            font-size: 14px;
            font-weight: 600;
            color: var(--brand-charcoal);
        }

        .invoice-totals-row.total .label {
            font-size: 15px;
            font-weight: 600;
            color: var(--brand-charcoal);
        }

        .invoice-totals-row.total .value {
            font-size: 22px;
            font-weight: 700;
            color: var(--brand-pink);
        }

        .invoice-totals-row.discount .value {
            color: var(--danger);
        }

        .invoice-totals-row.commission {
            background: rgba(76, 175, 80, 0.08);
            margin: 12px -20px 0;
            padding: 12px 20px;
            border-radius: 0 0 12px 12px;
        }

        .invoice-totals-row.commission .value {
            color: var(--success);
        }

        /* Discount Section */
        .invoice-discount-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }

        .invoice-discount-card h4 {
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        .invoice-discount-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .invoice-discount-grid .full-width {
            grid-column: 1 / -1;
        }

        /* Action Buttons */
        .invoice-form-actions {
            margin-top: auto;
            padding-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .invoice-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .invoice-btn-primary {
            background: linear-gradient(135deg, var(--brand-pink) 0%, var(--brand-pink-dark) 100%);
            color: white;
        }

        .invoice-btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(246, 117, 153, 0.4);
        }

        .invoice-btn-secondary {
            background: var(--brand-charcoal);
            color: white;
        }

        .invoice-btn-secondary:hover {
            background: #333;
        }

        .invoice-btn-outline {
            background: transparent;
            border: 2px solid var(--border-soft);
            color: var(--brand-charcoal);
        }

        .invoice-btn-outline:hover {
            border-color: var(--brand-pink);
            color: var(--brand-pink);
        }

        /* Picker Modal Redesign */
        .modal.picker-modal-content {
            max-width: 700px;
            width: 95%;
            max-height: 85vh;
            border-radius: 16px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .picker-modal-header {
            padding: 20px 24px;
            background: var(--surface-muted);
            border-bottom: 1px solid var(--border-soft);
        }

        .picker-modal-header h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .picker-search-wrapper {
            position: relative;
        }

        .picker-search-wrapper svg {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-subtle);
            width: 18px;
            height: 18px;
        }

        .picker-search-input {
            width: 100%;
            padding: 12px 14px 12px 42px;
            border: 2px solid var(--border-soft);
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .picker-search-input:focus {
            outline: none;
            border-color: var(--brand-pink);
        }

        .picker-list {
            max-height: 450px;
            overflow-y: auto;
            padding: 12px;
        }

        .picker-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.15s ease;
            border: 1px solid transparent;
            margin-bottom: 8px;
        }

        .picker-item:hover {
            background: rgba(246, 117, 153, 0.06);
            border-color: var(--brand-pink);
        }

        .picker-item:last-child {
            margin-bottom: 0;
        }

        .picker-item-info h5 {
            font-size: 14px;
            font-weight: 500;
            color: var(--brand-charcoal);
            margin-bottom: 4px;
        }

        .picker-item-info span {
            font-size: 12px;
            color: var(--text-subtle);
        }

        .picker-item-price {
            font-size: 16px;
            font-weight: 700;
            color: var(--brand-pink);
        }

        .picker-item-stock {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(76, 175, 80, 0.1);
            color: var(--success);
        }

        .picker-item-stock.low {
            background: rgba(255, 152, 0, 0.1);
            color: var(--warning);
        }

        .picker-item-stock.out {
            background: rgba(244, 67, 54, 0.1);
            color: var(--danger);
        }

        /* Payment Modal */
        .modal.payment-modal-content {
            max-width: 480px;
            width: 95%;
            border-radius: 16px;
        }

        .payment-modal-header {
            padding: 20px 24px;
            background: linear-gradient(135deg, var(--success) 0%, #2e7d32 100%);
            color: white;
        }

        .payment-modal-header h3 {
            font-size: 18px;
            font-weight: 600;
        }

        .payment-amount-display {
            text-align: center;
            padding: 24px;
            background: var(--surface-muted);
            border-bottom: 1px solid var(--border-soft);
        }

        .payment-amount-display .label {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .payment-amount-display .amount {
            font-size: 36px;
            font-weight: 700;
            color: var(--danger);
        }

        .payment-form-body {
            padding: 24px;
        }

        @media (max-width: 900px) {
            .invoice-stats-row {
                grid-template-columns: repeat(2, 1fr);
            }

            .invoice-form-layout {
                grid-template-columns: 1fr;
            }

            .invoice-form-sidebar {
                border-top: 1px solid var(--border-soft);
            }

            .invoice-form-row {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 600px) {
            .invoice-stats-row {
                grid-template-columns: 1fr;
            }

            .invoice-filters-row {
                flex-direction: column;
            }

            .invoice-search-wrapper {
                min-width: 100%;
            }

            .invoice-filter-select {
                width: 100%;
            }
        }

        /* ============================================
           MOBILE RESPONSIVE STYLES
           ============================================ */

        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            color: var(--brand-charcoal);
        }

        /* Sidebar overlay for mobile */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 998;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sidebar-overlay.show {
            display: block;
            opacity: 1;
        }

        /* Mobile close button in sidebar */
        .sidebar-close-btn {
            display: none;
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 10;
        }

        .sidebar-close-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        /* Tablet and below */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
                z-index: 999;
                transition: transform 0.3s ease;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .sidebar-close-btn {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .main-content {
                margin-left: 0;
            }

            .mobile-menu-btn {
                display: block;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            /* Top bar adjustments */
            .top-bar {
                padding: 12px 15px;
            }

            .page-title {
                font-size: 18px;
            }

            .search-box {
                display: none;
            }

            /* Stats grid mobile */
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            /* Quick actions mobile */
            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Phone specific */
        @media (max-width: 768px) {
            /* Table responsiveness */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin: 0 -15px;
                padding: 0 15px;
            }

            .data-table {
                min-width: 600px;
            }

            .data-table th,
            .data-table td {
                padding: 10px 12px;
                font-size: 13px;
            }

            /* Filter tabs scroll */
            .status-filter-tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 5px;
            }

            .status-filter-tab {
                white-space: nowrap;
                flex-shrink: 0;
            }

            /* Action buttons stack on mobile */
            .action-buttons {
                flex-direction: column;
                gap: 8px;
            }

            .action-buttons .btn {
                width: 100%;
                justify-content: center;
            }

            /* Card adjustments */
            .card {
                padding: 15px;
                margin-bottom: 15px;
            }

            /* Stats grid single column on small phones */
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }

            .stat-card {
                padding: 15px;
            }

            .stat-value {
                font-size: 24px;
            }

            /* Section headers */
            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            /* Quick actions single column */
            .quick-actions {
                grid-template-columns: 1fr;
            }

            /* Calendar mobile */
            .calendar-grid {
                grid-template-columns: repeat(7, 1fr);
            }

            .calendar-day {
                min-height: 60px;
                padding: 5px;
                font-size: 11px;
            }

            .calendar-day-header {
                padding: 5px;
                font-size: 10px;
            }

            /* Modal mobile fullscreen */
            .modal-content {
                width: 100%;
                max-width: 100%;
                height: 100%;
                max-height: 100%;
                margin: 0;
                border-radius: 0;
            }

            /* Filter panel mobile */
            .filter-panel {
                flex-direction: column;
                gap: 10px;
            }

            .filter-panel select,
            .filter-panel input {
                width: 100%;
            }

            /* Booking detail row on mobile */
            .booking-detail-row {
                flex-direction: column;
                gap: 5px;
            }
        }

        /* Very small phones */
        @media (max-width: 400px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .top-bar-actions {
                gap: 5px;
            }

            .page-title {
                font-size: 16px;
            }

            .data-table th,
            .data-table td {
                padding: 8px 10px;
                font-size: 12px;
            }
        }

        /* Calendar View */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day-header {
            padding: 10px;
            text-align: center;
            font-weight: 600;
            font-size: 12px;
            color: var(--gray-medium);
        }

        .calendar-day {
            min-height: 100px;
            padding: 10px;
            background: white;
            border: 1px solid var(--gray-light);
            border-radius: 8px;
        }

        .calendar-day-number {
            font-weight: 600;
            margin-bottom: 8px;
        }

        .calendar-event {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 4px;
            margin-bottom: 4px;
            background: rgba(246, 117, 153, 0.1);
            color: var(--brand-pink);
        }

        /* Inventory indicators */
        .stock-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stock-bar {
            flex: 1;
            height: 8px;
            background: var(--gray-light);
            border-radius: 4px;
            overflow: hidden;
        }

        .stock-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s;
        }

        .stock-fill.high { background: var(--success); }
        .stock-fill.medium { background: var(--warning); }
        .stock-fill.low { background: var(--danger); }

        /* Gallery Admin Styles */
        .gallery-admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
        }

        .gallery-admin-item {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            background: var(--gray-light);
            aspect-ratio: 1;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .gallery-admin-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .gallery-admin-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .gallery-admin-item.inactive {
            opacity: 0.5;
        }

        .gallery-admin-item.inactive::after {
            content: 'HIDDEN';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .gallery-admin-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            padding: 40px 12px 12px;
            color: white;
        }

        .gallery-admin-label {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .gallery-admin-category {
            font-size: 11px;
            opacity: 0.8;
            text-transform: uppercase;
        }

        .gallery-admin-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 4px;
        }

        .gallery-action-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .gallery-action-btn:hover {
            transform: scale(1.1);
        }

        .gallery-action-btn.edit {
            background: var(--brand-pink);
            color: white;
        }

        .gallery-action-btn.toggle {
            background: white;
            color: var(--gray-dark);
        }

        .gallery-action-btn.delete {
            background: var(--danger);
            color: white;
        }

        .gallery-action-btn svg {
            width: 14px;
            height: 14px;
        }

        /* Time Slot Schedule */
        .time-slots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }

        .time-slot {
            padding: 12px 8px;
            border: 2px solid var(--gray-light);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            font-weight: 500;
        }

        .time-slot:hover:not(.booked):not(.selected) {
            border-color: var(--primary);
            background: rgba(246, 117, 153, 0.05);
        }

        .time-slot.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        .time-slot.booked {
            background: var(--gray-light);
            color: var(--gray-medium);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .time-slot.booked::after {
            content: ' ✗';
            font-size: 10px;
        }

        /* Status Filter Tabs */
        .status-filter-tab {
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            padding: 12px 20px;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-muted);
            transition: all 0.2s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-filter-tab:hover {
            color: var(--brand-charcoal);
            border-bottom-color: var(--border-strong);
        }

        .status-filter-tab.active {
            color: var(--brand-pink);
            border-bottom-color: var(--brand-pink);
        }

        .filter-count {
            background: var(--surface-muted);
            color: var(--text-muted);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            min-width: 24px;
            text-align: center;
        }

        .status-filter-tab.active .filter-count {
            background: var(--brand-pink);
            color: white;
        }

        /* ============================================ */
        /* INVOICE SYSTEM STYLES */
        /* ============================================ */
        .line-items-container {
            border: 1px solid var(--border-soft);
            border-radius: 8px;
            overflow: hidden;
        }

        .line-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-soft);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }

        .line-item:hover {
            background: var(--surface-muted);
        }

        .line-item:last-child {
            border-bottom: none;
        }

        .line-item-info {
            flex: 1;
        }

        .line-item-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .line-item-details {
            font-size: 13px;
            color: var(--text-subtle);
        }

        .line-item-price {
            font-weight: 700;
            color: var(--primary);
            font-size: 16px;
            margin-right: 16px;
        }

        .line-item-remove {
            background: var(--danger);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }

        .line-item-remove:hover {
            opacity: 0.8;
        }

        .service-picker-item, .product-picker-item {
            padding: 12px;
            border: 1px solid var(--border-soft);
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .service-picker-item:hover, .product-picker-item:hover {
            background: var(--primary-light);
            border-color: var(--primary);
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success { background: rgba(76, 175, 80, 0.12); color: var(--success); }
        .badge-warning { background: rgba(255, 152, 0, 0.12); color: var(--warning); }
        .badge-danger { background: rgba(231, 76, 60, 0.12); color: var(--danger); }
        .badge-info { background: rgba(33, 150, 243, 0.12); color: var(--info); }
        .badge-secondary { background: var(--surface-muted); color: var(--text-muted); }
    </style>

    <!-- Booking Constants (shared with client app) -->
    <script src="/shared/booking-constants.js"></script>
</head>
<body>
    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <button class="sidebar-close-btn" onclick="closeSidebar()" aria-label="Close menu">×</button>
            <div class="sidebar-header">
                <div class="sidebar-logo"><img src="Flirt pink logo 2.jpeg" alt="FL!RT Hair & Beauty Bar"></div>
                <div class="sidebar-subtitle">Admin Console</div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Overview</div>
                </div>
                <a class="nav-item active" onclick="showSection('dashboard', event)">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                    Dashboard
                </a>

                <div class="nav-section" style="margin-top: 20px;">
                    <div class="nav-section-title">Management</div>
                </div>
                <a class="nav-item" onclick="showSection('bookings', event)">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    Bookings
                    <span class="nav-badge" id="bookingsNavBadge">0</span>
                </a>
                <a class="nav-item" onclick="showSection('team', event)">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    Team
                </a>
                <a class="nav-item" onclick="showSection('payroll', event)">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                        <line x1="1" y1="10" x2="23" y2="10"></line>
                    </svg>
                    Payroll
                </a>
                <a class="nav-item" onclick="showSection('services', event)">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                        <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
                    </svg>
                    Services
                </a>
                <a class="nav-item" onclick="showSection('customers', event)">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    Customers
                </a>
                <a class="nav-item" onclick="showSection('products', event)">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="16.5" y1="9.4" x2="7.5" y2="4.21"></line>
                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                    </svg>
                    Products
                </a>
                <a class="nav-item" onclick="showSection('orders', event)">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="9" cy="21" r="1"></circle>
                        <circle cx="20" cy="21" r="1"></circle>
                        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                    </svg>
                    Orders
                    <span class="nav-badge" id="pending-orders-count" style="display: none;">0</span>
                </a>
                <a class="nav-item" onclick="showSection('invoices', event)">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                    Invoices
                    <span class="nav-badge" id="unpaid-invoices-count" style="display: none;">0</span>
                </a>
                <a class="nav-item" onclick="showSection('commissions', event)">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="1" x2="12" y2="23"></line>
                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                    </svg>
                    Commissions
                </a>

                <div class="nav-section" style="margin-top: 20px;">
                    <div class="nav-section-title">Marketing</div>
                </div>
                <a class="nav-item" onclick="showSection('promotions', event)">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                    </svg>
                    Promotions
                </a>
                <a class="nav-item" onclick="showSection('notifications', event)">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                    </svg>
                    Push Notifications
                </a>
                <a class="nav-item" onclick="showSection('gallery', event)">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                        <polyline points="21 15 16 10 5 21"></polyline>
                    </svg>
                    Gallery
                </a>
                <a class="nav-item" onclick="showSection('chat', event)">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    Chat
                    <span class="nav-badge" style="display: none;"></span>
                </a>
                <a class="nav-item" onclick="showSection('hair-tips', event)">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="16" x2="12" y2="12"></line>
                        <line x1="12" y1="8" x2="12.01" y2="8"></line>
                    </svg>
                    Hair Care Tips
                </a>

                <div class="nav-section" style="margin-top: 20px;">
                    <div class="nav-section-title">Settings</div>
                </div>
                <a class="nav-item" onclick="showSection('rewards-settings', event)">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="8" r="7"></circle>
                        <polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline>
                    </svg>
                    Rewards Programme
                </a>
                <a class="nav-item" onclick="showSection('hair-tracker-settings', event)">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path>
                        <path d="M22 12A10 10 0 0 0 12 2v10z"></path>
                    </svg>
                    Hair Tracker Settings
                </a>
                <a class="nav-item" onclick="showSection('payment-settings', event)">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                        <line x1="1" y1="10" x2="23" y2="10"></line>
                    </svg>
                    Payment Settings
                </a>
                <a class="nav-item" onclick="showSection('business-settings', event)">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                    Business Details
                </a>
                <a class="nav-item admin-only" onclick="showSection('staff', event)">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    Staff
                </a>
                <a class="nav-item" onclick="showSection('settings', event)">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                    Settings
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <header class="top-bar">
                <div style="display: flex; align-items: center; gap: 20px;">
                    <button class="mobile-menu-btn" onclick="toggleSidebar()">☰</button>
                    <h1 class="page-title" id="pageTitle">Dashboard</h1>
                </div>
                <div class="top-bar-actions">
                    <div class="search-box" style="position: relative;">
                        <span>🔍</span>
                        <input type="search" id="globalSearch" placeholder="Search customers, bookings..." autocomplete="off" autocorrect="off" spellcheck="false" aria-label="Search" oninput="handleGlobalSearch(event)" onkeydown="handleSearchKeydown(event)">
                        <div class="search-results" id="searchResults"></div>
                    </div>
                    <button class="notification-btn" onclick="showSection('notifications')" title="View Notifications">
                        🔔
                        <span class="notification-dot" id="notificationDot"></span>
                    </button>
                    <div class="admin-profile" onclick="toggleAdminMenu()" title="Account Menu">
                        <div class="admin-avatar" id="adminAvatar">A</div>
                        <span id="adminName" style="font-weight: 500;">Admin</span>
                        <span style="font-size: 10px;">▼</span>
                    </div>
                    <div class="admin-dropdown" id="adminDropdown">
                        <button onclick="showPasswordChangeModal()">🔑 Change Password</button>
                        <button onclick="showSection('settings')">⚙️ Settings</button>
                        <hr style="margin: 5px 0; border: none; border-top: 1px solid var(--border-soft);">
                        <button onclick="logout()" style="color: var(--danger);">🚪 Logout</button>
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Dashboard Section -->
                <section id="dashboard" class="page-section active">
                    <!-- Dashboard Alert Area -->
                    <div id="dashboardAlert" class="dashboard-alert" style="display: none;"></div>

                    <!-- Stats Grid -->
                    <div class="stats-grid">
                        <div class="stat-card" id="statCardRevenue">
                            <div class="stat-card-header">
                                <div>
                                    <div class="stat-value" id="statMonthRevenue">Loading...</div>
                                    <div class="stat-label">Revenue This Month</div>
                                </div>
                                <div class="stat-icon pink">💰</div>
                            </div>
                            <div class="stat-change" id="statRevenueChange"></div>
                        </div>
                        <div class="stat-card" id="statCardBookings">
                            <div class="stat-card-header">
                                <div>
                                    <div class="stat-value" id="statMonthBookings">Loading...</div>
                                    <div class="stat-label">Bookings This Month</div>
                                </div>
                                <div class="stat-icon gold">📅</div>
                            </div>
                            <div class="stat-change" id="statBookingsChange"></div>
                        </div>
                        <div class="stat-card" id="statCardOrders">
                            <div class="stat-card-header">
                                <div>
                                    <div class="stat-value" id="statMonthOrders">Loading...</div>
                                    <div class="stat-label">Product Orders This Month</div>
                                </div>
                                <div class="stat-icon green">📦</div>
                            </div>
                            <div class="stat-change" id="statOrdersChange"></div>
                        </div>
                        <div class="stat-card" id="statCardCustomers">
                            <div class="stat-card-header">
                                <div>
                                    <div class="stat-value" id="statActiveCustomers">Loading...</div>
                                    <div class="stat-label">Active Customers</div>
                                </div>
                                <div class="stat-icon blue">👥</div>
                            </div>
                            <div class="stat-change" id="statCustomersChange"></div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <h3 style="margin-bottom: 15px;">Quick Actions</h3>
                    <div class="quick-actions">
                        <button class="quick-action-btn" onclick="openAdminBookingModal()">
                            <div class="quick-action-icon">➕</div>
                            <div class="quick-action-text">New Booking</div>
                        </button>
                        <button class="quick-action-btn" onclick="openAddProductModal()">
                            <div class="quick-action-icon">📦</div>
                            <div class="quick-action-text">Add Product</div>
                        </button>
                        <button class="quick-action-btn" onclick="openModal('addPromoModal')">
                            <div class="quick-action-icon">🏷️</div>
                            <div class="quick-action-text">Create Promo</div>
                        </button>
                        <button class="quick-action-btn" onclick="showSection('chat')">
                            <div class="quick-action-icon">💬</div>
                            <div class="quick-action-text">View Messages</div>
                        </button>
                    </div>

                    <!-- Today's Bookings -->
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Today's Bookings</h3>
                            <button class="btn btn-outline btn-sm" onclick="viewTodayBookings()">View All</button>
                        </div>
                        <table class="data-table" id="todayBookingsTable">
                            <thead>
                                <tr>
                                    <th>Client</th>
                                    <th>Service</th>
                                    <th>Stylist</th>
                                    <th>Time</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="todayBookingsBody">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 30px; color: var(--gray-medium);">
                                        Loading today's bookings...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Charts Row -->
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
                        <div class="chart-container" id="revenueChartContainer">
                            <div class="chart-header">
                                <h3>Revenue Overview</h3>
                                <select class="filter-select" id="revenueChartRange" onchange="loadRevenueChart()">
                                    <option value="30d">Last 30 Days</option>
                                    <option value="7d">Last 7 Days</option>
                                    <option value="90d">Last 90 Days</option>
                                </select>
                            </div>
                            <div class="chart-canvas-wrapper" style="position: relative; height: 250px;">
                                <canvas id="revenueChart"></canvas>
                            </div>
                            <div id="revenueChartError" class="chart-error" style="display: none; text-align: center; padding: 20px; color: var(--danger);">
                                Unable to load chart data
                            </div>
                        </div>
                        <div class="chart-container" id="servicesChartContainer">
                            <div class="chart-header">
                                <h3>Popular Services</h3>
                            </div>
                            <div class="chart-canvas-wrapper" style="position: relative; height: 250px;">
                                <canvas id="servicesChart"></canvas>
                            </div>
                            <div id="servicesChartError" class="chart-error" style="display: none; text-align: center; padding: 20px; color: var(--danger);">
                                Unable to load chart data
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Bookings Section -->
                <section id="bookings" class="page-section">
                    <!-- View Toggle & Actions Bar -->
                    <div class="filters-bar">
                        <div style="display: flex; gap: 10px; margin-right: auto;">
                            <button class="btn btn-sm" id="bookingsListViewBtn" onclick="setBookingsView('list')" style="background: var(--primary); color: white;">List</button>
                            <button class="btn btn-sm btn-outline" id="bookingsCalendarViewBtn" onclick="setBookingsView('calendar')">Calendar</button>
                        </div>
                        <button class="btn btn-outline btn-sm" onclick="exportBookingsToCSV()" title="Export filtered results to CSV">📥 Export CSV</button>
                        <button class="btn btn-primary" onclick="openAdminBookingModal()">+ New Booking</button>
                    </div>

                    <!-- Status Filter Tabs -->
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid var(--border-soft); overflow-x: auto;">
                        <button class="status-filter-tab active" data-status="all" onclick="filterByStatus('all')">
                            All <span class="filter-count" id="count-all">0</span>
                        </button>
                        <button class="status-filter-tab" data-status="REQUESTED" onclick="filterByStatus('REQUESTED')">
                            ⏳ Requested <span class="filter-count" id="count-requested">0</span>
                        </button>
                        <button class="status-filter-tab" data-status="CONFIRMED" onclick="filterByStatus('CONFIRMED')">
                            ✓ Confirmed <span class="filter-count" id="count-confirmed">0</span>
                        </button>
                        <button class="status-filter-tab" data-status="COMPLETED" onclick="filterByStatus('COMPLETED')">
                            ✓✓ Completed <span class="filter-count" id="count-completed">0</span>
                        </button>
                        <button class="status-filter-tab" data-status="CANCELLED" onclick="filterByStatus('CANCELLED')">
                            ✗ Cancelled <span class="filter-count" id="count-cancelled">0</span>
                        </button>
                    </div>

                    <!-- Advanced Filters Bar -->
                    <div class="data-card" style="margin-bottom: 20px; padding: 20px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end;">
                            <!-- Search -->
                            <div style="grid-column: span 2;">
                                <label class="form-label">Search</label>
                                <input type="text" id="bookingsSearchInput" class="form-input" placeholder="Search by name, email, phone, service, ID..." oninput="onBookingsSearchInput(this.value)">
                            </div>

                            <!-- Status Filter -->
                            <div>
                                <label class="form-label">Status</label>
                                <select id="bookingsStatusFilter" class="form-input" onchange="onBookingsFilterChange()">
                                    <option value="all">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="confirmed">Confirmed</option>
                                    <option value="completed">Completed</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                            </div>

                            <!-- Stylist Filter -->
                            <div>
                                <label class="form-label">Stylist</label>
                                <select id="bookingsStylistFilter" class="form-input" onchange="onBookingsFilterChange()">
                                    <option value="all">All Stylists</option>
                                    <!-- Populated dynamically -->
                                </select>
                            </div>

                            <!-- Service Filter -->
                            <div>
                                <label class="form-label">Service</label>
                                <select id="bookingsServiceFilter" class="form-input" onchange="onBookingsFilterChange()">
                                    <option value="all">All Services</option>
                                    <!-- Populated dynamically -->
                                </select>
                            </div>

                            <!-- Time of Day Filter -->
                            <div>
                                <label class="form-label">Time of Day</label>
                                <select id="bookingsTimeFilter" class="form-input" onchange="onBookingsFilterChange()">
                                    <option value="all">All Times</option>
                                    <option value="morning">Morning</option>
                                    <option value="afternoon">Afternoon</option>
                                    <option value="evening">Evening</option>
                                </select>
                            </div>

                            <!-- Date Range Preset -->
                            <div>
                                <label class="form-label">Date Range</label>
                                <select id="bookingsDatePreset" class="form-input" onchange="onBookingsDatePresetChange()">
                                    <option value="all">All Dates</option>
                                    <option value="today">Today</option>
                                    <option value="tomorrow">Tomorrow</option>
                                    <option value="thisweek">This Week</option>
                                    <option value="next7days">Next 7 Days</option>
                                    <option value="custom">Custom Range...</option>
                                </select>
                            </div>

                            <!-- Custom Date From -->
                            <div id="bookingsDateFromGroup" style="display: none;">
                                <label class="form-label">From Date</label>
                                <input type="date" id="bookingsDateFrom" class="form-input" onchange="onBookingsDateRangeChange()">
                            </div>

                            <!-- Custom Date To -->
                            <div id="bookingsDateToGroup" style="display: none;">
                                <label class="form-label">To Date</label>
                                <input type="date" id="bookingsDateTo" class="form-input" onchange="onBookingsDateRangeChange()">
                            </div>

                            <!-- Clear Filters Button -->
                            <div>
                                <button class="btn btn-outline" onclick="clearAllBookingsFilters()" style="width: 100%;">Clear All</button>
                            </div>
                        </div>
                    </div>

                    <!-- List View -->
                    <div id="bookingsListView">
                        <!-- Bulk Actions Bar -->
                        <div id="bookingsBulkActionsBar" class="data-card" style="display: none; margin-bottom: 15px; padding: 15px; background: var(--primary-light); border: 2px solid var(--primary);">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <span style="font-weight: 600; color: var(--primary);" id="bookingsSelectedCount">0 selected</span>
                                <button class="btn btn-sm" onclick="bulkConfirmBookings()" style="background: var(--success); color: white;">✓ Confirm Selected</button>
                                <button class="btn btn-sm" onclick="bulkCompleteBookings()" style="background: var(--info); color: white;">✓ Complete Selected</button>
                                <button class="btn btn-sm btn-outline" onclick="bulkCancelBookings()" style="color: var(--danger); border-color: var(--danger);">✗ Cancel Selected</button>
                                <button class="btn btn-sm btn-outline" onclick="deselectAllBookings()" style="margin-left: auto;">Deselect All</button>
                            </div>
                        </div>

                        <div class="data-card">
                            <div class="data-card-header">
                                <div>
                                    <h3 class="data-card-title">Bookings</h3>
                                    <span style="color: var(--gray-medium); font-size: 13px;" id="bookingsTotalCount">Loading...</span>
                                </div>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 14px; cursor: pointer;">
                                        <input type="checkbox" id="bookingsGroupByDate" onchange="toggleBookingsGrouping()" style="cursor: pointer;">
                                        <span>Group by Date</span>
                                    </label>
                                </div>
                            </div>
                            <div style="overflow-x: auto;">
                                <table class="data-table" id="bookingsTable" style="position: relative;">
                                    <thead style="position: sticky; top: 0; background: white; z-index: 10;">
                                        <tr>
                                            <th style="width: 40px;">
                                                <input type="checkbox" id="bookingsSelectAll" onchange="toggleSelectAllBookings()" title="Select all on this page">
                                            </th>
                                            <th style="width: 80px;">ID</th>
                                            <th style="cursor: pointer;" onclick="sortBookingsBy('customer')">
                                                Client <span id="sortIconCustomer">↕</span>
                                            </th>
                                            <th style="cursor: pointer;" onclick="sortBookingsBy('service')">
                                                Service <span id="sortIconService">↕</span>
                                            </th>
                                            <th style="cursor: pointer;" onclick="sortBookingsBy('stylist')">
                                                Stylist <span id="sortIconStylist">↕</span>
                                            </th>
                                            <th style="cursor: pointer;" onclick="sortBookingsBy('date')">
                                                Date <span id="sortIconDate">↕</span>
                                            </th>
                                            <th>Time</th>
                                            <th style="cursor: pointer;" onclick="sortBookingsBy('status')">
                                                Status <span id="sortIconStatus">↕</span>
                                            </th>
                                            <th>Payment</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="bookingsTableBody">
                                        <tr>
                                            <td colspan="10" style="text-align: center; padding: 40px; color: var(--gray-medium);">
                                                Loading bookings...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Pagination Controls -->
                            <div id="bookingsPagination" class="data-card-footer" style="display: none; justify-content: space-between; align-items: center; padding: 15px; border-top: 1px solid var(--gray-light);">
                                <div style="color: var(--gray-medium); font-size: 14px;" id="bookingsPaginationInfo">
                                    Showing 1-50 of 125
                                </div>
                                <div style="display: flex; gap: 5px;">
                                    <button class="btn btn-sm btn-outline" id="bookingsPrevPage" onclick="goToBookingsPage('prev')" disabled>← Previous</button>
                                    <div id="bookingsPaginationPages" style="display: flex; gap: 5px;">
                                        <!-- Page numbers rendered dynamically -->
                                    </div>
                                    <button class="btn btn-sm btn-outline" id="bookingsNextPage" onclick="goToBookingsPage('next')">Next →</button>
                                </div>
                                <div>
                                    <select id="bookingsPageSize" class="form-input" onchange="onBookingsPageSizeChange()" style="width: auto; padding: 5px 10px; font-size: 13px;">
                                        <option value="25">25 per page</option>
                                        <option value="50" selected>50 per page</option>
                                        <option value="100">100 per page</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Calendar View -->
                    <div id="bookingsCalendarView" style="display: none;">
                        <div class="data-card">
                            <div class="data-card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <button class="btn btn-sm btn-outline" onclick="changeBookingsCalendarPeriod(-1)">◀</button>
                                    <h3 class="data-card-title" id="bookingsCalendarLabel" style="min-width: 200px; text-align: center;">November 2025</h3>
                                    <button class="btn btn-sm btn-outline" onclick="changeBookingsCalendarPeriod(1)">▶</button>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="display: flex; border: 1px solid var(--gray-light); border-radius: 6px; overflow: hidden;">
                                        <button id="calendarDayBtn" class="btn btn-sm" style="border-radius: 0; border: none;" onclick="setCalendarView('day')">Day</button>
                                        <button id="calendarWeekBtn" class="btn btn-sm btn-outline" style="border-radius: 0; border: none; border-left: 1px solid var(--gray-light);" onclick="setCalendarView('week')">Week</button>
                                        <button id="calendarMonthBtn" class="btn btn-sm btn-outline" style="border-radius: 0; border: none; border-left: 1px solid var(--gray-light);" onclick="setCalendarView('month')">Month</button>
                                    </div>
                                    <button class="btn btn-sm btn-outline" onclick="goToCalendarToday()">Today</button>
                                </div>
                            </div>
                            <!-- Status Color Legend -->
                            <div style="padding: 10px 20px; background: var(--gray-light); border-top: 1px solid var(--border-soft); display: flex; flex-wrap: wrap; gap: 12px; align-items: center; font-size: 11px;">
                                <span style="color: var(--gray-medium); font-weight: 600;">Status:</span>
                                <span style="display: flex; align-items: center; gap: 4px;"><span style="width: 10px; height: 10px; border-radius: 50%; background: #9e9e9e;"></span> No Status</span>
                                <span style="display: flex; align-items: center; gap: 4px;"><span style="width: 10px; height: 10px; border-radius: 50%; background: #f9a825;"></span> To Be Confirmed</span>
                                <span style="display: flex; align-items: center; gap: 4px;"><span style="width: 10px; height: 10px; border-radius: 50%; background: #1565c0;"></span> Online Booking</span>
                                <span style="display: flex; align-items: center; gap: 4px;"><span style="width: 10px; height: 10px; border-radius: 50%; background: #4caf50;"></span> Confirmed</span>
                                <span style="display: flex; align-items: center; gap: 4px;"><span style="width: 10px; height: 10px; border-radius: 50%; background: #2e7d32;"></span> Paid</span>
                                <span style="display: flex; align-items: center; gap: 4px;"><span style="width: 10px; height: 10px; border-radius: 50%; background: #9c27b0;"></span> New Extensions</span>
                                <span style="display: flex; align-items: center; gap: 4px;"><span style="width: 10px; height: 10px; border-radius: 50%; background: #ff9800;"></span> Late</span>
                                <span style="display: flex; align-items: center; gap: 4px;"><span style="width: 10px; height: 10px; border-radius: 50%; background: #c62828;"></span> No Show</span>
                                <span style="display: flex; align-items: center; gap: 4px;"><span style="width: 10px; height: 10px; border-radius: 50%; background: #f44336;"></span> Cancelled</span>
                            </div>
                            <div style="padding: 20px;">
                                <!-- Day View - Salon Schedule with Stylist Columns -->
                                <div id="calendarDayView" style="display: none;">
                                    <div style="border: 1px solid var(--gray-light); border-radius: 8px; overflow: hidden;">
                                        <div style="background: var(--gray-light); padding: 12px 15px; font-weight: 600; border-bottom: 1px solid var(--gray-light); display: flex; justify-content: space-between; align-items: center;">
                                            <span id="dayViewDate">Thursday, November 28, 2025</span>
                                            <div style="display: flex; gap: 8px; align-items: center;">
                                                <span id="dayViewPendingCount" style="background: #fff3cd; color: #856404; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 500;">0 pending</span>
                                            </div>
                                        </div>
                                        <!-- Stylist columns header -->
                                        <div id="dayViewStylistHeader" style="display: grid; background: var(--gray-light); border-bottom: 1px solid var(--gray-light);">
                                            <!-- Dynamic stylist columns header -->
                                        </div>
                                        <div id="dayViewGrid" style="position: relative; height: 700px; overflow: auto;">
                                            <!-- Salon schedule grid with stylist columns -->
                                        </div>
                                    </div>
                                </div>

                                <!-- Week View -->
                                <div id="calendarWeekView" style="display: none;">
                                    <div style="border: 1px solid var(--gray-light); border-radius: 8px; overflow: hidden;">
                                        <div style="display: grid; grid-template-columns: 80px repeat(7, 1fr); background: var(--gray-light); border-bottom: 1px solid var(--gray-light);">
                                            <div style="border-right: 1px solid var(--gray-light); padding: 12px 10px; text-align: center; font-size: 11px; color: var(--gray-medium);">TIME</div>
                                            <div style="border-right: 1px solid var(--gray-light); padding: 12px 10px; text-align: center; font-weight: 600; font-size: 12px;">SUN</div>
                                            <div style="border-right: 1px solid var(--gray-light); padding: 12px 10px; text-align: center; font-weight: 600; font-size: 12px;">MON</div>
                                            <div style="border-right: 1px solid var(--gray-light); padding: 12px 10px; text-align: center; font-weight: 600; font-size: 12px;">TUE</div>
                                            <div style="border-right: 1px solid var(--gray-light); padding: 12px 10px; text-align: center; font-weight: 600; font-size: 12px;">WED</div>
                                            <div style="border-right: 1px solid var(--gray-light); padding: 12px 10px; text-align: center; font-weight: 600; font-size: 12px;">THU</div>
                                            <div style="border-right: 1px solid var(--gray-light); padding: 12px 10px; text-align: center; font-weight: 600; font-size: 12px;">FRI</div>
                                            <div style="padding: 12px 10px; text-align: center; font-weight: 600; font-size: 12px;">SAT</div>
                                        </div>
                                        <div id="weekViewGrid" style="display: grid; grid-template-columns: 80px repeat(7, 1fr); height: 600px; overflow-y: auto;">
                                            <!-- Week grid rendered by JS -->
                                        </div>
                                    </div>
                                </div>

                                <!-- Month View -->
                                <div id="calendarMonthView" style="display: block;">
                                    <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-bottom: 10px;">
                                        <div style="text-align: center; font-weight: 600; padding: 10px; color: var(--gray-medium); font-size: 12px;">SUN</div>
                                        <div style="text-align: center; font-weight: 600; padding: 10px; color: var(--gray-medium); font-size: 12px;">MON</div>
                                        <div style="text-align: center; font-weight: 600; padding: 10px; color: var(--gray-medium); font-size: 12px;">TUE</div>
                                        <div style="text-align: center; font-weight: 600; padding: 10px; color: var(--gray-medium); font-size: 12px;">WED</div>
                                        <div style="text-align: center; font-weight: 600; padding: 10px; color: var(--gray-medium); font-size: 12px;">THU</div>
                                        <div style="text-align: center; font-weight: 600; padding: 10px; color: var(--gray-medium); font-size: 12px;">FRI</div>
                                        <div style="text-align: center; font-weight: 600; padding: 10px; color: var(--gray-medium); font-size: 12px;">SAT</div>
                                    </div>
                                    <div id="bookingsCalendarGrid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px;">
                                        <!-- Calendar days rendered by JS -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Day Details Popup -->
                    <div id="bookingsDayPopup" class="modal" style="display: none;">
                        <div class="modal-content" style="max-width: 500px;">
                            <div class="modal-header">
                                <h3 id="bookingsDayPopupTitle">Bookings for June 15</h3>
                                <button class="modal-close" onclick="closeBookingsDayPopup()">&times;</button>
                            </div>
                            <div class="modal-body" id="bookingsDayPopupContent">
                                <!-- Bookings for selected day -->
                            </div>
                        </div>
                    </div>

                    <!-- Edit Booking Modal -->
                    <div id="editBookingModal" class="modal-overlay" style="display: none;">
                        <div class="modal" style="max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column;">
                            <div class="modal-header">
                                <h3 class="modal-title">Edit Booking</h3>
                                <button class="modal-close" onclick="closeEditBookingModal()">&times;</button>
                            </div>
                            <div class="modal-body" style="flex: 1; overflow-y: auto;">
                                <div class="form-group">
                                    <label class="form-label">Customer</label>
                                    <input type="text" id="editBookingCustomer" class="form-input" readonly style="background: var(--gray-light);">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Service</label>
                                    <select id="editBookingService" class="form-input">
                                        <!-- Populated by JS -->
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Stylist</label>
                                    <select id="editBookingStylist" class="form-input">
                                        <option value="">Any Available</option>
                                        <!-- Populated by JS -->
                                    </select>
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="form-group">
                                        <label class="form-label">Date</label>
                                        <input type="date" id="editBookingDate" class="form-input" required>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Time</label>
                                        <input type="time" id="editBookingTime" class="form-input">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Duration (minutes)</label>
                                    <input type="number" id="editBookingDuration" class="form-input" placeholder="60" min="15" step="15">
                                    <small style="color: var(--gray-medium); font-size: 12px;">Typical duration for the selected service</small>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Status</label>
                                    <select id="editBookingStatus" class="form-input">
                                        <option value="No Status">No Status</option>
                                        <option value="To Be Confirmed">To Be Confirmed</option>
                                        <option value="Online Booking">Online Booking</option>
                                        <option value="CONFIRMED">Confirmed</option>
                                        <option value="Paid">Paid</option>
                                        <option value="New Extentions">New Extensions</option>
                                        <option value="Late">Late</option>
                                        <option value="No Show">No Show</option>
                                        <option value="Cancelled">Cancelled</option>
                                        <option value="COMPLETED">Completed</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Commission Rate Override (%)</label>
                                    <input type="number" id="editBookingCommissionRate" class="form-input" min="0" max="100" step="1" placeholder="Leave blank for default">
                                    <small style="color: var(--text-subtle);">Override the service/stylist default commission for this booking</small>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Notes</label>
                                    <textarea id="editBookingNotes" class="form-input" rows="3" placeholder="Special requests or notes..."></textarea>
                                </div>

                                <div id="editBookingError" style="color: var(--danger); margin-bottom: 15px; display: none;"></div>

                                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                                    <button class="btn btn-outline" onclick="closeEditBookingModal()">Cancel</button>
                                    <button class="btn btn-primary" onclick="saveBookingEdit()">Save Changes</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Booking Payment Modal -->
                    <div id="bookingPaymentModal" class="modal-overlay" style="display: none;">
                        <div class="modal" style="max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
                            <div class="modal-header">
                                <h3 class="modal-title">Booking Payment</h3>
                                <button class="modal-close" onclick="closeModal('bookingPaymentModal')">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div id="bookingPaymentInfo" style="background: var(--gray-light); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                                    <!-- Populated by JS -->
                                </div>

                                <div style="display: grid; gap: 10px; margin-bottom: 20px;">
                                    <button class="btn btn-primary" onclick="sendPaymentLink()" style="width: 100%;">
                                        📧 Send PayFast Payment Link
                                    </button>
                                    <p style="text-align: center; color: var(--gray-medium); font-size: 12px; margin: 5px 0;">
                                        Sends a secure payment link to the customer via email
                                    </p>
                                </div>

                                <div style="border-top: 1px solid var(--gray-light); padding-top: 20px;">
                                    <h4 style="margin: 0 0 15px; color: var(--brand-charcoal);">Record Manual Payment</h4>

                                    <div class="form-group">
                                        <label class="form-label">Payment Method</label>
                                        <select id="paymentMethod" class="form-input">
                                            <option value="cash">Cash</option>
                                            <option value="card_on_site">Card (On-Site)</option>
                                            <option value="eft">EFT / Bank Transfer</option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Amount (R)</label>
                                        <input type="number" id="paymentAmount" class="form-input" step="0.01" min="0">
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Reference (Optional)</label>
                                        <input type="text" id="paymentReference" class="form-input" placeholder="Receipt #, EFT ref, etc.">
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Notes (Optional)</label>
                                        <textarea id="paymentNotes" class="form-input" rows="2" placeholder="Additional notes..."></textarea>
                                    </div>

                                    <div id="paymentError" style="color: var(--danger); margin-bottom: 15px; display: none;"></div>

                                    <button class="btn btn-primary" onclick="recordManualPayment()" style="width: 100%;">
                                        Record Payment
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Assign Time Modal -->
                    <div id="assignTimeModal" class="modal-overlay" style="display: none;">
                        <div class="modal" style="max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column;">
                            <div class="modal-header">
                                <h3 class="modal-title">Assign Appointment Time</h3>
                                <button class="modal-close" onclick="closeModal('assignTimeModal')">&times;</button>
                            </div>
                            <div class="modal-body" style="flex: 1; overflow-y: auto;">
                                <!-- Booking Summary -->
                                <div style="background: var(--gray-light); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                                    <h4 style="margin: 0 0 10px 0; font-size: 16px;">Booking Request Details</h4>
                                    <div style="display: grid; grid-template-columns: auto 1fr; gap: 8px 15px; font-size: 14px;">
                                        <strong>Customer:</strong> <span id="assignTimeCustomer">-</span>
                                        <strong>Requested Date:</strong> <span id="assignTimeRequestedDate">-</span>
                                        <strong>Time Window:</strong> <span id="assignTimeWindow">-</span>
                                    </div>
                                </div>

                                <!-- Service Selection -->
                                <div class="form-group">
                                    <label class="form-label">Service <span style="color: var(--danger);">*</span></label>
                                    <select id="assignTimeServiceSelect" class="form-input" onchange="updateServiceDuration()">
                                        <option value="">Select service...</option>
                                        <!-- Populated by JS -->
                                    </select>
                                </div>

                                <!-- Stylist Selection -->
                                <div class="form-group">
                                    <label class="form-label">Assign to Stylist <span style="color: var(--danger);">*</span></label>
                                    <select id="assignTimeStylist" class="form-input" onchange="loadStylistSchedule()">
                                        <option value="">Select stylist...</option>
                                        <!-- Populated by JS -->
                                    </select>
                                </div>

                                <!-- Date Selection -->
                                <div class="form-group">
                                    <label class="form-label">Appointment Date <span style="color: var(--danger);">*</span></label>
                                    <input type="date" id="assignTimeDate" class="form-input" onchange="loadStylistSchedule()">
                                </div>

                                <!-- Time Slot Selection -->
                                <div class="form-group">
                                    <label class="form-label">Select Time Slot <span style="color: var(--danger);">*</span></label>
                                    <div id="timeSlotSchedule" style="min-height: 200px;">
                                        <div style="text-align: center; padding: 40px; color: var(--gray-medium);">
                                            Select a stylist and date to view available time slots
                                        </div>
                                    </div>
                                </div>

                                <!-- Duration -->
                                <div class="form-group">
                                    <label class="form-label">Duration (minutes)</label>
                                    <input type="number" id="assignTimeDuration" class="form-input" value="60" min="15" step="15">
                                    <small style="color: var(--gray-medium); font-size: 12px;">Based on selected service</small>
                                </div>

                                <div id="assignTimeError" style="color: var(--danger); margin-bottom: 15px; display: none;"></div>

                                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                                    <button class="btn btn-outline" onclick="closeModal('assignTimeModal')">Cancel</button>
                                    <button class="btn btn-primary" onclick="confirmAssignTime()">Assign Time & Confirm</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Team Section (Stylists) -->
                <section id="team" class="page-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>Team Members</h3>
                        <button class="btn btn-primary" onclick="openAddStaffModal()">+ Add Team Member</button>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div>
                                    <div class="stat-value" id="teamActiveCount">0</div>
                                    <div class="stat-label">Active Stylists</div>
                                </div>
                                <div class="stat-icon pink">👩‍🎨</div>
                            </div>
                        </div>
                    </div>

                    <div class="data-card">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Team Member</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="team-table-body">
                                <tr><td colspan="4" style="text-align: center; padding: 40px;">Loading team members...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Payroll Section -->
                <section id="payroll" class="page-section">
                    <div class="section-header">
                        <h2>Payroll Management</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-outline" onclick="exportPayrollCSV()">Export CSV</button>
                            <button class="btn btn-primary" onclick="generatePayroll()">Generate Payroll</button>
                        </div>
                    </div>

                    <!-- Period Selector -->
                    <div class="card" style="margin-bottom: 20px;">
                        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                            <div>
                                <label style="font-size: 14px; color: var(--gray-medium); display: block; margin-bottom: 5px;">Year</label>
                                <select id="payrollYear" class="filter-select" onchange="loadPayroll()">
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 14px; color: var(--gray-medium); display: block; margin-bottom: 5px;">Month</label>
                                <select id="payrollMonth" class="filter-select" onchange="loadPayroll()">
                                    <option value="1">January</option>
                                    <option value="2">February</option>
                                    <option value="3">March</option>
                                    <option value="4">April</option>
                                    <option value="5">May</option>
                                    <option value="6">June</option>
                                    <option value="7">July</option>
                                    <option value="8">August</option>
                                    <option value="9">September</option>
                                    <option value="10">October</option>
                                    <option value="11">November</option>
                                    <option value="12">December</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 14px; color: var(--gray-medium); display: block; margin-bottom: 5px;">Status</label>
                                <select id="payrollStatus" class="filter-select" onchange="loadPayroll()">
                                    <option value="">All</option>
                                    <option value="draft">Draft</option>
                                    <option value="finalized">Finalized</option>
                                    <option value="paid">Paid</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Summary Cards -->
                    <div class="stats-grid" id="payrollSummaryCards">
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div>
                                    <div class="stat-value" id="payrollTotalBasic">R0</div>
                                    <div class="stat-label">Total Basic Pay</div>
                                </div>
                                <div class="stat-icon blue">💵</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div>
                                    <div class="stat-value" id="payrollTotalCommission">R0</div>
                                    <div class="stat-label">Total Commission</div>
                                </div>
                                <div class="stat-icon green">📈</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div>
                                    <div class="stat-value" id="payrollTotalGross">R0</div>
                                    <div class="stat-label">Total Gross Pay</div>
                                </div>
                                <div class="stat-icon pink">💰</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div>
                                    <div class="stat-value" id="payrollStylistCount">0</div>
                                    <div class="stat-label">Stylists</div>
                                </div>
                                <div class="stat-icon gold">👩‍🎨</div>
                            </div>
                        </div>
                    </div>

                    <!-- Payroll Table -->
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Payroll Records</h3>
                            <span style="color: var(--gray-medium);" id="payrollRecordsCount">0 records</span>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Stylist</th>
                                    <th>Basic Pay</th>
                                    <th>Commission Rate</th>
                                    <th>Bookings</th>
                                    <th>Revenue (ex VAT)</th>
                                    <th>Commission</th>
                                    <th>Gross Pay</th>
                                    <th>Status</th>
                                    <th style="width: 180px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="payrollTableBody">
                                <tr>
                                    <td colspan="9" style="text-align: center; padding: 40px; color: var(--gray-medium);">
                                        Select a period and click "Generate Payroll" to calculate
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Stylist Pay Settings -->
                    <div class="data-card" style="margin-top: 20px;">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Stylist Pay Settings</h3>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Stylist</th>
                                    <th>Basic Monthly Salary</th>
                                    <th style="width: 120px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="stylistPaySettingsBody">
                                <tr>
                                    <td colspan="3" style="text-align: center; padding: 20px; color: var(--gray-medium);">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                        <p style="margin-top: 12px; font-size: 13px; color: var(--gray-medium);">
                            Commission rates are configured per service in the Services section.
                        </p>
                    </div>
                </section>

                <!-- Payroll Detail Modal -->
                <div id="payrollDetailModal" class="modal-overlay">
                    <div class="modal" style="max-width: 600px; width: 90%;">
                        <div class="modal-header">
                            <h3>Payroll Details</h3>
                            <button class="modal-close" onclick="closeModal('payrollDetailModal')">&times;</button>
                        </div>
                        <div class="modal-body" id="payrollDetailContent">
                            <!-- Content will be populated dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Stylist Pay Edit Modal -->
                <div id="stylistPayModal" class="modal-overlay">
                    <div class="modal" style="max-width: 480px; width: 95%;">
                        <div class="modal-header" style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; border-radius: 12px 12px 0 0; padding: 20px 24px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="width: 44px; height: 44px; background: rgba(255,255,255,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px;">
                                    💰
                                </div>
                                <div>
                                    <h3 style="margin: 0; font-size: 18px; font-weight: 600;">Basic Salary Settings</h3>
                                    <p style="margin: 4px 0 0 0; font-size: 13px; opacity: 0.9;" id="stylistPayNameHeader">Stylist Name</p>
                                </div>
                            </div>
                            <button class="modal-close" onclick="closeModal('stylistPayModal')" style="color: white; opacity: 0.8;">&times;</button>
                        </div>
                        <div class="modal-body" style="padding: 24px;">
                            <input type="hidden" id="stylistPayId">
                            <input type="hidden" id="stylistPayName">

                            <!-- Basic Pay Section -->
                            <div style="background: var(--gray-lightest); border-radius: 12px; padding: 20px;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                                    <span style="font-size: 18px;">📋</span>
                                    <span style="font-weight: 600; color: var(--gray-dark);">Basic Monthly Salary</span>
                                </div>
                                <div style="position: relative;">
                                    <span style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); font-weight: 600; color: var(--gray-medium); font-size: 16px;">R</span>
                                    <input type="number" id="stylistBasicPay" min="0" step="100" placeholder="0.00"
                                           style="padding-left: 36px; font-size: 24px; font-weight: 600; height: 56px; border-radius: 10px;">
                                </div>
                                <p style="margin: 10px 0 0 0; font-size: 12px; color: var(--gray-medium);">
                                    Fixed monthly amount paid regardless of bookings
                                </p>
                            </div>

                            <!-- Info about commission -->
                            <div style="margin-top: 16px; padding: 14px; background: #FFF8E1; border-radius: 10px; border-left: 3px solid #FFC107;">
                                <p style="margin: 0; font-size: 13px; color: #5D4E37; line-height: 1.5;">
                                    <strong>Note:</strong> Commission rates are configured per service in the <strong>Services</strong> section.
                                    Each service can have its own commission rate.
                                </p>
                            </div>
                        </div>
                        <div class="modal-footer" style="padding: 16px 24px 24px; border-top: none; gap: 12px;">
                            <button class="btn btn-outline" onclick="closeModal('stylistPayModal')" style="flex: 1;">Cancel</button>
                            <button class="btn btn-primary" onclick="saveStylistPay()" style="flex: 2;">
                                <span style="margin-right: 6px;">✓</span> Save Salary
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Customers Section -->
                <section id="customers" class="page-section">
                    <div class="filters-bar">
                        <input type="text" id="customerSearchInput" placeholder="Search customers..."
                               onkeyup="filterCustomers()" class="filter-select" style="flex: 1; max-width: 300px;">
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <button class="btn btn-primary" onclick="openCustomerModal()">+ Add Customer</button>
                            <button class="btn btn-outline" onclick="exportCustomersCSV()">Export CSV</button>
                        </div>
                    </div>

                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Customer Database</h3>
                            <span style="color: var(--gray-medium);" id="customersCount">0 customers</span>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Customer</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Points</th>
                                    <th>Total Spent</th>
                                    <th>Last Visit</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Customer Modal -->
                <div id="customerModal" class="modal-overlay">
                    <div class="modal" style="max-width: 520px; width: 90%;">
                        <div class="modal-header">
                            <h3 class="modal-title" id="customerModalTitle">Add Customer</h3>
                            <button class="modal-close" onclick="closeCustomerModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" id="editingCustomerId">
                            <div class="form-group">
                                <label class="form-label">Full Name *</label>
                                <input type="text" class="form-input" id="customerName" placeholder="Customer name">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email *</label>
                                <input type="email" class="form-input" id="customerEmail" placeholder="customer@email.com">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Phone</label>
                                <input type="tel" class="form-input" id="customerPhone" placeholder="+27 82 123 4567">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Points</label>
                                <input type="number" class="form-input" id="customerPoints" value="0" min="0">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Password (optional for new customers)</label>
                                <input type="text" class="form-input" id="customerPassword" placeholder="Leave blank to auto-generate">
                            </div>
                            <!-- Reset Password Section (only shown when editing) -->
                            <div id="resetPasswordSection" class="form-group" style="display: none; border-top: 1px solid var(--gray-light); padding-top: 15px; margin-top: 15px;">
                                <label class="form-label">Password Reset</label>
                                <p style="font-size: 12px; color: var(--gray-dark); margin-bottom: 10px;">Generate a new temporary password and optionally send it to the customer via email.</p>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <button type="button" class="btn btn-outline" onclick="resetCustomerPassword()" style="flex-shrink: 0;">
                                        🔑 Reset Password
                                    </button>
                                    <label style="display: flex; align-items: center; gap: 5px; font-size: 13px; color: var(--gray-dark);">
                                        <input type="checkbox" id="sendResetEmail" checked> Send email to customer
                                    </label>
                                </div>
                                <div id="resetPasswordResult" style="margin-top: 10px; padding: 10px; border-radius: 8px; display: none;"></div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-outline" onclick="closeCustomerModal()">Cancel</button>
                            <button class="btn btn-primary" onclick="saveCustomer()">Save Customer</button>
                        </div>
                    </div>
                </div>

                <!-- Customer Profile Modal (Full-screen style) -->
                <div id="customerProfileModal" class="modal-overlay" style="display: none;">
                    <div class="modal customer-profile-modal">
                        <div class="modal-header customer-profile-header">
                            <div class="customer-profile-header-content">
                                <div class="customer-avatar-large" id="profileAvatar">IO</div>
                                <div class="customer-profile-info">
                                    <h2 id="profileName">Customer Name</h2>
                                    <div class="customer-profile-meta">
                                        <span id="profileEmail">email@example.com</span>
                                        <span class="meta-divider">•</span>
                                        <span id="profilePhone">+27 00 000 0000</span>
                                        <span class="meta-divider">•</span>
                                        <span id="profileMemberSince">Member since Jan 2024</span>
                                    </div>
                                    <div class="customer-tier-badge" id="profileTierBadge">
                                        <span class="tier-icon">👑</span>
                                        <span class="tier-name">Gold Member</span>
                                    </div>
                                </div>
                            </div>
                            <div class="customer-profile-actions">
                                <button class="btn btn-outline btn-sm" onclick="editCustomerFromProfile()">
                                    ✏️ Edit
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="createInvoiceForCustomer()">
                                    📄 New Invoice
                                </button>
                                <button class="modal-close" onclick="closeCustomerProfile()">&times;</button>
                            </div>
                        </div>

                        <!-- Stats Cards -->
                        <div class="customer-stats-bar">
                            <div class="customer-stat">
                                <div class="customer-stat-value" id="statTotalSpent">R0</div>
                                <div class="customer-stat-label">Total Spent</div>
                            </div>
                            <div class="customer-stat">
                                <div class="customer-stat-value" id="statPoints">0</div>
                                <div class="customer-stat-label">Points Balance</div>
                            </div>
                            <div class="customer-stat">
                                <div class="customer-stat-value" id="statBookings">0</div>
                                <div class="customer-stat-label">Total Bookings</div>
                            </div>
                            <div class="customer-stat">
                                <div class="customer-stat-value" id="statOrders">0</div>
                                <div class="customer-stat-label">Shop Orders</div>
                            </div>
                            <div class="customer-stat">
                                <div class="customer-stat-value" id="statInvoices">0</div>
                                <div class="customer-stat-label">Invoices</div>
                            </div>
                            <div class="customer-stat">
                                <div class="customer-stat-value" id="statLastVisit">-</div>
                                <div class="customer-stat-label">Last Visit</div>
                            </div>
                        </div>

                        <!-- Tab Navigation -->
                        <div class="customer-profile-tabs">
                            <button class="profile-tab active" data-tab="overview" onclick="switchProfileTab('overview')">
                                📊 Overview
                            </button>
                            <button class="profile-tab" data-tab="bookings" onclick="switchProfileTab('bookings')">
                                📅 Bookings <span class="tab-count" id="tabBookingsCount">0</span>
                            </button>
                            <button class="profile-tab" data-tab="orders" onclick="switchProfileTab('orders')">
                                🛒 Orders <span class="tab-count" id="tabOrdersCount">0</span>
                            </button>
                            <button class="profile-tab" data-tab="invoices" onclick="switchProfileTab('invoices')">
                                📄 Invoices <span class="tab-count" id="tabInvoicesCount">0</span>
                            </button>
                            <button class="profile-tab" data-tab="loyalty" onclick="switchProfileTab('loyalty')">
                                ⭐ Loyalty
                            </button>
                            <button class="profile-tab" data-tab="inspo" onclick="switchProfileTab('inspo')">
                                📸 Inspiration <span class="tab-count" id="tabInspoCount">0</span>
                            </button>
                            <button class="profile-tab" data-tab="chat" onclick="switchProfileTab('chat')">
                                💬 Chat <span class="tab-count" id="tabChatCount">0</span>
                            </button>
                        </div>

                        <!-- Tab Content -->
                        <div class="customer-profile-content">
                            <!-- Overview Tab -->
                            <div id="profileTabOverview" class="profile-tab-content active">
                                <div class="profile-overview-grid">
                                    <!-- Recent Activity -->
                                    <div class="profile-card">
                                        <h4>Recent Activity</h4>
                                        <div id="recentActivityList" class="activity-list">
                                            <!-- Populated dynamically -->
                                        </div>
                                    </div>

                                    <!-- Points Summary -->
                                    <div class="profile-card">
                                        <h4>Points Summary</h4>
                                        <div class="points-summary">
                                            <div class="points-row">
                                                <span>Total Earned</span>
                                                <span class="points-value positive" id="pointsEarned">+0</span>
                                            </div>
                                            <div class="points-row">
                                                <span>Total Redeemed</span>
                                                <span class="points-value negative" id="pointsRedeemed">-0</span>
                                            </div>
                                            <div class="points-row total">
                                                <span>Current Balance</span>
                                                <span class="points-value" id="pointsBalance">0</span>
                                            </div>
                                        </div>
                                        <div class="tier-progress" id="tierProgress">
                                            <!-- Tier progress bar -->
                                        </div>
                                    </div>

                                    <!-- Referrals -->
                                    <div class="profile-card">
                                        <h4>Referrals</h4>
                                        <div id="referralsSummary">
                                            <!-- Referrals info -->
                                        </div>
                                    </div>

                                    <!-- Quick Stats -->
                                    <div class="profile-card">
                                        <h4>Quick Stats</h4>
                                        <div class="quick-stats-grid">
                                            <div class="quick-stat">
                                                <div class="quick-stat-icon">✅</div>
                                                <div class="quick-stat-info">
                                                    <span class="quick-stat-value" id="completedBookings">0</span>
                                                    <span class="quick-stat-label">Completed Visits</span>
                                                </div>
                                            </div>
                                            <div class="quick-stat">
                                                <div class="quick-stat-icon">📆</div>
                                                <div class="quick-stat-info">
                                                    <span class="quick-stat-value" id="upcomingBookings">0</span>
                                                    <span class="quick-stat-label">Upcoming</span>
                                                </div>
                                            </div>
                                            <div class="quick-stat">
                                                <div class="quick-stat-icon">🎁</div>
                                                <div class="quick-stat-info">
                                                    <span class="quick-stat-value" id="referralsMade">0</span>
                                                    <span class="quick-stat-label">Referrals Made</span>
                                                </div>
                                            </div>
                                            <div class="quick-stat">
                                                <div class="quick-stat-icon">📸</div>
                                                <div class="quick-stat-info">
                                                    <span class="quick-stat-value" id="inspoPhotos">0</span>
                                                    <span class="quick-stat-label">Inspo Photos</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Bookings Tab -->
                            <div id="profileTabBookings" class="profile-tab-content">
                                <div class="profile-table-container">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>Date & Time</th>
                                                <th>Service</th>
                                                <th>Stylist</th>
                                                <th>Status</th>
                                                <th>Amount</th>
                                            </tr>
                                        </thead>
                                        <tbody id="profileBookingsTable">
                                            <!-- Populated dynamically -->
                                        </tbody>
                                    </table>
                                    <div id="noBookingsMessage" class="empty-state" style="display: none;">
                                        <div class="empty-icon">📅</div>
                                        <p>No bookings yet</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Orders Tab -->
                            <div id="profileTabOrders" class="profile-tab-content">
                                <div class="profile-table-container">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>Order #</th>
                                                <th>Date</th>
                                                <th>Items</th>
                                                <th>Status</th>
                                                <th>Total</th>
                                            </tr>
                                        </thead>
                                        <tbody id="profileOrdersTable">
                                            <!-- Populated dynamically -->
                                        </tbody>
                                    </table>
                                    <div id="noOrdersMessage" class="empty-state" style="display: none;">
                                        <div class="empty-icon">🛒</div>
                                        <p>No shop orders yet</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Invoices Tab -->
                            <div id="profileTabInvoices" class="profile-tab-content">
                                <div class="profile-table-container">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>Invoice #</th>
                                                <th>Date</th>
                                                <th>Items</th>
                                                <th>Status</th>
                                                <th>Total</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="profileInvoicesTable">
                                            <!-- Populated dynamically -->
                                        </tbody>
                                    </table>
                                    <div id="noInvoicesMessage" class="empty-state" style="display: none;">
                                        <div class="empty-icon">📄</div>
                                        <p>No invoices yet</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Loyalty Tab -->
                            <div id="profileTabLoyalty" class="profile-tab-content">
                                <div class="loyalty-content-grid">
                                    <div class="profile-card full-width">
                                        <h4>Points History</h4>
                                        <div class="profile-table-container">
                                            <table class="data-table">
                                                <thead>
                                                    <tr>
                                                        <th>Date</th>
                                                        <th>Description</th>
                                                        <th>Type</th>
                                                        <th>Points</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="profileLoyaltyTable">
                                                    <!-- Populated dynamically -->
                                                </tbody>
                                            </table>
                                            <div id="noLoyaltyMessage" class="empty-state" style="display: none;">
                                                <div class="empty-icon">⭐</div>
                                                <p>No points history yet</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Inspiration Tab -->
                            <div id="profileTabInspo" class="profile-tab-content">
                                <div id="inspoGalleryGrid" class="inspo-gallery-grid">
                                    <!-- Populated dynamically -->
                                </div>
                                <div id="noInspoMessage" class="empty-state" style="display: none;">
                                    <div class="empty-icon">📸</div>
                                    <p>No inspiration photos uploaded</p>
                                </div>
                            </div>

                            <!-- Chat Tab -->
                            <div id="profileTabChat" class="profile-tab-content">
                                <div class="profile-chat-container">
                                    <!-- Chat input at top -->
                                    <div class="profile-chat-input-container">
                                        <textarea id="profileChatInput" class="profile-chat-textarea" placeholder="Type a message to this customer..." rows="2"></textarea>
                                        <button class="btn btn-primary profile-chat-send" onclick="sendProfileChatMessage()">
                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                                            </svg>
                                            Send
                                        </button>
                                    </div>

                                    <!-- Chat history -->
                                    <div id="profileChatHistory" class="profile-chat-history">
                                        <!-- Populated dynamically -->
                                    </div>
                                    <div id="noChatMessage" class="empty-state" style="display: none;">
                                        <div class="empty-icon">💬</div>
                                        <p>No chat history with this customer</p>
                                        <p style="font-size: 13px; color: var(--text-subtle);">Send a message to start a conversation</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Customer Profile Styles -->
                <style>
                    .customer-profile-modal {
                        max-width: 1200px;
                        width: 95%;
                        max-height: 90vh;
                        display: flex;
                        flex-direction: column;
                    }

                    .customer-profile-header {
                        background: linear-gradient(135deg, var(--primary) 0%, #e85a7f 100%);
                        padding: 24px 30px;
                        display: flex;
                        justify-content: space-between;
                        align-items: flex-start;
                        border-radius: 16px 16px 0 0;
                    }

                    .customer-profile-header-content {
                        display: flex;
                        align-items: center;
                        gap: 20px;
                    }

                    .customer-avatar-large {
                        width: 80px;
                        height: 80px;
                        border-radius: 50%;
                        background: white;
                        color: var(--primary);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 28px;
                        font-weight: 700;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    }

                    .customer-profile-info h2 {
                        color: white;
                        margin: 0 0 8px 0;
                        font-size: 24px;
                    }

                    .customer-profile-meta {
                        color: rgba(255,255,255,0.9);
                        font-size: 14px;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        flex-wrap: wrap;
                    }

                    .meta-divider {
                        opacity: 0.5;
                    }

                    .customer-tier-badge {
                        display: inline-flex;
                        align-items: center;
                        gap: 6px;
                        background: rgba(255,255,255,0.2);
                        padding: 6px 14px;
                        border-radius: 20px;
                        margin-top: 10px;
                        font-size: 13px;
                        color: white;
                        font-weight: 500;
                    }

                    .customer-profile-actions {
                        display: flex;
                        gap: 10px;
                        align-items: flex-start;
                    }

                    .customer-profile-actions .modal-close {
                        color: white;
                        font-size: 28px;
                        opacity: 0.8;
                    }

                    .customer-profile-actions .modal-close:hover {
                        opacity: 1;
                    }

                    .customer-profile-actions .btn {
                        background: rgba(255,255,255,0.2);
                        border-color: rgba(255,255,255,0.3);
                        color: white;
                    }

                    .customer-profile-actions .btn:hover {
                        background: rgba(255,255,255,0.3);
                    }

                    .customer-stats-bar {
                        display: flex;
                        background: white;
                        border-bottom: 1px solid var(--border-soft);
                        padding: 0;
                    }

                    .customer-stat {
                        flex: 1;
                        padding: 20px;
                        text-align: center;
                        border-right: 1px solid var(--border-soft);
                    }

                    .customer-stat:last-child {
                        border-right: none;
                    }

                    .customer-stat-value {
                        font-size: 24px;
                        font-weight: 700;
                        color: var(--text-primary);
                    }

                    .customer-stat-label {
                        font-size: 12px;
                        color: var(--text-subtle);
                        margin-top: 4px;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                    }

                    .customer-profile-tabs {
                        display: flex;
                        background: var(--surface-muted);
                        border-bottom: 2px solid var(--border-soft);
                        overflow-x: auto;
                    }

                    .profile-tab {
                        padding: 14px 24px;
                        border: none;
                        background: transparent;
                        cursor: pointer;
                        font-size: 14px;
                        font-weight: 500;
                        color: var(--text-subtle);
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        border-bottom: 3px solid transparent;
                        margin-bottom: -2px;
                        transition: all 0.2s;
                        white-space: nowrap;
                    }

                    .profile-tab:hover {
                        background: rgba(0,0,0,0.03);
                        color: var(--text-primary);
                    }

                    .profile-tab.active {
                        color: var(--primary);
                        border-bottom-color: var(--primary);
                        background: white;
                    }

                    .tab-count {
                        background: var(--surface-muted);
                        padding: 2px 8px;
                        border-radius: 10px;
                        font-size: 11px;
                    }

                    .profile-tab.active .tab-count {
                        background: rgba(246, 117, 153, 0.15);
                        color: var(--primary);
                    }

                    .customer-profile-content {
                        flex: 1;
                        overflow-y: auto;
                        background: var(--surface-muted);
                        padding: 24px;
                    }

                    .profile-tab-content {
                        display: none;
                    }

                    .profile-tab-content.active {
                        display: block;
                    }

                    .profile-overview-grid {
                        display: grid;
                        grid-template-columns: repeat(2, 1fr);
                        gap: 20px;
                    }

                    .profile-card {
                        background: white;
                        border-radius: 12px;
                        padding: 20px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
                    }

                    .profile-card.full-width {
                        grid-column: 1 / -1;
                    }

                    .profile-card h4 {
                        margin: 0 0 16px 0;
                        font-size: 16px;
                        color: var(--text-primary);
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    }

                    .activity-list {
                        display: flex;
                        flex-direction: column;
                        gap: 12px;
                        max-height: 300px;
                        overflow-y: auto;
                    }

                    .activity-item {
                        display: flex;
                        align-items: flex-start;
                        gap: 12px;
                        padding: 12px;
                        background: var(--surface-muted);
                        border-radius: 8px;
                    }

                    .activity-icon {
                        width: 36px;
                        height: 36px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 16px;
                        flex-shrink: 0;
                    }

                    .activity-icon.booking { background: rgba(76, 175, 80, 0.1); }
                    .activity-icon.order { background: rgba(33, 150, 243, 0.1); }
                    .activity-icon.invoice { background: rgba(156, 39, 176, 0.1); }
                    .activity-icon.points { background: rgba(255, 193, 7, 0.1); }

                    .activity-info {
                        flex: 1;
                    }

                    .activity-title {
                        font-weight: 500;
                        color: var(--text-primary);
                        font-size: 14px;
                    }

                    .activity-date {
                        font-size: 12px;
                        color: var(--text-subtle);
                        margin-top: 2px;
                    }

                    .activity-amount {
                        font-weight: 600;
                        color: var(--text-primary);
                    }

                    .points-summary {
                        display: flex;
                        flex-direction: column;
                        gap: 12px;
                    }

                    .points-row {
                        display: flex;
                        justify-content: space-between;
                        padding: 10px 0;
                        border-bottom: 1px solid var(--border-soft);
                    }

                    .points-row.total {
                        border-bottom: none;
                        font-weight: 600;
                        font-size: 16px;
                        padding-top: 16px;
                        border-top: 2px solid var(--border-soft);
                    }

                    .points-value.positive { color: var(--success); }
                    .points-value.negative { color: var(--danger); }

                    .tier-progress {
                        margin-top: 20px;
                        padding-top: 16px;
                        border-top: 1px solid var(--border-soft);
                    }

                    .tier-progress-bar {
                        height: 8px;
                        background: var(--surface-muted);
                        border-radius: 4px;
                        overflow: hidden;
                        margin: 10px 0;
                    }

                    .tier-progress-fill {
                        height: 100%;
                        border-radius: 4px;
                        transition: width 0.3s;
                    }

                    .tier-progress-fill.bronze { background: #cd7f32; }
                    .tier-progress-fill.silver { background: #c0c0c0; }
                    .tier-progress-fill.gold { background: #ffd700; }
                    .tier-progress-fill.platinum { background: linear-gradient(90deg, #e5e4e2, #a8a8a8); }

                    .tier-progress-text {
                        font-size: 12px;
                        color: var(--text-subtle);
                        text-align: center;
                    }

                    .quick-stats-grid {
                        display: grid;
                        grid-template-columns: repeat(2, 1fr);
                        gap: 12px;
                    }

                    .quick-stat {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        padding: 12px;
                        background: var(--surface-muted);
                        border-radius: 8px;
                    }

                    .quick-stat-icon {
                        font-size: 24px;
                    }

                    .quick-stat-value {
                        font-size: 20px;
                        font-weight: 700;
                        color: var(--text-primary);
                        display: block;
                    }

                    .quick-stat-label {
                        font-size: 12px;
                        color: var(--text-subtle);
                    }

                    .profile-table-container {
                        background: white;
                        border-radius: 12px;
                        overflow: hidden;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
                    }

                    .profile-table-container .data-table {
                        margin: 0;
                    }

                    .empty-state {
                        text-align: center;
                        padding: 60px 20px;
                        color: var(--text-subtle);
                    }

                    .empty-icon {
                        font-size: 48px;
                        margin-bottom: 16px;
                        opacity: 0.5;
                    }

                    .inspo-gallery-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                        gap: 16px;
                    }

                    .inspo-photo-card {
                        aspect-ratio: 1;
                        border-radius: 12px;
                        overflow: hidden;
                        position: relative;
                        cursor: pointer;
                        background: var(--surface-muted);
                    }

                    .inspo-photo-card img {
                        width: 100%;
                        height: 100%;
                        object-fit: cover;
                    }

                    .inspo-photo-overlay {
                        position: absolute;
                        bottom: 0;
                        left: 0;
                        right: 0;
                        padding: 12px;
                        background: linear-gradient(transparent, rgba(0,0,0,0.7));
                        color: white;
                        font-size: 12px;
                    }

                    /* Profile Chat Styles */
                    .profile-chat-container {
                        display: flex;
                        flex-direction: column;
                        height: 400px;
                        max-height: 400px;
                    }

                    .profile-chat-input-container {
                        display: flex;
                        gap: 12px;
                        padding: 16px;
                        background: var(--surface-muted);
                        border-radius: 12px;
                        margin-bottom: 16px;
                    }

                    .profile-chat-textarea {
                        flex: 1;
                        padding: 12px;
                        border: 1px solid var(--border-color);
                        border-radius: 8px;
                        resize: none;
                        font-family: inherit;
                        font-size: 14px;
                    }

                    .profile-chat-textarea:focus {
                        outline: none;
                        border-color: var(--primary);
                    }

                    .profile-chat-send {
                        display: flex;
                        align-items: center;
                        gap: 6px;
                        padding: 10px 20px;
                        white-space: nowrap;
                    }

                    .profile-chat-history {
                        flex: 1;
                        overflow-y: auto;
                        display: flex;
                        flex-direction: column;
                        gap: 12px;
                        padding: 4px;
                    }

                    .chat-conversation-group {
                        background: var(--surface);
                        border: 1px solid var(--border-color);
                        border-radius: 12px;
                        padding: 16px;
                    }

                    .chat-conversation-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 12px;
                        padding-bottom: 12px;
                        border-bottom: 1px solid var(--border-color);
                    }

                    .chat-conversation-date {
                        font-size: 12px;
                        color: var(--text-subtle);
                    }

                    .chat-conversation-status {
                        font-size: 11px;
                        padding: 3px 8px;
                        border-radius: 10px;
                        background: rgba(76, 175, 80, 0.15);
                        color: #4caf50;
                    }

                    .chat-conversation-status.closed {
                        background: rgba(158, 158, 158, 0.15);
                        color: #9e9e9e;
                    }

                    .chat-message {
                        display: flex;
                        flex-direction: column;
                        max-width: 80%;
                        margin-bottom: 8px;
                    }

                    .chat-message.from-user {
                        align-self: flex-start;
                    }

                    .chat-message.from-agent {
                        align-self: flex-end;
                    }

                    .chat-message-bubble {
                        padding: 10px 14px;
                        border-radius: 16px;
                        font-size: 14px;
                        line-height: 1.4;
                    }

                    .chat-message.from-user .chat-message-bubble {
                        background: var(--surface-muted);
                        color: var(--text-primary);
                        border-bottom-left-radius: 4px;
                    }

                    .chat-message.from-agent .chat-message-bubble {
                        background: var(--primary);
                        color: white;
                        border-bottom-right-radius: 4px;
                    }

                    .chat-message-time {
                        font-size: 11px;
                        color: var(--text-subtle);
                        margin-top: 4px;
                        padding: 0 4px;
                    }

                    .chat-message.from-agent .chat-message-time {
                        text-align: right;
                    }

                    .status-badge {
                        display: inline-flex;
                        align-items: center;
                        padding: 4px 10px;
                        border-radius: 12px;
                        font-size: 12px;
                        font-weight: 500;
                    }

                    .status-badge.pending { background: rgba(255, 193, 7, 0.15); color: #f59e0b; }
                    .status-badge.confirmed { background: rgba(33, 150, 243, 0.15); color: #2196f3; }
                    .status-badge.completed { background: rgba(76, 175, 80, 0.15); color: #4caf50; }
                    .status-badge.cancelled { background: rgba(244, 67, 54, 0.15); color: #f44336; }
                    .status-badge.paid { background: rgba(76, 175, 80, 0.15); color: #4caf50; }
                    .status-badge.unpaid { background: rgba(255, 193, 7, 0.15); color: #f59e0b; }
                    .status-badge.processing { background: rgba(33, 150, 243, 0.15); color: #2196f3; }
                    .status-badge.shipped { background: rgba(156, 39, 176, 0.15); color: #9c27b0; }
                    .status-badge.delivered { background: rgba(76, 175, 80, 0.15); color: #4caf50; }

                    .loyalty-content-grid {
                        display: flex;
                        flex-direction: column;
                        gap: 20px;
                    }

                    @media (max-width: 768px) {
                        .customer-profile-modal {
                            width: 100%;
                            max-height: 100vh;
                            border-radius: 0;
                        }

                        .customer-profile-header {
                            flex-direction: column;
                            gap: 16px;
                            border-radius: 0;
                        }

                        .customer-profile-header-content {
                            flex-direction: column;
                            text-align: center;
                        }

                        .customer-stats-bar {
                            flex-wrap: wrap;
                        }

                        .customer-stat {
                            flex: 1 1 33%;
                            min-width: 100px;
                        }

                        .profile-overview-grid {
                            grid-template-columns: 1fr;
                        }

                        .customer-profile-tabs {
                            overflow-x: auto;
                        }
                    }
                </style>

                <!-- Products Section -->
                <section id="products" class="page-section">
                    <div class="filters-bar">
                        <input type="text" id="productSearchInput" placeholder="Search products..."
                               onkeyup="filterProducts()" class="filter-select" style="flex: 1; max-width: 300px;">
                        <select class="filter-select" id="productCategoryFilter" onchange="filterProducts()">
                            <option value="">All Categories</option>
                        </select>
                        <select class="filter-select" id="productStockFilter" onchange="filterProducts()">
                            <option value="">All Stock</option>
                            <option value="in">In Stock</option>
                            <option value="low">Low Stock</option>
                            <option value="out">Out of Stock</option>
                        </select>
                        <button class="btn btn-primary" onclick="openAddProductModal()">+ Add Product</button>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div>
                                    <div class="stat-value" id="productsTotalCount">0</div>
                                    <div class="stat-label">Total Products</div>
                                </div>
                                <div class="stat-icon pink">📦</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div>
                                    <div class="stat-value" id="productsLowStockCount">0</div>
                                    <div class="stat-label">Low Stock Alerts</div>
                                </div>
                                <div class="stat-icon" style="background: rgba(244, 67, 54, 0.1); color: var(--danger);">⚠️</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div>
                                    <div class="stat-value" id="productsInventoryValue">R0</div>
                                    <div class="stat-label">Inventory Value</div>
                                </div>
                                <div class="stat-icon green">💰</div>
                            </div>
                        </div>
                    </div>

                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Product Inventory</h3>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Sale Price</th>
                                    <th>Stock</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 20px; color: var(--gray-medium);">Loading products...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Orders Section -->
                <section id="orders" class="page-section">
                    <div class="filters-bar">
                        <select class="filter-select" id="orderStatusFilter">
                            <option value="">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="processing">Processing</option>
                            <option value="shipped">Shipped</option>
                            <option value="delivered">Delivered</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                        <select class="filter-select" id="orderDeliveryFilter">
                            <option value="">All Delivery Methods</option>
                            <option value="pickup">Pickup</option>
                            <option value="standard courier">Standard Courier</option>
                            <option value="express courier">Express Courier</option>
                        </select>
                        <input type="date" class="filter-select" id="orderDateFilter" aria-label="Filter orders by date">
                        <button class="btn btn-outline btn-small" id="orderFiltersClear" type="button">Clear</button>
                    </div>

                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Product Orders</h3>
                            <span style="color: var(--gray-medium);" id="orderCountText">Loading...</span>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Items</th>
                                    <th>Total</th>
                                    <th>Delivery</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTableBody">
                                <tr>
                                    <td colspan="7" style="text-align: center; color: var(--gray-medium); padding: 20px;">Loading orders...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- ============================================ -->
                <!-- INVOICES SECTION -->
                <!-- ============================================ -->
                <section id="invoices" class="page-section">
                    <!-- Header -->
                    <div class="invoice-header">
                        <div class="invoice-header-left">
                            <h1>Invoices</h1>
                            <p>Create and manage invoices for completed services</p>
                        </div>
                        <div class="invoice-header-actions">
                            <button class="btn btn-outline" onclick="exportInvoices()" title="Export">
                                <svg style="width:18px;height:18px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                            </button>
                            <button class="btn btn-primary" onclick="showCreateInvoice()">
                                <svg style="width:18px;height:18px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                                New Invoice
                            </button>
                        </div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="invoice-stats-row" id="invoice-stats-row">
                        <div class="invoice-stat-card">
                            <div class="stat-label">Total Invoices</div>
                            <div class="stat-value" id="stat-total-invoices">0</div>
                            <div class="stat-subtext">This month</div>
                        </div>
                        <div class="invoice-stat-card highlight">
                            <div class="stat-label">Revenue</div>
                            <div class="stat-value" id="stat-total-revenue">R0</div>
                            <div class="stat-subtext">From paid invoices</div>
                        </div>
                        <div class="invoice-stat-card">
                            <div class="stat-label">Pending</div>
                            <div class="stat-value" id="stat-pending-amount">R0</div>
                            <div class="stat-subtext"><span id="stat-pending-count">0</span> unpaid invoices</div>
                        </div>
                        <div class="invoice-stat-card">
                            <div class="stat-label">Commissions</div>
                            <div class="stat-value" id="stat-commissions">R0</div>
                            <div class="stat-subtext">This month</div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="invoice-filters">
                        <div class="invoice-filters-row">
                            <div class="invoice-search-wrapper">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                </svg>
                                <input type="text" id="invoice-search" class="invoice-search-input"
                                    placeholder="Search by invoice #, customer name, or email..."
                                    oninput="debounceInvoiceSearch()">
                            </div>
                            <select id="invoice-status-filter" class="invoice-filter-select" onchange="loadInvoices()">
                                <option value="">All Statuses</option>
                                <option value="draft">📝 Draft</option>
                                <option value="finalized">✅ Finalized</option>
                                <option value="sent">📧 Sent</option>
                                <option value="cancelled">❌ Cancelled</option>
                            </select>
                            <select id="invoice-payment-filter" class="invoice-filter-select" onchange="loadInvoices()">
                                <option value="">All Payments</option>
                                <option value="unpaid">🔴 Unpaid</option>
                                <option value="partial">🟡 Partial</option>
                                <option value="paid">🟢 Paid</option>
                            </select>
                            <select id="invoice-stylist-filter" class="invoice-filter-select" onchange="loadInvoices()">
                                <option value="">All Stylists</option>
                                <!-- Populated dynamically -->
                            </select>
                        </div>
                    </div>

                    <!-- Invoice List -->
                    <div class="invoice-list-wrapper">
                        <div id="invoice-list-container">
                            <div class="invoice-empty-state">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <h3>No invoices yet</h3>
                                <p>Create your first invoice to get started</p>
                                <button class="btn btn-primary" onclick="showCreateInvoice()">
                                    <svg style="width:16px;height:16px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="12" y1="5" x2="12" y2="19"></line>
                                        <line x1="5" y1="12" x2="19" y2="12"></line>
                                    </svg>
                                    Create Invoice
                                </button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- ============================================ -->
                <!-- CREATE/EDIT INVOICE MODAL -->
                <!-- ============================================ -->
                <div id="invoice-modal" class="modal-overlay" style="display: none;">
                    <div class="modal invoice-modal-content">
                        <div class="invoice-modal-header">
                            <h2 id="invoice-modal-title">
                                <svg style="width:24px;height:24px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                    <line x1="16" y1="13" x2="8" y2="13"></line>
                                    <line x1="16" y1="17" x2="8" y2="17"></line>
                                    <polyline points="10 9 9 9 8 9"></polyline>
                                </svg>
                                Create Invoice
                            </h2>
                            <button class="modal-close" onclick="closeInvoiceModal()">&times;</button>
                        </div>
                        <div class="invoice-modal-body">
                            <form id="invoice-form" onsubmit="saveInvoice(event)">
                                <div class="invoice-form-layout">
                                    <!-- Main Form Area -->
                                    <div class="invoice-form-main">
                                        <!-- Customer & Details -->
                                        <div class="invoice-form-section">
                                            <div class="invoice-form-section-title">Customer Details</div>

                                            <!-- Customer Type Toggle -->
                                            <div class="invoice-form-row" style="margin-bottom: 16px;">
                                                <div class="invoice-form-group" style="flex: 1;">
                                                    <label class="invoice-form-label">Customer Type</label>
                                                    <div style="display: flex; gap: 8px;">
                                                        <button type="button" id="customer-type-individual" class="customer-type-btn active" onclick="setCustomerType('individual')" style="flex: 1; padding: 10px 16px; border: 2px solid var(--brand-pink); border-radius: 8px; background: var(--brand-pink); color: white; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                                            <svg style="width:18px;height:18px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                                                <circle cx="12" cy="7" r="4"></circle>
                                                            </svg>
                                                            Individual
                                                        </button>
                                                        <button type="button" id="customer-type-company" class="customer-type-btn" onclick="setCustomerType('company')" style="flex: 1; padding: 10px 16px; border: 2px solid var(--border-soft); border-radius: 8px; background: white; color: var(--brand-charcoal); font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                                            <svg style="width:18px;height:18px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                                <path d="M3 21h18"></path>
                                                                <path d="M5 21V7l8-4v18"></path>
                                                                <path d="M19 21V11l-6-4"></path>
                                                                <path d="M9 9v.01"></path>
                                                                <path d="M9 12v.01"></path>
                                                                <path d="M9 15v.01"></path>
                                                                <path d="M9 18v.01"></path>
                                                            </svg>
                                                            Company
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="invoice-form-row">
                                                <div class="invoice-form-group">
                                                    <label class="invoice-form-label">Customer <span class="required">*</span></label>
                                                    <select id="invoice-customer" required class="invoice-form-select">
                                                        <option value="">Select customer...</option>
                                                    </select>
                                                </div>
                                                <div class="invoice-form-group">
                                                    <label class="invoice-form-label">Stylist <span class="required">*</span></label>
                                                    <select id="invoice-stylist" required class="invoice-form-select">
                                                        <option value="">Select stylist...</option>
                                                    </select>
                                                </div>
                                            </div>

                                            <!-- Company Details (hidden by default) -->
                                            <div id="company-details-section" style="display: none;">
                                                <div class="invoice-form-row">
                                                    <div class="invoice-form-group" style="flex: 1;">
                                                        <label class="invoice-form-label">Company Name <span class="required">*</span></label>
                                                        <input type="text" id="invoice-company-name" class="invoice-form-input" placeholder="Enter company name...">
                                                    </div>
                                                </div>
                                                <div class="invoice-form-row">
                                                    <div class="invoice-form-group" style="flex: 1;">
                                                        <label class="invoice-form-label">Business Address</label>
                                                        <textarea id="invoice-business-address" rows="2" class="invoice-form-textarea" placeholder="Enter business address..."></textarea>
                                                    </div>
                                                </div>
                                                <div class="invoice-form-row">
                                                    <div class="invoice-form-group">
                                                        <label class="invoice-form-label">VAT Number</label>
                                                        <input type="text" id="invoice-vat-number" class="invoice-form-input" placeholder="e.g., 4123456789">
                                                    </div>
                                                    <div class="invoice-form-group">
                                                        <label class="invoice-form-label">Company Reg. Number</label>
                                                        <input type="text" id="invoice-company-reg" class="invoice-form-input" placeholder="e.g., 2024/123456/07">
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="invoice-form-row">
                                                <div class="invoice-form-group">
                                                    <label class="invoice-form-label">Service Date <span class="required">*</span></label>
                                                    <input type="date" id="invoice-service-date" required class="invoice-form-input">
                                                </div>
                                                <div class="invoice-form-group">
                                                    <label class="invoice-form-label">Link to Booking</label>
                                                    <select id="invoice-booking" class="invoice-form-select">
                                                        <option value="">Walk-in (no booking)</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Services -->
                                        <div class="invoice-form-section">
                                            <div class="invoice-line-items">
                                                <div class="invoice-line-items-header">
                                                    <h4>
                                                        <svg style="width:18px;height:18px;vertical-align:middle;margin-right:6px;opacity:0.7" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
                                                        </svg>
                                                        Services
                                                    </h4>
                                                    <button type="button" class="invoice-add-item-btn" onclick="showServicePicker()">
                                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <line x1="12" y1="5" x2="12" y2="19"></line>
                                                            <line x1="5" y1="12" x2="19" y2="12"></line>
                                                        </svg>
                                                        Add Service
                                                    </button>
                                                </div>
                                                <div id="invoice-services-list" class="invoice-line-items-body">
                                                    <div class="invoice-line-items-empty">
                                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                                            <circle cx="12" cy="12" r="10"></circle>
                                                            <line x1="12" y1="8" x2="12" y2="12"></line>
                                                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                                                        </svg>
                                                        <p>No services added yet</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Products -->
                                        <div class="invoice-form-section">
                                            <div class="invoice-line-items">
                                                <div class="invoice-line-items-header">
                                                    <h4>
                                                        <svg style="width:18px;height:18px;vertical-align:middle;margin-right:6px;opacity:0.7" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
                                                            <line x1="3" y1="6" x2="21" y2="6"></line>
                                                            <path d="M16 10a4 4 0 0 1-8 0"></path>
                                                        </svg>
                                                        Products
                                                    </h4>
                                                    <button type="button" class="invoice-add-item-btn" onclick="showProductPicker()">
                                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <line x1="12" y1="5" x2="12" y2="19"></line>
                                                            <line x1="5" y1="12" x2="19" y2="12"></line>
                                                        </svg>
                                                        Add Product
                                                    </button>
                                                </div>
                                                <div id="invoice-products-list" class="invoice-line-items-body">
                                                    <div class="invoice-line-items-empty">
                                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                                            <circle cx="12" cy="12" r="10"></circle>
                                                            <line x1="12" y1="8" x2="12" y2="12"></line>
                                                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                                                        </svg>
                                                        <p>No products added yet</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Notes -->
                                        <div class="invoice-form-section">
                                            <div class="invoice-form-section-title">Notes</div>
                                            <div class="invoice-form-row">
                                                <div class="invoice-form-group">
                                                    <label class="invoice-form-label">Client Notes (shown on invoice)</label>
                                                    <textarea id="invoice-client-notes" rows="3" class="invoice-form-textarea"
                                                        placeholder="Thank you for visiting FL!RT..."></textarea>
                                                </div>
                                                <div class="invoice-form-group">
                                                    <label class="invoice-form-label">Internal Notes (private)</label>
                                                    <textarea id="invoice-internal-notes" rows="3" class="invoice-form-textarea"
                                                        placeholder="Admin notes..."></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Sidebar - Totals & Actions -->
                                    <div class="invoice-form-sidebar">
                                        <!-- Discount -->
                                        <div class="invoice-discount-card">
                                            <h4>
                                                <svg style="width:16px;height:16px;vertical-align:middle;margin-right:6px;opacity:0.7" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <circle cx="9" cy="21" r="1"></circle>
                                                    <circle cx="20" cy="21" r="1"></circle>
                                                    <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                                                </svg>
                                                Discount
                                            </h4>
                                            <div class="invoice-discount-grid">
                                                <select id="invoice-discount-type" class="invoice-form-select" onchange="calculateInvoiceTotals()">
                                                    <option value="">None</option>
                                                    <option value="percentage">%</option>
                                                    <option value="fixed">Fixed</option>
                                                    <option value="loyalty_points">Loyalty</option>
                                                </select>
                                                <input type="number" id="invoice-discount-value" placeholder="0" class="invoice-form-input"
                                                    step="0.01" min="0" oninput="calculateInvoiceTotals()">
                                                <input type="text" id="invoice-discount-reason" placeholder="Reason (optional)"
                                                    class="invoice-form-input full-width">
                                            </div>
                                        </div>

                                        <!-- Totals -->
                                        <div class="invoice-totals-card">
                                            <h4>Invoice Summary</h4>
                                            <div class="invoice-totals-row">
                                                <span class="label">Services</span>
                                                <span class="value" id="invoice-services-subtotal">R0.00</span>
                                            </div>
                                            <div class="invoice-totals-row">
                                                <span class="label">Products</span>
                                                <span class="value" id="invoice-products-subtotal">R0.00</span>
                                            </div>
                                            <div class="invoice-totals-row">
                                                <span class="label">Subtotal</span>
                                                <span class="value" id="invoice-subtotal">R0.00</span>
                                            </div>
                                            <div class="invoice-totals-row discount">
                                                <span class="label">Discount</span>
                                                <span class="value" id="invoice-discount-amount">-R0.00</span>
                                            </div>
                                            <div class="invoice-totals-row" id="invoice-tax-row">
                                                <span class="label" id="invoice-tax-label">VAT (15%)</span>
                                                <span class="value" id="invoice-tax-amount">R0.00</span>
                                            </div>
                                            <div class="invoice-totals-row total">
                                                <span class="label">Total</span>
                                                <span class="value" id="invoice-total">R0.00</span>
                                            </div>
                                            <div class="invoice-totals-row commission">
                                                <span class="label">Commission</span>
                                                <span class="value" id="invoice-commission">R0.00</span>
                                            </div>
                                        </div>

                                        <!-- Actions -->
                                        <div class="invoice-form-actions">
                                            <button type="submit" class="invoice-btn invoice-btn-primary">
                                                <svg style="width:18px;height:18px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                                </svg>
                                                Finalize Invoice
                                            </button>
                                            <button type="button" class="invoice-btn invoice-btn-secondary" onclick="saveInvoiceAsDraft()">
                                                <svg style="width:18px;height:18px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                                                    <polyline points="17 21 17 13 7 13 7 21"></polyline>
                                                    <polyline points="7 3 7 8 15 8"></polyline>
                                                </svg>
                                                Save Draft
                                            </button>
                                            <button type="button" class="invoice-btn invoice-btn-outline" onclick="closeInvoiceModal()">
                                                Cancel
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Service Picker Modal -->
                <div id="service-picker-modal" class="modal-overlay stacked" style="display: none;">
                    <div class="modal picker-modal-content">
                        <div class="picker-modal-header">
                            <h3>
                                <svg style="width:22px;height:22px;vertical-align:middle;margin-right:8px;opacity:0.7" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
                                </svg>
                                Add Service
                            </h3>
                            <div class="picker-search-wrapper">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                </svg>
                                <input type="text" id="service-search" class="picker-search-input"
                                    placeholder="Search services by name or category..."
                                    oninput="filterInvoiceServices()">
                            </div>
                            <button class="modal-close" onclick="closeServicePicker()" style="position:absolute;top:20px;right:20px;">&times;</button>
                        </div>
                        <div id="service-list" class="picker-list">
                            <!-- Populated dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Product Picker Modal -->
                <div id="product-picker-modal" class="modal-overlay stacked" style="display: none;">
                    <div class="modal picker-modal-content">
                        <div class="picker-modal-header">
                            <h3>
                                <svg style="width:22px;height:22px;vertical-align:middle;margin-right:8px;opacity:0.7" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
                                    <line x1="3" y1="6" x2="21" y2="6"></line>
                                    <path d="M16 10a4 4 0 0 1-8 0"></path>
                                </svg>
                                Add Product
                            </h3>
                            <div class="picker-search-wrapper">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                </svg>
                                <input type="text" id="product-search" class="picker-search-input"
                                    placeholder="Search products by name or category..."
                                    oninput="filterInvoiceProducts()">
                            </div>
                            <button class="modal-close" onclick="closeProductPicker()" style="position:absolute;top:20px;right:20px;">&times;</button>
                        </div>
                        <div id="product-list" class="picker-list">
                            <!-- Populated dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Payment Modal -->
                <div id="payment-modal" class="modal-overlay stacked" style="display: none;">
                    <div class="modal payment-modal-content">
                        <div class="payment-modal-header">
                            <h3>
                                <svg style="width:22px;height:22px;vertical-align:middle;margin-right:8px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                                    <line x1="1" y1="10" x2="23" y2="10"></line>
                                </svg>
                                Record Payment
                            </h3>
                            <button class="modal-close" onclick="closePaymentModal()" style="position:absolute;top:20px;right:20px;color:white;">&times;</button>
                        </div>
                        <div class="payment-amount-display">
                            <div class="label">Amount Due</div>
                            <div class="amount" id="payment-amount-due">R0.00</div>
                            <p id="payment-invoice-info" style="font-size:13px;color:var(--text-muted);margin-top:8px;"></p>
                        </div>
                        <div class="payment-form-body">
                            <form id="payment-form" onsubmit="recordPayment(event)">
                                <div class="invoice-form-group">
                                    <label class="invoice-form-label">Payment Amount <span class="required">*</span></label>
                                    <input type="number" id="payment-amount" required class="invoice-form-input"
                                        step="0.01" min="0.01" placeholder="0.00" style="font-size:18px;font-weight:600;">
                                </div>
                                <div class="invoice-form-group">
                                    <label class="invoice-form-label">Payment Method <span class="required">*</span></label>
                                    <select id="payment-method" required class="invoice-form-select">
                                        <option value="">Select method...</option>
                                        <option value="cash">💵 Cash</option>
                                        <option value="card_on_site">💳 Card (On Site)</option>
                                        <option value="eft">🏦 EFT</option>
                                        <option value="payfast">⚡ PayFast</option>
                                        <option value="yoco">📱 Yoco</option>
                                    </select>
                                </div>
                                <div class="invoice-form-group">
                                    <label class="invoice-form-label">Reference Number</label>
                                    <input type="text" id="payment-reference" class="invoice-form-input"
                                        placeholder="Transaction ID, Receipt #, etc.">
                                </div>
                                <div class="invoice-form-group">
                                    <label class="invoice-form-label">Notes</label>
                                    <textarea id="payment-notes" rows="2" class="invoice-form-textarea" placeholder="Optional notes..."></textarea>
                                </div>
                                <div style="display: flex; gap: 12px; margin-top: 24px;">
                                    <button type="button" class="invoice-btn invoice-btn-outline" style="flex:1" onclick="closePaymentModal()">Cancel</button>
                                    <button type="submit" class="invoice-btn invoice-btn-primary" style="flex:2">
                                        <svg style="width:18px;height:18px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                        </svg>
                                        Record Payment
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- VIEW INVOICE MODAL -->
                <div id="view-invoice-modal" class="modal-overlay" style="display: none;">
                    <div class="modal" style="max-width: 800px; width: 95%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
                        <div class="modal-header" style="background: linear-gradient(135deg, var(--brand-pink) 0%, #e05a7f 100%); color: white; padding: 20px 24px;">
                            <div>
                                <h3 id="view-invoice-number" style="margin: 0; font-size: 20px;">INV-2025-00001</h3>
                                <p id="view-invoice-date" style="margin: 4px 0 0; opacity: 0.9; font-size: 14px;">11 Dec 2025</p>
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span id="view-invoice-status" class="status-badge" style="background: rgba(255,255,255,0.2); color: white;">Finalized</span>
                                <button class="modal-close" onclick="closeViewInvoiceModal()" style="color: white; background: rgba(255,255,255,0.2); border-radius: 50%; width: 32px; height: 32px;">&times;</button>
                            </div>
                        </div>
                        <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 0;">
                            <!-- Business & Customer Info -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 20px; background: var(--gray-light);">
                                <div>
                                    <div style="font-size: 11px; text-transform: uppercase; color: var(--text-subtle); margin-bottom: 4px;">From</div>
                                    <div id="view-invoice-biz-name" style="font-weight: 600; font-size: 16px; color: var(--brand-pink);">Flirt Hair & Beauty Bar</div>
                                    <div id="view-invoice-biz-line1" style="font-size: 13px; color: var(--text-muted);">Shop 5, Lifestyle Centre</div>
                                    <div id="view-invoice-biz-line2" style="font-size: 13px; color: var(--text-muted);">Corner Witkoppen & Cedar Road</div>
                                    <div id="view-invoice-biz-city" style="font-size: 13px; color: var(--text-muted);">Fourways, Johannesburg, 2191</div>
                                    <div id="view-invoice-biz-vat" style="font-size: 13px; color: var(--text-muted); margin-top: 4px; display: none;"></div>
                                </div>
                                <div>
                                    <div style="font-size: 11px; text-transform: uppercase; color: var(--text-subtle); margin-bottom: 4px;">Bill To</div>
                                    <div id="view-invoice-customer" style="font-weight: 600; font-size: 16px;">Italo Olivier</div>
                                    <div id="view-invoice-customer-email" style="font-size: 13px; color: var(--text-muted);"></div>
                                    <div id="view-invoice-customer-phone" style="font-size: 13px; color: var(--text-muted);"></div>
                                </div>
                            </div>
                            <!-- Stylist Info -->
                            <div style="padding: 12px 20px; border-bottom: 1px solid var(--border-soft);">
                                <span style="font-size: 12px; color: var(--text-subtle);">Stylist: </span>
                                <span id="view-invoice-stylist" style="font-weight: 500;">Emma Williams</span>
                                <span id="view-invoice-service-date" style="font-size: 13px; color: var(--text-muted); margin-left: 12px;"></span>
                            </div>

                            <!-- Services -->
                            <div style="padding: 20px;">
                                <h4 style="margin: 0 0 12px; font-size: 14px; color: var(--text-subtle); text-transform: uppercase;">Services</h4>
                                <div id="view-invoice-services" style="border: 1px solid var(--border-soft); border-radius: 8px; overflow: hidden;">
                                    <!-- Services rendered here -->
                                </div>
                            </div>

                            <!-- Products (if any) -->
                            <div id="view-invoice-products-section" style="padding: 0 20px 20px; display: none;">
                                <h4 style="margin: 0 0 12px; font-size: 14px; color: var(--text-subtle); text-transform: uppercase;">Products</h4>
                                <div id="view-invoice-products" style="border: 1px solid var(--border-soft); border-radius: 8px; overflow: hidden;">
                                    <!-- Products rendered here -->
                                </div>
                            </div>

                            <!-- Totals -->
                            <div style="padding: 0 20px 20px;">
                                <div style="background: var(--gray-light); border-radius: 8px; padding: 16px;">
                                    <div id="view-invoice-totals">
                                        <!-- Totals rendered here -->
                                    </div>
                                </div>
                            </div>

                            <!-- Payment Status & History -->
                            <div style="padding: 0 20px 20px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <h4 style="margin: 0; font-size: 14px; color: var(--text-subtle); text-transform: uppercase;">Payment</h4>
                                    <span id="view-invoice-payment-status" class="status-badge"></span>
                                </div>
                                <div id="view-invoice-payments" style="border: 1px solid var(--border-soft); border-radius: 8px; overflow: hidden;">
                                    <!-- Payments rendered here -->
                                </div>
                            </div>

                            <!-- Notes (if any) -->
                            <div id="view-invoice-notes-section" style="padding: 0 20px 20px; display: none;">
                                <h4 style="margin: 0 0 12px; font-size: 14px; color: var(--text-subtle); text-transform: uppercase;">Notes</h4>
                                <div id="view-invoice-notes" style="background: #fffef0; border: 1px solid #ffe082; border-radius: 8px; padding: 12px; font-size: 14px; color: #5d4037;">
                                </div>
                            </div>
                        </div>

                        <!-- Footer Actions -->
                        <div style="padding: 16px 24px; border-top: 1px solid var(--border-soft); display: flex; gap: 12px; justify-content: flex-end; background: white;">
                            <button class="btn btn-outline" onclick="printInvoice()">
                                <svg style="width:16px;height:16px;margin-right:6px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M6 9V2h12v7M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"></path>
                                    <rect x="6" y="14" width="12" height="8"></rect>
                                </svg>
                                Print
                            </button>
                            <button id="view-invoice-record-payment-btn" class="btn btn-primary" onclick="recordPaymentFromView()" style="display: none;">
                                Record Payment
                            </button>
                            <button class="btn btn-outline" onclick="closeViewInvoiceModal()">Close</button>
                        </div>
                    </div>
                </div>

                <!-- ============================================ -->
                <!-- COMMISSIONS SECTION -->
                <!-- ============================================ -->
                <section id="commissions" class="page-section">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Commission Reports</h1>
                            <p class="page-subtitle">View and manage stylist commissions</p>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="card" style="margin-bottom: 24px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 12px;">
                            <div class="form-group">
                                <label>Stylist</label>
                                <select id="commission-stylist" class="form-control">
                                    <option value="">Select stylist...</option>
                                    <!-- Populated dynamically -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Start Date</label>
                                <input type="date" id="commission-start-date" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>End Date</label>
                                <input type="date" id="commission-end-date" class="form-control">
                            </div>
                            <div class="form-group">
                                <label style="visibility: hidden;">Action</label>
                                <button class="btn btn-primary" onclick="loadCommissionReport()" style="width: 100%;">
                                    View Report
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Commission Summary -->
                    <div id="commission-summary" style="display: none; margin-bottom: 24px;">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-icon" style="background: var(--primary-light); color: var(--primary);">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                        <polyline points="14 2 14 8 20 8"></polyline>
                                    </svg>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-label">Paid Invoices</div>
                                    <div class="stat-value" id="comm-invoices-count">0</div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon" style="background: rgba(76, 175, 80, 0.12); color: var(--success);">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="12" y1="1" x2="12" y2="23"></line>
                                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                                    </svg>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-label">Total Sales</div>
                                    <div class="stat-value" id="comm-total-sales">R0.00</div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon" style="background: rgba(33, 150, 243, 0.12); color: var(--info);">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="7 10 12 15 17 10"></polyline>
                                        <line x1="12" y1="15" x2="12" y2="3"></line>
                                    </svg>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-label">Total Commission</div>
                                    <div class="stat-value" id="comm-total-commission">R0.00</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Commission Detail -->
                    <div class="card" id="commission-detail" style="display: none;">
                        <div style="margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center;">
                            <h3>Commission Breakdown</h3>
                            <button class="btn btn-primary" onclick="markCommissionsAsPaid()" id="mark-paid-btn">
                                Mark Selected as Paid
                            </button>
                        </div>
                        <div id="commission-list-container">
                            <!-- Populated dynamically -->
                        </div>
                    </div>
                </section>

                <!-- Promotions Section -->
                <section id="promotions" class="page-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>Active Promotions</h3>
                        <button class="btn btn-primary" onclick="openModal('addPromoModal')">+ Create Promotion</button>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div>
                                    <div class="stat-value" id="promoActiveCount">0</div>
                                    <div class="stat-label">Active Promos</div>
                                </div>
                                <div class="stat-icon pink">🏷️</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div>
                                    <div class="stat-value" id="promoCodesUsed">0</div>
                                    <div class="stat-label">Codes Used</div>
                                </div>
                                <div class="stat-icon gold">🎟️</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div>
                                    <div class="stat-value" id="promoDiscountsGiven">R0</div>
                                    <div class="stat-label">Discounts Given</div>
                                </div>
                                <div class="stat-icon green">💸</div>
                            </div>
                        </div>
                    </div>

                    <div class="data-card">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Description</th>
                                    <th>Discount</th>
                                    <th>Min Order</th>
                                    <th>Uses</th>
                                    <th>Special Offer</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Populated dynamically by loadPromos() -->
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Push Notifications Section -->
                <section id="notifications" class="page-section">
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Push Notifications</h3>
                            <button class="btn btn-primary btn-small" onclick="showCreateNotificationModal()">+ Create Notification</button>
                        </div>
                        <p style="color: var(--gray-medium); margin-bottom: 20px;">
                            Send branded notifications to all app users. Notifications appear as elegant toast messages in the client app.
                        </p>

                        <div id="notificationsList">
                            <!-- Notifications will be loaded dynamically -->
                            <div style="text-align: center; padding: 40px; color: var(--gray-medium);">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48" style="margin-bottom: 10px; opacity: 0.5;">
                                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                                    <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                                </svg>
                                <p>Loading notifications...</p>
                            </div>
                        </div>
                    </div>

                </section>

                <!-- Gallery Section -->
                <section id="gallery" class="page-section">
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Gallery Management</h3>
                            <div style="display:flex; gap:10px; align-items:center;">
                                <button class="btn btn-outline btn-small" onclick="openInstagramModal()">Instagram Feed</button>
                                <button class="btn btn-outline btn-small" onclick="importFlirthairGallery()">Import from flirthair.co.za</button>
                                <button class="btn btn-primary btn-small" onclick="showGalleryModal()">+ Add Image</button>
                            </div>
                        </div>
                        <p style="color: var(--gray-medium); margin-bottom: 20px;">
                            Manage the gallery images displayed on the client app. Drag to reorder, toggle visibility, or add new images.
                        </p>

                        <div class="data-card" style="margin-bottom: 15px;">
                            <div class="data-card-header">
                                <h4 class="data-card-title" style="font-size: 16px;">Instagram Feed</h4>
                                <span id="instagramStatus" style="font-size: 12px; color: var(--gray-medium);"></span>
                            </div>
                            <div style="padding: 15px; color: var(--gray-medium);">
                                Configure your Instagram handle to surface the feed in the client gallery.
                                <div style="margin-top: 10px;">
                                    <button class="btn btn-outline btn-small" onclick="openInstagramModal()">Configure</button>
                                </div>
                            </div>
                        </div>

                        <div id="galleryList" class="gallery-admin-grid">
                            <!-- Gallery items will be loaded dynamically -->
                            <div style="text-align: center; padding: 40px; color: var(--gray-medium); grid-column: 1/-1;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48" style="margin-bottom: 10px; opacity: 0.5;">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                    <polyline points="21 15 16 10 5 21"></polyline>
                                </svg>
                                <p>Loading gallery...</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Chat Section -->
                <section id="chat" class="page-section">
                    <div style="display: grid; grid-template-columns: 350px 1fr; gap: 20px; height: calc(100vh - 200px);">
                        <div class="data-card" style="margin: 0; display: flex; flex-direction: column;">
                            <div class="data-card-header">
                                <h3 class="data-card-title">Conversations</h3>
                                <span class="nav-badge" id="totalUnreadBadge" style="display: none;">0</span>
                            </div>
                            <div class="chat-list" id="adminChatList">
                                <!-- Conversations loaded dynamically -->
                                <div style="text-align: center; padding: 40px; color: var(--gray-medium);">
                                    Loading conversations...
                                </div>
                            </div>
                        </div>
                        <div class="data-card" style="margin: 0; display: flex; flex-direction: column;">
                            <div class="data-card-header" id="chatHeader">
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <div class="chat-avatar" id="selectedChatAvatar">?</div>
                                    <div>
                                        <div style="font-weight: 600;" id="selectedChatName">Select a conversation</div>
                                        <div style="font-size: 12px; color: var(--gray-medium);" id="selectedChatStatus"></div>
                                    </div>
                                </div>
                                <div class="action-btns" id="chatActions" style="display: none;">
                                    <button class="btn btn-outline btn-sm" onclick="closeConversation()">Close Chat</button>
                                </div>
                            </div>
                            <div style="flex: 1; padding: 20px; overflow-y: auto; background: var(--gray-light);" id="chatMessagesAdmin">
                                <div style="text-align: center; padding: 60px 20px; color: var(--gray-medium);">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48" style="margin-bottom: 15px; opacity: 0.5;">
                                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                    </svg>
                                    <p>Select a conversation from the left to view messages</p>
                                </div>
                            </div>
                            <div style="padding: 15px; border-top: 1px solid var(--gray-light); display: flex; gap: 10px;" id="chatInputArea">
                                <input type="text" class="form-input" id="adminChatInput" placeholder="Type a message..." style="flex: 1;" onkeydown="handleAdminChatKeypress(event)" disabled>
                                <button class="btn btn-primary" id="adminSendBtn" onclick="sendAdminChatMessage()" disabled>Send</button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Hair Tips Section -->
                <section id="hair-tips" class="page-section">
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Hair Care Tips</h3>
                            <button class="btn btn-primary btn-sm" onclick="openHairTipModal()">+ Add Tip</button>
                        </div>
                        <div style="padding: 20px;">
                            <p style="color: var(--gray-medium); margin-bottom: 20px;">
                                Manage the hair care tips that rotate on the customer app. Active tips are shown randomly to customers on each visit.
                            </p>
                            <div id="hairTipsList" style="display: flex; flex-direction: column; gap: 12px;">
                                <div style="text-align: center; padding: 40px; color: var(--gray-medium);">
                                    Loading tips...
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Hair Tip Modal -->
                <div id="hairTipModal" class="modal-overlay">
                    <div class="modal" style="max-width: 520px; width: 90%;">
                        <div class="modal-header">
                            <h3 id="hairTipModalTitle">Add New Hair Tip</h3>
                            <button class="modal-close" onclick="closeHairTipModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" id="editHairTipId">
                            <div class="form-group">
                                <label class="form-label">Tip Text *</label>
                                <textarea class="form-input" id="hairTipText" rows="4" placeholder="Enter the hair care tip..." style="resize: vertical;"></textarea>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Category</label>
                                    <select class="form-input" id="hairTipCategory">
                                        <option value="general">General</option>
                                        <option value="extensions">Extensions</option>
                                        <option value="styling">Styling</option>
                                        <option value="care">Care</option>
                                        <option value="maintenance">Maintenance</option>
                                        <option value="wash">Wash</option>
                                        <option value="treatment">Treatment</option>
                                        <option value="heat">Heat</option>
                                        <option value="detangle">Detangle</option>
                                        <option value="scalp">Scalp</option>
                                        <option value="drying">Drying</option>
                                        <option value="protection">Protection</option>
                                        <option value="lifestyle">Lifestyle</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Priority</label>
                                    <select class="form-input" id="hairTipPriority">
                                        <option value="1">Normal</option>
                                        <option value="2">High</option>
                                        <option value="3">Featured</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-outline" onclick="closeHairTipModal()">Cancel</button>
                            <button class="btn btn-primary" onclick="saveHairTip()">Save Tip</button>
                        </div>
                    </div>
                </div>

                <!-- Staff Management Section (Admin Only) -->
                <section id="staff" class="page-section admin-only">
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Staff Management</h3>
                            <button class="btn btn-primary" onclick="showAddStaffModal()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                                Add Staff Member
                            </button>
                        </div>
                        <div style="padding: 25px;">
                            <p style="color: #666; margin-bottom: 20px;">
                                Manage staff logins and permissions. Staff members can access the admin console with restricted permissions.
                            </p>
                            <div id="staff-list-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Email</th>
                                            <th>Role</th>
                                            <th>Linked Stylist</th>
                                            <th>Permissions</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="staff-table-body">
                                        <tr><td colspan="6" style="text-align: center; padding: 40px;">Loading staff...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Add/Edit Staff Modal -->
                <div id="staff-modal" class="modal" style="display: none;">
                    <div class="modal-content" style="max-width: 600px;">
                        <div class="modal-header">
                            <h3 id="staff-modal-title">Add Staff Member</h3>
                            <button class="modal-close" onclick="closeStaffModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" id="staff-edit-id">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Name *</label>
                                    <input type="text" class="form-input" id="staff-name" placeholder="Full name">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Email *</label>
                                    <input type="email" class="form-input" id="staff-email" placeholder="Email address">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Phone</label>
                                    <input type="tel" class="form-input" id="staff-phone" placeholder="Phone number">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Link to Stylist (Optional)</label>
                                    <select class="form-input" id="staff-stylist">
                                        <option value="">-- No linked stylist --</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group" id="staff-password-group">
                                <label class="form-label">Initial Password (leave blank to auto-generate)</label>
                                <input type="text" class="form-input" id="staff-password" placeholder="Temporary password">
                            </div>
                            <div class="form-group">
                                <label class="form-label" style="margin-bottom: 15px;">Permissions</label>
                                <div id="staff-permissions-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                                    <!-- Permissions will be loaded dynamically -->
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="closeStaffModal()">Cancel</button>
                            <button class="btn btn-primary" onclick="saveAdminStaff()">Save</button>
                        </div>
                    </div>
                </div>

                <!-- Settings Section -->
                <section id="settings" class="page-section">
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Business Settings</h3>
                        </div>
                        <div style="padding: 25px;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Business Name</label>
                                    <input type="text" class="form-input" id="settingsBusinessName" placeholder="Enter business name">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-input" id="settingsEmail" placeholder="Enter email address">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Phone</label>
                                    <input type="tel" class="form-input" id="settingsPhone" placeholder="Enter phone number">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Address</label>
                                    <input type="text" class="form-input" id="settingsAddress" placeholder="Enter full address">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Business Hours <span style="font-weight: normal; color: var(--gray-medium);">(click to edit)</span></label>
                                <div id="businessHoursGrid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px;">
                                    <!-- Hours will be populated by JavaScript -->
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="saveBusinessSettings()">Save Settings</button>
                        </div>
                    </div>

                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Service Pricing</h3>
                            <a href="#" onclick="navigateToSection('services'); return false;" class="btn btn-outline btn-sm">Manage Services</a>
                        </div>
                        <div style="padding: 20px; background: var(--gray-light); border-radius: 8px; margin: 15px;">
                            <p style="margin: 0; color: var(--gray-medium); font-size: 14px;">
                                Service pricing is managed in the <strong>Services</strong> section.
                                <a href="#" onclick="navigateToSection('services'); return false;" style="color: var(--primary);">Go to Services</a>
                            </p>
                        </div>
                    </div>

                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Delivery Settings</h3>
                        </div>
                        <div style="padding: 25px;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Standard Courier Fee</label>
                                    <div style="position: relative;">
                                        <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--gray-medium);">R</span>
                                        <input type="number" class="form-input" id="deliveryStandardFee" placeholder="65" style="padding-left: 30px;" min="0" step="0.01">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Express Courier Fee</label>
                                    <div style="position: relative;">
                                        <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--gray-medium);">R</span>
                                        <input type="number" class="form-input" id="deliveryExpressFee" placeholder="120" style="padding-left: 30px;" min="0" step="0.01">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Free Delivery Threshold</label>
                                <div style="position: relative; max-width: 200px;">
                                    <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--gray-medium);">R</span>
                                    <input type="number" class="form-input" id="deliveryFreeThreshold" placeholder="500" style="padding-left: 30px;" min="0" step="0.01">
                                </div>
                                <p style="font-size: 13px; color: var(--gray-medium); margin-top: 5px;">Orders above this amount get free standard delivery</p>
                            </div>
                            <button class="btn btn-primary" onclick="saveDeliverySettings()">Save Delivery Settings</button>
                        </div>
                    </div>
                </section>

                <!-- Loyalty Settings Section - Hidden for now, to be implemented later -->
                <section id="loyalty-settings" class="page-section" style="display: none !important;">
                    <div class="section-header">
                        <h2 class="section-title">Loyalty Program Settings</h2>
                        <p style="color: var(--gray-medium); margin-top: 5px;">Configure points earning rules and tier thresholds</p>
                    </div>

                    <!-- Points Earning Rules -->
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Points Earning Rules</h3>
                        </div>
                        <div style="padding: 25px;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Points per Booking</label>
                                    <input type="number" id="loyaltyBookingPoints" class="form-input" min="0" placeholder="50">
                                    <p style="font-size: 12px; color: var(--gray-medium); margin-top: 5px;">Points earned for each booking made</p>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Rands per Point (Shop)</label>
                                    <input type="number" id="loyaltySpendRand" class="form-input" min="1" placeholder="10">
                                    <p style="font-size: 12px; color: var(--gray-medium); margin-top: 5px;">Spend R X to earn 1 point on shop orders</p>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Review Bonus Points</label>
                                    <input type="number" id="loyaltyReviewPoints" class="form-input" min="0" placeholder="25">
                                    <p style="font-size: 12px; color: var(--gray-medium); margin-top: 5px;">Points earned for leaving a review</p>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Referral Bonus Points</label>
                                    <input type="number" id="loyaltyReferralPoints" class="form-input" min="0" placeholder="100">
                                    <p style="font-size: 12px; color: var(--gray-medium); margin-top: 5px;">Points for both referrer and referee</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Referral Program Settings -->
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Referral Program Settings</h3>
                        </div>
                        <div style="padding: 25px;">
                            <div class="form-row">
                                <div class="form-group" style="flex: 0 0 auto;">
                                    <label class="form-label">Enable Referrals</label>
                                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                        <input type="checkbox" id="referralEnabled" checked style="width: 20px; height: 20px;">
                                        <span>Active</span>
                                    </label>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Discount Type</label>
                                    <select id="referralDiscountType" class="form-input">
                                        <option value="percent">Percentage (%)</option>
                                        <option value="amount">Fixed Amount (R)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Discount Value</label>
                                    <input type="number" id="referralDiscountValue" class="form-input" min="0" placeholder="10">
                                    <p style="font-size: 12px; color: var(--gray-medium); margin-top: 5px;">e.g. 10 = "10%" or "R10"</p>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Section Headline</label>
                                    <input type="text" id="referralHeadline" class="form-input" placeholder="Rewards & Referrals">
                                    <p style="font-size: 12px; color: var(--gray-medium); margin-top: 5px;">Main title shown in the app</p>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Subheading</label>
                                    <input type="text" id="referralSubheading" class="form-input" placeholder="Share your code and you both save!">
                                    <p style="font-size: 12px; color: var(--gray-medium); margin-top: 5px;">Text below the referral code</p>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Share Message Template</label>
                                <textarea id="referralShareMessage" class="form-input" rows="3" placeholder="Check out Flirt Hair Extensions! Use my code {code} for {discount} off your first booking! 💇✨"></textarea>
                                <p style="font-size: 12px; color: var(--gray-medium); margin-top: 5px;">
                                    Use <code style="background: #f0f0f0; padding: 2px 5px; border-radius: 3px;">{code}</code> for user's code and
                                    <code style="background: #f0f0f0; padding: 2px 5px; border-radius: 3px;">{discount}</code> for the discount (e.g. "10%" or "R50")
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Ways to Earn Points Editor -->
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Ways to Earn Points (Display)</h3>
                        </div>
                        <div style="padding: 25px;">
                            <p style="color: var(--gray-medium); margin-bottom: 15px; font-size: 14px;">
                                Configure the "Ways to Earn Points" list shown in the app. Labels can include <code style="background: #f0f0f0; padding: 2px 5px; border-radius: 3px;">{spendRand}</code> placeholder.
                            </p>
                            <div id="earnRulesEditor">
                                <!-- Dynamically populated -->
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 15px; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="saveLoyaltySettings()" style="flex: 1;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" style="margin-right: 8px;"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                            Save Changes
                        </button>
                        <button class="btn btn-outline" onclick="resetLoyaltySettings()" style="flex: 1;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" style="margin-right: 8px;"><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg>
                            Reset to Defaults
                        </button>
                    </div>

                    <!-- Validation Errors -->
                    <div id="loyaltyErrors" style="margin-top: 15px; padding: 15px; background: rgba(244,67,54,0.1); border-radius: 8px; border-left: 4px solid var(--danger); display: none;">
                        <strong style="color: var(--danger);">Validation Errors:</strong>
                        <ul id="loyaltyErrorList" style="margin: 10px 0 0 20px; color: var(--danger);"></ul>
                    </div>

                    <!-- Success Message -->
                    <div id="loyaltySuccess" style="margin-top: 15px; padding: 15px; background: rgba(76,175,80,0.1); border-radius: 8px; border-left: 4px solid var(--success); display: none;">
                        <strong style="color: var(--success);">Settings saved successfully!</strong>
                    </div>
                </section>

                <!-- Rewards Programme Settings Section -->
                <section id="rewards-settings" class="page-section">
                    <div class="section-header">
                        <h2 class="section-title">Rewards Programme Settings</h2>
                        <p style="color: var(--gray-medium); margin-top: 5px;">Configure the salon rewards programme - milestones, discounts, and packages</p>
                    </div>

                    <!-- Programme Status -->
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Programme Status</h3>
                        </div>
                        <div style="padding: 25px;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Programme Enabled</label>
                                    <label class="switch" style="margin-top: 10px;">
                                        <input type="checkbox" id="rewardsProgrammeEnabled" checked>
                                        <span class="slider"></span>
                                    </label>
                                    <p style="font-size: 12px; color: var(--gray-medium); margin-top: 5px;">Enable or disable the entire rewards programme</p>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Programme Name</label>
                                    <input type="text" id="rewardsProgrammeName" class="form-input" placeholder="Salon Rewards">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Dynamic Reward Tracks -->
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Reward Tracks</h3>
                            <button class="btn btn-primary" onclick="showAddTrackModal()">+ Add New Track</button>
                        </div>
                        <div style="padding: 25px;">
                            <p style="color: var(--gray-medium); margin-bottom: 20px;">
                                Configure reward tracks that customers can earn. Each track has milestones that award discounts when reached.
                                Link services or categories to tracks to automatically track customer progress.
                            </p>
                            <div id="dynamicRewardTracks" style="display: grid; gap: 20px;">
                                <div style="text-align: center; padding: 40px; color: var(--gray-medium); background: var(--gray-light); border-radius: 8px;">
                                    <span style="font-size: 48px; display: block; margin-bottom: 15px;">🎁</span>
                                    <p>Loading reward tracks...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Referral Rewards -->
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Referral Rewards</h3>
                            <label class="switch">
                                <input type="checkbox" id="rewardsReferralEnabled" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div style="padding: 25px;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Minimum Booking Value (R)</label>
                                    <input type="number" id="rewardsReferralMinValue" class="form-input" min="0" value="1000">
                                    <p style="font-size: 12px; color: var(--gray-medium); margin-top: 5px;">Referee's first booking must be at least this amount</p>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Reward Description</label>
                                    <input type="text" id="rewardsReferralDescription" class="form-input" value="Complimentary wash & blow-dry">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Service Packages -->
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Service Packages</h3>
                            <label class="switch">
                                <input type="checkbox" id="rewardsPackagesEnabled" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div style="padding: 25px;">
                            <p style="color: var(--gray-medium); margin-bottom: 15px;">Configure pre-paid session packages (e.g., 4 wash & blow-dry sessions at 20% off)</p>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Default Package Sessions</label>
                                    <input type="number" id="rewardsPackageSessions" class="form-input" min="1" value="4">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Default Package Discount %</label>
                                    <input type="number" id="rewardsPackageDiscount" class="form-input" min="1" max="100" value="20">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Service-to-Reward Track Mappings -->
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Service-to-Reward Track Mappings</h3>
                            <button class="btn btn-outline" onclick="loadServiceRewardMappings()">Refresh</button>
                        </div>
                        <div style="padding: 25px;">
                            <p style="color: var(--gray-medium); margin-bottom: 20px;">
                                Configure which services trigger which reward tracks. Services can be linked directly or by category.
                                Rewards are processed when the associated invoice is paid.
                            </p>

                            <!-- Reward Track Definitions -->
                            <div style="margin-bottom: 25px;">
                                <h4 style="font-size: 16px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                    <span>Active Reward Tracks</span>
                                    <button class="btn btn-sm btn-outline" onclick="showAddTrackModal()" style="font-size: 12px; padding: 4px 12px;">+ Add Track</button>
                                </h4>
                                <div id="rewardTrackDefinitions" style="display: grid; gap: 10px;">
                                    <div style="text-align: center; padding: 20px; color: var(--gray-medium);">Loading...</div>
                                </div>
                            </div>

                            <!-- Category Mappings -->
                            <div style="margin-bottom: 25px;">
                                <h4 style="font-size: 16px; margin-bottom: 15px;">Category Mappings</h4>
                                <p style="font-size: 13px; color: var(--gray-medium); margin-bottom: 15px;">
                                    Map entire service categories to reward tracks. All services in a category will count toward the linked track.
                                </p>
                                <div id="categoryRewardMappings" style="display: flex; flex-wrap: wrap; gap: 10px;">
                                    <div style="text-align: center; padding: 20px; color: var(--gray-medium); width: 100%;">Loading...</div>
                                </div>
                                <div style="margin-top: 15px; display: flex; gap: 10px; align-items: center;">
                                    <select id="newCategoryMappingCategory" class="form-input" style="max-width: 200px;">
                                        <option value="">Select Category</option>
                                    </select>
                                    <select id="newCategoryMappingTrack" class="form-input" style="max-width: 200px;">
                                        <option value="">Select Track</option>
                                    </select>
                                    <button class="btn btn-primary btn-sm" onclick="addCategoryMapping()">Add Mapping</button>
                                </div>
                            </div>

                            <!-- Individual Service Mappings -->
                            <div>
                                <h4 style="font-size: 16px; margin-bottom: 15px;">Individual Service Overrides</h4>
                                <p style="font-size: 13px; color: var(--gray-medium); margin-bottom: 15px;">
                                    Override category mappings for specific services or link services that don't belong to a mapped category.
                                </p>
                                <div id="serviceRewardMappings" style="margin-bottom: 15px;">
                                    <div style="text-align: center; padding: 20px; color: var(--gray-medium);">Loading...</div>
                                </div>
                                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                                    <select id="newServiceMappingService" class="form-input" style="max-width: 250px;">
                                        <option value="">Select Service</option>
                                    </select>
                                    <select id="newServiceMappingTrack" class="form-input" style="max-width: 200px;">
                                        <option value="">Select Track</option>
                                    </select>
                                    <button class="btn btn-primary btn-sm" onclick="addServiceMapping()">Add Mapping</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Analytics Summary -->
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Rewards Analytics</h3>
                            <button class="btn btn-outline" onclick="loadRewardsAnalytics()">Refresh</button>
                        </div>
                        <div id="rewardsAnalyticsContent" style="padding: 25px;">
                            <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px;">
                                <div class="stat-card">
                                    <div class="stat-value" id="rewardsStatTotal">-</div>
                                    <div class="stat-label">Total Rewards Issued</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" id="rewardsStatActive">-</div>
                                    <div class="stat-label">Active Rewards</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" id="rewardsStatRedeemed">-</div>
                                    <div class="stat-label">Redeemed</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" id="rewardsStatUsers">-</div>
                                    <div class="stat-label">Users with Rewards</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Save Button -->
                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="saveRewardsSettings()">Save Rewards Settings</button>
                    </div>

                    <!-- Messages -->
                    <div id="rewardsErrors" style="margin-top: 15px; padding: 15px; background: rgba(244,67,54,0.1); border-radius: 8px; border-left: 4px solid var(--danger); display: none;">
                        <strong style="color: var(--danger);">Error:</strong>
                        <span id="rewardsErrorMessage"></span>
                    </div>
                    <div id="rewardsSuccess" style="margin-top: 15px; padding: 15px; background: rgba(76,175,80,0.1); border-radius: 8px; border-left: 4px solid var(--success); display: none;">
                        <strong style="color: var(--success);">Settings saved successfully!</strong>
                    </div>
                </section>

                <!-- Hair Tracker Settings Section -->
                <section id="hair-tracker-settings" class="page-section">
                    <div class="section-header">
                        <h2 class="section-title">Hair Tracker Settings</h2>
                        <p style="color: var(--gray-medium); margin-top: 5px;">Configure hair care tracking intervals and display settings</p>
                    </div>

                    <!-- Interval Settings -->
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Default Intervals</h3>
                        </div>
                        <div style="padding: 25px;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Default Maintenance Interval (days)</label>
                                    <input type="number" id="trackerDefaultMaintenance" class="form-input" min="1" placeholder="42">
                                    <p style="font-size: 12px; color: var(--gray-medium); margin-top: 5px;">Fallback when extension type not set</p>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Recommended Wash Frequency (days)</label>
                                    <input type="number" id="trackerWashFrequency" class="form-input" min="1" placeholder="3">
                                    <p style="font-size: 12px; color: var(--gray-medium); margin-top: 5px;">Days between recommended washes</p>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Deep Condition Frequency (days)</label>
                                    <input type="number" id="trackerDeepConditionFrequency" class="form-input" min="1" placeholder="14">
                                    <p style="font-size: 12px; color: var(--gray-medium); margin-top: 5px;">Recommended deep conditioning interval</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Extension Type Intervals -->
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Extension Type Maintenance Intervals</h3>
                        </div>
                        <div style="padding: 25px;">
                            <p style="color: var(--gray-medium); margin-bottom: 15px; font-size: 14px;">
                                Set maintenance interval for each extension type. Set to 0 for no-maintenance items (clip-ins, etc.)
                            </p>
                            <div id="extensionTypesEditor">
                                <!-- Dynamically populated -->
                            </div>
                        </div>
                    </div>

                    <!-- Health Score Settings -->
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Health Score Calculation</h3>
                        </div>
                        <div style="padding: 25px;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Base Score</label>
                                    <input type="number" id="trackerHealthBase" class="form-input" min="0" max="100" placeholder="100">
                                    <p style="font-size: 12px; color: var(--gray-medium); margin-top: 5px;">Starting health score (0-100)</p>
                                </div>
                            </div>
                            <h4 style="margin: 20px 0 15px; font-size: 14px; font-weight: 600;">Score Penalties (points deducted)</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Overdue Maintenance (per day)</label>
                                    <input type="number" id="trackerPenaltyMaintenance" class="form-input" min="0" step="0.1" placeholder="0.5">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Missed Deep Condition (per day)</label>
                                    <input type="number" id="trackerPenaltyDeepCondition" class="form-input" min="0" step="0.1" placeholder="0.3">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Excess Washes (per extra wash/week)</label>
                                    <input type="number" id="trackerPenaltyWashes" class="form-input" min="0" step="0.1" placeholder="1.0">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Copy/Labels -->
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Display Text & Labels</h3>
                        </div>
                        <div style="padding: 25px;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Tracker Title</label>
                                    <input type="text" id="trackerCopyTitle" class="form-input" placeholder="Hair Care Journey">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Tracker Subtitle</label>
                                    <input type="text" id="trackerCopySubtitle" class="form-input" placeholder="Keep your extensions healthy and on track">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Next Wash Label</label>
                                    <input type="text" id="trackerCopyWash" class="form-input" placeholder="Next Wash Day">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Maintenance Label</label>
                                    <input type="text" id="trackerCopyMaintenance" class="form-input" placeholder="Maintenance Due">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Deep Condition Label</label>
                                    <input type="text" id="trackerCopyDeepCondition" class="form-input" placeholder="Deep Condition">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">No Install Message</label>
                                    <input type="text" id="trackerCopyNoInstall" class="form-input" placeholder="Set up your hair tracker to get personalized care recommendations!">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Setup Button Text</label>
                                    <input type="text" id="trackerCopySetupBtn" class="form-input" placeholder="Set Up Tracker">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Care Tips -->
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Care Tips</h3>
                        </div>
                        <div style="padding: 25px;">
                            <p style="color: var(--gray-medium); margin-bottom: 15px; font-size: 14px;">
                                Add tips that will be shown to users in the tracker. These are randomly selected.
                            </p>
                            <div id="trackerTipsEditor">
                                <!-- Dynamically populated -->
                            </div>
                            <button class="btn btn-outline" onclick="addTrackerTip()" style="margin-top: 15px;">
                                + Add Tip
                            </button>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 15px; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="saveHairTrackerSettings()" style="flex: 1;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" style="margin-right: 8px;"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                            Save Changes
                        </button>
                        <button class="btn btn-outline" onclick="resetHairTrackerSettings()" style="flex: 1;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" style="margin-right: 8px;"><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg>
                            Reset to Defaults
                        </button>
                    </div>

                    <!-- Status Messages -->
                    <div id="trackerSettingsError" style="margin-top: 15px; padding: 15px; background: rgba(244,67,54,0.1); border-radius: 8px; border-left: 4px solid var(--danger); display: none;">
                        <strong style="color: var(--danger);">Error:</strong>
                        <span id="trackerSettingsErrorText"></span>
                    </div>
                    <div id="trackerSettingsSuccess" style="margin-top: 15px; padding: 15px; background: rgba(76,175,80,0.1); border-radius: 8px; border-left: 4px solid var(--success); display: none;">
                        <strong style="color: var(--success);">Settings saved successfully!</strong>
                    </div>
                </section>

                <!-- Payment Settings Section -->
                <section id="payment-settings" class="page-section">
                    <div class="section-header">
                        <h2 class="section-title">Payment Configuration</h2>
                        <p style="color: var(--gray-medium); margin-top: 5px;">Manage PayFast and Yoco payment gateway settings</p>
                        <button class="btn btn-primary" onclick="refreshPaymentConfig()" style="margin-top: 15px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" style="margin-right: 8px;"><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg>
                            Refresh Status
                        </button>
                    </div>

                    <!-- Editable Payment Settings -->
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Editable Settings</h3>
                        </div>
                        <div style="padding: 25px;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">App URL (used for return/cancel pages)</label>
                                    <input type="text" id="paymentAppUrl" class="form-input" placeholder="https://flirthair.co.za">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">API Base URL (used for webhooks)</label>
                                    <input type="text" id="paymentApiBaseUrl" class="form-input" placeholder="https://api.flirthair.co.za">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">PayFast Merchant ID</label>
                                    <input type="text" id="payfastMerchantId" class="form-input" placeholder="e.g. 10000100">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">PayFast Merchant Key</label>
                                    <input type="text" id="payfastMerchantKey" class="form-input" placeholder="e.g. 46f0cd694581a">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">PayFast Passphrase (recommended)</label>
                                    <input type="text" id="payfastPassphrase" class="form-input" placeholder="Optional but recommended">
                                </div>
                                <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-top: 28px;">
                                    <input type="checkbox" id="payfastSandbox" style="width: 18px; height: 18px;">
                                    <label for="payfastSandbox" class="form-label" style="margin: 0;">Use Sandbox Mode</label>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Yoco Secret Key</label>
                                    <input type="text" id="yocoSecretKey" class="form-input" placeholder="sk_test_xxx or sk_live_xxx">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Yoco Public Key</label>
                                    <input type="text" id="yocoPublicKey" class="form-input" placeholder="pk_test_xxx or pk_live_xxx">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Yoco Webhook Secret</label>
                                <input type="text" id="yocoWebhookSecret" class="form-input" placeholder="Webhook signing secret">
                            </div>

                            <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
                                <button class="btn btn-primary" onclick="savePaymentSettings()">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" style="margin-right: 8px;"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                                    Save Payment Settings
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- App URL Display -->
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Application URL</h3>
                        </div>
                        <div style="padding: 25px;">
                            <div class="form-group">
                                <label class="form-label">Base URL (APP_URL)</label>
                                <input type="text" id="paymentAppUrlDisplay" class="form-input" readonly style="background: var(--gray-light); cursor: not-allowed;">
                                <p style="font-size: 12px; color: var(--gray-medium); margin-top: 5px;">Set via APP_URL environment variable</p>
                            </div>
                        </div>
                    </div>

                    <!-- PayFast Configuration -->
                    <div class="data-card">
                        <div class="data-card-header">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <h3 class="data-card-title">PayFast Configuration</h3>
                                <span id="payfastStatusBadge" class="status-badge" style="display: none;"></span>
                            </div>
                        </div>
                        <div style="padding: 25px;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Mode</label>
                                    <input type="text" id="payfastMode" class="form-input" readonly style="background: var(--gray-light);">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Base URL</label>
                                    <input type="text" id="payfastBaseUrl" class="form-input" readonly style="background: var(--gray-light);">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Notify URL (ITN Endpoint)</label>
                                <input type="text" id="payfastNotifyUrl" class="form-input" readonly style="background: var(--gray-light); font-family: monospace; font-size: 13px;">
                                <p style="font-size: 12px; color: var(--gray-medium); margin-top: 5px;">Configure this URL in your PayFast account under Settings → Integration</p>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Return URL</label>
                                    <input type="text" id="payfastReturnUrl" class="form-input" readonly style="background: var(--gray-light); font-family: monospace; font-size: 13px;">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Cancel URL</label>
                                    <input type="text" id="payfastCancelUrl" class="form-input" readonly style="background: var(--gray-light); font-family: monospace; font-size: 13px;">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                                    Passphrase Configured
                                    <span id="payfastPassphraseIcon"></span>
                                </label>
                                <p style="font-size: 12px; color: var(--gray-medium); margin-top: 5px;">Set via PAYFAST_PASSPHRASE environment variable (recommended for production)</p>
                            </div>
                            <div id="payfastMissingVars" style="display: none; margin-top: 15px; padding: 15px; background: rgba(255,152,0,0.1); border-radius: 8px; border-left: 4px solid var(--warning);">
                                <strong style="color: var(--warning);">Missing Configuration:</strong>
                                <ul id="payfastMissingVarsList" style="margin: 10px 0 0 20px; color: var(--gray-dark);"></ul>
                            </div>
                        </div>
                    </div>

                    <!-- Yoco Configuration -->
                    <div class="data-card">
                        <div class="data-card-header">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <h3 class="data-card-title">Yoco Configuration</h3>
                                <span id="yocoStatusBadge" class="status-badge" style="display: none;"></span>
                            </div>
                        </div>
                        <div style="padding: 25px;">
                            <div class="form-group">
                                <label class="form-label">Base URL</label>
                                <input type="text" id="yocoBaseUrl" class="form-input" readonly style="background: var(--gray-light);">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Webhook URL</label>
                                <input type="text" id="yocoWebhookUrl" class="form-input" readonly style="background: var(--gray-light); font-family: monospace; font-size: 13px;">
                                <p style="font-size: 12px; color: var(--gray-medium); margin-top: 5px;">Configure this URL in your Yoco Dashboard under Developers → Webhooks</p>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                                        Public Key
                                        <span id="yocoPublicKeyIcon"></span>
                                    </label>
                                    <input type="text" id="yocoPublicKeyDisplay" class="form-input" readonly style="background: var(--gray-light); font-family: monospace; font-size: 13px;">
                                    <p style="font-size: 12px; color: var(--gray-medium); margin-top: 5px;">Set via YOCO_PUBLIC_KEY environment variable</p>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                                        Webhook Secret Configured
                                        <span id="yocoWebhookSecretIcon"></span>
                                    </label>
                                    <p style="font-size: 12px; color: var(--gray-medium); margin-top: 5px;">Set via YOCO_WEBHOOK_SECRET environment variable (required for webhook verification)</p>
                                </div>
                            </div>
                            <div id="yocoMissingVars" style="display: none; margin-top: 15px; padding: 15px; background: rgba(255,152,0,0.1); border-radius: 8px; border-left: 4px solid var(--warning);">
                                <strong style="color: var(--warning);">Missing Configuration:</strong>
                                <ul id="yocoMissingVarsList" style="margin: 10px 0 0 20px; color: var(--gray-dark);"></ul>
                            </div>
                        </div>
                    </div>

                    <!-- Configuration Guide -->
                    <div class="data-card" style="background: var(--primary-light); border: 1px solid var(--primary);">
                        <div class="data-card-header">
                            <h3 class="data-card-title" style="color: var(--primary);">Configuration Guide</h3>
                        </div>
                        <div style="padding: 25px; color: var(--gray-dark);">
                            <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 10px;">Environment Variables Required:</h4>
                            <ul style="margin-left: 20px; line-height: 1.8;">
                                <li><code style="background: white; padding: 2px 6px; border-radius: 4px; font-size: 12px;">APP_URL</code> - Your application's base URL (e.g., https://flirthair.co.za)</li>
                                <li><code style="background: white; padding: 2px 6px; border-radius: 4px; font-size: 12px;">PAYFAST_MERCHANT_ID</code> - Your PayFast merchant ID</li>
                                <li><code style="background: white; padding: 2px 6px; border-radius: 4px; font-size: 12px;">PAYFAST_MERCHANT_KEY</code> - Your PayFast merchant key</li>
                                <li><code style="background: white; padding: 2px 6px; border-radius: 4px; font-size: 12px;">PAYFAST_PASSPHRASE</code> - (Optional) PayFast security passphrase</li>
                                <li><code style="background: white; padding: 2px 6px; border-radius: 4px; font-size: 12px;">PAYFAST_SANDBOX</code> - Set to 'true' for sandbox mode</li>
                                <li><code style="background: white; padding: 2px 6px; border-radius: 4px; font-size: 12px;">YOCO_SECRET_KEY</code> - Your Yoco secret key</li>
                                <li><code style="background: white; padding: 2px 6px; border-radius: 4px; font-size: 12px;">YOCO_PUBLIC_KEY</code> - Your Yoco public key</li>
                                <li><code style="background: white; padding: 2px 6px; border-radius: 4px; font-size: 12px;">YOCO_WEBHOOK_SECRET</code> - Your Yoco webhook secret</li>
                            </ul>
                        </div>
                    </div>
                </section>

                <!-- Business Settings Section -->
                <section id="business-settings" class="page-section">
                    <div class="section-header">
                        <h2 class="section-title">Business Details</h2>
                        <p style="color: var(--gray-medium); margin-top: 5px;">Configure your business information for invoices and documents</p>
                    </div>

                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Business Information</h3>
                        </div>
                        <div style="padding: 25px;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Business Name</label>
                                    <input type="text" id="bizBusinessName" class="form-input" placeholder="Flirt Hair & Beauty Bar">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Address Line 1</label>
                                    <input type="text" id="bizAddressLine1" class="form-input" placeholder="Shop number, Building name">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Address Line 2</label>
                                    <input type="text" id="bizAddressLine2" class="form-input" placeholder="Street address">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">City / Suburb</label>
                                    <input type="text" id="bizAddressCity" class="form-input" placeholder="Fourways, Johannesburg">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Postal Code</label>
                                    <input type="text" id="bizAddressPostal" class="form-input" placeholder="2191">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">VAT Registration</label>
                                    <div style="display: flex; gap: 16px; margin-top: 8px;">
                                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                            <input type="radio" name="bizVatRegistered" id="bizVatRegisteredYes" value="yes" onchange="toggleVatNumberField()">
                                            <span>VAT Registered</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                            <input type="radio" name="bizVatRegistered" id="bizVatRegisteredNo" value="no" onchange="toggleVatNumberField()" checked>
                                            <span>Not VAT Registered</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="form-row" id="bizVatNumberRow" style="display: none;">
                                <div class="form-group">
                                    <label class="form-label">VAT Number</label>
                                    <input type="text" id="bizVatNumber" class="form-input" placeholder="e.g. 4123456789">
                                </div>
                            </div>

                            <hr style="margin: 24px 0; border: none; border-top: 1px solid var(--border-soft);">

                            <h4 style="margin-bottom: 16px; font-size: 14px; color: var(--text-subtle);">Contact Details</h4>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Phone Number</label>
                                    <input type="text" id="bizPhone" class="form-input" placeholder="011 465 1234">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Email Address</label>
                                    <input type="email" id="bizEmail" class="form-input" placeholder="info@flirthair.co.za">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Website</label>
                                    <input type="text" id="bizWebsite" class="form-input" placeholder="www.flirthair.co.za">
                                </div>
                            </div>

                            <div style="display: flex; justify-content: flex-end; margin-top: 20px; gap: 12px;">
                                <button class="btn btn-outline" onclick="loadBusinessDetailsForm()">
                                    Reset
                                </button>
                                <button class="btn btn-primary" onclick="saveBusinessDetailsForm()">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" style="margin-right: 8px;"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                                    Save Business Details
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Invoice Preview -->
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Invoice Preview</h3>
                        </div>
                        <div style="padding: 25px;">
                            <p style="color: var(--gray-medium); margin-bottom: 16px;">This is how your business details will appear on invoices:</p>
                            <div style="background: white; border: 1px solid var(--border-soft); border-radius: 8px; padding: 20px; max-width: 400px;">
                                <div id="bizPreviewName" style="font-size: 18px; font-weight: 600; color: var(--brand-pink); margin-bottom: 8px;">Flirt Hair & Beauty Bar</div>
                                <div id="bizPreviewAddress" style="font-size: 13px; color: var(--gray-medium); line-height: 1.6;">
                                    <div id="bizPreviewLine1">Shop 5, Lifestyle Centre</div>
                                    <div id="bizPreviewLine2">Corner Witkoppen & Cedar Road</div>
                                    <div id="bizPreviewCity">Fourways, Johannesburg, 2191</div>
                                </div>
                                <div id="bizPreviewVat" style="font-size: 12px; color: var(--gray-medium); margin-top: 8px; display: none;">VAT No: <span id="bizPreviewVatNum"></span></div>
                                <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-soft); font-size: 12px; color: var(--gray-medium);">
                                    <div id="bizPreviewContact"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Services Section -->
                <section id="services" class="page-section">
                    <div class="section-header">
                        <h2>Service Management</h2>
                        <button class="btn btn-primary" onclick="openServiceModal()">
                            <span style="margin-right: 5px;">+</span> Add New Service
                        </button>
                    </div>

                    <!-- Filters -->
                    <div class="card" style="margin-bottom: 20px;">
                        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 200px;">
                                <input type="text" id="serviceSearchInput" placeholder="Search services..."
                                       onkeyup="filterServices()" class="form-control">
                            </div>
                            <div>
                                <select id="serviceTypeFilter" onchange="filterServices()" class="form-control">
                                    <option value="">All Types</option>
                                </select>
                            </div>
                            <div>
                                <select id="serviceActiveFilter" onchange="filterServices()" class="form-control">
                                    <option value="">All Status</option>
                                    <option value="1">Active</option>
                                    <option value="0">Inactive</option>
                                </select>
                            </div>
                            <div>
                                <select id="serviceBookableFilter" onchange="filterServices()" class="form-control">
                                    <option value="">All Bookable</option>
                                    <option value="1">Bookable Only</option>
                                    <option value="0">Invoice Only</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Services Table -->
                    <div class="card">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Image</th>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Duration</th>
                                    <th>Status</th>
                                    <th>Bookable</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="servicesTableBody">
                                <tr>
                                    <td colspan="9" style="text-align: center; padding: 40px;">
                                        Loading services...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <!-- Create Notification Modal -->
    <div class="modal-overlay" id="createNotificationModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">Create Push Notification</h3>
                <button class="modal-close" onclick="closeNotificationModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Notification Type</label>
                    <select id="notifType" class="form-input">
                        <option value="promo">Promotion</option>
                        <option value="info">Information</option>
                        <option value="booking">Booking</option>
                        <option value="points">Points / Rewards</option>
                        <option value="gift">Gift / Special</option>
                        <option value="warning">Important Notice</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Title *</label>
                    <input type="text" id="notifTitle" class="form-input" placeholder="e.g., Flash Sale Today!">
                </div>
                <div class="form-group">
                    <label class="form-label">Message *</label>
                    <textarea id="notifMessage" class="form-input" rows="3" placeholder="e.g., Get 30% off all tape extensions until midnight!"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Action Button Text (optional)</label>
                    <input type="text" id="notifActionText" class="form-input" placeholder="e.g., Shop Now">
                </div>
                <div class="form-group">
                    <label class="form-label">Expires At (optional)</label>
                    <input type="datetime-local" id="notifExpires" class="form-input">
                </div>

                <div style="background: rgba(246, 117, 153, 0.1); border-radius: 8px; padding: 15px; margin-top: 20px;">
                    <div style="font-weight: 600; margin-bottom: 8px; color: var(--brand-pink);">Preview</div>
                    <div id="notifPreview" style="background: white; border-radius: 8px; padding: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; gap: 12px; align-items: flex-start;">
                        <div style="width: 36px; height: 36px; border-radius: 8px; background: rgba(246, 117, 153, 0.1); display: flex; align-items: center; justify-content: center;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="#F67599" stroke-width="2" width="20" height="20">
                                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                            </svg>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 13px; color: #414042;">Your Title Here</div>
                            <div style="font-size: 12px; color: #6d6e70;">Your message will appear here...</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeNotificationModal()">Cancel</button>
                <button class="btn btn-primary" onclick="createNotification()">Send Notification</button>
            </div>
        </div>
    </div>

    <!-- Service Modal -->
    <div id="serviceModal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="serviceModalTitle">Add New Service</h3>
                <button class="modal-close" onclick="closeServiceModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="serviceForm" onsubmit="saveService(event)">
                    <input type="hidden" id="serviceId">

                    <div class="form-group">
                        <label class="form-label">Service Name *</label>
                        <input type="text" id="serviceName" class="form-input" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea id="serviceDescription" class="form-input" rows="3"></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Service Type *</label>
                            <select id="serviceType" class="form-input" required onchange="onServiceTypeChange()">
                                <option value="">Select a type...</option>
                            </select>
                            <small style="color: var(--text-subtle);"><a href="#" onclick="showManageTypesModal(); return false;">Manage types</a></small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <select id="serviceCategory" class="form-input">
                                <option value="">Select a category...</option>
                            </select>
                            <small style="color: var(--text-subtle);"><a href="#" onclick="showManageCategoriesModal(); return false;">Manage categories</a></small>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Price (R) *</label>
                            <input type="number" id="servicePrice" class="form-input" required min="0" step="0.01">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Duration (minutes)</label>
                            <input type="number" id="serviceDuration" class="form-input" min="0" step="15">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Service Image</label>
                        <div style="display: flex; gap: 10px; align-items: flex-start;">
                            <div style="flex: 1;">
                                <input type="file" id="serviceImageFile" accept="image/jpeg,image/png,image/gif,image/webp"
                                       onchange="onServiceImageFileSelect()" style="display: none;">
                                <button type="button" class="btn btn-outline" onclick="document.getElementById('serviceImageFile').click()" style="width: 100%;">
                                    <span id="serviceImageBtnText">Choose Image</span>
                                </button>
                                <small style="color: var(--text-subtle); display: block; margin-top: 5px;">Max 5MB. JPEG, PNG, GIF, or WebP</small>
                            </div>
                            <div style="flex: 1;">
                                <input type="url" id="serviceImageUrl" class="form-input"
                                       placeholder="Or paste image URL"
                                       oninput="updateServiceImagePreview()">
                            </div>
                        </div>
                        <div id="serviceImagePreview" style="margin-top: 10px; display: none;">
                            <div style="position: relative; display: inline-block;">
                                <img id="serviceImagePreviewImg" src="" alt="Preview" style="max-width: 100%; max-height: 150px; border-radius: 8px; object-fit: cover; border: 1px solid var(--border-color);">
                                <button type="button" onclick="clearServiceImage()" style="position: absolute; top: 5px; right: 5px; background: var(--danger); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px;">&times;</button>
                            </div>
                            <div id="serviceImagePreviewError" style="display: none; color: var(--danger); font-size: 12px; margin-top: 5px;">Failed to load image</div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Display Order</label>
                            <input type="number" id="serviceDisplayOrder" class="form-input" min="0" step="1" placeholder="0">
                            <small style="color: var(--text-subtle);">Lower numbers appear first</small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Commission Rate (%)</label>
                            <input type="number" id="serviceCommissionRate" class="form-input" min="0" max="100" step="1" placeholder="Leave blank for stylist default">
                            <small style="color: var(--text-subtle);">Overrides stylist default rate for this service</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="serviceActive" checked style="cursor: pointer;">
                            <span>Active (visible to customers)</span>
                        </label>
                    </div>

                    <div class="form-group">
                        <label class="form-label" style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="serviceBookable" checked style="cursor: pointer;">
                            <span>Bookable (available for client appointment booking)</span>
                        </label>
                        <small style="color: var(--text-subtle); margin-top: 4px; display: block;">Uncheck for invoice-only services like retail, redemptions, or training</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeServiceModal()">Cancel</button>
                <button class="btn btn-primary" onclick="document.getElementById('serviceForm').requestSubmit()">Save Service</button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal" style="max-width: 420px; width: 90%;">
            <div class="modal-header">
                <h3 class="modal-title" id="confirmTitle">Please Confirm</h3>
                <button class="modal-close" onclick="resolveConfirm(false)">&times;</button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage" style="font-size: 15px; color: var(--brand-charcoal); margin: 0;"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="confirmCancelBtn" onclick="resolveConfirm(false)">Cancel</button>
                <button class="btn btn-primary" id="confirmConfirmBtn" onclick="resolveConfirm(true)">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Product Quantity Input Modal -->
    <div class="modal-overlay stacked" id="quantityInputModal" style="display: none;">
        <div class="modal" style="max-width: 380px; width: 90%;">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--brand-pink) 0%, var(--brand-pink-dark) 100%); color: white; border-radius: 12px 12px 0 0;">
                <h3 class="modal-title" style="color: white;">
                    <svg style="width:20px;height:20px;vertical-align:middle;margin-right:8px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <path d="M16 10a4 4 0 0 1-8 0"></path>
                    </svg>
                    <span id="quantityProductName">Add Product</span>
                </h3>
                <button class="modal-close" style="color: white;" onclick="resolveQuantityInput(null)">&times;</button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--brand-charcoal);">Quantity</label>
                    <input type="number" id="quantityInputValue" min="1" step="1" value="1"
                           style="width: 100%; padding: 12px 16px; border: 2px solid var(--border-soft); border-radius: 10px; font-size: 16px; transition: border-color 0.2s;"
                           onfocus="this.style.borderColor='var(--brand-pink)'"
                           onblur="this.style.borderColor='var(--border-soft)'"
                           onkeydown="if(event.key==='Enter'){document.getElementById('quantityConfirmBtn').click()}">
                </div>
                <p style="font-size: 13px; color: var(--text-muted); margin: 0;">Enter the number of units to add to this invoice.</p>
            </div>
            <div class="modal-footer" style="padding: 16px 24px; background: var(--surface-muted); border-radius: 0 0 12px 12px;">
                <button class="btn btn-outline" onclick="resolveQuantityInput(null)">Cancel</button>
                <button class="btn btn-primary" id="quantityConfirmBtn" onclick="resolveQuantityInput(document.getElementById('quantityInputValue').value)" style="background: var(--brand-pink);">Add to Invoice</button>
            </div>
        </div>
    </div>

    <!-- Product Type Selection Modal -->
    <div class="modal-overlay stacked" id="productTypeModal" style="display: none;">
        <div class="modal" style="max-width: 420px; width: 90%;">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--brand-pink) 0%, var(--brand-pink-dark) 100%); color: white; border-radius: 12px 12px 0 0;">
                <h3 class="modal-title" style="color: white;">
                    <svg style="width:20px;height:20px;vertical-align:middle;margin-right:8px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="16" x2="12" y2="12"></line>
                        <line x1="12" y1="8" x2="12.01" y2="8"></line>
                    </svg>
                    Product Type
                </h3>
                <button class="modal-close" style="color: white;" onclick="resolveProductType(null)">&times;</button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <p style="font-size: 15px; color: var(--brand-charcoal); margin: 0 0 20px 0;">How is this product being used?</p>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <button onclick="resolveProductType('retail')" style="display: flex; align-items: center; gap: 16px; padding: 16px 20px; border: 2px solid var(--border-soft); border-radius: 12px; background: white; cursor: pointer; text-align: left; transition: all 0.2s;"
                            onmouseover="this.style.borderColor='var(--brand-pink)'; this.style.background='rgba(232, 62, 140, 0.05)'"
                            onmouseout="this.style.borderColor='var(--border-soft)'; this.style.background='white'">
                        <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #4CAF50 0%, #2e7d32 100%); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <svg style="width:24px;height:24px;color:white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
                                <line x1="3" y1="6" x2="21" y2="6"></line>
                                <path d="M16 10a4 4 0 0 1-8 0"></path>
                            </svg>
                        </div>
                        <div>
                            <div style="font-weight: 600; color: var(--brand-charcoal); font-size: 15px;">Retail Sale</div>
                            <div style="font-size: 13px; color: var(--text-muted);">Customer takes the product home</div>
                        </div>
                    </button>
                    <button onclick="resolveProductType('service_product')" style="display: flex; align-items: center; gap: 16px; padding: 16px 20px; border: 2px solid var(--border-soft); border-radius: 12px; background: white; cursor: pointer; text-align: left; transition: all 0.2s;"
                            onmouseover="this.style.borderColor='var(--brand-pink)'; this.style.background='rgba(232, 62, 140, 0.05)'"
                            onmouseout="this.style.borderColor='var(--border-soft)'; this.style.background='white'">
                        <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, var(--brand-pink) 0%, var(--brand-pink-dark) 100%); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <svg style="width:24px;height:24px;color:white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
                            </svg>
                        </div>
                        <div>
                            <div style="font-weight: 600; color: var(--brand-charcoal); font-size: 15px;">Service Product</div>
                            <div style="font-size: 13px; color: var(--text-muted);">Used during treatment (e.g., colour, treatment)</div>
                        </div>
                    </button>
                </div>
            </div>
            <div class="modal-footer" style="padding: 12px 24px; background: var(--surface-muted); border-radius: 0 0 12px 12px; justify-content: center;">
                <button class="btn btn-outline" onclick="resolveProductType(null)">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Custom Amount Input Modal (for service products) -->
    <div class="modal-overlay stacked" id="customAmountModal" style="display: none;">
        <div class="modal" style="max-width: 380px; width: 90%;">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--brand-pink) 0%, var(--brand-pink-dark) 100%); color: white; border-radius: 12px 12px 0 0;">
                <h3 class="modal-title" style="color: white;">
                    <svg style="width:20px;height:20px;vertical-align:middle;margin-right:8px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                    </svg>
                    <span id="customAmountProductName">Service Product Amount</span>
                </h3>
                <button class="modal-close" style="color: white;" onclick="resolveCustomAmount(null)">&times;</button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--brand-charcoal);">Amount (R)</label>
                    <input type="number" id="customAmountValue" min="0" step="0.01" placeholder="0.00"
                           style="width: 100%; padding: 12px 16px; border: 2px solid var(--border-soft); border-radius: 10px; font-size: 16px; transition: border-color 0.2s;"
                           onfocus="this.style.borderColor='var(--brand-pink)'"
                           onblur="this.style.borderColor='var(--border-soft)'"
                           onkeydown="if(event.key==='Enter'){document.getElementById('customAmountConfirmBtn').click()}">
                </div>
                <p style="font-size: 13px; color: var(--text-muted); margin: 0;">Enter the amount to charge for this service product usage.</p>
            </div>
            <div class="modal-footer" style="padding: 16px 24px; background: var(--surface-muted); border-radius: 0 0 12px 12px;">
                <button class="btn btn-outline" onclick="resolveCustomAmount(null)">Cancel</button>
                <button class="btn btn-primary" id="customAmountConfirmBtn" onclick="resolveCustomAmount(document.getElementById('customAmountValue').value)" style="background: var(--brand-pink);">Add to Invoice</button>
            </div>
        </div>
    </div>

    <!-- Time Input Dialog -->
    <div class="modal-overlay stacked" id="timeInputDialog" style="display: none;">
        <div class="modal" style="max-width: 380px; width: 90%;">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--brand-pink) 0%, var(--brand-pink-dark) 100%); color: white; border-radius: 12px 12px 0 0;">
                <h3 class="modal-title" style="color: white;">
                    <svg style="width:20px;height:20px;vertical-align:middle;margin-right:8px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                    <span id="timeInputDialogTitle">Set Time</span>
                </h3>
                <button class="modal-close" style="color: white;" onclick="resolveTimeInput(false)">&times;</button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <p id="timeInputDialogMessage" style="font-size: 14px; color: var(--brand-charcoal); margin: 0 0 16px 0;">Enter the time:</p>
                <div style="margin-bottom: 20px;">
                    <input type="time" id="timeInputValue" value="09:00"
                           style="width: 100%; padding: 14px 16px; border: 2px solid var(--border-soft); border-radius: 10px; font-size: 18px; transition: border-color 0.2s; text-align: center;"
                           onfocus="this.style.borderColor='var(--brand-pink)'"
                           onblur="this.style.borderColor='var(--border-soft)'"
                           onkeydown="if(event.key==='Enter'){document.getElementById('timeInputDialogConfirm').click()}">
                </div>
            </div>
            <div class="modal-footer" style="padding: 16px 24px; background: var(--surface-muted); border-radius: 0 0 12px 12px;">
                <button class="btn btn-outline" onclick="resolveTimeInput(false)">Cancel</button>
                <button class="btn btn-primary" id="timeInputDialogConfirm" onclick="resolveTimeInput(true)" style="background: var(--brand-pink);">Confirm</button>
            </div>
        </div>
    </div>

    <div class="admin-toast-container" id="adminToastContainer"></div>

    <!-- Add Staff Modal -->
    <div class="modal-overlay" id="addStaffModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Add Staff Member</h3>
                <button class="modal-close" onclick="closeModal('addStaffModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="image-upload" onclick="document.getElementById('staffPhoto').click()">
                    <div style="font-size: 40px; margin-bottom: 10px;">📷</div>
                    <div>Click to upload photo</div>
                    <input type="file" id="staffPhoto" accept="image/*" style="display: none;" onchange="handleStaffPhotoUpload(event)">
                    <img id="staffPhotoPreview" class="image-preview" style="display:none;" alt="Preview">
                </div>
                <div class="form-row" style="margin-top: 20px;">
                    <div class="form-group">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-input" id="staffName" placeholder="e.g., Lisa Thompson">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Role</label>
                        <select class="form-input" id="staffRole">
                            <option value="Stylist">Stylist</option>
                            <option value="Stylist & Extension Specialist">Stylist & Extension Specialist</option>
                            <option value="Nail Babes">Nail Babes</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Bio / Tagline</label>
                    <textarea class="form-input" id="staffTagline" rows="3" placeholder="A cute description that shows their personality..."></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Years Experience</label>
                        <input type="number" class="form-input" id="staffExperience" placeholder="8">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Instagram Handle</label>
                        <input type="text" class="form-input" id="staffInstagram" placeholder="@lisahair">
                    </div>
                </div>
                <div class="form-group" id="staffServicesGroup">
                    <label class="form-label">Services Offered</label>
                    <button type="button" class="btn btn-outline" onclick="handleManageServicesClick()" style="width: 100%;">
                        Manage Services & Pricing
                    </button>
                    <small id="staffServicesHint" style="display: block; margin-top: 5px; color: #666;"></small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('addStaffModal')">Cancel</button>
                <button class="btn btn-primary" id="staffSaveBtn" onclick="saveStaff()">Add Staff Member</button>
            </div>
        </div>
    </div>

    <!-- Staff Services Management Modal -->
    <div class="modal-overlay" id="staffServicesModal" style="display: none;">
        <div class="modal" style="max-width: 1000px;">
            <div class="modal-header">
                <h3 class="modal-title" id="staffServicesModalTitle">Manage Staff Services</h3>
                <button class="modal-close" onclick="closeStaffServicesModal()">&times;</button>
            </div>
            <div class="modal-body" style="padding: 0;">
                <!-- Tab Navigation -->
                <div style="display: flex; border-bottom: 2px solid var(--border-soft); background: var(--surface-muted);">
                    <button class="staff-services-tab active" id="tabCategories" onclick="switchServicesTab('categories')">
                        <span style="font-size: 18px;">📁</span> Add by Category
                    </button>
                    <button class="staff-services-tab" id="tabIndividual" onclick="switchServicesTab('individual')">
                        <span style="font-size: 18px;">📋</span> Add Individual
                    </button>
                    <button class="staff-services-tab" id="tabAssigned" onclick="switchServicesTab('assigned')">
                        <span style="font-size: 18px;">✓</span> Assigned <span id="assignedCountBadge" class="tab-badge">0</span>
                    </button>
                </div>

                <!-- Categories Tab -->
                <div id="panelCategories" class="staff-services-panel" style="padding: 20px;">
                    <p style="color: var(--text-subtle); margin-bottom: 15px;">Select categories to quickly add all services within them:</p>
                    <div id="categoriesList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px;">
                        <!-- Populated dynamically -->
                    </div>
                </div>

                <!-- Individual Services Tab -->
                <div id="panelIndividual" class="staff-services-panel" style="display: none; padding: 20px;">
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <input type="text" id="serviceSearchFilter" placeholder="Search services..."
                               class="form-input" style="flex: 1;" onkeyup="filterAvailableServices()">
                        <select id="serviceCategoryFilter" class="form-input" style="width: 200px;" onchange="filterAvailableServices(true)">
                            <option value="">All Categories</option>
                        </select>
                    </div>
                    <div id="availableServicesList" style="max-height: 450px; overflow-y: auto; border: 1px solid var(--border-soft); border-radius: 8px;">
                        <!-- Populated dynamically -->
                    </div>
                </div>

                <!-- Assigned Services Tab -->
                <div id="panelAssigned" class="staff-services-panel" style="display: none; padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <p style="color: var(--text-subtle); margin: 0;">Services this staff member can perform:</p>
                        <button class="btn btn-outline btn-sm" onclick="removeAllStaffServices()" style="color: var(--danger);">
                            Remove All
                        </button>
                    </div>
                    <div id="staffServicesList" style="max-height: 450px; overflow-y: auto;">
                        <!-- Populated dynamically -->
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid var(--border-soft);">
                <button class="btn btn-outline" onclick="closeStaffServicesModal()">Done</button>
            </div>
        </div>
    </div>

    <style>
        .staff-services-tab {
            padding: 12px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-subtle);
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }
        .staff-services-tab:hover {
            background: rgba(0,0,0,0.03);
            color: var(--text-primary);
        }
        .staff-services-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: white;
        }
        .tab-badge {
            background: var(--primary);
            color: white;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
        }
        .category-card {
            background: white;
            border: 2px solid var(--border-soft);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .category-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .category-card.partial {
            border-color: #f0ad4e;
            background: linear-gradient(135deg, white 0%, #fff9f0 100%);
        }
        .category-card.full {
            border-color: var(--success);
            background: linear-gradient(135deg, white 0%, #f0fff4 100%);
        }
        .category-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        .category-card-title {
            font-weight: 600;
            font-size: 15px;
            color: var(--text-primary);
        }
        .category-card-count {
            font-size: 12px;
            color: var(--text-subtle);
            background: var(--surface-muted);
            padding: 2px 8px;
            border-radius: 10px;
        }
        .category-card-progress {
            height: 4px;
            background: var(--border-soft);
            border-radius: 2px;
            margin: 10px 0;
            overflow: hidden;
        }
        .category-card-progress-fill {
            height: 100%;
            background: var(--success);
            border-radius: 2px;
            transition: width 0.3s;
        }
        .category-card-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .category-card-actions .btn {
            flex: 1;
            padding: 8px 12px;
            font-size: 13px;
        }
        .service-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-soft);
        }
        .service-item:last-child {
            border-bottom: none;
        }
        .service-item:hover {
            background: var(--surface-muted);
        }
        .service-item-info {
            flex: 1;
        }
        .service-item-name {
            font-weight: 500;
            color: var(--text-primary);
        }
        .service-item-meta {
            font-size: 12px;
            color: var(--text-subtle);
            margin-top: 2px;
        }
        .assigned-category-group {
            margin-bottom: 20px;
        }
        .assigned-category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 16px;
            background: var(--surface-muted);
            border-radius: 8px 8px 0 0;
            border: 1px solid var(--border-soft);
            border-bottom: none;
        }
        .assigned-category-title {
            font-weight: 600;
            font-size: 14px;
        }
        .assigned-services-list {
            border: 1px solid var(--border-soft);
            border-radius: 0 0 8px 8px;
        }
    </style>

    <!-- Add Product Modal -->
    <div class="modal-overlay" id="addProductModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Add Product</h3>
                <button class="modal-close" onclick="closeModal('addProductModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="image-upload" onclick="document.getElementById('productPhoto').click()">
                    <div style="font-size: 40px; margin-bottom: 10px;">🧴</div>
                    <div>Click to upload product image</div>
                    <input type="file" id="productPhoto" accept="image/*" style="display: none;">
                </div>
                <div class="form-group" style="margin-top: 10px;">
                    <label class="form-label">Image URL</label>
                    <input type="url" class="form-input" id="productImageUrl" placeholder="https://...product.png" oninput="updateProductImagePreview(this.value)">
                    <div id="productImagePreview" style="margin-top: 8px; display: none;">
                        <img alt="Preview" style="width: 80px; height: 80px; object-fit: contain; background: var(--surface-muted); border-radius: 8px; padding: 6px;">
                    </div>
                </div>
                <div class="form-row" style="margin-top: 20px;">
                    <div class="form-group">
                        <label class="form-label">Product Name</label>
                        <input type="text" class="form-input" id="productName" placeholder="e.g., Angel.Wash">
                    </div>
                    <div class="form-group">
                        <label class="form-label">SKU</label>
                        <input type="text" class="form-input" id="productSku" placeholder="e.g., KM-AW-001">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-input" id="productDescription" rows="3" placeholder="Product description..."></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select class="form-input" id="productCategory">
                            <option value="Care Products">Care Products</option>
                            <option value="Styling">Styling</option>
                            <option value="Extensions">Extensions</option>
                            <option value="Accessories">Accessories</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Stock Quantity</label>
                        <input type="number" class="form-input" id="productStock" placeholder="24">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Regular Price (R)</label>
                        <input type="number" class="form-input" id="productPrice" placeholder="385">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Sale Price (R) - Optional</label>
                        <input type="number" class="form-input" id="productSalePrice" placeholder="Leave empty if not on sale">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('addProductModal')">Cancel</button>
                <button class="btn btn-primary" id="productSaveBtn" onclick="saveProduct()">Add Product</button>
            </div>
        </div>
    </div>

    <!-- Add Booking Modal -->
    <div class="modal-overlay" id="addBookingModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">New Booking</h3>
                <button class="modal-close" onclick="closeModal('addBookingModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Customer</label>
                    <div style="display: flex; gap: 8px;">
                        <select class="form-input" id="adminBookingCustomer" style="flex: 1;">
                            <option value="">Loading customers...</option>
                        </select>
                        <button type="button" class="btn btn-outline" onclick="openNewCustomerFromBooking()" title="Add new customer" style="padding: 8px 12px; white-space: nowrap;">
                            + New
                        </button>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Service</label>
                        <select class="form-input" id="adminBookingService" onchange="handleAdminBookingServiceChange()">
                            <option value="">Loading services...</option>
                        </select>
                    </div>
                    <div class="form-group" id="adminBookingStylistGroup">
                        <label class="form-label">Stylist</label>
                        <select class="form-input" id="adminBookingStylist">
                            <option value="">Any available</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Date <span style="color: var(--danger);">*</span></label>
                        <input type="date" class="form-input" id="adminBookingDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Start Time <span style="color: var(--danger);">*</span></label>
                        <input type="time" class="form-input" id="adminBookingTime" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Duration (minutes)</label>
                        <input type="number" class="form-input" id="adminBookingDuration" min="15" step="15" placeholder="Auto-filled from service">
                        <small style="color: var(--gray-medium); font-size: 12px;">Automatically set based on selected service</small>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-input" rows="3" id="adminBookingNotes" placeholder="Any special requirements or notes..."></textarea>
                </div>
                <div id="adminBookingError" style="color: var(--danger); font-size: 13px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('addBookingModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveBooking()">Create Booking</button>
            </div>
        </div>
    </div>

    <!-- Add Promotion Modal -->
    <div class="modal-overlay" id="addPromoModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">Create Promotion</h3>
                <button class="modal-close" onclick="closeModal('addPromoModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Promo Code *</label>
                        <input type="text" class="form-input" id="promoCode" placeholder="e.g., SUMMER30" style="text-transform: uppercase;">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-input" id="promoDescription" placeholder="e.g., 30% off summer sale">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Discount Type *</label>
                        <select class="form-input" id="promoType">
                            <option value="percentage">Percentage Off</option>
                            <option value="fixed">Fixed Amount Off (Rands)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Discount Value *</label>
                        <input type="number" class="form-input" id="promoValue" placeholder="e.g., 30" min="0">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Minimum Order (R)</label>
                        <input type="number" class="form-input" id="promoMinOrder" placeholder="0" min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Usage Limit</label>
                        <input type="number" class="form-input" id="promoUsageLimit" placeholder="Unlimited" min="0">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Expires At</label>
                    <input type="datetime-local" class="form-input" id="promoExpiresAt">
                </div>

                <!-- Special Offer Section -->
                <div style="border-top: 1px solid var(--gray-light); margin-top: 20px; padding-top: 20px;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                        <label class="toggle-switch">
                            <input type="checkbox" id="promoHighlighted">
                            <span class="toggle-slider"></span>
                        </label>
                        <span style="font-weight: 600; color: var(--brand-pink);">Show in Special Offers</span>
                    </div>
                    <p style="font-size: 12px; color: var(--gray-medium); margin-bottom: 16px;">
                        Enable this to display the promotion as a Special Offer card on the customer-facing site.
                    </p>
                    <div id="specialOfferFields" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Offer Title</label>
                                <input type="text" class="form-input" id="promoTitle" placeholder="e.g., Summer Glow Package 🌟">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Badge Text</label>
                                <input type="text" class="form-input" id="promoBadge" placeholder="e.g., LIMITED TIME" style="text-transform: uppercase;">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Subtitle / Card Description</label>
                            <textarea class="form-input" id="promoSubtitle" rows="2" placeholder="e.g., Get 30% off tape extensions + free color consultation"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Sort Order / Priority</label>
                            <input type="number" class="form-input" id="promoPriority" placeholder="1" min="0" style="max-width: 100px;">
                            <small style="color: var(--gray-medium); display: block; margin-top: 4px;">Lower numbers appear first</small>
                        </div>
                    </div>

                    <!-- Shop Banner Toggle -->
                    <div style="border-top: 1px solid var(--border-soft); padding-top: 20px; margin-top: 20px;">
                        <label class="toggle-label" style="cursor: pointer; display: flex; align-items: center; gap: 12px;">
                            <input type="checkbox" id="promoShowInShopBanner">
                            <span style="font-weight: 600; color: var(--brand-pink);">Show as Shop Banner</span>
                        </label>
                        <p style="font-size: 12px; color: var(--gray-medium); margin-bottom: 16px;">
                            Enable this to display the promotion as the main flash sale banner in the shop section. Only one promo can be the shop banner at a time.
                        </p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('addPromoModal')">Cancel</button>
                <button class="btn btn-primary" onclick="savePromo()">Create Promotion</button>
            </div>
        </div>
    </div>

    <!-- Password Change Modal (for mustChangePassword) -->
    <div class="modal-overlay" id="changePasswordModal" style="z-index: 9999;">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header" style="background: var(--brand-pink); color: white;">
                <h3 class="modal-title">Password Change Required</h3>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px; color: var(--gray-medium);">
                    For security reasons, you must change your password before continuing.
                </p>
                <div class="form-group">
                    <label class="form-label">Current Password</label>
                    <input type="password" id="currentPassword" class="form-input" placeholder="Enter current password">
                </div>
                <div class="form-group">
                    <label class="form-label">New Password</label>
                    <input type="password" id="newPassword" class="form-input" placeholder="Enter new password (min 8 characters)">
                </div>
                <div class="form-group">
                    <label class="form-label">Confirm New Password</label>
                    <input type="password" id="confirmPassword" class="form-input" placeholder="Confirm new password">
                </div>
                <div id="passwordError" style="color: var(--danger); font-size: 13px; margin-top: 10px; display: none;"></div>
                <div id="passwordStrength" style="margin-top: 10px;">
                    <div style="font-size: 12px; color: var(--gray-medium); margin-bottom: 5px;">Password Strength:</div>
                    <div style="height: 4px; background: #eee; border-radius: 2px; overflow: hidden;">
                        <div id="strengthBar" style="height: 100%; width: 0%; transition: all 0.3s;"></div>
                    </div>
                    <div id="strengthText" style="font-size: 11px; margin-top: 3px; color: var(--gray-medium);"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="logout()">Logout Instead</button>
                <button class="btn btn-primary" onclick="submitPasswordChange()">Change Password</button>
            </div>
        </div>
    </div>

    <!-- Gallery Modal -->
    <div class="modal-overlay" id="galleryModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title" id="galleryModalTitle">Add Gallery Image</h3>
                <button class="modal-close" onclick="closeGalleryModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Image URL *</label>
                    <input type="url" id="galleryImageUrl" class="form-input" placeholder="https://example.com/image.jpg">
                </div>
                <div class="form-group">
                    <label class="form-label">Preview</label>
                    <div id="galleryImagePreview" style="width: 100%; height: 150px; background: var(--gray-light); border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                        <span style="color: var(--gray-medium);">Enter URL to preview</span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Label</label>
                    <input type="text" id="galleryLabel" class="form-input" placeholder="e.g., Blonde Extensions">
                </div>
                <div class="form-group">
                    <label class="form-label">Alt Text</label>
                    <input type="text" id="galleryAltText" class="form-input" placeholder="Description for accessibility">
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select id="galleryCategory" class="form-input">
                        <option value="general">General</option>
                        <option value="extensions">Extensions</option>
                        <option value="styling">Styling</option>
                        <option value="natural">Natural</option>
                        <option value="braids">Braids</option>
                        <option value="color">Color</option>
                        <option value="wigs">Wigs</option>
                    </select>
                </div>
                <input type="hidden" id="galleryEditId">
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeGalleryModal()">Cancel</button>
                <button class="btn btn-primary" id="gallerySubmitBtn" onclick="submitGalleryItem()">Add Image</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // API CONFIGURATION
        // ============================================
        // Use relative URL for production compatibility
        const API_BASE = (() => {
            const origin = window.location.origin;
            const port = window.location.port;
            // If running from file:// or Live Server (not port 3001), use localhost:3001
            if (origin === 'null' || origin.startsWith('file://') || (port && port !== '3001')) {
                console.warn('Running in dev mode - using localhost:3001 for API.');
                return 'http://localhost:3001/api';
            }
            return '/api';
        })();

        // API connectivity status
        let apiConnected = false;

        // ============================================
        // BOOKING CONSTANTS
        // ============================================
        window.BookingConstants = {
            TIME_WINDOWS: {
                MORNING: {
                    id: 'MORNING',
                    label: 'Morning',
                    icon: '🌅',
                    description: '6:00 AM - 12:00 PM',
                    startHour: 6,
                    endHour: 12
                },
                AFTERNOON: {
                    id: 'AFTERNOON',
                    label: 'Afternoon',
                    icon: '☀️',
                    description: '12:00 PM - 3:00 PM',
                    startHour: 12,
                    endHour: 15
                },
                LATE_AFTERNOON: {
                    id: 'LATE_AFTERNOON',
                    label: 'Late Afternoon',
                    icon: '🌤️',
                    description: '3:00 PM - 6:00 PM',
                    startHour: 15,
                    endHour: 18
                },
                EVENING: {
                    id: 'EVENING',
                    label: 'Evening',
                    icon: '🌙',
                    description: '6:00 PM - 10:00 PM',
                    startHour: 18,
                    endHour: 22
                }
            },
            getTimeWindow(id) {
                return this.TIME_WINDOWS[id] || null;
            }
        };

        const formatDateDisplay = (value, options = {}) => {
            if (!value) return '';
            const date = value instanceof Date ? value : new Date(value);
            if (isNaN(date)) return '';
            return new Intl.DateTimeFormat('en-GB', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                ...options
            }).format(date);
        };

        const formatDateWithTime = (value, timeText) => {
            const dateText = formatDateDisplay(value);
            if (!dateText) return '';
            return timeText ? `${dateText}${timeText.trim() ? ` at ${timeText}` : ''}` : dateText;
        };

        const formatCurrencyZAR = (value) => {
            const amount = Number(value || 0);
            return 'R' + amount.toLocaleString('en-ZA', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        };

        function getToken() {
            return localStorage.getItem('flirt_admin_token');
        }

        async function apiCall(endpoint, options = {}) {
            const token = getToken();
            const headers = {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                ...(token && { 'Authorization': `Bearer ${token}` })
            };

            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    ...options,
                    headers: { ...headers, ...options.headers }
                });
                const raw = await response.text();
                let data;
                try {
                    data = raw ? JSON.parse(raw) : {};
                } catch (e) {
                    throw new Error(raw || 'API request failed (non-JSON response)');
                }
                if (!response.ok) throw new Error(data.message || 'API request failed');
                apiConnected = true;
                return data;
            } catch (error) {
                console.error('API Error:', error);
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    apiConnected = false;
                    showConnectionError();
                }
                throw error;
            }
        }

        function showConnectionError() {
            const existingBanner = document.getElementById('connectionError');
            if (existingBanner) return;

            const banner = document.createElement('div');
            banner.id = 'connectionError';
            banner.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; background: #f44336; color: white; padding: 12px; text-align: center; z-index: 10000; font-size: 14px;';
            banner.innerHTML = '⚠️ Unable to connect to server. Please ensure the backend is running.';
            document.body.prepend(banner);
        }

        // ============================================
        // AUTH
        // ============================================
        let adminUser = null;

        async function checkAdminAuth() {
            const token = getToken();
            if (!token) {
                showLoginPrompt();
                return false;
            }
            try {
                const data = await apiCall('/auth/me');
                if (data.user.role !== 'admin' && data.user.role !== 'staff') {
                    alert('Admin access required');
                    showLoginPrompt();
                    return false;
                }
                adminUser = data.user;
                const adminNameEl = document.getElementById('adminName');
                if (adminNameEl) {
                    adminNameEl.textContent = data.user.name;
                }
                return true;
            } catch (error) {
                showLoginPrompt();
                return false;
            }
        }

        function showLoginPrompt() {
            const email = prompt('Admin Email:');
            const password = prompt('Password:');
            if (email && password) {
                login(email, password);
            }
        }

        async function login(email, password) {
            try {
                const data = await apiCall('/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ email, password })
                });
                if (data.user.role !== 'admin' && data.user.role !== 'staff') {
                    alert('Admin access required');
                    return;
                }
                localStorage.setItem('flirt_admin_token', data.token);
                adminUser = data.user;
                document.getElementById('adminName').textContent = data.user.name;

                // Check if password change is required
                if (data.mustChangePassword || data.user.mustChangePassword) {
                    showPasswordChangeModal();
                } else {
                    initDashboard();
                }
            } catch (error) {
                alert('Login failed: ' + error.message);
            }
        }

        function logout() {
            localStorage.removeItem('flirt_admin_token');
            location.reload();
        }

        // ============================================
        // PASSWORD CHANGE (for mustChangePassword)
        // ============================================
        function showPasswordChangeModal() {
            document.getElementById('changePasswordModal').classList.add('show');
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            document.getElementById('passwordError').style.display = 'none';
            updatePasswordStrength('');

            // Add password strength checker
            document.getElementById('newPassword').addEventListener('input', function() {
                updatePasswordStrength(this.value);
            });
        }

        function updatePasswordStrength(password) {
            const strengthBar = document.getElementById('strengthBar');
            const strengthText = document.getElementById('strengthText');

            let strength = 0;
            let text = '';
            let color = '';

            if (password.length >= 8) strength += 25;
            if (password.length >= 12) strength += 15;
            if (/[a-z]/.test(password)) strength += 15;
            if (/[A-Z]/.test(password)) strength += 15;
            if (/[0-9]/.test(password)) strength += 15;
            if (/[^a-zA-Z0-9]/.test(password)) strength += 15;

            if (strength < 30) {
                text = 'Weak';
                color = '#f44336';
            } else if (strength < 60) {
                text = 'Fair';
                color = '#FF9800';
            } else if (strength < 80) {
                text = 'Good';
                color = '#4CAF50';
            } else {
                text = 'Strong';
                color = '#2196F3';
            }

            strengthBar.style.width = strength + '%';
            strengthBar.style.background = color;
            strengthText.textContent = password ? text : '';
            strengthText.style.color = color;
        }

        async function submitPasswordChange() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorDiv = document.getElementById('passwordError');

            // Validation
            if (!currentPassword || !newPassword || !confirmPassword) {
                errorDiv.textContent = 'All fields are required';
                errorDiv.style.display = 'block';
                return;
            }

            if (newPassword.length < 8) {
                errorDiv.textContent = 'New password must be at least 8 characters';
                errorDiv.style.display = 'block';
                return;
            }

            if (newPassword !== confirmPassword) {
                errorDiv.textContent = 'New passwords do not match';
                errorDiv.style.display = 'block';
                return;
            }

            if (newPassword === currentPassword) {
                errorDiv.textContent = 'New password must be different from current password';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                await apiCall('/auth/change-password', {
                    method: 'POST',
                    body: JSON.stringify({ currentPassword, newPassword })
                });

                // Close modal and load dashboard
                document.getElementById('changePasswordModal').classList.remove('show');
                alert('Password changed successfully!');
                initDashboard();
            } catch (error) {
                errorDiv.textContent = error.message || 'Failed to change password';
                errorDiv.style.display = 'block';
            }
        }

        // ============================================
        // NAVIGATION
        // ============================================
        function showSection(sectionId, evt) {
            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');

            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            // Find the nav item for this section and mark it active
            const navEvent = evt || window.event;
            if (navEvent && navEvent.target) {
                const navItem = navEvent.target.closest('.nav-item');
                if (navItem) navItem.classList.add('active');
            } else {
                // Fallback: find nav item by section id
                document.querySelectorAll('.nav-item').forEach(item => {
                    if (item.getAttribute('onclick')?.includes(`'${sectionId}'`)) {
                        item.classList.add('active');
                    }
                });
            }

            const titles = {
                'dashboard': 'Dashboard',
                'bookings': 'Bookings',
                'team': 'Team Members',
                'staff': 'Staff Management',
                'payroll': 'Payroll Management',
                'services': 'Service Management',
                'customers': 'Customers',
                'products': 'Products & Inventory',
                'orders': 'Product Orders',
                'promotions': 'Promotions & Sales',
                'notifications': 'Push Notifications',
                'gallery': 'Gallery Management',
                'chat': 'Customer Chat',
                'hair-tips': 'Hair Care Tips',
                'loyalty-settings': 'Loyalty Settings',
                'hair-tracker-settings': 'Hair Tracker Settings',
                'business-settings': 'Business Details',
                'settings': 'Settings'
            };
            document.getElementById('pageTitle').textContent = titles[sectionId] || 'Dashboard';

            // Load section data
            switch(sectionId) {
                case 'dashboard': initDashboard(); break;
                case 'bookings':
                    if (typeof initBookingsFilters === 'function') {
                        initBookingsFilters().then(() => loadBookings());
                    } else {
                        loadBookings();
                    }
                    break;
                case 'team': loadTeam(); break;
                case 'staff': loadStaff(); break;
                case 'payroll':
                    initPayrollYearSelector();
                    loadPayroll();
                    loadStylistPaySettings();
                    break;
                case 'services': loadServices(); break;
                case 'customers': loadCustomers(); break;
                case 'products': loadProducts(); break;
                case 'orders': loadOrders(); break;
                case 'promotions': loadPromos(); break;
                case 'notifications': loadNotifications(); break;
                case 'gallery': loadGallery(); break;
                case 'loyalty-settings': loadLoyaltySettings(); break;
                case 'rewards-settings': loadRewardsSettings(); break;
                case 'hair-tracker-settings': loadHairTrackerSettings(); break;
                case 'payment-settings': loadPaymentSettings(); break;
                case 'chat': loadAdminConversations(); break;
                case 'hair-tips': loadHairTips(); break;
                case 'staff': loadStaff(); break;
                case 'settings': loadSettingsPage(); break;
                case 'business-settings': loadBusinessDetailsForm(); break;
            }

            // Close sidebar on mobile after navigation
            if (window.innerWidth < 1024) {
                closeSidebar();
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('show');
            // Prevent body scroll when sidebar is open
            document.body.style.overflow = sidebar.classList.contains('open') ? 'hidden' : '';
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.remove('open');
            overlay.classList.remove('show');
            document.body.style.overflow = '';
        }

        // ============================================
        // ADMIN MENU & GLOBAL SEARCH
        // ============================================
        function toggleAdminMenu() {
            const dropdown = document.getElementById('adminDropdown');
            dropdown.classList.toggle('show');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('adminDropdown');
            const profile = document.querySelector('.admin-profile');
            if (dropdown && profile && !profile.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });

        let searchDebounceTimer = null;

        function handleGlobalSearch(event) {
            const query = event.target.value.trim().toLowerCase();
            const resultsContainer = document.getElementById('searchResults');

            if (searchDebounceTimer) clearTimeout(searchDebounceTimer);

            if (query.length < 2) {
                resultsContainer.classList.remove('show');
                return;
            }

            searchDebounceTimer = setTimeout(() => performGlobalSearch(query), 300);
        }

        function handleSearchKeydown(event) {
            if (event.key === 'Escape') {
                document.getElementById('searchResults').classList.remove('show');
                event.target.blur();
            }
        }

        async function performGlobalSearch(query) {
            const resultsContainer = document.getElementById('searchResults');
            let html = '';

            try {
                // Search customers
                const customersRes = await fetch(`${API_BASE}/admin/customers?search=${encodeURIComponent(query)}&limit=5`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('flirt_admin_token')}` }
                });
                if (customersRes.ok) {
                    const customersData = await customersRes.json();
                    const customers = customersData.customers || customersData.users || customersData || [];
                    if (customers.length > 0) {
                        html += `<div class="search-result-group">
                            <div class="search-result-group-title">Customers</div>
                            ${customers.slice(0, 5).map(c => `
                                <div class="search-result-item" onclick="selectSearchResult('customers', '${c.id}')">
                                    <span class="icon">👤</span>
                                    <div class="details">
                                        <div class="name">${c.name || 'Unknown'}</div>
                                        <div class="meta">${c.email || ''}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>`;
                    }
                }

                // Search bookings
                const bookingsRes = await fetch(`${API_BASE}/admin/bookings?search=${encodeURIComponent(query)}&limit=5`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('flirt_admin_token')}` }
                });
                if (bookingsRes.ok) {
                    const bookingsData = await bookingsRes.json();
                    const bookings = bookingsData.bookings || bookingsData || [];
                    if (bookings.length > 0) {
                        html += `<div class="search-result-group">
                            <div class="search-result-group-title">Bookings</div>
                            ${bookings.slice(0, 5).map(b => `
                                <div class="search-result-item" onclick="selectSearchResult('bookings', '${b.id}')">
                                    <span class="icon">📅</span>
                                    <div class="details">
                                        <div class="name">${b.customerName || b.customer_name || 'Guest'}</div>
                                        <div class="meta">${b.serviceName || b.service_name || 'Service'} - ${b.date || ''}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>`;
                    }
                }

                // Quick navigation
                html += `<div class="search-result-group">
                    <div class="search-result-group-title">Quick Navigation</div>
                    <div class="search-result-item" onclick="selectSearchResult('customers'); filterCustomersByQuery('${query.replace(/'/g, "\\'")}')">
                        <span class="icon">🔍</span>
                        <div class="details">
                            <div class="name">Search all customers for "${query}"</div>
                        </div>
                    </div>
                </div>`;

                resultsContainer.innerHTML = html;
                resultsContainer.classList.add('show');
            } catch (error) {
                console.error('Search error:', error);
            }
        }

        function selectSearchResult(section, id) {
            document.getElementById('searchResults').classList.remove('show');
            document.getElementById('globalSearch').value = '';
            showSection(section);

            // If an ID is provided, try to open the specific item
            if (id) {
                setTimeout(() => {
                    if (section === 'customers') {
                        // Open customer details modal
                        if (typeof viewCustomer === 'function') {
                            viewCustomer(id);
                        }
                    } else if (section === 'bookings') {
                        // Highlight or open booking
                        if (typeof viewBookingDetails === 'function') {
                            viewBookingDetails(id);
                        }
                    }
                }, 200);
            }
        }

        function filterCustomersByQuery(query) {
            setTimeout(() => {
                const searchInput = document.getElementById('customerSearchInput');
                if (searchInput) {
                    searchInput.value = query;
                    // Trigger the filterCustomers function directly
                    if (typeof filterCustomers === 'function') {
                        filterCustomers();
                    }
                }
            }, 200);
        }

        // Close search results when clicking outside
        document.addEventListener('click', function(e) {
            const searchBox = document.querySelector('.search-box');
            const resultsContainer = document.getElementById('searchResults');
            if (searchBox && resultsContainer && !searchBox.contains(e.target)) {
                resultsContainer.classList.remove('show');
            }
        });

        // ============================================
        // DASHBOARD
        // ============================================
        let revenueChartInstance = null;
        let servicesChartInstance = null;

        // Show dashboard alert
        function showDashboardAlert(message, type = 'error') {
            const alert = document.getElementById('dashboardAlert');
            if (alert) {
                alert.className = `dashboard-alert ${type}`;
                alert.innerHTML = `<span>${type === 'error' ? '⚠️' : type === 'warning' ? '⚡' : 'ℹ️'}</span> ${message}`;
                alert.style.display = 'flex';
            }
        }

        function hideDashboardAlert() {
            const alert = document.getElementById('dashboardAlert');
            if (alert) alert.style.display = 'none';
        }

        // Load dashboard stats
        async function loadDashboard() {
            // Set loading state
            const statCards = ['statCardRevenue', 'statCardBookings', 'statCardOrders', 'statCardCustomers'];
            statCards.forEach(id => {
                const card = document.getElementById(id);
                if (card) card.classList.add('loading');
            });

            try {
                const data = await apiCall('/admin/stats');
                const stats = data.stats;

                // Update stat cards with correct monthly metrics
                document.getElementById('statMonthRevenue').textContent = 'R' + (stats.monthRevenue || 0).toLocaleString();
                document.getElementById('statMonthBookings').textContent = stats.monthBookings || 0;
                document.getElementById('statMonthOrders').textContent = stats.monthOrders || 0;
                document.getElementById('statActiveCustomers').textContent = stats.activeCustomers || 0;

                // Remove loading state
                statCards.forEach(id => {
                    const card = document.getElementById(id);
                    if (card) card.classList.remove('loading', 'error');
                });

                hideDashboardAlert();
            } catch (error) {
                console.error('Dashboard stats load error:', error);

                // Show error state on cards
                statCards.forEach(id => {
                    const card = document.getElementById(id);
                    if (card) {
                        card.classList.remove('loading');
                        card.classList.add('error');
                    }
                });

                document.getElementById('statMonthRevenue').textContent = 'Error';
                document.getElementById('statMonthBookings').textContent = '-';
                document.getElementById('statMonthOrders').textContent = '-';
                document.getElementById('statActiveCustomers').textContent = '-';

                showDashboardAlert('Unable to load live stats. Please refresh the page.', 'error');
            }
        }

        // Load today's bookings for dashboard
        async function loadTodayBookings() {
            const tbody = document.getElementById('todayBookingsBody');
            if (!tbody) return;

            tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 30px; color: var(--gray-medium);">Loading...</td></tr>`;

            try {
                // Get today's date in YYYY-MM-DD format
                const today = new Date().toISOString().split('T')[0];
                const data = await apiCall(`/admin/bookings?date=${today}`);
                // Filter out cancelled bookings and sort by time
                const bookings = (data.bookings || [])
                    .filter(b => b.status !== 'cancelled')
                    .sort((a, b) => (a.time || '').localeCompare(b.time || ''))
                    .slice(0, 10); // Limit to 10 bookings

                if (bookings.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 30px; color: var(--gray-medium);">
                                📅 No bookings for today
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = bookings.map(b => {
                    const initials = (b.customerName || b.userName || 'G').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
                    const timeStr = b.time || b.confirmedTime || 'TBC';
                    // Format time to 12-hour format
                    let displayTime = timeStr;
                    if (timeStr.match(/^\d{2}:\d{2}$/)) {
                        const [h, m] = timeStr.split(':');
                        const hour = parseInt(h);
                        displayTime = `${hour > 12 ? hour - 12 : hour || 12}:${m} ${hour >= 12 ? 'PM' : 'AM'}`;
                    }

                    return `
                        <tr>
                            <td>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div class="avatar-placeholder">${initials}</div>
                                    ${b.customerName || b.userName || 'Guest'}
                                </div>
                            </td>
                            <td>${b.serviceName || '-'}</td>
                            <td>${b.stylistName || b.stylistId || 'Any'}</td>
                            <td>${displayTime}</td>
                            <td><span class="status-badge status-${b.status}">${b.status}</span></td>
                            <td class="action-btns">
                                ${b.status === 'REQUESTED' ? `
                                    <button class="btn btn-icon btn-outline booking-confirm-btn" data-booking-id="${b.id}" title="Confirm">✅</button>
                                ` : ''}
                                ${b.status === 'CONFIRMED' ? `
                                    <button class="btn btn-icon btn-outline booking-complete-btn" data-booking-id="${b.id}" title="Complete">✔️</button>
                                ` : ''}
                                <button class="btn btn-icon btn-outline" title="View" onclick="showSection('bookings')">👁️</button>
                            </td>
                        </tr>
                    `;
                }).join('');

                // Attach event listeners for today's bookings buttons
                setTimeout(() => attachTodayBookingsListeners(), 0);
            } catch (error) {
                console.error('Today bookings load error:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 30px; color: var(--danger);">
                            Failed to load today's bookings
                        </td>
                    </tr>
                `;
            }
        }

        function attachTodayBookingsListeners() {
            // Confirm buttons in Today's Bookings
            document.querySelectorAll('#todayBookingsBody .booking-confirm-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const bookingId = this.getAttribute('data-booking-id');
                    confirmBookingTime(bookingId);
                });
            });

            // Complete buttons in Today's Bookings
            document.querySelectorAll('#todayBookingsBody .booking-complete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const bookingId = this.getAttribute('data-booking-id');
                    completeBooking(bookingId);
                });
            });
        }

        // Quick action to view today's bookings in full section
        function viewTodayBookings() {
            showSection('bookings');
            // The bookings section will load all bookings; user can filter from there
        }

        // Load Revenue Chart
        async function loadRevenueChart() {
            const canvas = document.getElementById('revenueChart');
            const errorDiv = document.getElementById('revenueChartError');
            if (!canvas) return;

            const range = document.getElementById('revenueChartRange')?.value || '30d';

            try {
                const data = await apiCall(`/admin/revenue-trend?range=${range}`);

                // Destroy existing chart if any
                if (revenueChartInstance) {
                    revenueChartInstance.destroy();
                }

                // Format labels to show only day/month
                const formattedLabels = data.labels.map(d => {
                    const date = new Date(d);
                    return `${date.getDate()}/${date.getMonth() + 1}`;
                });

                revenueChartInstance = new Chart(canvas.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: formattedLabels,
                        datasets: [{
                            label: 'Revenue (R)',
                            data: data.values,
                            borderColor: '#F67599',
                            backgroundColor: 'rgba(246, 117, 153, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 2,
                            pointHoverRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: value => 'R' + value.toLocaleString()
                                }
                            }
                        }
                    }
                });

                if (errorDiv) errorDiv.style.display = 'none';
                canvas.style.display = 'block';
            } catch (error) {
                console.error('Revenue chart load error:', error);
                canvas.style.display = 'none';
                if (errorDiv) errorDiv.style.display = 'block';
            }
        }

        // Load Popular Services Chart
        async function loadPopularServicesChart() {
            const canvas = document.getElementById('servicesChart');
            const errorDiv = document.getElementById('servicesChartError');
            if (!canvas) return;

            try {
                const data = await apiCall('/admin/popular-services?range=30d');

                // Destroy existing chart if any
                if (servicesChartInstance) {
                    servicesChartInstance.destroy();
                }

                const colors = ['#F67599', '#414042', '#4CAF50', '#FF9800', '#2196F3'];

                servicesChartInstance = new Chart(canvas.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Bookings',
                            data: data.values,
                            backgroundColor: colors.slice(0, data.labels.length),
                            borderRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: { precision: 0 }
                            }
                        }
                    }
                });

                if (errorDiv) errorDiv.style.display = 'none';
                canvas.style.display = 'block';
            } catch (error) {
                console.error('Services chart load error:', error);
                canvas.style.display = 'none';
                if (errorDiv) errorDiv.style.display = 'block';
            }
        }

        // Initialize all dashboard components
        async function initDashboard() {
            await Promise.all([
                loadDashboard(),
                loadTodayBookings(),
                loadRevenueChart(),
                loadPopularServicesChart()
            ]);
        }

        // ============================================
        // BOOKINGS
        // ============================================
        let adminBookings = [];
        let allBookings = []; // Unfiltered list
        let currentStatusFilter = 'all';
        let bookingsCalendarMonthOffset = 0;
        let currentBookingsView = 'list';
        let adminBookingDataLoaded = false;
        let adminBookingServices = [];
        let adminBookingStylists = [];
        let adminBookingCustomers = [];

        async function ensureAdminBookingData() {
            if (adminBookingDataLoaded) return;

            const [hairServices, beautyServices, stylistsData, customersData] = await Promise.all([
                apiCall('/services/hair'),
                apiCall('/services/beauty'),
                apiCall('/stylists'),
                apiCall('/admin/customers')
            ]);

            adminBookingServices = [...(hairServices.services || []), ...(beautyServices.services || [])];
            adminBookingStylists = stylistsData.stylists || [];
            adminBookingCustomers = (customersData.customers || []).sort((a, b) => (a.name || '').localeCompare(b.name || ''));
            adminBookingDataLoaded = true;
            populateAdminBookingForm();
        }

        function populateAdminBookingForm() {
            const serviceSelect = document.getElementById('adminBookingService');
            if (serviceSelect) {
                serviceSelect.innerHTML = '<option value=\"\">Select service...</option>' +
                    adminBookingServices.map(s => `
                        <option value=\"${s.id}\" data-type=\"${s.service_type || s.serviceType || 'hair'}\">
                            ${s.name} - R${s.price}
                        </option>
                    `).join('');
            }

            const stylistSelect = document.getElementById('adminBookingStylist');
            if (stylistSelect) {
                stylistSelect.innerHTML = '<option value=\"\">Any available</option>' +
                    adminBookingStylists.map(s => `<option value=\"${s.id}\">${s.name}</option>`).join('');
            }

            const customerSelect = document.getElementById('adminBookingCustomer');
            if (customerSelect) {
                customerSelect.innerHTML = '<option value=\"\">Select customer...</option>' +
                    adminBookingCustomers.map(c => `<option value=\"${c.id}\">${c.name} (${c.email})</option>`).join('');
            }
        }

        async function openAdminBookingModal() {
            const errorEl = document.getElementById('adminBookingError');
            if (errorEl) errorEl.textContent = '';

            try {
                await ensureAdminBookingData();
                populateAdminBookingForm();
                document.getElementById('adminBookingDate').value = '';
                document.getElementById('adminBookingTime').value = '';
                document.getElementById('adminBookingDuration').value = '';
                document.getElementById('adminBookingNotes').value = '';
                document.getElementById('adminBookingCustomer').value = '';
                document.getElementById('adminBookingService').value = '';
                handleAdminBookingServiceChange();
                openModal('addBookingModal');
            } catch (err) {
                alert(`Failed to load booking data: ${err.message}`);
            }
        }

        function handleAdminBookingServiceChange() {
            const select = document.getElementById('adminBookingService');
            const selectedOption = select?.selectedOptions[0];
            const type = selectedOption?.dataset.type || 'hair';
            const duration = selectedOption?.dataset.duration || 60;
            const stylistGroup = document.getElementById('adminBookingStylistGroup');
            const durationInput = document.getElementById('adminBookingDuration');

            // Auto-fill duration from selected service
            if (durationInput && duration) {
                durationInput.value = duration;
            }

            // Show/hide stylist field based on booking type
            if (stylistGroup) {
                stylistGroup.style.display = type === 'hair' ? 'block' : 'none';
            }
        }

        // Bookings filter state
        let bookingsFilters = {
            search: '',
            status: 'all',
            stylistId: 'all',
            serviceId: 'all',
            timeOfDay: 'all',
            dateFrom: null,
            dateTo: null
        };

        // Search with debounce
        let bookingsSearchTimeout = null;
        function onBookingsSearchInput(value) {
            clearTimeout(bookingsSearchTimeout);
            bookingsSearchTimeout = setTimeout(() => {
                bookingsFilters.search = value.trim();
                loadBookings();
            }, 300);
        }

        // Filter change handlers
        function onBookingsFilterChange() {
            const rawStatus = document.getElementById('bookingsStatusFilter')?.value || 'all';
            bookingsFilters.status = rawStatus === 'all' ? 'all' : rawStatus.toUpperCase();
            bookingsFilters.stylistId = document.getElementById('bookingsStylistFilter')?.value || 'all';
            bookingsFilters.serviceId = document.getElementById('bookingsServiceFilter')?.value || 'all';
            const rawTime = document.getElementById('bookingsTimeFilter')?.value || 'all';
            bookingsFilters.timeOfDay = rawTime === 'all' ? 'all' : rawTime.toUpperCase();
            loadBookings();
        }

        function onBookingsDatePresetChange() {
            const preset = document.getElementById('bookingsDatePreset')?.value;
            const dateFromGroup = document.getElementById('bookingsDateFromGroup');
            const dateToGroup = document.getElementById('bookingsDateToGroup');
            const today = new Date();

            if (preset === 'custom') {
                if (dateFromGroup) dateFromGroup.style.display = 'block';
                if (dateToGroup) dateToGroup.style.display = 'block';
                return;
            } else {
                if (dateFromGroup) dateFromGroup.style.display = 'none';
                if (dateToGroup) dateToGroup.style.display = 'none';
            }

            let dateFrom = null;
            let dateTo = null;

            switch(preset) {
                case 'today':
                    dateFrom = dateTo = today.toISOString().split('T')[0];
                    break;
                case 'tomorrow':
                    const tomorrow = new Date(today);
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    dateFrom = dateTo = tomorrow.toISOString().split('T')[0];
                    break;
                case 'thisweek':
                    const startOfWeek = new Date(today);
                    startOfWeek.setDate(today.getDate() - today.getDay());
                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(startOfWeek.getDate() + 6);
                    dateFrom = startOfWeek.toISOString().split('T')[0];
                    dateTo = endOfWeek.toISOString().split('T')[0];
                    break;
                case 'next7days':
                    dateFrom = today.toISOString().split('T')[0];
                    const next7 = new Date(today);
                    next7.setDate(today.getDate() + 7);
                    dateTo = next7.toISOString().split('T')[0];
                    break;
            }

            bookingsFilters.dateFrom = dateFrom;
            bookingsFilters.dateTo = dateTo;
            loadBookings();
        }

        function onBookingsDateRangeChange() {
            const dateFrom = document.getElementById('bookingsDateFrom')?.value;
            const dateTo = document.getElementById('bookingsDateTo')?.value;
            bookingsFilters.dateFrom = dateFrom || null;
            bookingsFilters.dateTo = dateTo || null;
            loadBookings();
        }

        function clearAllBookingsFilters() {
            bookingsFilters = {
                search: '',
                status: 'all',
                stylistId: 'all',
                serviceId: 'all',
                timeOfDay: 'all',
                dateFrom: null,
                dateTo: null
            };

            // Reset UI
            const searchInput = document.getElementById('bookingsSearchInput');
            if (searchInput) searchInput.value = '';
            const statusFilter = document.getElementById('bookingsStatusFilter');
            if (statusFilter) statusFilter.value = 'all';
            const stylistFilter = document.getElementById('bookingsStylistFilter');
            if (stylistFilter) stylistFilter.value = 'all';
            const serviceFilter = document.getElementById('bookingsServiceFilter');
            if (serviceFilter) serviceFilter.value = 'all';
            const timeFilter = document.getElementById('bookingsTimeFilter');
            if (timeFilter) timeFilter.value = 'all';
            const datePreset = document.getElementById('bookingsDatePreset');
            if (datePreset) datePreset.value = 'all';
            const dateFrom = document.getElementById('bookingsDateFrom');
            if (dateFrom) dateFrom.value = '';
            const dateTo = document.getElementById('bookingsDateTo');
            if (dateTo) dateTo.value = '';

            loadBookings();
        }

        async function loadBookings() {
            try {
                // Build query parameters from filters
                const params = new URLSearchParams();

                if (bookingsFilters.search) {
                    params.append('search', bookingsFilters.search);
                }
                if (bookingsFilters.status && bookingsFilters.status !== 'all') {
                    params.append('status', bookingsFilters.status);
                }
                if (bookingsFilters.stylistId && bookingsFilters.stylistId !== 'all') {
                    params.append('stylistId', bookingsFilters.stylistId);
                }
                if (bookingsFilters.serviceId && bookingsFilters.serviceId !== 'all') {
                    params.append('serviceId', bookingsFilters.serviceId);
                }
                if (bookingsFilters.timeOfDay && bookingsFilters.timeOfDay !== 'all') {
                    params.append('timeOfDay', bookingsFilters.timeOfDay);
                }
                if (bookingsFilters.dateFrom) {
                    params.append('dateFrom', bookingsFilters.dateFrom);
                }
                if (bookingsFilters.dateTo) {
                    params.append('dateTo', bookingsFilters.dateTo);
                }

                const url = params.toString() ? `/admin/bookings?${params.toString()}` : '/admin/bookings';
                const data = await apiCall(url);
                allBookings = data.bookings || [];

                // Apply status filter
                applyStatusFilter();

                // Update total count
                const totalEl = document.getElementById('bookingsTotalCount');
                if (totalEl) {
                    if (data.pagination) {
                        totalEl.textContent = `${adminBookings.length} shown of ${data.pagination.total} total`;
                    } else {
                        totalEl.textContent = `${adminBookings.length} total bookings`;
                    }
                }

                // Update sidebar badge
                const badge = document.getElementById('bookingsNavBadge');
                if (badge) {
                    badge.textContent = allBookings.length;
                }

                // Update status filter counts
                updateStatusFilterCounts();

                // Render both views
                renderBookingsTable();
                renderBookingsCalendar();
            } catch (error) {
                console.log('Bookings load error:', error);
                document.getElementById('bookingsTableBody').innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px; color: var(--danger);">
                            Failed to load bookings: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        // Status filter functions
        function filterByStatus(status) {
            currentStatusFilter = status;
            applyStatusFilter();

            // Update active tab
            document.querySelectorAll('.status-filter-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('data-status') === status) {
                    tab.classList.add('active');
                }
            });

            renderBookingsTable();
            renderBookingsCalendar();
        }

        function applyStatusFilter() {
            if (currentStatusFilter === 'all') {
                adminBookings = [...allBookings];
            } else {
                adminBookings = allBookings.filter(b => {
                    const status = (b.status || '').toUpperCase();
                    return status === currentStatusFilter;
                });
            }
        }

        function updateStatusFilterCounts() {
            // Count bookings by status
            const counts = {
                all: allBookings.length,
                REQUESTED: 0,
                CONFIRMED: 0,
                COMPLETED: 0,
                CANCELLED: 0
            };

            allBookings.forEach(b => {
                const status = (b.status || '').toUpperCase();
                if (counts[status] !== undefined) {
                    counts[status]++;
                }
            });

            // Update count badges
            document.getElementById('count-all').textContent = counts.all;
            document.getElementById('count-requested').textContent = counts.REQUESTED;
            document.getElementById('count-confirmed').textContent = counts.CONFIRMED;
            document.getElementById('count-completed').textContent = counts.COMPLETED;
            document.getElementById('count-cancelled').textContent = counts.CANCELLED;
        }

        // ============================================
        // BOOKINGS: SORTING, PAGINATION, BULK ACTIONS
        // ============================================
        let bookingsSortField = 'date';
        let bookingsSortDirection = 'desc';
        let bookingsCurrentPage = 1;
        let bookingsPageSize = 50;
        let selectedBookingIds = new Set();
        let bookingsGroupByDate = false;

        function sortBookingsBy(field) {
            if (bookingsSortField === field) {
                // Toggle direction
                bookingsSortDirection = bookingsSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                bookingsSortField = field;
                bookingsSortDirection = 'asc';
            }

            // Update sort icons
            ['customer', 'service', 'stylist', 'date', 'status'].forEach(f => {
                const icon = document.getElementById(`sortIcon${f.charAt(0).toUpperCase() + f.slice(1)}`);
                if (icon) {
                    icon.textContent = f === field ? (bookingsSortDirection === 'asc' ? '↑' : '↓') : '↕';
                }
            });

            // Sort adminBookings
            adminBookings.sort((a, b) => {
                let valA, valB;
                switch (field) {
                    case 'customer':
                        valA = (a.customerName || '').toLowerCase();
                        valB = (b.customerName || '').toLowerCase();
                        break;
                    case 'service':
                        valA = (a.serviceName || '').toLowerCase();
                        valB = (b.serviceName || '').toLowerCase();
                        break;
                    case 'stylist':
                        valA = (a.stylistName || '').toLowerCase();
                        valB = (b.stylistName || '').toLowerCase();
                        break;
                    case 'date':
                        valA = a.requestedDate || a.date || '';
                        valB = b.requestedDate || b.date || '';
                        break;
                    case 'status':
                        valA = (a.status || '').toLowerCase();
                        valB = (b.status || '').toLowerCase();
                        break;
                    default:
                        valA = '';
                        valB = '';
                }

                if (valA < valB) return bookingsSortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return bookingsSortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            bookingsCurrentPage = 1;
            renderBookingsTable();
        }

        function goToBookingsPage(direction) {
            const totalPages = Math.ceil(adminBookings.length / bookingsPageSize);

            if (direction === 'prev' && bookingsCurrentPage > 1) {
                bookingsCurrentPage--;
            } else if (direction === 'next' && bookingsCurrentPage < totalPages) {
                bookingsCurrentPage++;
            } else if (typeof direction === 'number') {
                bookingsCurrentPage = direction;
            }

            renderBookingsTable();
            updateBookingsPagination();
        }

        function onBookingsPageSizeChange() {
            const select = document.getElementById('bookingsPageSize');
            if (select) {
                bookingsPageSize = parseInt(select.value) || 50;
                bookingsCurrentPage = 1;
                renderBookingsTable();
                updateBookingsPagination();
            }
        }

        function updateBookingsPagination() {
            const total = adminBookings.length;
            const totalPages = Math.ceil(total / bookingsPageSize);
            const start = (bookingsCurrentPage - 1) * bookingsPageSize + 1;
            const end = Math.min(bookingsCurrentPage * bookingsPageSize, total);

            const paginationEl = document.getElementById('bookingsPagination');
            if (paginationEl) {
                paginationEl.style.display = total > bookingsPageSize ? 'flex' : 'none';
            }

            const infoEl = document.getElementById('bookingsPaginationInfo');
            if (infoEl) {
                infoEl.textContent = `Showing ${start}-${end} of ${total}`;
            }

            const prevBtn = document.getElementById('bookingsPrevPage');
            const nextBtn = document.getElementById('bookingsNextPage');
            if (prevBtn) prevBtn.disabled = bookingsCurrentPage <= 1;
            if (nextBtn) nextBtn.disabled = bookingsCurrentPage >= totalPages;

            // Render page numbers
            const pagesEl = document.getElementById('bookingsPaginationPages');
            if (pagesEl && totalPages > 1) {
                let pagesHtml = '';
                for (let i = 1; i <= Math.min(totalPages, 5); i++) {
                    const isActive = i === bookingsCurrentPage;
                    pagesHtml += `<button class="btn btn-sm ${isActive ? '' : 'btn-outline'}"
                                   onclick="goToBookingsPage(${i})"
                                   style="${isActive ? 'background: var(--primary); color: white;' : ''}">${i}</button>`;
                }
                if (totalPages > 5) {
                    pagesHtml += `<span style="padding: 0 8px;">...</span>`;
                    pagesHtml += `<button class="btn btn-sm btn-outline" onclick="goToBookingsPage(${totalPages})">${totalPages}</button>`;
                }
                pagesEl.innerHTML = pagesHtml;
            }
        }

        function toggleSelectAllBookings() {
            const selectAllCheckbox = document.getElementById('bookingsSelectAll');
            const checkboxes = document.querySelectorAll('#bookingsTableBody input[type="checkbox"]');

            if (selectAllCheckbox && selectAllCheckbox.checked) {
                // Select all visible bookings
                const start = (bookingsCurrentPage - 1) * bookingsPageSize;
                const end = Math.min(start + bookingsPageSize, adminBookings.length);
                for (let i = start; i < end; i++) {
                    selectedBookingIds.add(adminBookings[i].id);
                }
                checkboxes.forEach(cb => cb.checked = true);
            } else {
                // Deselect all
                selectedBookingIds.clear();
                checkboxes.forEach(cb => cb.checked = false);
            }

            updateBulkActionsBar();
        }

        function toggleBookingSelection(bookingId) {
            if (selectedBookingIds.has(bookingId)) {
                selectedBookingIds.delete(bookingId);
            } else {
                selectedBookingIds.add(bookingId);
            }
            updateBulkActionsBar();
        }

        function deselectAllBookings() {
            selectedBookingIds.clear();
            document.querySelectorAll('#bookingsTableBody input[type="checkbox"]').forEach(cb => cb.checked = false);
            const selectAllCheckbox = document.getElementById('bookingsSelectAll');
            if (selectAllCheckbox) selectAllCheckbox.checked = false;
            updateBulkActionsBar();
        }

        function updateBulkActionsBar() {
            const bar = document.getElementById('bookingsBulkActionsBar');
            const countEl = document.getElementById('bookingsSelectedCount');

            if (bar) {
                bar.style.display = selectedBookingIds.size > 0 ? 'block' : 'none';
            }
            if (countEl) {
                countEl.textContent = `${selectedBookingIds.size} selected`;
            }
        }

        async function bulkConfirmBookings() {
            if (selectedBookingIds.size === 0) return;

            const confirmed = await openConfirmDialog({
                title: 'Confirm Bookings',
                message: `Are you sure you want to confirm ${selectedBookingIds.size} booking(s)?`,
                confirmText: 'Confirm All',
                tone: 'neutral'
            });

            if (!confirmed) return;

            let successCount = 0;
            for (const id of selectedBookingIds) {
                try {
                    await apiCall(`/admin/bookings/${id}`, {
                        method: 'PUT',
                        body: JSON.stringify({ status: 'CONFIRMED' })
                    });
                    successCount++;
                } catch (error) {
                    console.error(`Failed to confirm booking ${id}:`, error);
                }
            }

            showAdminToast(`${successCount} booking(s) confirmed`, 'success');
            deselectAllBookings();
            loadBookings();
        }

        async function bulkCompleteBookings() {
            if (selectedBookingIds.size === 0) return;

            const confirmed = await openConfirmDialog({
                title: 'Complete Bookings',
                message: `Are you sure you want to mark ${selectedBookingIds.size} booking(s) as completed?`,
                confirmText: 'Complete All',
                tone: 'neutral'
            });

            if (!confirmed) return;

            let successCount = 0;
            for (const id of selectedBookingIds) {
                try {
                    await apiCall(`/admin/bookings/${id}`, {
                        method: 'PUT',
                        body: JSON.stringify({ status: 'COMPLETED' })
                    });
                    successCount++;
                } catch (error) {
                    console.error(`Failed to complete booking ${id}:`, error);
                }
            }

            showAdminToast(`${successCount} booking(s) marked as completed`, 'success');
            deselectAllBookings();
            loadBookings();
        }

        async function bulkCancelBookings() {
            if (selectedBookingIds.size === 0) return;

            const confirmed = await openConfirmDialog({
                title: 'Cancel Bookings',
                message: `Are you sure you want to cancel ${selectedBookingIds.size} booking(s)? This cannot be undone.`,
                confirmText: 'Cancel All',
                tone: 'danger'
            });

            if (!confirmed) return;

            let successCount = 0;
            for (const id of selectedBookingIds) {
                try {
                    await apiCall(`/admin/bookings/${id}`, {
                        method: 'PUT',
                        body: JSON.stringify({ status: 'CANCELLED' })
                    });
                    successCount++;
                } catch (error) {
                    console.error(`Failed to cancel booking ${id}:`, error);
                }
            }

            showAdminToast(`${successCount} booking(s) cancelled`, 'success');
            deselectAllBookings();
            loadBookings();
        }

        function toggleBookingsGrouping() {
            const checkbox = document.getElementById('bookingsGroupByDate');
            bookingsGroupByDate = checkbox ? checkbox.checked : false;
            renderBookingsTable();
        }

        function exportBookingsToCSV() {
            if (adminBookings.length === 0) {
                showAdminToast('No bookings to export', 'error');
                return;
            }

            // Build CSV content
            const headers = ['ID', 'Customer', 'Email', 'Phone', 'Service', 'Stylist', 'Date', 'Time', 'Status', 'Notes'];
            const rows = adminBookings.map(b => [
                b.id,
                b.customerName || 'Guest',
                b.customerEmail || '',
                b.customerPhone || '',
                b.serviceName || '',
                b.stylistName || 'Any',
                b.requestedDate || b.date || '',
                b.assignedStartTime || b.confirmedTime || b.time || b.preferredTimeOfDay || '',
                b.status || '',
                (b.notes || '').replace(/"/g, '""')
            ]);

            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${cell}"`).join(',') + '\n';
            });

            // Download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `bookings-export-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showAdminToast(`Exported ${adminBookings.length} booking(s) to CSV`, 'success');
        }

        function renderBookingsTable() {
            const container = document.getElementById('bookingsTableBody');
            if (!container) return;

            if (adminBookings.length === 0) {
                container.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 40px; color: var(--gray-medium);">
                            No bookings found
                        </td>
                    </tr>
                `;
                updateBookingsPagination();
                return;
            }

            // Apply pagination
            const start = (bookingsCurrentPage - 1) * bookingsPageSize;
            const end = Math.min(start + bookingsPageSize, adminBookings.length);
            const paginatedBookings = adminBookings.slice(start, end);

            // Optional: Group by date
            let html = '';
            let lastDate = null;

            paginatedBookings.forEach(b => {
                // Use new schema fields with fallback to legacy
                const dateStr = formatDateDisplay(b.requestedDate || b.date);
                const rawDate = (b.requestedDate || b.date || '').split('T')[0];

                // Add date separator if grouping is enabled
                if (bookingsGroupByDate && rawDate !== lastDate) {
                    html += `
                        <tr style="background: var(--gray-light);">
                            <td colspan="9" style="padding: 10px 20px; font-weight: 600; color: var(--brand-charcoal);">
                                ${formatDateDisplay(rawDate + 'T00:00:00', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' })}
                            </td>
                        </tr>
                    `;
                    lastDate = rawDate;
                }

                // Format time display based on booking status
                let timeStr = 'TBC';
                if (b.status === 'CONFIRMED') {
                    timeStr = b.assignedStartTime || b.confirmedTime || b.time || 'TBC';
                } else if (b.status === 'REQUESTED') {
                    // Show time window for requested bookings
                    const timeWindow = window.BookingConstants?.getTimeWindow(b.requestedTimeWindow || b.preferredTimeOfDay);
                    timeStr = timeWindow ? `${timeWindow.icon} ${timeWindow.label}` : (b.preferredTimeOfDay || 'TBC');
                } else {
                    timeStr = b.confirmedTime || b.time || b.preferredTimeOfDay || 'TBC';
                }

                const shortId = b.id.substring(0, 8);
                const isSelected = selectedBookingIds.has(b.id);

                html += `
                    <tr${isSelected ? ' style="background: var(--primary-light);"' : ''}>
                        <td>
                            <input type="checkbox"
                                   data-booking-id="${b.id}"
                                   ${isSelected ? 'checked' : ''}
                                   onchange="toggleBookingSelection('${b.id}')"
                                   title="Select booking">
                        </td>
                        <td>
                            <code style="font-size: 11px; background: var(--gray-light); padding: 2px 6px; border-radius: 3px;" title="${b.id}">${shortId}</code>
                        </td>
                        <td>
                            <div style="font-weight: 500;">${b.customerName || 'Guest'}</div>
                            <div style="font-size: 12px; color: var(--gray-medium);">${b.customerEmail || ''}</div>
                        </td>
                        <td>${b.serviceName}</td>
                        <td>${b.stylistName || 'Any Available'}</td>
                        <td>${dateStr}</td>
                        <td>${timeStr}</td>
                        <td><span class="status-badge status-${b.status}">${b.status}</span></td>
                        <td>
                            ${(() => {
                                const paymentStatus = b.paymentStatus || b.payment_status || 'unpaid';
                                const paymentBadgeClass = paymentStatus === 'paid' ? 'status-paid' : (paymentStatus === 'pending' ? 'status-pending' : 'status-unpaid');
                                const paymentLabel = paymentStatus === 'paid' ? '✓ Paid' : (paymentStatus === 'pending' ? '⏳ Pending' : '○ Unpaid');
                                return `<span class="status-badge ${paymentBadgeClass}" style="font-size: 11px;">${paymentLabel}</span>`;
                            })()}
                            ${b.status === 'CONFIRMED' && (b.paymentStatus || b.payment_status || 'unpaid') !== 'paid' ? `
                                <div style="margin-top: 4px;">
                                    <button class="btn btn-sm booking-payment-btn" data-booking-id="${b.id}" title="Payment Options" style="font-size: 10px; padding: 2px 6px;">💳</button>
                                </div>
                            ` : ''}
                        </td>
                        <td class="action-btns">
                            ${b.status === 'REQUESTED' && !b.assignedStartTime ? `
                                <button class="btn btn-sm btn-primary booking-assign-btn" data-booking-id="${b.id}" title="Assign Time">⏰ Assign</button>
                            ` : `
                                <button class="btn btn-sm booking-edit-btn" data-booking-id="${b.id}" title="Edit booking">✏️</button>
                            `}
                            ${b.status === 'CONFIRMED' ? `
                                <button class="btn btn-sm booking-complete-btn" data-booking-id="${b.id}" title="Complete">✓</button>
                            ` : ''}
                            ${(b.status === 'REQUESTED' || b.status === 'CONFIRMED') ? `
                                <button class="btn btn-sm btn-outline booking-cancel-btn" data-booking-id="${b.id}" title="Cancel">✗</button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            });

            container.innerHTML = html;

            // Update pagination controls
            updateBookingsPagination();

            // Add event listeners for booking action buttons
            attachBookingActionListeners();
        }

        function attachBookingActionListeners() {
            // Assign Time buttons (for REQUESTED bookings)
            const assignBtns = document.querySelectorAll('.booking-assign-btn');
            console.log('🔧 Attaching event listeners to', assignBtns.length, 'assign buttons');
            assignBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const bookingId = this.getAttribute('data-booking-id');
                    console.log('🖱️ Assign button clicked for booking:', bookingId);
                    openAssignTimeModal(bookingId);
                });
            });

            // Edit buttons
            document.querySelectorAll('.booking-edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const bookingId = this.getAttribute('data-booking-id');
                    openEditBookingModal(bookingId);
                });
            });

            // Confirm buttons
            document.querySelectorAll('.booking-confirm-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const bookingId = this.getAttribute('data-booking-id');
                    confirmBookingTime(bookingId);
                });
            });

            // Complete buttons
            document.querySelectorAll('.booking-complete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const bookingId = this.getAttribute('data-booking-id');
                    completeBooking(bookingId);
                });
            });

            // Cancel buttons
            document.querySelectorAll('.booking-cancel-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const bookingId = this.getAttribute('data-booking-id');
                    cancelBooking(bookingId);
                });
            });

            // Payment buttons
            document.querySelectorAll('.booking-payment-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const bookingId = this.getAttribute('data-booking-id');
                    openPaymentModal(bookingId);
                });
            });
        }

        // ============================================
        // BOOKING PAYMENT FUNCTIONS
        // ============================================
        let currentPaymentBookingId = null;

        function openPaymentModal(bookingId) {
            currentPaymentBookingId = bookingId;
            const booking = adminBookings.find(b => b.id === bookingId);

            if (!booking) {
                showAdminToast('Booking not found', 'error');
                return;
            }

            // Populate booking info
            const infoEl = document.getElementById('bookingPaymentInfo');
            infoEl.innerHTML = `
                <div style="display: grid; gap: 8px;">
                    <div><strong>Customer:</strong> ${booking.customerName || 'Guest'}</div>
                    <div><strong>Service:</strong> ${booking.serviceName}</div>
                    <div><strong>Date:</strong> ${formatDateDisplay(booking.requestedDate || booking.date)}</div>
                    <div style="font-size: 18px; font-weight: bold; color: var(--brand-pink);">Amount: R${booking.servicePrice || booking.service_price}</div>
                </div>
            `;

            // Set default payment amount
            document.getElementById('paymentAmount').value = booking.servicePrice || booking.service_price || 0;
            document.getElementById('paymentMethod').value = 'cash';
            document.getElementById('paymentReference').value = '';
            document.getElementById('paymentNotes').value = '';

            // Hide error
            document.getElementById('paymentError').style.display = 'none';

            openModal('bookingPaymentModal');
        }

        async function sendPaymentLink() {
            if (!currentPaymentBookingId) return;

            try {
                const result = await apiCall(`/admin/bookings/${currentPaymentBookingId}/payment/send-link`, {
                    method: 'POST',
                    body: JSON.stringify({ sendMethod: 'email' })
                });

                showAdminToast(result.message || 'Payment link sent!', 'success');
                closeModal('bookingPaymentModal');
                loadBookings();
            } catch (error) {
                showAdminToast('Error: ' + (error.message || 'Failed to send payment link'), 'error');
            }
        }

        async function recordManualPayment() {
            if (!currentPaymentBookingId) return;

            const method = document.getElementById('paymentMethod').value;
            const amount = document.getElementById('paymentAmount').value;
            const reference = document.getElementById('paymentReference').value;
            const notes = document.getElementById('paymentNotes').value;

            if (!amount || parseFloat(amount) <= 0) {
                document.getElementById('paymentError').textContent = 'Please enter a valid amount';
                document.getElementById('paymentError').style.display = 'block';
                return;
            }

            try {
                const result = await apiCall(`/admin/bookings/${currentPaymentBookingId}/payment/record`, {
                    method: 'POST',
                    body: JSON.stringify({ method, amount, reference, notes })
                });

                showAdminToast(result.message || 'Payment recorded!', 'success');
                closeModal('bookingPaymentModal');
                loadBookings();
            } catch (error) {
                document.getElementById('paymentError').textContent = error.message || 'Failed to record payment';
                document.getElementById('paymentError').style.display = 'block';
            }
        }

        function renderBookingsCalendar() {
            const grid = document.getElementById('bookingsCalendarGrid');
            const label = document.getElementById('bookingsCalendarLabel');
            if (!grid) return;

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Calculate target month
            const targetDate = new Date(today.getFullYear(), today.getMonth() + bookingsCalendarMonthOffset, 1);
            const year = targetDate.getFullYear();
            const month = targetDate.getMonth();

            // Update month label
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
            if (label) label.textContent = `${monthNames[month]} ${year}`;

            // Group bookings by date (use requestedDate for new booking system, fallback to date for legacy)
            const bookingsByDate = {};
            adminBookings.forEach(b => {
                const bookingDate = b.requestedDate || b.date;
                if (!bookingDate) return;
                const dateKey = bookingDate.split('T')[0];
                if (!bookingsByDate[dateKey]) bookingsByDate[dateKey] = [];
                bookingsByDate[dateKey].push(b);
            });

            // Build calendar grid
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            let html = '';

            // Empty cells before first day
            for (let i = 0; i < firstDayOfMonth; i++) {
                html += '<div style="min-height: 100px; background: var(--gray-light); border-radius: 8px; opacity: 0.3;"></div>';
            }

            // Day cells
            for (let day = 1; day <= daysInMonth; day++) {
                const cellDate = new Date(year, month, day);
                // Fix timezone issue: format date as YYYY-MM-DD in local timezone, not UTC
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = cellDate.getTime() === today.getTime();
                const isPast = cellDate < today;
                const dayBookings = bookingsByDate[dateKey] || [];
                const hasBookings = dayBookings.length > 0;

                // Status color mapping for month view dots
                const statusColorMap = {
                    'pending': '#ffc107', 'REQUESTED': '#ffc107', 'To Be Confirmed': '#f9a825',
                    'confirmed': '#4caf50', 'CONFIRMED': '#4caf50', 'Paid': '#2e7d32',
                    'completed': '#2196f3', 'Online Booking': '#1565c0',
                    'cancelled': '#f44336', 'Cancelled': '#f44336',
                    'No Status': '#9e9e9e', 'Late': '#ff9800',
                    'New Extentions': '#9c27b0', 'New Extensions': '#9c27b0',
                    'No Show': '#c62828'
                };

                // Generate status dots for the day's bookings
                const statusDots = dayBookings.slice(0, 6).map(b => {
                    const color = statusColorMap[b.status] || '#9e9e9e';
                    return `<span style="width: 8px; height: 8px; border-radius: 50%; background: ${color};" title="${b.status || 'No Status'}"></span>`;
                }).join('');
                const moreCount = dayBookings.length > 6 ? dayBookings.length - 6 : 0;

                html += `
                    <div onclick="${hasBookings ? `showBookingsForDay('${dateKey}')` : ''}"
                         style="min-height: 100px; background: white; border-radius: 8px; padding: 10px; border: 1px solid ${isToday ? 'var(--primary)' : 'var(--gray-light)'}; ${isPast ? 'opacity: 0.5;' : ''} ${hasBookings ? 'cursor: pointer;' : ''} position: relative; ${isToday ? 'box-shadow: 0 0 0 2px var(--primary-light);' : ''}">
                        <div style="font-weight: 600; font-size: 14px; color: ${isToday ? 'var(--primary)' : 'var(--dark)'};">${day}</div>
                        ${hasBookings ? `
                            <div style="margin-top: 8px;">
                                <div style="font-size: 20px; font-weight: 700; color: var(--primary);">${dayBookings.length}</div>
                                <div style="font-size: 10px; color: var(--gray-medium);">booking${dayBookings.length > 1 ? 's' : ''}</div>
                            </div>
                            <div style="display: flex; gap: 3px; margin-top: 8px; flex-wrap: wrap; align-items: center;">
                                ${statusDots}
                                ${moreCount > 0 ? `<span style="font-size: 9px; color: var(--gray-medium);">+${moreCount}</span>` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            grid.innerHTML = html;
        }

        function setBookingsView(view) {
            currentBookingsView = view;
            const listView = document.getElementById('bookingsListView');
            const calendarView = document.getElementById('bookingsCalendarView');
            const listBtn = document.getElementById('bookingsListViewBtn');
            const calendarBtn = document.getElementById('bookingsCalendarViewBtn');

            if (view === 'list') {
                listView.style.display = 'block';
                calendarView.style.display = 'none';
                listBtn.style.background = 'var(--primary)';
                listBtn.style.color = 'white';
                listBtn.classList.remove('btn-outline');
                calendarBtn.style.background = '';
                calendarBtn.style.color = '';
                calendarBtn.classList.add('btn-outline');
            } else {
                listView.style.display = 'none';
                calendarView.style.display = 'block';
                calendarBtn.style.background = 'var(--primary)';
                calendarBtn.style.color = 'white';
                calendarBtn.classList.remove('btn-outline');
                listBtn.style.background = '';
                listBtn.style.color = '';
                listBtn.classList.add('btn-outline');
                renderBookingsCalendar();
            }
        }

        function changeBookingsCalendarMonth(delta) {
            bookingsCalendarMonthOffset += delta;
            renderBookingsCalendar();
        }

        function goToBookingsCalendarToday() {
            bookingsCalendarMonthOffset = 0;
            renderBookingsCalendar();
        }

        function showBookingsForDay(dateKey) {
            const dayBookings = adminBookings.filter(b => (b.requestedDate || b.date).split('T')[0] === dateKey);
            const popup = document.getElementById('bookingsDayPopup');
            const title = document.getElementById('bookingsDayPopupTitle');
            const content = document.getElementById('bookingsDayPopupContent');

            const formattedDate = formatDateDisplay(dateKey + 'T00:00:00', {
                weekday: 'long'
            });
            title.textContent = `Bookings for ${formattedDate}`;

            if (dayBookings.length === 0) {
                content.innerHTML = '<p style="color: var(--gray-medium); text-align: center;">No bookings for this day</p>';
            } else {
                content.innerHTML = dayBookings.map(b => {
                    // Format time based on booking status
                    let timeStr;
                    let requestedTimeStr = '';

                    if (b.assignedStartTime) {
                        // Has assigned time - format it nicely
                        const startTime = new Date(`2000-01-01T${b.assignedStartTime}`);
                        timeStr = startTime.toLocaleTimeString('en-ZA', { hour: '2-digit', minute: '2-digit', hour12: false });
                        if (b.assignedEndTime) {
                            const endTime = new Date(`2000-01-01T${b.assignedEndTime}`);
                            timeStr += ` - ${endTime.toLocaleTimeString('en-ZA', { hour: '2-digit', minute: '2-digit', hour12: false })}`;
                        }
                    } else if (b.confirmedTime || b.time) {
                        timeStr = b.confirmedTime || b.time;
                    } else {
                        timeStr = 'Not assigned';
                    }

                    // Always show requested time window for context
                    const requestedWindow = b.requestedTimeWindow || b.preferredTimeOfDay;
                    if (requestedWindow) {
                        const timeWindow = window.BookingConstants?.getTimeWindow(requestedWindow);
                        if (timeWindow) {
                            requestedTimeStr = `<div style="font-size: 13px; color: var(--gray-medium); margin-top: 2px;">${timeWindow.icon} Requested: ${timeWindow.label} (${timeWindow.description})</div>`;
                        } else {
                            requestedTimeStr = `<div style="font-size: 13px; color: var(--gray-medium); margin-top: 2px;">Requested: ${requestedWindow}</div>`;
                        }
                    }

                    return `
                        <div style="padding: 15px; border: 1px solid var(--gray-light); border-radius: 10px; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                                <div>
                                    <div style="font-weight: 600;">${b.customerName || 'Guest'}</div>
                                    <div style="font-size: 12px; color: var(--gray-medium);">${b.customerEmail || ''}</div>
                                </div>
                                <span class="status-badge status-${b.status}">${b.status}</span>
                            </div>
                            <div style="font-size: 14px; margin-bottom: 5px;"><strong>Service:</strong> ${b.serviceName}</div>
                            <div style="font-size: 14px; margin-bottom: 5px;">
                                <strong>Time:</strong> ${timeStr}
                                ${requestedTimeStr}
                            </div>
                            ${b.stylistName ? `<div style="font-size: 14px; margin-bottom: 5px;"><strong>Stylist:</strong> ${b.stylistName}</div>` : ''}
                            ${b.notes ? `<div style="font-size: 12px; color: var(--gray-medium); margin-top: 8px; padding: 8px; background: var(--gray-light); border-radius: 4px;"><strong>Notes:</strong> ${b.notes}</div>` : ''}
                            <div style="margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="btn btn-sm booking-edit-btn" data-booking-id="${b.id}">✏️ Edit</button>
                                ${b.status === 'REQUESTED' ? `
                                    <button class="btn btn-sm btn-primary booking-confirm-close-btn" data-booking-id="${b.id}">✓ Confirm</button>
                                ` : ''}
                                ${b.status === 'CONFIRMED' ? `
                                    <button class="btn btn-sm btn-primary booking-complete-close-btn" data-booking-id="${b.id}">✓ Complete</button>
                                ` : ''}
                                ${(b.status === 'REQUESTED' || b.status === 'CONFIRMED') ? `
                                    <button class="btn btn-sm btn-outline booking-cancel-close-btn" data-booking-id="${b.id}">✗ Cancel</button>
                                ` : ''}
                                <button class="btn btn-sm booking-delete-btn" data-booking-id="${b.id}" style="background: var(--danger); color: white; margin-left: auto;">🗑️ Delete</button>
                            </div>
                        </div>
                    `;
                }).join('');

                // Attach event listeners for popup buttons
                attachBookingPopupListeners();
            }

            popup.style.display = 'flex';
        }

        function attachBookingPopupListeners() {
            // Edit buttons
            document.querySelectorAll('.booking-edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const bookingId = this.getAttribute('data-booking-id');
                    openEditBookingModal(bookingId);
                });
            });

            // Confirm and close popup buttons
            document.querySelectorAll('.booking-confirm-close-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const bookingId = this.getAttribute('data-booking-id');
                    await confirmBookingTime(bookingId);
                    closeBookingsDayPopup();
                });
            });

            // Complete and close popup buttons
            document.querySelectorAll('.booking-complete-close-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const bookingId = this.getAttribute('data-booking-id');
                    await completeBooking(bookingId);
                    closeBookingsDayPopup();
                });
            });

            // Cancel and close popup buttons
            document.querySelectorAll('.booking-cancel-close-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const bookingId = this.getAttribute('data-booking-id');
                    await cancelBooking(bookingId);
                    closeBookingsDayPopup();
                });
            });

            // Delete buttons
            document.querySelectorAll('.booking-delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const bookingId = this.getAttribute('data-booking-id');
                    deleteBooking(bookingId);
                });
            });
        }

        // Calendar view state
        let currentCalendarView = 'month'; // 'day', 'week', 'month'
        let calendarViewDate = new Date();

        function setCalendarView(view) {
            currentCalendarView = view;

            // Update button states
            ['Day', 'Week', 'Month'].forEach(v => {
                const btn = document.getElementById(`calendar${v}Btn`);
                if (v.toLowerCase() === view) {
                    btn.style.background = 'var(--primary)';
                    btn.style.color = 'white';
                    btn.classList.remove('btn-outline');
                } else {
                    btn.style.background = '';
                    btn.style.color = '';
                    btn.classList.add('btn-outline');
                }
            });

            // Show/hide appropriate views
            document.getElementById('calendarDayView').style.display = view === 'day' ? 'block' : 'none';
            document.getElementById('calendarWeekView').style.display = view === 'week' ? 'block' : 'none';
            document.getElementById('calendarMonthView').style.display = view === 'month' ? 'block' : 'none';

            // Render the appropriate view
            if (view === 'day') {
                renderDayView();
            } else if (view === 'week') {
                renderWeekView();
            } else {
                renderBookingsCalendar();
            }
        }

        async function renderDayView() {
            // Ensure we have stylists data
            await ensureAdminBookingData();

            const dateLabel = document.getElementById('dayViewDate');
            const grid = document.getElementById('dayViewGrid');
            const header = document.getElementById('dayViewStylistHeader');
            const label = document.getElementById('bookingsCalendarLabel');
            const pendingCount = document.getElementById('dayViewPendingCount');

            const formattedDate = formatDateDisplay(calendarViewDate, {
                weekday: 'long'
            });
            dateLabel.textContent = formattedDate;
            label.textContent = formattedDate;

            const dateKey = calendarViewDate.toISOString().split('T')[0];
            const dayBookings = adminBookings.filter(b => {
                const bookingDate = (b.requestedDate || b.date).split('T')[0];
                return bookingDate === dateKey;
            });

            // Count pending (REQUESTED) bookings
            const pendingBookings = dayBookings.filter(b => b.status === 'REQUESTED');
            pendingCount.textContent = `${pendingBookings.length} pending`;
            pendingCount.style.display = pendingBookings.length > 0 ? 'inline-block' : 'none';

            // Get active stylists for columns
            const stylists = adminBookingStylists.filter(s => s.active !== false && s.status !== 'inactive');
            const stylistColumns = [...stylists, { id: null, name: 'Unassigned' }];
            const numColumns = stylistColumns.length;

            // Helper: Calculate duration in minutes from start/end times
            function calculateDuration(booking) {
                if (booking.assignedStartTime && booking.assignedEndTime) {
                    const [startH, startM] = booking.assignedStartTime.split(':').map(Number);
                    const [endH, endM] = booking.assignedEndTime.split(':').map(Number);
                    return (endH * 60 + endM) - (startH * 60 + startM);
                }
                return booking.duration || 60;
            }

            // Helper: Calculate position in minutes from start of day (7 AM)
            function calculatePosition(timeStr) {
                if (!timeStr) return -1;
                const [h, m] = timeStr.split(':').map(Number);
                return (h * 60 + m) - (7 * 60); // Offset from 7 AM
            }

            // Prepare bookings with calculated positions and durations
            const bookingsWithLayout = dayBookings.map(b => {
                const time = b.assignedStartTime || b.confirmedTime || b.time;
                return {
                    ...b,
                    displayTime: time || null,
                    position: time ? calculatePosition(time) : -1,
                    duration: calculateDuration(b),
                    stylistColumnId: b.stylistId || null
                };
            });

            const PIXELS_PER_MINUTE = 1.2;
            const START_HOUR = 7;
            const END_HOUR = 20;
            const TOTAL_HEIGHT = (END_HOUR - START_HOUR) * 60 * PIXELS_PER_MINUTE;
            const TIME_COL_WIDTH = 60;

            // Render stylist columns header
            header.style.gridTemplateColumns = `${TIME_COL_WIDTH}px repeat(${numColumns}, 1fr)`;
            let headerHtml = `<div style="border-right: 1px solid var(--gray-light); padding: 10px 5px; text-align: center; font-size: 11px; color: var(--gray-medium);">TIME</div>`;
            stylistColumns.forEach((s, idx) => {
                const stylistBookings = dayBookings.filter(b => (b.stylistId || null) === s.id);
                const stylistPending = stylistBookings.filter(b => b.status === 'REQUESTED').length;
                headerHtml += `
                    <div style="border-right: ${idx < numColumns - 1 ? '1px solid var(--gray-light)' : 'none'}; padding: 10px 8px; text-align: center; font-weight: 600; font-size: 12px;">
                        ${s.name}
                        <div style="font-size: 10px; font-weight: 400; color: var(--gray-medium);">
                            ${stylistBookings.length} booking${stylistBookings.length !== 1 ? 's' : ''}
                            ${stylistPending > 0 ? `<span style="color: #856404;">(${stylistPending} pending)</span>` : ''}
                        </div>
                    </div>
                `;
            });
            header.innerHTML = headerHtml;

            // Render the grid
            let html = `<div style="display: grid; grid-template-columns: ${TIME_COL_WIDTH}px repeat(${numColumns}, 1fr); position: relative;">`;

            // Time slots from 7 AM to 8 PM
            for (let hour = START_HOUR; hour <= END_HOUR; hour++) {
                const displayTime = hour < 12 ? `${hour} AM` : hour === 12 ? '12 PM' : `${hour - 12} PM`;
                const isWorkingHour = hour >= 8 && hour <= 18;

                html += `<div style="border-right: 1px solid var(--gray-light); border-bottom: 1px solid var(--gray-light); padding: 4px 6px; font-size: 10px; color: var(--gray-medium); text-align: right; height: ${60 * PIXELS_PER_MINUTE}px; background: ${isWorkingHour ? 'white' : '#fafafa'};">
                    ${displayTime}
                </div>`;

                // Cell for each stylist column
                for (let colIdx = 0; colIdx < numColumns; colIdx++) {
                    html += `<div style="border-right: ${colIdx < numColumns - 1 ? '1px solid var(--gray-light)' : 'none'}; border-bottom: 1px solid var(--gray-light); position: relative; height: ${60 * PIXELS_PER_MINUTE}px; background: ${isWorkingHour ? 'white' : '#fafafa'};"></div>`;
                }
            }

            html += '</div>';

            // Overlay bookings with absolute positioning per stylist column
            html += `<div style="position: absolute; top: 0; left: ${TIME_COL_WIDTH}px; right: 0; height: ${TOTAL_HEIGHT}px; pointer-events: none; display: grid; grid-template-columns: repeat(${numColumns}, 1fr);">`;

            // Create a container for each stylist column
            stylistColumns.forEach((stylist, colIdx) => {
                const columnBookings = bookingsWithLayout.filter(b => b.stylistColumnId === stylist.id);

                html += `<div style="position: relative; border-right: ${colIdx < numColumns - 1 ? '1px solid transparent' : 'none'};">`;

                columnBookings.forEach(b => {
                    // Status styles matching MySalonOnline appointment statuses
                    const statusStyles = {
                        // Legacy/internal statuses
                        'REQUESTED': { bg: '#fff3cd', border: '#f0ad4e', text: '#856404' },
                        'CONFIRMED': { bg: '#d4edda', border: '#28a745', text: '#155724' },
                        'COMPLETED': { bg: '#d1ecf1', border: '#17a2b8', text: '#0c5460' },
                        'CANCELLED': { bg: '#f8d7da', border: '#dc3545', text: '#721c24' },
                        'NO_SHOW': { bg: '#e2e3e5', border: '#6c757d', text: '#383d41' },
                        'pending': { bg: '#fff3cd', border: '#f0ad4e', text: '#856404' },
                        'confirmed': { bg: '#d4edda', border: '#28a745', text: '#155724' },
                        'completed': { bg: '#d1ecf1', border: '#17a2b8', text: '#0c5460' },
                        'cancelled': { bg: '#f8d7da', border: '#dc3545', text: '#721c24' },
                        // MySalonOnline statuses
                        'No Status': { bg: '#e9ecef', border: '#9e9e9e', text: '#495057' },
                        'Cancelled': { bg: '#f8d7da', border: '#dc3545', text: '#721c24' },
                        'Late': { bg: '#ffe0b2', border: '#ff9800', text: '#e65100' },
                        'New Extentions': { bg: '#e1bee7', border: '#9c27b0', text: '#7b1fa2' },
                        'New Extensions': { bg: '#e1bee7', border: '#9c27b0', text: '#7b1fa2' },
                        'No Show': { bg: '#ffcdd2', border: '#c62828', text: '#c62828' },
                        'Online Booking': { bg: '#bbdefb', border: '#1565c0', text: '#1565c0' },
                        'Paid': { bg: '#c8e6c9', border: '#2e7d32', text: '#2e7d32' },
                        'To Be Confirmed': { bg: '#fff9c4', border: '#f9a825', text: '#f9a825' }
                    };
                    const style = statusStyles[b.status] || { bg: '#e9ecef', border: '#9e9e9e', text: '#495057' };

                    // For unscheduled bookings, stack them at the top
                    let topPos, height;
                    if (b.position < 0) {
                        topPos = -5; // Stack at top
                        height = 50;
                    } else {
                        topPos = b.position * PIXELS_PER_MINUTE;
                        height = Math.max(b.duration * PIXELS_PER_MINUTE, 45);
                    }

                    // Quick action buttons based on status
                    let quickActions = '';
                    if (b.status === 'REQUESTED') {
                        quickActions = `
                            <div class="day-view-quick-actions" style="position: absolute; bottom: 3px; right: 3px; display: flex; gap: 3px;">
                                <button class="quick-confirm-btn" data-booking-id="${b.id}" title="Confirm" style="background: #28a745; color: white; border: none; border-radius: 3px; width: 22px; height: 22px; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;">✓</button>
                            </div>
                        `;
                    } else if (b.status === 'CONFIRMED') {
                        quickActions = `
                            <div class="day-view-quick-actions" style="position: absolute; bottom: 3px; right: 3px; display: flex; gap: 3px;">
                                <button class="quick-complete-btn" data-booking-id="${b.id}" title="Complete" style="background: #17a2b8; color: white; border: none; border-radius: 3px; width: 22px; height: 22px; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center;">✓</button>
                            </div>
                        `;
                    }

                    // Show time window for REQUESTED bookings without assigned time
                    let timeDisplay = '';
                    if (b.displayTime) {
                        timeDisplay = b.displayTime;
                        if (b.assignedEndTime) {
                            timeDisplay += `-${b.assignedEndTime.substring(0, 5)}`;
                        }
                    } else if (b.requestedTimeWindow || b.preferredTimeOfDay) {
                        const tw = window.BookingConstants?.getTimeWindow(b.requestedTimeWindow || b.preferredTimeOfDay);
                        timeDisplay = tw ? `${tw.icon} ${tw.label}` : (b.requestedTimeWindow || b.preferredTimeOfDay);
                    } else {
                        timeDisplay = 'No time';
                    }

                    // Format duration for display
                    const durationDisplay = b.duration ? `${Math.floor(b.duration / 60)}h ${b.duration % 60 > 0 ? (b.duration % 60) + 'm' : ''}`.trim() : '';

                    // Format price
                    const priceDisplay = b.servicePrice ? `R${Number(b.servicePrice).toLocaleString()}` : '';

                    html += `
                        <div class="calendar-booking-item day-view-booking" data-booking-id="${b.id}"
                             style="position: absolute;
                                    top: ${topPos}px;
                                    left: 2px;
                                    right: 2px;
                                    height: ${height}px;
                                    min-height: 45px;
                                    padding: 6px 8px;
                                    border-radius: 6px;
                                    background: ${style.bg};
                                    border-left: 4px solid ${style.border};
                                    cursor: pointer;
                                    pointer-events: auto;
                                    overflow: hidden;
                                    box-sizing: border-box;
                                    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                                    transition: transform 0.1s, box-shadow 0.1s;"
                             onmouseenter="this.style.transform='scale(1.02)'; this.style.boxShadow='0 3px 8px rgba(0,0,0,0.15)';"
                             onmouseleave="this.style.transform='scale(1)'; this.style.boxShadow='0 1px 3px rgba(0,0,0,0.1)';">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 4px;">
                                <div style="font-weight: 600; font-size: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: ${style.text}; flex: 1;">${b.customerName || 'Guest'}</div>
                                ${priceDisplay ? `<div style="font-size: 10px; font-weight: 600; color: ${style.text}; white-space: nowrap;">${priceDisplay}</div>` : ''}
                            </div>
                            <div style="font-size: 10px; margin-top: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: ${style.text}; opacity: 0.85;">${b.serviceName}</div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 2px;">
                                <div style="font-size: 10px; color: ${style.text}; opacity: 0.7;">${timeDisplay}${durationDisplay ? ` (${durationDisplay})` : ''}</div>
                                <div style="font-size: 8px; padding: 1px 5px; border-radius: 3px; background: ${style.border}; color: white; font-weight: 500; white-space: nowrap;">${b.status || 'No Status'}</div>
                            </div>
                            ${b.customerPhone ? `<div style="font-size: 9px; color: ${style.text}; margin-top: 2px; opacity: 0.6;"><a href="tel:${b.customerPhone}" style="color: inherit; text-decoration: none;" onclick="event.stopPropagation();">📞 ${b.customerPhone}</a></div>` : ''}
                            ${quickActions}
                        </div>
                    `;
                });

                html += '</div>';
            });

            html += '</div>';

            grid.innerHTML = html;
            grid.style.position = 'relative';

            // Attach event listeners to calendar booking items
            attachCalendarBookingListeners();
        }

        function attachCalendarBookingListeners() {
            // Main booking click - edit
            document.querySelectorAll('.calendar-booking-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    // Don't trigger if clicking on quick action buttons
                    if (e.target.closest('.day-view-quick-actions')) return;
                    e.stopPropagation();
                    const bookingId = this.getAttribute('data-booking-id');
                    openEditBookingModal(bookingId);
                });
            });

            // Quick confirm buttons
            document.querySelectorAll('.quick-confirm-btn').forEach(btn => {
                btn.addEventListener('click', async function(e) {
                    e.stopPropagation();
                    const bookingId = this.getAttribute('data-booking-id');
                    await quickConfirmBooking(bookingId);
                });
            });

            // Quick complete buttons
            document.querySelectorAll('.quick-complete-btn').forEach(btn => {
                btn.addEventListener('click', async function(e) {
                    e.stopPropagation();
                    const bookingId = this.getAttribute('data-booking-id');
                    await quickCompleteBooking(bookingId);
                });
            });
        }

        // Quick confirm booking - prompts for time if not set
        async function quickConfirmBooking(bookingId) {
            const booking = adminBookings.find(b => b.id === bookingId);
            if (!booking) return;

            // If booking already has a time, confirm directly
            if (booking.assignedStartTime || booking.confirmedTime || booking.time) {
                await confirmBookingDirect(bookingId);
                return;
            }

            // Otherwise, open edit modal to set time
            openEditBookingModal(bookingId);
            showAdminToast('Please set a time before confirming', 'info');
        }

        // Direct confirm without time prompt
        async function confirmBookingDirect(bookingId) {
            try {
                const booking = adminBookings.find(b => b.id === bookingId);
                const time = booking.assignedStartTime || booking.confirmedTime || booking.time || '09:00';

                await apiCall(`/admin/bookings/${bookingId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ status: 'CONFIRMED', time })
                });

                showAdminToast('Booking confirmed!', 'success');
                await loadBookings();

                // Re-render current view
                if (currentCalendarView === 'day') {
                    renderDayView();
                } else {
                    renderBookingsCalendar();
                }
            } catch (error) {
                showAdminToast('Error confirming booking: ' + error.message, 'error');
            }
        }

        // Quick complete booking
        async function quickCompleteBooking(bookingId) {
            try {
                await apiCall(`/admin/bookings/${bookingId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ status: 'COMPLETED' })
                });

                showAdminToast('Booking completed!', 'success');
                await loadBookings();

                // Re-render current view
                if (currentCalendarView === 'day') {
                    renderDayView();
                } else {
                    renderBookingsCalendar();
                }
            } catch (error) {
                showAdminToast('Error completing booking: ' + error.message, 'error');
            }
        }

        function renderWeekView() {
            const label = document.getElementById('bookingsCalendarLabel');
            const grid = document.getElementById('weekViewGrid');

            // Get start of week (Sunday)
            const weekStart = new Date(calendarViewDate);
            weekStart.setDate(weekStart.getDate() - weekStart.getDay());

            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);

            label.textContent = `${formatDateDisplay(weekStart)} - ${formatDateDisplay(weekEnd)}`;

            let html = '';

            // Time slots from 6 AM to 10 PM
            for (let hour = 6; hour <= 22; hour++) {
                const displayTime = hour < 12 ? `${hour} AM` : hour === 12 ? '12 PM' : `${hour - 12} PM`;

                html += `<div style="border-right: 1px solid var(--gray-light); border-bottom: 1px solid var(--gray-light); padding: 8px 5px; font-size: 10px; color: var(--gray-medium); text-align: right;">${displayTime}</div>`;

                // For each day of the week
                for (let dayOffset = 0; dayOffset < 7; dayOffset++) {
                    const cellDate = new Date(weekStart);
                    cellDate.setDate(weekStart.getDate() + dayOffset);
                    const dateKey = cellDate.toISOString().split('T')[0];
                    const time = `${hour.toString().padStart(2, '0')}:00`;

                    const hourBookings = adminBookings.filter(b => {
                        if (b.date.split('T')[0] !== dateKey) return false;
                        const bookingTime = b.confirmedTime || b.time || '';
                        return bookingTime.startsWith(time.substring(0, 2));
                    });

                    const borderRight = dayOffset < 6 ? 'border-right: 1px solid var(--gray-light);' : '';
                    html += `<div style="${borderRight} border-bottom: 1px solid var(--gray-light); padding: 2px; min-height: 50px; font-size: 10px;">`;

                    hourBookings.forEach(b => {
                        // Status colors matching MySalonOnline appointment statuses
                        const statusColors = {
                            // Legacy/internal statuses
                            'pending': 'background: #fff3cd; color: #856404;',
                            'confirmed': 'background: #d4edda; color: #155724;',
                            'completed': 'background: #d1ecf1; color: #0c5460;',
                            'cancelled': 'background: #f8d7da; color: #721c24;',
                            'REQUESTED': 'background: #fff3cd; color: #856404;',
                            'CONFIRMED': 'background: #d4edda; color: #155724;',
                            // MySalonOnline statuses
                            'No Status': 'background: #e9ecef; color: #495057;',
                            'Cancelled': 'background: #f8d7da; color: #721c24;',
                            'Late': 'background: #ffe0b2; color: #e65100;',
                            'New Extentions': 'background: #e1bee7; color: #7b1fa2;',
                            'New Extensions': 'background: #e1bee7; color: #7b1fa2;',
                            'No Show': 'background: #ffcdd2; color: #c62828;',
                            'Online Booking': 'background: #bbdefb; color: #1565c0;',
                            'Paid': 'background: #c8e6c9; color: #2e7d32;',
                            'To Be Confirmed': 'background: #fff9c4; color: #f9a825;'
                        };

                        html += `
                            <div class="calendar-booking-item" data-booking-id="${b.id}" style="margin: 1px 0; padding: 4px; border-radius: 3px; ${statusColors[b.status] || ''} cursor: pointer; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"
                                 title="Click to edit: ${b.customerName} - ${b.serviceName}">
                                ${b.customerName?.substring(0, 10) || 'Guest'}
                            </div>
                        `;
                    });

                    html += '</div>';
                }
            }

            grid.innerHTML = html;

            // Attach event listeners to calendar booking items
            attachCalendarBookingListeners();
        }

        function changeBookingsCalendarPeriod(delta) {
            if (currentCalendarView === 'day') {
                calendarViewDate.setDate(calendarViewDate.getDate() + delta);
                renderDayView();
            } else if (currentCalendarView === 'week') {
                calendarViewDate.setDate(calendarViewDate.getDate() + (delta * 7));
                renderWeekView();
            } else {
                bookingsCalendarMonthOffset += delta;
                renderBookingsCalendar();
            }
        }

        function goToCalendarToday() {
            calendarViewDate = new Date();
            bookingsCalendarMonthOffset = 0;

            if (currentCalendarView === 'day') {
                renderDayView();
            } else if (currentCalendarView === 'week') {
                renderWeekView();
            } else {
                renderBookingsCalendar();
            }
        }

        function closeBookingsDayPopup() {
            document.getElementById('bookingsDayPopup').style.display = 'none';
        }

        // Edit booking functionality
        let currentEditingBookingId = null;
        let editBookingSourcePopupOpen = false; // Track if day popup was open when edit was triggered

        // Fetch stylists who offer a specific service
        async function fetchStylistsForService(serviceId) {
            try {
                const response = await apiCall(`/services/${serviceId}/stylists`);
                return response.stylists || [];
            } catch (error) {
                console.error('Error fetching stylists for service:', error);
                return [];
            }
        }

        // Update the stylist dropdown based on selected service
        async function updateEditBookingStylistDropdown(serviceId, currentStylistId = null) {
            const stylistSelect = document.getElementById('editBookingStylist');
            if (!stylistSelect) return;

            // Show loading state
            stylistSelect.innerHTML = '<option value="">Loading...</option>';
            stylistSelect.disabled = true;

            if (!serviceId) {
                // No service selected - show all stylists
                stylistSelect.innerHTML = '<option value="">Any Available</option>' +
                    adminBookingStylists.map(s =>
                        `<option value="${s.id}" ${s.id === currentStylistId ? 'selected' : ''}>${s.name}</option>`
                    ).join('');
                stylistSelect.disabled = false;
                return;
            }

            // Fetch stylists who offer this service
            const eligibleStylists = await fetchStylistsForService(serviceId);

            if (eligibleStylists.length === 0) {
                stylistSelect.innerHTML = '<option value="">No stylists offer this service</option>';
                stylistSelect.disabled = false;
                return;
            }

            stylistSelect.innerHTML = '<option value="">Any Available</option>' +
                eligibleStylists.map(s =>
                    `<option value="${s.id}" ${s.id === currentStylistId ? 'selected' : ''}>${s.name}</option>`
                ).join('');
            stylistSelect.disabled = false;

            // Check if current stylist is still valid for this service
            if (currentStylistId && !eligibleStylists.find(s => s.id === currentStylistId)) {
                // Current stylist doesn't offer this service - show warning
                const errorEl = document.getElementById('editBookingError');
                if (errorEl) {
                    errorEl.style.display = 'block';
                    errorEl.textContent = 'Warning: The current stylist does not offer this service. Please select a different stylist.';
                }
                stylistSelect.value = ''; // Reset to "Any Available"
            }
        }

        async function openEditBookingModal(bookingId) {
            currentEditingBookingId = bookingId;
            const booking = adminBookings.find(b => b.id === bookingId);

            if (!booking) {
                showAdminToast('Booking not found', 'error');
                return;
            }

            // Track if day popup is currently visible (to restore it later)
            const dayPopup = document.getElementById('bookingsDayPopup');
            editBookingSourcePopupOpen = dayPopup && dayPopup.style.display === 'flex';

            // Ensure data is loaded
            await ensureAdminBookingData();

            // Populate services dropdown
            const serviceSelect = document.getElementById('editBookingService');
            serviceSelect.innerHTML = adminBookingServices.map(s =>
                `<option value="${s.id}" ${s.id === booking.serviceId ? 'selected' : ''}>
                    ${s.name} - R${s.price}
                </option>`
            ).join('');

            // Add event listener for service change to update stylists dropdown
            // Remove old listener first to prevent duplicates
            const newServiceSelect = serviceSelect.cloneNode(true);
            serviceSelect.parentNode.replaceChild(newServiceSelect, serviceSelect);
            newServiceSelect.addEventListener('change', async (e) => {
                const selectedServiceId = e.target.value;
                await updateEditBookingStylistDropdown(selectedServiceId, null);
            });

            // Populate stylists dropdown - filtered by selected service
            await updateEditBookingStylistDropdown(booking.serviceId, booking.stylistId);

            // Fill form with current booking data
            document.getElementById('editBookingCustomer').value = booking.customerName || 'Guest';
            document.getElementById('editBookingService').value = booking.serviceId || '';
            document.getElementById('editBookingStylist').value = booking.stylistId || '';
            document.getElementById('editBookingDate').value = (booking.requestedDate || booking.date).split('T')[0];
            document.getElementById('editBookingTime').value = booking.assignedStartTime || booking.confirmedTime || booking.time || '';
            document.getElementById('editBookingDuration').value = booking.duration || 60;
            document.getElementById('editBookingStatus').value = booking.status;
            document.getElementById('editBookingCommissionRate').value = booking.commission_rate !== null && booking.commission_rate !== undefined
                ? (booking.commission_rate * 100).toFixed(0)
                : '';
            document.getElementById('editBookingNotes').value = booking.notes || '';

            // Clear error
            const errorEl = document.getElementById('editBookingError');
            if (errorEl) {
                errorEl.style.display = 'none';
                errorEl.textContent = '';
            }

            // Hide day popup temporarily (but keep track of it)
            if (dayPopup) {
                dayPopup.style.display = 'none';
            }

            // Open edit modal
            openModal('editBookingModal');
        }

        // Close edit booking modal and restore day popup if needed
        function closeEditBookingModal() {
            closeModal('editBookingModal');
            currentEditingBookingId = null;

            // If the edit was initiated from the day popup, restore it and refresh content
            if (editBookingSourcePopupOpen) {
                // Get the date from the current calendar view or the booking
                const dateKey = calendarViewDate.toISOString().split('T')[0];
                showBookingsForDay(dateKey);
                editBookingSourcePopupOpen = false;
            }
        }

        async function saveBookingEdit() {
            const errorEl = document.getElementById('editBookingError');
            if (errorEl) {
                errorEl.style.display = 'none';
                errorEl.textContent = '';
            }

            try {
                const serviceId = document.getElementById('editBookingService').value;
                const stylistId = document.getElementById('editBookingStylist').value;
                const date = document.getElementById('editBookingDate').value;
                const time = document.getElementById('editBookingTime').value;
                const duration = document.getElementById('editBookingDuration').value;
                const status = document.getElementById('editBookingStatus').value;
                const notes = document.getElementById('editBookingNotes').value;
                const commissionRateInput = document.getElementById('editBookingCommissionRate').value.trim();

                if (!date) {
                    throw new Error('Date is required');
                }

                if (!serviceId) {
                    throw new Error('Service is required');
                }

                const service = adminBookingServices.find(s => s.id === serviceId);
                if (!service) {
                    throw new Error('Invalid service selected');
                }

                // Parse commission rate: convert from percentage to decimal, or null if empty
                const commissionRate = commissionRateInput !== '' ? parseFloat(commissionRateInput) / 100 : null;

                const updateData = {
                    serviceId: serviceId,
                    serviceName: service.name,
                    servicePrice: service.price,
                    stylistId: stylistId || null,
                    date: date,
                    confirmedTime: time || null,
                    time: time || null,
                    duration: duration ? parseInt(duration) : null,
                    status: status,
                    notes: notes || null,
                    commissionRate: commissionRate,
                    updatedAt: new Date().toISOString()
                };

                // If status is completed, add completed timestamp
                if (status === 'completed') {
                    updateData.completedAt = new Date().toISOString();
                }

                await apiCall(`/admin/bookings/${currentEditingBookingId}`, {
                    method: 'PATCH',
                    body: JSON.stringify(updateData)
                });

                showAdminToast('Booking updated successfully!', 'success');
                await loadBookings();
                closeEditBookingModal();

                // Re-render current view
                if (currentCalendarView === 'day') {
                    renderDayView();
                } else {
                    renderBookingsCalendar();
                }

            } catch (error) {
                if (errorEl) {
                    errorEl.style.display = 'block';
                    errorEl.textContent = error.message;
                } else {
                    showAdminToast('Error updating booking: ' + (error.message || ''), 'error');
                }
            }
        }

        async function deleteBooking(bookingId) {
            const proceed = await openConfirmDialog({
                title: 'Delete booking?',
                message: 'This action cannot be undone.',
                confirmText: 'Delete',
                tone: 'danger'
            });
            if (!proceed) return;

            try {
                await apiCall(`/admin/bookings/${bookingId}`, {
                    method: 'DELETE'
                });

                showAdminToast('Booking deleted successfully', 'success');
                closeBookingsDayPopup();
                closeModal('editBookingModal');
                editBookingSourcePopupOpen = false;
                await loadBookings();

                // Re-render current view
                if (currentCalendarView === 'day') {
                    renderDayView();
                } else {
                    renderBookingsCalendar();
                }

            } catch (error) {
                showAdminToast('Error deleting booking: ' + (error.message || ''), 'error');
            }
        }

        async function completeBooking(id) {
            const proceed = await openConfirmDialog({
                title: 'Complete booking?',
                message: 'Mark this booking as completed.',
                confirmText: 'Complete'
            });
            if (!proceed) return;
            try {
                await apiCall(`/admin/bookings/${id}/status`, {
                    method: 'PATCH',
                    body: JSON.stringify({ status: 'COMPLETED' })
                });
                showAdminToast('Booking marked as completed', 'success');
                await loadBookings();

                // Re-render current view
                if (currentCalendarView === 'day') {
                    renderDayView();
                } else {
                    renderBookingsCalendar();
                }
            } catch (error) {
                showAdminToast('Error completing booking: ' + (error.message || 'Database error'), 'error');
            }
        }

        async function confirmBookingTime(id) {
            // Use a styled time input modal instead of prompt
            const time = await openTimeInputDialog({
                title: 'Confirm Booking Time',
                message: 'Enter the confirmed appointment time:',
                confirmText: 'Confirm'
            });

            if (time) {
                try {
                    await apiCall(`/admin/bookings/${id}/confirm`, {
                        method: 'PATCH',
                        body: JSON.stringify({ confirmedTime: time })
                    });
                    showAdminToast('Booking confirmed!', 'success');
                    await loadBookings();

                    // Re-render current view
                    if (currentCalendarView === 'day') {
                        renderDayView();
                    } else {
                        renderBookingsCalendar();
                    }
                } catch (error) {
                    showAdminToast('Error: ' + error.message, 'error');
                }
            }
        }

        // Time input dialog for styled time picker
        let timeInputResolver = null;
        async function openTimeInputDialog({ title, message, confirmText = 'Confirm' }) {
            return new Promise(resolve => {
                timeInputResolver = resolve;
                document.getElementById('timeInputDialogTitle').textContent = title;
                document.getElementById('timeInputDialogMessage').textContent = message;
                document.getElementById('timeInputDialogConfirm').textContent = confirmText;
                document.getElementById('timeInputValue').value = '09:00';
                document.getElementById('timeInputDialog').style.display = 'flex';
                setTimeout(() => document.getElementById('timeInputValue').focus(), 100);
            });
        }

        function resolveTimeInput(confirmed) {
            const dialog = document.getElementById('timeInputDialog');
            dialog.style.display = 'none';
            if (timeInputResolver) {
                if (confirmed) {
                    timeInputResolver(document.getElementById('timeInputValue').value);
                } else {
                    timeInputResolver(null);
                }
                timeInputResolver = null;
            }
        }

        async function cancelBooking(id) {
            const proceed = await openConfirmDialog({
                title: 'Cancel booking?',
                message: 'This will cancel the booking and notify the customer if configured.',
                confirmText: 'Cancel Booking',
                tone: 'danger'
            });
            if (!proceed) return;
            try {
                await apiCall(`/admin/bookings/${id}/status`, {
                    method: 'PATCH',
                    body: JSON.stringify({ status: 'CANCELLED' })
                });
                showAdminToast('Booking cancelled', 'success');
                await loadBookings();

                // Re-render current view
                if (currentCalendarView === 'day') {
                    renderDayView();
                } else {
                    renderBookingsCalendar();
                }
            } catch (error) {
                showAdminToast('Error cancelling booking: ' + (error.message || 'Database error'), 'error');
            }
        }

        // ============================================
        // ASSIGN TIME MODAL (New Two-Step Booking Flow)
        // ============================================
        let currentAssignBookingId = null;
        let currentAssignBooking = null;
        let selectedTimeSlot = null;

        async function openAssignTimeModal(bookingId) {
            try {
                console.log('📋 openAssignTimeModal called with bookingId:', bookingId);
                console.log('📚 allBookings array has', allBookings.length, 'bookings');

                // Ensure we have stylists data loaded
                console.log('📝 Step 0: Ensuring admin booking data is loaded...');
                await ensureAdminBookingData();
                console.log('✅ Admin booking data loaded. Stylists:', adminBookingStylists.length);

                currentAssignBookingId = bookingId;
                currentAssignBooking = allBookings.find(b => b.id === bookingId);

                if (!currentAssignBooking) {
                    console.error('❌ Booking not found in allBookings array');
                    alert('Booking not found');
                    return;
                }
                console.log('✅ Found booking:', currentAssignBooking);

                // Populate booking details
                console.log('📝 Step 1: Setting customer name...');
                document.getElementById('assignTimeCustomer').textContent = currentAssignBooking.customerName || 'Guest';

                console.log('📝 Step 2: Setting requested date...');
                const requestedDate = new Date(currentAssignBooking.requestedDate || currentAssignBooking.date);
                document.getElementById('assignTimeRequestedDate').textContent = requestedDate.toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                console.log('📝 Step 3: Setting time window...');
                // Format time window
                const timeWindow = window.BookingConstants?.getTimeWindow(currentAssignBooking.requestedTimeWindow || currentAssignBooking.preferredTimeOfDay);
                document.getElementById('assignTimeWindow').textContent = timeWindow ?
                    `${timeWindow.icon} ${timeWindow.label} (${timeWindow.description})` :
                    (currentAssignBooking.requestedTimeWindow || currentAssignBooking.preferredTimeOfDay || 'Any');

                console.log('📝 Step 4: Loading services dropdown...');
                // Load services dropdown
                const serviceSelect = document.getElementById('assignTimeServiceSelect');
                if (adminBookingServices && adminBookingServices.length > 0) {
                    serviceSelect.innerHTML = '<option value="">Select service...</option>' +
                        adminBookingServices.map(s => `<option value="${s.id}" data-duration="${s.duration || 60}">${s.name} (${s.category || 'General'})</option>`).join('');
                    serviceSelect.value = currentAssignBooking.serviceId || '';
                }

                console.log('📝 Step 5: Pre-selecting stylist and date...');
                // Pre-select stylist and date
                document.getElementById('assignTimeStylist').value = currentAssignBooking.stylistId || '';
                document.getElementById('assignTimeDate').value = currentAssignBooking.requestedDate || currentAssignBooking.date;

                console.log('📝 Step 6: Loading stylists dropdown...');
                // Load stylists dropdown
                const stylistSelect = document.getElementById('assignTimeStylist');
                if (adminBookingStylists && adminBookingStylists.length > 0) {
                    stylistSelect.innerHTML = '<option value="">Select stylist...</option>' +
                        adminBookingStylists.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                    stylistSelect.value = currentAssignBooking.stylistId || '';
                }

                // Reset
                console.log('📝 Step 7: Resetting form...');
                selectedTimeSlot = null;
                document.getElementById('assignTimeError').style.display = 'none';

                // Load schedule if stylist and date are selected
                console.log('📝 Step 8: Checking if we need to load schedule...');
                if (currentAssignBooking.stylistId && (currentAssignBooking.requestedDate || currentAssignBooking.date)) {
                    console.log('📝 Step 9: Loading stylist schedule...');
                    await loadStylistSchedule();
                }

                console.log('📝 Step 10: Opening modal...');
                openModal('assignTimeModal');
                console.log('✅ Modal opened successfully!');
            } catch (error) {
                console.error('❌ Error in openAssignTimeModal:', error);
                console.error('Error stack:', error.stack);
                alert('Error opening assign modal: ' + error.message);
            }
        }

        function updateServiceDuration() {
            const serviceSelect = document.getElementById('assignTimeServiceSelect');
            const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
            const duration = selectedOption ? selectedOption.getAttribute('data-duration') : 60;
            document.getElementById('assignTimeDuration').value = duration || 60;
        }

        async function loadStylistSchedule() {
            const stylistId = document.getElementById('assignTimeStylist').value;
            const date = document.getElementById('assignTimeDate').value;
            const container = document.getElementById('timeSlotSchedule');

            if (!stylistId || !date) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--gray-medium);">Select a stylist and date to view available time slots</div>';
                return;
            }

            container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--gray-medium);">Loading schedule...</div>';

            // Generate time slots (8 AM to 8 PM, every 30 minutes)
            const timeSlots = [];
            for (let hour = 8; hour < 20; hour++) {
                for (let minute of [0, 30]) {
                    const timeStr = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                    timeSlots.push(timeStr);
                }
            }

            // Get booked slots for this stylist on this date
            const bookedSlots = allBookings
                .filter(b =>
                    b.stylistId === stylistId &&
                    (b.requestedDate || b.date) === date &&
                    b.status === 'CONFIRMED' &&
                    b.assignedStartTime
                )
                .map(b => b.assignedStartTime);

            // Render time slots
            container.innerHTML = '<div class="time-slots-grid">' +
                timeSlots.map(slot => {
                    const isBooked = bookedSlots.includes(slot);
                    return `<div class="time-slot ${isBooked ? 'booked' : ''}" data-time="${slot}">${slot}</div>`;
                }).join('') +
                '</div>';

            // Add click handlers
            document.querySelectorAll('.time-slot:not(.booked)').forEach(slot => {
                slot.addEventListener('click', function() {
                    // Remove selected from all
                    document.querySelectorAll('.time-slot').forEach(s => s.classList.remove('selected'));
                    // Add to clicked
                    this.classList.add('selected');
                    selectedTimeSlot = this.dataset.time;
                });
            });
        }

        async function confirmAssignTime() {
            const stylistId = document.getElementById('assignTimeStylist').value;
            const date = document.getElementById('assignTimeDate').value;
            const duration = parseInt(document.getElementById('assignTimeDuration').value) || 60;
            const errorDiv = document.getElementById('assignTimeError');

            errorDiv.style.display = 'none';

            if (!stylistId) {
                errorDiv.textContent = 'Please select a stylist';
                errorDiv.style.display = 'block';
                return;
            }

            if (!date) {
                errorDiv.textContent = 'Please select a date';
                errorDiv.style.display = 'block';
                return;
            }

            if (!selectedTimeSlot) {
                errorDiv.textContent = 'Please select a time slot';
                errorDiv.style.display = 'block';
                return;
            }

            // Calculate end time
            const [hours, minutes] = selectedTimeSlot.split(':').map(Number);
            const endMinutes = hours * 60 + minutes + duration;
            const endHours = Math.floor(endMinutes / 60);
            const endMins = endMinutes % 60;
            const assignedEndTime = `${endHours.toString().padStart(2, '0')}:${endMins.toString().padStart(2, '0')}`;

            try {
                await apiCall(`/admin/bookings/${currentAssignBookingId}/assign-time`, {
                    method: 'POST',
                    body: JSON.stringify({
                        stylistId,
                        assignedStartTime: selectedTimeSlot,
                        assignedEndTime
                    })
                });

                alert('✅ Time assigned successfully! Booking is now confirmed.');
                closeModal('assignTimeModal');
                loadBookings();
            } catch (error) {
                errorDiv.textContent = error.message || 'Failed to assign time';
                errorDiv.style.display = 'block';
            }
        }

        // ============================================
        // TEAM (Stylists)
        // ============================================
        async function loadTeam() {
            const container = document.getElementById('team-table-body');
            if (!container) return;

            try {
                const data = await apiCall('/admin/team');
                teamListCache = data.team || [];

                // Update active count
                const activeCount = teamListCache.filter(s => s.available !== false).length;
                const countEl = document.getElementById('teamActiveCount');
                if (countEl) countEl.textContent = activeCount;

                if (teamListCache.length > 0) {
                    container.innerHTML = teamListCache.map(s => `
                        <tr>
                            <td>
                                <div style="display:flex;align-items:center;gap:10px;">
                                    ${(s.imageUrl || s.image_url) ?
                                        `<img src="${s.imageUrl || s.image_url}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;" alt="${s.name}">` :
                                        `<div style="width:40px;height:40px;border-radius:50%;background:${s.color || '#F67599'};display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;">${s.name ? s.name.charAt(0) : '?'}</div>`
                                    }
                                    <div>
                                        <strong>${s.name}</strong>
                                        ${s.yearsExperience ? `<br><small style="color:#666;">${s.yearsExperience} years experience</small>` : ''}
                                    </div>
                                </div>
                            </td>
                            <td>${s.specialty || 'Stylist'}</td>
                            <td><span class="status-badge status-${s.available !== false ? 'confirmed' : 'cancelled'}">${s.available !== false ? 'Active' : 'Inactive'}</span></td>
                            <td>
                                <button class="btn btn-sm btn-outline" onclick="editTeamMember('${s.id}')" title="Edit">✏️</button>
                                <button class="btn btn-sm btn-outline" onclick="deleteTeamMember('${s.id}')" style="margin-left:6px; color: var(--danger);" title="Delete">🗑️</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    container.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:40px; color: #666;">No team members yet. Click "+ Add Team Member" to add your first stylist.</td></tr>';
                }
            } catch (error) {
                console.error('Team load error:', error);
                container.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:40px; color: #dc3545;">Error loading team members</td></tr>';
            }
        }

        function handleStaffPhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                showAdminToast('Please select an image file', 'error');
                return;
            }

            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showAdminToast('Image must be less than 5MB', 'error');
                return;
            }

            // Read file and convert to base64
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('staffPhotoPreview');
                const base64 = e.target.result;

                // Show preview
                preview.src = base64;
                preview.style.display = 'block';

                // Store the base64 data for saving
                preview.dataset.imageUrl = base64;
            };
            reader.onerror = function() {
                showAdminToast('Error reading file', 'error');
            };
            reader.readAsDataURL(file);
        }

        async function saveStaff() {
            const name = document.getElementById('staffName')?.value?.trim();
            const specialty = document.getElementById('staffRole')?.value;
            const tagline = document.getElementById('staffTagline')?.value?.trim();
            const yearsExperience = parseInt(document.getElementById('staffExperience')?.value) || 0;
            const instagram = document.getElementById('staffInstagram')?.value?.trim();
            const imageUrl = document.getElementById('staffPhotoPreview')?.dataset?.imageUrl || '';

            if (!name || !specialty) {
                showAdminToast('Name and specialty are required', 'error');
                return;
            }

            const staffData = { name, specialty, tagline, yearsExperience, instagram, imageUrl };

            try {
                if (editingTeamMemberId) {
                    // Update existing team member
                    await apiCall(`/admin/team/${editingTeamMemberId}`, {
                        method: 'PATCH',
                        body: JSON.stringify(staffData)
                    });
                    showAdminToast('Team member updated!', 'success');
                } else {
                    // Create new team member
                    await apiCall('/admin/team', {
                        method: 'POST',
                        body: JSON.stringify(staffData)
                    });
                    showAdminToast('Team member added!', 'success');
                }
                editingTeamMemberId = null;
                teamListCache = []; // Clear cache
                closeModal('addStaffModal');
                loadTeam();
            } catch (error) {
                showAdminToast('Error saving team member: ' + (error.message || ''), 'error');
            }
        }

        // ============================================
        // STAFF MANAGEMENT (Admin Only)
        // ============================================
        let staffList = [];
        let permissionsList = {};
        let stylistsForStaff = [];

        async function loadStaff() {
            if (adminUser?.role !== 'admin') {
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
                return;
            }

            try {
                const data = await apiCall('/admin/staff');
                staffList = data.staff || [];
                renderStaffTable(staffList);

                // Load permissions list
                const permData = await apiCall('/admin/staff/permissions-list');
                permissionsList = permData.permissions || {};

                // Load stylists for linking
                const stylistData = await apiCall('/stylists');
                stylistsForStaff = stylistData.stylists || [];
            } catch (error) {
                console.error('Error loading staff:', error);
                document.getElementById('staff-table-body').innerHTML =
                    '<tr><td colspan="6" style="text-align: center; color: #e53e3e; padding: 40px;">Failed to load staff members</td></tr>';
            }
        }

        function renderStaffTable(staff) {
            const tbody = document.getElementById('staff-table-body');
            if (!staff || staff.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #666;">No staff members yet. Click "Add Staff Member" to create one.</td></tr>';
                return;
            }

            tbody.innerHTML = staff.map(s => {
                const permCount = Object.values(s.permissions || {}).filter(v => v === true).length;
                const permText = s.role === 'admin' ? '<span style="color: #e53e3e; font-weight: 600;">All (Admin)</span>'
                    : permCount === 0 ? '<span style="color: #999;">None</span>'
                    : `<span style="color: #38a169;">${permCount} permissions</span>`;

                return `
                    <tr>
                        <td><strong>${s.name}</strong></td>
                        <td>${s.email}</td>
                        <td>
                            <span class="badge ${s.role === 'admin' ? 'badge-danger' : 'badge-info'}">
                                ${s.role === 'admin' ? 'Admin' : 'Staff'}
                            </span>
                        </td>
                        <td>${s.stylistName || '<span style="color: #999;">-</span>'}</td>
                        <td>${permText}</td>
                        <td>
                            ${s.role !== 'admin' ? `
                                <button class="btn btn-sm btn-secondary" onclick="editStaff('${s.id}')" title="Edit">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="resetStaffPassword('${s.id}', '${s.name}')" title="Reset Password">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                                    </svg>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="removeStaff('${s.id}', '${s.name}')" title="Remove">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                </button>
                            ` : '<span style="color: #999; font-size: 12px;">Protected</span>'}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function showAddStaffModal() {
            document.getElementById('staff-modal-title').textContent = 'Add Staff Member';
            document.getElementById('staff-edit-id').value = '';
            document.getElementById('staff-name').value = '';
            document.getElementById('staff-email').value = '';
            document.getElementById('staff-email').disabled = false;
            document.getElementById('staff-phone').value = '';
            document.getElementById('staff-password').value = '';
            document.getElementById('staff-password-group').style.display = 'block';

            // Populate stylists dropdown
            const stylistSelect = document.getElementById('staff-stylist');
            stylistSelect.innerHTML = '<option value="">-- No linked stylist --</option>' +
                stylistsForStaff.map(s => `<option value="${s.id}">${s.name}</option>`).join('');

            // Populate permissions grid
            renderPermissionsGrid({});

            document.getElementById('staff-modal').style.display = 'flex';
        }

        function editStaff(staffId) {
            const staff = staffList.find(s => s.id === staffId);
            if (!staff) return;

            document.getElementById('staff-modal-title').textContent = 'Edit Staff Member';
            document.getElementById('staff-edit-id').value = staff.id;
            document.getElementById('staff-name').value = staff.name || '';
            document.getElementById('staff-email').value = staff.email || '';
            document.getElementById('staff-email').disabled = true;
            document.getElementById('staff-phone').value = staff.phone || '';
            document.getElementById('staff-password-group').style.display = 'none';

            // Populate stylists dropdown
            const stylistSelect = document.getElementById('staff-stylist');
            stylistSelect.innerHTML = '<option value="">-- No linked stylist --</option>' +
                stylistsForStaff.map(s => `<option value="${s.id}" ${staff.stylistId === s.id ? 'selected' : ''}>${s.name}</option>`).join('');

            // Populate permissions grid
            renderPermissionsGrid(staff.permissions || {});

            document.getElementById('staff-modal').style.display = 'flex';
        }

        function renderPermissionsGrid(currentPermissions) {
            const grid = document.getElementById('staff-permissions-grid');
            grid.innerHTML = Object.entries(permissionsList).map(([key, perm]) => `
                <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #f7f7f7; border-radius: 6px; cursor: pointer;">
                    <input type="checkbox" id="perm-${key}" ${currentPermissions[key] ? 'checked' : ''} style="width: 18px; height: 18px;">
                    <div>
                        <div style="font-weight: 500;">${perm.label}</div>
                        <div style="font-size: 11px; color: #666;">${perm.description}</div>
                    </div>
                </label>
            `).join('');
        }

        function closeStaffModal() {
            document.getElementById('staff-modal').style.display = 'none';
        }

        async function saveAdminStaff() {
            const editId = document.getElementById('staff-edit-id').value;
            const name = document.getElementById('staff-name').value.trim();
            const email = document.getElementById('staff-email').value.trim();
            const phone = document.getElementById('staff-phone').value.trim();
            const stylistId = document.getElementById('staff-stylist').value || null;
            const password = document.getElementById('staff-password').value;

            if (!name || !email) {
                showAdminToast('Name and email are required', 'error');
                return;
            }

            // Gather permissions
            const permissions = {};
            Object.keys(permissionsList).forEach(key => {
                const checkbox = document.getElementById(`perm-${key}`);
                if (checkbox && checkbox.checked) {
                    permissions[key] = true;
                }
            });

            try {
                let result;
                if (editId) {
                    // Update existing
                    result = await apiCall(`/admin/staff/${editId}`, 'PUT', {
                        name, phone, permissions, stylistId
                    });
                    showAdminToast('Staff member updated successfully', 'success');
                } else {
                    // Create new
                    result = await apiCall('/admin/staff', 'POST', {
                        email, name, phone, permissions, stylistId, password: password || undefined
                    });
                    if (result.temporaryPassword) {
                        showAdminToast(`Staff created! Temporary password: ${result.temporaryPassword}`, 'success');
                        alert(`Staff member created!\\n\\nTemporary password: ${result.temporaryPassword}\\n\\nPlease share this with the staff member. They will be required to change it on first login.`);
                    } else {
                        showAdminToast('Staff member created successfully', 'success');
                    }
                }

                closeStaffModal();
                loadStaff();
            } catch (error) {
                showAdminToast(error.message || 'Failed to save staff member', 'error');
            }
        }

        async function resetStaffPassword(staffId, staffName) {
            if (!confirm(`Reset password for ${staffName}?\\n\\nA new temporary password will be generated.`)) return;

            try {
                const result = await apiCall(`/admin/staff/${staffId}/reset-password`, 'POST');
                showAdminToast('Password reset successfully', 'success');
                alert(`Password reset for ${staffName}!\\n\\nNew temporary password: ${result.temporaryPassword}\\n\\nPlease share this with the staff member.`);
            } catch (error) {
                showAdminToast(error.message || 'Failed to reset password', 'error');
            }
        }

        async function removeStaff(staffId, staffName) {
            if (!confirm(`Remove ${staffName} as staff?\\n\\nThey will be converted to a regular customer account and lose all admin access.`)) return;

            try {
                await apiCall(`/admin/staff/${staffId}`, 'DELETE');
                showAdminToast('Staff member removed', 'success');
                loadStaff();
            } catch (error) {
                showAdminToast(error.message || 'Failed to remove staff member', 'error');
            }
        }

        // ============================================
        // CUSTOMERS
        // ============================================
        let editingCustomerId = null;

        async function loadCustomers() {
            try {
                const data = await apiCall('/admin/customers');
                const container = document.querySelector('#customers .data-table tbody');
                const countEl = document.getElementById('customersCount');
                if (countEl) countEl.textContent = `${data.customers.length} customers`;

                window.lastCustomersList = data.customers || [];

                renderCustomersTable(data.customers);
            } catch (error) {
                console.log('Customers load error:', error);
            }
        }

        function filterCustomers() {
            const searchTerm = (document.getElementById('customerSearchInput')?.value || '').toLowerCase();

            let filtered = window.lastCustomersList || [];

            if (searchTerm) {
                filtered = filtered.filter(c =>
                    (c.name && c.name.toLowerCase().includes(searchTerm)) ||
                    (c.email && c.email.toLowerCase().includes(searchTerm)) ||
                    (c.phone && c.phone.toLowerCase().includes(searchTerm))
                );
            }

            renderCustomersTable(filtered);
        }

        function renderCustomersTable(customers) {
            const container = document.querySelector('#customers .data-table tbody');
            const countEl = document.getElementById('customersCount');
            if (countEl) countEl.textContent = `${customers.length} customers`;

            if (!container) return;

            if (customers.length === 0) {
                container.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px; color: var(--text-subtle);">No customers found</td></tr>';
                return;
            }

            container.innerHTML = customers.map(c => {
                const initials = getInitials(c.name || c.email || '');
                const lastVisit = c.createdAt ? formatDateDisplay(c.createdAt) : '-';
                const tierBadge = c.tier ? `<span class="tier-badge tier-${c.tier.toLowerCase()}">${c.tier}</span>` : '';
                return `
                    <tr class="customer-row" onclick="openCustomerProfile('${c.id}')" style="cursor: pointer;" title="Click to view profile">
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div class="avatar-placeholder" style="background: var(--brand-gradient); color: white;">${initials}</div>
                                <div>
                                    <div style="font-weight: 600;">${c.name || '-'}</div>
                                    ${tierBadge}
                                </div>
                            </div>
                        </td>
                        <td>${c.email || '-'}</td>
                        <td>${c.phone || '-'}</td>
                        <td>${(c.points || 0).toLocaleString()}</td>
                        <td>R${(c.totalSpent || 0).toLocaleString()}</td>
                        <td>${lastVisit}</td>
                    </tr>
                `;
            }).join('');
        }

        function exportCustomersCSV() {
            const customers = window.lastCustomersList || [];
            if (customers.length === 0) {
                showAdminToast('No customers to export', 'error');
                return;
            }

            const headers = ['Name', 'Email', 'Phone', 'Points', 'Total Spent'];
            const rows = customers.map(c => [
                c.name || '',
                c.email || '',
                c.phone || '',
                c.points || 0,
                c.totalSpent || 0
            ]);

            const csv = [headers.join(','), ...rows.map(r => r.map(v => `"${v}"`).join(','))].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `flirt-customers-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            showAdminToast('Customers exported!', 'success');
        }

        // Flag to track if we're creating a customer from booking modal
        let creatingCustomerFromBooking = false;

        // Open new customer modal from booking flow
        function openNewCustomerFromBooking() {
            creatingCustomerFromBooking = true;
            // Don't close booking modal - just open customer modal on top
            openCustomerModal(null);
            // Add stacked class so customer modal appears above booking modal
            document.getElementById('customerModal').classList.add('stacked');
        }

        function openCustomerModal(customer = null) {
            editingCustomerId = customer?.id || null;
            document.getElementById('customerModalTitle').textContent = editingCustomerId ? 'Edit Customer' : 'Add Customer';
            document.getElementById('editingCustomerId').value = editingCustomerId || '';
            document.getElementById('customerName').value = customer?.name || '';
            document.getElementById('customerEmail').value = customer?.email || '';
            document.getElementById('customerPhone').value = customer?.phone || '';
            document.getElementById('customerPoints').value = customer?.points ?? 0;
            document.getElementById('customerPassword').value = '';

            // Show/hide reset password section based on whether we're editing
            const resetSection = document.getElementById('resetPasswordSection');
            const resetResult = document.getElementById('resetPasswordResult');
            if (editingCustomerId) {
                resetSection.style.display = 'block';
                resetResult.style.display = 'none';
            } else {
                resetSection.style.display = 'none';
            }

            openModal('customerModal');
        }

        function closeCustomerModal() {
            editingCustomerId = null;
            creatingCustomerFromBooking = false; // Reset flag on close
            document.getElementById('customerModal').classList.remove('stacked'); // Remove stacked class
            closeModal('customerModal');
        }

        function editCustomer(customerId) {
            const rowData = window.lastCustomersList?.find(c => c.id === customerId);
            openCustomerModal(rowData || { id: customerId });
        }

        async function saveCustomer() {
            const name = document.getElementById('customerName').value.trim();
            const email = document.getElementById('customerEmail').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();
            const points = parseInt(document.getElementById('customerPoints').value, 10) || 0;
            const password = document.getElementById('customerPassword').value.trim();

            if (!name || !email) {
                alert('Name and email are required');
                return;
            }

            // Track if we came from booking flow
            const wasFromBookingFlow = creatingCustomerFromBooking;

            try {
                let newCustomerId = null;

                if (editingCustomerId) {
                    await apiCall(`/admin/customers/${editingCustomerId}`, {
                        method: 'PUT',
                        body: JSON.stringify({ name, phone, points, password: password || undefined })
                    });
                    alert('Customer updated');
                } else {
                    const result = await apiCall('/admin/customers', {
                        method: 'POST',
                        body: JSON.stringify({ name, email, phone, points, password: password || undefined })
                    });
                    newCustomerId = result.customerId || result.id;

                    if (wasFromBookingFlow) {
                        // Don't show alert, just close and update dropdown
                    } else {
                        alert('Customer added');
                    }
                }

                closeCustomerModal();
                await loadCustomers();

                // If we were creating from booking flow, update the booking customer dropdown and select new customer
                if (wasFromBookingFlow && newCustomerId) {
                    await refreshBookingCustomerDropdown(newCustomerId);
                }
            } catch (error) {
                alert('Error saving customer: ' + error.message);
            }
        }

        // Refresh the booking customer dropdown and optionally select a customer
        async function refreshBookingCustomerDropdown(selectCustomerId = null) {
            try {
                const data = await apiCall('/admin/customers');
                const customers = data.customers || [];
                const customerSelect = document.getElementById('adminBookingCustomer');

                customerSelect.innerHTML = '<option value="">Select customer...</option>' +
                    customers.map(c => `<option value="${c.id}">${c.name} (${c.email})</option>`).join('');

                // If a customer ID was provided, select them
                if (selectCustomerId) {
                    customerSelect.value = selectCustomerId;
                }
            } catch (error) {
                console.error('Error refreshing customer dropdown:', error);
            }
        }

        function openChatForCustomer(id, name, email) {
            alert(`Chat for ${name || email || id} coming soon`);
        }

        async function resetCustomerPassword() {
            if (!editingCustomerId) {
                alert('No customer selected');
                return;
            }

            const sendEmail = document.getElementById('sendResetEmail').checked;
            const resultEl = document.getElementById('resetPasswordResult');

            if (!confirm('Are you sure you want to reset this customer\'s password?')) {
                return;
            }

            try {
                resultEl.style.display = 'block';
                resultEl.style.background = '#fff3cd';
                resultEl.style.color = '#856404';
                resultEl.innerHTML = 'Resetting password...';

                const data = await apiCall(`/admin/customers/${editingCustomerId}/reset-password`, {
                    method: 'POST',
                    body: JSON.stringify({ sendEmail })
                });

                resultEl.style.background = '#d4edda';
                resultEl.style.color = '#155724';

                if (sendEmail) {
                    resultEl.innerHTML = `
                        <strong>Password reset successfully!</strong><br>
                        <span style="font-size: 12px;">Temporary password: <code style="background: #f8f9fa; padding: 2px 6px; border-radius: 4px;">${data.temporaryPassword}</code></span><br>
                        <span style="font-size: 12px;">Email sent to customer.</span>
                    `;
                } else {
                    resultEl.innerHTML = `
                        <strong>Password reset successfully!</strong><br>
                        <span style="font-size: 12px;">Temporary password: <code style="background: #f8f9fa; padding: 2px 6px; border-radius: 4px;">${data.temporaryPassword}</code></span><br>
                        <span style="font-size: 12px; color: #856404;">Please share this password with the customer manually.</span>
                    `;
                }
            } catch (error) {
                resultEl.style.background = '#f8d7da';
                resultEl.style.color = '#721c24';
                resultEl.innerHTML = `<strong>Error:</strong> ${error.message || 'Failed to reset password'}`;
            }
        }

        function getInitials(text) {
            return text.split(' ').filter(Boolean).map(t => t[0]).join('').slice(0, 2).toUpperCase() || '?';
        }

        // ============================================
        // CUSTOMER PROFILE
        // ============================================
        let currentProfileCustomerId = null;
        let currentProfileData = null;

        async function openCustomerProfile(customerId) {
            currentProfileCustomerId = customerId;
            document.getElementById('customerProfileModal').style.display = 'flex';

            // Show loading state
            document.getElementById('profileName').textContent = 'Loading...';

            try {
                const data = await apiCall(`/admin/customers/${customerId}/profile`);
                currentProfileData = data.profile;
                renderCustomerProfile(data.profile);
            } catch (error) {
                console.error('Error loading customer profile:', error);
                showAdminToast('Failed to load customer profile', 'error');
                closeCustomerProfile();
            }
        }

        function closeCustomerProfile() {
            document.getElementById('customerProfileModal').style.display = 'none';
            currentProfileCustomerId = null;
            currentProfileData = null;
        }

        function renderCustomerProfile(profile) {
            // Header info
            document.getElementById('profileAvatar').textContent = getInitials(profile.name || '');
            document.getElementById('profileName').textContent = profile.name || 'Unknown';
            document.getElementById('profileEmail').textContent = profile.email || '-';
            document.getElementById('profilePhone').textContent = profile.phone || 'No phone';
            document.getElementById('profileMemberSince').textContent = profile.createdAt
                ? 'Member since ' + formatDate(profile.createdAt)
                : '';

            // Tier badge
            const tierIcons = { bronze: '🥉', silver: '🥈', gold: '🥇', platinum: '👑' };
            const tier = profile.tier || 'bronze';
            document.getElementById('profileTierBadge').innerHTML = `
                <span class="tier-icon">${tierIcons[tier] || '🏅'}</span>
                <span class="tier-name">${tier.charAt(0).toUpperCase() + tier.slice(1)} Member</span>
            `;

            // Stats bar
            document.getElementById('statTotalSpent').textContent = 'R' + (profile.stats.totalSpent || 0).toLocaleString();
            document.getElementById('statPoints').textContent = (profile.points || 0).toLocaleString();
            document.getElementById('statBookings').textContent = profile.stats.totalBookings || 0;
            document.getElementById('statOrders').textContent = profile.stats.totalOrders || 0;
            document.getElementById('statInvoices').textContent = profile.stats.totalInvoices || 0;
            document.getElementById('statLastVisit').textContent = profile.stats.lastVisit
                ? formatDate(profile.stats.lastVisit)
                : '-';

            // Tab counts
            document.getElementById('tabBookingsCount').textContent = profile.bookings?.length || 0;
            document.getElementById('tabOrdersCount').textContent = profile.orders?.length || 0;
            document.getElementById('tabInvoicesCount').textContent = profile.invoices?.length || 0;
            document.getElementById('tabInspoCount').textContent = profile.inspoPhotos?.length || 0;

            // Render all tabs
            renderProfileOverview(profile);
            renderProfileBookings(profile.bookings || []);
            renderProfileOrders(profile.orders || []);
            renderProfileInvoices(profile.invoices || []);
            renderProfileLoyalty(profile);
            renderProfileInspo(profile.inspoPhotos || []);

            // Load chat history (async, doesn't block profile display)
            loadProfileChat();

            // Reset to overview tab
            switchProfileTab('overview');
        }

        function switchProfileTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.profile-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabName);
            });

            // Update tab content
            document.querySelectorAll('.profile-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            const tabContent = document.getElementById('profileTab' + tabName.charAt(0).toUpperCase() + tabName.slice(1));
            if (tabContent) tabContent.classList.add('active');
        }

        function renderProfileOverview(profile) {
            // Recent Activity
            const activities = [];

            // Add recent bookings
            (profile.bookings || []).slice(0, 3).forEach(b => {
                activities.push({
                    type: 'booking',
                    icon: '📅',
                    title: b.serviceName || b.service_name || 'Booking',
                    date: b.date,
                    amount: b.price || b.total
                });
            });

            // Add recent orders
            (profile.orders || []).slice(0, 3).forEach(o => {
                activities.push({
                    type: 'order',
                    icon: '🛒',
                    title: `Order #${(o.id || '').slice(-6).toUpperCase()}`,
                    date: o.createdAt || o.created_at,
                    amount: o.total
                });
            });

            // Add recent invoices
            (profile.invoices || []).slice(0, 3).forEach(i => {
                activities.push({
                    type: 'invoice',
                    icon: '📄',
                    title: `Invoice ${i.invoice_number || i.id?.slice(-6).toUpperCase()}`,
                    date: i.created_at,
                    amount: i.total || i.calculated_total
                });
            });

            // Sort by date
            activities.sort((a, b) => new Date(b.date) - new Date(a.date));

            const activityList = document.getElementById('recentActivityList');
            if (activities.length === 0) {
                activityList.innerHTML = '<div class="empty-state" style="padding: 20px;"><p>No recent activity</p></div>';
            } else {
                activityList.innerHTML = activities.slice(0, 6).map(a => `
                    <div class="activity-item">
                        <div class="activity-icon ${a.type}">${a.icon}</div>
                        <div class="activity-info">
                            <div class="activity-title">${a.title}</div>
                            <div class="activity-date">${formatDate(a.date)}</div>
                        </div>
                        ${a.amount ? `<div class="activity-amount">R${a.amount.toLocaleString()}</div>` : ''}
                    </div>
                `).join('');
            }

            // Points summary
            document.getElementById('pointsEarned').textContent = '+' + (profile.stats.pointsEarned || 0).toLocaleString();
            document.getElementById('pointsRedeemed').textContent = '-' + (profile.stats.pointsRedeemed || 0).toLocaleString();
            document.getElementById('pointsBalance').textContent = (profile.points || 0).toLocaleString();

            // Tier progress
            const tierProgress = document.getElementById('tierProgress');
            const settings = profile.loyaltySettings || { tierThresholds: { bronze: 0, silver: 500, gold: 1500, platinum: 5000 } };
            const thresholds = settings.tierThresholds;
            const points = profile.points || 0;
            const tier = profile.tier || 'bronze';

            let nextTier, nextThreshold, currentThreshold;
            if (tier === 'bronze') {
                nextTier = 'Silver';
                nextThreshold = thresholds.silver;
                currentThreshold = thresholds.bronze;
            } else if (tier === 'silver') {
                nextTier = 'Gold';
                nextThreshold = thresholds.gold;
                currentThreshold = thresholds.silver;
            } else if (tier === 'gold') {
                nextTier = 'Platinum';
                nextThreshold = thresholds.platinum;
                currentThreshold = thresholds.gold;
            } else {
                nextTier = null;
                nextThreshold = thresholds.platinum;
                currentThreshold = thresholds.platinum;
            }

            const progress = nextTier
                ? Math.min(100, ((points - currentThreshold) / (nextThreshold - currentThreshold)) * 100)
                : 100;

            tierProgress.innerHTML = nextTier ? `
                <div class="tier-progress-text">
                    ${nextThreshold - points} points to ${nextTier}
                </div>
                <div class="tier-progress-bar">
                    <div class="tier-progress-fill ${tier}" style="width: ${progress}%"></div>
                </div>
            ` : `
                <div class="tier-progress-text" style="color: var(--success);">
                    ✨ Highest tier achieved!
                </div>
            `;

            // Referrals summary
            const referralsSummary = document.getElementById('referralsSummary');
            const referrals = profile.referralsMade || [];
            if (referrals.length === 0 && !profile.referredBy) {
                referralsSummary.innerHTML = '<p style="color: var(--text-subtle);">No referrals yet</p>';
            } else {
                let html = '';
                if (profile.referredBy) {
                    html += `<div style="padding: 10px; background: var(--surface-muted); border-radius: 8px; margin-bottom: 10px;">
                        <small style="color: var(--text-subtle);">Referred by</small><br>
                        <strong>${profile.referredBy.referrer_name || 'Unknown'}</strong>
                    </div>`;
                }
                if (referrals.length > 0) {
                    html += `<div style="font-weight: 600; margin-bottom: 8px;">${referrals.length} referral${referrals.length !== 1 ? 's' : ''} made</div>`;
                    html += referrals.slice(0, 3).map(r => `
                        <div style="padding: 8px; background: var(--surface-muted); border-radius: 6px; margin-bottom: 6px; font-size: 13px;">
                            ${r.referee_name || r.referee_email || 'Unknown'}
                        </div>
                    `).join('');
                }
                referralsSummary.innerHTML = html;
            }

            // Quick stats
            document.getElementById('completedBookings').textContent = profile.stats.completedBookings || 0;
            document.getElementById('upcomingBookings').textContent = profile.stats.upcomingBookings || 0;
            document.getElementById('referralsMade').textContent = profile.stats.referralsMadeCount || 0;
            document.getElementById('inspoPhotos').textContent = profile.stats.inspoPhotosCount || 0;
        }

        function renderProfileBookings(bookings) {
            const tbody = document.getElementById('profileBookingsTable');
            const emptyMsg = document.getElementById('noBookingsMessage');

            if (bookings.length === 0) {
                tbody.innerHTML = '';
                emptyMsg.style.display = 'block';
                return;
            }

            emptyMsg.style.display = 'none';
            tbody.innerHTML = bookings.map(b => `
                <tr>
                    <td>
                        <strong>${formatDate(b.date)}</strong><br>
                        <small style="color: var(--text-subtle);">${b.time || '-'}</small>
                    </td>
                    <td>${b.serviceName || b.service_name || '-'}</td>
                    <td>${b.stylistName || b.stylist_name || '-'}</td>
                    <td><span class="status-badge ${b.status}">${b.status}</span></td>
                    <td>${b.price || b.total ? 'R' + (b.price || b.total) : '-'}</td>
                </tr>
            `).join('');
        }

        function renderProfileOrders(orders) {
            const tbody = document.getElementById('profileOrdersTable');
            const emptyMsg = document.getElementById('noOrdersMessage');

            if (orders.length === 0) {
                tbody.innerHTML = '';
                emptyMsg.style.display = 'block';
                return;
            }

            emptyMsg.style.display = 'none';
            tbody.innerHTML = orders.map(o => {
                const itemsStr = (o.items || []).slice(0, 2).map(i => i.product_name || 'Item').join(', ')
                    + (o.items?.length > 2 ? ` +${o.items.length - 2} more` : '');
                return `
                    <tr>
                        <td><strong>#${(o.id || '').slice(-6).toUpperCase()}</strong></td>
                        <td>${formatDate(o.createdAt || o.created_at)}</td>
                        <td><small>${itemsStr || 'No items'}</small></td>
                        <td><span class="status-badge ${o.status}">${o.status}</span></td>
                        <td>R${(o.total || 0).toLocaleString()}</td>
                    </tr>
                `;
            }).join('');
        }

        function renderProfileInvoices(invoices) {
            const tbody = document.getElementById('profileInvoicesTable');
            const emptyMsg = document.getElementById('noInvoicesMessage');

            if (invoices.length === 0) {
                tbody.innerHTML = '';
                emptyMsg.style.display = 'block';
                return;
            }

            emptyMsg.style.display = 'none';
            tbody.innerHTML = invoices.map(i => {
                const itemsStr = (i.items || []).slice(0, 2).map(item => item.description || 'Item').join(', ')
                    + (i.items?.length > 2 ? ` +${i.items.length - 2} more` : '');
                const total = i.total || i.calculated_total || 0;
                return `
                    <tr>
                        <td><strong>${i.invoice_number || '#' + (i.id || '').slice(-6).toUpperCase()}</strong></td>
                        <td>${formatDate(i.created_at)}</td>
                        <td><small>${itemsStr || 'No items'}</small></td>
                        <td><span class="status-badge ${i.status}">${i.status}</span></td>
                        <td>R${total.toLocaleString()}</td>
                        <td>
                            <button class="btn btn-sm btn-outline" onclick="viewInvoice('${i.id}')">View</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderProfileLoyalty(profile) {
            const tbody = document.getElementById('profileLoyaltyTable');
            const emptyMsg = document.getElementById('noLoyaltyMessage');
            const transactions = profile.loyaltyTransactions || [];

            if (transactions.length === 0) {
                tbody.innerHTML = '';
                emptyMsg.style.display = 'block';
                return;
            }

            emptyMsg.style.display = 'none';
            tbody.innerHTML = transactions.map(t => `
                <tr>
                    <td>${formatDate(t.created_at)}</td>
                    <td>${t.description || '-'}</td>
                    <td><span class="status-badge ${t.transaction_type}">${t.transaction_type || '-'}</span></td>
                    <td style="font-weight: 600; color: ${t.points >= 0 ? 'var(--success)' : 'var(--danger)'};">
                        ${t.points >= 0 ? '+' : ''}${t.points}
                    </td>
                </tr>
            `).join('');
        }

        function renderProfileInspo(photos) {
            const grid = document.getElementById('inspoGalleryGrid');
            const emptyMsg = document.getElementById('noInspoMessage');

            if (photos.length === 0) {
                grid.innerHTML = '';
                emptyMsg.style.display = 'block';
                return;
            }

            emptyMsg.style.display = 'none';
            grid.innerHTML = photos.map(p => `
                <div class="inspo-photo-card" onclick="viewInspoPhoto('${p.id}')">
                    <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: var(--surface-muted);">
                        <span style="font-size: 40px; opacity: 0.5;">📸</span>
                    </div>
                    <div class="inspo-photo-overlay">
                        ${p.label || p.notes || formatDate(p.created_at)}
                    </div>
                </div>
            `).join('');
        }

        async function viewInspoPhoto(photoId) {
            try {
                const data = await apiCall(`/inspo-photos/${photoId}`);
                if (data.photo?.image_data) {
                    // Open in new tab or modal
                    const win = window.open('', '_blank');
                    win.document.write(`<img src="${data.photo.image_data}" style="max-width: 100%; max-height: 100vh;">`);
                }
            } catch (error) {
                console.error('Error loading photo:', error);
            }
        }

        // ========== PROFILE CHAT FUNCTIONS ==========
        let profileChatData = [];

        async function loadProfileChat() {
            if (!currentProfileCustomerId) return;

            const historyContainer = document.getElementById('profileChatHistory');
            const emptyMsg = document.getElementById('noChatMessage');
            const countBadge = document.getElementById('tabChatCount');

            try {
                const data = await apiCall(`/admin/customers/${currentProfileCustomerId}/chat`);
                profileChatData = data.conversations || [];

                // Count total messages
                let totalMessages = 0;
                profileChatData.forEach(conv => {
                    totalMessages += conv.messages?.length || 0;
                });

                if (countBadge) {
                    countBadge.textContent = totalMessages;
                }

                if (profileChatData.length === 0 || totalMessages === 0) {
                    historyContainer.innerHTML = '';
                    emptyMsg.style.display = 'block';
                    return;
                }

                emptyMsg.style.display = 'none';
                renderProfileChatHistory(profileChatData);
            } catch (error) {
                console.error('Error loading profile chat:', error);
                historyContainer.innerHTML = '<p style="text-align: center; color: var(--danger);">Error loading chat history</p>';
            }
        }

        function renderProfileChatHistory(conversations) {
            const historyContainer = document.getElementById('profileChatHistory');

            historyContainer.innerHTML = conversations.map(conv => {
                const statusClass = conv.status === 'closed' ? 'closed' : '';
                const statusLabel = conv.status === 'closed' ? 'Closed' : 'Open';

                const messagesHtml = conv.messages.map(msg => {
                    const isAgent = msg.fromType === 'agent';
                    const messageClass = isAgent ? 'from-agent' : 'from-user';
                    const timeStr = formatDateTime(msg.createdAt);

                    return `
                        <div class="chat-message ${messageClass}">
                            <div class="chat-message-bubble">${escapeHtml(msg.text)}</div>
                            <div class="chat-message-time">${timeStr}</div>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="chat-conversation-group">
                        <div class="chat-conversation-header">
                            <span class="chat-conversation-date">
                                ${conv.source === 'admin_initiated' ? '📤 Started by admin' : '📥 Started by customer'}
                                · ${formatDate(conv.createdAt)}
                            </span>
                            <span class="chat-conversation-status ${statusClass}">${statusLabel}</span>
                        </div>
                        <div class="chat-messages-list">
                            ${messagesHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function sendProfileChatMessage() {
            if (!currentProfileCustomerId) return;

            const input = document.getElementById('profileChatInput');
            const text = input.value.trim();

            if (!text) {
                showAdminToast('Please enter a message', 'warning');
                return;
            }

            try {
                const response = await apiCall(`/admin/customers/${currentProfileCustomerId}/chat`, {
                    method: 'POST',
                    body: JSON.stringify({ text })
                });

                if (response.success) {
                    input.value = '';
                    showAdminToast('Message sent!', 'success');
                    // Reload chat to show new message
                    await loadProfileChat();
                    // Scroll to bottom of chat history
                    const historyContainer = document.getElementById('profileChatHistory');
                    if (historyContainer) {
                        historyContainer.scrollTop = historyContainer.scrollHeight;
                    }
                }
            } catch (error) {
                console.error('Error sending message:', error);
                showAdminToast('Failed to send message', 'error');
            }
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return dateStr;
            return date.toLocaleString('en-ZA', {
                day: 'numeric',
                month: 'short',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function editCustomerFromProfile() {
            if (!currentProfileCustomerId || !currentProfileData) return;
            closeCustomerProfile();
            openCustomerModal(currentProfileData);
        }

        async function createInvoiceForCustomer() {
            if (!currentProfileCustomerId || !currentProfileData) return;
            // Open invoice modal directly without closing profile or navigating
            await showCreateInvoice();
            // Pre-select the customer after modal opens
            setTimeout(() => {
                const customerSelect = document.getElementById('invoiceCustomerSelect');
                if (customerSelect) {
                    customerSelect.value = currentProfileCustomerId;
                    // Trigger change event to update any dependent fields
                    customerSelect.dispatchEvent(new Event('change'));
                }
            }, 100);
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return dateStr;
            return date.toLocaleDateString('en-ZA', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        // ============================================
        // PRODUCTS
        // ============================================
        async function loadProducts() {
            try {
                const data = await apiCall('/products');
                const rawProducts = data.products || [];

                const products = rawProducts.map(p => {
                    const salePrice = p.salePrice ?? p.sale_price ?? null;
                    const onSale = p.onSale ?? p.on_sale ?? !!salePrice;
                    const imageUrl = p.imageUrl || p.image_url || '';
                    return {
                        ...p,
                        name: p.name || 'Untitled product',
                        category: p.category || 'Uncategorized',
                        price: Number(p.price || 0),
                        salePrice: salePrice ? Number(salePrice) : null,
                        onSale: !!onSale,
                        stock: Number(p.stock || 0),
                        imageUrl,
                        sku: p.sku || ''
                    };
                });

                productListCache = products;

                // Calculate stats
                const totalCount = products.length;
                const lowStockThreshold = 10;
                const lowStockCount = products.filter(p => p.stock < lowStockThreshold).length;
                const inventoryValue = products.reduce((sum, p) => {
                    const effectivePrice = p.onSale && p.salePrice ? p.salePrice : p.price;
                    return sum + (effectivePrice * p.stock);
                }, 0);

                // Update stat cards
                document.getElementById('productsTotalCount').textContent = totalCount;
                document.getElementById('productsLowStockCount').textContent = lowStockCount;
                document.getElementById('productsInventoryValue').textContent = formatCurrencyZAR(inventoryValue);

                // Update product table
                const container = document.getElementById('productsTableBody');
                if (container) {
                    if (products.length > 0) {
                        container.innerHTML = products.map(p => {
                            const isLowStock = p.stock < lowStockThreshold;
                            const stockClass = isLowStock ? 'style="color: var(--danger); font-weight: 600;"' : '';
                            const stockBadge = isLowStock ? '<span style="background: rgba(244, 67, 54, 0.1); color: var(--danger); padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-left: 4px;">Low Stock</span>' : '';
                            const statusClass = p.stock > 0 ? 'status-confirmed' : 'cancelled';
                            const statusLabel = p.stock > 0 ? 'In Stock' : 'Out of Stock';
                            const thumb = p.imageUrl
                                ? `<img src="${p.imageUrl}" alt="${p.name}" style="width: 50px; height: 50px; object-fit: contain; background: var(--surface-muted); border-radius: 8px;">`
                                : `<div style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; background: var(--surface-muted); border-radius: 8px; color: var(--gray-medium); font-weight: 700;">${(p.name || '?').charAt(0)}</div>`;

                            const saleText = p.onSale && p.salePrice
                                ? `<span style="color: var(--danger); font-weight: 600;">${formatCurrencyZAR(p.salePrice)}</span>`
                                : '-';

                            return `
                                <tr>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            ${thumb}
                                            <div>
                                                <div style="font-weight: 600;">${p.name}</div>
                                                ${p.sku ? `<div style="font-size: 12px; color: var(--gray-medium);">SKU: ${p.sku}</div>` : ''}
                                            </div>
                                        </div>
                                    </td>
                                    <td>${p.category}</td>
                                    <td>${formatCurrencyZAR(p.price)}</td>
                                    <td>${saleText}</td>
                                    <td ${stockClass}>${p.stock}${stockBadge}</td>
                                    <td><span class="status-badge ${statusClass}">${statusLabel}</span></td>
                                    <td class="action-btns" style="gap: 6px;">
                                        <button class="btn btn-sm" onclick="editProduct('${p.id}')" title="Edit product">✏️ Edit</button>
                                        <button class="btn btn-sm" onclick="deleteProduct('${p.id}')" title="Delete product" style="color: var(--danger);">Delete</button>
                                    </td>
                                </tr>
                            `;
                        }).join('');
                    } else {
                        container.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--gray-medium);">No products yet. Add your first product!</td></tr>';
                    }
                }
            } catch (error) {
                console.log('Products load error:', error);
            }

            // Populate category filter dropdown
            const categoryFilter = document.getElementById('productCategoryFilter');
            if (categoryFilter && productListCache.length > 0) {
                const categories = [...new Set(productListCache.map(p => p.category).filter(Boolean))].sort();
                categoryFilter.innerHTML = '<option value="">All Categories</option>' +
                    categories.map(c => `<option value="${c}">${c}</option>`).join('');
            }
        }

        function filterProducts() {
            const searchTerm = (document.getElementById('productSearchInput')?.value || '').toLowerCase();
            const categoryFilter = document.getElementById('productCategoryFilter')?.value || '';
            const stockFilter = document.getElementById('productStockFilter')?.value || '';
            const lowStockThreshold = 10;

            let filtered = productListCache || [];

            if (searchTerm) {
                filtered = filtered.filter(p =>
                    (p.name && p.name.toLowerCase().includes(searchTerm)) ||
                    (p.category && p.category.toLowerCase().includes(searchTerm)) ||
                    (p.sku && p.sku.toLowerCase().includes(searchTerm))
                );
            }

            if (categoryFilter) {
                filtered = filtered.filter(p => p.category === categoryFilter);
            }

            if (stockFilter) {
                if (stockFilter === 'in') {
                    filtered = filtered.filter(p => p.stock >= lowStockThreshold);
                } else if (stockFilter === 'low') {
                    filtered = filtered.filter(p => p.stock > 0 && p.stock < lowStockThreshold);
                } else if (stockFilter === 'out') {
                    filtered = filtered.filter(p => p.stock === 0);
                }
            }

            renderProductsTable(filtered);
        }

        function renderProductsTable(products) {
            const container = document.getElementById('productsTableBody');
            if (!container) return;

            const lowStockThreshold = 10;

            if (products.length === 0) {
                container.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--gray-medium);">No products found</td></tr>';
                return;
            }

            container.innerHTML = products.map(p => {
                const isLowStock = p.stock < lowStockThreshold;
                const stockClass = isLowStock ? 'style="color: var(--danger); font-weight: 600;"' : '';
                const stockBadge = isLowStock ? '<span style="background: rgba(244, 67, 54, 0.1); color: var(--danger); padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-left: 4px;">Low Stock</span>' : '';
                const statusClass = p.stock > 0 ? 'status-confirmed' : 'cancelled';
                const statusLabel = p.stock > 0 ? 'In Stock' : 'Out of Stock';
                const thumb = p.imageUrl
                    ? `<img src="${p.imageUrl}" alt="${p.name}" style="width: 50px; height: 50px; object-fit: contain; background: var(--surface-muted); border-radius: 8px;">`
                    : `<div style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; background: var(--surface-muted); border-radius: 8px; color: var(--gray-medium); font-weight: 700;">${(p.name || '?').charAt(0)}</div>`;

                const saleText = p.onSale && p.salePrice
                    ? `<span style="color: var(--danger); font-weight: 600;">${formatCurrencyZAR(p.salePrice)}</span>`
                    : '-';

                return `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                ${thumb}
                                <div>
                                    <div style="font-weight: 600;">${p.name}</div>
                                    ${p.sku ? `<div style="font-size: 12px; color: var(--gray-medium);">SKU: ${p.sku}</div>` : ''}
                                </div>
                            </div>
                        </td>
                        <td>${p.category}</td>
                        <td>${formatCurrencyZAR(p.price)}</td>
                        <td>${saleText}</td>
                        <td ${stockClass}>${p.stock}${stockBadge}</td>
                        <td><span class="status-badge ${statusClass}">${statusLabel}</span></td>
                        <td class="action-btns" style="gap: 6px;">
                            <button class="btn btn-sm" onclick="editProduct('${p.id}')" title="Edit product">✏️ Edit</button>
                            <button class="btn btn-sm" onclick="deleteProduct('${p.id}')" title="Delete product" style="color: var(--danger);">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateProductImagePreview(url = '') {
            const wrap = document.getElementById('productImagePreview');
            const img = wrap?.querySelector('img');
            if (!wrap || !img) return;
            if (url) {
                img.src = url;
                wrap.style.display = 'block';
            } else {
                wrap.style.display = 'none';
            }
        }

        async function saveProduct() {
            const name = document.getElementById('productName')?.value?.trim();
            const sku = document.getElementById('productSku')?.value?.trim();
            const description = document.getElementById('productDescription')?.value?.trim();
            const category = document.getElementById('productCategory')?.value;
            const price = parseFloat(document.getElementById('productPrice')?.value);
            const salePrice = parseFloat(document.getElementById('productSalePrice')?.value) || null;
            const stock = parseInt(document.getElementById('productStock')?.value) || 0;
            const imageUrl = document.getElementById('productImageUrl')?.value?.trim() || '';

            if (!name || !category || !price) {
                alert('Name, category, and price are required');
                return;
            }

            const productData = {
                name,
                sku,
                description,
                category,
                price,
                stock,
                onSale: salePrice ? true : false,
                salePrice: salePrice || null,
                imageUrl
            };

            try {
                if (editingProductId) {
                    // Update existing product
                    await apiCall(`/admin/products/${editingProductId}`, {
                        method: 'PATCH',
                        body: JSON.stringify(productData)
                    });
                    showAdminToast('Product updated!', 'success');
                } else {
                    // Create new product
                    await apiCall('/admin/products', {
                        method: 'POST',
                        body: JSON.stringify(productData)
                    });
                    showAdminToast('Product added!', 'success');
                }
                editingProductId = null;
                productListCache = []; // Clear cache
                closeModal('addProductModal');
                loadProducts();
            } catch (error) {
                showAdminToast('Error saving product: ' + (error.message || ''), 'error');
            }
        }

        // ============================================
        // ORDERS
        // ============================================
        let orderFiltersBound = false;

        function initOrderFilters() {
            if (orderFiltersBound) return;
            const statusSelect = document.getElementById('orderStatusFilter');
            const deliverySelect = document.getElementById('orderDeliveryFilter');
            const dateInput = document.getElementById('orderDateFilter');
            const clearBtn = document.getElementById('orderFiltersClear');

            [statusSelect, deliverySelect, dateInput].forEach(el => {
                if (el) {
                    el.addEventListener('change', () => loadOrders());
                }
            });

            if (clearBtn) {
                clearBtn.addEventListener('click', () => {
                    if (statusSelect) statusSelect.value = '';
                    if (deliverySelect) deliverySelect.value = '';
                    if (dateInput) dateInput.value = '';
                    loadOrders();
                });
            }

            orderFiltersBound = true;
        }

        const formatOrderStatusClass = (statusKey) => {
            const map = {
                pending: 'pending',
                processing: 'active',
                shipped: 'active',
                delivered: 'completed',
                paid: 'completed',
                cancelled: 'cancelled'
            };
            return map[statusKey] || 'pending';
        };

        const formatOrderStatusLabel = (statusKey) => {
            return (statusKey || 'pending')
                .replace(/_/g, ' ')
                .replace(/\b\w/g, (c) => c.toUpperCase());
        };

        const formatDeliveryLabel = (method) => {
            if (!method) return 'Pickup';
            return String(method)
                .split(' ')
                .map(part => part.charAt(0).toUpperCase() + part.slice(1))
                .join(' ');
        };

        // ========== PAYROLL MANAGEMENT ==========
        let payrollRecords = [];
        let stylistsPayData = [];

        function initPayrollYearSelector() {
            const yearSelect = document.getElementById('payrollYear');
            if (!yearSelect) return;

            const currentYear = new Date().getFullYear();
            yearSelect.innerHTML = '';
            for (let y = currentYear; y >= currentYear - 2; y--) {
                const opt = document.createElement('option');
                opt.value = y;
                opt.textContent = y;
                yearSelect.appendChild(opt);
            }
            yearSelect.value = currentYear;

            // Set current month
            const monthSelect = document.getElementById('payrollMonth');
            if (monthSelect) {
                monthSelect.value = new Date().getMonth() + 1;
            }
        }

        async function loadPayroll() {
            const year = document.getElementById('payrollYear')?.value;
            const month = document.getElementById('payrollMonth')?.value;
            const status = document.getElementById('payrollStatus')?.value;

            if (!year || !month) return;

            const tbody = document.getElementById('payrollTableBody');
            const countEl = document.getElementById('payrollRecordsCount');

            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px; color: var(--gray-medium);">Loading...</td></tr>';
            }

            try {
                const params = new URLSearchParams({ year, month });
                if (status) params.append('status', status);

                const data = await apiCall(`/admin/payroll?${params.toString()}`);
                payrollRecords = data.records || [];

                // Update summary cards
                let totalBasic = 0, totalCommission = 0, totalGross = 0;
                payrollRecords.forEach(r => {
                    totalBasic += r.basic_pay || 0;
                    totalCommission += r.commission_amount || 0;
                    totalGross += r.gross_pay || 0;
                });

                document.getElementById('payrollTotalBasic').textContent = formatCurrencyZAR(totalBasic);
                document.getElementById('payrollTotalCommission').textContent = formatCurrencyZAR(totalCommission);
                document.getElementById('payrollTotalGross').textContent = formatCurrencyZAR(totalGross);
                document.getElementById('payrollStylistCount').textContent = payrollRecords.length;

                if (countEl) {
                    countEl.textContent = `${payrollRecords.length} record${payrollRecords.length !== 1 ? 's' : ''}`;
                }

                if (!tbody) return;

                if (payrollRecords.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: var(--gray-medium);">No payroll records for this period. Click "Generate Payroll" to calculate.</td></tr>';
                    return;
                }

                tbody.innerHTML = payrollRecords.map(r => {
                    const statusClass = r.status === 'paid' ? 'status-confirmed' :
                                       r.status === 'finalized' ? 'status-pending' : 'status-draft';
                    const statusLabel = r.status.charAt(0).toUpperCase() + r.status.slice(1);

                    const actions = [];
                    if (r.status !== 'paid') {
                        actions.push(`<button class="btn btn-sm btn-outline" onclick="recalculatePayroll('${r.id}')" title="Recalculate">🔄</button>`);
                    }
                    if (r.status === 'draft') {
                        actions.push(`<button class="btn btn-sm" onclick="finalizePayroll('${r.id}')">Finalize</button>`);
                    }
                    if (r.status === 'finalized') {
                        actions.push(`<button class="btn btn-sm btn-primary" onclick="markPayrollPaid('${r.id}')">Mark Paid</button>`);
                    }
                    if (r.status !== 'paid') {
                        actions.push(`<button class="btn btn-sm btn-outline" onclick="deletePayroll('${r.id}')" style="color: var(--danger);" title="Delete">🗑️</button>`);
                    }

                    return `
                        <tr>
                            <td><strong>${r.stylistName || 'Unknown'}</strong></td>
                            <td>${formatCurrencyZAR(r.basic_pay)}</td>
                            <td>${((r.commission_rate || 0) * 100).toFixed(0)}%</td>
                            <td>${r.total_bookings || 0}</td>
                            <td>${formatCurrencyZAR(r.total_service_revenue_ex_vat)}</td>
                            <td>${formatCurrencyZAR(r.commission_amount)}</td>
                            <td><strong>${formatCurrencyZAR(r.gross_pay)}</strong></td>
                            <td><span class="status-badge ${statusClass}">${statusLabel}</span></td>
                            <td class="action-btns" style="gap: 4px;">${actions.join(' ')}</td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading payroll:', error);
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px; color: var(--danger);">Error loading payroll data</td></tr>';
                }
            }
        }

        async function loadStylistPaySettings() {
            const tbody = document.getElementById('stylistPaySettingsBody');
            if (!tbody) return;

            try {
                const data = await apiCall('/stylists');
                stylistsPayData = data.stylists || [];

                if (stylistsPayData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px; color: var(--gray-medium);">No stylists found</td></tr>';
                    return;
                }

                tbody.innerHTML = stylistsPayData.map(s => `
                    <tr>
                        <td><strong>${s.name}</strong></td>
                        <td>${formatCurrencyZAR(s.basic_monthly_pay || 0)}</td>
                        <td class="action-btns">
                            <button class="btn btn-sm btn-outline" onclick="openStylistPayModal('${s.id}')">Edit</button>
                        </td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error('Error loading stylist pay settings:', error);
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px; color: var(--danger);">Error loading data</td></tr>';
            }
        }

        function openStylistPayModal(stylistId) {
            const stylist = stylistsPayData.find(s => s.id === stylistId);
            if (!stylist) return;

            document.getElementById('stylistPayId').value = stylistId;
            document.getElementById('stylistPayName').value = stylist.name;
            document.getElementById('stylistPayNameHeader').textContent = stylist.name;
            document.getElementById('stylistBasicPay').value = stylist.basic_monthly_pay || 0;

            document.getElementById('stylistPayModal').classList.add('show');
        }

        async function saveStylistPay() {
            const stylistId = document.getElementById('stylistPayId').value;
            const basicMonthlyPay = parseFloat(document.getElementById('stylistBasicPay').value) || 0;

            try {
                await apiCall(`/admin/stylists/${stylistId}/pay`, {
                    method: 'PATCH',
                    body: JSON.stringify({ basicMonthlyPay })
                });

                closeModal('stylistPayModal');
                await loadStylistPaySettings();
                showAdminToast('Salary updated successfully', 'success');
            } catch (error) {
                console.error('Error saving stylist pay:', error);
                showAdminToast('Failed to save salary', 'error');
            }
        }

        async function generatePayroll() {
            const year = parseInt(document.getElementById('payrollYear')?.value);
            const month = parseInt(document.getElementById('payrollMonth')?.value);

            if (!year || !month) {
                showAdminToast('Please select year and month', 'error');
                return;
            }

            const monthName = document.getElementById('payrollMonth')?.options[month - 1]?.text || month;
            const proceed = await openConfirmDialog({
                title: 'Generate Payroll?',
                message: `This will calculate payroll for all stylists for ${monthName} ${year}. Existing draft records will be updated.`,
                confirmText: 'Generate',
                tone: 'neutral'
            });

            if (!proceed) return;

            try {
                const data = await apiCall('/admin/payroll/generate', {
                    method: 'POST',
                    body: JSON.stringify({ year, month })
                });

                const successCount = data.results?.filter(r => r.success).length || 0;
                showAdminToast(`Generated payroll for ${successCount} stylists`, 'success');
                await loadPayroll();
            } catch (error) {
                console.error('Error generating payroll:', error);
                showAdminToast('Failed to generate payroll', 'error');
            }
        }

        async function recalculatePayroll(recordId) {
            try {
                await apiCall(`/admin/payroll/${recordId}/recalculate`, { method: 'POST' });
                showAdminToast('Payroll recalculated', 'success');
                await loadPayroll();
            } catch (error) {
                console.error('Error recalculating payroll:', error);
                showAdminToast(error.message || 'Failed to recalculate', 'error');
            }
        }

        async function finalizePayroll(recordId) {
            const proceed = await openConfirmDialog({
                title: 'Finalize Payroll?',
                message: 'This will mark the payroll as finalized. You can still recalculate it until marked as paid.',
                confirmText: 'Finalize',
                tone: 'neutral'
            });

            if (!proceed) return;

            try {
                await apiCall(`/admin/payroll/${recordId}/finalize`, { method: 'POST' });
                showAdminToast('Payroll finalized', 'success');
                await loadPayroll();
            } catch (error) {
                console.error('Error finalizing payroll:', error);
                showAdminToast(error.message || 'Failed to finalize', 'error');
            }
        }

        async function markPayrollPaid(recordId) {
            const proceed = await openConfirmDialog({
                title: 'Mark as Paid?',
                message: 'This will lock the payroll record. It cannot be modified after this.',
                confirmText: 'Mark Paid',
                tone: 'neutral'
            });

            if (!proceed) return;

            try {
                await apiCall(`/admin/payroll/${recordId}/pay`, { method: 'POST' });
                showAdminToast('Payroll marked as paid', 'success');
                await loadPayroll();
            } catch (error) {
                console.error('Error marking payroll as paid:', error);
                showAdminToast(error.message || 'Failed to mark as paid', 'error');
            }
        }

        async function deletePayroll(recordId) {
            const proceed = await openConfirmDialog({
                title: 'Delete Payroll Record?',
                message: 'This action cannot be undone.',
                confirmText: 'Delete',
                tone: 'danger'
            });

            if (!proceed) return;

            try {
                await apiCall(`/admin/payroll/${recordId}`, { method: 'DELETE' });
                showAdminToast('Payroll record deleted', 'success');
                await loadPayroll();
            } catch (error) {
                console.error('Error deleting payroll:', error);
                showAdminToast(error.message || 'Failed to delete', 'error');
            }
        }

        function exportPayrollCSV() {
            const year = document.getElementById('payrollYear')?.value;
            const month = document.getElementById('payrollMonth')?.value;

            let url = `${API_BASE}/admin/payroll/export/csv`;
            const params = new URLSearchParams();
            if (year) params.append('year', year);
            if (month) params.append('month', month);
            if (params.toString()) url += `?${params.toString()}`;

            // Add auth token
            const token = localStorage.getItem('flirtAdminToken');
            if (token) {
                url += (url.includes('?') ? '&' : '?') + `token=${token}`;
            }

            window.open(url, '_blank');
        }

        // ========== ORDERS MANAGEMENT ==========
        async function loadOrders() {
            initOrderFilters();
            const container = document.getElementById('ordersTableBody');
            const countText = document.getElementById('orderCountText');

            const status = document.getElementById('orderStatusFilter')?.value || '';
            const deliveryMethod = document.getElementById('orderDeliveryFilter')?.value || '';
            const date = document.getElementById('orderDateFilter')?.value || '';

            const params = new URLSearchParams();
            if (status) params.append('status', status);
            if (deliveryMethod) params.append('deliveryMethod', deliveryMethod);
            if (date) params.append('date', date);

            if (container) {
                container.innerHTML = `<tr><td colspan="7" style="text-align: center; color: var(--gray-medium); padding: 16px;">Loading orders.....</td></tr>`;
            }

            try {
                const data = await apiCall(`/admin/orders${params.toString() ? `?${params.toString()}` : ''}`);
                const orders = data.orders || [];

                // Update pending orders badge (always fetch unfiltered pending count)
                updatePendingOrdersBadge(orders, !params.toString());

                if (countText) {
                    countText.textContent = orders.length
                        ? `${orders.length} order${orders.length === 1 ? '' : 's'}`
                        : 'No orders found';
                }

                if (!container) return;

                if (!orders.length) {
                    container.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 20px; color: var(--gray-medium);">No orders found for these filters.</td></tr>`;
                    return;
                }

                container.innerHTML = orders.map(o => {
                    const statusKey = String(o.status || 'pending').toLowerCase();
                    const statusLabel = formatOrderStatusLabel(statusKey);
                    const statusClass = formatOrderStatusClass(statusKey);
                    const itemCount = Array.isArray(o.items)
                        ? o.items.reduce((sum, item) => sum + (item.quantity || 0), 0)
                        : 0;
                    const total = formatCurrencyZAR(o.total || 0);
                    const delivery = formatDeliveryLabel(o.deliveryMethod || o.delivery_method || 'pickup');
                    const createdAt = formatDateDisplay(o.createdAt || o.created_at);
                    const idShort = o.id ? `#${o.id.substring(0, 8)}` : '—';

                    const actions = [];
                    if (statusKey !== 'processing' && statusKey !== 'cancelled' && statusKey !== 'delivered') {
                        actions.push(`<button class="btn btn-sm" onclick="updateOrderStatus('${o.id}', 'processing')">Process</button>`);
                    }
                    if (statusKey !== 'shipped' && statusKey !== 'cancelled' && statusKey !== 'delivered') {
                        actions.push(`<button class="btn btn-sm" onclick="updateOrderStatus('${o.id}', 'shipped')">Ship</button>`);
                    }
                    if (statusKey !== 'delivered') {
                        actions.push(`<button class="btn btn-sm btn-outline" onclick="updateOrderStatus('${o.id}', 'delivered')">Mark Delivered</button>`);
                    }
                    if (statusKey !== 'cancelled' && statusKey !== 'delivered') {
                        actions.push(`<button class="btn btn-sm btn-outline" style="color: var(--danger);" onclick="updateOrderStatus('${o.id}', 'cancelled')">Cancel</button>`);
                    }

                    return `
                        <tr>
                            <td title="${o.id || ''}">${idShort}</td>
                            <td>
                                <div style="font-weight: 600;">${o.customerName || o.customer_name || 'Guest'}</div>
                                ${o.customerEmail ? `<div style="color: var(--gray-medium); font-size: 12px;">${o.customerEmail}</div>` : ''}
                            </td>
                            <td>${itemCount || (Array.isArray(o.items) ? o.items.length : 0)} items</td>
                            <td>${total}</td>
                            <td>${delivery}${createdAt ? `<div style="color: var(--gray-medium); font-size: 12px;">${createdAt}</div>` : ''}</td>
                            <td><span class="status-badge ${statusClass}">${statusLabel}</span></td>
                            <td class="action-btns" style="gap: 6px;">${actions.join(' ') || '<span style="color: var(--gray-medium); font-size: 12px;">No actions</span>'}</td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.log('Orders load error:', error);
                if (container) {
                    container.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 20px; color: var(--danger);">Error Loading orders... Please try again.</td></tr>`;
                }
                if (countText) {
                    countText.textContent = 'Error loading orders';
                }
            }
        }

        async function updateOrderStatus(id, status) {
            const statusLabel = formatOrderStatusLabel(status);
            const proceed = await openConfirmDialog({
                title: 'Update order status?',
                message: `Change this order to ${statusLabel}?`,
                confirmText: 'Update',
                tone: status === 'cancelled' ? 'danger' : 'neutral'
            });
            if (!proceed) return;

            try {
                await apiCall(`/admin/orders/${id}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ status })
                });
                showAdminToast(`Order updated to ${statusLabel}`, 'success');
                loadOrders();
            } catch (error) {
                showAdminToast('Error updating order: ' + (error.message || ''), 'error');
            }
        }

        // ============================================
        // PROMOTIONS
        // ============================================
        async function loadPromos() {
            try {
                const data = await apiCall('/admin/promos');
                const promos = data.promos || [];

                // Calculate stats
                const activeCount = promos.filter(p => p.active).length;
                const totalUsed = promos.reduce((sum, p) => sum + (p.times_used || 0), 0);

                // Calculate total discounts given (this is an estimate based on orders table)
                // For now, we'll fetch from orders API
                let totalDiscounts = 0;
                try {
                    const ordersData = await apiCall('/admin/orders');
                    totalDiscounts = (ordersData.orders || []).reduce((sum, o) => sum + (o.discount || 0), 0);
                } catch (e) {
                    console.log('Could not fetch orders for discount calculation');
                }

                // Update stat cards
                document.getElementById('promoActiveCount').textContent = activeCount;
                document.getElementById('promoCodesUsed').textContent = totalUsed;
                document.getElementById('promoDiscountsGiven').textContent = 'R' + totalDiscounts.toLocaleString();

                // Update table
                const container = document.querySelector('#promotions .data-table tbody');
                if (container) {
                    if (promos.length > 0) {
                        container.innerHTML = promos.map(p => `
                            <tr>
                                <td><code style="background: var(--gray-light); padding: 4px 8px; border-radius: 4px;">${p.code}</code></td>
                                <td>
                                    <div style="font-weight: 500;">${p.title || p.description || '-'}</div>
                                    ${p.title && p.description ? `<div style="font-size: 12px; color: var(--gray-medium);">${p.description}</div>` : ''}
                                </td>
                                <td>${p.discount_type === 'percentage' ? p.discount_value + '%' : 'R' + p.discount_value}</td>
                                <td>${p.min_order ? 'R' + p.min_order : '-'}</td>
                                <td>${p.times_used || 0}${p.usage_limit ? '/' + p.usage_limit : ''}</td>
                                <td>
                                    ${p.highlighted
                                        ? `<span class="status-badge" style="background: var(--brand-pink); color: white;" title="${p.badge || 'SPECIAL'}: ${p.subtitle || ''}">Yes</span>`
                                        : '<span class="status-badge" style="background: var(--gray-light);">No</span>'
                                    }
                                </td>
                                <td><span class="status-badge status-${p.active ? 'confirmed' : 'cancelled'}">${p.active ? 'Active' : 'Inactive'}</span></td>
                                <td class="action-btns" style="display: flex; gap: 4px;">
                                    <button class="btn btn-sm" onclick="togglePromo('${p.id}', ${!p.active})">${p.active ? 'Disable' : 'Enable'}</button>
                                    <button class="btn btn-sm btn-outline" onclick="toggleHighlighted('${p.id}', ${!p.highlighted})" title="${p.highlighted ? 'Remove from' : 'Add to'} Special Offers">
                                        ${p.highlighted ? '⭐' : '☆'}
                                    </button>
                                    <button class="btn btn-sm btn-outline" onclick="editPromo('${p.id}')" title="Edit">✏️</button>
                                </td>
                            </tr>
                        `).join('');
                    } else {
                        container.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: var(--gray-medium);">No promotions found. Create your first promotion!</td></tr>';
                    }
                }
            } catch (error) {
                console.log('Promos load error:', error);
            }
        }

        // Setup toggle for Special Offer fields visibility
        document.addEventListener('DOMContentLoaded', () => {
            const highlightedCheckbox = document.getElementById('promoHighlighted');
            const specialOfferFields = document.getElementById('specialOfferFields');
            if (highlightedCheckbox && specialOfferFields) {
                highlightedCheckbox.addEventListener('change', () => {
                    specialOfferFields.style.display = highlightedCheckbox.checked ? 'block' : 'none';
                });
            }
        });

        function clearPromoForm() {
            const fields = ['promoCode', 'promoDescription', 'promoValue', 'promoMinOrder', 'promoUsageLimit', 'promoExpiresAt', 'promoTitle', 'promoBadge', 'promoSubtitle', 'promoPriority'];
            fields.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            const typeSelect = document.getElementById('promoType');
            if (typeSelect) typeSelect.value = 'percentage';
            const highlightedCheckbox = document.getElementById('promoHighlighted');
            if (highlightedCheckbox) highlightedCheckbox.checked = false;
            const specialOfferFields = document.getElementById('specialOfferFields');
            if (specialOfferFields) specialOfferFields.style.display = 'none';
        }

        async function savePromo() {
            const code = document.getElementById('promoCode')?.value?.trim();
            const discountType = document.getElementById('promoType')?.value;
            const discountValue = parseFloat(document.getElementById('promoValue')?.value);
            const description = document.getElementById('promoDescription')?.value?.trim() || '';
            const minOrder = parseFloat(document.getElementById('promoMinOrder')?.value) || 0;
            const usageLimit = parseInt(document.getElementById('promoUsageLimit')?.value) || null;
            const expiresAt = document.getElementById('promoExpiresAt')?.value ? new Date(document.getElementById('promoExpiresAt').value).toISOString() : null;

            // Special Offer fields
            const highlighted = document.getElementById('promoHighlighted')?.checked || false;
            const title = document.getElementById('promoTitle')?.value?.trim() || '';
            const badge = document.getElementById('promoBadge')?.value?.trim().toUpperCase() || '';
            const subtitle = document.getElementById('promoSubtitle')?.value?.trim() || '';
            const priority = parseInt(document.getElementById('promoPriority')?.value) || 0;

            // Shop Banner field
            const showInShopBanner = document.getElementById('promoShowInShopBanner')?.checked || false;

            if (!code || !discountType || !discountValue) {
                alert('Code, type, and value are required');
                return;
            }

            try {
                await apiCall('/admin/promos', {
                    method: 'POST',
                    body: JSON.stringify({
                        code, discountType, discountValue, description, minOrder, usageLimit, expiresAt,
                        highlighted, title, badge, subtitle, priority, showInShopBanner
                    })
                });
                alert('Promo created!');
                closeModal('addPromoModal');
                clearPromoForm();
                loadPromos();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function togglePromo(id, active) {
            try {
                await apiCall(`/admin/promos/${id}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ active })
                });
                loadPromos();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function toggleHighlighted(id, highlighted) {
            try {
                await apiCall(`/admin/promos/${id}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ highlighted })
                });
                loadPromos();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Placeholder for edit functionality - opens modal with promo data
        async function editPromo(id) {
            try {
                const data = await apiCall('/admin/promos');
                const promo = data.promos.find(p => p.id === id);
                if (!promo) {
                    alert('Promo not found');
                    return;
                }

                // Populate form
                document.getElementById('promoCode').value = promo.code;
                document.getElementById('promoDescription').value = promo.description || '';
                document.getElementById('promoType').value = promo.discountType;
                document.getElementById('promoValue').value = promo.discountValue;
                document.getElementById('promoMinOrder').value = promo.minOrder || '';
                document.getElementById('promoUsageLimit').value = promo.usageLimit || '';
                if (promo.expiresAt) {
                    const dt = new Date(promo.expiresAt);
                    document.getElementById('promoExpiresAt').value = dt.toISOString().slice(0, 16);
                }
                document.getElementById('promoHighlighted').checked = promo.highlighted || false;
                document.getElementById('promoTitle').value = promo.title || '';
                document.getElementById('promoBadge').value = promo.badge || '';
                document.getElementById('promoSubtitle').value = promo.subtitle || '';
                document.getElementById('promoPriority').value = promo.priority || '';
                document.getElementById('promoShowInShopBanner').checked = promo.show_in_shop_banner || false;

                // Show/hide special offer fields
                document.getElementById('specialOfferFields').style.display = promo.highlighted ? 'block' : 'none';

                // Change modal title and button
                document.querySelector('#addPromoModal .modal-title').textContent = 'Edit Promotion';
                const saveBtn = document.querySelector('#addPromoModal .btn-primary');
                saveBtn.textContent = 'Update Promotion';
                saveBtn.onclick = () => updatePromo(id);

                openModal('addPromoModal');
            } catch (error) {
                alert('Error loading promo: ' + error.message);
            }
        }

        async function updatePromo(id) {
            const discountType = document.getElementById('promoType')?.value;
            const discountValue = parseFloat(document.getElementById('promoValue')?.value);
            const description = document.getElementById('promoDescription')?.value?.trim() || '';
            const minOrder = parseFloat(document.getElementById('promoMinOrder')?.value) || 0;
            const usageLimit = parseInt(document.getElementById('promoUsageLimit')?.value) || null;
            const expiresAt = document.getElementById('promoExpiresAt')?.value ? new Date(document.getElementById('promoExpiresAt').value).toISOString() : null;

            // Special Offer fields
            const highlighted = document.getElementById('promoHighlighted')?.checked || false;
            const title = document.getElementById('promoTitle')?.value?.trim() || '';
            const badge = document.getElementById('promoBadge')?.value?.trim().toUpperCase() || '';
            const subtitle = document.getElementById('promoSubtitle')?.value?.trim() || '';
            const priority = parseInt(document.getElementById('promoPriority')?.value) || 0;

            // Shop Banner field
            const showInShopBanner = document.getElementById('promoShowInShopBanner')?.checked || false;

            try {
                await apiCall(`/admin/promos/${id}`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        discountType, discountValue, description, minOrder, usageLimit, expiresAt,
                        highlighted, title, badge, subtitle, priority, showInShopBanner
                    })
                });
                alert('Promo updated!');
                closeModal('addPromoModal');

                // Reset modal for create mode
                document.querySelector('#addPromoModal .modal-title').textContent = 'Create Promotion';
                const saveBtn = document.querySelector('#addPromoModal .btn-primary');
                saveBtn.textContent = 'Create Promotion';
                saveBtn.onclick = savePromo;
                clearPromoForm();

                loadPromos();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // ============================================
        // LOYALTY SETTINGS
        // ============================================
        let currentLoyaltyConfig = null;

        async function loadLoyaltySettings() {
            try {
                const data = await apiCall('/admin/loyalty');
                currentLoyaltyConfig = data;

                // Populate points rules
                document.getElementById('loyaltyBookingPoints').value = data.pointsRules.bookingPoints || 50;
                document.getElementById('loyaltySpendRand').value = data.pointsRules.spendRand || 10;
                document.getElementById('loyaltyReviewPoints').value = data.pointsRules.reviewPoints || 25;
                document.getElementById('loyaltyReferralPoints').value = data.pointsRules.referralPoints || 100;

                // Populate tier thresholds
                document.getElementById('loyaltyTierBronze').value = 0;
                document.getElementById('loyaltyTierSilver').value = data.tierThresholds.silver || 500;
                document.getElementById('loyaltyTierGold').value = data.tierThresholds.gold || 1500;
                document.getElementById('loyaltyTierPlatinum').value = data.tierThresholds.platinum || 5000;

                // Populate referral settings
                if (data.referral) {
                    document.getElementById('referralEnabled').checked = data.referral.enabled !== false;
                    document.getElementById('referralDiscountType').value = data.referral.discountType || 'percent';
                    document.getElementById('referralDiscountValue').value = data.referral.discountValue || 10;
                    document.getElementById('referralHeadline').value = data.referral.headline || '';
                    document.getElementById('referralSubheading').value = data.referral.subheading || '';
                    document.getElementById('referralShareMessage').value = data.referral.shareMessageTemplate || '';
                }

                // Populate earn rules editor
                renderEarnRulesEditor(data.earnRulesDisplay || [], data.pointsRules);

                // Update preview
                updateTierPreview();

                // Hide any previous messages
                document.getElementById('loyaltyErrors').style.display = 'none';
                document.getElementById('loyaltySuccess').style.display = 'none';

                // Add live preview listeners
                addLoyaltyPreviewListeners();

            } catch (error) {
                console.error('Error loading loyalty settings:', error);
                alert('Failed to load loyalty settings: ' + error.message);
            }
        }

        // Render the earn rules editor
        function renderEarnRulesEditor(rules, pointsRules) {
            const container = document.getElementById('earnRulesEditor');
            if (!container) return;

            const pointsKeys = Object.keys(pointsRules || {});

            container.innerHTML = rules.map((rule, index) => {
                const isSpend = rule.isSpendRule;
                const pointsValue = pointsRules[rule.pointsKey] || 0;
                const pointsDisplay = isSpend ? `+1 pt / R${pointsValue}` : `+${pointsValue} pts`;

                return `
                    <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 12px; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                        <div style="flex: 2;">
                            <input type="text" class="form-input earn-rule-label" data-index="${index}" value="${rule.label}" placeholder="Label">
                        </div>
                        <div style="flex: 1;">
                            <select class="form-input earn-rule-key" data-index="${index}">
                                ${pointsKeys.map(key => `<option value="${key}" ${key === rule.pointsKey ? 'selected' : ''}>${key}</option>`).join('')}
                            </select>
                        </div>
                        <div style="width: 100px; text-align: center;">
                            <span style="font-weight: 600; color: var(--primary);">${pointsDisplay}</span>
                        </div>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 12px;">
                            <input type="checkbox" class="earn-rule-spend" data-index="${index}" ${isSpend ? 'checked' : ''}>
                            Spend rule
                        </label>
                    </div>
                `;
            }).join('');
        }

        function addLoyaltyPreviewListeners() {
            const tierInputs = ['loyaltyTierSilver', 'loyaltyTierGold', 'loyaltyTierPlatinum'];
            tierInputs.forEach(id => {
                const input = document.getElementById(id);
                input.removeEventListener('input', updateTierPreview);
                input.addEventListener('input', updateTierPreview);
            });
        }

        function updateTierPreview() {
            const silver = parseInt(document.getElementById('loyaltyTierSilver').value) || 500;
            const gold = parseInt(document.getElementById('loyaltyTierGold').value) || 1500;
            const platinum = parseInt(document.getElementById('loyaltyTierPlatinum').value) || 5000;

            // Update preview values
            document.getElementById('previewBronzeMax').textContent = (silver - 1).toLocaleString();
            document.getElementById('previewSilverMin').textContent = silver.toLocaleString();
            document.getElementById('previewSilverMax').textContent = (gold - 1).toLocaleString();
            document.getElementById('previewGoldMin').textContent = gold.toLocaleString();
            document.getElementById('previewGoldMax').textContent = (platinum - 1).toLocaleString();
            document.getElementById('previewPlatinumMin').textContent = platinum.toLocaleString();
        }

        function validateLoyaltySettings() {
            const errors = [];

            const bookingPoints = parseInt(document.getElementById('loyaltyBookingPoints').value);
            const spendRand = parseInt(document.getElementById('loyaltySpendRand').value);
            const reviewPoints = parseInt(document.getElementById('loyaltyReviewPoints').value);
            const referralPoints = parseInt(document.getElementById('loyaltyReferralPoints').value);
            const silver = parseInt(document.getElementById('loyaltyTierSilver').value);
            const gold = parseInt(document.getElementById('loyaltyTierGold').value);
            const platinum = parseInt(document.getElementById('loyaltyTierPlatinum').value);

            // Validate points rules
            if (isNaN(bookingPoints) || bookingPoints < 0) {
                errors.push('Booking points must be a positive number');
            }
            if (isNaN(spendRand) || spendRand < 1) {
                errors.push('Rands per point must be at least R1');
            }
            if (isNaN(reviewPoints) || reviewPoints < 0) {
                errors.push('Review points must be a positive number');
            }
            if (isNaN(referralPoints) || referralPoints < 0) {
                errors.push('Referral points must be a positive number');
            }

            // Validate tier thresholds
            if (isNaN(silver) || silver < 1) {
                errors.push('Silver threshold must be at least 1');
            }
            if (isNaN(gold) || gold < 1) {
                errors.push('Gold threshold must be at least 1');
            }
            if (isNaN(platinum) || platinum < 1) {
                errors.push('Platinum threshold must be at least 1');
            }
            if (silver >= gold) {
                errors.push('Gold threshold must be greater than Silver');
            }
            if (gold >= platinum) {
                errors.push('Platinum threshold must be greater than Gold');
            }

            return errors;
        }

        async function saveLoyaltySettings() {
            // Hide previous messages
            document.getElementById('loyaltyErrors').style.display = 'none';
            document.getElementById('loyaltySuccess').style.display = 'none';

            // Validate
            const errors = validateLoyaltySettings();
            if (errors.length > 0) {
                const errorList = document.getElementById('loyaltyErrorList');
                errorList.innerHTML = errors.map(e => `<li>${e}</li>`).join('');
                document.getElementById('loyaltyErrors').style.display = 'block';
                return;
            }

            // Collect earn rules from editor
            const earnRulesDisplay = [];
            document.querySelectorAll('.earn-rule-label').forEach((input, index) => {
                const label = input.value.trim();
                const keySelect = document.querySelector(`.earn-rule-key[data-index="${index}"]`);
                const spendCheck = document.querySelector(`.earn-rule-spend[data-index="${index}"]`);

                if (label && keySelect) {
                    earnRulesDisplay.push({
                        id: currentLoyaltyConfig?.earnRulesDisplay?.[index]?.id || `rule_${index}`,
                        label: label,
                        pointsKey: keySelect.value,
                        isSpendRule: spendCheck?.checked || false
                    });
                }
            });

            // Build config object
            const config = {
                pointsRules: {
                    bookingPoints: parseInt(document.getElementById('loyaltyBookingPoints').value),
                    spendRand: parseInt(document.getElementById('loyaltySpendRand').value),
                    reviewPoints: parseInt(document.getElementById('loyaltyReviewPoints').value),
                    referralPoints: parseInt(document.getElementById('loyaltyReferralPoints').value),
                    socialSharePoints: currentLoyaltyConfig?.pointsRules?.socialSharePoints || 10
                },
                tierThresholds: {
                    bronze: 0,
                    silver: parseInt(document.getElementById('loyaltyTierSilver').value),
                    gold: parseInt(document.getElementById('loyaltyTierGold').value),
                    platinum: parseInt(document.getElementById('loyaltyTierPlatinum').value)
                },
                referral: {
                    enabled: document.getElementById('referralEnabled').checked,
                    discountType: document.getElementById('referralDiscountType').value,
                    discountValue: parseInt(document.getElementById('referralDiscountValue').value) || 10,
                    headline: document.getElementById('referralHeadline').value.trim(),
                    subheading: document.getElementById('referralSubheading').value.trim(),
                    shareMessageTemplate: document.getElementById('referralShareMessage').value.trim()
                },
                earnRulesDisplay: earnRulesDisplay
            };

            try {
                const result = await apiCall('/admin/loyalty', {
                    method: 'PUT',
                    body: JSON.stringify(config)
                });

                if (result.success) {
                    currentLoyaltyConfig = result;
                    document.getElementById('loyaltySuccess').style.display = 'block';

                    // Show warnings if any
                    if (result.warnings && result.warnings.length > 0) {
                        console.warn('Loyalty settings warnings:', result.warnings);
                    }

                    setTimeout(() => {
                        document.getElementById('loyaltySuccess').style.display = 'none';
                    }, 3000);
                } else {
                    throw new Error(result.message || 'Failed to save');
                }
            } catch (error) {
                const errorList = document.getElementById('loyaltyErrorList');
                if (error.errors && Array.isArray(error.errors)) {
                    errorList.innerHTML = error.errors.map(e => `<li>${e}</li>`).join('');
                } else {
                    errorList.innerHTML = `<li>${error.message || 'Failed to save settings'}</li>`;
                }
                document.getElementById('loyaltyErrors').style.display = 'block';
            }
        }

        async function resetLoyaltySettings() {
            const proceed = await openConfirmDialog({
                title: 'Reset loyalty settings?',
                message: 'This will revert to defaults and cannot be undone.',
                confirmText: 'Reset',
                tone: 'danger'
            });
            if (!proceed) return;

            try {
                const result = await apiCall('/admin/loyalty/reset', {
                    method: 'POST'
                });

                if (result.success) {
                    // Reload settings with new values
                    loadLoyaltySettings();
                    showAdminToast('Loyalty settings reset to defaults!', 'success');
                } else {
                    throw new Error(result.message || 'Failed to reset');
                }
            } catch (error) {
                showAdminToast('Failed to reset settings: ' + (error.message || ''), 'error');
            }
        }

        // ============================================
        // REWARDS PROGRAMME SETTINGS
        // ============================================
        let rewardsConfig = null;

        async function loadRewardsSettings() {
            try {
                const result = await apiCall('/admin/rewards/config');
                if (result.success && result.config) {
                    rewardsConfig = result.config;
                    populateRewardsForm(result.config);
                }
                // Load dynamic reward tracks
                await loadDynamicRewardTracks();
                // Also load analytics and service-reward mappings
                loadRewardsAnalytics();
                loadServiceRewardMappings();
            } catch (error) {
                console.error('Error loading rewards settings:', error);
                showRewardsError('Failed to load rewards settings: ' + error.message);
            }
        }

        async function loadDynamicRewardTracks() {
            const container = document.getElementById('dynamicRewardTracks');
            if (!container) return;

            try {
                const result = await apiCall('/admin/reward-track-definitions');
                rewardTrackDefinitions = result.tracks || [];

                if (rewardTrackDefinitions.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--gray-medium); background: var(--gray-light); border-radius: 8px;">' +
                        '<span style="font-size: 48px; display: block; margin-bottom: 15px;">🎁</span>' +
                        '<p style="margin-bottom: 15px;">No reward tracks configured yet.</p>' +
                        '<button class="btn btn-primary" onclick="showAddTrackModal()">Create Your First Track</button>' +
                    '</div>';
                    return;
                }

                container.innerHTML = rewardTrackDefinitions.map(function(track) {
                    var milestones = typeof track.milestones === 'string' ? JSON.parse(track.milestones) : (track.milestones || []);
                    var trackTypeLabel = track.track_type === 'visit_count' ? 'Visit-based' : 'Spend-based';
                    var trackTypeIcon = track.track_type === 'visit_count' ? '📊' : '💰';

                    var milestonesHtml = milestones.map(function(m, idx) {
                        if (track.track_type === 'visit_count') {
                            return '<div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--gray-light);">' +
                                '<span>Milestone ' + (idx + 1) + ': ' + (m.count || 0) + ' visits</span>' +
                                '<span style="font-weight: 600; color: var(--success);">' + (m.reward_value || 0) + '% discount' + (m.repeating ? ' (repeating)' : '') + '</span>' +
                            '</div>';
                        } else {
                            return '<div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--gray-light);">' +
                                '<span>Milestone ' + (idx + 1) + ': R' + (m.amount || 0).toLocaleString() + ' spent</span>' +
                                '<span style="font-weight: 600; color: var(--success);">' + (m.reward_value || 0) + '% discount' + (m.repeating ? ' (repeating)' : '') + '</span>' +
                            '</div>';
                        }
                    }).join('');

                    if (milestones.length === 0) {
                        milestonesHtml = '<p style="color: var(--gray-medium); font-style: italic;">No milestones configured</p>';
                    }

                    return '<div style="background: white; border: 1px solid var(--gray-light); border-radius: 12px; overflow: hidden;">' +
                        '<div style="display: flex; justify-content: space-between; align-items: center; padding: 20px; background: ' + (track.active ? 'linear-gradient(135deg, #fff5f8 0%, #ffe8ee 100%)' : 'var(--gray-light)') + ';">' +
                            '<div style="display: flex; align-items: center; gap: 15px;">' +
                                '<span style="font-size: 32px;">' + (track.icon || '🎁') + '</span>' +
                                '<div>' +
                                    '<h4 style="margin: 0; font-size: 18px;">' + track.display_name + '</h4>' +
                                    '<p style="margin: 5px 0 0; font-size: 13px; color: var(--gray-medium);">' + trackTypeIcon + ' ' + trackTypeLabel + ' • ' + (track.reward_expiry_days || 90) + ' days expiry</p>' +
                                '</div>' +
                            '</div>' +
                            '<div style="display: flex; align-items: center; gap: 10px;">' +
                                '<span style="padding: 4px 12px; border-radius: 20px; font-size: 12px; background: ' + (track.active ? 'var(--success)' : 'var(--gray-medium)') + '; color: white;">' + (track.active ? 'Active' : 'Inactive') + '</span>' +
                                '<button class="btn btn-outline btn-sm" onclick="editTrack(\'' + track.id + '\')">Edit</button>' +
                                '<button class="btn btn-danger btn-sm" onclick="deleteTrack(\'' + track.id + '\')">Delete</button>' +
                            '</div>' +
                        '</div>' +
                        '<div style="padding: 20px;">' +
                            '<p style="color: var(--gray-dark); margin-bottom: 15px;">' + (track.description || 'No description') + '</p>' +
                            '<h5 style="font-size: 14px; margin-bottom: 10px; color: var(--gray-medium);">MILESTONES</h5>' +
                            milestonesHtml +
                        '</div>' +
                    '</div>';
                }).join('');
            } catch (error) {
                console.error('Error loading dynamic reward tracks:', error);
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--danger);">' +
                    '<p>Failed to load reward tracks: ' + error.message + '</p>' +
                    '<button class="btn btn-outline" onclick="loadDynamicRewardTracks()" style="margin-top: 10px;">Retry</button>' +
                '</div>';
            }
        }

        function populateRewardsForm(config) {
            // Programme status
            document.getElementById('rewardsProgrammeEnabled').checked = config.programme_enabled == 1;
            document.getElementById('rewardsProgrammeName').value = config.programme_name || 'Salon Rewards';

            // Referral
            document.getElementById('rewardsReferralEnabled').checked = config.referral_enabled == 1;
            document.getElementById('rewardsReferralMinValue').value = config.referral_min_booking_value || 1000;
            document.getElementById('rewardsReferralDescription').value = config.referral_reward_description || 'Complimentary wash & blow-dry';

            // Packages
            document.getElementById('rewardsPackagesEnabled').checked = config.packages_enabled == 1;
            document.getElementById('rewardsPackageSessions').value = config.wash_blowdry_package_sessions || 4;
            document.getElementById('rewardsPackageDiscount').value = config.wash_blowdry_package_discount || 20;

            // Hide messages
            var errorsEl = document.getElementById('rewardsErrors');
            var successEl = document.getElementById('rewardsSuccess');
            if (errorsEl) errorsEl.style.display = 'none';
            if (successEl) successEl.style.display = 'none';
        }

        async function saveRewardsSettings() {
            try {
                // Build config from general programme settings only
                // Track-specific settings are now managed dynamically through reward_track_definitions table
                const config = {
                    programme_enabled: document.getElementById('rewardsProgrammeEnabled').checked ? 1 : 0,
                    programme_name: document.getElementById('rewardsProgrammeName').value,

                    // Referral settings
                    referral_enabled: document.getElementById('rewardsReferralEnabled').checked ? 1 : 0,
                    referral_min_booking_value: parseFloat(document.getElementById('rewardsReferralMinValue').value) || 1000,
                    referral_reward_description: document.getElementById('rewardsReferralDescription').value,

                    // Package settings
                    packages_enabled: document.getElementById('rewardsPackagesEnabled').checked ? 1 : 0,
                    wash_blowdry_package_sessions: parseInt(document.getElementById('rewardsPackageSessions').value) || 4,
                    wash_blowdry_package_discount: parseFloat(document.getElementById('rewardsPackageDiscount').value) || 20
                };

                const result = await apiCall('/admin/rewards/config', {
                    method: 'PUT',
                    body: JSON.stringify(config)
                });

                if (result.success) {
                    rewardsConfig = result.config;
                    showRewardsSuccess();
                    showAdminToast('Rewards settings saved successfully', 'success');
                } else {
                    showRewardsError(result.message || 'Failed to save settings');
                }
            } catch (error) {
                console.error('Error saving rewards settings:', error);
                showRewardsError('Failed to save settings: ' + error.message);
            }
        }

        async function loadRewardsAnalytics() {
            try {
                const result = await apiCall('/admin/rewards/analytics');
                if (result.success) {
                    document.getElementById('rewardsStatTotal').textContent = result.stats?.total_rewards || 0;
                    document.getElementById('rewardsStatActive').textContent = result.stats?.active_rewards || 0;
                    document.getElementById('rewardsStatRedeemed').textContent = result.stats?.redeemed_rewards || 0;
                    document.getElementById('rewardsStatUsers').textContent = result.stats?.users_with_rewards || 0;
                }
            } catch (error) {
                console.error('Error loading rewards analytics:', error);
            }
        }

        function showRewardsError(message) {
            const errorDiv = document.getElementById('rewardsErrors');
            document.getElementById('rewardsErrorMessage').textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('rewardsSuccess').style.display = 'none';
        }

        function showRewardsSuccess() {
            document.getElementById('rewardsSuccess').style.display = 'block';
            document.getElementById('rewardsErrors').style.display = 'none';
            setTimeout(() => {
                document.getElementById('rewardsSuccess').style.display = 'none';
            }, 3000);
        }

        // ============================================
        // SERVICE-TO-REWARD TRACK MAPPINGS
        // ============================================
        let rewardTrackDefinitions = [];
        let categoryMappings = [];
        let serviceMappings = [];
        let allServices = [];
        let availableCategories = [];

        async function loadServiceRewardMappings() {
            try {
                // Load all data in parallel
                const [tracksRes, catMappingsRes, serviceMappingsRes, servicesRes] = await Promise.all([
                    apiCall('/admin/reward-track-definitions'),
                    apiCall('/admin/category-reward-mappings'),
                    apiCall('/admin/service-reward-mappings'),
                    apiCall('/admin/services')
                ]);

                if (tracksRes.success) {
                    rewardTrackDefinitions = tracksRes.tracks || [];
                    renderRewardTrackDefinitions();
                    populateTrackDropdowns();
                }

                if (catMappingsRes.success) {
                    categoryMappings = catMappingsRes.mappings || [];
                    availableCategories = catMappingsRes.availableCategories || [];
                    renderCategoryMappings();
                    populateCategoryDropdown();
                }

                if (serviceMappingsRes.success) {
                    serviceMappings = serviceMappingsRes.mappings || [];
                    renderServiceMappings();
                }

                if (servicesRes.success) {
                    allServices = servicesRes.services || [];
                    populateServiceDropdown();
                }
            } catch (error) {
                console.error('Error loading service-reward mappings:', error);
                showAdminToast('Failed to load reward mappings: ' + error.message, 'error');
            }
        }

        function renderRewardTrackDefinitions() {
            const container = document.getElementById('rewardTrackDefinitions');
            if (!rewardTrackDefinitions.length) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--gray-medium);">No reward tracks defined. Add one to get started.</div>';
                return;
            }

            container.innerHTML = rewardTrackDefinitions.map(track => {
                const milestones = typeof track.milestones === 'string' ? JSON.parse(track.milestones) : (track.milestones || []);
                const milestonesText = milestones.map(m => {
                    if (m.count) return m.count + ' visits = ' + m.reward_value + '%';
                    if (m.amount) return 'R' + m.amount + ' = ' + m.reward_value + '%';
                    return '';
                }).filter(Boolean).join(', ');

                return '<div style="display: flex; align-items: center; gap: 15px; padding: 15px; background: var(--gray-light); border-radius: 8px;">' +
                    '<span style="font-size: 24px;">' + (track.icon || '🎁') + '</span>' +
                    '<div style="flex: 1;">' +
                        '<div style="font-weight: 600;">' + track.display_name + '</div>' +
                        '<div style="font-size: 12px; color: var(--gray-medium);">' +
                            (track.track_type === 'visit_count' ? 'Visit-based' : 'Spend-based') + ' • ' +
                            (milestonesText || 'No milestones') + ' • ' +
                            'Expires in ' + (track.reward_expiry_days || 90) + ' days' +
                        '</div>' +
                    '</div>' +
                    '<div style="display: flex; gap: 5px;">' +
                        '<button class="btn btn-sm btn-outline" onclick="editTrack(\'' + track.id + '\')" title="Edit">Edit</button>' +
                        '<button class="btn btn-sm btn-danger" onclick="deleteTrack(\'' + track.id + '\')" title="Delete">×</button>' +
                    '</div>' +
                '</div>';
            }).join('');
        }

        function renderCategoryMappings() {
            const container = document.getElementById('categoryRewardMappings');
            if (!categoryMappings.length) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--gray-medium); width: 100%;">No category mappings. Add a mapping to link service categories to reward tracks.</div>';
                return;
            }

            container.innerHTML = categoryMappings.map(mapping =>
                '<div style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 12px; background: var(--primary-light); border-radius: 20px; font-size: 13px;">' +
                    '<span style="font-weight: 500;">' + mapping.category_name + '</span>' +
                    '<span style="color: var(--gray-medium);">→</span>' +
                    '<span>' + mapping.track_name + '</span>' +
                    '<button onclick="deleteCategoryMapping(\'' + mapping.id + '\')" style="background: none; border: none; color: var(--danger); cursor: pointer; padding: 0 4px;" title="Remove">×</button>' +
                '</div>'
            ).join('');
        }

        function renderServiceMappings() {
            const container = document.getElementById('serviceRewardMappings');
            if (!serviceMappings.length) {
                container.innerHTML = '<div style="text-align: center; padding: 15px; color: var(--gray-medium);">No individual service mappings. Services will use category mappings.</div>';
                return;
            }

            let html = '<table style="width: 100%; font-size: 13px;">' +
                '<thead>' +
                    '<tr style="text-align: left; color: var(--gray-medium);">' +
                        '<th style="padding: 8px;">Service</th>' +
                        '<th style="padding: 8px;">Track</th>' +
                        '<th style="padding: 8px;">Multiplier</th>' +
                        '<th style="padding: 8px;"></th>' +
                    '</tr>' +
                '</thead>' +
                '<tbody>';

            serviceMappings.forEach(m => {
                html += '<tr style="border-top: 1px solid var(--gray-light);">' +
                    '<td style="padding: 8px;">' + (m.service_name || m.service_id) + '</td>' +
                    '<td style="padding: 8px;">' + (m.track_name || m.track_id) + '</td>' +
                    '<td style="padding: 8px;">' + (m.points_multiplier || 1.0) + 'x</td>' +
                    '<td style="padding: 8px;">' +
                        '<button onclick="deleteServiceMapping(\'' + m.id + '\')" class="btn btn-sm btn-danger">×</button>' +
                    '</td>' +
                '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function populateTrackDropdowns() {
            let options = '';
            rewardTrackDefinitions.forEach(t => {
                options += '<option value="' + t.id + '">' + t.display_name + '</option>';
            });
            document.getElementById('newCategoryMappingTrack').innerHTML = '<option value="">Select Track</option>' + options;
            document.getElementById('newServiceMappingTrack').innerHTML = '<option value="">Select Track</option>' + options;
        }

        function populateCategoryDropdown() {
            let options = '';
            availableCategories.forEach(c => {
                options += '<option value="' + c + '">' + c + '</option>';
            });
            document.getElementById('newCategoryMappingCategory').innerHTML = '<option value="">Select Category</option>' + options;
        }

        function populateServiceDropdown() {
            let options = '';
            allServices.forEach(s => {
                options += '<option value="' + s.id + '">' + s.name + ' (' + (s.category || 'No category') + ')</option>';
            });
            document.getElementById('newServiceMappingService').innerHTML = '<option value="">Select Service</option>' + options;
        }

        async function addCategoryMapping() {
            const categoryName = document.getElementById('newCategoryMappingCategory').value;
            const trackId = document.getElementById('newCategoryMappingTrack').value;

            if (!categoryName || !trackId) {
                showAdminToast('Please select both a category and a track', 'error');
                return;
            }

            try {
                const result = await apiCall('/admin/category-reward-mappings', {
                    method: 'POST',
                    body: JSON.stringify({ category_name: categoryName, track_id: trackId })
                });

                if (result.success) {
                    showAdminToast('Category mapping added', 'success');
                    loadServiceRewardMappings();
                } else {
                    showAdminToast(result.message || 'Failed to add mapping', 'error');
                }
            } catch (error) {
                showAdminToast('Error adding mapping: ' + error.message, 'error');
            }
        }

        async function deleteCategoryMapping(id) {
            if (!confirm('Remove this category mapping?')) return;

            try {
                const result = await apiCall('/admin/category-reward-mappings/' + id, { method: 'DELETE' });
                if (result.success) {
                    showAdminToast('Category mapping removed', 'success');
                    loadServiceRewardMappings();
                }
            } catch (error) {
                showAdminToast('Error removing mapping: ' + error.message, 'error');
            }
        }

        async function addServiceMapping() {
            const serviceId = document.getElementById('newServiceMappingService').value;
            const trackId = document.getElementById('newServiceMappingTrack').value;

            if (!serviceId || !trackId) {
                showAdminToast('Please select both a service and a track', 'error');
                return;
            }

            try {
                const result = await apiCall('/admin/service-reward-mappings', {
                    method: 'POST',
                    body: JSON.stringify({ service_id: serviceId, track_id: trackId })
                });

                if (result.success) {
                    showAdminToast('Service mapping added', 'success');
                    loadServiceRewardMappings();
                } else {
                    showAdminToast(result.message || 'Failed to add mapping', 'error');
                }
            } catch (error) {
                showAdminToast('Error adding mapping: ' + error.message, 'error');
            }
        }

        async function deleteServiceMapping(id) {
            if (!confirm('Remove this service mapping?')) return;

            try {
                const result = await apiCall('/admin/service-reward-mappings/' + id, { method: 'DELETE' });
                if (result.success) {
                    showAdminToast('Service mapping removed', 'success');
                    loadServiceRewardMappings();
                }
            } catch (error) {
                showAdminToast('Error removing mapping: ' + error.message, 'error');
            }
        }

        async function deleteTrack(id) {
            if (!confirm('Delete this reward track? This will also remove all its mappings.')) return;

            try {
                const result = await apiCall('/admin/reward-track-definitions/' + id, { method: 'DELETE' });
                if (result.success) {
                    showAdminToast('Track deleted', 'success');
                    // Refresh both the main tracks display and the mappings section
                    loadDynamicRewardTracks();
                    loadServiceRewardMappings();
                } else {
                    showAdminToast(result.message || 'Failed to delete track', 'error');
                }
            } catch (error) {
                showAdminToast('Error deleting track: ' + error.message, 'error');
            }
        }

        function editTrack(id) {
            const track = rewardTrackDefinitions.find(t => t.id === id);
            if (!track) return;
            showAddTrackModal(track);
        }

        // Track modal milestones temporary storage
        let trackModalMilestones = [];

        function showAddTrackModal(track) {
            const isEdit = !!track;
            trackModalMilestones = track && typeof track.milestones === 'string' ? JSON.parse(track.milestones) : (track ? track.milestones : []) || [];
            if (!Array.isArray(trackModalMilestones)) trackModalMilestones = [];

            var trackType = track ? track.track_type : 'visit_count';
            var modalHtml = '<div id="trackModal" style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;">' +
                '<div style="background: white; border-radius: 12px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;">' +
                    '<div style="padding: 20px; border-bottom: 1px solid var(--gray-light);">' +
                        '<h3 style="margin: 0;">' + (isEdit ? 'Edit' : 'Add') + ' Reward Track</h3>' +
                    '</div>' +
                    '<div style="padding: 20px;">' +
                        '<div class="form-group" style="margin-bottom: 15px;">' +
                            '<label class="form-label">Track Name (unique identifier)</label>' +
                            '<input type="text" id="trackName" class="form-input" placeholder="e.g., nails, maintenance" value="' + (track ? track.name : '') + '"' + (isEdit ? ' disabled style="background: var(--gray-light);"' : '') + '>' +
                            (isEdit ? '<p style="font-size: 11px; color: var(--gray-medium); margin-top: 5px;">Name cannot be changed after creation</p>' : '') +
                        '</div>' +
                        '<div class="form-group" style="margin-bottom: 15px;">' +
                            '<label class="form-label">Display Name</label>' +
                            '<input type="text" id="trackDisplayName" class="form-input" placeholder="e.g., Nails Rewards" value="' + (track ? track.display_name : '') + '">' +
                        '</div>' +
                        '<div class="form-group" style="margin-bottom: 15px;">' +
                            '<label class="form-label">Description</label>' +
                            '<input type="text" id="trackDescription" class="form-input" placeholder="Brief description" value="' + (track ? (track.description || '') : '') + '">' +
                        '</div>' +
                        '<div class="form-row" style="display: flex; gap: 15px; margin-bottom: 15px;">' +
                            '<div class="form-group" style="flex: 1;">' +
                                '<label class="form-label">Track Type</label>' +
                                '<select id="trackType" class="form-input" onchange="updateMilestoneLabels()">' +
                                    '<option value="visit_count"' + (trackType === 'visit_count' ? ' selected' : '') + '>Visit Count</option>' +
                                    '<option value="spend_amount"' + (trackType === 'spend_amount' ? ' selected' : '') + '>Spend Amount</option>' +
                                '</select>' +
                            '</div>' +
                            '<div class="form-group" style="flex: 1;">' +
                                '<label class="form-label">Icon</label>' +
                                '<input type="text" id="trackIcon" class="form-input" placeholder="Emoji" value="' + (track ? (track.icon || '🎁') : '🎁') + '" style="width: 80px;">' +
                            '</div>' +
                            '<div class="form-group" style="flex: 1;">' +
                                '<label class="form-label">Expiry (days)</label>' +
                                '<input type="number" id="trackExpiryDays" class="form-input" value="' + (track ? (track.reward_expiry_days || 90) : 90) + '" min="1">' +
                            '</div>' +
                        '</div>' +
                        '<div class="form-group" style="margin-bottom: 15px;">' +
                            '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">' +
                                '<label class="form-label" style="margin: 0;">Milestones</label>' +
                                '<button type="button" class="btn btn-outline btn-sm" onclick="addMilestoneRow()">+ Add Milestone</button>' +
                            '</div>' +
                            '<div id="milestonesContainer" style="background: var(--gray-light); border-radius: 8px; padding: 15px;">' +
                                renderMilestonesEditor(trackModalMilestones, trackType) +
                            '</div>' +
                        '</div>' +
                        '<div class="form-group" style="margin-bottom: 15px;">' +
                            '<label class="form-label">Active Status</label>' +
                            '<label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">' +
                                '<input type="checkbox" id="trackActive"' + (track ? (track.active ? ' checked' : '') : ' checked') + '>' +
                                '<span>Track is active and available for customer progress</span>' +
                            '</label>' +
                        '</div>' +
                    '</div>' +
                    '<div style="padding: 15px 20px; border-top: 1px solid var(--gray-light); display: flex; justify-content: flex-end; gap: 10px;">' +
                        '<button class="btn btn-outline" onclick="document.getElementById(\'trackModal\').remove()">Cancel</button>' +
                        '<button class="btn btn-primary" onclick="saveTrack(\'' + (track ? track.id : '') + '\')">' + (isEdit ? 'Save Changes' : 'Create Track') + '</button>' +
                    '</div>' +
                '</div>' +
            '</div>';

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function renderMilestonesEditor(milestones, trackType) {
            if (!milestones || milestones.length === 0) {
                return '<p style="text-align: center; color: var(--gray-medium); padding: 20px; margin: 0;">No milestones yet. Add one to get started.</p>';
            }

            var isVisit = trackType === 'visit_count';
            var thresholdLabel = isVisit ? 'Visits' : 'Spend (R)';

            return milestones.map(function(m, idx) {
                var threshold = isVisit ? (m.count || 0) : (m.amount || 0);
                return '<div class="milestone-row" style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px; background: white; padding: 12px; border-radius: 8px;" data-index="' + idx + '">' +
                    '<div style="flex: 1;">' +
                        '<label style="font-size: 11px; color: var(--gray-medium);">' + thresholdLabel + '</label>' +
                        '<input type="number" class="form-input milestone-threshold" value="' + threshold + '" min="1" style="margin-top: 4px;" onchange="updateMilestoneData(' + idx + ')">' +
                    '</div>' +
                    '<div style="flex: 1;">' +
                        '<label style="font-size: 11px; color: var(--gray-medium);">Discount %</label>' +
                        '<input type="number" class="form-input milestone-discount" value="' + (m.reward_value || 0) + '" min="1" max="100" style="margin-top: 4px;" onchange="updateMilestoneData(' + idx + ')">' +
                    '</div>' +
                    '<div style="display: flex; align-items: center; gap: 8px; padding-top: 18px;">' +
                        '<label style="display: flex; align-items: center; gap: 4px; font-size: 12px; cursor: pointer;" title="Milestone repeats after being earned">' +
                            '<input type="checkbox" class="milestone-repeating"' + (m.repeating ? ' checked' : '') + ' onchange="updateMilestoneData(' + idx + ')">' +
                            '<span>Repeat</span>' +
                        '</label>' +
                        '<button type="button" class="btn btn-sm" style="background: var(--danger); color: white; padding: 4px 8px;" onclick="removeMilestoneRow(' + idx + ')">×</button>' +
                    '</div>' +
                '</div>';
            }).join('');
        }

        function updateMilestoneLabels() {
            var trackType = document.getElementById('trackType').value;
            var container = document.getElementById('milestonesContainer');
            if (container) {
                container.innerHTML = renderMilestonesEditor(trackModalMilestones, trackType);
            }
        }

        function addMilestoneRow() {
            var trackType = document.getElementById('trackType').value;
            var isVisit = trackType === 'visit_count';
            var newMilestone = isVisit
                ? { count: 6, reward_value: 10, reward_type: 'percentage_discount', repeating: false }
                : { amount: 5000, reward_value: 10, reward_type: 'percentage_discount', repeating: false };

            trackModalMilestones.push(newMilestone);
            updateMilestoneLabels();
        }

        function removeMilestoneRow(index) {
            trackModalMilestones.splice(index, 1);
            updateMilestoneLabels();
        }

        function updateMilestoneData(index) {
            var rows = document.querySelectorAll('.milestone-row');
            if (rows[index]) {
                var row = rows[index];
                var threshold = parseInt(row.querySelector('.milestone-threshold').value) || 0;
                var discount = parseInt(row.querySelector('.milestone-discount').value) || 0;
                var repeating = row.querySelector('.milestone-repeating').checked;
                var trackType = document.getElementById('trackType').value;

                if (trackType === 'visit_count') {
                    trackModalMilestones[index] = {
                        count: threshold,
                        reward_value: discount,
                        reward_type: 'percentage_discount',
                        repeating: repeating
                    };
                } else {
                    trackModalMilestones[index] = {
                        amount: threshold,
                        reward_value: discount,
                        reward_type: 'percentage_discount',
                        repeating: repeating
                    };
                }
            }
        }

        async function saveTrack(existingId) {
            const name = document.getElementById('trackName').value.trim();
            const displayName = document.getElementById('trackDisplayName').value.trim();
            const description = document.getElementById('trackDescription').value.trim();
            const trackType = document.getElementById('trackType').value;
            const icon = document.getElementById('trackIcon').value.trim();
            const expiryDays = parseInt(document.getElementById('trackExpiryDays').value) || 90;
            const active = document.getElementById('trackActive').checked ? 1 : 0;

            // Use the milestone editor data instead of JSON textarea
            const milestones = trackModalMilestones;

            if (!name || !displayName || !trackType) {
                showAdminToast('Please fill in name, display name, and track type', 'error');
                return;
            }

            if (milestones.length === 0) {
                showAdminToast('Please add at least one milestone', 'error');
                return;
            }

            const data = {
                name: name,
                display_name: displayName,
                description: description,
                track_type: trackType,
                icon: icon || '🎁',
                reward_expiry_days: expiryDays,
                milestones: milestones,
                active: active
            };

            try {
                const url = existingId ? '/admin/reward-track-definitions/' + existingId : '/admin/reward-track-definitions';
                const method = existingId ? 'PUT' : 'POST';

                const result = await apiCall(url, { method: method, body: JSON.stringify(data) });

                if (result.success) {
                    document.getElementById('trackModal').remove();
                    showAdminToast(existingId ? 'Track updated' : 'Track created', 'success');
                    // Refresh both the main tracks display and the mappings section
                    loadDynamicRewardTracks();
                    loadServiceRewardMappings();
                } else {
                    showAdminToast(result.message || 'Failed to save track', 'error');
                }
            } catch (error) {
                showAdminToast('Error saving track: ' + error.message, 'error');
            }
        }

        // ============================================
        // HAIR TRACKER SETTINGS
        // ============================================
        let hairTrackerSettings = null;

        async function loadHairTrackerSettings() {
            try {
                const result = await apiCall('/admin/hair-tracker');

                if (result.success) {
                    hairTrackerSettings = result;

                    // Populate interval fields
                    document.getElementById('trackerDefaultMaintenance').value = result.defaultMaintenanceIntervalDays || 42;
                    document.getElementById('trackerWashFrequency').value = result.washFrequencyDays || 3;
                    document.getElementById('trackerDeepConditionFrequency').value = result.deepConditionFrequencyDays || 14;

                    // Populate health score fields
                    document.getElementById('trackerHealthBase').value = result.healthScore?.base || 100;
                    document.getElementById('trackerPenaltyMaintenance').value = result.healthScore?.penalties?.overMaintenanceByDay || 0.5;
                    document.getElementById('trackerPenaltyDeepCondition').value = result.healthScore?.penalties?.noDeepConditionOverDays || 0.3;
                    document.getElementById('trackerPenaltyWashes').value = result.healthScore?.penalties?.tooManyWashesPerWeek || 1.0;

                    // Populate copy fields
                    const copy = result.copy || {};
                    document.getElementById('trackerCopyTitle').value = copy.trackerTitle || '';
                    document.getElementById('trackerCopySubtitle').value = copy.trackerSubtitle || '';
                    document.getElementById('trackerCopyWash').value = copy.nextWashLabel || '';
                    document.getElementById('trackerCopyMaintenance').value = copy.maintenanceLabel || '';
                    document.getElementById('trackerCopyDeepCondition').value = copy.deepConditionLabel || '';
                    document.getElementById('trackerCopyNoInstall').value = copy.noInstallMessage || '';
                    document.getElementById('trackerCopySetupBtn').value = copy.setupButtonText || '';

                    // Render extension types editor
                    renderExtensionTypesEditor(result.extensionTypes || []);

                    // Render tips editor
                    renderTrackerTipsEditor(result.tips || []);
                }
            } catch (error) {
                console.error('Failed to load hair tracker settings:', error);
            }
        }

        function renderExtensionTypesEditor(extensionTypes) {
            const container = document.getElementById('extensionTypesEditor');
            if (!container) return;

            container.innerHTML = extensionTypes.map((et, index) => `
                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;" data-ext-index="${index}">
                    <input type="text" class="form-input ext-id" value="${et.id || ''}" placeholder="ID (e.g. tapes)" style="flex: 1;">
                    <input type="text" class="form-input ext-label" value="${et.label || ''}" placeholder="Label (e.g. Tape Extensions)" style="flex: 2;">
                    <input type="number" class="form-input ext-days" value="${et.maintenanceDays || 0}" placeholder="Days" min="0" style="width: 100px;">
                    <button class="btn btn-outline" onclick="removeExtensionType(${index})" style="padding: 8px 12px;">×</button>
                </div>
            `).join('');

            // Add button to add new extension type
            container.innerHTML += `
                <button class="btn btn-outline" onclick="addExtensionType()" style="margin-top: 10px;">
                    + Add Extension Type
                </button>
            `;
        }

        function addExtensionType() {
            const currentTypes = collectExtensionTypes();
            currentTypes.push({ id: '', label: '', maintenanceDays: 42 });
            renderExtensionTypesEditor(currentTypes);
        }

        function removeExtensionType(index) {
            const currentTypes = collectExtensionTypes();
            currentTypes.splice(index, 1);
            renderExtensionTypesEditor(currentTypes);
        }

        function collectExtensionTypes() {
            const container = document.getElementById('extensionTypesEditor');
            const rows = container.querySelectorAll('[data-ext-index]');
            return Array.from(rows).map(row => ({
                id: row.querySelector('.ext-id').value.trim(),
                label: row.querySelector('.ext-label').value.trim(),
                maintenanceDays: parseInt(row.querySelector('.ext-days').value) || 0
            })).filter(et => et.id && et.label);
        }

        function renderTrackerTipsEditor(tips) {
            const container = document.getElementById('trackerTipsEditor');
            if (!container) return;

            container.innerHTML = tips.map((tip, index) => `
                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;" data-tip-index="${index}">
                    <input type="text" class="form-input tip-text" value="${tip}" placeholder="Enter care tip..." style="flex: 1;">
                    <button class="btn btn-outline" onclick="removeTrackerTip(${index})" style="padding: 8px 12px;">×</button>
                </div>
            `).join('');
        }

        function addTrackerTip() {
            const currentTips = collectTrackerTips();
            currentTips.push('');
            renderTrackerTipsEditor(currentTips);
        }

        function removeTrackerTip(index) {
            const currentTips = collectTrackerTips();
            currentTips.splice(index, 1);
            renderTrackerTipsEditor(currentTips);
        }

        function collectTrackerTips() {
            const container = document.getElementById('trackerTipsEditor');
            const rows = container.querySelectorAll('[data-tip-index]');
            return Array.from(rows)
                .map(row => row.querySelector('.tip-text').value.trim())
                .filter(tip => tip);
        }

        async function saveHairTrackerSettings() {
            // Hide previous messages
            document.getElementById('trackerSettingsError').style.display = 'none';
            document.getElementById('trackerSettingsSuccess').style.display = 'none';

            try {
                const settings = {
                    defaultMaintenanceIntervalDays: parseInt(document.getElementById('trackerDefaultMaintenance').value) || 42,
                    washFrequencyDays: parseInt(document.getElementById('trackerWashFrequency').value) || 3,
                    deepConditionFrequencyDays: parseInt(document.getElementById('trackerDeepConditionFrequency').value) || 14,
                    extensionTypes: collectExtensionTypes(),
                    healthScore: {
                        base: parseInt(document.getElementById('trackerHealthBase').value) || 100,
                        penalties: {
                            overMaintenanceByDay: parseFloat(document.getElementById('trackerPenaltyMaintenance').value) || 0.5,
                            noDeepConditionOverDays: parseFloat(document.getElementById('trackerPenaltyDeepCondition').value) || 0.3,
                            tooManyWashesPerWeek: parseFloat(document.getElementById('trackerPenaltyWashes').value) || 1.0
                        }
                    },
                    copy: {
                        trackerTitle: document.getElementById('trackerCopyTitle').value.trim() || 'Hair Care Journey',
                        trackerSubtitle: document.getElementById('trackerCopySubtitle').value.trim() || 'Keep your extensions healthy and on track',
                        nextWashLabel: document.getElementById('trackerCopyWash').value.trim() || 'Next Wash Day',
                        maintenanceLabel: document.getElementById('trackerCopyMaintenance').value.trim() || 'Maintenance Due',
                        deepConditionLabel: document.getElementById('trackerCopyDeepCondition').value.trim() || 'Deep Condition',
                        noInstallMessage: document.getElementById('trackerCopyNoInstall').value.trim() || 'Set up your hair tracker to get personalized care recommendations!',
                        setupButtonText: document.getElementById('trackerCopySetupBtn').value.trim() || 'Set Up Tracker'
                    },
                    tips: collectTrackerTips()
                };

                const result = await apiCall('/admin/hair-tracker', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });

                if (result.success) {
                    document.getElementById('trackerSettingsSuccess').style.display = 'block';
                    setTimeout(() => {
                        document.getElementById('trackerSettingsSuccess').style.display = 'none';
                    }, 3000);
                } else {
                    throw new Error(result.message || 'Failed to save settings');
                }
            } catch (error) {
                document.getElementById('trackerSettingsErrorText').textContent = error.message || 'Failed to save settings';
                document.getElementById('trackerSettingsError').style.display = 'block';
            }
        }

        async function resetHairTrackerSettings() {
            const proceed = await openConfirmDialog({
                title: 'Reset hair tracker?',
                message: 'This will revert to defaults and cannot be undone.',
                confirmText: 'Reset',
                tone: 'danger'
            });
            if (!proceed) return;

            try {
                const result = await apiCall('/admin/hair-tracker/reset', {
                    method: 'POST'
                });

                if (result.success) {
                    loadHairTrackerSettings();
                    showAdminToast('Hair tracker settings reset to defaults!', 'success');
                } else {
                    throw new Error(result.message || 'Failed to reset');
                }
            } catch (error) {
                showAdminToast('Failed to reset settings: ' + (error.message || ''), 'error');
            }
        }

        // ============================================
        // MODALS
        // ============================================
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('show');
                modal.style.display = 'flex';  // Override inline style
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('show');
                modal.style.display = 'none';  // Reset inline style
            }
        }

        // Click-outside-to-close disabled for admin modals to prevent accidental data loss
        // Users should use the X button or Cancel button to close modals
        // document.querySelectorAll('.modal-overlay').forEach(overlay => {
        //     overlay.addEventListener('click', function(e) {
        //         if (e.target === this) {
        //             this.classList.remove('show');
        //             this.style.display = 'none';
        //         }
        //     });
        // });

        // Reusable confirm dialog
        let confirmResolver = null;
        function openConfirmDialog({ title = 'Please confirm', message = '', confirmText = 'Confirm', cancelText = 'Cancel', tone = 'neutral' } = {}) {
            return new Promise(resolve => {
                confirmResolver = resolve;
                document.getElementById('confirmTitle').textContent = title;
                document.getElementById('confirmMessage').textContent = message;
                document.getElementById('confirmConfirmBtn').textContent = confirmText;
                document.getElementById('confirmCancelBtn').textContent = cancelText;
                const confirmBtn = document.getElementById('confirmConfirmBtn');
                if (tone === 'danger') {
                    confirmBtn.style.background = 'var(--danger)';
                } else {
                    confirmBtn.style.background = '';
                }
                document.getElementById('confirmModal').classList.add('show');
            });
        }

        function resolveConfirm(choice) {
            document.getElementById('confirmModal').classList.remove('show');
            if (confirmResolver) {
                confirmResolver(choice);
                confirmResolver = null;
            }
        }

        // Quantity input dialog
        let quantityResolver = null;
        function openQuantityInput(productName) {
            return new Promise(resolve => {
                quantityResolver = resolve;
                document.getElementById('quantityProductName').textContent = productName;
                document.getElementById('quantityInputValue').value = '1';
                const modal = document.getElementById('quantityInputModal');
                modal.style.display = 'flex';
                modal.classList.add('show');
                setTimeout(() => document.getElementById('quantityInputValue').focus(), 100);
            });
        }

        function resolveQuantityInput(value) {
            const modal = document.getElementById('quantityInputModal');
            modal.classList.remove('show');
            modal.style.display = 'none';
            if (quantityResolver) {
                if (value && !isNaN(value) && parseFloat(value) > 0) {
                    quantityResolver(parseFloat(value));
                } else {
                    quantityResolver(null);
                }
                quantityResolver = null;
            }
        }

        // Product type selection dialog
        let productTypeResolver = null;
        function openProductTypeDialog() {
            return new Promise(resolve => {
                productTypeResolver = resolve;
                const modal = document.getElementById('productTypeModal');
                modal.style.display = 'flex';
                modal.classList.add('show');
            });
        }

        function resolveProductType(type) {
            const modal = document.getElementById('productTypeModal');
            modal.classList.remove('show');
            modal.style.display = 'none';
            if (productTypeResolver) {
                productTypeResolver(type);
                productTypeResolver = null;
            }
        }

        // Custom amount input dialog (for service products)
        let customAmountResolver = null;
        function openCustomAmountInput(productName) {
            return new Promise(resolve => {
                customAmountResolver = resolve;
                document.getElementById('customAmountProductName').textContent = productName;
                document.getElementById('customAmountValue').value = '';
                const modal = document.getElementById('customAmountModal');
                modal.style.display = 'flex';
                modal.classList.add('show');
                setTimeout(() => document.getElementById('customAmountValue').focus(), 100);
            });
        }

        function resolveCustomAmount(value) {
            const modal = document.getElementById('customAmountModal');
            modal.classList.remove('show');
            modal.style.display = 'none';
            if (customAmountResolver) {
                if (value && !isNaN(value) && parseFloat(value) >= 0) {
                    customAmountResolver(parseFloat(value));
                } else {
                    customAmountResolver(null);
                }
                customAmountResolver = null;
            }
        }

        // Simple admin toast
        function showAdminToast(message, tone = 'info') {
            const container = document.getElementById('adminToastContainer');
            if (!container) return;
            const toast = document.createElement('div');
            toast.className = `admin-toast ${tone === 'error' ? 'error' : tone === 'success' ? 'success' : ''}`;
            toast.innerHTML = `
                <span>${message}</span>
                <button class="toast-close" aria-label="Close" onclick="this.closest('.admin-toast').remove()">×</button>
            `;
            container.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('fade-out');
                setTimeout(() => toast.remove(), 300);
            }, 3500);
        }

        // State for editing staff/products
        let editingTeamMemberId = null;
        let editingProductId = null;
        let teamListCache = [];
        let productListCache = [];

        async function editTeamMember(id) {
            editingTeamMemberId = id;
            // Find team member in cached list or fetch
            let member = teamListCache.find(s => s.id === id);
            if (!member) {
                try {
                    const data = await apiCall('/admin/team');
                    teamListCache = data.team || [];
                    member = teamListCache.find(s => s.id === id);
                } catch (error) {
                    alert('Error loading team member: ' + error.message);
                    return;
                }
            }

            if (!member) {
                alert('Team member not found');
                return;
            }

            // Prefill form fields
            document.getElementById('staffName').value = member.name || '';
            document.getElementById('staffRole').value = member.specialty || 'Stylist';
            document.getElementById('staffTagline').value = member.tagline || '';
            document.getElementById('staffExperience').value = member.yearsExperience || '';
            document.getElementById('staffInstagram').value = member.instagram || '';
            const imageUrl = member.imageUrl || member.image_url;
            if (imageUrl) {
                const preview = document.getElementById('staffPhotoPreview');
                preview.src = imageUrl;
                preview.dataset.imageUrl = imageUrl;
                preview.style.display = 'block';
            }

            // Update modal title and button
            document.querySelector('#addStaffModal .modal-title').textContent = 'Edit Team Member';
            document.getElementById('staffSaveBtn').textContent = 'Save Changes';

            openModal('addStaffModal');
        }

        async function archiveTeamMember(id) {
            const proceed = await openConfirmDialog({
                title: 'Archive team member?',
                message: 'They will be marked inactive.',
                confirmText: 'Archive'
            });
            if (!proceed) return;
            try {
                await apiCall(`/admin/team/${id}/archive`, { method: 'PATCH' });
                teamListCache = [];
                loadTeam();
                showAdminToast('Team member archived', 'success');
            } catch (error) {
                showAdminToast('Error archiving team member: ' + (error.message || ''), 'error');
            }
        }

        async function deleteTeamMember(id) {
            const proceed = await openConfirmDialog({
                title: 'Delete team member?',
                message: 'This cannot be undone.',
                confirmText: 'Delete',
                tone: 'danger'
            });
            if (!proceed) return;
            try {
                await apiCall(`/admin/team/${id}`, { method: 'DELETE' });
                teamListCache = [];
                loadTeam();
                showAdminToast('Team member deleted', 'success');
            } catch (error) {
                showAdminToast('Error deleting team member: ' + (error.message || ''), 'error');
            }
        }

        // ===== STAFF SERVICES MANAGEMENT FUNCTIONS =====
        let currentStaffIdForServices = null;
        let allAvailableServices = [];
        let staffCurrentServices = [];
        let currentServicesTab = 'categories';

        // Tab switching
        function switchServicesTab(tabName) {
            currentServicesTab = tabName;
            // Update tab buttons
            document.querySelectorAll('.staff-services-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add('active');
            // Update panels
            document.querySelectorAll('.staff-services-panel').forEach(panel => panel.style.display = 'none');
            document.getElementById('panel' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).style.display = 'block';
        }

        // Open staff services management modal
        async function openStaffServicesModal(staffId) {
            if (!staffId) {
                showAdminToast('Please save the staff member first', 'error');
                return;
            }

            currentStaffIdForServices = staffId;
            document.getElementById('staffServicesModal').style.display = 'flex';

            // Reset to categories tab
            switchServicesTab('categories');

            // Load all available services and staff's current services
            await Promise.all([
                loadAllAvailableServices(),
                loadStaffServices(staffId)
            ]);

            renderAllServiceViews();
        }

        function closeStaffServicesModal() {
            document.getElementById('staffServicesModal').style.display = 'none';
            currentStaffIdForServices = null;
        }

        // Render all views
        function renderAllServiceViews() {
            renderCategoriesView();
            renderAvailableServices();
            renderStaffServices();
            updateAssignedBadge();
        }

        // Update badge count
        function updateAssignedBadge() {
            document.getElementById('assignedCountBadge').textContent = staffCurrentServices.length;
        }

        // Load all available services
        async function loadAllAvailableServices() {
            try {
                const data = await apiCall('/admin/services');
                allAvailableServices = data.services || [];

                // Populate category filter
                const categoryCount = {};
                allAvailableServices.forEach(s => {
                    categoryCount[s.category] = (categoryCount[s.category] || 0) + 1;
                });
                const categories = Object.keys(categoryCount).sort();
                const filterSelect = document.getElementById('serviceCategoryFilter');
                filterSelect.innerHTML = '<option value="">All Categories (' + allAvailableServices.length + ')</option>' +
                    categories.map(cat => `<option value="${cat}">${cat} (${categoryCount[cat]})</option>`).join('');

                document.getElementById('serviceSearchFilter').value = '';
            } catch (error) {
                console.error('Error loading services:', error);
                allAvailableServices = [];
            }
        }

        // Load staff's current services
        async function loadStaffServices(staffId) {
            try {
                const data = await apiCall(`/admin/team/${staffId}/services`);
                staffCurrentServices = data.services || [];
            } catch (error) {
                console.error('Error loading staff services:', error);
                staffCurrentServices = [];
            }
        }

        // Render categories view with cards
        function renderCategoriesView() {
            const container = document.getElementById('categoriesList');
            const staffServiceIds = new Set(staffCurrentServices.map(s => s.service_id));

            // Group services by category
            const categoryMap = {};
            allAvailableServices.forEach(s => {
                if (!categoryMap[s.category]) {
                    categoryMap[s.category] = { total: 0, assigned: 0, services: [] };
                }
                categoryMap[s.category].total++;
                categoryMap[s.category].services.push(s);
                if (staffServiceIds.has(s.id)) {
                    categoryMap[s.category].assigned++;
                }
            });

            const categories = Object.keys(categoryMap).sort();

            if (categories.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-subtle);">No services available</div>';
                return;
            }

            container.innerHTML = categories.map(cat => {
                const data = categoryMap[cat];
                const percentage = Math.round((data.assigned / data.total) * 100);
                const cardClass = data.assigned === data.total ? 'full' : data.assigned > 0 ? 'partial' : '';
                const statusText = data.assigned === data.total ? '✓ All assigned' :
                                   data.assigned > 0 ? `${data.assigned} of ${data.total} assigned` :
                                   `${data.total} services`;

                return `
                    <div class="category-card ${cardClass}">
                        <div class="category-card-header">
                            <div class="category-card-title">${cat}</div>
                            <div class="category-card-count">${statusText}</div>
                        </div>
                        <div class="category-card-progress">
                            <div class="category-card-progress-fill" style="width: ${percentage}%"></div>
                        </div>
                        <div class="category-card-actions">
                            ${data.assigned < data.total ?
                                `<button class="btn btn-primary" onclick="addCategoryToStaff('${cat.replace(/'/g, "\\'")}')">
                                    Add All (${data.total - data.assigned})
                                </button>` :
                                `<button class="btn btn-outline" disabled style="flex: 1;">All Added</button>`
                            }
                            ${data.assigned > 0 ?
                                `<button class="btn btn-outline" onclick="removeCategoryFromStaff('${cat.replace(/'/g, "\\'")}')" style="color: var(--danger);">
                                    Remove
                                </button>` : ''
                            }
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Add entire category to staff
        async function addCategoryToStaff(category) {
            // Refresh staff services first to ensure we have current data
            await loadStaffServices(currentStaffIdForServices);

            const staffServiceIds = new Set(staffCurrentServices.map(s => s.service_id));
            const servicesToAdd = allAvailableServices.filter(s =>
                s.category === category && !staffServiceIds.has(s.id)
            );

            if (servicesToAdd.length === 0) {
                showAdminToast('All services in this category already added', 'info');
                renderAllServiceViews();
                return;
            }

            showAdminToast(`Adding ${servicesToAdd.length} services...`, 'info');

            try {
                // Try batch add first (more efficient)
                try {
                    const serviceIds = servicesToAdd.map(s => s.id);
                    await apiCall(`/admin/team/${currentStaffIdForServices}/services/batch`, {
                        method: 'POST',
                        body: JSON.stringify({ serviceIds })
                    });
                    showAdminToast(`Added ${servicesToAdd.length} services from ${category}`, 'success');
                } catch (batchError) {
                    // Batch endpoint doesn't exist, fall back to individual adds
                    let added = 0;
                    let skipped = 0;
                    for (const service of servicesToAdd) {
                        try {
                            await apiCall(`/admin/team/${currentStaffIdForServices}/services`, {
                                method: 'POST',
                                body: JSON.stringify({ serviceId: service.id })
                            });
                            added++;
                        } catch (e) {
                            // Silently skip already-added services
                            if (e.message && e.message.includes('already added')) {
                                skipped++;
                            } else {
                                console.error('Failed to add service:', service.name, e);
                            }
                        }
                    }
                    if (added > 0) {
                        showAdminToast(`Added ${added} services from ${category}`, 'success');
                    } else if (skipped > 0) {
                        showAdminToast('All services were already added', 'info');
                    }
                }

                await loadStaffServices(currentStaffIdForServices);
                renderAllServiceViews();
            } catch (error) {
                console.error('Error adding category:', error);
                showAdminToast('Failed to add category services', 'error');
            }
        }

        // Remove entire category from staff
        async function removeCategoryFromStaff(category) {
            const servicesToRemove = staffCurrentServices.filter(s => s.category === category);

            if (servicesToRemove.length === 0) {
                return;
            }

            const proceed = await openConfirmDialog({
                title: `Remove ${category}?`,
                message: `This will remove all ${servicesToRemove.length} services in this category from this staff member.`,
                confirmText: 'Remove All',
                tone: 'danger'
            });

            if (!proceed) return;

            try {
                const serviceIds = servicesToRemove.map(s => s.service_id);

                // Try batch remove first
                try {
                    await apiCall(`/admin/team/${currentStaffIdForServices}/services/batch`, {
                        method: 'DELETE',
                        body: JSON.stringify({ serviceIds })
                    });
                    showAdminToast(`Removed ${servicesToRemove.length} services from ${category}`, 'success');
                } catch (batchError) {
                    // Fall back to individual removes
                    let removed = 0;
                    for (const service of servicesToRemove) {
                        try {
                            await apiCall(`/admin/team/${currentStaffIdForServices}/services/${service.service_id}`, {
                                method: 'DELETE'
                            });
                            removed++;
                        } catch (e) {
                            console.error('Failed to remove service:', service.service_name, e);
                        }
                    }
                    showAdminToast(`Removed ${removed} services from ${category}`, 'success');
                }

                await loadStaffServices(currentStaffIdForServices);
                renderAllServiceViews();
            } catch (error) {
                console.error('Error removing category:', error);
                showAdminToast('Failed to remove category services', 'error');
            }
        }

        // Remove all services from staff
        async function removeAllStaffServices() {
            if (staffCurrentServices.length === 0) {
                showAdminToast('No services to remove', 'info');
                return;
            }

            const proceed = await openConfirmDialog({
                title: 'Remove All Services?',
                message: `This will remove all ${staffCurrentServices.length} services from this staff member. This cannot be undone.`,
                confirmText: 'Remove All',
                tone: 'danger'
            });

            if (!proceed) return;

            try {
                const serviceIds = staffCurrentServices.map(s => s.service_id);

                // Use batch endpoint
                try {
                    await apiCall(`/admin/team/${currentStaffIdForServices}/services/batch`, {
                        method: 'DELETE',
                        body: JSON.stringify({ serviceIds })
                    });
                    showAdminToast(`Removed ${staffCurrentServices.length} services`, 'success');
                } catch (batchError) {
                    // Fall back to individual removes
                    let removed = 0;
                    for (const service of staffCurrentServices) {
                        try {
                            await apiCall(`/admin/team/${currentStaffIdForServices}/services/${service.service_id}`, {
                                method: 'DELETE'
                            });
                            removed++;
                        } catch (e) {
                            console.error('Failed to remove service:', e);
                        }
                    }
                    showAdminToast(`Removed ${removed} services`, 'success');
                }

                await loadStaffServices(currentStaffIdForServices);
                renderAllServiceViews();
            } catch (error) {
                console.error('Error removing all services:', error);
                showAdminToast('Failed to remove services', 'error');
            }
        }

        // Filter available services
        function filterAvailableServices(clearSearch = false) {
            if (clearSearch) {
                document.getElementById('serviceSearchFilter').value = '';
            }
            renderAvailableServices();
        }

        // Render available services list (individual tab)
        function renderAvailableServices() {
            const searchTerm = document.getElementById('serviceSearchFilter').value.toLowerCase();
            const categoryFilter = document.getElementById('serviceCategoryFilter').value;

            const staffServiceIds = new Set(staffCurrentServices.map(s => s.service_id));
            let filtered = allAvailableServices.filter(s => !staffServiceIds.has(s.id));

            if (searchTerm) {
                filtered = filtered.filter(s =>
                    s.name.toLowerCase().includes(searchTerm) ||
                    (s.category && s.category.toLowerCase().includes(searchTerm))
                );
            }

            if (categoryFilter) {
                filtered = filtered.filter(s => s.category === categoryFilter);
            }

            const container = document.getElementById('availableServicesList');

            if (filtered.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-subtle);">No services available</div>';
                return;
            }

            container.innerHTML = filtered.map(service => `
                <div class="service-item">
                    <div class="service-item-info">
                        <div class="service-item-name">${service.name}</div>
                        <div class="service-item-meta">${service.category} • R${service.price} • ${service.duration || '–'}min</div>
                    </div>
                    <button class="btn btn-sm btn-primary" onclick="addServiceToStaff('${service.id}')">Add</button>
                </div>
            `).join('');
        }

        // Render staff's services (assigned tab) - grouped by category
        function renderStaffServices() {
            const container = document.getElementById('staffServicesList');

            if (staffCurrentServices.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: var(--text-subtle);">
                        <div style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;">📋</div>
                        <p style="margin: 0;">No services assigned yet</p>
                        <p style="margin: 10px 0 0 0; font-size: 13px;">Use the "Add by Category" tab to quickly assign services</p>
                    </div>
                `;
                return;
            }

            // Group by category
            const categoryMap = {};
            staffCurrentServices.forEach(ss => {
                if (!categoryMap[ss.category]) {
                    categoryMap[ss.category] = [];
                }
                categoryMap[ss.category].push(ss);
            });

            const categories = Object.keys(categoryMap).sort();

            container.innerHTML = categories.map(cat => `
                <div class="assigned-category-group">
                    <div class="assigned-category-header">
                        <span class="assigned-category-title">${cat} (${categoryMap[cat].length})</span>
                        <button class="btn btn-sm btn-outline" onclick="removeCategoryFromStaff('${cat.replace(/'/g, "\\'")}')"
                                style="color: var(--danger); padding: 4px 10px; font-size: 12px;">
                            Remove All
                        </button>
                    </div>
                    <div class="assigned-services-list">
                        ${categoryMap[cat].map(ss => `
                            <div class="service-item">
                                <div class="service-item-info">
                                    <div class="service-item-name">${ss.service_name}</div>
                                    <div class="service-item-meta">
                                        R${ss.custom_price || ss.default_price} • ${ss.custom_duration || ss.default_duration || '–'}min
                                        ${ss.custom_price || ss.custom_duration ? ' <span style="color: var(--primary);">(custom)</span>' : ''}
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-outline" onclick="removeServiceFromStaff('${ss.service_id}')"
                                        style="color: var(--danger);">Remove</button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        // Add service to staff
        async function addServiceToStaff(serviceId) {
            try {
                await apiCall(`/admin/team/${currentStaffIdForServices}/services`, {
                    method: 'POST',
                    body: JSON.stringify({ serviceId })
                });

                showAdminToast('Service added', 'success');
                await loadStaffServices(currentStaffIdForServices);
                renderAllServiceViews();
            } catch (error) {
                console.error('Error adding service:', error);
                showAdminToast(error.message || 'Failed to add service', 'error');
            }
        }

        // Remove service from staff
        async function removeServiceFromStaff(serviceId) {
            try {
                await apiCall(`/admin/team/${currentStaffIdForServices}/services/${serviceId}`, {
                    method: 'DELETE'
                });

                showAdminToast('Service removed', 'success');
                await loadStaffServices(currentStaffIdForServices);
                renderAllServiceViews();
            } catch (error) {
                console.error('Error removing service:', error);
                showAdminToast(error.message || 'Failed to remove service', 'error');
            }
        }

        // Update staff service custom price
        async function updateStaffServicePrice(serviceId, price) {
            try {
                const customPrice = price ? parseFloat(price) : null;
                await apiCall(`/admin/team/${currentStaffIdForServices}/services/${serviceId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ customPrice })
                });

                showAdminToast('Price updated', 'success');
                await loadStaffServices(currentStaffIdForServices);
            } catch (error) {
                console.error('Error updating price:', error);
                showAdminToast('Failed to update price', 'error');
            }
        }

        // Update staff service custom duration
        async function updateStaffServiceDuration(serviceId, duration) {
            try {
                const customDuration = duration ? parseInt(duration) : null;
                await apiCall(`/admin/team/${currentStaffIdForServices}/services/${serviceId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ customDuration })
                });

                showAdminToast('Duration updated', 'success');
                await loadStaffServices(currentStaffIdForServices);
            } catch (error) {
                console.error('Error updating duration:', error);
                showAdminToast('Failed to update duration', 'error');
            }
        }

        // ===== SERVICE MANAGEMENT FUNCTIONS =====
        // allServices is already declared in the reward mappings section
        let editingServiceId = null;

        async function loadServices() {
            try {
                const data = await apiCall('/admin/services');
                allServices = data.services || [];

                // Populate service type filter
                const typeFilter = document.getElementById('serviceTypeFilter');
                const types = [...new Set(allServices.map(s => s.service_type))];
                typeFilter.innerHTML = '<option value="">All Types</option>' +
                    types.map(type => `<option value="${type}">${type.charAt(0).toUpperCase() + type.slice(1)}</option>`).join('');

                renderServicesTable();
            } catch (error) {
                console.error('Error loading services:', error);
                showAdminToast('Error loading services', 'error');
            }
        }

        function filterServices() {
            const searchTerm = document.getElementById('serviceSearchInput').value.toLowerCase();
            const typeFilter = document.getElementById('serviceTypeFilter').value;
            const activeFilter = document.getElementById('serviceActiveFilter').value;
            const bookableFilter = document.getElementById('serviceBookableFilter').value;

            let filtered = allServices;

            if (searchTerm) {
                filtered = filtered.filter(s =>
                    s.name.toLowerCase().includes(searchTerm) ||
                    (s.description && s.description.toLowerCase().includes(searchTerm)) ||
                    (s.category && s.category.toLowerCase().includes(searchTerm))
                );
            }

            if (typeFilter) {
                filtered = filtered.filter(s => s.service_type === typeFilter);
            }

            if (activeFilter !== '') {
                filtered = filtered.filter(s => s.active === parseInt(activeFilter));
            }

            if (bookableFilter !== '') {
                const bookableValue = parseInt(bookableFilter);
                filtered = filtered.filter(s => (s.bookable === bookableValue) || (bookableValue === 1 && s.bookable === undefined));
            }

            renderServicesTable(filtered);
        }

        function renderServicesTable(services = allServices) {
            const tbody = document.getElementById('servicesTableBody');

            if (services.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: var(--text-subtle);">No services found</td></tr>';
                return;
            }

            tbody.innerHTML = services.map(service => `
                <tr>
                    <td>
                        ${service.image_url
                            ? `<img src="${service.image_url}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;" alt="${service.name}">`
                            : '<div style="width: 50px; height: 50px; background: var(--gray-light); border-radius: 4px; display: flex; align-items: center; justify-content: center; color: var(--text-subtle);">No image</div>'
                        }
                    </td>
                    <td><strong>${service.name}</strong></td>
                    <td><span class="badge" style="background: var(--primary-light); color: var(--primary); padding: 4px 8px; border-radius: 4px; font-size: 12px;">${service.service_type}</span></td>
                    <td>${service.category || '-'}</td>
                    <td><strong>R${service.price.toFixed(2)}</strong></td>
                    <td>${service.duration ? service.duration + ' min' : '-'}</td>
                    <td>
                        <span class="status-badge status-${service.active ? 'confirmed' : 'cancelled'}">
                            ${service.active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td>
                        <span class="status-badge status-${service.bookable === 1 || service.bookable === undefined ? 'confirmed' : 'pending'}" style="font-size: 11px;">
                            ${service.bookable === 1 || service.bookable === undefined ? 'Yes' : 'Invoice Only'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm" onclick="editService('${service.id}')">Edit</button>
                        <button class="btn btn-sm btn-outline" onclick="toggleServiceActive('${service.id}')" style="margin-left: 6px;">
                            ${service.active ? 'Deactivate' : 'Activate'}
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="deleteService('${service.id}')" style="margin-left: 6px; color: var(--danger);">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        // Service types and categories data
        let serviceTypes = [];
        let serviceCategories = [];
        let pendingImageFile = null;

        // Load service types and categories
        async function loadServiceTypesAndCategories() {
            try {
                const [typesRes, categoriesRes] = await Promise.all([
                    apiCall('/admin/service-types'),
                    apiCall('/admin/service-categories')
                ]);
                if (typesRes.success) serviceTypes = typesRes.types || [];
                if (categoriesRes.success) serviceCategories = categoriesRes.categories || [];
            } catch (error) {
                console.error('Error loading service types/categories:', error);
            }
        }

        // Populate service type dropdown
        function populateServiceTypeDropdown(selectedValue = '') {
            const select = document.getElementById('serviceType');
            select.innerHTML = '<option value="">Select a type...</option>';
            serviceTypes.filter(t => t.active === 1).forEach(type => {
                const option = document.createElement('option');
                option.value = type.name;
                option.textContent = type.name.charAt(0).toUpperCase() + type.name.slice(1);
                if (type.name === selectedValue) option.selected = true;
                select.appendChild(option);
            });
        }

        // Populate category dropdown based on selected type
        function populateCategoryDropdown(serviceTypeName, selectedValue = '') {
            const select = document.getElementById('serviceCategory');
            select.innerHTML = '<option value="">Select a category...</option>';

            if (!serviceTypeName) return;

            const type = serviceTypes.find(t => t.name === serviceTypeName);
            if (!type) return;

            const filtered = serviceCategories.filter(c => c.service_type_id === type.id && c.active === 1);
            filtered.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.name;
                option.textContent = cat.name;
                if (cat.name === selectedValue) option.selected = true;
                select.appendChild(option);
            });
        }

        // Handle service type change
        function onServiceTypeChange() {
            const selectedType = document.getElementById('serviceType').value;
            populateCategoryDropdown(selectedType);
        }

        async function openServiceModal() {
            editingServiceId = null;
            pendingImageFile = null;
            document.getElementById('serviceModalTitle').textContent = 'Add New Service';
            document.getElementById('serviceForm').reset();
            document.getElementById('serviceId').value = '';
            document.getElementById('serviceDisplayOrder').value = '0';
            document.getElementById('serviceCommissionRate').value = '';
            document.getElementById('serviceActive').checked = true;
            document.getElementById('serviceBookable').checked = true;
            document.getElementById('serviceImagePreview').style.display = 'none';
            document.getElementById('serviceImageBtnText').textContent = 'Choose Image';
            document.getElementById('serviceImageFile').value = '';

            // Load and populate dropdowns
            await loadServiceTypesAndCategories();
            populateServiceTypeDropdown();
            populateCategoryDropdown('');

            document.getElementById('serviceModal').style.display = 'flex';
        }

        function closeServiceModal() {
            document.getElementById('serviceModal').style.display = 'none';
            document.getElementById('serviceImagePreview').style.display = 'none';
            pendingImageFile = null;
            editingServiceId = null;
        }

        // Handle file selection for service image
        function onServiceImageFileSelect() {
            const fileInput = document.getElementById('serviceImageFile');
            const file = fileInput.files[0];

            if (!file) return;

            // Validate file size (5MB max)
            if (file.size > 5 * 1024 * 1024) {
                showAdminToast('Image file is too large. Maximum size is 5MB.', 'error');
                fileInput.value = '';
                return;
            }

            // Store the file for upload after save
            pendingImageFile = file;
            document.getElementById('serviceImageBtnText').textContent = file.name.substring(0, 20) + (file.name.length > 20 ? '...' : '');

            // Clear URL input
            document.getElementById('serviceImageUrl').value = '';

            // Show preview using FileReader
            const reader = new FileReader();
            reader.onload = (e) => {
                const preview = document.getElementById('serviceImagePreview');
                const img = document.getElementById('serviceImagePreviewImg');
                const error = document.getElementById('serviceImagePreviewError');

                preview.style.display = 'block';
                img.style.display = 'block';
                img.src = e.target.result;
                error.style.display = 'none';
            };
            reader.readAsDataURL(file);
        }

        // Clear service image
        function clearServiceImage() {
            pendingImageFile = null;
            document.getElementById('serviceImageFile').value = '';
            document.getElementById('serviceImageUrl').value = '';
            document.getElementById('serviceImagePreview').style.display = 'none';
            document.getElementById('serviceImageBtnText').textContent = 'Choose Image';
        }

        // Update image preview when URL changes
        function updateServiceImagePreview() {
            const url = document.getElementById('serviceImageUrl').value.trim();
            const preview = document.getElementById('serviceImagePreview');
            const img = document.getElementById('serviceImagePreviewImg');
            const error = document.getElementById('serviceImagePreviewError');

            if (!url) {
                preview.style.display = 'none';
                return;
            }

            // Clear file input when URL is entered
            pendingImageFile = null;
            document.getElementById('serviceImageFile').value = '';
            document.getElementById('serviceImageBtnText').textContent = 'Choose Image';

            // Show preview container
            preview.style.display = 'block';
            error.style.display = 'none';

            // Test if image loads
            img.onload = () => {
                img.style.display = 'block';
                error.style.display = 'none';
            };
            img.onerror = () => {
                img.style.display = 'none';
                error.style.display = 'block';
            };
            img.src = url;
        }

        async function editService(id) {
            const service = allServices.find(s => s.id === id);
            if (!service) return;

            editingServiceId = id;
            pendingImageFile = null;

            // Load and populate dropdowns first
            await loadServiceTypesAndCategories();
            populateServiceTypeDropdown(service.service_type);
            populateCategoryDropdown(service.service_type, service.category || '');

            document.getElementById('serviceModalTitle').textContent = 'Edit Service';
            document.getElementById('serviceId').value = service.id;
            document.getElementById('serviceName').value = service.name;
            document.getElementById('serviceDescription').value = service.description || '';
            document.getElementById('servicePrice').value = service.price;
            document.getElementById('serviceDuration').value = service.duration || '';
            document.getElementById('serviceImageUrl').value = service.image_url || '';
            document.getElementById('serviceDisplayOrder').value = service.display_order || 0;
            document.getElementById('serviceCommissionRate').value = service.commission_rate !== null && service.commission_rate !== undefined
                ? (service.commission_rate * 100).toFixed(0)
                : '';
            document.getElementById('serviceActive').checked = service.active === 1;
            document.getElementById('serviceBookable').checked = service.bookable === 1 || service.bookable === undefined;
            document.getElementById('serviceImageBtnText').textContent = 'Choose Image';
            document.getElementById('serviceImageFile').value = '';

            // Update image preview
            updateServiceImagePreview();

            document.getElementById('serviceModal').style.display = 'flex';
        }

        async function saveService(event) {
            event.preventDefault();

            const commissionRateInput = document.getElementById('serviceCommissionRate').value.trim();
            const commissionRate = commissionRateInput !== '' ? parseFloat(commissionRateInput) / 100 : null;

            const serviceData = {
                name: document.getElementById('serviceName').value.trim(),
                description: document.getElementById('serviceDescription').value.trim() || null,
                service_type: document.getElementById('serviceType').value.trim(),
                category: document.getElementById('serviceCategory').value.trim() || null,
                price: parseFloat(document.getElementById('servicePrice').value),
                duration: parseInt(document.getElementById('serviceDuration').value) || null,
                image_url: pendingImageFile ? null : (document.getElementById('serviceImageUrl').value.trim() || null),
                display_order: parseInt(document.getElementById('serviceDisplayOrder').value) || 0,
                commission_rate: commissionRate,
                active: document.getElementById('serviceActive').checked ? 1 : 0,
                bookable: document.getElementById('serviceBookable').checked ? 1 : 0
            };

            try {
                let serviceId = editingServiceId;

                if (editingServiceId) {
                    await apiCall(`/admin/services/${editingServiceId}`, {
                        method: 'PUT',
                        body: JSON.stringify(serviceData)
                    });
                } else {
                    const result = await apiCall('/admin/services', {
                        method: 'POST',
                        body: JSON.stringify(serviceData)
                    });
                    serviceId = result.service?.id;
                }

                // Upload image if file was selected
                if (pendingImageFile && serviceId) {
                    const formData = new FormData();
                    formData.append('image', pendingImageFile);

                    const token = localStorage.getItem('adminToken');
                    const response = await fetch(`${API_BASE}/admin/services/${serviceId}/image`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: formData
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Failed to upload image');
                    }
                }

                showAdminToast(editingServiceId ? 'Service updated successfully' : 'Service created successfully', 'success');
                closeServiceModal();
                loadServices();
            } catch (error) {
                console.error('Error saving service:', error);
                showAdminToast(error.message || 'Error saving service', 'error');
            }
        }

        // ============================================
        // SERVICE TYPES & CATEGORIES MANAGEMENT MODALS
        // ============================================

        function showManageTypesModal() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'manageTypesModal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3 class="modal-title">Manage Service Types</h3>
                        <button class="modal-close" onclick="closeManageTypesModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 20px;">
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="newTypeName" class="form-input" placeholder="New type name" style="flex: 1;">
                                <button class="btn btn-primary" onclick="addServiceType()">Add</button>
                            </div>
                        </div>
                        <div id="serviceTypesList" style="max-height: 300px; overflow-y: auto;">
                            <p style="color: var(--text-subtle);">Loading...</p>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            loadServiceTypesList();
        }

        function closeManageTypesModal() {
            const modal = document.getElementById('manageTypesModal');
            if (modal) modal.remove();
        }

        async function loadServiceTypesList() {
            try {
                const result = await apiCall('/admin/service-types');
                const container = document.getElementById('serviceTypesList');

                if (!result.success || !result.types || result.types.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-subtle);">No service types found.</p>';
                    return;
                }

                container.innerHTML = result.types.map(type => `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid var(--border-color);">
                        <div>
                            <strong>${type.name}</strong>
                            ${type.active === 0 ? '<span style="color: var(--danger); font-size: 12px; margin-left: 8px;">(Inactive)</span>' : ''}
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button class="btn btn-sm btn-outline" onclick="toggleServiceType('${type.id}', ${type.active})">${type.active === 1 ? 'Disable' : 'Enable'}</button>
                            <button class="btn btn-sm btn-outline" onclick="deleteServiceType('${type.id}')" style="color: var(--danger);">Delete</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading service types:', error);
                document.getElementById('serviceTypesList').innerHTML = '<p style="color: var(--danger);">Error loading types.</p>';
            }
        }

        async function addServiceType() {
            const name = document.getElementById('newTypeName').value.trim();
            if (!name) {
                showAdminToast('Please enter a type name', 'error');
                return;
            }

            try {
                await apiCall('/admin/service-types', {
                    method: 'POST',
                    body: JSON.stringify({ name })
                });
                document.getElementById('newTypeName').value = '';
                showAdminToast('Service type added', 'success');
                loadServiceTypesList();
                await loadServiceTypesAndCategories();
                populateServiceTypeDropdown();
            } catch (error) {
                showAdminToast(error.message || 'Error adding type', 'error');
            }
        }

        async function toggleServiceType(id, currentActive) {
            try {
                await apiCall(`/admin/service-types/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify({ active: currentActive === 1 ? 0 : 1 })
                });
                loadServiceTypesList();
                await loadServiceTypesAndCategories();
                populateServiceTypeDropdown();
            } catch (error) {
                showAdminToast(error.message || 'Error updating type', 'error');
            }
        }

        async function deleteServiceType(id) {
            if (!confirm('Are you sure you want to delete this service type?')) return;

            try {
                await apiCall(`/admin/service-types/${id}`, { method: 'DELETE' });
                showAdminToast('Service type deleted', 'success');
                loadServiceTypesList();
                await loadServiceTypesAndCategories();
                populateServiceTypeDropdown();
            } catch (error) {
                showAdminToast(error.message || 'Error deleting type', 'error');
            }
        }

        function showManageCategoriesModal() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'manageCategoriesModal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal" style="max-width: 700px;">
                    <div class="modal-header">
                        <h3 class="modal-title">Manage Service Categories</h3>
                        <button class="modal-close" onclick="closeManageCategoriesModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 20px;">
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <select id="newCategoryType" class="form-input" style="flex: 1; min-width: 150px;">
                                    <option value="">Select type...</option>
                                    ${serviceTypes.filter(t => t.active === 1).map(t => `<option value="${t.id}">${t.name}</option>`).join('')}
                                </select>
                                <input type="text" id="newCategoryName" class="form-input" placeholder="New category name" style="flex: 2; min-width: 150px;">
                                <button class="btn btn-primary" onclick="addServiceCategory()">Add</button>
                            </div>
                        </div>
                        <div id="serviceCategoriesList" style="max-height: 350px; overflow-y: auto;">
                            <p style="color: var(--text-subtle);">Loading...</p>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            loadServiceCategoriesList();
        }

        function closeManageCategoriesModal() {
            const modal = document.getElementById('manageCategoriesModal');
            if (modal) modal.remove();
        }

        async function loadServiceCategoriesList() {
            try {
                const result = await apiCall('/admin/service-categories');
                const container = document.getElementById('serviceCategoriesList');

                if (!result.success || !result.categories || result.categories.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-subtle);">No categories found.</p>';
                    return;
                }

                // Group by service type
                const grouped = {};
                result.categories.forEach(cat => {
                    const typeName = cat.service_type_name || 'Unknown';
                    if (!grouped[typeName]) grouped[typeName] = [];
                    grouped[typeName].push(cat);
                });

                container.innerHTML = Object.entries(grouped).map(([typeName, cats]) => `
                    <div style="margin-bottom: 15px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px; text-transform: capitalize;">${typeName}</h4>
                        ${cats.map(cat => `
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px 10px; background: var(--bg-secondary); border-radius: 4px; margin-bottom: 5px;">
                                <div>
                                    <span>${cat.name}</span>
                                    ${cat.active === 0 ? '<span style="color: var(--danger); font-size: 12px; margin-left: 8px;">(Inactive)</span>' : ''}
                                </div>
                                <div style="display: flex; gap: 5px;">
                                    <button class="btn btn-sm btn-outline" onclick="toggleServiceCategory('${cat.id}', ${cat.active})">${cat.active === 1 ? 'Disable' : 'Enable'}</button>
                                    <button class="btn btn-sm btn-outline" onclick="deleteServiceCategory('${cat.id}')" style="color: var(--danger);">Delete</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading service categories:', error);
                document.getElementById('serviceCategoriesList').innerHTML = '<p style="color: var(--danger);">Error loading categories.</p>';
            }
        }

        async function addServiceCategory() {
            const typeId = document.getElementById('newCategoryType').value;
            const name = document.getElementById('newCategoryName').value.trim();

            if (!typeId) {
                showAdminToast('Please select a service type', 'error');
                return;
            }
            if (!name) {
                showAdminToast('Please enter a category name', 'error');
                return;
            }

            try {
                await apiCall('/admin/service-categories', {
                    method: 'POST',
                    body: JSON.stringify({ name, service_type_id: typeId })
                });
                document.getElementById('newCategoryName').value = '';
                showAdminToast('Category added', 'success');
                loadServiceCategoriesList();
                await loadServiceTypesAndCategories();
            } catch (error) {
                showAdminToast(error.message || 'Error adding category', 'error');
            }
        }

        async function toggleServiceCategory(id, currentActive) {
            try {
                await apiCall(`/admin/service-categories/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify({ active: currentActive === 1 ? 0 : 1 })
                });
                loadServiceCategoriesList();
                await loadServiceTypesAndCategories();
            } catch (error) {
                showAdminToast(error.message || 'Error updating category', 'error');
            }
        }

        async function deleteServiceCategory(id) {
            if (!confirm('Are you sure you want to delete this category?')) return;

            try {
                await apiCall(`/admin/service-categories/${id}`, { method: 'DELETE' });
                showAdminToast('Category deleted', 'success');
                loadServiceCategoriesList();
                await loadServiceTypesAndCategories();
            } catch (error) {
                showAdminToast(error.message || 'Error deleting category', 'error');
            }
        }

        async function toggleServiceActive(id) {
            try {
                await apiCall(`/admin/services/${id}/toggle`, {
                    method: 'PATCH'
                });
                showAdminToast('Service status updated', 'success');
                loadServices();
            } catch (error) {
                console.error('Error toggling service:', error);
                showAdminToast('Error updating service status', 'error');
            }
        }

        async function deleteService(id) {
            const proceed = await openConfirmDialog({
                title: 'Delete Service?',
                message: 'This service will be permanently deleted. Services used in bookings cannot be deleted.',
                confirmText: 'Delete',
                tone: 'danger'
            });

            if (!proceed) return;

            try {
                await apiCall(`/admin/services/${id}`, {
                    method: 'DELETE'
                });
                showAdminToast('Service deleted successfully', 'success');
                loadServices();
            } catch (error) {
                console.error('Error deleting service:', error);
                showAdminToast(error.message || 'Error deleting service', 'error');
            }
        }
        // ===== END SERVICE MANAGEMENT FUNCTIONS =====

        async function editProduct(id) {
            editingProductId = id;
            // Find product in cached list or fetch
            let product = productListCache.find(p => p.id === id);
            if (!product) {
                try {
                    const data = await apiCall('/products');
                    productListCache = data.products || [];
                    product = productListCache.find(p => p.id === id);
                } catch (error) {
                    alert('Error loading product: ' + error.message);
                    return;
                }
            }

            if (!product) {
                alert('Product not found');
                return;
            }

            // Prefill form fields
            document.getElementById('productName').value = product.name || '';
            document.getElementById('productSku').value = product.sku || '';
            document.getElementById('productDescription').value = product.description || '';
            document.getElementById('productCategory').value = product.category || 'Care Products';
            document.getElementById('productStock').value = product.stock || 0;
            document.getElementById('productPrice').value = product.price || '';
            document.getElementById('productSalePrice').value = product.salePrice || '';
            const imageUrl = product.imageUrl || product.image_url || '';
            const imageInput = document.getElementById('productImageUrl');
            if (imageInput) {
                imageInput.value = imageUrl;
                updateProductImagePreview(imageUrl);
            }

            // Update modal title and button
            document.querySelector('#addProductModal .modal-title').textContent = 'Edit Product';
            document.getElementById('productSaveBtn').textContent = 'Save Changes';

            openModal('addProductModal');
        }

        async function deleteProduct(id) {
            const proceed = await openConfirmDialog({
                title: 'Delete product?',
                message: 'This action cannot be undone.',
                confirmText: 'Delete',
                tone: 'danger'
            });
            if (!proceed) return;

            try {
                await apiCall(`/admin/products/${id}`, {
                    method: 'DELETE'
                });
                showAdminToast('Product deleted successfully!', 'success');
                productListCache = []; // Clear cache
                loadProducts();
            } catch (error) {
                showAdminToast('Error deleting product: ' + (error.message || ''), 'error');
            }
        }

        // Reset team member modal for adding new
        function openAddStaffModal() {
            editingTeamMemberId = null;
            document.getElementById('staffName').value = '';
            document.getElementById('staffRole').value = 'Stylist';
            document.getElementById('staffTagline').value = '';
            document.getElementById('staffExperience').value = '';
            document.getElementById('staffInstagram').value = '';
            const preview = document.getElementById('staffPhotoPreview');
            if (preview) {
                preview.src = '';
                preview.dataset.imageUrl = '';
                preview.style.display = 'none';
            }
            // Update hint for services
            const hint = document.getElementById('staffServicesHint');
            if (hint) hint.textContent = 'Team member will be saved first, then you can add services.';

            document.querySelector('#addStaffModal .modal-title').textContent = 'Add Team Member';
            document.getElementById('staffSaveBtn').textContent = 'Add Team Member';
            openModal('addStaffModal');
        }

        // Handle clicking "Manage Services" - auto-save if new team member
        async function handleManageServicesClick() {
            // If editing existing team member, just open the modal
            if (editingTeamMemberId) {
                openStaffServicesModal(editingTeamMemberId);
                return;
            }

            // For new team member, validate and save first
            const name = document.getElementById('staffName').value.trim();
            const specialty = document.getElementById('staffRole').value;

            if (!name) {
                showAdminToast('Please enter a name first', 'error');
                document.getElementById('staffName').focus();
                return;
            }

            // Save the team member first
            const tagline = document.getElementById('staffTagline').value.trim();
            const yearsExperience = document.getElementById('staffExperience').value;
            const instagram = document.getElementById('staffInstagram').value.trim();
            const preview = document.getElementById('staffPhotoPreview');
            const imageUrl = preview?.dataset?.imageUrl || '';

            const staffData = { name, specialty, tagline, yearsExperience, instagram, imageUrl };

            try {
                showAdminToast('Saving team member...', 'info');
                const result = await apiCall('/admin/team', {
                    method: 'POST',
                    body: JSON.stringify(staffData)
                });

                // Get the new team member ID
                editingTeamMemberId = result.team?.id || result.id;
                teamListCache = []; // Clear cache

                // Update the modal to show we're now editing
                document.querySelector('#addStaffModal .modal-title').textContent = 'Edit Team Member';
                document.getElementById('staffSaveBtn').textContent = 'Save Changes';
                const hint = document.getElementById('staffServicesHint');
                if (hint) hint.textContent = '';

                showAdminToast('Team member saved! Now add their services.', 'success');

                // Now open the services modal
                openStaffServicesModal(editingTeamMemberId);
            } catch (error) {
                showAdminToast('Error saving team member: ' + (error.message || ''), 'error');
            }
        }

        // Reset product modal for adding new
        function openAddProductModal() {
            editingProductId = null;
            document.getElementById('productName').value = '';
            document.getElementById('productSku').value = '';
            document.getElementById('productDescription').value = '';
            document.getElementById('productCategory').value = 'Care Products';
            document.getElementById('productStock').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('productSalePrice').value = '';
            document.querySelector('#addProductModal .modal-title').textContent = 'Add Product';
            document.getElementById('productSaveBtn').textContent = 'Add Product';
            openModal('addProductModal');
        }

        async function saveBooking() {
            const errorEl = document.getElementById('adminBookingError');
            if (errorEl) errorEl.textContent = '';

            const customerId = document.getElementById('adminBookingCustomer').value;
            const serviceSelect = document.getElementById('adminBookingService');
            const serviceId = serviceSelect?.value;
            const bookingType = serviceSelect?.selectedOptions[0]?.dataset.type || 'hair';
            const stylistId = document.getElementById('adminBookingStylist').value;
            const date = document.getElementById('adminBookingDate').value;
            const time = document.getElementById('adminBookingTime').value;
            const duration = document.getElementById('adminBookingDuration').value;
            const notes = document.getElementById('adminBookingNotes').value.trim();

            if (!customerId || !serviceId || !date || !time) {
                if (errorEl) errorEl.textContent = 'Customer, service, date, and start time are required.';
                return;
            }
            if (bookingType === 'hair' && !stylistId) {
                if (errorEl) errorEl.textContent = 'Please choose a stylist for hair bookings.';
                return;
            }

            const payload = {
                userId: customerId,
                type: bookingType,
                serviceId,
                date,
                time,
                duration: duration ? parseInt(duration) : undefined,
                stylistId: stylistId || null,
                notes: notes || undefined
            };

            try {
                await apiCall('/admin/bookings', {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                closeModal('addBookingModal');
                await loadBookings();
                showAdminToast({ type: 'success', title: 'Booking created', message: 'Booking saved and synced.' });
            } catch (error) {
                if (errorEl) errorEl.textContent = error.message || 'Failed to create booking.';
            }
        }

        // ============================================
        // PUSH NOTIFICATIONS
        // ============================================
        const notifIcons = {
            promo: `<svg viewBox="0 0 24 24" fill="none" stroke="#F67599" stroke-width="2" width="20" height="20">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
            </svg>`,
            info: `<svg viewBox="0 0 24 24" fill="none" stroke="#F67599" stroke-width="2" width="20" height="20">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>`,
            booking: `<svg viewBox="0 0 24 24" fill="none" stroke="#F67599" stroke-width="2" width="20" height="20">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>`,
            points: `<svg viewBox="0 0 24 24" fill="none" stroke="#F67599" stroke-width="2" width="20" height="20">
                <circle cx="12" cy="8" r="7"></circle>
                <polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline>
            </svg>`,
            gift: `<svg viewBox="0 0 24 24" fill="none" stroke="#F67599" stroke-width="2" width="20" height="20">
                <polyline points="20 12 20 22 4 22 4 12"></polyline>
                <rect x="2" y="7" width="20" height="5"></rect>
                <line x1="12" y1="22" x2="12" y2="7"></line>
                <path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"></path>
                <path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"></path>
            </svg>`,
            warning: `<svg viewBox="0 0 24 24" fill="none" stroke="#F67599" stroke-width="2" width="20" height="20">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                <line x1="12" y1="9" x2="12" y2="13"></line>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>`,
            success: `<svg viewBox="0 0 24 24" fill="none" stroke="#F67599" stroke-width="2" width="20" height="20">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>`,
            error: `<svg viewBox="0 0 24 24" fill="none" stroke="#F67599" stroke-width="2" width="20" height="20">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="15" y1="9" x2="9" y2="15"></line>
                <line x1="9" y1="9" x2="15" y2="15"></line>
            </svg>`,
            default: `<svg viewBox="0 0 24 24" fill="none" stroke="#F67599" stroke-width="2" width="20" height="20">
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
            </svg>`
        };

        async function loadNotifications() {
            try {
                const data = await apiCall('/notifications');
                renderNotifications(data.notifications || []);
            } catch (error) {
                document.getElementById('notificationsList').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--gray-medium);">
                        <p>No notifications yet. Create your first one!</p>
                    </div>
                `;
            }
        }

        function renderNotifications(notifications) {
            const container = document.getElementById('notificationsList');

            if (notifications.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--gray-medium);">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48" style="margin-bottom: 10px; opacity: 0.5;">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                        <p>No notifications yet. Create your first one!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = notifications.map(n => `
                <div class="notification-card" style="background: white; border: 1px solid var(--gray-light); border-radius: 12px; padding: 16px; margin-bottom: 12px; display: flex; gap: 14px; align-items: flex-start; ${!n.active ? 'opacity: 0.6;' : ''}">
                    <div style="width: 44px; height: 44px; border-radius: 10px; background: ${n.active ? 'rgba(246, 117, 153, 0.1)' : 'var(--gray-light)'}; display: flex; align-items: center; justify-content: center;">
                        ${notifIcons[n.type] || notifIcons.default}
                    </div>
                    <div style="flex: 1; min-width: 0;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px;">
                            <div style="font-weight: 600; color: var(--brand-charcoal);">${n.title}</div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <span style="font-size: 11px; padding: 3px 8px; border-radius: 4px; background: ${n.active ? 'rgba(76, 175, 80, 0.1)' : 'var(--gray-light)'}; color: ${n.active ? 'var(--success)' : 'var(--gray-medium)'};">
                                    ${n.active ? 'Active' : 'Inactive'}
                                </span>
                            </div>
                        </div>
                            <div style="font-size: 13px; color: var(--gray-medium); margin-bottom: 8px;">${n.message}</div>
                            <div style="display: flex; gap: 12px; font-size: 11px; color: var(--gray-medium);">
                                <span>Type: ${n.type}</span>
                                ${n.expiresAt ? `<span>Expires: ${formatDateDisplay(n.expiresAt)}</span>` : ''}
                                <span>Created: ${formatDateDisplay(n.createdAt)}</span>
                            </div>
                        </div>
                    <div style="display: flex; gap: 6px;">
                        <button onclick="toggleNotification('${n.id}')" class="btn btn-icon btn-outline" title="${n.active ? 'Deactivate' : 'Activate'}">
                            ${n.active ?
                                `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>` :
                                `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>`}
                        </button>
                        <button onclick="deleteNotification('${n.id}')" class="btn btn-icon btn-outline" title="Delete" style="color: var(--danger);">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function showCreateNotificationModal() {
            document.getElementById('createNotificationModal').classList.add('show');
            updateNotificationPreview();

            // Add event listeners for live preview
            document.getElementById('notifType').addEventListener('change', updateNotificationPreview);
            document.getElementById('notifTitle').addEventListener('input', updateNotificationPreview);
            document.getElementById('notifMessage').addEventListener('input', updateNotificationPreview);
        }

        function closeNotificationModal() {
            document.getElementById('createNotificationModal').classList.remove('show');
            // Clear form
            document.getElementById('notifTitle').value = '';
            document.getElementById('notifMessage').value = '';
            document.getElementById('notifActionText').value = '';
            document.getElementById('notifExpires').value = '';
            document.getElementById('notifType').value = 'promo';
        }

        function updateNotificationPreview() {
            const type = document.getElementById('notifType').value;
            const title = document.getElementById('notifTitle').value || 'Your Title Here';
            const message = document.getElementById('notifMessage').value || 'Your message will appear here...';

            document.getElementById('notifPreview').innerHTML = `
                <div style="width: 36px; height: 36px; border-radius: 8px; background: rgba(246, 117, 153, 0.1); display: flex; align-items: center; justify-content: center;">${notifIcons[type] || notifIcons.promo}</div>
                <div style="flex: 1;">
                    <div style="font-weight: 600; font-size: 13px; color: #414042;">${title}</div>
                    <div style="font-size: 12px; color: #6d6e70;">${message}</div>
                </div>
            `;
        }

        async function createNotification() {
            const title = document.getElementById('notifTitle').value.trim();
            const message = document.getElementById('notifMessage').value.trim();
            const type = document.getElementById('notifType').value;
            const actionText = document.getElementById('notifActionText').value.trim();
            const expiresAt = document.getElementById('notifExpires').value;

            if (!title || !message) {
                alert('Please enter a title and message');
                return;
            }

            try {
                await apiCall('/notifications', {
                    method: 'POST',
                    body: JSON.stringify({
                        title,
                        message,
                        type,
                        actionText: actionText || null,
                        expiresAt: expiresAt || null
                    })
                });

                closeNotificationModal();
                loadNotifications();
                alert('Notification created successfully! Users will see it when they open the app.');
            } catch (error) {
                alert('Error creating notification: ' + error.message);
            }
        }

        async function toggleNotification(id) {
            try {
                await apiCall(`/notifications/${id}/toggle`, { method: 'PATCH' });
                loadNotifications();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function deleteNotification(id) {
            const proceed = await openConfirmDialog({
                title: 'Delete notification?',
                message: 'This cannot be undone.',
                confirmText: 'Delete',
                tone: 'danger'
            });
            if (!proceed) return;

            try {
                await apiCall(`/notifications/${id}`, { method: 'DELETE' });
                loadNotifications();
            } catch (error) {
                showAdminToast('Error deleting notification: ' + (error.message || ''), 'error');
            }
        }

        // ============================================
        // CUSTOMER CHAT
        // ============================================
        let adminConversations = [];
        let selectedConversationId = null;
        let adminChatPollingInterval = null;

        async function loadAdminConversations() {
            try {
                const data = await apiCall('/admin/chat/conversations');
                adminConversations = data.conversations || [];
                renderAdminConversations();

                // Start polling for new messages
                startAdminChatPolling();

                // Update unread badge in nav
                updateUnreadBadge();
            } catch (error) {
                console.error('Error loading conversations:', error);
                document.getElementById('adminChatList').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--danger);">
                        Failed to load conversations: ${error.message}
                    </div>
                `;
            }
        }

        function renderAdminConversations() {
            const container = document.getElementById('adminChatList');

            if (adminConversations.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--gray-medium);">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48" style="margin-bottom: 15px; opacity: 0.5;">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                        <p>No conversations yet</p>
                        <p style="font-size: 12px; margin-top: 8px;">Customer messages will appear here</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = adminConversations.map(conv => {
                const isSelected = conv.id === selectedConversationId;
                const hasUnread = conv.unreadCount > 0;
                const lastMsgTime = conv.lastMessageAt ? formatChatTimeAdmin(new Date(conv.lastMessageAt)) : '';
                const statusClass = conv.status === 'closed' ? 'closed' : '';

                return `
                    <div class="chat-item ${isSelected ? 'active' : ''} ${hasUnread ? 'unread' : ''} ${statusClass}"
                         onclick="selectChat('${conv.id}')"
                         style="padding: 15px; border-bottom: 1px solid var(--gray-light); cursor: pointer; ${isSelected ? 'background: var(--primary-light);' : ''} ${hasUnread ? 'background: rgba(246, 117, 153, 0.12);' : ''}">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div class="chat-avatar" style="width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), #ff9cbc); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 16px;">
                                ${(conv.customerName || 'G').charAt(0).toUpperCase()}
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-weight: ${hasUnread ? '700' : '600'}; color: var(--dark);">${conv.customerName || 'Guest'}</span>
                                    <span style="font-size: 11px; color: var(--gray-medium);">${lastMsgTime}</span>
                                </div>
                                <div style="font-size: 13px; color: var(--gray-medium); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 4px;">
                                    ${conv.lastMessage || 'No messages yet'}
                                </div>
                                <div style="display: flex; gap: 8px; margin-top: 6px;">
                                    ${conv.status === 'closed' ? '<span style="font-size: 10px; padding: 2px 6px; background: var(--gray-light); border-radius: 10px; color: var(--gray-medium);">Closed</span>' : ''}
                                    ${hasUnread ? `<span style="font-size: 10px; padding: 2px 8px; background: var(--primary); border-radius: 10px; color: white;">${conv.unreadCount} new</span>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function formatChatTimeAdmin(date) {
            const now = new Date();
            const diff = now - date;
            const mins = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (mins < 1) return 'Just now';
            if (mins < 60) return mins + 'm ago';
            if (hours < 24) return hours + 'h ago';
            if (days < 7) return days + 'd ago';
            return formatDateDisplay(date);
        }

        async function selectChat(conversationId) {
            selectedConversationId = conversationId;

            // Update UI to show selected
            renderAdminConversations();

            try {
                const data = await apiCall(`/admin/chat/conversations/${conversationId}`);
                const conv = data.conversation;

                // Update header
                document.getElementById('selectedChatName').textContent = conv.customerName || 'Guest';
                document.getElementById('selectedChatStatus').textContent = conv.status === 'open' ? 'Active conversation' : 'Closed';
                document.getElementById('selectedChatAvatar').textContent = (conv.customerName || 'G').charAt(0).toUpperCase();
                document.getElementById('chatActions').style.display = conv.status === 'open' ? 'flex' : 'none';

                // Enable input if conversation is open
                const input = document.getElementById('adminChatInput');
                const sendBtn = document.getElementById('adminSendBtn');
                if (conv.status === 'open') {
                    input.disabled = false;
                    sendBtn.disabled = false;
                    input.placeholder = 'Type a message...';
                } else {
                    input.disabled = true;
                    sendBtn.disabled = true;
                    input.placeholder = 'This conversation is closed';
                }

                // Render messages
                renderAdminMessages(conv.messages || []);

                // Mark as read
                if (conv.unreadCount > 0) {
                    await apiCall(`/admin/chat/conversations/${conversationId}/read`, { method: 'PATCH' });
                    // Refresh conversation list to update unread counts
                    const listData = await apiCall('/admin/chat/conversations');
                    adminConversations = listData.conversations || [];
                    renderAdminConversations();
                    updateUnreadBadge();
                }

            } catch (error) {
                console.error('Error loading conversation:', error);
                document.getElementById('chatMessagesAdmin').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--danger);">
                        Failed to load conversation: ${error.message}
                    </div>
                `;
            }
        }

        function renderAdminMessages(messages) {
            const container = document.getElementById('chatMessagesAdmin');

            if (messages.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--gray-medium);">
                        No messages in this conversation yet
                    </div>
                `;
                return;
            }

            container.innerHTML = messages.map(msg => {
                const isAgent = msg.from === 'agent';
                const time = formatChatTimeAdmin(new Date(msg.timestamp));

                return `
                    <div style="display: flex; justify-content: ${isAgent ? 'flex-end' : 'flex-start'}; margin-bottom: 12px;">
                        <div style="max-width: 70%; padding: 12px 16px; border-radius: 18px; ${isAgent ?
                            'background: linear-gradient(135deg, var(--primary), #ff9cbc); color: white; border-bottom-right-radius: 4px;' :
                            'background: white; color: var(--dark); border-bottom-left-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.1);'}">
                            <div style="word-wrap: break-word;">${escapeHtmlAdmin(msg.text)}</div>
                            <div style="font-size: 10px; margin-top: 6px; opacity: 0.7; text-align: ${isAgent ? 'right' : 'left'};">
                                ${isAgent ? 'You' : 'Customer'} - ${time}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        function escapeHtmlAdmin(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function sendAdminChatMessage() {
            if (!selectedConversationId) return;

            const input = document.getElementById('adminChatInput');
            const message = input.value.trim();
            if (!message) return;

            input.value = '';
            input.disabled = true;
            document.getElementById('adminSendBtn').disabled = true;

            try {
                await apiCall('/admin/chat/message', {
                    method: 'POST',
                    body: JSON.stringify({
                        conversationId: selectedConversationId,
                        text: message
                    })
                });

                // Reload the conversation to show the new message
                await selectChat(selectedConversationId);

            } catch (error) {
                console.error('Error sending message:', error);
                alert('Failed to send message: ' + error.message);
            } finally {
                input.disabled = false;
                document.getElementById('adminSendBtn').disabled = false;
                input.focus();
            }
        }

        function handleAdminChatKeypress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendAdminChatMessage();
            }
        }

        async function closeConversation() {
            if (!selectedConversationId) return;

            const proceed = await openConfirmDialog({
                title: 'Close conversation?',
                message: 'The customer can start a new one if needed.',
                confirmText: 'Close Chat'
            });
            if (!proceed) return;

            try {
                await apiCall(`/admin/chat/conversations/${selectedConversationId}/status`, {
                    method: 'PATCH',
                    body: JSON.stringify({ status: 'closed' })
                });

                // Reload conversations and clear selection
                await loadAdminConversations();
                selectedConversationId = null;

                // Reset the chat panel
                document.getElementById('selectedChatName').textContent = 'Select a conversation';
                document.getElementById('selectedChatStatus').textContent = '';
                document.getElementById('selectedChatAvatar').textContent = '?';
                document.getElementById('chatActions').style.display = 'none';
                document.getElementById('adminChatInput').disabled = true;
                document.getElementById('adminSendBtn').disabled = true;
                document.getElementById('chatMessagesAdmin').innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: var(--gray-medium);">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48" style="margin-bottom: 15px; opacity: 0.5;">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                        <p>Select a conversation from the left to view messages</p>
                    </div>
                `;

            } catch (error) {
                console.error('Error closing conversation:', error);
                alert('Failed to close conversation: ' + error.message);
            }
        }

        function updateUnreadBadge() {
            const totalUnread = adminConversations.reduce((sum, c) => sum + (c.unreadCount || 0), 0);
            const badge = document.getElementById('totalUnreadBadge');
            const navBadge = document.querySelector('.nav-item[onclick*="chat"] .nav-badge');

            if (badge) {
                badge.textContent = totalUnread;
                badge.style.display = totalUnread > 0 ? 'inline-flex' : 'none';
            }

            if (navBadge) {
                navBadge.textContent = totalUnread;
                navBadge.style.display = totalUnread > 0 ? 'inline-flex' : 'none';
            }
        }

        function startAdminChatPolling() {
            stopAdminChatPolling();
            adminChatPollingInterval = setInterval(pollAdminChat, 10000); // Poll every 10 seconds
        }

        function stopAdminChatPolling() {
            if (adminChatPollingInterval) {
                clearInterval(adminChatPollingInterval);
                adminChatPollingInterval = null;
            }
        }

        async function pollAdminChat() {
            try {
                const data = await apiCall('/admin/chat/conversations');
                const newConversations = data.conversations || [];

                // Check if there are new messages in any conversation
                const hadNewMessages = newConversations.some((newConv, i) => {
                    const oldConv = adminConversations.find(c => c.id === newConv.id);
                    return !oldConv || newConv.messageCount > (oldConv.messageCount || 0);
                });

                adminConversations = newConversations;
                renderAdminConversations();
                updateUnreadBadge();

                // If the selected conversation has new messages, reload it
                if (selectedConversationId && hadNewMessages) {
                    const selectedConv = newConversations.find(c => c.id === selectedConversationId);
                    if (selectedConv) {
                        const convData = await apiCall(`/admin/chat/conversations/${selectedConversationId}`);
                        renderAdminMessages(convData.conversation.messages || []);
                    }
                }
            } catch (error) {
                console.error('Chat polling error:', error);
            }
        }

        // ============================================
        // HAIR TIPS MANAGEMENT
        // ============================================
        let hairTipsData = [];

        async function loadHairTips() {
            try {
                const data = await apiCall('/admin/hair-tips');
                hairTipsData = data.tips || [];
                renderHairTips();
            } catch (error) {
                console.error('Error loading hair tips:', error);
                document.getElementById('hairTipsList').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--danger);">
                        Failed to load tips: ${error.message}
                    </div>
                `;
            }
        }

        function renderHairTips() {
            const container = document.getElementById('hairTipsList');

            if (hairTipsData.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--gray-medium);">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48" style="margin-bottom: 15px; opacity: 0.5;">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                        </svg>
                        <p>No hair tips yet</p>
                        <p style="font-size: 12px; margin-top: 8px;">Click "+ Add Tip" to create your first tip</p>
                    </div>
                `;
                return;
            }

            const activeCount = hairTipsData.filter(t => t.active).length;
            const inactiveCount = hairTipsData.length - activeCount;

            container.innerHTML = `
                <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                    <div style="padding: 15px 20px; background: var(--success-light, #e8f5e9); border-radius: 8px; flex: 1;">
                        <div style="font-size: 24px; font-weight: 700; color: var(--success, #4caf50);">${activeCount}</div>
                        <div style="font-size: 12px; color: var(--gray-medium);">Active Tips</div>
                    </div>
                    <div style="padding: 15px 20px; background: var(--gray-light); border-radius: 8px; flex: 1;">
                        <div style="font-size: 24px; font-weight: 700; color: var(--gray-medium);">${inactiveCount}</div>
                        <div style="font-size: 12px; color: var(--gray-medium);">Inactive Tips</div>
                    </div>
                </div>
                ${hairTipsData.map(tip => `
                    <div style="display: flex; align-items: flex-start; gap: 15px; padding: 15px; background: ${tip.active ? 'white' : 'var(--gray-light)'}; border: 1px solid var(--gray-light); border-radius: 10px; ${!tip.active ? 'opacity: 0.7;' : ''}">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <span style="font-size: 10px; padding: 2px 8px; background: ${getCategoryColor(tip.category)}; border-radius: 10px; color: white; text-transform: uppercase;">${tip.category || 'general'}</span>
                                ${!tip.active ? '<span style="font-size: 10px; padding: 2px 8px; background: var(--gray-medium); border-radius: 10px; color: white;">INACTIVE</span>' : ''}
                            </div>
                            <p style="margin: 0; color: var(--dark); line-height: 1.5;">${escapeHtmlTips(tip.text)}</p>
                        </div>
                        <div style="display: flex; gap: 8px; flex-shrink: 0;">
                            <button class="btn btn-sm btn-outline" onclick="toggleHairTip('${tip.id}')" title="${tip.active ? 'Deactivate' : 'Activate'}">
                                ${tip.active ? '👁️' : '👁️‍🗨️'}
                            </button>
                            <button class="btn btn-sm btn-outline" onclick="editHairTip('${tip.id}')" title="Edit">
                                ✏️
                            </button>
                            <button class="btn btn-sm btn-outline" onclick="deleteHairTip('${tip.id}')" title="Delete" style="color: var(--danger);">
                                🗑️
                            </button>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function getCategoryColor(category) {
            const colors = {
                'general': '#9e9e9e',
                'extensions': '#FF6B9D',
                'styling': '#9c27b0',
                'care': '#4caf50',
                'maintenance': '#ff9800',
                'wash': '#2196F3',
                'treatment': '#7e57c2',
                'heat': '#f57c00',
                'detangle': '#26a69a',
                'scalp': '#6d4c41',
                'drying': '#00acc1',
                'protection': '#00897b',
                'lifestyle': '#8d6e63'
            };
            return colors[category] || colors.general;
        }

        function escapeHtmlTips(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function openHairTipModal(tipId = null) {
            document.getElementById('editHairTipId').value = tipId || '';
            document.getElementById('hairTipModalTitle').textContent = tipId ? 'Edit Hair Tip' : 'Add New Hair Tip';

            if (tipId) {
                const tip = hairTipsData.find(t => t.id === tipId);
                if (tip) {
                    document.getElementById('hairTipText').value = tip.text;
                    document.getElementById('hairTipCategory').value = tip.category || 'general';
                    document.getElementById('hairTipPriority').value = tip.priority || 1;
                }
            } else {
                document.getElementById('hairTipText').value = '';
                document.getElementById('hairTipCategory').value = 'general';
                document.getElementById('hairTipPriority').value = '1';
            }

            openModal('hairTipModal');
        }

        function closeHairTipModal() {
            closeModal('hairTipModal');
        }

        function editHairTip(tipId) {
            openHairTipModal(tipId);
        }

        async function saveHairTip() {
            const tipId = document.getElementById('editHairTipId').value;
            const text = document.getElementById('hairTipText').value.trim();
            const category = document.getElementById('hairTipCategory').value;
            const priority = parseInt(document.getElementById('hairTipPriority').value);

            if (!text) {
                alert('Please enter the tip text');
                return;
            }

            try {
                if (tipId) {
                    // Update existing tip
                    await apiCall(`/admin/hair-tips/${tipId}`, {
                        method: 'PUT',
                        body: JSON.stringify({ text, category, priority })
                    });
                } else {
                    // Create new tip
                    await apiCall('/admin/hair-tips', {
                        method: 'POST',
                        body: JSON.stringify({ text, category, priority })
                    });
                }

                closeHairTipModal();
                loadHairTips();
            } catch (error) {
                alert('Error saving tip: ' + error.message);
            }
        }

        async function toggleHairTip(tipId) {
            try {
                await apiCall(`/admin/hair-tips/${tipId}/toggle`, { method: 'PATCH' });
                loadHairTips();
            } catch (error) {
                alert('Error toggling tip: ' + error.message);
            }
        }

        async function deleteHairTip(tipId) {
            const proceed = await openConfirmDialog({
                title: 'Delete tip?',
                message: 'This cannot be undone.',
                confirmText: 'Delete',
                tone: 'danger'
            });
            if (!proceed) return;

            try {
                await apiCall(`/admin/hair-tips/${tipId}`, { method: 'DELETE' });
                loadHairTips();
            } catch (error) {
                showAdminToast('Error deleting tip: ' + (error.message || ''), 'error');
            }
        }

        // ============================================
        // GALLERY MANAGEMENT
        // ============================================

        let galleryImporting = false;

        async function importFlirthairGallery() {
            if (galleryImporting) return;
            const confirmed = confirm('Import the latest images from flirthair.co.za into the gallery? Existing Flirt images will be updated.');
            if (!confirmed) return;

            galleryImporting = true;
            showAdminToast('Importing gallery images...', 'info');
            try {
                const result = await apiCall('/admin/gallery/import/flirthair', { method: 'POST' });
                const created = result.created || 0;
                const updated = result.updated || 0;
                const skipped = result.skipped || 0;
                showAdminToast(`Import complete. ${created} added, ${updated} updated, ${skipped} skipped.`, 'success');
                loadGallery();
            } catch (error) {
                showAdminToast('Import failed: ' + error.message, 'error');
            } finally {
                galleryImporting = false;
            }
        }

        async function loadGallery() {
            try {
                const data = await apiCall('/admin/gallery');
                renderGallery(data.items || []);
                window.instagramConfig = data.instagram || null;

                const instaStatus = document.getElementById('instagramStatus');
                if (instaStatus) {
                    const insta = data.instagram;
                    if (insta && insta.username) {
                        instaStatus.textContent = `Connected to @${insta.username}`;
                        instaStatus.style.color = 'var(--success)';
                    } else {
                        instaStatus.textContent = 'Not configured';
                        instaStatus.style.color = 'var(--gray-medium)';
                    }
                }
            } catch (error) {
                console.error('Error loading gallery:', error);
                document.getElementById('galleryList').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--danger); grid-column: 1/-1;">
                        Failed to load gallery: ${error.message}
                    </div>
                `;
            }
        }

        function openInstagramModal() {
            const existing = window.instagramConfig || {};
            const username = prompt('Instagram handle (without @):', existing.username || '');
            if (username === null) return;
            const embedUrl = prompt('Custom embed URL (optional):', existing.embedUrl || '');
            saveInstagramConfig(username.trim(), embedUrl ? embedUrl.trim() : '');
        }

        async function saveInstagramConfig(username, embedUrl) {
            try {
                await apiCall('/admin/gallery/instagram', {
                    method: 'PUT',
                    body: JSON.stringify({ username, embedUrl })
                });
                alert('Instagram feed updated');
                loadGallery();
            } catch (error) {
                alert('Error saving Instagram config: ' + error.message);
            }
        }

        function renderGallery(items) {
            const container = document.getElementById('galleryList');

            if (items.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--gray-medium); grid-column: 1/-1;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48" style="margin-bottom: 10px; opacity: 0.5;">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                            <polyline points="21 15 16 10 5 21"></polyline>
                        </svg>
                        <p>No gallery images yet. Click "+ Add Image" to get started.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = items.map(item => `
                <div class="gallery-admin-item ${item.active ? '' : 'inactive'}" data-id="${item.id}">
                    <img src="${item.imageUrl}" alt="${item.altText || ''}" onerror="this.src='https://via.placeholder.com/300x300?text=Image+Not+Found'">
                    <div class="gallery-admin-overlay">
                        <div class="gallery-admin-label">${item.label || 'Untitled'}</div>
                        <div class="gallery-admin-category">${item.category || 'general'}</div>
                    </div>
                    <div class="gallery-admin-actions">
                        <button class="gallery-action-btn edit" onclick="editGalleryItem('${item.id}')" title="Edit">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </button>
                        <button class="gallery-action-btn toggle" onclick="toggleGalleryItem('${item.id}')" title="${item.active ? 'Hide' : 'Show'}">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                ${item.active ?
                                    '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>' :
                                    '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line>'
                                }
                            </svg>
                        </button>
                        <button class="gallery-action-btn delete" onclick="deleteGalleryItem('${item.id}')" title="Delete">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function showGalleryModal(item = null) {
            document.getElementById('galleryModalTitle').textContent = item ? 'Edit Gallery Image' : 'Add Gallery Image';
            document.getElementById('gallerySubmitBtn').textContent = item ? 'Update Image' : 'Add Image';
            document.getElementById('galleryEditId').value = item ? item.id : '';
            document.getElementById('galleryImageUrl').value = item ? item.imageUrl : '';
            document.getElementById('galleryLabel').value = item ? (item.label || '') : '';
            document.getElementById('galleryAltText').value = item ? (item.altText || '') : '';
            document.getElementById('galleryCategory').value = item ? (item.category || 'general') : 'general';

            // Update preview
            updateGalleryPreview(item ? item.imageUrl : '');

            document.getElementById('galleryModal').classList.add('active');
        }

        function closeGalleryModal() {
            document.getElementById('galleryModal').classList.remove('active');
        }

        function updateGalleryPreview(url) {
            const preview = document.getElementById('galleryImagePreview');
            if (url) {
                preview.innerHTML = `<img src="${url}" alt="Preview" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.parentElement.innerHTML='<span style=\\'color: var(--danger);\\'>Failed to load image</span>'">`;
            } else {
                preview.innerHTML = '<span style="color: var(--gray-medium);">Enter URL to preview</span>';
            }
        }

        // Add event listener for image URL preview
        document.addEventListener('DOMContentLoaded', function() {
            const urlInput = document.getElementById('galleryImageUrl');
            if (urlInput) {
                urlInput.addEventListener('input', function() {
                    updateGalleryPreview(this.value);
                });
            }
        });

        async function editGalleryItem(id) {
            try {
                const data = await apiCall('/admin/gallery');
                const item = data.items.find(i => i.id === id);
                if (item) {
                    showGalleryModal(item);
                }
            } catch (error) {
                alert('Error loading item: ' + error.message);
            }
        }

        async function submitGalleryItem() {
            const id = document.getElementById('galleryEditId').value;
            const imageUrl = document.getElementById('galleryImageUrl').value.trim();
            const label = document.getElementById('galleryLabel').value.trim();
            const altText = document.getElementById('galleryAltText').value.trim();
            const category = document.getElementById('galleryCategory').value;

            if (!imageUrl) {
                alert('Please enter an image URL');
                return;
            }

            try {
                if (id) {
                    // Update existing
                    await apiCall(`/admin/gallery/${id}`, {
                        method: 'PATCH',
                        body: JSON.stringify({ imageUrl, label, altText, category })
                    });
                } else {
                    // Create new
                    await apiCall('/admin/gallery', {
                        method: 'POST',
                        body: JSON.stringify({ imageUrl, label, altText, category })
                    });
                }

                closeGalleryModal();
                loadGallery();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function toggleGalleryItem(id) {
            try {
                await apiCall(`/admin/gallery/${id}/toggle`, { method: 'PATCH' });
                loadGallery();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function deleteGalleryItem(id) {
            const proceed = await openConfirmDialog({
                title: 'Delete gallery image?',
                message: 'This cannot be undone.',
                confirmText: 'Delete',
                tone: 'danger'
            });
            if (!proceed) return;

            try {
                await apiCall(`/admin/gallery/${id}`, { method: 'DELETE' });
                loadGallery();
            } catch (error) {
                showAdminToast('Error deleting image: ' + (error.message || ''), 'error');
            }
        }

        // ============================================
        // PAYMENT SETTINGS
        // ============================================
        async function loadPaymentSettings() {
            await refreshPaymentConfig();
        }

        async function refreshPaymentConfig() {
            try {
                const data = await apiCall('/admin/payment-config');
                const config = data.config;
                const stored = data.storedConfig || {};

                // Update App URL
                document.getElementById('paymentAppUrlDisplay').value = config.appUrl;

                populatePaymentForm(config, stored);

                // Update PayFast configuration
                updatePayFastUI(config.payfast);

                // Update Yoco configuration
                updateYocoUI(config.yoco);

            } catch (error) {
                console.error('Error loading payment config:', error);
                alert('Failed to load payment configuration: ' + error.message);
            }
        }

        function populatePaymentForm(config, stored) {
            document.getElementById('paymentAppUrl').value = stored.appUrl || config.appUrl || '';
            document.getElementById('paymentApiBaseUrl').value = stored.apiBaseUrl || config.apiBaseUrl || '';

            document.getElementById('payfastMerchantId').value = stored.payfast?.merchantId || '';
            document.getElementById('payfastMerchantKey').value = stored.payfast?.merchantKey || '';
            document.getElementById('payfastPassphrase').value = stored.payfast?.passphrase || '';
            const sandboxDefault = config.payfast.mode === 'sandbox';
            document.getElementById('payfastSandbox').checked = stored.payfast?.sandbox ?? sandboxDefault;

            document.getElementById('yocoSecretKey').value = stored.yoco?.secretKey || '';
            document.getElementById('yocoPublicKey').value = stored.yoco?.publicKey || '';
            document.getElementById('yocoWebhookSecret').value = stored.yoco?.webhookSecret || '';
        }

        async function savePaymentSettings() {
            const payload = {
                appUrl: document.getElementById('paymentAppUrl').value.trim(),
                apiBaseUrl: document.getElementById('paymentApiBaseUrl').value.trim(),
                payfast: {
                    merchantId: document.getElementById('payfastMerchantId').value.trim(),
                    merchantKey: document.getElementById('payfastMerchantKey').value.trim(),
                    passphrase: document.getElementById('payfastPassphrase').value.trim(),
                    sandbox: document.getElementById('payfastSandbox').checked
                },
                yoco: {
                    secretKey: document.getElementById('yocoSecretKey').value.trim(),
                    publicKey: document.getElementById('yocoPublicKey').value.trim(),
                    webhookSecret: document.getElementById('yocoWebhookSecret').value.trim()
                }
            };

            try {
                await apiCall('/admin/payment-config', {
                    method: 'PUT',
                    body: JSON.stringify(payload)
                });
                alert('Payment settings saved');
                await refreshPaymentConfig();
            } catch (error) {
                console.error('Error saving payment settings:', error);
                alert('Failed to save payment settings: ' + error.message);
            }
        }

        function updatePayFastUI(payfast) {
            // Status badge
            const statusBadge = document.getElementById('payfastStatusBadge');
            if (payfast.configured) {
                statusBadge.textContent = '✓ Configured';
                statusBadge.style.background = 'var(--success)';
                statusBadge.style.display = 'inline-block';
            } else {
                statusBadge.textContent = '⚠ Not Configured';
                statusBadge.style.background = 'var(--warning)';
                statusBadge.style.display = 'inline-block';
            }

            // Mode and URLs
            document.getElementById('payfastMode').value = payfast.mode;
            document.getElementById('payfastBaseUrl').value = payfast.baseUrl;
            document.getElementById('payfastNotifyUrl').value = payfast.notifyUrl;
            document.getElementById('payfastReturnUrl').value = payfast.returnUrl;
            document.getElementById('payfastCancelUrl').value = payfast.cancelUrl;

            // Passphrase indicator
            const passphraseIcon = document.getElementById('payfastPassphraseIcon');
            if (payfast.hasPassphrase) {
                passphraseIcon.innerHTML = '<span style="color: var(--success);">✓</span>';
            } else {
                passphraseIcon.innerHTML = '<span style="color: var(--gray-medium);">✗</span>';
            }

            // Missing vars
            const missingVarsDiv = document.getElementById('payfastMissingVars');
            const missingVarsList = document.getElementById('payfastMissingVarsList');

            if (payfast.missingEnvVars && payfast.missingEnvVars.length > 0) {
                missingVarsDiv.style.display = 'block';
                missingVarsList.innerHTML = payfast.missingEnvVars
                    .map(v => `<li><code style="background: white; padding: 2px 6px; border-radius: 4px;">${v}</code></li>`)
                    .join('');
            } else {
                missingVarsDiv.style.display = 'none';
            }
        }

        function updateYocoUI(yoco) {
            // Status badge
            const statusBadge = document.getElementById('yocoStatusBadge');
            if (yoco.configured) {
                statusBadge.textContent = '✓ Configured';
                statusBadge.style.background = 'var(--success)';
                statusBadge.style.display = 'inline-block';
            } else {
                statusBadge.textContent = '⚠ Not Configured';
                statusBadge.style.background = 'var(--warning)';
                statusBadge.style.display = 'inline-block';
            }

            // Base URL and webhook
            document.getElementById('yocoBaseUrl').value = yoco.baseUrl;
            document.getElementById('yocoWebhookUrl').value = yoco.webhookUrl;

            // Public key (truncated for security)
            document.getElementById('yocoPublicKeyDisplay').value = yoco.publicKey || 'Not configured';

            // Icons for configured items
            const publicKeyIcon = document.getElementById('yocoPublicKeyIcon');
            if (yoco.hasPublicKey) {
                publicKeyIcon.innerHTML = '<span style="color: var(--success);">✓</span>';
            } else {
                publicKeyIcon.innerHTML = '<span style="color: var(--gray-medium);">✗</span>';
            }

            const webhookSecretIcon = document.getElementById('yocoWebhookSecretIcon');
            if (yoco.hasWebhookSecret) {
                webhookSecretIcon.innerHTML = '<span style="color: var(--success);">✓</span>';
            } else {
                webhookSecretIcon.innerHTML = '<span style="color: var(--warning);">⚠</span>';
            }

            // Missing vars
            const missingVarsDiv = document.getElementById('yocoMissingVars');
            const missingVarsList = document.getElementById('yocoMissingVarsList');

            if (yoco.missingEnvVars && yoco.missingEnvVars.length > 0) {
                missingVarsDiv.style.display = 'block';
                missingVarsList.innerHTML = yoco.missingEnvVars
                    .map(v => `<li><code style="background: white; padding: 2px 6px; border-radius: 4px;">${v}</code></li>`)
                    .join('');
            } else {
                missingVarsDiv.style.display = 'none';
            }
        }

        // ============================================
        // BUSINESS & DELIVERY SETTINGS
        // ============================================

        let businessHours = {};

        async function loadSettingsPage() {
            await Promise.all([
                loadBusinessSettings(),
                loadDeliverySettings()
            ]);
        }

        async function loadBusinessSettings() {
            try {
                const data = await apiCall('/admin/business-settings');
                const settings = data.settings;

                document.getElementById('settingsBusinessName').value = settings.businessName || '';
                document.getElementById('settingsEmail').value = settings.email || '';
                document.getElementById('settingsPhone').value = settings.phone || '';
                document.getElementById('settingsAddress').value = settings.address || '';

                businessHours = settings.hours || {};
                renderBusinessHours();
            } catch (error) {
                console.error('Error loading business settings:', error);
                // If endpoint doesn't exist yet (table not created), show defaults
                renderBusinessHours();
            }
        }

        function renderBusinessHours() {
            const days = [
                { key: 'mon', label: 'MON' },
                { key: 'tue', label: 'TUE' },
                { key: 'wed', label: 'WED' },
                { key: 'thu', label: 'THU' },
                { key: 'fri', label: 'FRI' },
                { key: 'sat', label: 'SAT' },
                { key: 'sun', label: 'SUN' }
            ];

            const grid = document.getElementById('businessHoursGrid');
            grid.innerHTML = days.map(day => {
                const hours = businessHours[day.key];
                const isClosed = !hours;
                const displayText = isClosed ? 'Closed' : formatHoursDisplay(hours.open, hours.close);
                const opacity = isClosed ? 'opacity: 0.5;' : '';

                return `
                    <div style="text-align: center; padding: 10px; background: var(--gray-light); border-radius: 8px; cursor: pointer; ${opacity}"
                         onclick="editDayHours('${day.key}', '${day.label}')"
                         title="Click to edit">
                        <div style="font-weight: 600; font-size: 12px;">${day.label}</div>
                        <div style="font-size: 11px; color: var(--gray-medium);">${displayText}</div>
                    </div>
                `;
            }).join('');
        }

        function formatHoursDisplay(open, close) {
            const formatTime = (time) => {
                if (!time) return '';
                const [h, m] = time.split(':');
                const hour = parseInt(h);
                const ampm = hour >= 12 ? 'pm' : 'am';
                const hour12 = hour % 12 || 12;
                return `${hour12}${ampm}`;
            };
            return `${formatTime(open)}-${formatTime(close)}`;
        }

        function editDayHours(dayKey, dayLabel) {
            const hours = businessHours[dayKey];
            const isClosed = !hours;

            const html = `
                <div style="padding: 20px;">
                    <h3 style="margin-bottom: 20px;">Edit ${dayLabel} Hours</h3>
                    <div style="margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="dayClosedCheckbox" ${isClosed ? 'checked' : ''} onchange="toggleDayClosed()">
                            <span>Closed</span>
                        </label>
                    </div>
                    <div id="hoursInputs" style="${isClosed ? 'display: none;' : ''}">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Open</label>
                                <input type="time" class="form-input" id="dayOpenTime" value="${hours?.open || '08:00'}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Close</label>
                                <input type="time" class="form-input" id="dayCloseTime" value="${hours?.close || '18:00'}">
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="saveDayHours('${dayKey}')">Save</button>
                        <button class="btn btn-outline" onclick="closeModal('editHoursModal')">Cancel</button>
                    </div>
                </div>
            `;

            // Create modal if not exists
            let modal = document.getElementById('editHoursModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'editHoursModal';
                modal.className = 'modal-overlay';
                modal.innerHTML = '<div class="modal" style="max-width: 400px;"></div>';
                document.body.appendChild(modal);
            }

            modal.querySelector('.modal').innerHTML = html;
            modal.style.display = '';  // Clear inline style so CSS class can work
            modal.classList.add('show');
        }

        function toggleDayClosed() {
            const isClosed = document.getElementById('dayClosedCheckbox').checked;
            document.getElementById('hoursInputs').style.display = isClosed ? 'none' : '';
        }

        function saveDayHours(dayKey) {
            const isClosed = document.getElementById('dayClosedCheckbox').checked;

            if (isClosed) {
                businessHours[dayKey] = null;
            } else {
                businessHours[dayKey] = {
                    open: document.getElementById('dayOpenTime').value,
                    close: document.getElementById('dayCloseTime').value
                };
            }

            renderBusinessHours();
            closeModal('editHoursModal');
        }

        async function saveBusinessSettings() {
            const payload = {
                businessName: document.getElementById('settingsBusinessName').value.trim(),
                email: document.getElementById('settingsEmail').value.trim(),
                phone: document.getElementById('settingsPhone').value.trim(),
                address: document.getElementById('settingsAddress').value.trim(),
                hours: businessHours
            };

            // Validate email
            if (payload.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(payload.email)) {
                alert('Please enter a valid email address');
                return;
            }

            try {
                await apiCall('/admin/business-settings', {
                    method: 'PUT',
                    body: JSON.stringify(payload)
                });
                alert('Business settings saved successfully!');
            } catch (error) {
                console.error('Error saving business settings:', error);
                alert('Failed to save business settings: ' + error.message);
            }
        }

        async function loadDeliverySettings() {
            try {
                const data = await apiCall('/admin/delivery-config');
                const config = data.config;

                document.getElementById('deliveryStandardFee').value = config.standardFee || '';
                document.getElementById('deliveryExpressFee').value = config.expressFee || '';
                document.getElementById('deliveryFreeThreshold').value = config.freeThreshold || '';
            } catch (error) {
                console.error('Error loading delivery settings:', error);
            }
        }

        async function saveDeliverySettings() {
            const standardFee = parseFloat(document.getElementById('deliveryStandardFee').value) || 0;
            const expressFee = parseFloat(document.getElementById('deliveryExpressFee').value) || 0;
            const freeThreshold = parseFloat(document.getElementById('deliveryFreeThreshold').value) || 0;

            if (standardFee < 0 || expressFee < 0 || freeThreshold < 0) {
                alert('Fee values cannot be negative');
                return;
            }

            try {
                await apiCall('/admin/delivery-config', {
                    method: 'PUT',
                    body: JSON.stringify({ standardFee, expressFee, freeThreshold })
                });
                alert('Delivery settings saved successfully!');
            } catch (error) {
                console.error('Error saving delivery settings:', error);
                alert('Failed to save delivery settings: ' + error.message);
            }
        }

        // ============================================
        // BUSINESS DETAILS FORM (for invoices)
        // ============================================
        let cachedBusinessInfo = null;

        function toggleVatNumberField() {
            const isVatRegistered = document.getElementById('bizVatRegisteredYes').checked;
            document.getElementById('bizVatNumberRow').style.display = isVatRegistered ? '' : 'none';
            updateBusinessPreview();
        }

        async function loadBusinessDetailsForm() {
            try {
                const response = await fetch(`${API_BASE}/business-info`);
                const data = await response.json();

                if (data.success && data.business) {
                    const biz = data.business;
                    cachedBusinessInfo = biz;

                    document.getElementById('bizBusinessName').value = biz.business_name || '';
                    document.getElementById('bizAddressLine1').value = biz.address_line1 || '';
                    document.getElementById('bizAddressLine2').value = biz.address_line2 || '';
                    document.getElementById('bizAddressCity').value = biz.address_city || '';
                    document.getElementById('bizAddressPostal').value = biz.address_postal || '';
                    document.getElementById('bizPhone').value = biz.phone || '';
                    document.getElementById('bizEmail').value = biz.email || '';
                    document.getElementById('bizWebsite').value = biz.website || '';

                    // VAT registration status
                    const isVatRegistered = biz.vat_registered === 'true' || biz.vat_registered === true;
                    document.getElementById('bizVatRegisteredYes').checked = isVatRegistered;
                    document.getElementById('bizVatRegisteredNo').checked = !isVatRegistered;
                    document.getElementById('bizVatNumberRow').style.display = isVatRegistered ? '' : 'none';
                    document.getElementById('bizVatNumber').value = biz.vat_number || '';

                    updateBusinessPreview();
                }
            } catch (error) {
                console.error('Error loading business details:', error);
            }
        }

        function updateBusinessPreview() {
            const name = document.getElementById('bizBusinessName').value || 'Flirt Hair & Beauty Bar';
            const line1 = document.getElementById('bizAddressLine1').value || '';
            const line2 = document.getElementById('bizAddressLine2').value || '';
            const city = document.getElementById('bizAddressCity').value || '';
            const postal = document.getElementById('bizAddressPostal').value || '';
            const phone = document.getElementById('bizPhone').value || '';
            const email = document.getElementById('bizEmail').value || '';
            const website = document.getElementById('bizWebsite').value || '';
            const isVatRegistered = document.getElementById('bizVatRegisteredYes').checked;
            const vatNumber = document.getElementById('bizVatNumber').value || '';

            document.getElementById('bizPreviewName').textContent = name;
            document.getElementById('bizPreviewLine1').textContent = line1;
            document.getElementById('bizPreviewLine2').textContent = line2;

            let cityPostal = city;
            if (postal) cityPostal += (city ? ', ' : '') + postal;
            document.getElementById('bizPreviewCity').textContent = cityPostal;

            // VAT display
            const vatDiv = document.getElementById('bizPreviewVat');
            if (isVatRegistered && vatNumber) {
                vatDiv.style.display = '';
                document.getElementById('bizPreviewVatNum').textContent = vatNumber;
            } else {
                vatDiv.style.display = 'none';
            }

            // Contact info
            const contactParts = [];
            if (phone) contactParts.push(`Tel: ${phone}`);
            if (email) contactParts.push(email);
            if (website) contactParts.push(website);
            document.getElementById('bizPreviewContact').textContent = contactParts.join(' | ');
        }

        async function saveBusinessDetailsForm() {
            const isVatRegistered = document.getElementById('bizVatRegisteredYes').checked;

            const payload = {
                business_name: document.getElementById('bizBusinessName').value.trim(),
                address_line1: document.getElementById('bizAddressLine1').value.trim(),
                address_line2: document.getElementById('bizAddressLine2').value.trim(),
                address_city: document.getElementById('bizAddressCity').value.trim(),
                address_postal: document.getElementById('bizAddressPostal').value.trim(),
                vat_registered: isVatRegistered ? 'true' : 'false',
                vat_number: isVatRegistered ? document.getElementById('bizVatNumber').value.trim() : '',
                phone: document.getElementById('bizPhone').value.trim(),
                email: document.getElementById('bizEmail').value.trim(),
                website: document.getElementById('bizWebsite').value.trim()
            };

            // Validate email if provided
            if (payload.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(payload.email)) {
                showAdminToast('Please enter a valid email address', 'error');
                return;
            }

            // Validate VAT number if registered
            if (isVatRegistered && !payload.vat_number) {
                showAdminToast('Please enter a VAT number', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/business-settings`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                if (data.success) {
                    cachedBusinessInfo = payload;
                    showAdminToast('Business details saved successfully!', 'success');
                } else {
                    throw new Error(data.error || 'Failed to save');
                }
            } catch (error) {
                console.error('Error saving business details:', error);
                showAdminToast('Failed to save business details: ' + error.message, 'error');
            }
        }

        // Get cached business info for invoices (fetches if not cached)
        async function getBusinessInfo() {
            if (cachedBusinessInfo) return cachedBusinessInfo;

            try {
                const response = await fetch(`${API_BASE}/business-info`);
                const data = await response.json();
                if (data.success && data.business) {
                    cachedBusinessInfo = data.business;
                    return cachedBusinessInfo;
                }
            } catch (error) {
                console.error('Error fetching business info:', error);
            }

            // Return defaults if fetch fails
            return {
                business_name: 'Flirt Hair & Beauty Bar',
                address_line1: 'Shop 5, Lifestyle Centre',
                address_line2: 'Corner Witkoppen & Cedar Road',
                address_city: 'Fourways, Johannesburg',
                address_postal: '2191',
                vat_registered: 'false',
                vat_number: '',
                phone: '',
                email: '',
                website: ''
            };
        }

        // Add input listeners for live preview
        document.addEventListener('DOMContentLoaded', function() {
            const bizFields = ['bizBusinessName', 'bizAddressLine1', 'bizAddressLine2', 'bizAddressCity',
                              'bizAddressPostal', 'bizVatNumber', 'bizPhone', 'bizEmail', 'bizWebsite'];
            bizFields.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', updateBusinessPreview);
            });
        });

        function navigateToSection(sectionId) {
            showSection(sectionId);
        }

        document.addEventListener('DOMContentLoaded', async function() {
            const today = new Date().toISOString().split('T')[0];
            document.querySelectorAll('input[type="date"]').forEach(input => {
                if (!input.value) input.value = today;
            });

            const isAuthed = await checkAdminAuth();
            if (isAuthed) {
                initDashboard();
                // Load pending orders count for nav badge
                updatePendingOrdersBadge([], false);
            }
        });

        // ============================================
        // INVOICING SYSTEM JAVASCRIPT
        // ============================================

        // Notification system for invoice operations
        function showNotification(message, type = 'info') {
            // Remove any existing notifications
            const existing = document.getElementById('invoice-notification');
            if (existing) existing.remove();

            // Create notification element
            const notification = document.createElement('div');
            notification.id = 'invoice-notification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                min-width: 300px;
                max-width: 500px;
                padding: 16px 20px;
                background: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                display: flex;
                align-items: center;
                gap: 12px;
                animation: slideIn 0.3s ease-out;
            `;

            // Set border and icon based on type
            const colors = {
                success: { border: '#4CAF50', icon: '✓' },
                error: { border: '#e74c3c', icon: '✕' },
                warning: { border: '#FF9800', icon: '⚠' },
                info: { border: '#2196F3', icon: 'ℹ' }
            };

            const config = colors[type] || colors.info;
            notification.style.borderLeft = `4px solid ${config.border}`;

            // Add icon
            const icon = document.createElement('span');
            icon.style.cssText = `
                font-size: 20px;
                font-weight: bold;
                color: ${config.border};
            `;
            icon.textContent = config.icon;

            // Add message
            const messageEl = document.createElement('span');
            messageEl.style.cssText = 'flex: 1; color: var(--brand-charcoal);';
            messageEl.textContent = message;

            // Add close button
            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = '×';
            closeBtn.style.cssText = `
                background: none;
                border: none;
                font-size: 24px;
                color: #999;
                cursor: pointer;
                padding: 0;
                width: 24px;
                height: 24px;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            closeBtn.onclick = () => notification.remove();

            notification.appendChild(icon);
            notification.appendChild(messageEl);
            notification.appendChild(closeBtn);

            // Add animation styles if not already present
            if (!document.getElementById('notification-styles')) {
                const style = document.createElement('style');
                style.id = 'notification-styles';
                style.textContent = `
                    @keyframes slideIn {
                        from {
                            transform: translateX(400px);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0);
                            opacity: 1;
                        }
                    }
                `;
                document.head.appendChild(style);
            }

            document.body.appendChild(notification);

            // Auto-remove after 4 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.animation = 'slideIn 0.3s ease-out reverse';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 4000);
        }

        // Global variables for invoice management
        let currentInvoice = {
            services: [],
            products: [],
            customer_type: 'individual', // 'individual' or 'company'
            company_name: '',
            business_address: '',
            vat_number: '',
            company_reg: '',
            totals: {
                services_subtotal: 0,
                products_subtotal: 0,
                subtotal: 0,
                discount_amount: 0,
                tax_amount: 0,
                total: 0,
                commission: 0
            }
        };

        let invoiceServices = [];
        let invoiceProducts = [];
        let invoiceStylists = [];
        let invoiceCustomers = [];
        let currentPaymentInvoice = null;

        // Customer type toggle for invoices
        function setCustomerType(type) {
            currentInvoice.customer_type = type;

            const individualBtn = document.getElementById('customer-type-individual');
            const companyBtn = document.getElementById('customer-type-company');
            const companySection = document.getElementById('company-details-section');
            const companyNameInput = document.getElementById('invoice-company-name');

            if (type === 'company') {
                // Style company button as active
                companyBtn.style.borderColor = 'var(--brand-pink)';
                companyBtn.style.background = 'var(--brand-pink)';
                companyBtn.style.color = 'white';
                // Style individual button as inactive
                individualBtn.style.borderColor = 'var(--border-soft)';
                individualBtn.style.background = 'white';
                individualBtn.style.color = 'var(--brand-charcoal)';
                // Show company details
                companySection.style.display = 'block';
                // Make company name required
                if (companyNameInput) companyNameInput.required = true;
            } else {
                // Style individual button as active
                individualBtn.style.borderColor = 'var(--brand-pink)';
                individualBtn.style.background = 'var(--brand-pink)';
                individualBtn.style.color = 'white';
                // Style company button as inactive
                companyBtn.style.borderColor = 'var(--border-soft)';
                companyBtn.style.background = 'white';
                companyBtn.style.color = 'var(--brand-charcoal)';
                // Hide company details
                companySection.style.display = 'none';
                // Remove required from company name
                if (companyNameInput) companyNameInput.required = false;
            }
        }

        // Reset customer type form to individual
        function resetCustomerType() {
            setCustomerType('individual');
            // Clear company fields
            const companyName = document.getElementById('invoice-company-name');
            const businessAddress = document.getElementById('invoice-business-address');
            const vatNumber = document.getElementById('invoice-vat-number');
            const companyReg = document.getElementById('invoice-company-reg');
            if (companyName) companyName.value = '';
            if (businessAddress) businessAddress.value = '';
            if (vatNumber) vatNumber.value = '';
            if (companyReg) companyReg.value = '';
        }

        // Load invoices
        async function loadInvoices() {
            try {
                const search = document.getElementById('invoice-search')?.value || '';
                const status = document.getElementById('invoice-status-filter')?.value || '';
                const payment_status = document.getElementById('invoice-payment-filter')?.value || '';
                const stylist_id = document.getElementById('invoice-stylist-filter')?.value || '';

                const params = new URLSearchParams();
                if (search) params.append('search', search);
                if (status) params.append('status', status);
                if (payment_status) params.append('payment_status', payment_status);
                if (stylist_id) params.append('stylist_id', stylist_id);

                const response = await fetch(`/api/admin/invoices?${params}`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });

                const data = await response.json();

                if (data.success) {
                    renderInvoiceList(data.invoices);
                    updateUnpaidBadge(data.invoices);
                }
            } catch (error) {
                console.error('Error loading invoices:', error);
                if (typeof showNotification === 'function') showNotification('Failed to load invoices', 'error');
            }
        }

        function renderInvoiceList(invoices) {
            const container = document.getElementById('invoice-list-container');

            // Update stats
            updateInvoiceStats(invoices);

            if (!invoices || invoices.length === 0) {
                container.innerHTML = `
                    <div class="invoice-empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <h3>No invoices found</h3>
                        <p>Create your first invoice to get started</p>
                        <button class="btn btn-primary" onclick="showCreateInvoice()">
                            <svg style="width:16px;height:16px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            Create Invoice
                        </button>
                    </div>
                `;
                return;
            }

            const html = `
                <table class="invoice-table">
                    <thead>
                        <tr>
                            <th>Invoice</th>
                            <th>Customer</th>
                            <th>Date</th>
                            <th>Amount</th>
                            <th>Payment</th>
                            <th>Status</th>
                            <th style="width: 120px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${invoices.map(inv => {
                            const initials = (inv.customer_name || 'U').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
                            return `
                            <tr>
                                <td>
                                    <span class="invoice-number">${inv.invoice_number || 'DRAFT'}</span>
                                </td>
                                <td>
                                    <div class="invoice-customer">
                                        <div class="invoice-customer-avatar">${initials}</div>
                                        <div class="invoice-customer-info">
                                            <div class="name">${inv.customer_name || 'Unknown'}</div>
                                            <div class="email">${inv.stylist_name || ''}</div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="invoice-date">${inv.service_date ? new Date(inv.service_date).toLocaleDateString('en-ZA', { day: 'numeric', month: 'short', year: 'numeric' }) : 'N/A'}</span>
                                </td>
                                <td>
                                    <span class="invoice-amount">R${(inv.total || 0).toFixed(2)}</span>
                                </td>
                                <td>
                                    <span class="payment-status ${inv.payment_status}">
                                        <span class="payment-status-dot"></span>
                                        ${inv.payment_status.charAt(0).toUpperCase() + inv.payment_status.slice(1)}
                                    </span>
                                    ${inv.payment_status === 'partial' ? `<div style="font-size:11px;color:var(--text-subtle);margin-top:4px;">R${(inv.amount_paid || 0).toFixed(2)} paid</div>` : ''}
                                </td>
                                <td>
                                    <span class="invoice-status ${inv.status}">
                                        ${inv.status.charAt(0).toUpperCase() + inv.status.slice(1)}
                                    </span>
                                </td>
                                <td>
                                    <div class="invoice-actions">
                                        <button class="invoice-action-btn" onclick="viewInvoice('${inv.id}')" title="View">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                                <circle cx="12" cy="12" r="3"></circle>
                                            </svg>
                                        </button>
                                        ${inv.status === 'finalized' ? `
                                            <button class="invoice-action-btn" onclick="printInvoiceById('${inv.id}')" title="Print">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M6 9V2h12v7M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"></path>
                                                    <rect x="6" y="14" width="12" height="8"></rect>
                                                </svg>
                                            </button>
                                        ` : ''}
                                        ${inv.payment_status !== 'paid' && inv.status === 'finalized' ? `
                                            <button class="invoice-action-btn" onclick="showPaymentModal('${inv.id}')" title="Record Payment" style="color:var(--success);">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <line x1="12" y1="1" x2="12" y2="23"></line>
                                                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                                                </svg>
                                            </button>
                                        ` : ''}
                                        ${inv.status === 'draft' ? `
                                            <button class="invoice-action-btn" onclick="editInvoice('${inv.id}')" title="Edit">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                                </svg>
                                            </button>
                                            <button class="invoice-action-btn danger" onclick="deleteInvoice('${inv.id}')" title="Delete">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <polyline points="3 6 5 6 21 6"></polyline>
                                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                                </svg>
                                            </button>
                                        ` : ''}
                                    </div>
                                </td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        // Update invoice stats cards
        function updateInvoiceStats(invoices) {
            const totalInvoices = invoices.length;
            const paidInvoices = invoices.filter(i => i.payment_status === 'paid');
            const unpaidInvoices = invoices.filter(i => i.payment_status !== 'paid' && i.status === 'finalized');

            const totalRevenue = paidInvoices.reduce((sum, i) => sum + (i.total || 0), 0);
            const pendingAmount = unpaidInvoices.reduce((sum, i) => sum + ((i.total || 0) - (i.amount_paid || 0)), 0);
            const totalCommissions = invoices.reduce((sum, i) => sum + (i.commission || 0), 0);

            document.getElementById('stat-total-invoices').textContent = totalInvoices;
            document.getElementById('stat-total-revenue').textContent = `R${totalRevenue.toLocaleString('en-ZA', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
            document.getElementById('stat-pending-amount').textContent = `R${pendingAmount.toLocaleString('en-ZA', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
            document.getElementById('stat-pending-count').textContent = unpaidInvoices.length;
            document.getElementById('stat-commissions').textContent = `R${totalCommissions.toLocaleString('en-ZA', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
        }

        // Debounce invoice search
        let invoiceSearchTimeout = null;
        function debounceInvoiceSearch() {
            if (invoiceSearchTimeout) clearTimeout(invoiceSearchTimeout);
            invoiceSearchTimeout = setTimeout(() => loadInvoices(), 300);
        }

        // Export invoices placeholder
        function exportInvoices() {
            showAdminToast('Export feature coming soon', 'info');
        }

        // View invoice details
        let currentViewInvoiceId = null;

        async function viewInvoice(id) {
            try {
                currentViewInvoiceId = id;
                const response = await fetch(`${API_BASE}/admin/invoices/${id}`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });

                if (!response.ok) throw new Error('Failed to load invoice');

                const data = await response.json();
                const invoice = data.invoice;

                // Populate business info from dynamic settings
                const biz = await getBusinessInfo();
                document.getElementById('view-invoice-biz-name').textContent = biz.business_name || 'Flirt Hair & Beauty Bar';
                document.getElementById('view-invoice-biz-line1').textContent = biz.address_line1 || '';
                document.getElementById('view-invoice-biz-line2').textContent = biz.address_line2 || '';
                let cityPostal = biz.address_city || '';
                if (biz.address_postal) cityPostal += (cityPostal ? ', ' : '') + biz.address_postal;
                document.getElementById('view-invoice-biz-city').textContent = cityPostal;

                // VAT display
                const vatDiv = document.getElementById('view-invoice-biz-vat');
                if (biz.vat_registered === 'true' && biz.vat_number) {
                    vatDiv.textContent = `VAT No: ${biz.vat_number}`;
                    vatDiv.style.display = '';
                } else {
                    vatDiv.style.display = 'none';
                }

                // Populate header
                document.getElementById('view-invoice-number').textContent = invoice.invoice_number || `Draft #${invoice.id.slice(0, 8)}`;
                document.getElementById('view-invoice-date').textContent = formatDate(invoice.created_at);
                document.getElementById('view-invoice-status').textContent = invoice.status.charAt(0).toUpperCase() + invoice.status.slice(1);

                // Customer info
                document.getElementById('view-invoice-customer').textContent = invoice.customer?.name || 'Walk-in Customer';
                document.getElementById('view-invoice-customer-email').textContent = invoice.customer?.email || '';
                document.getElementById('view-invoice-customer-phone').textContent = invoice.customer?.phone || '';

                // Stylist info
                document.getElementById('view-invoice-stylist').textContent = invoice.stylist?.name || 'Not assigned';
                document.getElementById('view-invoice-service-date').textContent = invoice.service_date ? `Service: ${formatDate(invoice.service_date)}` : '';

                // Render services
                const servicesHtml = (invoice.services || []).map(s => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-bottom: 1px solid var(--border-soft);">
                        <div>
                            <div style="font-weight: 500;">${s.service_name}</div>
                            ${s.quantity > 1 ? `<div style="font-size: 12px; color: var(--text-muted);">Qty: ${s.quantity}</div>` : ''}
                        </div>
                        <div style="font-weight: 600;">R${parseFloat(s.line_total || s.unit_price * s.quantity).toFixed(2)}</div>
                    </div>
                `).join('') || '<div style="padding: 16px; text-align: center; color: var(--text-muted);">No services</div>';
                document.getElementById('view-invoice-services').innerHTML = servicesHtml;

                // Render products (if any)
                const productsSection = document.getElementById('view-invoice-products-section');
                if (invoice.products && invoice.products.length > 0) {
                    productsSection.style.display = 'block';
                    const productsHtml = invoice.products.map(p => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-bottom: 1px solid var(--border-soft);">
                            <div>
                                <div style="font-weight: 500;">${p.product_name}</div>
                                <div style="font-size: 12px; color: var(--text-muted);">Qty: ${p.quantity} @ R${parseFloat(p.unit_price).toFixed(2)}</div>
                            </div>
                            <div style="font-weight: 600;">R${parseFloat(p.line_total || p.unit_price * p.quantity).toFixed(2)}</div>
                        </div>
                    `).join('');
                    document.getElementById('view-invoice-products').innerHTML = productsHtml;
                } else {
                    productsSection.style.display = 'none';
                }

                // Render totals
                let totalsHtml = `
                    <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-soft);">
                        <span>Services Subtotal</span>
                        <span>R${parseFloat(invoice.services_subtotal || 0).toFixed(2)}</span>
                    </div>
                `;
                if (invoice.products_subtotal > 0) {
                    totalsHtml += `
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-soft);">
                            <span>Products Subtotal</span>
                            <span>R${parseFloat(invoice.products_subtotal).toFixed(2)}</span>
                        </div>
                    `;
                }
                if (invoice.discount_amount > 0) {
                    totalsHtml += `
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-soft); color: var(--success);">
                            <span>Discount ${invoice.discount_reason ? `(${invoice.discount_reason})` : ''}</span>
                            <span>-R${parseFloat(invoice.discount_amount).toFixed(2)}</span>
                        </div>
                    `;
                }
                if (invoice.tax_amount > 0) {
                    totalsHtml += `
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-soft);">
                            <span>VAT (15%)</span>
                            <span>R${parseFloat(invoice.tax_amount).toFixed(2)}</span>
                        </div>
                    `;
                }
                totalsHtml += `
                    <div style="display: flex; justify-content: space-between; padding: 12px 0; font-size: 18px; font-weight: 700; color: var(--brand-pink);">
                        <span>TOTAL</span>
                        <span>R${parseFloat(invoice.total).toFixed(2)}</span>
                    </div>
                `;
                if (invoice.amount_paid > 0 && invoice.payment_status !== 'paid') {
                    totalsHtml += `
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; color: var(--text-muted);">
                            <span>Amount Paid</span>
                            <span>R${parseFloat(invoice.amount_paid).toFixed(2)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; font-weight: 600; color: var(--warning);">
                            <span>Balance Due</span>
                            <span>R${(parseFloat(invoice.total) - parseFloat(invoice.amount_paid)).toFixed(2)}</span>
                        </div>
                    `;
                }
                document.getElementById('view-invoice-totals').innerHTML = totalsHtml;

                // Payment status badge
                const paymentStatusBadge = document.getElementById('view-invoice-payment-status');
                const paymentColors = {
                    'unpaid': { bg: '#f8d7da', color: '#721c24' },
                    'partial': { bg: '#fff3cd', color: '#856404' },
                    'paid': { bg: '#d4edda', color: '#155724' },
                    'refunded': { bg: '#e2e3e5', color: '#383d41' }
                };
                const paymentStyle = paymentColors[invoice.payment_status] || paymentColors.unpaid;
                paymentStatusBadge.textContent = invoice.payment_status.charAt(0).toUpperCase() + invoice.payment_status.slice(1);
                paymentStatusBadge.style.background = paymentStyle.bg;
                paymentStatusBadge.style.color = paymentStyle.color;

                // Render payments
                const paymentsContainer = document.getElementById('view-invoice-payments');
                if (invoice.payments && invoice.payments.length > 0) {
                    const paymentsHtml = invoice.payments.map(p => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-bottom: 1px solid var(--border-soft);">
                            <div>
                                <div style="font-weight: 500;">R${parseFloat(p.amount).toFixed(2)}</div>
                                <div style="font-size: 12px; color: var(--text-muted);">${p.payment_method} ${p.reference ? `• ${p.reference}` : ''}</div>
                            </div>
                            <div style="font-size: 13px; color: var(--text-muted);">${formatDate(p.payment_date)}</div>
                        </div>
                    `).join('');
                    paymentsContainer.innerHTML = paymentsHtml;
                } else {
                    paymentsContainer.innerHTML = '<div style="padding: 16px; text-align: center; color: var(--text-muted);">No payments recorded</div>';
                }

                // Show/hide record payment button
                const recordPaymentBtn = document.getElementById('view-invoice-record-payment-btn');
                if (invoice.status === 'finalized' && invoice.payment_status !== 'paid') {
                    recordPaymentBtn.style.display = 'inline-flex';
                } else {
                    recordPaymentBtn.style.display = 'none';
                }

                // Notes section
                const notesSection = document.getElementById('view-invoice-notes-section');
                const notesDiv = document.getElementById('view-invoice-notes');
                if (invoice.client_notes || invoice.internal_notes) {
                    notesSection.style.display = 'block';
                    let notesHtml = '';
                    if (invoice.client_notes) {
                        notesHtml += `<div><strong>Client Notes:</strong> ${invoice.client_notes}</div>`;
                    }
                    if (invoice.internal_notes) {
                        notesHtml += `<div style="margin-top: 8px;"><strong>Internal:</strong> ${invoice.internal_notes}</div>`;
                    }
                    notesDiv.innerHTML = notesHtml;
                } else {
                    notesSection.style.display = 'none';
                }

                // Show modal
                const modal = document.getElementById('view-invoice-modal');
                modal.style.display = 'flex';
                modal.classList.add('show');

            } catch (error) {
                console.error('Error loading invoice:', error);
                showAdminToast('Failed to load invoice details', 'error');
            }
        }

        function closeViewInvoiceModal() {
            const modal = document.getElementById('view-invoice-modal');
            modal.style.display = 'none';
            modal.classList.remove('show');
            currentViewInvoiceId = null;
        }

        function recordPaymentFromView() {
            if (currentViewInvoiceId) {
                closeViewInvoiceModal();
                showPaymentModal(currentViewInvoiceId);
            }
        }

        // Print invoice directly by ID (from list view)
        async function printInvoiceById(id) {
            try {
                const response = await fetch(`${API_BASE}/admin/invoices/${id}`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });

                if (!response.ok) throw new Error('Failed to load invoice');

                const data = await response.json();
                const invoice = data.invoice;

                await generatePrintableInvoice(invoice);
            } catch (error) {
                console.error('Print invoice error:', error);
                showAdminToast('Failed to load invoice for printing', 'error');
            }
        }

        async function printInvoice() {
            if (!currentViewInvoiceId) return;

            // Get business info for print
            const biz = await getBusinessInfo();
            const bizName = biz.business_name || 'Flirt Hair & Beauty Bar';
            let bizAddress = '';
            if (biz.address_line1) bizAddress += biz.address_line1 + '<br>';
            if (biz.address_line2) bizAddress += biz.address_line2 + '<br>';
            let cityPostal = biz.address_city || '';
            if (biz.address_postal) cityPostal += (cityPostal ? ', ' : '') + biz.address_postal;
            if (cityPostal) bizAddress += cityPostal + '<br>';
            const vatHtml = (biz.vat_registered === 'true' && biz.vat_number)
                ? `<div class="vat-number">VAT No: ${biz.vat_number}</div>`
                : '';

            // Build footer contact info
            const contactParts = [];
            if (biz.phone) contactParts.push(`Tel: ${biz.phone}`);
            if (biz.email) contactParts.push(biz.email);
            if (biz.website) contactParts.push(biz.website);
            const footerContact = contactParts.length > 0 ? contactParts.join(' | ') : '';

            // Open print-friendly version in new window
            const printWindow = window.open('', '_blank');
            const invoiceNumber = document.getElementById('view-invoice-number').textContent;
            const invoiceDate = document.getElementById('view-invoice-date').textContent;
            const customer = document.getElementById('view-invoice-customer').textContent;
            const customerEmail = document.getElementById('view-invoice-customer-email').textContent;
            const customerPhone = document.getElementById('view-invoice-customer-phone').textContent;
            const stylist = document.getElementById('view-invoice-stylist').textContent;
            const servicesHtml = document.getElementById('view-invoice-services').innerHTML;
            const productsSection = document.getElementById('view-invoice-products-section');
            const productsHtml = productsSection.style.display !== 'none' ? document.getElementById('view-invoice-products').innerHTML : '';
            const totalsHtml = document.getElementById('view-invoice-totals').innerHTML;

            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Invoice ${invoiceNumber}</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { font-family: Arial, sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; }
                        .header { display: flex; justify-content: space-between; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 2px solid #F67599; }
                        .logo { font-size: 28px; font-weight: bold; color: #F67599; }
                        .invoice-info { text-align: right; }
                        .invoice-number { font-size: 20px; font-weight: bold; }
                        .details { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 30px; }
                        .label { font-size: 11px; text-transform: uppercase; color: #666; margin-bottom: 4px; }
                        .value { font-weight: 600; }
                        .section { margin-bottom: 24px; }
                        .section-title { font-size: 12px; text-transform: uppercase; color: #666; margin-bottom: 12px; }
                        .items { border: 1px solid #ddd; border-radius: 4px; }
                        .item { display: flex; justify-content: space-between; padding: 12px 16px; border-bottom: 1px solid #eee; }
                        .item:last-child { border-bottom: none; }
                        .totals { background: #f5f5f5; padding: 16px; border-radius: 4px; }
                        .total-row { display: flex; justify-content: space-between; padding: 6px 0; }
                        .total-row.grand { font-size: 18px; font-weight: bold; color: #F67599; padding-top: 12px; border-top: 1px solid #ddd; margin-top: 8px; }
                        .business-info { font-size: 13px; color: #666; line-height: 1.5; }
                        .vat-number { margin-top: 8px; font-size: 12px; }
                        .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; font-size: 12px; color: #888; }
                        @media print { body { padding: 20px; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div>
                            <div class="logo">FLIRT</div>
                            <div class="business-info">
                                ${bizAddress}
                                ${vatHtml}
                            </div>
                        </div>
                        <div class="invoice-info">
                            <div class="invoice-number">${invoiceNumber}</div>
                            <div>${invoiceDate}</div>
                        </div>
                    </div>
                    <div class="details">
                        <div>
                            <div class="label">Bill To</div>
                            <div class="value">${customer}</div>
                            ${customerEmail ? `<div>${customerEmail}</div>` : ''}
                            ${customerPhone ? `<div>${customerPhone}</div>` : ''}
                        </div>
                        <div>
                            <div class="label">Stylist</div>
                            <div class="value">${stylist}</div>
                        </div>
                    </div>
                    <div class="section">
                        <div class="section-title">Services</div>
                        <div class="items">${servicesHtml}</div>
                    </div>
                    ${productsHtml ? `
                    <div class="section">
                        <div class="section-title">Products</div>
                        <div class="items">${productsHtml}</div>
                    </div>
                    ` : ''}
                    <div class="totals">${totalsHtml}</div>
                    <div class="footer">
                        Thank you for choosing ${bizName}!<br>
                        ${footerContact}
                    </div>
                    <script>window.onload = function() { window.print(); }<\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        // Generate printable invoice from invoice object (used by printInvoiceById)
        async function generatePrintableInvoice(invoice) {
            // Get business info for print
            const biz = await getBusinessInfo();
            const bizName = biz.business_name || 'Flirt Hair & Beauty Bar';
            let bizAddress = '';
            if (biz.address_line1) bizAddress += biz.address_line1 + '<br>';
            if (biz.address_line2) bizAddress += biz.address_line2 + '<br>';
            let cityPostal = biz.address_city || '';
            if (biz.address_postal) cityPostal += (cityPostal ? ', ' : '') + biz.address_postal;
            if (cityPostal) bizAddress += cityPostal + '<br>';
            const vatHtml = (biz.vat_registered === 'true' && biz.vat_number)
                ? `<div class="vat-number">VAT No: ${biz.vat_number}</div>`
                : '';

            // Build footer contact info
            const contactParts = [];
            if (biz.phone) contactParts.push(`Tel: ${biz.phone}`);
            if (biz.email) contactParts.push(biz.email);
            if (biz.website) contactParts.push(biz.website);
            const footerContact = contactParts.length > 0 ? contactParts.join(' | ') : '';

            const printWindow = window.open('', '_blank');

            const invoiceNumber = invoice.invoice_number || `Draft #${invoice.id.slice(0, 8)}`;
            const invoiceDate = formatDate(invoice.created_at);
            const customer = invoice.customer?.name || 'Walk-in Customer';
            const customerEmail = invoice.customer?.email || '';
            const customerPhone = invoice.customer?.phone || '';
            const stylist = invoice.stylist?.name || 'Not assigned';

            // Build services HTML
            const servicesHtml = (invoice.services || []).map(s => `
                <div style="display: flex; justify-content: space-between; padding: 12px 16px; border-bottom: 1px solid #eee;">
                    <div>
                        <div style="font-weight: 500;">${s.service_name}</div>
                        ${s.quantity > 1 ? `<div style="font-size: 12px; color: #666;">Qty: ${s.quantity}</div>` : ''}
                    </div>
                    <div style="font-weight: 600;">R${parseFloat(s.line_total || s.unit_price * s.quantity).toFixed(2)}</div>
                </div>
            `).join('') || '<div style="padding: 16px; text-align: center; color: #666;">No services</div>';

            // Build products HTML
            const productsHtml = (invoice.products && invoice.products.length > 0) ? invoice.products.map(p => `
                <div style="display: flex; justify-content: space-between; padding: 12px 16px; border-bottom: 1px solid #eee;">
                    <div>
                        <div style="font-weight: 500;">${p.product_name}</div>
                        <div style="font-size: 12px; color: #666;">Qty: ${p.quantity} @ R${parseFloat(p.unit_price).toFixed(2)}</div>
                    </div>
                    <div style="font-weight: 600;">R${parseFloat(p.line_total || p.unit_price * p.quantity).toFixed(2)}</div>
                </div>
            `).join('') : '';

            // Build totals HTML
            let totalsHtml = `
                <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #eee;">
                    <span>Services Subtotal</span>
                    <span>R${parseFloat(invoice.services_subtotal || 0).toFixed(2)}</span>
                </div>
            `;
            if (invoice.products_subtotal > 0) {
                totalsHtml += `
                    <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #eee;">
                        <span>Products Subtotal</span>
                        <span>R${parseFloat(invoice.products_subtotal).toFixed(2)}</span>
                    </div>
                `;
            }
            if (invoice.discount_amount > 0) {
                totalsHtml += `
                    <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #eee; color: green;">
                        <span>Discount ${invoice.discount_reason ? `(${invoice.discount_reason})` : ''}</span>
                        <span>-R${parseFloat(invoice.discount_amount).toFixed(2)}</span>
                    </div>
                `;
            }
            if (invoice.tax_amount > 0) {
                totalsHtml += `
                    <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #eee;">
                        <span>VAT (15%)</span>
                        <span>R${parseFloat(invoice.tax_amount).toFixed(2)}</span>
                    </div>
                `;
            }
            totalsHtml += `
                <div style="display: flex; justify-content: space-between; padding: 12px 0; font-size: 18px; font-weight: bold; color: #F67599; border-top: 1px solid #ddd; margin-top: 8px;">
                    <span>TOTAL</span>
                    <span>R${parseFloat(invoice.total).toFixed(2)}</span>
                </div>
            `;

            // Company details for invoice (if company customer)
            let billToHtml = `
                <div class="value">${customer}</div>
                ${customerEmail ? `<div>${customerEmail}</div>` : ''}
                ${customerPhone ? `<div>${customerPhone}</div>` : ''}
            `;
            if (invoice.customer_type === 'company' && invoice.company_name) {
                billToHtml = `
                    <div class="value">${invoice.company_name}</div>
                    <div>${customer}</div>
                    ${invoice.business_address ? `<div style="white-space: pre-line;">${invoice.business_address}</div>` : ''}
                    ${invoice.vat_number ? `<div>VAT: ${invoice.vat_number}</div>` : ''}
                    ${invoice.company_reg ? `<div>Reg: ${invoice.company_reg}</div>` : ''}
                    ${customerEmail ? `<div>${customerEmail}</div>` : ''}
                    ${customerPhone ? `<div>${customerPhone}</div>` : ''}
                `;
            }

            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Invoice ${invoiceNumber}</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { font-family: Arial, sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; }
                        .header { display: flex; justify-content: space-between; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 2px solid #F67599; }
                        .logo { font-size: 28px; font-weight: bold; color: #F67599; }
                        .invoice-info { text-align: right; }
                        .invoice-number { font-size: 20px; font-weight: bold; }
                        .details { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 30px; }
                        .label { font-size: 11px; text-transform: uppercase; color: #666; margin-bottom: 4px; }
                        .value { font-weight: 600; }
                        .section { margin-bottom: 24px; }
                        .section-title { font-size: 12px; text-transform: uppercase; color: #666; margin-bottom: 12px; }
                        .items { border: 1px solid #ddd; border-radius: 4px; }
                        .item { display: flex; justify-content: space-between; padding: 12px 16px; border-bottom: 1px solid #eee; }
                        .item:last-child { border-bottom: none; }
                        .totals { background: #f5f5f5; padding: 16px; border-radius: 4px; }
                        .business-info { font-size: 13px; color: #666; line-height: 1.5; }
                        .vat-number { margin-top: 8px; font-size: 12px; }
                        .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; font-size: 12px; color: #888; }
                        @media print { body { padding: 20px; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div>
                            <div class="logo">FLIRT</div>
                            <div class="business-info">
                                ${bizAddress}
                                ${vatHtml}
                            </div>
                        </div>
                        <div class="invoice-info">
                            <div class="invoice-number">${invoiceNumber}</div>
                            <div>${invoiceDate}</div>
                        </div>
                    </div>
                    <div class="details">
                        <div>
                            <div class="label">Bill To</div>
                            ${billToHtml}
                        </div>
                        <div>
                            <div class="label">Stylist</div>
                            <div class="value">${stylist}</div>
                        </div>
                    </div>
                    <div class="section">
                        <div class="section-title">Services</div>
                        <div class="items">${servicesHtml}</div>
                    </div>
                    ${productsHtml ? `
                    <div class="section">
                        <div class="section-title">Products</div>
                        <div class="items">${productsHtml}</div>
                    </div>
                    ` : ''}
                    <div class="totals">${totalsHtml}</div>
                    <div class="footer">
                        Thank you for choosing ${bizName}!<br>
                        ${footerContact}
                    </div>
                    <script>window.onload = function() { window.print(); }<\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        // Edit invoice
        async function editInvoice(id) {
            try {
                // Fetch the invoice details
                const response = await fetch(`/api/admin/invoices/${id}`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                const data = await response.json();

                if (!data.success || !data.invoice) {
                    showAdminToast('Invoice not found', 'error');
                    return;
                }

                const invoice = data.invoice;

                // Check if invoice is editable (only drafts can be edited)
                if (invoice.status !== 'draft') {
                    showAdminToast('Only draft invoices can be edited', 'warning');
                    return;
                }

                // Load picker data
                await Promise.all([
                    loadServicesForPicker(),
                    loadProductsForPicker(),
                    loadStylistsForInvoice(),
                    loadCustomersForInvoice()
                ]);

                // Set the current invoice for editing
                currentInvoice = {
                    id: invoice.id,
                    services: (invoice.services || []).map(s => ({
                        id: s.service_id || s.id,
                        name: s.service_name || s.name,
                        price: parseFloat(s.price) || 0,
                        quantity: s.quantity || 1,
                        stylistId: s.stylist_id,
                        stylistName: s.stylist_name
                    })),
                    products: (invoice.products || []).map(p => ({
                        id: p.product_id || p.id,
                        name: p.product_name || p.name,
                        price: parseFloat(p.price) || 0,
                        quantity: p.quantity || 1
                    })),
                    customer_type: invoice.customer_type || 'individual',
                    company_name: invoice.company_name || '',
                    business_address: invoice.business_address || '',
                    vat_number: invoice.vat_number || '',
                    company_reg: invoice.company_reg || '',
                    totals: {
                        services_subtotal: parseFloat(invoice.services_subtotal) || 0,
                        products_subtotal: parseFloat(invoice.products_subtotal) || 0,
                        subtotal: parseFloat(invoice.subtotal) || 0,
                        discount_amount: parseFloat(invoice.discount_amount) || 0,
                        tax_amount: parseFloat(invoice.tax_amount) || 0,
                        total: parseFloat(invoice.total) || 0,
                        commission: parseFloat(invoice.commission) || 0
                    }
                };

                // Populate form fields
                const customerSelect = document.getElementById('invoiceCustomerSelect');
                if (customerSelect && invoice.user_id) {
                    customerSelect.value = invoice.user_id;
                }

                const stylistSelect = document.getElementById('invoice-stylist');
                if (stylistSelect && invoice.stylist_id) {
                    stylistSelect.value = invoice.stylist_id;
                }

                const dateInput = document.getElementById('invoice-service-date');
                if (dateInput && invoice.service_date) {
                    dateInput.value = invoice.service_date.split('T')[0];
                }

                const notesInput = document.getElementById('invoice-notes');
                if (notesInput) {
                    notesInput.value = invoice.notes || '';
                }

                const discountInput = document.getElementById('invoice-discount');
                if (discountInput) {
                    discountInput.value = invoice.discount_amount || 0;
                }

                // Set customer type and populate company fields
                setCustomerType(invoice.customer_type || 'individual');
                if (invoice.customer_type === 'company') {
                    const companyNameInput = document.getElementById('invoice-company-name');
                    const businessAddressInput = document.getElementById('invoice-business-address');
                    const vatNumberInput = document.getElementById('invoice-vat-number');
                    const companyRegInput = document.getElementById('invoice-company-reg');
                    if (companyNameInput) companyNameInput.value = invoice.company_name || '';
                    if (businessAddressInput) businessAddressInput.value = invoice.business_address || '';
                    if (vatNumberInput) vatNumberInput.value = invoice.vat_number || '';
                    if (companyRegInput) companyRegInput.value = invoice.company_reg || '';
                }

                // Render services and products lists
                renderInvoiceServices();
                renderInvoiceProducts();
                calculateInvoiceTotals();

                // Update modal title and open
                document.getElementById('invoice-modal-title').textContent = 'Edit Invoice';
                const modal = document.getElementById('invoice-modal');
                modal.style.display = 'flex';
                modal.classList.add('show');

            } catch (error) {
                console.error('Error loading invoice for edit:', error);
                showAdminToast('Failed to load invoice', 'error');
            }
        }

        // Delete invoice
        async function deleteInvoice(id) {
            if (!confirm('Are you sure you want to delete this draft invoice?')) return;
            try {
                await fetch(`/api/admin/invoices/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                showAdminToast('Invoice deleted', 'success');
                loadInvoices();
            } catch (error) {
                console.error('Error deleting invoice:', error);
                showAdminToast('Failed to delete invoice', 'error');
            }
        }

        function getPaymentBadgeClass(status) {
            const classes = {
                'unpaid': 'danger',
                'partial': 'warning',
                'paid': 'success',
                'refunded': 'secondary'
            };
            return classes[status] || 'secondary';
        }

        function getStatusBadgeClass(status) {
            const classes = {
                'draft': 'secondary',
                'finalized': 'info',
                'sent': 'success',
                'cancelled': 'danger',
                'void': 'secondary'
            };
            return classes[status] || 'secondary';
        }

        // Update pending orders badge in nav
        async function updatePendingOrdersBadge(orders, isUnfiltered) {
            let pendingCount;

            if (isUnfiltered) {
                // If we already have unfiltered data, count from it
                pendingCount = orders.filter(o =>
                    ['pending', 'processing'].includes((o.status || '').toLowerCase())
                ).length;
            } else {
                // Fetch unfiltered count from API
                try {
                    const data = await apiCall('/admin/orders?status=pending');
                    const processingData = await apiCall('/admin/orders?status=processing');
                    pendingCount = (data.orders?.length || 0) + (processingData.orders?.length || 0);
                } catch (e) {
                    pendingCount = 0;
                }
            }

            const badge = document.getElementById('pending-orders-count');
            if (badge) {
                if (pendingCount > 0) {
                    badge.textContent = pendingCount;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        function updateUnpaidBadge(invoices) {
            const unpaidCount = invoices.filter(inv =>
                inv.status === 'finalized' && inv.payment_status === 'unpaid'
            ).length;

            const badge = document.getElementById('unpaid-invoices-count');
            if (badge) {
                if (unpaidCount > 0) {
                    badge.textContent = unpaidCount;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        // Create invoice
        async function showCreateInvoice() {
            currentInvoice = {
                services: [],
                products: [],
                customer_type: 'individual',
                company_name: '',
                business_address: '',
                vat_number: '',
                company_reg: '',
                totals: { services_subtotal: 0, products_subtotal: 0, subtotal: 0, discount_amount: 0, tax_amount: 0, total: 0, commission: 0 }
            };

            await Promise.all([
                loadServicesForPicker(),
                loadProductsForPicker(),
                loadStylistsForInvoice(),
                loadCustomersForInvoice()
            ]);

            document.getElementById('invoice-service-date').valueAsDate = new Date();
            document.getElementById('invoice-form').reset();
            document.getElementById('invoice-services-list').innerHTML = '<p style="text-align: center; color: var(--text-subtle); padding: 20px;">No services added yet</p>';
            document.getElementById('invoice-products-list').innerHTML = '<p style="text-align: center; color: var(--text-subtle); padding: 20px;">No products added yet</p>';

            // Reset customer type to individual
            resetCustomerType();

            calculateInvoiceTotals();

            document.getElementById('invoice-modal-title').textContent = 'Create Invoice';
            const modal = document.getElementById('invoice-modal');
            modal.style.display = 'flex';
            modal.classList.add('show');
        }

        async function loadServicesForPicker() {
            try {
                // Load both hair and beauty services
                const [hairResponse, beautyResponse] = await Promise.all([
                    fetch('/api/services/hair', { headers: { 'Authorization': `Bearer ${getToken()}` } }),
                    fetch('/api/services/beauty', { headers: { 'Authorization': `Bearer ${getToken()}` } })
                ]);

                const hairData = await hairResponse.json();
                const beautyData = await beautyResponse.json();

                // Combine both service types
                invoiceServices = [
                    ...(hairData.services || []),
                    ...(beautyData.services || [])
                ];
            } catch (error) {
                console.error('Error loading services:', error);
                showNotification('Failed to load services. Please refresh and try again.', 'error');
            }
        }

        async function loadProductsForPicker() {
            try {
                const response = await fetch('/api/products', {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                const data = await response.json();
                invoiceProducts = data.products || [];
            } catch (error) {
                console.error('Error loading products:', error);
                showNotification('Failed to load products. Please refresh and try again.', 'error');
            }
        }

        async function loadStylistsForInvoice() {
            try {
                // Fetch from /api/stylists (Team section) instead of /api/admin/staff
                const response = await fetch('/api/stylists', {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                const data = await response.json();
                invoiceStylists = data.stylists || [];

                const stylistSelects = document.querySelectorAll('#invoice-stylist, #invoice-stylist-filter, #commission-stylist');
                stylistSelects.forEach(select => {
                    const currentValue = select.value;
                    const filterSelect = select.id === 'invoice-stylist-filter' || select.id === 'commission-stylist';

                    select.innerHTML = filterSelect ? '<option value="">All Stylists</option>' : '<option value="">Select stylist...</option>';

                    invoiceStylists.forEach(stylist => {
                        const option = document.createElement('option');
                        option.value = stylist.id;
                        option.textContent = stylist.name;
                        select.appendChild(option);
                    });

                    if (currentValue) select.value = currentValue;
                });
            } catch (error) {
                console.error('Error loading stylists:', error);
                showNotification('Failed to load stylists. Please refresh and try again.', 'error');
            }
        }

        async function loadCustomersForInvoice() {
            try {
                const response = await fetch('/api/admin/customers', {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });
                const data = await response.json();
                invoiceCustomers = data.customers || [];

                const customerSelect = document.getElementById('invoice-customer');
                customerSelect.innerHTML = '<option value="">Select customer...</option>';

                invoiceCustomers.forEach(customer => {
                    const option = document.createElement('option');
                    option.value = customer.id;
                    option.textContent = `${customer.name} (${customer.email})`;
                    customerSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading customers:', error);
                showNotification('Failed to load customers. Please refresh and try again.', 'error');
            }
        }

        // Service picker
        function showServicePicker() {
            renderServiceList(invoiceServices);
            const modal = document.getElementById('service-picker-modal');
            modal.style.display = 'flex';
            modal.classList.add('show');
        }

        function closeServicePicker() {
            const modal = document.getElementById('service-picker-modal');
            modal.classList.remove('show');
            modal.style.display = 'none';
        }

        function filterInvoiceServices() {
            const search = document.getElementById('service-search').value.toLowerCase();
            const filtered = invoiceServices.filter(s =>
                s.name.toLowerCase().includes(search) ||
                s.category?.toLowerCase().includes(search)
            );
            renderServiceList(filtered);
        }

        function renderServiceList(services) {
            const container = document.getElementById('service-list');

            if (services.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-subtle);">
                        <svg style="width:48px;height:48px;margin-bottom:12px;opacity:0.4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                        <p>No services found</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = services.map(service => `
                <div class="picker-item" onclick="addServiceToInvoice('${service.id}')">
                    <div class="picker-item-info">
                        <h5>${service.name}</h5>
                        <span>${service.category || 'General'} • ${service.duration || 60} min</span>
                    </div>
                    <div class="picker-item-price">R${(service.price || 0).toFixed(2)}</div>
                </div>
            `).join('');
        }

        function addServiceToInvoice(serviceId) {
            const service = invoiceServices.find(s => s.id === serviceId);
            if (!service) return;

            currentInvoice.services.push({
                service_id: service.id,
                service_name: service.name,
                service_category: service.category || 'General',
                unit_price: service.price,
                quantity: 1,
                discount: 0,
                total: service.price,
                commission_rate: service.commission_rate || null
            });

            renderInvoiceServices();
            calculateInvoiceTotals();
            closeServicePicker();
        }

        function renderInvoiceServices() {
            const container = document.getElementById('invoice-services-list');

            if (currentInvoice.services.length === 0) {
                container.innerHTML = `
                    <div class="invoice-line-items-empty">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="12"></line>
                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                        <p>No services added yet</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = currentInvoice.services.map((service, index) => `
                <div class="invoice-line-item">
                    <div class="invoice-line-item-info">
                        <h5>${service.service_name}</h5>
                        <span>${service.service_category}</span>
                    </div>
                    <div class="invoice-line-item-qty">
                        <span>Qty:</span>
                        <input type="number" value="${service.quantity}" min="1" onchange="updateServiceQty(${index}, this.value)">
                    </div>
                    <div class="invoice-line-item-price">R${service.total.toFixed(2)}</div>
                    <button type="button" class="invoice-line-item-remove" onclick="removeService(${index})">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
            `).join('');
        }

        function updateServiceQty(index, qty) {
            const service = currentInvoice.services[index];
            if (service) {
                service.quantity = Math.max(1, parseInt(qty) || 1);
                service.total = service.unit_price * service.quantity;
                renderInvoiceServices();
                calculateInvoiceTotals();
            }
        }

        function removeService(index) {
            currentInvoice.services.splice(index, 1);
            renderInvoiceServices();
            calculateInvoiceTotals();
        }

        // Product picker
        function showProductPicker() {
            renderProductList(invoiceProducts);
            const modal = document.getElementById('product-picker-modal');
            modal.style.display = 'flex';
            modal.classList.add('show');
        }

        function closeProductPicker() {
            const modal = document.getElementById('product-picker-modal');
            modal.classList.remove('show');
            modal.style.display = 'none';
        }

        function filterInvoiceProducts() {
            const search = document.getElementById('product-search').value.toLowerCase();
            const filtered = invoiceProducts.filter(p =>
                p.name.toLowerCase().includes(search) ||
                p.category?.toLowerCase().includes(search)
            );
            renderProductList(filtered);
        }

        function renderProductList(products) {
            const container = document.getElementById('product-list');

            if (products.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-subtle);">
                        <svg style="width:48px;height:48px;margin-bottom:12px;opacity:0.4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                        <p>No products found</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = products.map(product => {
                const stockClass = product.stock <= 0 ? 'out' : product.stock < 5 ? 'low' : '';
                const stockText = product.stock <= 0 ? 'Out of stock' : `${product.stock} in stock`;
                return `
                <div class="picker-item" onclick="showProductQuantityModal('${product.id}')">
                    <div class="picker-item-info">
                        <h5>${product.name}</h5>
                        <span>${product.category || 'General'}</span>
                    </div>
                    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;">
                        <div class="picker-item-price">R${(product.price || 0).toFixed(2)}</div>
                        <div class="picker-item-stock ${stockClass}">${stockText}</div>
                    </div>
                </div>
            `}).join('');
        }

        async function showProductQuantityModal(productId) {
            const product = invoiceProducts.find(p => p.id === productId);
            if (!product) return;

            // Use styled quantity input dialog
            const quantity = await openQuantityInput(product.name);
            if (!quantity) return;

            // Use styled product type selection dialog
            const productType = await openProductTypeDialog();
            if (!productType) return;

            // For service products, ask for custom amount
            let customPrice = null;
            if (productType === 'service_product') {
                customPrice = await openCustomAmountInput(product.name);
                if (customPrice === null) return; // User cancelled
            }

            addProductToInvoice(product, quantity, productType, customPrice);
        }

        function addProductToInvoice(product, quantity, productType, customPrice = null) {
            // Use custom price for service products, otherwise use product price
            const unitPrice = (productType === 'service_product' && customPrice !== null) ? customPrice : product.price;
            const total = unitPrice * quantity;

            currentInvoice.products.push({
                product_id: product.id,
                product_name: product.name,
                product_category: product.category || 'General',
                product_type: productType,
                unit_price: unitPrice,
                quantity: quantity,
                discount: 0,
                total: total,
                commission_rate: product.commission_rate || null
            });

            renderInvoiceProducts();
            calculateInvoiceTotals();
            closeProductPicker();
        }

        function renderInvoiceProducts() {
            const container = document.getElementById('invoice-products-list');

            if (currentInvoice.products.length === 0) {
                container.innerHTML = `
                    <div class="invoice-line-items-empty">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="12"></line>
                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                        <p>No products added yet</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = currentInvoice.products.map((product, index) => `
                <div class="invoice-line-item">
                    <div class="invoice-line-item-info">
                        <h5>${product.product_name}</h5>
                        <span>${product.product_category} • ${product.product_type === 'retail' ? '🛍️ Retail' : '🎨 Service'}</span>
                    </div>
                    <div class="invoice-line-item-qty">
                        <span>Qty:</span>
                        <input type="number" value="${product.quantity}" min="1" onchange="updateProductQty(${index}, this.value)">
                    </div>
                    <div class="invoice-line-item-price">R${product.total.toFixed(2)}</div>
                    <button type="button" class="invoice-line-item-remove" onclick="removeProduct(${index})">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
            `).join('');
        }

        function updateProductQty(index, qty) {
            const product = currentInvoice.products[index];
            if (product) {
                product.quantity = Math.max(1, parseInt(qty) || 1);
                product.total = product.unit_price * product.quantity;
                renderInvoiceProducts();
                calculateInvoiceTotals();
            }
        }

        function removeProduct(index) {
            currentInvoice.products.splice(index, 1);
            renderInvoiceProducts();
            calculateInvoiceTotals();
        }

        // Calculate totals - checks VAT registration status
        async function calculateInvoiceTotals() {
            const services_subtotal = currentInvoice.services.reduce((sum, s) => sum + s.total, 0);
            const products_subtotal = currentInvoice.products.reduce((sum, p) => sum + p.total, 0);
            const subtotal = services_subtotal + products_subtotal;

            const discountType = document.getElementById('invoice-discount-type')?.value || '';
            const discountValue = parseFloat(document.getElementById('invoice-discount-value')?.value) || 0;

            let discount_amount = 0;
            if (discountType === 'percentage') {
                discount_amount = subtotal * (discountValue / 100);
            } else if (discountType === 'fixed') {
                discount_amount = discountValue;
            } else if (discountType === 'loyalty_points') {
                discount_amount = discountValue / 10; // 100 points = R10
            }

            const taxable = subtotal - discount_amount;

            // Check if business is VAT registered
            const biz = await getBusinessInfo();
            const isVatRegistered = biz.vat_registered === 'true';
            const tax_amount = isVatRegistered ? taxable * 0.15 : 0;
            const total = taxable + tax_amount;
            const commission = subtotal * 0.30; // Approximate 30%

            document.getElementById('invoice-services-subtotal').textContent = `R${services_subtotal.toFixed(2)}`;
            document.getElementById('invoice-products-subtotal').textContent = `R${products_subtotal.toFixed(2)}`;
            document.getElementById('invoice-subtotal').textContent = `R${subtotal.toFixed(2)}`;
            document.getElementById('invoice-discount-amount').textContent = `-R${discount_amount.toFixed(2)}`;

            // Show/hide VAT row based on VAT registration status
            const taxRow = document.getElementById('invoice-tax-row');
            if (isVatRegistered) {
                taxRow.style.display = '';
                document.getElementById('invoice-tax-amount').textContent = `R${tax_amount.toFixed(2)}`;
            } else {
                taxRow.style.display = 'none';
            }

            document.getElementById('invoice-total').textContent = `R${total.toFixed(2)}`;
            document.getElementById('invoice-commission').textContent = `R${commission.toFixed(2)}`;

            currentInvoice.totals = {
                services_subtotal, products_subtotal, subtotal, discount_amount, tax_amount, total, commission
            };
        }

        // Save invoice
        async function saveInvoiceAsDraft() {
            await saveInvoice(null, false);
        }

        async function saveInvoice(event, finalize = true) {
            if (event) event.preventDefault();

            try {
                const customerId = document.getElementById('invoice-customer').value;
                const stylistId = document.getElementById('invoice-stylist').value;
                const serviceDate = document.getElementById('invoice-service-date').value;
                const bookingId = document.getElementById('invoice-booking').value || null;

                // Get company details
                const customerType = currentInvoice.customer_type || 'individual';
                const companyName = document.getElementById('invoice-company-name')?.value || '';
                const businessAddress = document.getElementById('invoice-business-address')?.value || '';
                const vatNumber = document.getElementById('invoice-vat-number')?.value || '';
                const companyReg = document.getElementById('invoice-company-reg')?.value || '';

                if (!customerId || !stylistId || !serviceDate) {
                    if (typeof showNotification === 'function') {
                        showNotification('Please fill in all required fields', 'error');
                    } else {
                        alert('Please fill in all required fields');
                    }
                    return;
                }

                // Validate company name if company customer
                if (customerType === 'company' && !companyName.trim()) {
                    if (typeof showNotification === 'function') {
                        showNotification('Please enter company name', 'error');
                    } else {
                        alert('Please enter company name');
                    }
                    return;
                }

                if (currentInvoice.services.length === 0 && currentInvoice.products.length === 0) {
                    if (typeof showNotification === 'function') {
                        showNotification('Please add at least one service or product', 'error');
                    } else {
                        alert('Please add at least one service or product');
                    }
                    return;
                }

                const discountType = document.getElementById('invoice-discount-type').value || null;
                const discountValue = parseFloat(document.getElementById('invoice-discount-value').value) || 0;
                const discountReason = document.getElementById('invoice-discount-reason').value || null;
                const clientNotes = document.getElementById('invoice-client-notes').value || null;
                const internalNotes = document.getElementById('invoice-internal-notes').value || null;

                const invoiceData = {
                    booking_id: bookingId,
                    user_id: customerId,
                    stylist_id: stylistId,
                    service_date: serviceDate,
                    services: currentInvoice.services,
                    products: currentInvoice.products,
                    customer_type: customerType,
                    company_name: customerType === 'company' ? companyName : null,
                    business_address: customerType === 'company' ? businessAddress : null,
                    vat_number: customerType === 'company' ? vatNumber : null,
                    company_reg: customerType === 'company' ? companyReg : null,
                    discount_type: discountType,
                    discount_value: discountValue,
                    discount_reason: discountReason,
                    client_notes: clientNotes,
                    internal_notes: internalNotes
                };

                // Check if we're editing an existing invoice
                const isEditing = currentInvoice.id;
                const url = isEditing ? `/api/admin/invoices/${currentInvoice.id}` : '/api/admin/invoices';
                const method = isEditing ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify(invoiceData)
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || (isEditing ? 'Failed to update invoice' : 'Failed to create invoice'));
                }

                if (finalize) {
                    const finalizeResponse = await fetch(`/api/admin/invoices/${data.invoice.id}/finalize`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${getToken()}`
                        }
                    });

                    const finalizeData = await finalizeResponse.json();

                    if (!finalizeData.success) {
                        throw new Error(finalizeData.error || 'Failed to finalize invoice');
                    }

                    if (typeof showNotification === 'function') {
                        showNotification(`Invoice ${finalizeData.invoice.invoice_number} created and finalized!`, 'success');
                    } else {
                        alert(`Invoice ${finalizeData.invoice.invoice_number} created and finalized!`);
                    }
                } else {
                    const message = isEditing ? 'Invoice updated' : 'Invoice saved as draft';
                    if (typeof showNotification === 'function') {
                        showNotification(message, 'success');
                    } else {
                        alert(message);
                    }
                }

                closeInvoiceModal();
                loadInvoices();

            } catch (error) {
                console.error('Error saving invoice:', error);
                if (typeof showNotification === 'function') {
                    showNotification(error.message || 'Failed to save invoice', 'error');
                } else {
                    alert(error.message || 'Failed to save invoice');
                }
            }
        }

        function closeInvoiceModal() {
            const modal = document.getElementById('invoice-modal');
            modal.classList.remove('show');
            modal.style.display = 'none';
        }

        // Payment modal
        async function showPaymentModal(invoiceId) {
            try {
                const response = await fetch(`/api/admin/invoices/${invoiceId}`, {
                    headers: { 'Authorization': `Bearer ${getToken()}` }
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error('Invoice not found');
                }

                currentPaymentInvoice = data.invoice;

                // Handle nested customer object and calculate amount due
                const customerName = currentPaymentInvoice.customer?.name || currentPaymentInvoice.customer_name || 'Unknown';
                const amountDue = currentPaymentInvoice.amount_due || (currentPaymentInvoice.total - (currentPaymentInvoice.amount_paid || 0));

                document.getElementById('payment-invoice-info').textContent = `${currentPaymentInvoice.invoice_number} - ${customerName}`;
                document.getElementById('payment-amount-due').textContent = `R${amountDue.toFixed(2)}`;
                document.getElementById('payment-amount').value = amountDue.toFixed(2);

                const modal = document.getElementById('payment-modal');
                modal.style.display = 'flex';
                modal.classList.add('show');
            } catch (error) {
                console.error('Error loading invoice:', error);
                if (typeof showNotification === 'function') {
                    showNotification('Failed to load invoice', 'error');
                } else {
                    alert('Failed to load invoice');
                }
            }
        }

        function closePaymentModal() {
            const modal = document.getElementById('payment-modal');
            modal.classList.remove('show');
            modal.style.display = 'none';
            currentPaymentInvoice = null;
        }

        async function recordPayment(e) {
            e.preventDefault();

            if (!currentPaymentInvoice) return;

            try {
                const amount = parseFloat(document.getElementById('payment-amount').value);
                const paymentMethod = document.getElementById('payment-method').value;
                const reference = document.getElementById('payment-reference').value || null;
                const notes = document.getElementById('payment-notes').value || null;

                const response = await fetch(`/api/admin/invoices/${currentPaymentInvoice.id}/payments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify({
                        amount,
                        payment_method: paymentMethod,
                        payment_reference: reference,
                        notes
                    })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to record payment');
                }

                if (typeof showNotification === 'function') {
                    showNotification('Payment recorded successfully!', 'success');
                } else {
                    alert('Payment recorded successfully!');
                }
                closePaymentModal();
                loadInvoices();

            } catch (error) {
                console.error('Error recording payment:', error);
                if (typeof showNotification === 'function') {
                    showNotification(error.message || 'Failed to record payment', 'error');
                } else {
                    alert(error.message || 'Failed to record payment');
                }
            }
        }

        // Commission reports
        async function loadCommissionReport() {
            const stylistId = document.getElementById('commission-stylist').value;
            const startDate = document.getElementById('commission-start-date').value;
            const endDate = document.getElementById('commission-end-date').value;

            if (!stylistId || !startDate || !endDate) {
                if (typeof showNotification === 'function') {
                    showNotification('Please select stylist and date range', 'error');
                } else {
                    alert('Please select stylist and date range');
                }
                return;
            }

            try {
                const response = await fetch(
                    `/api/admin/commissions?stylist_id=${stylistId}&start_date=${startDate}&end_date=${endDate}`,
                    { headers: { 'Authorization': `Bearer ${getToken()}` } }
                );

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to load report');
                }

                renderCommissionReport(data.summary, data.commissions);

            } catch (error) {
                console.error('Error loading commission report:', error);
                if (typeof showNotification === 'function') {
                    showNotification(error.message || 'Failed to load report', 'error');
                } else {
                    alert(error.message || 'Failed to load report');
                }
            }
        }

        function renderCommissionReport(summary, commissions) {
            // Add defensive checks for summary data
            document.getElementById('comm-invoices-count').textContent = summary?.total_invoices || 0;
            document.getElementById('comm-total-sales').textContent = `R${(summary?.total_sales || 0).toFixed(2)}`;
            document.getElementById('comm-total-commission').textContent = `R${(summary?.total_commission || 0).toFixed(2)}`;

            document.getElementById('commission-summary').style.display = 'block';
            document.getElementById('commission-detail').style.display = 'block';

            const container = document.getElementById('commission-list-container');

            if (!commissions || commissions.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--text-subtle);">No commissions found for this period</p>';
                return;
            }

            const html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" onchange="toggleAllCommissions(this)"></th>
                            <th>Invoice</th>
                            <th>Date</th>
                            <th>Customer</th>
                            <th>Total</th>
                            <th>Services Comm.</th>
                            <th>Products Comm.</th>
                            <th>Total Comm.</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${commissions.map(comm => `
                            <tr>
                                <td>
                                    <input type="checkbox" class="commission-checkbox" value="${comm.invoice_id || comm.id || ''}"
                                        ${comm.payment_status === 'paid' ? 'disabled' : ''}>
                                </td>
                                <td><strong>${comm.invoice_number || 'N/A'}</strong></td>
                                <td>${comm.service_date ? new Date(comm.service_date).toLocaleDateString('en-ZA') : 'N/A'}</td>
                                <td>${comm.customer_name || comm.customer?.name || 'Unknown'}</td>
                                <td>R${(comm.invoice_total || 0).toFixed(2)}</td>
                                <td>R${(comm.services_commission || 0).toFixed(2)}</td>
                                <td>R${(comm.products_commission || 0).toFixed(2)}</td>
                                <td><strong>R${(comm.total_commission || 0).toFixed(2)}</strong></td>
                                <td>
                                    <span class="badge badge-${comm.payment_status === 'paid' ? 'success' : 'warning'}">
                                        ${(comm.payment_status || 'pending').toUpperCase()}
                                    </span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        function toggleAllCommissions(checkbox) {
            document.querySelectorAll('.commission-checkbox:not(:disabled)').forEach(cb => {
                cb.checked = checkbox.checked;
            });
        }

        async function markCommissionsAsPaid() {
            const selected = Array.from(document.querySelectorAll('.commission-checkbox:checked')).map(cb => cb.value);

            if (selected.length === 0) {
                if (typeof showNotification === 'function') {
                    showNotification('Please select commissions to mark as paid', 'error');
                } else {
                    alert('Please select commissions to mark as paid');
                }
                return;
            }

            if (!confirm(`Mark ${selected.length} commission(s) as paid?`)) return;

            try {
                const reference = prompt('Enter payroll reference:', `PAYROLL-${new Date().toISOString().slice(0, 7)}`);
                if (!reference) return;

                const response = await fetch('/api/admin/commissions/mark-paid', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify({
                        invoice_ids: selected,
                        payment_reference: reference,
                        payment_date: new Date().toISOString()
                    })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Failed to mark commissions as paid');
                }

                if (typeof showNotification === 'function') {
                    showNotification(`${selected.length} commission(s) marked as paid!`, 'success');
                } else {
                    alert(`${selected.length} commission(s) marked as paid!`);
                }
                loadCommissionReport();

            } catch (error) {
                console.error('Error marking commissions as paid:', error);
                if (typeof showNotification === 'function') {
                    showNotification(error.message || 'Failed to mark commissions as paid', 'error');
                } else {
                    alert(error.message || 'Failed to mark commissions as paid');
                }
            }
        }

        // Initialize when section is shown
        function initInvoiceSection() {
            loadInvoices();
            loadStylistsForInvoice();

            const now = new Date();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);

            if (document.getElementById('commission-start-date')) {
                document.getElementById('commission-start-date').valueAsDate = firstDay;
            }
            if (document.getElementById('commission-end-date')) {
                document.getElementById('commission-end-date').valueAsDate = lastDay;
            }
        }

        // Hook into existing showSection function to initialize invoices
        // Use a more robust approach to handle potential timing issues
        function hookShowSection() {
            const _originalShowSection = window.showSection;
            if (_originalShowSection && typeof _originalShowSection === 'function') {
                window.showSection = function(sectionId, event) {
                    _originalShowSection(sectionId, event);
                    if (sectionId === 'invoices' || sectionId === 'commissions') {
                        initInvoiceSection();
                    }
                };
            } else {
                // If showSection doesn't exist yet, try again after a short delay
                setTimeout(hookShowSection, 100);
            }
        }

        // Try to hook immediately, or wait for DOM to be ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', hookShowSection);
        } else {
            hookShowSection();
        }
    </script>
</body>
</html>







