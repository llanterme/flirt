<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FL!RT - Admin Console</title>
    <!-- Flirt Brand Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23F67599'/><text y='68' x='50' text-anchor='middle' font-size='36' font-family='Arial' font-weight='300' letter-spacing='2' fill='white'>FL<tspan fill='%23414042'>.</tspan>RT</text></svg>">
    <!-- Google Fonts - Flirt Brand Typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@300;400;600&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js for dashboard charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Flirt Brand Colors - from Style Guide */
            --brand-pink: #F67599;          /* Primary - Pantone 190 C */
            --brand-pink-dark: #e05a7f;     /* Darker pink for hover states */
            --brand-charcoal: #414042;      /* Secondary - Pantone Black 7 C */
            --brand-white: #ffffff;         /* Base color */
            --primary: #F67599;
            --primary-light: rgba(246, 117, 153, 0.12);

            /* Legacy variable mapping */
            --primary-black: #414042;
            --primary-white: #ffffff;
            --accent-pink: #F67599;
            --accent-gold: #F67599;
            --gray-dark: #414042;
            --gray-medium: #6d6e70;
            --gray-light: #f8f8f8;
            --success: #4CAF50;
            --warning: #FF9800;
            --danger: #e74c3c;
            --info: #2196F3;
            --shadow: rgba(65, 64, 66, 0.1);
            --sidebar-width: 260px;
            --text-muted: rgba(65, 64, 66, 0.75);
            --text-subtle: rgba(65, 64, 66, 0.6);
            --border-soft: rgba(65, 64, 66, 0.16);
            --brand-gradient: linear-gradient(135deg, var(--brand-pink) 0%, var(--brand-pink-dark) 100%);
            --surface-muted: #f5f5f5;
            --dark: #414042;
        }

        body {
            font-family: 'Open Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--gray-light);
            color: var(--brand-charcoal);
            line-height: 1.6;
        }

        /* Brand Typography */
        h1, h2, h3, .sidebar-logo, .page-title {
            font-family: 'Josefin Sans', 'Helvetica Neue', Arial, sans-serif;
            letter-spacing: 0.1em;
        }

        /* Layout */
        .admin-layout {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--brand-charcoal);
            color: white;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            transition: transform 0.3s;
            z-index: 100;
        }

        .sidebar-header {
            padding: 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--brand-pink);
            padding: 20px 24px;
            position: relative;
        }

        .sidebar-logo::after {
            content: '';
            position: absolute;
            bottom: -20px;
            left: 0;
            right: 0;
            height: 40px;
            background: var(--brand-pink);
            clip-path: polygon(0 0, 100% 0, 100% 50%, 50% 100%, 0 50%);
        }

        .sidebar-logo img {
            height: 55px;
            width: auto;
            position: relative;
            z-index: 1;
        }

        .sidebar-subtitle {
            font-family: 'Josefin Sans', Arial, sans-serif;
            font-size: 11px;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            color: rgba(255,255,255,0.5);
            margin-top: 30px;
            padding: 0 24px;
            text-align: center;
        }

        .sidebar-nav {
            padding: 20px 0;
        }

        .nav-section {
            padding: 0 20px;
            margin-bottom: 10px;
        }

        .nav-section-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--gray-medium);
            margin-bottom: 10px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            transition: all 0.3s;
            cursor: pointer;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.05);
            color: white;
        }

        .nav-item.active {
            background: rgba(246, 117, 153, 0.1);
            color: var(--brand-pink);
            border-left-color: var(--brand-pink);
        }

        .nav-icon {
            width: 20px;
            height: 20px;
        }

        .nav-badge {
            margin-left: auto;
            background: var(--brand-pink);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            min-height: 100vh;
        }

        /* Top Bar */
        .top-bar {
            background: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px var(--shadow);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .page-title {
            font-size: 24px;
            font-weight: 600;
        }

        .top-bar-actions {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .search-box {
            display: flex;
            align-items: center;
            background: var(--gray-light);
            border-radius: 25px;
            padding: 8px 15px;
            gap: 10px;
        }

        .search-box input {
            border: none;
            background: none;
            outline: none;
            width: 200px;
        }

        .notification-btn {
            position: relative;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
        }

        .notification-dot {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 8px;
            height: 8px;
            background: var(--danger);
            border-radius: 50%;
        }

        .admin-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .admin-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--brand-pink);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .admin-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            min-width: 180px;
            z-index: 1000;
            padding: 8px 0;
        }

        .admin-dropdown.show {
            display: block;
        }

        .admin-dropdown button {
            display: block;
            width: 100%;
            padding: 10px 16px;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            color: var(--brand-charcoal);
        }

        .admin-dropdown button:hover {
            background: var(--gray-light);
        }

        .top-bar-actions {
            position: relative;
        }

        .search-results {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            margin-top: 5px;
            min-width: 300px;
        }

        .search-results.show {
            display: block;
        }

        .search-result-group {
            padding: 8px 0;
            border-bottom: 1px solid var(--border-soft);
        }

        .search-result-group:last-child {
            border-bottom: none;
        }

        .search-result-group-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            padding: 4px 12px;
            text-transform: uppercase;
        }

        .search-result-item {
            padding: 10px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-result-item:hover {
            background: var(--gray-light);
        }

        .search-result-item .icon {
            font-size: 16px;
        }

        .search-result-item .details {
            flex: 1;
        }

        .search-result-item .name {
            font-weight: 500;
            font-size: 14px;
        }

        .search-result-item .meta {
            font-size: 12px;
            color: var(--text-muted);
        }

        .search-no-results {
            padding: 20px;
            text-align: center;
            color: var(--text-muted);
        }

        /* Content Area */
        .content-area {
            padding: 30px;
        }

        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dashboard Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 2px 10px var(--shadow);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .stat-icon.pink { background: rgba(246, 117, 153, 0.1); color: var(--brand-pink); }
        .stat-icon.gold { background: rgba(212, 175, 55, 0.1); color: var(--accent-gold); }
        .stat-icon.green { background: rgba(76, 175, 80, 0.1); color: var(--success); }
        .stat-icon.blue { background: rgba(33, 150, 243, 0.1); color: var(--info); }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary-black);
        }

        .stat-label {
            color: var(--gray-medium);
            font-size: 14px;
        }

        .stat-change {
            font-size: 13px;
            margin-top: 10px;
        }

        .stat-change.positive { color: var(--success); }
        .stat-change.negative { color: var(--danger); }

        /* Data Tables */
        .data-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 2px 10px var(--shadow);
            overflow: hidden;
            margin-bottom: 20px;
        }

        .data-card-header {
            padding: 20px 25px;
            border-bottom: 1px solid var(--gray-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .data-card-title {
            font-size: 18px;
            font-weight: 600;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 15px 20px;
            text-align: left;
            border-bottom: 1px solid var(--gray-light);
        }

        .data-table th {
            background: var(--gray-light);
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            color: var(--gray-medium);
        }

        .data-table tr:hover {
            background: rgba(246, 117, 153, 0.02);
        }

        .data-table .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .data-table .avatar-placeholder {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--brand-pink);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        /* Status Badges */
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .status-badge.active { background: rgba(76, 175, 80, 0.1); color: var(--success); }
        .status-badge.pending { background: rgba(255, 152, 0, 0.1); color: var(--warning); }
        .status-badge.completed { background: rgba(33, 150, 243, 0.1); color: var(--info); }
        .status-badge.cancelled { background: rgba(244, 67, 54, 0.1); color: var(--danger); }
        .status-badge.sale { background: rgba(244, 67, 54, 0.1); color: var(--danger); }

        /* Payment status badges */
        .status-badge.status-paid { background: rgba(76, 175, 80, 0.15); color: #388e3c; }
        .status-badge.status-pending { background: rgba(255, 152, 0, 0.15); color: #f57c00; }
        .status-badge.status-unpaid { background: rgba(158, 158, 158, 0.15); color: #757575; }

        /* Action Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--brand-pink);
            color: white;
        }

        .btn-primary:hover {
            background: var(--brand-pink-dark);
        }

        .btn-secondary {
            background: var(--primary-black);
            color: white;
        }

        .btn-outline {
            background: white;
            border: 2px solid var(--gray-light);
            color: var(--gray-dark);
        }

        .btn-outline:hover {
            border-color: var(--brand-pink);
            color: var(--brand-pink);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }

        .action-btns {
            display: flex;
            gap: 8px;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--gray-dark);
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--gray-light);
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--brand-pink);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        /* Higher z-index for stacked modals (e.g., customer modal on top of booking modal) */
        .modal-overlay.stacked {
            z-index: 1100;
        }

        .modal {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlide 0.3s ease;
        }

        @keyframes modalSlide {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            padding: 25px;
            border-bottom: 1px solid var(--gray-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray-medium);
        }

        /* Admin toast */
        .admin-toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1100;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .admin-toast {
            min-width: 240px;
            max-width: 360px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
            padding: 12px 14px;
            border-left: 4px solid var(--brand-pink);
            font-size: 14px;
            color: var(--brand-charcoal);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .admin-toast.success { border-color: var(--success); }
        .admin-toast.error { border-color: var(--danger); }
        .admin-toast .toast-close {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-subtle);
            font-size: 16px;
        }

        .modal-body {
            padding: 25px;
        }

        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid var(--gray-light);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Charts placeholder */
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 2px 10px var(--shadow);
            margin-bottom: 20px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-placeholder {
            height: 300px;
            background: linear-gradient(135deg, var(--gray-light) 0%, #e8e8e8 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gray-medium);
        }

        /* Dashboard Alert */
        .dashboard-alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .dashboard-alert.error {
            background: #ffebee;
            border: 1px solid #ef9a9a;
            color: #c62828;
        }
        .dashboard-alert.warning {
            background: #fff3e0;
            border: 1px solid #ffcc80;
            color: #ef6c00;
        }
        .dashboard-alert.info {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            color: #1565c0;
        }

        /* Stat card loading state */
        .stat-card.loading .stat-value {
            color: var(--gray-medium);
        }
        .stat-card.error .stat-value {
            color: var(--danger);
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .quick-action-btn {
            background: white;
            border: 2px solid var(--gray-light);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quick-action-btn:hover {
            border-color: var(--brand-pink);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px var(--shadow);
        }

        .quick-action-icon {
            width: 45px;
            height: 45px;
            border-radius: 10px;
            background: rgba(246, 117, 153, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .quick-action-text {
            font-weight: 600;
        }

        /* Filters */
        .filters-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 10px 15px;
            border: 2px solid var(--gray-light);
            border-radius: 8px;
            background: white;
            font-size: 14px;
            cursor: pointer;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gray-light);
            border-radius: 26px;
            transition: 0.3s;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
        }

        .toggle-switch input:checked + .toggle-slider {
            background: var(--success);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        /* Chat Panel */
        .chat-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .chat-item {
            padding: 15px 20px;
            border-bottom: 1px solid var(--gray-light);
            cursor: pointer;
            display: flex;
            gap: 15px;
            transition: background 0.3s;
        }

        .chat-item:hover {
            background: var(--gray-light);
        }

        .chat-item.unread {
            background: rgba(246, 117, 153, 0.05);
        }

        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--brand-pink);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .chat-preview {
            color: var(--gray-medium);
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-time {
            font-size: 12px;
            color: var(--gray-medium);
        }

        .chat-unread-badge {
            background: var(--brand-pink);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
        }

        /* Image Upload */
        .image-upload {
            border: 2px dashed var(--gray-light);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .image-upload:hover {
            border-color: var(--brand-pink);
            background: rgba(246, 117, 153, 0.02);
        }

        .image-preview {
            width: 100px;
            height: 100px;
            border-radius: 10px;
            object-fit: cover;
            margin-top: 15px;
        }

        /* ============================================
           MOBILE RESPONSIVE STYLES
           ============================================ */

        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            color: var(--brand-charcoal);
        }

        /* Sidebar overlay for mobile */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 998;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sidebar-overlay.show {
            display: block;
            opacity: 1;
        }

        /* Mobile close button in sidebar */
        .sidebar-close-btn {
            display: none;
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 10;
        }

        .sidebar-close-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        /* Tablet and below */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
                z-index: 999;
                transition: transform 0.3s ease;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .sidebar-close-btn {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .main-content {
                margin-left: 0;
            }

            .mobile-menu-btn {
                display: block;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            /* Top bar adjustments */
            .top-bar {
                padding: 12px 15px;
            }

            .page-title {
                font-size: 18px;
            }

            .search-box {
                display: none;
            }

            /* Stats grid mobile */
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            /* Quick actions mobile */
            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Phone specific */
        @media (max-width: 768px) {
            /* Table responsiveness */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin: 0 -15px;
                padding: 0 15px;
            }

            .data-table {
                min-width: 600px;
            }

            .data-table th,
            .data-table td {
                padding: 10px 12px;
                font-size: 13px;
            }

            /* Filter tabs scroll */
            .status-filter-tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 5px;
            }

            .status-filter-tab {
                white-space: nowrap;
                flex-shrink: 0;
            }

            /* Action buttons stack on mobile */
            .action-buttons {
                flex-direction: column;
                gap: 8px;
            }

            .action-buttons .btn {
                width: 100%;
                justify-content: center;
            }

            /* Card adjustments */
            .card {
                padding: 15px;
                margin-bottom: 15px;
            }

            /* Stats grid single column on small phones */
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }

            .stat-card {
                padding: 15px;
            }

            .stat-value {
                font-size: 24px;
            }

            /* Section headers */
            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            /* Quick actions single column */
            .quick-actions {
                grid-template-columns: 1fr;
            }

            /* Calendar mobile */
            .calendar-grid {
                grid-template-columns: repeat(7, 1fr);
            }

            .calendar-day {
                min-height: 60px;
                padding: 5px;
                font-size: 11px;
            }

            .calendar-day-header {
                padding: 5px;
                font-size: 10px;
            }

            /* Modal mobile fullscreen */
            .modal-content {
                width: 100%;
                max-width: 100%;
                height: 100%;
                max-height: 100%;
                margin: 0;
                border-radius: 0;
            }

            /* Filter panel mobile */
            .filter-panel {
                flex-direction: column;
                gap: 10px;
            }

            .filter-panel select,
            .filter-panel input {
                width: 100%;
            }

            /* Booking detail row on mobile */
            .booking-detail-row {
                flex-direction: column;
                gap: 5px;
            }
        }

        /* Very small phones */
        @media (max-width: 400px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .top-bar-actions {
                gap: 5px;
            }

            .page-title {
                font-size: 16px;
            }

            .data-table th,
            .data-table td {
                padding: 8px 10px;
                font-size: 12px;
            }
        }

        /* Calendar View */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day-header {
            padding: 10px;
            text-align: center;
            font-weight: 600;
            font-size: 12px;
            color: var(--gray-medium);
        }

        .calendar-day {
            min-height: 100px;
            padding: 10px;
            background: white;
            border: 1px solid var(--gray-light);
            border-radius: 8px;
        }

        .calendar-day-number {
            font-weight: 600;
            margin-bottom: 8px;
        }

        .calendar-event {
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 4px;
            margin-bottom: 4px;
            background: rgba(246, 117, 153, 0.1);
            color: var(--brand-pink);
        }

        /* Inventory indicators */
        .stock-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stock-bar {
            flex: 1;
            height: 8px;
            background: var(--gray-light);
            border-radius: 4px;
            overflow: hidden;
        }

        .stock-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s;
        }

        .stock-fill.high { background: var(--success); }
        .stock-fill.medium { background: var(--warning); }
        .stock-fill.low { background: var(--danger); }

        /* Gallery Admin Styles */
        .gallery-admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
        }

        .gallery-admin-item {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            background: var(--gray-light);
            aspect-ratio: 1;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .gallery-admin-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .gallery-admin-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .gallery-admin-item.inactive {
            opacity: 0.5;
        }

        .gallery-admin-item.inactive::after {
            content: 'HIDDEN';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .gallery-admin-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            padding: 40px 12px 12px;
            color: white;
        }

        .gallery-admin-label {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .gallery-admin-category {
            font-size: 11px;
            opacity: 0.8;
            text-transform: uppercase;
        }

        .gallery-admin-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 4px;
        }

        .gallery-action-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .gallery-action-btn:hover {
            transform: scale(1.1);
        }

        .gallery-action-btn.edit {
            background: var(--brand-pink);
            color: white;
        }

        .gallery-action-btn.toggle {
            background: white;
            color: var(--gray-dark);
        }

        .gallery-action-btn.delete {
            background: var(--danger);
            color: white;
        }

        .gallery-action-btn svg {
            width: 14px;
            height: 14px;
        }

        /* Time Slot Schedule */
        .time-slots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }

        .time-slot {
            padding: 12px 8px;
            border: 2px solid var(--gray-light);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            font-weight: 500;
        }

        .time-slot:hover:not(.booked):not(.selected) {
            border-color: var(--primary);
            background: rgba(246, 117, 153, 0.05);
        }

        .time-slot.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        .time-slot.booked {
            background: var(--gray-light);
            color: var(--gray-medium);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .time-slot.booked::after {
            content: ' ✗';
            font-size: 10px;
        }

        /* Status Filter Tabs */
        .status-filter-tab {
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            padding: 12px 20px;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-muted);
            transition: all 0.2s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-filter-tab:hover {
            color: var(--brand-charcoal);
            border-bottom-color: var(--border-strong);
        }

        .status-filter-tab.active {
            color: var(--brand-pink);
            border-bottom-color: var(--brand-pink);
        }

        .filter-count {
            background: var(--surface-muted);
            color: var(--text-muted);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            min-width: 24px;
            text-align: center;
        }

        .status-filter-tab.active .filter-count {
            background: var(--brand-pink);
            color: white;
        }
    </style>

    <!-- Booking Constants (shared with client app) -->
    <script src="/shared/booking-constants.js"></script>
</head>
<body>
    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <button class="sidebar-close-btn" onclick="closeSidebar()" aria-label="Close menu">×</button>
            <div class="sidebar-header">
                <div class="sidebar-logo"><img src="Flirt pink logo 2.jpeg" alt="FL!RT Hair & Beauty Bar"></div>
                <div class="sidebar-subtitle">Admin Console</div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Overview</div>
                </div>
                <a class="nav-item active" onclick="showSection('dashboard', event)">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                    Dashboard
                </a>

                <div class="nav-section" style="margin-top: 20px;">
                    <div class="nav-section-title">Management</div>
                </div>
                <a class="nav-item" onclick="showSection('bookings', event)">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    Bookings
                    <span class="nav-badge" id="bookingsNavBadge">0</span>
                </a>
                <a class="nav-item" onclick="showSection('staff', event)">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    Staff
                </a>
                <a class="nav-item" onclick="showSection('payroll', event)">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                        <line x1="1" y1="10" x2="23" y2="10"></line>
                    </svg>
                    Payroll
                </a>
                <a class="nav-item" onclick="showSection('services', event)">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                        <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
                    </svg>
                    Services
                </a>
                <a class="nav-item" onclick="showSection('customers', event)">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    Customers
                </a>
                <a class="nav-item" onclick="showSection('products', event)">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="16.5" y1="9.4" x2="7.5" y2="4.21"></line>
                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                    </svg>
                    Products
                </a>
                <a class="nav-item" onclick="showSection('orders', event)">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="9" cy="21" r="1"></circle>
                        <circle cx="20" cy="21" r="1"></circle>
                        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                    </svg>
                    Orders
                    <span class="nav-badge">5</span>
                </a>

                <div class="nav-section" style="margin-top: 20px;">
                    <div class="nav-section-title">Marketing</div>
                </div>
                <a class="nav-item" onclick="showSection('promotions', event)">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                    </svg>
                    Promotions
                </a>
                <a class="nav-item" onclick="showSection('notifications', event)">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                    </svg>
                    Push Notifications
                </a>
                <a class="nav-item" onclick="showSection('gallery', event)">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                        <polyline points="21 15 16 10 5 21"></polyline>
                    </svg>
                    Gallery
                </a>
                <a class="nav-item" onclick="showSection('chat', event)">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    Chat
                    <span class="nav-badge">3</span>
                </a>
                <a class="nav-item" onclick="showSection('hair-tips', event)">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="16" x2="12" y2="12"></line>
                        <line x1="12" y1="8" x2="12.01" y2="8"></line>
                    </svg>
                    Hair Care Tips
                </a>

                <div class="nav-section" style="margin-top: 20px;">
                    <div class="nav-section-title">Settings</div>
                </div>
                <a class="nav-item" onclick="showSection('rewards-settings', event)">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="8" r="7"></circle>
                        <polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline>
                    </svg>
                    Rewards Programme
                </a>
                <a class="nav-item" onclick="showSection('hair-tracker-settings', event)">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path>
                        <path d="M22 12A10 10 0 0 0 12 2v10z"></path>
                    </svg>
                    Hair Tracker Settings
                </a>
                <a class="nav-item" onclick="showSection('payment-settings', event)">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                        <line x1="1" y1="10" x2="23" y2="10"></line>
                    </svg>
                    Payment Settings
                </a>
                <a class="nav-item" onclick="showSection('settings', event)">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                    Settings
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <header class="top-bar">
                <div style="display: flex; align-items: center; gap: 20px;">
                    <button class="mobile-menu-btn" onclick="toggleSidebar()">☰</button>
                    <h1 class="page-title" id="pageTitle">Dashboard</h1>
                </div>
                <div class="top-bar-actions">
                    <div class="search-box" style="position: relative;">
                        <span>🔍</span>
                        <input type="search" id="globalSearch" placeholder="Search customers, bookings..." autocomplete="off" autocorrect="off" spellcheck="false" aria-label="Search" oninput="handleGlobalSearch(event)" onkeydown="handleSearchKeydown(event)">
                        <div class="search-results" id="searchResults"></div>
                    </div>
                    <button class="notification-btn" onclick="showSection('notifications')" title="View Notifications">
                        🔔
                        <span class="notification-dot" id="notificationDot"></span>
                    </button>
                    <div class="admin-profile" onclick="toggleAdminMenu()" title="Account Menu">
                        <div class="admin-avatar" id="adminAvatar">A</div>
                        <span id="adminName" style="font-weight: 500;">Admin</span>
                        <span style="font-size: 10px;">▼</span>
                    </div>
                    <div class="admin-dropdown" id="adminDropdown">
                        <button onclick="showPasswordChangeModal()">🔑 Change Password</button>
                        <button onclick="showSection('settings')">⚙️ Settings</button>
                        <hr style="margin: 5px 0; border: none; border-top: 1px solid var(--border-soft);">
                        <button onclick="logout()" style="color: var(--danger);">🚪 Logout</button>
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Dashboard Section -->
                <section id="dashboard" class="page-section active">
                    <!-- Dashboard Alert Area -->
                    <div id="dashboardAlert" class="dashboard-alert" style="display: none;"></div>

                    <!-- Stats Grid -->
                    <div class="stats-grid">
                        <div class="stat-card" id="statCardRevenue">
                            <div class="stat-card-header">
                                <div>
                                    <div class="stat-value" id="statMonthRevenue">Loading...</div>
                                    <div class="stat-label">Revenue This Month</div>
                                </div>
                                <div class="stat-icon pink">💰</div>
                            </div>
                            <div class="stat-change" id="statRevenueChange"></div>
                        </div>
                        <div class="stat-card" id="statCardBookings">
                            <div class="stat-card-header">
                                <div>
                                    <div class="stat-value" id="statMonthBookings">Loading...</div>
                                    <div class="stat-label">Bookings This Month</div>
                                </div>
                                <div class="stat-icon gold">📅</div>
                            </div>
                            <div class="stat-change" id="statBookingsChange"></div>
                        </div>
                        <div class="stat-card" id="statCardOrders">
                            <div class="stat-card-header">
                                <div>
                                    <div class="stat-value" id="statMonthOrders">Loading...</div>
                                    <div class="stat-label">Product Orders This Month</div>
                                </div>
                                <div class="stat-icon green">📦</div>
                            </div>
                            <div class="stat-change" id="statOrdersChange"></div>
                        </div>
                        <div class="stat-card" id="statCardCustomers">
                            <div class="stat-card-header">
                                <div>
                                    <div class="stat-value" id="statActiveCustomers">Loading...</div>
                                    <div class="stat-label">Active Customers</div>
                                </div>
                                <div class="stat-icon blue">👥</div>
                            </div>
                            <div class="stat-change" id="statCustomersChange"></div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <h3 style="margin-bottom: 15px;">Quick Actions</h3>
                    <div class="quick-actions">
                        <button class="quick-action-btn" onclick="openAdminBookingModal()">
                            <div class="quick-action-icon">➕</div>
                            <div class="quick-action-text">New Booking</div>
                        </button>
                        <button class="quick-action-btn" onclick="openAddProductModal()">
                            <div class="quick-action-icon">📦</div>
                            <div class="quick-action-text">Add Product</div>
                        </button>
                        <button class="quick-action-btn" onclick="openModal('addPromoModal')">
                            <div class="quick-action-icon">🏷️</div>
                            <div class="quick-action-text">Create Promo</div>
                        </button>
                        <button class="quick-action-btn" onclick="showSection('chat')">
                            <div class="quick-action-icon">💬</div>
                            <div class="quick-action-text">View Messages</div>
                        </button>
                    </div>

                    <!-- Today's Bookings -->
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Today's Bookings</h3>
                            <button class="btn btn-outline btn-sm" onclick="viewTodayBookings()">View All</button>
                        </div>
                        <table class="data-table" id="todayBookingsTable">
                            <thead>
                                <tr>
                                    <th>Client</th>
                                    <th>Service</th>
                                    <th>Stylist</th>
                                    <th>Time</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="todayBookingsBody">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 30px; color: var(--gray-medium);">
                                        Loading today's bookings...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Charts Row -->
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
                        <div class="chart-container" id="revenueChartContainer">
                            <div class="chart-header">
                                <h3>Revenue Overview</h3>
                                <select class="filter-select" id="revenueChartRange" onchange="loadRevenueChart()">
                                    <option value="30d">Last 30 Days</option>
                                    <option value="7d">Last 7 Days</option>
                                    <option value="90d">Last 90 Days</option>
                                </select>
                            </div>
                            <div class="chart-canvas-wrapper" style="position: relative; height: 250px;">
                                <canvas id="revenueChart"></canvas>
                            </div>
                            <div id="revenueChartError" class="chart-error" style="display: none; text-align: center; padding: 20px; color: var(--danger);">
                                Unable to load chart data
                            </div>
                        </div>
                        <div class="chart-container" id="servicesChartContainer">
                            <div class="chart-header">
                                <h3>Popular Services</h3>
                            </div>
                            <div class="chart-canvas-wrapper" style="position: relative; height: 250px;">
                                <canvas id="servicesChart"></canvas>
                            </div>
                            <div id="servicesChartError" class="chart-error" style="display: none; text-align: center; padding: 20px; color: var(--danger);">
                                Unable to load chart data
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Bookings Section -->
                <section id="bookings" class="page-section">
                    <!-- View Toggle & Actions Bar -->
                    <div class="filters-bar">
                        <div style="display: flex; gap: 10px; margin-right: auto;">
                            <button class="btn btn-sm" id="bookingsListViewBtn" onclick="setBookingsView('list')" style="background: var(--primary); color: white;">List</button>
                            <button class="btn btn-sm btn-outline" id="bookingsCalendarViewBtn" onclick="setBookingsView('calendar')">Calendar</button>
                        </div>
                        <button class="btn btn-outline btn-sm" onclick="exportBookingsToCSV()" title="Export filtered results to CSV">📥 Export CSV</button>
                        <button class="btn btn-primary" onclick="openAdminBookingModal()">+ New Booking</button>
                    </div>

                    <!-- Status Filter Tabs -->
                    <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid var(--border-soft); overflow-x: auto;">
                        <button class="status-filter-tab active" data-status="all" onclick="filterByStatus('all')">
                            All <span class="filter-count" id="count-all">0</span>
                        </button>
                        <button class="status-filter-tab" data-status="REQUESTED" onclick="filterByStatus('REQUESTED')">
                            ⏳ Requested <span class="filter-count" id="count-requested">0</span>
                        </button>
                        <button class="status-filter-tab" data-status="CONFIRMED" onclick="filterByStatus('CONFIRMED')">
                            ✓ Confirmed <span class="filter-count" id="count-confirmed">0</span>
                        </button>
                        <button class="status-filter-tab" data-status="COMPLETED" onclick="filterByStatus('COMPLETED')">
                            ✓✓ Completed <span class="filter-count" id="count-completed">0</span>
                        </button>
                        <button class="status-filter-tab" data-status="CANCELLED" onclick="filterByStatus('CANCELLED')">
                            ✗ Cancelled <span class="filter-count" id="count-cancelled">0</span>
                        </button>
                    </div>

                    <!-- Advanced Filters Bar -->
                    <div class="data-card" style="margin-bottom: 20px; padding: 20px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end;">
                            <!-- Search -->
                            <div style="grid-column: span 2;">
                                <label class="form-label">Search</label>
                                <input type="text" id="bookingsSearchInput" class="form-input" placeholder="Search by name, email, phone, service, ID..." oninput="onBookingsSearchInput(this.value)">
                            </div>

                            <!-- Status Filter -->
                            <div>
                                <label class="form-label">Status</label>
                                <select id="bookingsStatusFilter" class="form-input" onchange="onBookingsFilterChange()">
                                    <option value="all">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="confirmed">Confirmed</option>
                                    <option value="completed">Completed</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                            </div>

                            <!-- Stylist Filter -->
                            <div>
                                <label class="form-label">Stylist</label>
                                <select id="bookingsStylistFilter" class="form-input" onchange="onBookingsFilterChange()">
                                    <option value="all">All Stylists</option>
                                    <!-- Populated dynamically -->
                                </select>
                            </div>

                            <!-- Service Filter -->
                            <div>
                                <label class="form-label">Service</label>
                                <select id="bookingsServiceFilter" class="form-input" onchange="onBookingsFilterChange()">
                                    <option value="all">All Services</option>
                                    <!-- Populated dynamically -->
                                </select>
                            </div>

                            <!-- Time of Day Filter -->
                            <div>
                                <label class="form-label">Time of Day</label>
                                <select id="bookingsTimeFilter" class="form-input" onchange="onBookingsFilterChange()">
                                    <option value="all">All Times</option>
                                    <option value="morning">Morning</option>
                                    <option value="afternoon">Afternoon</option>
                                    <option value="evening">Evening</option>
                                </select>
                            </div>

                            <!-- Date Range Preset -->
                            <div>
                                <label class="form-label">Date Range</label>
                                <select id="bookingsDatePreset" class="form-input" onchange="onBookingsDatePresetChange()">
                                    <option value="all">All Dates</option>
                                    <option value="today">Today</option>
                                    <option value="tomorrow">Tomorrow</option>
                                    <option value="thisweek">This Week</option>
                                    <option value="next7days">Next 7 Days</option>
                                    <option value="custom">Custom Range...</option>
                                </select>
                            </div>

                            <!-- Custom Date From -->
                            <div id="bookingsDateFromGroup" style="display: none;">
                                <label class="form-label">From Date</label>
                                <input type="date" id="bookingsDateFrom" class="form-input" onchange="onBookingsDateRangeChange()">
                            </div>

                            <!-- Custom Date To -->
                            <div id="bookingsDateToGroup" style="display: none;">
                                <label class="form-label">To Date</label>
                                <input type="date" id="bookingsDateTo" class="form-input" onchange="onBookingsDateRangeChange()">
                            </div>

                            <!-- Clear Filters Button -->
                            <div>
                                <button class="btn btn-outline" onclick="clearAllBookingsFilters()" style="width: 100%;">Clear All</button>
                            </div>
                        </div>
                    </div>

                    <!-- List View -->
                    <div id="bookingsListView">
                        <!-- Bulk Actions Bar -->
                        <div id="bookingsBulkActionsBar" class="data-card" style="display: none; margin-bottom: 15px; padding: 15px; background: var(--primary-light); border: 2px solid var(--primary);">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <span style="font-weight: 600; color: var(--primary);" id="bookingsSelectedCount">0 selected</span>
                                <button class="btn btn-sm" onclick="bulkConfirmBookings()" style="background: var(--success); color: white;">✓ Confirm Selected</button>
                                <button class="btn btn-sm" onclick="bulkCompleteBookings()" style="background: var(--info); color: white;">✓ Complete Selected</button>
                                <button class="btn btn-sm btn-outline" onclick="bulkCancelBookings()" style="color: var(--danger); border-color: var(--danger);">✗ Cancel Selected</button>
                                <button class="btn btn-sm btn-outline" onclick="deselectAllBookings()" style="margin-left: auto;">Deselect All</button>
                            </div>
                        </div>

                        <div class="data-card">
                            <div class="data-card-header">
                                <div>
                                    <h3 class="data-card-title">Bookings</h3>
                                    <span style="color: var(--gray-medium); font-size: 13px;" id="bookingsTotalCount">Loading...</span>
                                </div>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <label style="display: flex; align-items: center; gap: 8px; font-size: 14px; cursor: pointer;">
                                        <input type="checkbox" id="bookingsGroupByDate" onchange="toggleBookingsGrouping()" style="cursor: pointer;">
                                        <span>Group by Date</span>
                                    </label>
                                </div>
                            </div>
                            <div style="overflow-x: auto;">
                                <table class="data-table" id="bookingsTable" style="position: relative;">
                                    <thead style="position: sticky; top: 0; background: white; z-index: 10;">
                                        <tr>
                                            <th style="width: 40px;">
                                                <input type="checkbox" id="bookingsSelectAll" onchange="toggleSelectAllBookings()" title="Select all on this page">
                                            </th>
                                            <th style="width: 80px;">ID</th>
                                            <th style="cursor: pointer;" onclick="sortBookingsBy('customer')">
                                                Client <span id="sortIconCustomer">↕</span>
                                            </th>
                                            <th style="cursor: pointer;" onclick="sortBookingsBy('service')">
                                                Service <span id="sortIconService">↕</span>
                                            </th>
                                            <th style="cursor: pointer;" onclick="sortBookingsBy('stylist')">
                                                Stylist <span id="sortIconStylist">↕</span>
                                            </th>
                                            <th style="cursor: pointer;" onclick="sortBookingsBy('date')">
                                                Date <span id="sortIconDate">↕</span>
                                            </th>
                                            <th>Time</th>
                                            <th style="cursor: pointer;" onclick="sortBookingsBy('status')">
                                                Status <span id="sortIconStatus">↕</span>
                                            </th>
                                            <th>Payment</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="bookingsTableBody">
                                        <tr>
                                            <td colspan="10" style="text-align: center; padding: 40px; color: var(--gray-medium);">
                                                Loading bookings...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Pagination Controls -->
                            <div id="bookingsPagination" class="data-card-footer" style="display: none; justify-content: space-between; align-items: center; padding: 15px; border-top: 1px solid var(--gray-light);">
                                <div style="color: var(--gray-medium); font-size: 14px;" id="bookingsPaginationInfo">
                                    Showing 1-50 of 125
                                </div>
                                <div style="display: flex; gap: 5px;">
                                    <button class="btn btn-sm btn-outline" id="bookingsPrevPage" onclick="goToBookingsPage('prev')" disabled>← Previous</button>
                                    <div id="bookingsPaginationPages" style="display: flex; gap: 5px;">
                                        <!-- Page numbers rendered dynamically -->
                                    </div>
                                    <button class="btn btn-sm btn-outline" id="bookingsNextPage" onclick="goToBookingsPage('next')">Next →</button>
                                </div>
                                <div>
                                    <select id="bookingsPageSize" class="form-input" onchange="onBookingsPageSizeChange()" style="width: auto; padding: 5px 10px; font-size: 13px;">
                                        <option value="25">25 per page</option>
                                        <option value="50" selected>50 per page</option>
                                        <option value="100">100 per page</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Calendar View -->
                    <div id="bookingsCalendarView" style="display: none;">
                        <div class="data-card">
                            <div class="data-card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <button class="btn btn-sm btn-outline" onclick="changeBookingsCalendarPeriod(-1)">◀</button>
                                    <h3 class="data-card-title" id="bookingsCalendarLabel" style="min-width: 200px; text-align: center;">November 2025</h3>
                                    <button class="btn btn-sm btn-outline" onclick="changeBookingsCalendarPeriod(1)">▶</button>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div style="display: flex; border: 1px solid var(--gray-light); border-radius: 6px; overflow: hidden;">
                                        <button id="calendarDayBtn" class="btn btn-sm" style="border-radius: 0; border: none;" onclick="setCalendarView('day')">Day</button>
                                        <button id="calendarWeekBtn" class="btn btn-sm btn-outline" style="border-radius: 0; border: none; border-left: 1px solid var(--gray-light);" onclick="setCalendarView('week')">Week</button>
                                        <button id="calendarMonthBtn" class="btn btn-sm btn-outline" style="border-radius: 0; border: none; border-left: 1px solid var(--gray-light);" onclick="setCalendarView('month')">Month</button>
                                    </div>
                                    <button class="btn btn-sm btn-outline" onclick="goToCalendarToday()">Today</button>
                                </div>
                            </div>
                            <div style="padding: 20px;">
                                <!-- Day View -->
                                <div id="calendarDayView" style="display: none;">
                                    <div style="border: 1px solid var(--gray-light); border-radius: 8px; overflow: hidden;">
                                        <div style="background: var(--gray-light); padding: 12px 15px; font-weight: 600; border-bottom: 1px solid var(--gray-light);">
                                            <span id="dayViewDate">Thursday, November 28, 2025</span>
                                        </div>
                                        <div id="dayViewGrid" style="position: relative; height: 600px; overflow-y: auto;">
                                            <!-- Time slots 6 AM to 10 PM -->
                                            <div style="display: grid; grid-template-columns: 80px 1fr; border-bottom: 1px solid var(--gray-light);">
                                                <div style="border-right: 1px solid var(--gray-light); padding: 0;">
                                                    <!-- Time labels -->
                                                </div>
                                                <div style="position: relative; min-height: 600px;">
                                                    <!-- Booking slots -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Week View -->
                                <div id="calendarWeekView" style="display: none;">
                                    <div style="border: 1px solid var(--gray-light); border-radius: 8px; overflow: hidden;">
                                        <div style="display: grid; grid-template-columns: 80px repeat(7, 1fr); background: var(--gray-light); border-bottom: 1px solid var(--gray-light);">
                                            <div style="border-right: 1px solid var(--gray-light); padding: 12px 10px; text-align: center; font-size: 11px; color: var(--gray-medium);">TIME</div>
                                            <div style="border-right: 1px solid var(--gray-light); padding: 12px 10px; text-align: center; font-weight: 600; font-size: 12px;">SUN</div>
                                            <div style="border-right: 1px solid var(--gray-light); padding: 12px 10px; text-align: center; font-weight: 600; font-size: 12px;">MON</div>
                                            <div style="border-right: 1px solid var(--gray-light); padding: 12px 10px; text-align: center; font-weight: 600; font-size: 12px;">TUE</div>
                                            <div style="border-right: 1px solid var(--gray-light); padding: 12px 10px; text-align: center; font-weight: 600; font-size: 12px;">WED</div>
                                            <div style="border-right: 1px solid var(--gray-light); padding: 12px 10px; text-align: center; font-weight: 600; font-size: 12px;">THU</div>
                                            <div style="border-right: 1px solid var(--gray-light); padding: 12px 10px; text-align: center; font-weight: 600; font-size: 12px;">FRI</div>
                                            <div style="padding: 12px 10px; text-align: center; font-weight: 600; font-size: 12px;">SAT</div>
                                        </div>
                                        <div id="weekViewGrid" style="display: grid; grid-template-columns: 80px repeat(7, 1fr); height: 600px; overflow-y: auto;">
                                            <!-- Week grid rendered by JS -->
                                        </div>
                                    </div>
                                </div>

                                <!-- Month View -->
                                <div id="calendarMonthView" style="display: block;">
                                    <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-bottom: 10px;">
                                        <div style="text-align: center; font-weight: 600; padding: 10px; color: var(--gray-medium); font-size: 12px;">SUN</div>
                                        <div style="text-align: center; font-weight: 600; padding: 10px; color: var(--gray-medium); font-size: 12px;">MON</div>
                                        <div style="text-align: center; font-weight: 600; padding: 10px; color: var(--gray-medium); font-size: 12px;">TUE</div>
                                        <div style="text-align: center; font-weight: 600; padding: 10px; color: var(--gray-medium); font-size: 12px;">WED</div>
                                        <div style="text-align: center; font-weight: 600; padding: 10px; color: var(--gray-medium); font-size: 12px;">THU</div>
                                        <div style="text-align: center; font-weight: 600; padding: 10px; color: var(--gray-medium); font-size: 12px;">FRI</div>
                                        <div style="text-align: center; font-weight: 600; padding: 10px; color: var(--gray-medium); font-size: 12px;">SAT</div>
                                    </div>
                                    <div id="bookingsCalendarGrid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px;">
                                        <!-- Calendar days rendered by JS -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Day Details Popup -->
                    <div id="bookingsDayPopup" class="modal" style="display: none;">
                        <div class="modal-content" style="max-width: 500px;">
                            <div class="modal-header">
                                <h3 id="bookingsDayPopupTitle">Bookings for June 15</h3>
                                <button class="modal-close" onclick="closeBookingsDayPopup()">&times;</button>
                            </div>
                            <div class="modal-body" id="bookingsDayPopupContent">
                                <!-- Bookings for selected day -->
                            </div>
                        </div>
                    </div>

                    <!-- Edit Booking Modal -->
                    <div id="editBookingModal" class="modal-overlay" style="display: none;">
                        <div class="modal" style="max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column;">
                            <div class="modal-header">
                                <h3 class="modal-title">Edit Booking</h3>
                                <button class="modal-close" onclick="closeModal('editBookingModal')">&times;</button>
                            </div>
                            <div class="modal-body" style="flex: 1; overflow-y: auto;">
                                <div class="form-group">
                                    <label class="form-label">Customer</label>
                                    <input type="text" id="editBookingCustomer" class="form-input" readonly style="background: var(--gray-light);">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Service</label>
                                    <select id="editBookingService" class="form-input">
                                        <!-- Populated by JS -->
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Stylist</label>
                                    <select id="editBookingStylist" class="form-input">
                                        <option value="">Any Available</option>
                                        <!-- Populated by JS -->
                                    </select>
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div class="form-group">
                                        <label class="form-label">Date</label>
                                        <input type="date" id="editBookingDate" class="form-input" required>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Time</label>
                                        <input type="time" id="editBookingTime" class="form-input">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Duration (minutes)</label>
                                    <input type="number" id="editBookingDuration" class="form-input" placeholder="60" min="15" step="15">
                                    <small style="color: var(--gray-medium); font-size: 12px;">Typical duration for the selected service</small>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Status</label>
                                    <select id="editBookingStatus" class="form-input">
                                        <option value="pending">Pending</option>
                                        <option value="confirmed">Confirmed</option>
                                        <option value="completed">Completed</option>
                                        <option value="cancelled">Cancelled</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Commission Rate Override (%)</label>
                                    <input type="number" id="editBookingCommissionRate" class="form-input" min="0" max="100" step="1" placeholder="Leave blank for default">
                                    <small style="color: var(--text-subtle);">Override the service/stylist default commission for this booking</small>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Notes</label>
                                    <textarea id="editBookingNotes" class="form-input" rows="3" placeholder="Special requests or notes..."></textarea>
                                </div>

                                <div id="editBookingError" style="color: var(--danger); margin-bottom: 15px; display: none;"></div>

                                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                                    <button class="btn btn-outline" onclick="closeModal('editBookingModal')">Cancel</button>
                                    <button class="btn btn-primary" onclick="saveBookingEdit()">Save Changes</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Booking Payment Modal -->
                    <div id="bookingPaymentModal" class="modal-overlay" style="display: none;">
                        <div class="modal" style="max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
                            <div class="modal-header">
                                <h3 class="modal-title">Booking Payment</h3>
                                <button class="modal-close" onclick="closeModal('bookingPaymentModal')">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div id="bookingPaymentInfo" style="background: var(--gray-light); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                                    <!-- Populated by JS -->
                                </div>

                                <div style="display: grid; gap: 10px; margin-bottom: 20px;">
                                    <button class="btn btn-primary" onclick="sendPaymentLink()" style="width: 100%;">
                                        📧 Send PayFast Payment Link
                                    </button>
                                    <p style="text-align: center; color: var(--gray-medium); font-size: 12px; margin: 5px 0;">
                                        Sends a secure payment link to the customer via email
                                    </p>
                                </div>

                                <div style="border-top: 1px solid var(--gray-light); padding-top: 20px;">
                                    <h4 style="margin: 0 0 15px; color: var(--brand-charcoal);">Record Manual Payment</h4>

                                    <div class="form-group">
                                        <label class="form-label">Payment Method</label>
                                        <select id="paymentMethod" class="form-input">
                                            <option value="cash">Cash</option>
                                            <option value="card_on_site">Card (On-Site)</option>
                                            <option value="eft">EFT / Bank Transfer</option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Amount (R)</label>
                                        <input type="number" id="paymentAmount" class="form-input" step="0.01" min="0">
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Reference (Optional)</label>
                                        <input type="text" id="paymentReference" class="form-input" placeholder="Receipt #, EFT ref, etc.">
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Notes (Optional)</label>
                                        <textarea id="paymentNotes" class="form-input" rows="2" placeholder="Additional notes..."></textarea>
                                    </div>

                                    <div id="paymentError" style="color: var(--danger); margin-bottom: 15px; display: none;"></div>

                                    <button class="btn btn-primary" onclick="recordManualPayment()" style="width: 100%;">
                                        Record Payment
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Assign Time Modal -->
                    <div id="assignTimeModal" class="modal-overlay" style="display: none;">
                        <div class="modal" style="max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column;">
                            <div class="modal-header">
                                <h3 class="modal-title">Assign Appointment Time</h3>
                                <button class="modal-close" onclick="closeModal('assignTimeModal')">&times;</button>
                            </div>
                            <div class="modal-body" style="flex: 1; overflow-y: auto;">
                                <!-- Booking Summary -->
                                <div style="background: var(--gray-light); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                                    <h4 style="margin: 0 0 10px 0; font-size: 16px;">Booking Request Details</h4>
                                    <div style="display: grid; grid-template-columns: auto 1fr; gap: 8px 15px; font-size: 14px;">
                                        <strong>Customer:</strong> <span id="assignTimeCustomer">-</span>
                                        <strong>Requested Date:</strong> <span id="assignTimeRequestedDate">-</span>
                                        <strong>Time Window:</strong> <span id="assignTimeWindow">-</span>
                                    </div>
                                </div>

                                <!-- Service Selection -->
                                <div class="form-group">
                                    <label class="form-label">Service <span style="color: var(--danger);">*</span></label>
                                    <select id="assignTimeServiceSelect" class="form-input" onchange="updateServiceDuration()">
                                        <option value="">Select service...</option>
                                        <!-- Populated by JS -->
                                    </select>
                                </div>

                                <!-- Stylist Selection -->
                                <div class="form-group">
                                    <label class="form-label">Assign to Stylist <span style="color: var(--danger);">*</span></label>
                                    <select id="assignTimeStylist" class="form-input" onchange="loadStylistSchedule()">
                                        <option value="">Select stylist...</option>
                                        <!-- Populated by JS -->
                                    </select>
                                </div>

                                <!-- Date Selection -->
                                <div class="form-group">
                                    <label class="form-label">Appointment Date <span style="color: var(--danger);">*</span></label>
                                    <input type="date" id="assignTimeDate" class="form-input" onchange="loadStylistSchedule()">
                                </div>

                                <!-- Time Slot Selection -->
                                <div class="form-group">
                                    <label class="form-label">Select Time Slot <span style="color: var(--danger);">*</span></label>
                                    <div id="timeSlotSchedule" style="min-height: 200px;">
                                        <div style="text-align: center; padding: 40px; color: var(--gray-medium);">
                                            Select a stylist and date to view available time slots
                                        </div>
                                    </div>
                                </div>

                                <!-- Duration -->
                                <div class="form-group">
                                    <label class="form-label">Duration (minutes)</label>
                                    <input type="number" id="assignTimeDuration" class="form-input" value="60" min="15" step="15">
                                    <small style="color: var(--gray-medium); font-size: 12px;">Based on selected service</small>
                                </div>

                                <div id="assignTimeError" style="color: var(--danger); margin-bottom: 15px; display: none;"></div>

                                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                                    <button class="btn btn-outline" onclick="closeModal('assignTimeModal')">Cancel</button>
                                    <button class="btn btn-primary" onclick="confirmAssignTime()">Assign Time & Confirm</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Staff Section -->
                <section id="staff" class="page-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>Staff Members</h3>
                        <button class="btn btn-primary" onclick="openAddStaffModal()">+ Add Staff Member</button>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div>
                                    <div class="stat-value">4</div>
                                    <div class="stat-label">Active Stylists</div>
                                </div>
                                <div class="stat-icon pink">👩‍🎨</div>
                            </div>
                        </div>
                    </div>

                    <div class="data-card">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Staff Member</th>
                                    <th>Role</th>
                                    <th>Bookings</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <img src="https://images.unsplash.com/photo-1595959183082-7b570b7e1dfa?w=80&h=80&fit=crop" class="avatar" alt="Lisa">
                                            <div>
                                                <div style="font-weight: 500;">Lisa Thompson</div>
                                                <div style="font-size: 12px; color: var(--gray-medium);">8 years experience</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>Senior Stylist</td>
                                    <td>Tape Extensions, Weft</td>
                                    <td>⭐ 4.9 (127)</td>
                                    <td>42 this month</td>
                                    <td>
                                        <label class="toggle-switch">
                                            <input type="checkbox" checked>
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </td>
                                    <td class="action-btns">
                                        <button class="btn btn-icon btn-outline" onclick="editStaff(1)">✏️</button>
                                        <button class="btn btn-icon btn-outline">📊</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <img src="https://images.unsplash.com/photo-1580618672591-eb180b1a973f?w=80&h=80&fit=crop" class="avatar" alt="Emma">
                                            <div>
                                                <div style="font-weight: 500;">Emma Williams</div>
                                                <div style="font-size: 12px; color: var(--gray-medium);">6 years experience</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>Extension Specialist</td>
                                    <td>Keratin Bonds, Volume</td>
                                    <td>⭐ 4.8 (94)</td>
                                    <td>38 this month</td>
                                    <td>
                                        <label class="toggle-switch">
                                            <input type="checkbox" checked>
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </td>
                                    <td class="action-btns">
                                        <button class="btn btn-icon btn-outline">✏️</button>
                                        <button class="btn btn-icon btn-outline">📊</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <img src="https://images.unsplash.com/photo-1522337360788-8b13dee7a37e?w=80&h=80&fit=crop" class="avatar" alt="Sarah">
                                            <div>
                                                <div style="font-weight: 500;">Sarah Martinez</div>
                                                <div style="font-size: 12px; color: var(--gray-medium);">10 years experience</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>Color Expert</td>
                                    <td>Color Match, Balayage</td>
                                    <td>⭐ 5.0 (203)</td>
                                    <td>51 this month</td>
                                    <td>
                                        <label class="toggle-switch">
                                            <input type="checkbox" checked>
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </td>
                                    <td class="action-btns">
                                        <button class="btn btn-icon btn-outline">✏️</button>
                                        <button class="btn btn-icon btn-outline">📊</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <img src="https://images.unsplash.com/photo-1560066984-138dadb4c035?w=80&h=80&fit=crop" class="avatar" alt="Maya">
                                            <div>
                                                <div style="font-weight: 500;">Maya Johnson</div>
                                                <div style="font-size: 12px; color: var(--gray-medium);">5 years experience</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>Maintenance Expert</td>
                                    <td>Maintenance, Repairs</td>
                                    <td>⭐ 4.9 (156)</td>
                                    <td>35 this month</td>
                                    <td>
                                        <label class="toggle-switch">
                                            <input type="checkbox" checked>
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </td>
                                    <td class="action-btns">
                                        <button class="btn btn-icon btn-outline">✏️</button>
                                        <button class="btn btn-icon btn-outline">📊</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Payroll Section -->
                <section id="payroll" class="page-section">
                    <div class="section-header">
                        <h2>Payroll Management</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-outline" onclick="exportPayrollCSV()">Export CSV</button>
                            <button class="btn btn-primary" onclick="generatePayroll()">Generate Payroll</button>
                        </div>
                    </div>

                    <!-- Period Selector -->
                    <div class="card" style="margin-bottom: 20px;">
                        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                            <div>
                                <label style="font-size: 14px; color: var(--gray-medium); display: block; margin-bottom: 5px;">Year</label>
                                <select id="payrollYear" class="filter-select" onchange="loadPayroll()">
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 14px; color: var(--gray-medium); display: block; margin-bottom: 5px;">Month</label>
                                <select id="payrollMonth" class="filter-select" onchange="loadPayroll()">
                                    <option value="1">January</option>
                                    <option value="2">February</option>
                                    <option value="3">March</option>
                                    <option value="4">April</option>
                                    <option value="5">May</option>
                                    <option value="6">June</option>
                                    <option value="7">July</option>
                                    <option value="8">August</option>
                                    <option value="9">September</option>
                                    <option value="10">October</option>
                                    <option value="11">November</option>
                                    <option value="12">December</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size: 14px; color: var(--gray-medium); display: block; margin-bottom: 5px;">Status</label>
                                <select id="payrollStatus" class="filter-select" onchange="loadPayroll()">
                                    <option value="">All</option>
                                    <option value="draft">Draft</option>
                                    <option value="finalized">Finalized</option>
                                    <option value="paid">Paid</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Summary Cards -->
                    <div class="stats-grid" id="payrollSummaryCards">
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div>
                                    <div class="stat-value" id="payrollTotalBasic">R0</div>
                                    <div class="stat-label">Total Basic Pay</div>
                                </div>
                                <div class="stat-icon blue">💵</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div>
                                    <div class="stat-value" id="payrollTotalCommission">R0</div>
                                    <div class="stat-label">Total Commission</div>
                                </div>
                                <div class="stat-icon green">📈</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div>
                                    <div class="stat-value" id="payrollTotalGross">R0</div>
                                    <div class="stat-label">Total Gross Pay</div>
                                </div>
                                <div class="stat-icon pink">💰</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div>
                                    <div class="stat-value" id="payrollStylistCount">0</div>
                                    <div class="stat-label">Stylists</div>
                                </div>
                                <div class="stat-icon gold">👩‍🎨</div>
                            </div>
                        </div>
                    </div>

                    <!-- Payroll Table -->
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Payroll Records</h3>
                            <span style="color: var(--gray-medium);" id="payrollRecordsCount">0 records</span>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Stylist</th>
                                    <th>Basic Pay</th>
                                    <th>Commission Rate</th>
                                    <th>Bookings</th>
                                    <th>Revenue (ex VAT)</th>
                                    <th>Commission</th>
                                    <th>Gross Pay</th>
                                    <th>Status</th>
                                    <th style="width: 180px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="payrollTableBody">
                                <tr>
                                    <td colspan="9" style="text-align: center; padding: 40px; color: var(--gray-medium);">
                                        Select a period and click "Generate Payroll" to calculate
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Stylist Pay Settings -->
                    <div class="data-card" style="margin-top: 20px;">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Stylist Pay Settings</h3>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Stylist</th>
                                    <th>Basic Monthly Salary</th>
                                    <th style="width: 120px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="stylistPaySettingsBody">
                                <tr>
                                    <td colspan="3" style="text-align: center; padding: 20px; color: var(--gray-medium);">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                        <p style="margin-top: 12px; font-size: 13px; color: var(--gray-medium);">
                            Commission rates are configured per service in the Services section.
                        </p>
                    </div>
                </section>

                <!-- Payroll Detail Modal -->
                <div id="payrollDetailModal" class="modal-overlay">
                    <div class="modal" style="max-width: 600px; width: 90%;">
                        <div class="modal-header">
                            <h3>Payroll Details</h3>
                            <button class="modal-close" onclick="closeModal('payrollDetailModal')">&times;</button>
                        </div>
                        <div class="modal-body" id="payrollDetailContent">
                            <!-- Content will be populated dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Stylist Pay Edit Modal -->
                <div id="stylistPayModal" class="modal-overlay">
                    <div class="modal" style="max-width: 480px; width: 95%;">
                        <div class="modal-header" style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; border-radius: 12px 12px 0 0; padding: 20px 24px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="width: 44px; height: 44px; background: rgba(255,255,255,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px;">
                                    💰
                                </div>
                                <div>
                                    <h3 style="margin: 0; font-size: 18px; font-weight: 600;">Basic Salary Settings</h3>
                                    <p style="margin: 4px 0 0 0; font-size: 13px; opacity: 0.9;" id="stylistPayNameHeader">Stylist Name</p>
                                </div>
                            </div>
                            <button class="modal-close" onclick="closeModal('stylistPayModal')" style="color: white; opacity: 0.8;">&times;</button>
                        </div>
                        <div class="modal-body" style="padding: 24px;">
                            <input type="hidden" id="stylistPayId">
                            <input type="hidden" id="stylistPayName">

                            <!-- Basic Pay Section -->
                            <div style="background: var(--gray-lightest); border-radius: 12px; padding: 20px;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                                    <span style="font-size: 18px;">📋</span>
                                    <span style="font-weight: 600; color: var(--gray-dark);">Basic Monthly Salary</span>
                                </div>
                                <div style="position: relative;">
                                    <span style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); font-weight: 600; color: var(--gray-medium); font-size: 16px;">R</span>
                                    <input type="number" id="stylistBasicPay" min="0" step="100" placeholder="0.00"
                                           style="padding-left: 36px; font-size: 24px; font-weight: 600; height: 56px; border-radius: 10px;">
                                </div>
                                <p style="margin: 10px 0 0 0; font-size: 12px; color: var(--gray-medium);">
                                    Fixed monthly amount paid regardless of bookings
                                </p>
                            </div>

                            <!-- Info about commission -->
                            <div style="margin-top: 16px; padding: 14px; background: #FFF8E1; border-radius: 10px; border-left: 3px solid #FFC107;">
                                <p style="margin: 0; font-size: 13px; color: #5D4E37; line-height: 1.5;">
                                    <strong>Note:</strong> Commission rates are configured per service in the <strong>Services</strong> section.
                                    Each service can have its own commission rate.
                                </p>
                            </div>
                        </div>
                        <div class="modal-footer" style="padding: 16px 24px 24px; border-top: none; gap: 12px;">
                            <button class="btn btn-outline" onclick="closeModal('stylistPayModal')" style="flex: 1;">Cancel</button>
                            <button class="btn btn-primary" onclick="saveStylistPay()" style="flex: 2;">
                                <span style="margin-right: 6px;">✓</span> Save Salary
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Customers Section -->
                <section id="customers" class="page-section">
                    <div class="filters-bar">
                        <div class="search-box" style="flex: 1; max-width: 300px;">
                            <span>🔍</span>
                            <input type="text" placeholder="Search customers...">
                        </div>
                        <select class="filter-select">
                            <option>All Tiers</option>
                            <option>Platinum</option>
                            <option>Gold</option>
                            <option>Silver</option>
                            <option>Bronze</option>
                        </select>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <button class="btn btn-primary" onclick="openCustomerModal()">+ Add Customer</button>
                            <button class="btn btn-outline">Export CSV</button>
                        </div>
                    </div>

                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Customer Database</h3>
                            <span style="color: var(--gray-medium);" id="customersCount">0 customers</span>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Customer</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Tier</th>
                                    <th>Points</th>
                                    <th>Total Spent</th>
                                    <th>Last Visit</th>
                                    <th style="width: 130px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Customer Modal -->
                <div id="customerModal" class="modal-overlay">
                    <div class="modal" style="max-width: 520px; width: 90%;">
                        <div class="modal-header">
                            <h3 class="modal-title" id="customerModalTitle">Add Customer</h3>
                            <button class="modal-close" onclick="closeCustomerModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" id="editingCustomerId">
                            <div class="form-group">
                                <label class="form-label">Full Name *</label>
                                <input type="text" class="form-input" id="customerName" placeholder="Customer name">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email *</label>
                                <input type="email" class="form-input" id="customerEmail" placeholder="customer@email.com">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Phone</label>
                                <input type="tel" class="form-input" id="customerPhone" placeholder="+27 82 123 4567">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Tier</label>
                                    <select class="form-input" id="customerTier">
                                        <option value="bronze">Bronze</option>
                                        <option value="silver">Silver</option>
                                        <option value="gold">Gold</option>
                                        <option value="platinum">Platinum</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Points</label>
                                    <input type="number" class="form-input" id="customerPoints" value="0" min="0">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Password (optional for new customers)</label>
                                <input type="text" class="form-input" id="customerPassword" placeholder="Leave blank to auto-generate">
                            </div>
                            <!-- Reset Password Section (only shown when editing) -->
                            <div id="resetPasswordSection" class="form-group" style="display: none; border-top: 1px solid var(--gray-light); padding-top: 15px; margin-top: 15px;">
                                <label class="form-label">Password Reset</label>
                                <p style="font-size: 12px; color: var(--gray-dark); margin-bottom: 10px;">Generate a new temporary password and optionally send it to the customer via email.</p>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <button type="button" class="btn btn-outline" onclick="resetCustomerPassword()" style="flex-shrink: 0;">
                                        🔑 Reset Password
                                    </button>
                                    <label style="display: flex; align-items: center; gap: 5px; font-size: 13px; color: var(--gray-dark);">
                                        <input type="checkbox" id="sendResetEmail" checked> Send email to customer
                                    </label>
                                </div>
                                <div id="resetPasswordResult" style="margin-top: 10px; padding: 10px; border-radius: 8px; display: none;"></div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-outline" onclick="closeCustomerModal()">Cancel</button>
                            <button class="btn btn-primary" onclick="saveCustomer()">Save Customer</button>
                        </div>
                    </div>
                </div>

                <!-- Products Section -->
                <section id="products" class="page-section">
                    <div class="filters-bar">
                        <select class="filter-select">
                            <option>All Categories</option>
                            <option>Extensions</option>
                            <option>Care Products</option>
                            <option>Styling</option>
                        </select>
                        <select class="filter-select">
                            <option>All Stock</option>
                            <option>In Stock</option>
                            <option>Low Stock</option>
                            <option>Out of Stock</option>
                        </select>
                        <button class="btn btn-primary" onclick="openAddProductModal()">+ Add Product</button>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div>
                                    <div class="stat-value" id="productsTotalCount">0</div>
                                    <div class="stat-label">Total Products</div>
                                </div>
                                <div class="stat-icon pink">📦</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div>
                                    <div class="stat-value" id="productsLowStockCount">0</div>
                                    <div class="stat-label">Low Stock Alerts</div>
                                </div>
                                <div class="stat-icon" style="background: rgba(244, 67, 54, 0.1); color: var(--danger);">⚠️</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div>
                                    <div class="stat-value" id="productsInventoryValue">R0</div>
                                    <div class="stat-label">Inventory Value</div>
                                </div>
                                <div class="stat-icon green">💰</div>
                            </div>
                        </div>
                    </div>

                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Product Inventory</h3>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Sale Price</th>
                                    <th>Stock</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 20px; color: var(--gray-medium);">Loading products...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Orders Section -->
                <section id="orders" class="page-section">
                    <div class="filters-bar">
                        <select class="filter-select" id="orderStatusFilter">
                            <option value="">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="processing">Processing</option>
                            <option value="shipped">Shipped</option>
                            <option value="delivered">Delivered</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                        <select class="filter-select" id="orderDeliveryFilter">
                            <option value="">All Delivery Methods</option>
                            <option value="pickup">Pickup</option>
                            <option value="standard courier">Standard Courier</option>
                            <option value="express courier">Express Courier</option>
                        </select>
                        <input type="date" class="filter-select" id="orderDateFilter" aria-label="Filter orders by date">
                        <button class="btn btn-outline btn-small" id="orderFiltersClear" type="button">Clear</button>
                    </div>

                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Product Orders</h3>
                            <span style="color: var(--gray-medium);" id="orderCountText">Loading...</span>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Items</th>
                                    <th>Total</th>
                                    <th>Delivery</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTableBody">
                                <tr>
                                    <td colspan="7" style="text-align: center; color: var(--gray-medium); padding: 20px;">Loading orders...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Promotions Section -->
                <section id="promotions" class="page-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3>Active Promotions</h3>
                        <button class="btn btn-primary" onclick="openModal('addPromoModal')">+ Create Promotion</button>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div>
                                    <div class="stat-value" id="promoActiveCount">0</div>
                                    <div class="stat-label">Active Promos</div>
                                </div>
                                <div class="stat-icon pink">🏷️</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div>
                                    <div class="stat-value" id="promoCodesUsed">0</div>
                                    <div class="stat-label">Codes Used</div>
                                </div>
                                <div class="stat-icon gold">🎟️</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div>
                                    <div class="stat-value" id="promoDiscountsGiven">R0</div>
                                    <div class="stat-label">Discounts Given</div>
                                </div>
                                <div class="stat-icon green">💸</div>
                            </div>
                        </div>
                    </div>

                    <div class="data-card">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Description</th>
                                    <th>Discount</th>
                                    <th>Min Order</th>
                                    <th>Uses</th>
                                    <th>Special Offer</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Populated dynamically by loadPromos() -->
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Push Notifications Section -->
                <section id="notifications" class="page-section">
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Push Notifications</h3>
                            <button class="btn btn-primary btn-small" onclick="showCreateNotificationModal()">+ Create Notification</button>
                        </div>
                        <p style="color: var(--gray-medium); margin-bottom: 20px;">
                            Send branded notifications to all app users. Notifications appear as elegant toast messages in the client app.
                        </p>

                        <div id="notificationsList">
                            <!-- Notifications will be loaded dynamically -->
                            <div style="text-align: center; padding: 40px; color: var(--gray-medium);">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48" style="margin-bottom: 10px; opacity: 0.5;">
                                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                                    <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                                </svg>
                                <p>Loading notifications...</p>
                            </div>
                        </div>
                    </div>

                </section>

                <!-- Gallery Section -->
                <section id="gallery" class="page-section">
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Gallery Management</h3>
                            <div style="display:flex; gap:10px; align-items:center;">
                                <button class="btn btn-outline btn-small" onclick="openInstagramModal()">Instagram Feed</button>
                                <button class="btn btn-outline btn-small" onclick="importFlirthairGallery()">Import from flirthair.co.za</button>
                                <button class="btn btn-primary btn-small" onclick="showGalleryModal()">+ Add Image</button>
                            </div>
                        </div>
                        <p style="color: var(--gray-medium); margin-bottom: 20px;">
                            Manage the gallery images displayed on the client app. Drag to reorder, toggle visibility, or add new images.
                        </p>

                        <div class="data-card" style="margin-bottom: 15px;">
                            <div class="data-card-header">
                                <h4 class="data-card-title" style="font-size: 16px;">Instagram Feed</h4>
                                <span id="instagramStatus" style="font-size: 12px; color: var(--gray-medium);"></span>
                            </div>
                            <div style="padding: 15px; color: var(--gray-medium);">
                                Configure your Instagram handle to surface the feed in the client gallery.
                                <div style="margin-top: 10px;">
                                    <button class="btn btn-outline btn-small" onclick="openInstagramModal()">Configure</button>
                                </div>
                            </div>
                        </div>

                        <div id="galleryList" class="gallery-admin-grid">
                            <!-- Gallery items will be loaded dynamically -->
                            <div style="text-align: center; padding: 40px; color: var(--gray-medium); grid-column: 1/-1;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48" style="margin-bottom: 10px; opacity: 0.5;">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                    <polyline points="21 15 16 10 5 21"></polyline>
                                </svg>
                                <p>Loading gallery...</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Chat Section -->
                <section id="chat" class="page-section">
                    <div style="display: grid; grid-template-columns: 350px 1fr; gap: 20px; height: calc(100vh - 200px);">
                        <div class="data-card" style="margin: 0; display: flex; flex-direction: column;">
                            <div class="data-card-header">
                                <h3 class="data-card-title">Conversations</h3>
                                <span class="nav-badge" id="totalUnreadBadge" style="display: none;">0</span>
                            </div>
                            <div class="chat-list" id="adminChatList">
                                <!-- Conversations loaded dynamically -->
                                <div style="text-align: center; padding: 40px; color: var(--gray-medium);">
                                    Loading conversations...
                                </div>
                            </div>
                        </div>
                        <div class="data-card" style="margin: 0; display: flex; flex-direction: column;">
                            <div class="data-card-header" id="chatHeader">
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <div class="chat-avatar" id="selectedChatAvatar">?</div>
                                    <div>
                                        <div style="font-weight: 600;" id="selectedChatName">Select a conversation</div>
                                        <div style="font-size: 12px; color: var(--gray-medium);" id="selectedChatStatus"></div>
                                    </div>
                                </div>
                                <div class="action-btns" id="chatActions" style="display: none;">
                                    <button class="btn btn-outline btn-sm" onclick="closeConversation()">Close Chat</button>
                                </div>
                            </div>
                            <div style="flex: 1; padding: 20px; overflow-y: auto; background: var(--gray-light);" id="chatMessagesAdmin">
                                <div style="text-align: center; padding: 60px 20px; color: var(--gray-medium);">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48" style="margin-bottom: 15px; opacity: 0.5;">
                                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                    </svg>
                                    <p>Select a conversation from the left to view messages</p>
                                </div>
                            </div>
                            <div style="padding: 15px; border-top: 1px solid var(--gray-light); display: flex; gap: 10px;" id="chatInputArea">
                                <input type="text" class="form-input" id="adminChatInput" placeholder="Type a message..." style="flex: 1;" onkeydown="handleAdminChatKeypress(event)" disabled>
                                <button class="btn btn-primary" id="adminSendBtn" onclick="sendAdminChatMessage()" disabled>Send</button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Hair Tips Section -->
                <section id="hair-tips" class="page-section">
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Hair Care Tips</h3>
                            <button class="btn btn-primary btn-sm" onclick="openHairTipModal()">+ Add Tip</button>
                        </div>
                        <div style="padding: 20px;">
                            <p style="color: var(--gray-medium); margin-bottom: 20px;">
                                Manage the hair care tips that rotate on the customer app. Active tips are shown randomly to customers on each visit.
                            </p>
                            <div id="hairTipsList" style="display: flex; flex-direction: column; gap: 12px;">
                                <div style="text-align: center; padding: 40px; color: var(--gray-medium);">
                                    Loading tips...
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Hair Tip Modal -->
                <div id="hairTipModal" class="modal-overlay">
                    <div class="modal" style="max-width: 520px; width: 90%;">
                        <div class="modal-header">
                            <h3 id="hairTipModalTitle">Add New Hair Tip</h3>
                            <button class="modal-close" onclick="closeHairTipModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" id="editHairTipId">
                            <div class="form-group">
                                <label class="form-label">Tip Text *</label>
                                <textarea class="form-input" id="hairTipText" rows="4" placeholder="Enter the hair care tip..." style="resize: vertical;"></textarea>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Category</label>
                                    <select class="form-input" id="hairTipCategory">
                                        <option value="general">General</option>
                                        <option value="extensions">Extensions</option>
                                        <option value="styling">Styling</option>
                                        <option value="care">Care</option>
                                        <option value="maintenance">Maintenance</option>
                                        <option value="wash">Wash</option>
                                        <option value="treatment">Treatment</option>
                                        <option value="heat">Heat</option>
                                        <option value="detangle">Detangle</option>
                                        <option value="scalp">Scalp</option>
                                        <option value="drying">Drying</option>
                                        <option value="protection">Protection</option>
                                        <option value="lifestyle">Lifestyle</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Priority</label>
                                    <select class="form-input" id="hairTipPriority">
                                        <option value="1">Normal</option>
                                        <option value="2">High</option>
                                        <option value="3">Featured</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-outline" onclick="closeHairTipModal()">Cancel</button>
                            <button class="btn btn-primary" onclick="saveHairTip()">Save Tip</button>
                        </div>
                    </div>
                </div>

                <!-- Settings Section -->
                <section id="settings" class="page-section">
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Business Settings</h3>
                        </div>
                        <div style="padding: 25px;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Business Name</label>
                                    <input type="text" class="form-input" id="settingsBusinessName" placeholder="Enter business name">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-input" id="settingsEmail" placeholder="Enter email address">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Phone</label>
                                    <input type="tel" class="form-input" id="settingsPhone" placeholder="Enter phone number">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Address</label>
                                    <input type="text" class="form-input" id="settingsAddress" placeholder="Enter full address">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Business Hours <span style="font-weight: normal; color: var(--gray-medium);">(click to edit)</span></label>
                                <div id="businessHoursGrid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px;">
                                    <!-- Hours will be populated by JavaScript -->
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="saveBusinessSettings()">Save Settings</button>
                        </div>
                    </div>

                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Service Pricing</h3>
                            <a href="#" onclick="navigateToSection('services'); return false;" class="btn btn-outline btn-sm">Manage Services</a>
                        </div>
                        <div style="padding: 20px; background: var(--gray-light); border-radius: 8px; margin: 15px;">
                            <p style="margin: 0; color: var(--gray-medium); font-size: 14px;">
                                Service pricing is managed in the <strong>Services</strong> section.
                                <a href="#" onclick="navigateToSection('services'); return false;" style="color: var(--primary);">Go to Services</a>
                            </p>
                        </div>
                    </div>

                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Delivery Settings</h3>
                        </div>
                        <div style="padding: 25px;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Standard Courier Fee</label>
                                    <div style="position: relative;">
                                        <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--gray-medium);">R</span>
                                        <input type="number" class="form-input" id="deliveryStandardFee" placeholder="65" style="padding-left: 30px;" min="0" step="0.01">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Express Courier Fee</label>
                                    <div style="position: relative;">
                                        <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--gray-medium);">R</span>
                                        <input type="number" class="form-input" id="deliveryExpressFee" placeholder="120" style="padding-left: 30px;" min="0" step="0.01">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Free Delivery Threshold</label>
                                <div style="position: relative; max-width: 200px;">
                                    <span style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--gray-medium);">R</span>
                                    <input type="number" class="form-input" id="deliveryFreeThreshold" placeholder="500" style="padding-left: 30px;" min="0" step="0.01">
                                </div>
                                <p style="font-size: 13px; color: var(--gray-medium); margin-top: 5px;">Orders above this amount get free standard delivery</p>
                            </div>
                            <button class="btn btn-primary" onclick="saveDeliverySettings()">Save Delivery Settings</button>
                        </div>
                    </div>
                </section>

                <!-- Loyalty Settings Section - Hidden for now, to be implemented later -->
                <section id="loyalty-settings" class="page-section" style="display: none !important;">
                    <div class="section-header">
                        <h2 class="section-title">Loyalty Program Settings</h2>
                        <p style="color: var(--gray-medium); margin-top: 5px;">Configure points earning rules and tier thresholds</p>
                    </div>

                    <!-- Points Earning Rules -->
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Points Earning Rules</h3>
                        </div>
                        <div style="padding: 25px;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Points per Booking</label>
                                    <input type="number" id="loyaltyBookingPoints" class="form-input" min="0" placeholder="50">
                                    <p style="font-size: 12px; color: var(--gray-medium); margin-top: 5px;">Points earned for each booking made</p>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Rands per Point (Shop)</label>
                                    <input type="number" id="loyaltySpendRand" class="form-input" min="1" placeholder="10">
                                    <p style="font-size: 12px; color: var(--gray-medium); margin-top: 5px;">Spend R X to earn 1 point on shop orders</p>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Review Bonus Points</label>
                                    <input type="number" id="loyaltyReviewPoints" class="form-input" min="0" placeholder="25">
                                    <p style="font-size: 12px; color: var(--gray-medium); margin-top: 5px;">Points earned for leaving a review</p>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Referral Bonus Points</label>
                                    <input type="number" id="loyaltyReferralPoints" class="form-input" min="0" placeholder="100">
                                    <p style="font-size: 12px; color: var(--gray-medium); margin-top: 5px;">Points for both referrer and referee</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tier Thresholds -->
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Loyalty Tier Thresholds</h3>
                        </div>
                        <div style="padding: 25px;">
                            <div class="form-row" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;">
                                <div class="form-group" style="text-align: center;">
                                    <div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #CD7F32, #8B4513); margin: 0 auto 10px; display: flex; align-items: center; justify-content: center;">
                                        <svg viewBox="0 0 24 24" fill="white" width="28" height="28"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                                    </div>
                                    <label class="form-label" style="font-weight: 600; color: #CD7F32;">Bronze</label>
                                    <input type="number" id="loyaltyTierBronze" class="form-input" value="0" disabled style="text-align: center; background: var(--surface-muted);">
                                    <p style="font-size: 11px; color: var(--gray-medium); margin-top: 5px;">Starting tier</p>
                                </div>
                                <div class="form-group" style="text-align: center;">
                                    <div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #C0C0C0, #808080); margin: 0 auto 10px; display: flex; align-items: center; justify-content: center;">
                                        <svg viewBox="0 0 24 24" fill="white" width="28" height="28"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                                    </div>
                                    <label class="form-label" style="font-weight: 600; color: #808080;">Silver</label>
                                    <input type="number" id="loyaltyTierSilver" class="form-input" min="1" placeholder="500" style="text-align: center;">
                                    <p style="font-size: 11px; color: var(--gray-medium); margin-top: 5px;">5% discount</p>
                                </div>
                                <div class="form-group" style="text-align: center;">
                                    <div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #FFD700, #B8860B); margin: 0 auto 10px; display: flex; align-items: center; justify-content: center;">
                                        <svg viewBox="0 0 24 24" fill="white" width="28" height="28"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                                    </div>
                                    <label class="form-label" style="font-weight: 600; color: #B8860B;">Gold</label>
                                    <input type="number" id="loyaltyTierGold" class="form-input" min="1" placeholder="1500" style="text-align: center;">
                                    <p style="font-size: 11px; color: var(--gray-medium); margin-top: 5px;">15% discount</p>
                                </div>
                                <div class="form-group" style="text-align: center;">
                                    <div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #E5E4E2, #71797E); margin: 0 auto 10px; display: flex; align-items: center; justify-content: center;">
                                        <svg viewBox="0 0 24 24" fill="white" width="28" height="28"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                                    </div>
                                    <label class="form-label" style="font-weight: 600; color: #71797E;">Platinum</label>
                                    <input type="number" id="loyaltyTierPlatinum" class="form-input" min="1" placeholder="5000" style="text-align: center;">
                                    <p style="font-size: 11px; color: var(--gray-medium); margin-top: 5px;">20% discount</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Referral Program Settings -->
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Referral Program Settings</h3>
                        </div>
                        <div style="padding: 25px;">
                            <div class="form-row">
                                <div class="form-group" style="flex: 0 0 auto;">
                                    <label class="form-label">Enable Referrals</label>
                                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                        <input type="checkbox" id="referralEnabled" checked style="width: 20px; height: 20px;">
                                        <span>Active</span>
                                    </label>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Discount Type</label>
                                    <select id="referralDiscountType" class="form-input">
                                        <option value="percent">Percentage (%)</option>
                                        <option value="amount">Fixed Amount (R)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Discount Value</label>
                                    <input type="number" id="referralDiscountValue" class="form-input" min="0" placeholder="10">
                                    <p style="font-size: 12px; color: var(--gray-medium); margin-top: 5px;">e.g. 10 = "10%" or "R10"</p>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Section Headline</label>
                                    <input type="text" id="referralHeadline" class="form-input" placeholder="Rewards & Referrals">
                                    <p style="font-size: 12px; color: var(--gray-medium); margin-top: 5px;">Main title shown in the app</p>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Subheading</label>
                                    <input type="text" id="referralSubheading" class="form-input" placeholder="Share your code and you both save!">
                                    <p style="font-size: 12px; color: var(--gray-medium); margin-top: 5px;">Text below the referral code</p>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Share Message Template</label>
                                <textarea id="referralShareMessage" class="form-input" rows="3" placeholder="Check out Flirt Hair Extensions! Use my code {code} for {discount} off your first booking! 💇✨"></textarea>
                                <p style="font-size: 12px; color: var(--gray-medium); margin-top: 5px;">
                                    Use <code style="background: #f0f0f0; padding: 2px 5px; border-radius: 3px;">{code}</code> for user's code and
                                    <code style="background: #f0f0f0; padding: 2px 5px; border-radius: 3px;">{discount}</code> for the discount (e.g. "10%" or "R50")
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Ways to Earn Points Editor -->
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Ways to Earn Points (Display)</h3>
                        </div>
                        <div style="padding: 25px;">
                            <p style="color: var(--gray-medium); margin-bottom: 15px; font-size: 14px;">
                                Configure the "Ways to Earn Points" list shown in the app. Labels can include <code style="background: #f0f0f0; padding: 2px 5px; border-radius: 3px;">{spendRand}</code> placeholder.
                            </p>
                            <div id="earnRulesEditor">
                                <!-- Dynamically populated -->
                            </div>
                        </div>
                    </div>

                    <!-- Tier Preview -->
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Live Tier Preview</h3>
                        </div>
                        <div id="tierPreview" style="padding: 25px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                                <div style="flex: 1; min-width: 200px; padding: 15px; background: linear-gradient(135deg, rgba(205,127,50,0.1), rgba(139,69,19,0.1)); border-radius: 8px; border-left: 4px solid #CD7F32;">
                                    <strong style="color: #CD7F32;">Bronze</strong>
                                    <p style="margin: 5px 0 0; font-size: 13px; color: var(--gray-medium);">0 - <span id="previewBronzeMax">499</span> points</p>
                                </div>
                                <div style="flex: 1; min-width: 200px; padding: 15px; background: linear-gradient(135deg, rgba(192,192,192,0.1), rgba(128,128,128,0.1)); border-radius: 8px; border-left: 4px solid #808080;">
                                    <strong style="color: #808080;">Silver</strong>
                                    <p style="margin: 5px 0 0; font-size: 13px; color: var(--gray-medium);"><span id="previewSilverMin">500</span> - <span id="previewSilverMax">1499</span> points</p>
                                </div>
                                <div style="flex: 1; min-width: 200px; padding: 15px; background: linear-gradient(135deg, rgba(255,215,0,0.1), rgba(184,134,11,0.1)); border-radius: 8px; border-left: 4px solid #B8860B;">
                                    <strong style="color: #B8860B;">Gold</strong>
                                    <p style="margin: 5px 0 0; font-size: 13px; color: var(--gray-medium);"><span id="previewGoldMin">1500</span> - <span id="previewGoldMax">4999</span> points</p>
                                </div>
                                <div style="flex: 1; min-width: 200px; padding: 15px; background: linear-gradient(135deg, rgba(229,228,226,0.1), rgba(113,121,126,0.1)); border-radius: 8px; border-left: 4px solid #71797E;">
                                    <strong style="color: #71797E;">Platinum</strong>
                                    <p style="margin: 5px 0 0; font-size: 13px; color: var(--gray-medium);"><span id="previewPlatinumMin">5000</span>+ points</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 15px; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="saveLoyaltySettings()" style="flex: 1;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" style="margin-right: 8px;"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                            Save Changes
                        </button>
                        <button class="btn btn-outline" onclick="resetLoyaltySettings()" style="flex: 1;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" style="margin-right: 8px;"><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg>
                            Reset to Defaults
                        </button>
                    </div>

                    <!-- Validation Errors -->
                    <div id="loyaltyErrors" style="margin-top: 15px; padding: 15px; background: rgba(244,67,54,0.1); border-radius: 8px; border-left: 4px solid var(--danger); display: none;">
                        <strong style="color: var(--danger);">Validation Errors:</strong>
                        <ul id="loyaltyErrorList" style="margin: 10px 0 0 20px; color: var(--danger);"></ul>
                    </div>

                    <!-- Success Message -->
                    <div id="loyaltySuccess" style="margin-top: 15px; padding: 15px; background: rgba(76,175,80,0.1); border-radius: 8px; border-left: 4px solid var(--success); display: none;">
                        <strong style="color: var(--success);">Settings saved successfully!</strong>
                    </div>
                </section>

                <!-- Rewards Programme Settings Section -->
                <section id="rewards-settings" class="page-section">
                    <div class="section-header">
                        <h2 class="section-title">Rewards Programme Settings</h2>
                        <p style="color: var(--gray-medium); margin-top: 5px;">Configure the salon rewards programme - milestones, discounts, and packages</p>
                    </div>

                    <!-- Programme Status -->
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Programme Status</h3>
                        </div>
                        <div style="padding: 25px;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Programme Enabled</label>
                                    <label class="switch" style="margin-top: 10px;">
                                        <input type="checkbox" id="rewardsProgrammeEnabled" checked>
                                        <span class="slider"></span>
                                    </label>
                                    <p style="font-size: 12px; color: var(--gray-medium); margin-top: 5px;">Enable or disable the entire rewards programme</p>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Programme Name</label>
                                    <input type="text" id="rewardsProgrammeName" class="form-input" placeholder="Salon Rewards">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Nails Rewards -->
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Nails Rewards Track</h3>
                            <label class="switch">
                                <input type="checkbox" id="rewardsNailsEnabled" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div style="padding: 25px;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">1st Milestone - Visit Count</label>
                                    <input type="number" id="rewardsNailsMilestone1Count" class="form-input" min="1" value="6">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">1st Milestone - Discount %</label>
                                    <input type="number" id="rewardsNailsMilestone1Discount" class="form-input" min="1" max="100" value="10">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">2nd Milestone - Visit Count</label>
                                    <input type="number" id="rewardsNailsMilestone2Count" class="form-input" min="1" value="12">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">2nd Milestone - Discount %</label>
                                    <input type="number" id="rewardsNailsMilestone2Discount" class="form-input" min="1" max="100" value="50">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Reward Expiry (days)</label>
                                    <input type="number" id="rewardsNailsExpiryDays" class="form-input" min="1" value="90">
                                    <p style="font-size: 12px; color: var(--gray-medium); margin-top: 5px;">Days until reward expires after being issued</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Maintenance Rewards -->
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Hair Extensions Maintenance Track</h3>
                            <label class="switch">
                                <input type="checkbox" id="rewardsMaintenanceEnabled" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div style="padding: 25px;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Milestone - Every X Visits</label>
                                    <input type="number" id="rewardsMaintenanceMilestoneCount" class="form-input" min="1" value="6">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Discount % at Milestone</label>
                                    <input type="number" id="rewardsMaintenanceDiscount" class="form-input" min="1" max="100" value="10">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Reward Expiry (days)</label>
                                    <input type="number" id="rewardsMaintenanceExpiryDays" class="form-input" min="1" value="90">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Spend & Save -->
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Spend & Save Track</h3>
                            <label class="switch">
                                <input type="checkbox" id="rewardsSpendEnabled" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div style="padding: 25px;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Spend Threshold (R)</label>
                                    <input type="number" id="rewardsSpendThreshold" class="form-input" min="100" value="10000">
                                    <p style="font-size: 12px; color: var(--gray-medium); margin-top: 5px;">Cumulative spend amount to earn reward</p>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Discount % at Threshold</label>
                                    <input type="number" id="rewardsSpendDiscount" class="form-input" min="1" max="100" value="20">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Reward Expiry (days)</label>
                                    <input type="number" id="rewardsSpendExpiryDays" class="form-input" min="1" value="90">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Referral Rewards -->
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Referral Rewards</h3>
                            <label class="switch">
                                <input type="checkbox" id="rewardsReferralEnabled" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div style="padding: 25px;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Minimum Booking Value (R)</label>
                                    <input type="number" id="rewardsReferralMinValue" class="form-input" min="0" value="1000">
                                    <p style="font-size: 12px; color: var(--gray-medium); margin-top: 5px;">Referee's first booking must be at least this amount</p>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Reward Description</label>
                                    <input type="text" id="rewardsReferralDescription" class="form-input" value="Complimentary wash & blow-dry">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Service Packages -->
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Service Packages</h3>
                            <label class="switch">
                                <input type="checkbox" id="rewardsPackagesEnabled" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div style="padding: 25px;">
                            <p style="color: var(--gray-medium); margin-bottom: 15px;">Configure pre-paid session packages (e.g., 4 wash & blow-dry sessions at 20% off)</p>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Default Package Sessions</label>
                                    <input type="number" id="rewardsPackageSessions" class="form-input" min="1" value="4">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Default Package Discount %</label>
                                    <input type="number" id="rewardsPackageDiscount" class="form-input" min="1" max="100" value="20">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Analytics Summary -->
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Rewards Analytics</h3>
                            <button class="btn btn-outline" onclick="loadRewardsAnalytics()">Refresh</button>
                        </div>
                        <div id="rewardsAnalyticsContent" style="padding: 25px;">
                            <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px;">
                                <div class="stat-card">
                                    <div class="stat-value" id="rewardsStatTotal">-</div>
                                    <div class="stat-label">Total Rewards Issued</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" id="rewardsStatActive">-</div>
                                    <div class="stat-label">Active Rewards</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" id="rewardsStatRedeemed">-</div>
                                    <div class="stat-label">Redeemed</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" id="rewardsStatUsers">-</div>
                                    <div class="stat-label">Users with Rewards</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Save Button -->
                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="saveRewardsSettings()">Save Rewards Settings</button>
                    </div>

                    <!-- Messages -->
                    <div id="rewardsErrors" style="margin-top: 15px; padding: 15px; background: rgba(244,67,54,0.1); border-radius: 8px; border-left: 4px solid var(--danger); display: none;">
                        <strong style="color: var(--danger);">Error:</strong>
                        <span id="rewardsErrorMessage"></span>
                    </div>
                    <div id="rewardsSuccess" style="margin-top: 15px; padding: 15px; background: rgba(76,175,80,0.1); border-radius: 8px; border-left: 4px solid var(--success); display: none;">
                        <strong style="color: var(--success);">Settings saved successfully!</strong>
                    </div>
                </section>

                <!-- Hair Tracker Settings Section -->
                <section id="hair-tracker-settings" class="page-section">
                    <div class="section-header">
                        <h2 class="section-title">Hair Tracker Settings</h2>
                        <p style="color: var(--gray-medium); margin-top: 5px;">Configure hair care tracking intervals and display settings</p>
                    </div>

                    <!-- Interval Settings -->
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Default Intervals</h3>
                        </div>
                        <div style="padding: 25px;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Default Maintenance Interval (days)</label>
                                    <input type="number" id="trackerDefaultMaintenance" class="form-input" min="1" placeholder="42">
                                    <p style="font-size: 12px; color: var(--gray-medium); margin-top: 5px;">Fallback when extension type not set</p>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Recommended Wash Frequency (days)</label>
                                    <input type="number" id="trackerWashFrequency" class="form-input" min="1" placeholder="3">
                                    <p style="font-size: 12px; color: var(--gray-medium); margin-top: 5px;">Days between recommended washes</p>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Deep Condition Frequency (days)</label>
                                    <input type="number" id="trackerDeepConditionFrequency" class="form-input" min="1" placeholder="14">
                                    <p style="font-size: 12px; color: var(--gray-medium); margin-top: 5px;">Recommended deep conditioning interval</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Extension Type Intervals -->
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Extension Type Maintenance Intervals</h3>
                        </div>
                        <div style="padding: 25px;">
                            <p style="color: var(--gray-medium); margin-bottom: 15px; font-size: 14px;">
                                Set maintenance interval for each extension type. Set to 0 for no-maintenance items (clip-ins, etc.)
                            </p>
                            <div id="extensionTypesEditor">
                                <!-- Dynamically populated -->
                            </div>
                        </div>
                    </div>

                    <!-- Health Score Settings -->
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Health Score Calculation</h3>
                        </div>
                        <div style="padding: 25px;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Base Score</label>
                                    <input type="number" id="trackerHealthBase" class="form-input" min="0" max="100" placeholder="100">
                                    <p style="font-size: 12px; color: var(--gray-medium); margin-top: 5px;">Starting health score (0-100)</p>
                                </div>
                            </div>
                            <h4 style="margin: 20px 0 15px; font-size: 14px; font-weight: 600;">Score Penalties (points deducted)</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Overdue Maintenance (per day)</label>
                                    <input type="number" id="trackerPenaltyMaintenance" class="form-input" min="0" step="0.1" placeholder="0.5">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Missed Deep Condition (per day)</label>
                                    <input type="number" id="trackerPenaltyDeepCondition" class="form-input" min="0" step="0.1" placeholder="0.3">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Excess Washes (per extra wash/week)</label>
                                    <input type="number" id="trackerPenaltyWashes" class="form-input" min="0" step="0.1" placeholder="1.0">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Copy/Labels -->
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Display Text & Labels</h3>
                        </div>
                        <div style="padding: 25px;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Tracker Title</label>
                                    <input type="text" id="trackerCopyTitle" class="form-input" placeholder="Hair Care Journey">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Tracker Subtitle</label>
                                    <input type="text" id="trackerCopySubtitle" class="form-input" placeholder="Keep your extensions healthy and on track">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Next Wash Label</label>
                                    <input type="text" id="trackerCopyWash" class="form-input" placeholder="Next Wash Day">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Maintenance Label</label>
                                    <input type="text" id="trackerCopyMaintenance" class="form-input" placeholder="Maintenance Due">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Deep Condition Label</label>
                                    <input type="text" id="trackerCopyDeepCondition" class="form-input" placeholder="Deep Condition">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">No Install Message</label>
                                    <input type="text" id="trackerCopyNoInstall" class="form-input" placeholder="Set up your hair tracker to get personalized care recommendations!">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Setup Button Text</label>
                                    <input type="text" id="trackerCopySetupBtn" class="form-input" placeholder="Set Up Tracker">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Care Tips -->
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Care Tips</h3>
                        </div>
                        <div style="padding: 25px;">
                            <p style="color: var(--gray-medium); margin-bottom: 15px; font-size: 14px;">
                                Add tips that will be shown to users in the tracker. These are randomly selected.
                            </p>
                            <div id="trackerTipsEditor">
                                <!-- Dynamically populated -->
                            </div>
                            <button class="btn btn-outline" onclick="addTrackerTip()" style="margin-top: 15px;">
                                + Add Tip
                            </button>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 15px; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="saveHairTrackerSettings()" style="flex: 1;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" style="margin-right: 8px;"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                            Save Changes
                        </button>
                        <button class="btn btn-outline" onclick="resetHairTrackerSettings()" style="flex: 1;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" style="margin-right: 8px;"><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg>
                            Reset to Defaults
                        </button>
                    </div>

                    <!-- Status Messages -->
                    <div id="trackerSettingsError" style="margin-top: 15px; padding: 15px; background: rgba(244,67,54,0.1); border-radius: 8px; border-left: 4px solid var(--danger); display: none;">
                        <strong style="color: var(--danger);">Error:</strong>
                        <span id="trackerSettingsErrorText"></span>
                    </div>
                    <div id="trackerSettingsSuccess" style="margin-top: 15px; padding: 15px; background: rgba(76,175,80,0.1); border-radius: 8px; border-left: 4px solid var(--success); display: none;">
                        <strong style="color: var(--success);">Settings saved successfully!</strong>
                    </div>
                </section>

                <!-- Payment Settings Section -->
                <section id="payment-settings" class="page-section">
                    <div class="section-header">
                        <h2 class="section-title">Payment Configuration</h2>
                        <p style="color: var(--gray-medium); margin-top: 5px;">Manage PayFast and Yoco payment gateway settings</p>
                        <button class="btn btn-primary" onclick="refreshPaymentConfig()" style="margin-top: 15px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" style="margin-right: 8px;"><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg>
                            Refresh Status
                        </button>
                    </div>

                    <!-- Editable Payment Settings -->
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Editable Settings</h3>
                        </div>
                        <div style="padding: 25px;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">App URL (used for return/cancel pages)</label>
                                    <input type="text" id="paymentAppUrl" class="form-input" placeholder="https://flirthair.co.za">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">API Base URL (used for webhooks)</label>
                                    <input type="text" id="paymentApiBaseUrl" class="form-input" placeholder="https://api.flirthair.co.za">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">PayFast Merchant ID</label>
                                    <input type="text" id="payfastMerchantId" class="form-input" placeholder="e.g. 10000100">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">PayFast Merchant Key</label>
                                    <input type="text" id="payfastMerchantKey" class="form-input" placeholder="e.g. 46f0cd694581a">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">PayFast Passphrase (recommended)</label>
                                    <input type="text" id="payfastPassphrase" class="form-input" placeholder="Optional but recommended">
                                </div>
                                <div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-top: 28px;">
                                    <input type="checkbox" id="payfastSandbox" style="width: 18px; height: 18px;">
                                    <label for="payfastSandbox" class="form-label" style="margin: 0;">Use Sandbox Mode</label>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Yoco Secret Key</label>
                                    <input type="text" id="yocoSecretKey" class="form-input" placeholder="sk_test_xxx or sk_live_xxx">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Yoco Public Key</label>
                                    <input type="text" id="yocoPublicKey" class="form-input" placeholder="pk_test_xxx or pk_live_xxx">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Yoco Webhook Secret</label>
                                <input type="text" id="yocoWebhookSecret" class="form-input" placeholder="Webhook signing secret">
                            </div>

                            <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
                                <button class="btn btn-primary" onclick="savePaymentSettings()">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" style="margin-right: 8px;"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                                    Save Payment Settings
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- App URL Display -->
                    <div class="data-card">
                        <div class="data-card-header">
                            <h3 class="data-card-title">Application URL</h3>
                        </div>
                        <div style="padding: 25px;">
                            <div class="form-group">
                                <label class="form-label">Base URL (APP_URL)</label>
                                <input type="text" id="paymentAppUrlDisplay" class="form-input" readonly style="background: var(--gray-light); cursor: not-allowed;">
                                <p style="font-size: 12px; color: var(--gray-medium); margin-top: 5px;">Set via APP_URL environment variable</p>
                            </div>
                        </div>
                    </div>

                    <!-- PayFast Configuration -->
                    <div class="data-card">
                        <div class="data-card-header">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <h3 class="data-card-title">PayFast Configuration</h3>
                                <span id="payfastStatusBadge" class="status-badge" style="display: none;"></span>
                            </div>
                        </div>
                        <div style="padding: 25px;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Mode</label>
                                    <input type="text" id="payfastMode" class="form-input" readonly style="background: var(--gray-light);">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Base URL</label>
                                    <input type="text" id="payfastBaseUrl" class="form-input" readonly style="background: var(--gray-light);">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Notify URL (ITN Endpoint)</label>
                                <input type="text" id="payfastNotifyUrl" class="form-input" readonly style="background: var(--gray-light); font-family: monospace; font-size: 13px;">
                                <p style="font-size: 12px; color: var(--gray-medium); margin-top: 5px;">Configure this URL in your PayFast account under Settings → Integration</p>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Return URL</label>
                                    <input type="text" id="payfastReturnUrl" class="form-input" readonly style="background: var(--gray-light); font-family: monospace; font-size: 13px;">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Cancel URL</label>
                                    <input type="text" id="payfastCancelUrl" class="form-input" readonly style="background: var(--gray-light); font-family: monospace; font-size: 13px;">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                                    Passphrase Configured
                                    <span id="payfastPassphraseIcon"></span>
                                </label>
                                <p style="font-size: 12px; color: var(--gray-medium); margin-top: 5px;">Set via PAYFAST_PASSPHRASE environment variable (recommended for production)</p>
                            </div>
                            <div id="payfastMissingVars" style="display: none; margin-top: 15px; padding: 15px; background: rgba(255,152,0,0.1); border-radius: 8px; border-left: 4px solid var(--warning);">
                                <strong style="color: var(--warning);">Missing Configuration:</strong>
                                <ul id="payfastMissingVarsList" style="margin: 10px 0 0 20px; color: var(--gray-dark);"></ul>
                            </div>
                        </div>
                    </div>

                    <!-- Yoco Configuration -->
                    <div class="data-card">
                        <div class="data-card-header">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <h3 class="data-card-title">Yoco Configuration</h3>
                                <span id="yocoStatusBadge" class="status-badge" style="display: none;"></span>
                            </div>
                        </div>
                        <div style="padding: 25px;">
                            <div class="form-group">
                                <label class="form-label">Base URL</label>
                                <input type="text" id="yocoBaseUrl" class="form-input" readonly style="background: var(--gray-light);">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Webhook URL</label>
                                <input type="text" id="yocoWebhookUrl" class="form-input" readonly style="background: var(--gray-light); font-family: monospace; font-size: 13px;">
                                <p style="font-size: 12px; color: var(--gray-medium); margin-top: 5px;">Configure this URL in your Yoco Dashboard under Developers → Webhooks</p>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                                        Public Key
                                        <span id="yocoPublicKeyIcon"></span>
                                    </label>
                                    <input type="text" id="yocoPublicKeyDisplay" class="form-input" readonly style="background: var(--gray-light); font-family: monospace; font-size: 13px;">
                                    <p style="font-size: 12px; color: var(--gray-medium); margin-top: 5px;">Set via YOCO_PUBLIC_KEY environment variable</p>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
                                        Webhook Secret Configured
                                        <span id="yocoWebhookSecretIcon"></span>
                                    </label>
                                    <p style="font-size: 12px; color: var(--gray-medium); margin-top: 5px;">Set via YOCO_WEBHOOK_SECRET environment variable (required for webhook verification)</p>
                                </div>
                            </div>
                            <div id="yocoMissingVars" style="display: none; margin-top: 15px; padding: 15px; background: rgba(255,152,0,0.1); border-radius: 8px; border-left: 4px solid var(--warning);">
                                <strong style="color: var(--warning);">Missing Configuration:</strong>
                                <ul id="yocoMissingVarsList" style="margin: 10px 0 0 20px; color: var(--gray-dark);"></ul>
                            </div>
                        </div>
                    </div>

                    <!-- Configuration Guide -->
                    <div class="data-card" style="background: var(--primary-light); border: 1px solid var(--primary);">
                        <div class="data-card-header">
                            <h3 class="data-card-title" style="color: var(--primary);">Configuration Guide</h3>
                        </div>
                        <div style="padding: 25px; color: var(--gray-dark);">
                            <h4 style="font-size: 14px; font-weight: 600; margin-bottom: 10px;">Environment Variables Required:</h4>
                            <ul style="margin-left: 20px; line-height: 1.8;">
                                <li><code style="background: white; padding: 2px 6px; border-radius: 4px; font-size: 12px;">APP_URL</code> - Your application's base URL (e.g., https://flirthair.co.za)</li>
                                <li><code style="background: white; padding: 2px 6px; border-radius: 4px; font-size: 12px;">PAYFAST_MERCHANT_ID</code> - Your PayFast merchant ID</li>
                                <li><code style="background: white; padding: 2px 6px; border-radius: 4px; font-size: 12px;">PAYFAST_MERCHANT_KEY</code> - Your PayFast merchant key</li>
                                <li><code style="background: white; padding: 2px 6px; border-radius: 4px; font-size: 12px;">PAYFAST_PASSPHRASE</code> - (Optional) PayFast security passphrase</li>
                                <li><code style="background: white; padding: 2px 6px; border-radius: 4px; font-size: 12px;">PAYFAST_SANDBOX</code> - Set to 'true' for sandbox mode</li>
                                <li><code style="background: white; padding: 2px 6px; border-radius: 4px; font-size: 12px;">YOCO_SECRET_KEY</code> - Your Yoco secret key</li>
                                <li><code style="background: white; padding: 2px 6px; border-radius: 4px; font-size: 12px;">YOCO_PUBLIC_KEY</code> - Your Yoco public key</li>
                                <li><code style="background: white; padding: 2px 6px; border-radius: 4px; font-size: 12px;">YOCO_WEBHOOK_SECRET</code> - Your Yoco webhook secret</li>
                            </ul>
                        </div>
                    </div>
                </section>

                <!-- Services Section -->
                <section id="services" class="page-section">
                    <div class="section-header">
                        <h2>Service Management</h2>
                        <button class="btn btn-primary" onclick="openServiceModal()">
                            <span style="margin-right: 5px;">+</span> Add New Service
                        </button>
                    </div>

                    <!-- Filters -->
                    <div class="card" style="margin-bottom: 20px;">
                        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 200px;">
                                <input type="text" id="serviceSearchInput" placeholder="Search services..."
                                       onkeyup="filterServices()" class="form-control">
                            </div>
                            <div>
                                <select id="serviceTypeFilter" onchange="filterServices()" class="form-control">
                                    <option value="">All Types</option>
                                </select>
                            </div>
                            <div>
                                <select id="serviceActiveFilter" onchange="filterServices()" class="form-control">
                                    <option value="">All Status</option>
                                    <option value="1">Active</option>
                                    <option value="0">Inactive</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Services Table -->
                    <div class="card">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Image</th>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Duration</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="servicesTableBody">
                                <tr>
                                    <td colspan="8" style="text-align: center; padding: 40px;">
                                        Loading services...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <!-- Create Notification Modal -->
    <div class="modal-overlay" id="createNotificationModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">Create Push Notification</h3>
                <button class="modal-close" onclick="closeNotificationModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Notification Type</label>
                    <select id="notifType" class="form-input">
                        <option value="promo">Promotion</option>
                        <option value="info">Information</option>
                        <option value="booking">Booking</option>
                        <option value="points">Points / Rewards</option>
                        <option value="gift">Gift / Special</option>
                        <option value="warning">Important Notice</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Title *</label>
                    <input type="text" id="notifTitle" class="form-input" placeholder="e.g., Flash Sale Today!">
                </div>
                <div class="form-group">
                    <label class="form-label">Message *</label>
                    <textarea id="notifMessage" class="form-input" rows="3" placeholder="e.g., Get 30% off all tape extensions until midnight!"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Action Button Text (optional)</label>
                    <input type="text" id="notifActionText" class="form-input" placeholder="e.g., Shop Now">
                </div>
                <div class="form-group">
                    <label class="form-label">Expires At (optional)</label>
                    <input type="datetime-local" id="notifExpires" class="form-input">
                </div>

                <div style="background: rgba(246, 117, 153, 0.1); border-radius: 8px; padding: 15px; margin-top: 20px;">
                    <div style="font-weight: 600; margin-bottom: 8px; color: var(--brand-pink);">Preview</div>
                    <div id="notifPreview" style="background: white; border-radius: 8px; padding: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; gap: 12px; align-items: flex-start;">
                        <div style="width: 36px; height: 36px; border-radius: 8px; background: rgba(246, 117, 153, 0.1); display: flex; align-items: center; justify-content: center;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="#F67599" stroke-width="2" width="20" height="20">
                                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                            </svg>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 13px; color: #414042;">Your Title Here</div>
                            <div style="font-size: 12px; color: #6d6e70;">Your message will appear here...</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeNotificationModal()">Cancel</button>
                <button class="btn btn-primary" onclick="createNotification()">Send Notification</button>
            </div>
        </div>
    </div>

    <!-- Service Modal -->
    <div id="serviceModal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="serviceModalTitle">Add New Service</h3>
                <button class="modal-close" onclick="closeServiceModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="serviceForm" onsubmit="saveService(event)">
                    <input type="hidden" id="serviceId">

                    <div class="form-group">
                        <label class="form-label">Service Name *</label>
                        <input type="text" id="serviceName" class="form-input" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea id="serviceDescription" class="form-input" rows="3"></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Service Type *</label>
                            <input type="text" id="serviceType" class="form-input" required
                                   placeholder="e.g., hair, beauty, spa">
                            <small style="color: var(--text-subtle);">Can be any custom type</small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <input type="text" id="serviceCategory" class="form-input"
                                   placeholder="e.g., Extensions, Nails">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Price (R) *</label>
                            <input type="number" id="servicePrice" class="form-input" required min="0" step="0.01">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Duration (minutes)</label>
                            <input type="number" id="serviceDuration" class="form-input" min="0" step="15">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Image URL</label>
                        <input type="url" id="serviceImageUrl" class="form-input"
                               placeholder="https://example.com/image.jpg"
                               oninput="updateServiceImagePreview()">
                        <small style="color: var(--text-subtle);">URL to service image</small>
                        <div id="serviceImagePreview" style="margin-top: 10px; display: none;">
                            <img id="serviceImagePreviewImg" src="" alt="Preview" style="max-width: 100%; max-height: 150px; border-radius: 8px; object-fit: cover; border: 1px solid var(--border-color);">
                            <div id="serviceImagePreviewError" style="display: none; color: var(--danger); font-size: 12px; margin-top: 5px;">Failed to load image</div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Display Order</label>
                            <input type="number" id="serviceDisplayOrder" class="form-input" min="0" step="1" placeholder="0">
                            <small style="color: var(--text-subtle);">Lower numbers appear first</small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Commission Rate (%)</label>
                            <input type="number" id="serviceCommissionRate" class="form-input" min="0" max="100" step="1" placeholder="Leave blank for stylist default">
                            <small style="color: var(--text-subtle);">Overrides stylist default rate for this service</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="serviceActive" checked style="cursor: pointer;">
                            <span>Active (visible to customers)</span>
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeServiceModal()">Cancel</button>
                <button class="btn btn-primary" onclick="document.getElementById('serviceForm').requestSubmit()">Save Service</button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal" style="max-width: 420px; width: 90%;">
            <div class="modal-header">
                <h3 class="modal-title" id="confirmTitle">Please Confirm</h3>
                <button class="modal-close" onclick="resolveConfirm(false)">&times;</button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage" style="font-size: 15px; color: var(--brand-charcoal); margin: 0;"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="confirmCancelBtn" onclick="resolveConfirm(false)">Cancel</button>
                <button class="btn btn-primary" id="confirmConfirmBtn" onclick="resolveConfirm(true)">Confirm</button>
            </div>
        </div>
    </div>

    <div class="admin-toast-container" id="adminToastContainer"></div>

    <!-- Add Staff Modal -->
    <div class="modal-overlay" id="addStaffModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Add Staff Member</h3>
                <button class="modal-close" onclick="closeModal('addStaffModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="image-upload" onclick="document.getElementById('staffPhoto').click()">
                    <div style="font-size: 40px; margin-bottom: 10px;">📷</div>
                    <div>Click to upload photo</div>
                    <input type="file" id="staffPhoto" accept="image/*" style="display: none;" onchange="handleStaffPhotoUpload(event)">
                    <img id="staffPhotoPreview" class="image-preview" style="display:none;" alt="Preview">
                </div>
                <div class="form-row" style="margin-top: 20px;">
                    <div class="form-group">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-input" id="staffName" placeholder="e.g., Lisa Thompson">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Role</label>
                        <select class="form-input" id="staffRole">
                            <option value="Stylist">Stylist</option>
                            <option value="Stylist & Extension Specialist">Stylist & Extension Specialist</option>
                            <option value="Nail Babes">Nail Babes</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Bio / Tagline</label>
                    <textarea class="form-input" id="staffTagline" rows="3" placeholder="A cute description that shows their personality..."></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Years Experience</label>
                        <input type="number" class="form-input" id="staffExperience" placeholder="8">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Instagram Handle</label>
                        <input type="text" class="form-input" id="staffInstagram" placeholder="@lisahair">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Services Offered</label>
                    <button type="button" class="btn btn-outline" onclick="openStaffServicesModal(editingStaffId)" style="width: 100%;">
                        Manage Services & Pricing
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('addStaffModal')">Cancel</button>
                <button class="btn btn-primary" id="staffSaveBtn" onclick="saveStaff()">Add Staff Member</button>
            </div>
        </div>
    </div>

    <!-- Staff Services Management Modal -->
    <div class="modal-overlay" id="staffServicesModal" style="display: none;">
        <div class="modal" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title" id="staffServicesModalTitle">Manage Staff Services</h3>
                <button class="modal-close" onclick="closeStaffServicesModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <!-- Available Services -->
                    <div>
                        <h4>Available Services</h4>
                        <input type="text" id="serviceSearchFilter" placeholder="Search services..."
                               class="form-input" style="margin-bottom: 10px;" onkeyup="filterAvailableServices()">
                        <select id="serviceCategoryFilter" class="form-input" style="margin-bottom: 10px;" onchange="filterAvailableServices()">
                            <option value="">All Categories</option>
                        </select>
                        <div id="availableServicesList" style="max-height: 500px; overflow-y: auto; border: 1px solid var(--border-soft); border-radius: 4px; padding: 10px;">
                            <!-- Populated dynamically -->
                        </div>
                    </div>

                    <!-- Staff's Services -->
                    <div>
                        <h4>Staff's Services</h4>
                        <div id="staffServicesList" style="max-height: 580px; overflow-y: auto;">
                            <!-- Populated dynamically -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeStaffServicesModal()">Done</button>
            </div>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div class="modal-overlay" id="addProductModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Add Product</h3>
                <button class="modal-close" onclick="closeModal('addProductModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="image-upload" onclick="document.getElementById('productPhoto').click()">
                    <div style="font-size: 40px; margin-bottom: 10px;">🧴</div>
                    <div>Click to upload product image</div>
                    <input type="file" id="productPhoto" accept="image/*" style="display: none;">
                </div>
                <div class="form-group" style="margin-top: 10px;">
                    <label class="form-label">Image URL</label>
                    <input type="url" class="form-input" id="productImageUrl" placeholder="https://...product.png" oninput="updateProductImagePreview(this.value)">
                    <div id="productImagePreview" style="margin-top: 8px; display: none;">
                        <img alt="Preview" style="width: 80px; height: 80px; object-fit: contain; background: var(--surface-muted); border-radius: 8px; padding: 6px;">
                    </div>
                </div>
                <div class="form-row" style="margin-top: 20px;">
                    <div class="form-group">
                        <label class="form-label">Product Name</label>
                        <input type="text" class="form-input" id="productName" placeholder="e.g., Angel.Wash">
                    </div>
                    <div class="form-group">
                        <label class="form-label">SKU</label>
                        <input type="text" class="form-input" id="productSku" placeholder="e.g., KM-AW-001">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-input" id="productDescription" rows="3" placeholder="Product description..."></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select class="form-input" id="productCategory">
                            <option value="Care Products">Care Products</option>
                            <option value="Styling">Styling</option>
                            <option value="Extensions">Extensions</option>
                            <option value="Accessories">Accessories</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Stock Quantity</label>
                        <input type="number" class="form-input" id="productStock" placeholder="24">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Regular Price (R)</label>
                        <input type="number" class="form-input" id="productPrice" placeholder="385">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Sale Price (R) - Optional</label>
                        <input type="number" class="form-input" id="productSalePrice" placeholder="Leave empty if not on sale">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('addProductModal')">Cancel</button>
                <button class="btn btn-primary" id="productSaveBtn" onclick="saveProduct()">Add Product</button>
            </div>
        </div>
    </div>

    <!-- Add Booking Modal -->
    <div class="modal-overlay" id="addBookingModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">New Booking</h3>
                <button class="modal-close" onclick="closeModal('addBookingModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Customer</label>
                    <div style="display: flex; gap: 8px;">
                        <select class="form-input" id="adminBookingCustomer" style="flex: 1;">
                            <option value="">Loading customers...</option>
                        </select>
                        <button type="button" class="btn btn-outline" onclick="openNewCustomerFromBooking()" title="Add new customer" style="padding: 8px 12px; white-space: nowrap;">
                            + New
                        </button>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Service</label>
                        <select class="form-input" id="adminBookingService" onchange="handleAdminBookingServiceChange()">
                            <option value="">Loading services...</option>
                        </select>
                    </div>
                    <div class="form-group" id="adminBookingStylistGroup">
                        <label class="form-label">Stylist</label>
                        <select class="form-input" id="adminBookingStylist">
                            <option value="">Any available</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Date <span style="color: var(--danger);">*</span></label>
                        <input type="date" class="form-input" id="adminBookingDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Start Time <span style="color: var(--danger);">*</span></label>
                        <input type="time" class="form-input" id="adminBookingTime" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Duration (minutes)</label>
                        <input type="number" class="form-input" id="adminBookingDuration" min="15" step="15" placeholder="Auto-filled from service">
                        <small style="color: var(--gray-medium); font-size: 12px;">Automatically set based on selected service</small>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-input" rows="3" id="adminBookingNotes" placeholder="Any special requirements or notes..."></textarea>
                </div>
                <div id="adminBookingError" style="color: var(--danger); font-size: 13px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('addBookingModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveBooking()">Create Booking</button>
            </div>
        </div>
    </div>

    <!-- Add Promotion Modal -->
    <div class="modal-overlay" id="addPromoModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">Create Promotion</h3>
                <button class="modal-close" onclick="closeModal('addPromoModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Promo Code *</label>
                        <input type="text" class="form-input" id="promoCode" placeholder="e.g., SUMMER30" style="text-transform: uppercase;">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-input" id="promoDescription" placeholder="e.g., 30% off summer sale">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Discount Type *</label>
                        <select class="form-input" id="promoType">
                            <option value="percentage">Percentage Off</option>
                            <option value="fixed">Fixed Amount Off (Rands)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Discount Value *</label>
                        <input type="number" class="form-input" id="promoValue" placeholder="e.g., 30" min="0">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Minimum Order (R)</label>
                        <input type="number" class="form-input" id="promoMinOrder" placeholder="0" min="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Usage Limit</label>
                        <input type="number" class="form-input" id="promoUsageLimit" placeholder="Unlimited" min="0">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Expires At</label>
                    <input type="datetime-local" class="form-input" id="promoExpiresAt">
                </div>

                <!-- Special Offer Section -->
                <div style="border-top: 1px solid var(--gray-light); margin-top: 20px; padding-top: 20px;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                        <label class="toggle-switch">
                            <input type="checkbox" id="promoHighlighted">
                            <span class="toggle-slider"></span>
                        </label>
                        <span style="font-weight: 600; color: var(--brand-pink);">Show in Special Offers</span>
                    </div>
                    <p style="font-size: 12px; color: var(--gray-medium); margin-bottom: 16px;">
                        Enable this to display the promotion as a Special Offer card on the customer-facing site.
                    </p>
                    <div id="specialOfferFields" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Offer Title</label>
                                <input type="text" class="form-input" id="promoTitle" placeholder="e.g., Summer Glow Package 🌟">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Badge Text</label>
                                <input type="text" class="form-input" id="promoBadge" placeholder="e.g., LIMITED TIME" style="text-transform: uppercase;">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Subtitle / Card Description</label>
                            <textarea class="form-input" id="promoSubtitle" rows="2" placeholder="e.g., Get 30% off tape extensions + free color consultation"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Sort Order / Priority</label>
                            <input type="number" class="form-input" id="promoPriority" placeholder="1" min="0" style="max-width: 100px;">
                            <small style="color: var(--gray-medium); display: block; margin-top: 4px;">Lower numbers appear first</small>
                        </div>
                    </div>

                    <!-- Shop Banner Toggle -->
                    <div style="border-top: 1px solid var(--border-soft); padding-top: 20px; margin-top: 20px;">
                        <label class="toggle-label" style="cursor: pointer; display: flex; align-items: center; gap: 12px;">
                            <input type="checkbox" id="promoShowInShopBanner">
                            <span style="font-weight: 600; color: var(--brand-pink);">Show as Shop Banner</span>
                        </label>
                        <p style="font-size: 12px; color: var(--gray-medium); margin-bottom: 16px;">
                            Enable this to display the promotion as the main flash sale banner in the shop section. Only one promo can be the shop banner at a time.
                        </p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('addPromoModal')">Cancel</button>
                <button class="btn btn-primary" onclick="savePromo()">Create Promotion</button>
            </div>
        </div>
    </div>

    <!-- Password Change Modal (for mustChangePassword) -->
    <div class="modal-overlay" id="changePasswordModal" style="z-index: 9999;">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header" style="background: var(--brand-pink); color: white;">
                <h3 class="modal-title">Password Change Required</h3>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px; color: var(--gray-medium);">
                    For security reasons, you must change your password before continuing.
                </p>
                <div class="form-group">
                    <label class="form-label">Current Password</label>
                    <input type="password" id="currentPassword" class="form-input" placeholder="Enter current password">
                </div>
                <div class="form-group">
                    <label class="form-label">New Password</label>
                    <input type="password" id="newPassword" class="form-input" placeholder="Enter new password (min 8 characters)">
                </div>
                <div class="form-group">
                    <label class="form-label">Confirm New Password</label>
                    <input type="password" id="confirmPassword" class="form-input" placeholder="Confirm new password">
                </div>
                <div id="passwordError" style="color: var(--danger); font-size: 13px; margin-top: 10px; display: none;"></div>
                <div id="passwordStrength" style="margin-top: 10px;">
                    <div style="font-size: 12px; color: var(--gray-medium); margin-bottom: 5px;">Password Strength:</div>
                    <div style="height: 4px; background: #eee; border-radius: 2px; overflow: hidden;">
                        <div id="strengthBar" style="height: 100%; width: 0%; transition: all 0.3s;"></div>
                    </div>
                    <div id="strengthText" style="font-size: 11px; margin-top: 3px; color: var(--gray-medium);"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="logout()">Logout Instead</button>
                <button class="btn btn-primary" onclick="submitPasswordChange()">Change Password</button>
            </div>
        </div>
    </div>

    <!-- Gallery Modal -->
    <div class="modal-overlay" id="galleryModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title" id="galleryModalTitle">Add Gallery Image</h3>
                <button class="modal-close" onclick="closeGalleryModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Image URL *</label>
                    <input type="url" id="galleryImageUrl" class="form-input" placeholder="https://example.com/image.jpg">
                </div>
                <div class="form-group">
                    <label class="form-label">Preview</label>
                    <div id="galleryImagePreview" style="width: 100%; height: 150px; background: var(--gray-light); border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                        <span style="color: var(--gray-medium);">Enter URL to preview</span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Label</label>
                    <input type="text" id="galleryLabel" class="form-input" placeholder="e.g., Blonde Extensions">
                </div>
                <div class="form-group">
                    <label class="form-label">Alt Text</label>
                    <input type="text" id="galleryAltText" class="form-input" placeholder="Description for accessibility">
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select id="galleryCategory" class="form-input">
                        <option value="general">General</option>
                        <option value="extensions">Extensions</option>
                        <option value="styling">Styling</option>
                        <option value="natural">Natural</option>
                        <option value="braids">Braids</option>
                        <option value="color">Color</option>
                        <option value="wigs">Wigs</option>
                    </select>
                </div>
                <input type="hidden" id="galleryEditId">
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeGalleryModal()">Cancel</button>
                <button class="btn btn-primary" id="gallerySubmitBtn" onclick="submitGalleryItem()">Add Image</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // API CONFIGURATION
        // ============================================
        // Use relative URL for production compatibility
        const API_BASE = (() => {
            const origin = window.location.origin;
            const port = window.location.port;
            // If running from file:// or Live Server (not port 3001), use localhost:3001
            if (origin === 'null' || origin.startsWith('file://') || (port && port !== '3001')) {
                console.warn('Running in dev mode - using localhost:3001 for API.');
                return 'http://localhost:3001/api';
            }
            return '/api';
        })();

        // API connectivity status
        let apiConnected = false;

        // ============================================
        // BOOKING CONSTANTS
        // ============================================
        window.BookingConstants = {
            TIME_WINDOWS: {
                MORNING: {
                    id: 'MORNING',
                    label: 'Morning',
                    icon: '🌅',
                    description: '6:00 AM - 12:00 PM',
                    startHour: 6,
                    endHour: 12
                },
                AFTERNOON: {
                    id: 'AFTERNOON',
                    label: 'Afternoon',
                    icon: '☀️',
                    description: '12:00 PM - 3:00 PM',
                    startHour: 12,
                    endHour: 15
                },
                LATE_AFTERNOON: {
                    id: 'LATE_AFTERNOON',
                    label: 'Late Afternoon',
                    icon: '🌤️',
                    description: '3:00 PM - 6:00 PM',
                    startHour: 15,
                    endHour: 18
                },
                EVENING: {
                    id: 'EVENING',
                    label: 'Evening',
                    icon: '🌙',
                    description: '6:00 PM - 10:00 PM',
                    startHour: 18,
                    endHour: 22
                }
            },
            getTimeWindow(id) {
                return this.TIME_WINDOWS[id] || null;
            }
        };

        const formatDateDisplay = (value, options = {}) => {
            if (!value) return '';
            const date = value instanceof Date ? value : new Date(value);
            if (isNaN(date)) return '';
            return new Intl.DateTimeFormat('en-GB', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                ...options
            }).format(date);
        };

        const formatDateWithTime = (value, timeText) => {
            const dateText = formatDateDisplay(value);
            if (!dateText) return '';
            return timeText ? `${dateText}${timeText.trim() ? ` at ${timeText}` : ''}` : dateText;
        };

        const formatCurrencyZAR = (value) => {
            const amount = Number(value || 0);
            return 'R' + amount.toLocaleString('en-ZA', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        };

        function getToken() {
            return localStorage.getItem('flirt_admin_token');
        }

        async function apiCall(endpoint, options = {}) {
            const token = getToken();
            const headers = {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                ...(token && { 'Authorization': `Bearer ${token}` })
            };

            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    ...options,
                    headers: { ...headers, ...options.headers }
                });
                const raw = await response.text();
                let data;
                try {
                    data = raw ? JSON.parse(raw) : {};
                } catch (e) {
                    throw new Error(raw || 'API request failed (non-JSON response)');
                }
                if (!response.ok) throw new Error(data.message || 'API request failed');
                apiConnected = true;
                return data;
            } catch (error) {
                console.error('API Error:', error);
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    apiConnected = false;
                    showConnectionError();
                }
                throw error;
            }
        }

        function showConnectionError() {
            const existingBanner = document.getElementById('connectionError');
            if (existingBanner) return;

            const banner = document.createElement('div');
            banner.id = 'connectionError';
            banner.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; background: #f44336; color: white; padding: 12px; text-align: center; z-index: 10000; font-size: 14px;';
            banner.innerHTML = '⚠️ Unable to connect to server. Please ensure the backend is running.';
            document.body.prepend(banner);
        }

        // ============================================
        // AUTH
        // ============================================
        let adminUser = null;

        async function checkAdminAuth() {
            const token = getToken();
            if (!token) {
                showLoginPrompt();
                return false;
            }
            try {
                const data = await apiCall('/auth/me');
                if (data.user.role !== 'admin' && data.user.role !== 'staff') {
                    alert('Admin access required');
                    showLoginPrompt();
                    return false;
                }
                adminUser = data.user;
                const adminNameEl = document.getElementById('adminName');
                if (adminNameEl) {
                    adminNameEl.textContent = data.user.name;
                }
                return true;
            } catch (error) {
                showLoginPrompt();
                return false;
            }
        }

        function showLoginPrompt() {
            const email = prompt('Admin Email:');
            const password = prompt('Password:');
            if (email && password) {
                login(email, password);
            }
        }

        async function login(email, password) {
            try {
                const data = await apiCall('/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ email, password })
                });
                if (data.user.role !== 'admin' && data.user.role !== 'staff') {
                    alert('Admin access required');
                    return;
                }
                localStorage.setItem('flirt_admin_token', data.token);
                adminUser = data.user;
                document.getElementById('adminName').textContent = data.user.name;

                // Check if password change is required
                if (data.mustChangePassword || data.user.mustChangePassword) {
                    showPasswordChangeModal();
                } else {
                    initDashboard();
                }
            } catch (error) {
                alert('Login failed: ' + error.message);
            }
        }

        function logout() {
            localStorage.removeItem('flirt_admin_token');
            location.reload();
        }

        // ============================================
        // PASSWORD CHANGE (for mustChangePassword)
        // ============================================
        function showPasswordChangeModal() {
            document.getElementById('changePasswordModal').classList.add('show');
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            document.getElementById('passwordError').style.display = 'none';
            updatePasswordStrength('');

            // Add password strength checker
            document.getElementById('newPassword').addEventListener('input', function() {
                updatePasswordStrength(this.value);
            });
        }

        function updatePasswordStrength(password) {
            const strengthBar = document.getElementById('strengthBar');
            const strengthText = document.getElementById('strengthText');

            let strength = 0;
            let text = '';
            let color = '';

            if (password.length >= 8) strength += 25;
            if (password.length >= 12) strength += 15;
            if (/[a-z]/.test(password)) strength += 15;
            if (/[A-Z]/.test(password)) strength += 15;
            if (/[0-9]/.test(password)) strength += 15;
            if (/[^a-zA-Z0-9]/.test(password)) strength += 15;

            if (strength < 30) {
                text = 'Weak';
                color = '#f44336';
            } else if (strength < 60) {
                text = 'Fair';
                color = '#FF9800';
            } else if (strength < 80) {
                text = 'Good';
                color = '#4CAF50';
            } else {
                text = 'Strong';
                color = '#2196F3';
            }

            strengthBar.style.width = strength + '%';
            strengthBar.style.background = color;
            strengthText.textContent = password ? text : '';
            strengthText.style.color = color;
        }

        async function submitPasswordChange() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorDiv = document.getElementById('passwordError');

            // Validation
            if (!currentPassword || !newPassword || !confirmPassword) {
                errorDiv.textContent = 'All fields are required';
                errorDiv.style.display = 'block';
                return;
            }

            if (newPassword.length < 8) {
                errorDiv.textContent = 'New password must be at least 8 characters';
                errorDiv.style.display = 'block';
                return;
            }

            if (newPassword !== confirmPassword) {
                errorDiv.textContent = 'New passwords do not match';
                errorDiv.style.display = 'block';
                return;
            }

            if (newPassword === currentPassword) {
                errorDiv.textContent = 'New password must be different from current password';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                await apiCall('/auth/change-password', {
                    method: 'POST',
                    body: JSON.stringify({ currentPassword, newPassword })
                });

                // Close modal and load dashboard
                document.getElementById('changePasswordModal').classList.remove('show');
                alert('Password changed successfully!');
                initDashboard();
            } catch (error) {
                errorDiv.textContent = error.message || 'Failed to change password';
                errorDiv.style.display = 'block';
            }
        }

        // ============================================
        // NAVIGATION
        // ============================================
        function showSection(sectionId, evt) {
            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');

            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            // Find the nav item for this section and mark it active
            const navEvent = evt || window.event;
            if (navEvent && navEvent.target) {
                const navItem = navEvent.target.closest('.nav-item');
                if (navItem) navItem.classList.add('active');
            } else {
                // Fallback: find nav item by section id
                document.querySelectorAll('.nav-item').forEach(item => {
                    if (item.getAttribute('onclick')?.includes(`'${sectionId}'`)) {
                        item.classList.add('active');
                    }
                });
            }

            const titles = {
                'dashboard': 'Dashboard',
                'bookings': 'Bookings',
                'staff': 'Staff Management',
                'payroll': 'Payroll Management',
                'services': 'Service Management',
                'customers': 'Customers',
                'products': 'Products & Inventory',
                'orders': 'Product Orders',
                'promotions': 'Promotions & Sales',
                'notifications': 'Push Notifications',
                'gallery': 'Gallery Management',
                'chat': 'Customer Chat',
                'hair-tips': 'Hair Care Tips',
                'loyalty-settings': 'Loyalty Settings',
                'hair-tracker-settings': 'Hair Tracker Settings',
                'settings': 'Settings'
            };
            document.getElementById('pageTitle').textContent = titles[sectionId] || 'Dashboard';

            // Load section data
            switch(sectionId) {
                case 'dashboard': initDashboard(); break;
                case 'bookings':
                    if (typeof initBookingsFilters === 'function') {
                        initBookingsFilters().then(() => loadBookings());
                    } else {
                        loadBookings();
                    }
                    break;
                case 'staff': loadStaff(); break;
                case 'payroll':
                    initPayrollYearSelector();
                    loadPayroll();
                    loadStylistPaySettings();
                    break;
                case 'services': loadServices(); break;
                case 'customers': loadCustomers(); break;
                case 'products': loadProducts(); break;
                case 'orders': loadOrders(); break;
                case 'promotions': loadPromos(); break;
                case 'notifications': loadNotifications(); break;
                case 'gallery': loadGallery(); break;
                case 'loyalty-settings': loadLoyaltySettings(); break;
                case 'rewards-settings': loadRewardsSettings(); break;
                case 'hair-tracker-settings': loadHairTrackerSettings(); break;
                case 'payment-settings': loadPaymentSettings(); break;
                case 'chat': loadAdminConversations(); break;
                case 'hair-tips': loadHairTips(); break;
                case 'settings': loadSettingsPage(); break;
            }

            // Close sidebar on mobile after navigation
            if (window.innerWidth < 1024) {
                closeSidebar();
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('show');
            // Prevent body scroll when sidebar is open
            document.body.style.overflow = sidebar.classList.contains('open') ? 'hidden' : '';
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.remove('open');
            overlay.classList.remove('show');
            document.body.style.overflow = '';
        }

        // ============================================
        // ADMIN MENU & GLOBAL SEARCH
        // ============================================
        function toggleAdminMenu() {
            const dropdown = document.getElementById('adminDropdown');
            dropdown.classList.toggle('show');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('adminDropdown');
            const profile = document.querySelector('.admin-profile');
            if (dropdown && profile && !profile.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });

        let searchDebounceTimer = null;

        function handleGlobalSearch(event) {
            const query = event.target.value.trim().toLowerCase();
            const resultsContainer = document.getElementById('searchResults');

            if (searchDebounceTimer) clearTimeout(searchDebounceTimer);

            if (query.length < 2) {
                resultsContainer.classList.remove('show');
                return;
            }

            searchDebounceTimer = setTimeout(() => performGlobalSearch(query), 300);
        }

        function handleSearchKeydown(event) {
            if (event.key === 'Escape') {
                document.getElementById('searchResults').classList.remove('show');
                event.target.blur();
            }
        }

        async function performGlobalSearch(query) {
            const resultsContainer = document.getElementById('searchResults');
            let html = '';

            try {
                // Search customers
                const customersRes = await fetch(`${API_BASE}/admin/users?search=${encodeURIComponent(query)}&limit=5`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('flirt_admin_token')}` }
                });
                if (customersRes.ok) {
                    const customersData = await customersRes.json();
                    const customers = customersData.users || customersData || [];
                    if (customers.length > 0) {
                        html += `<div class="search-result-group">
                            <div class="search-result-group-title">Customers</div>
                            ${customers.slice(0, 5).map(c => `
                                <div class="search-result-item" onclick="selectSearchResult('customers', '${c.id}')">
                                    <span class="icon">👤</span>
                                    <div class="details">
                                        <div class="name">${c.name || 'Unknown'}</div>
                                        <div class="meta">${c.email || ''}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>`;
                    }
                }

                // Search bookings
                const bookingsRes = await fetch(`${API_BASE}/admin/bookings?search=${encodeURIComponent(query)}&limit=5`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('flirt_admin_token')}` }
                });
                if (bookingsRes.ok) {
                    const bookingsData = await bookingsRes.json();
                    const bookings = bookingsData.bookings || bookingsData || [];
                    if (bookings.length > 0) {
                        html += `<div class="search-result-group">
                            <div class="search-result-group-title">Bookings</div>
                            ${bookings.slice(0, 5).map(b => `
                                <div class="search-result-item" onclick="selectSearchResult('bookings', '${b.id}')">
                                    <span class="icon">📅</span>
                                    <div class="details">
                                        <div class="name">${b.customerName || b.customer_name || 'Guest'}</div>
                                        <div class="meta">${b.serviceName || b.service_name || 'Service'} - ${b.date || ''}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>`;
                    }
                }

                // Quick navigation
                html += `<div class="search-result-group">
                    <div class="search-result-group-title">Quick Navigation</div>
                    <div class="search-result-item" onclick="selectSearchResult('customers'); filterCustomersByQuery('${query.replace(/'/g, "\\'")}')">
                        <span class="icon">🔍</span>
                        <div class="details">
                            <div class="name">Search all customers for "${query}"</div>
                        </div>
                    </div>
                </div>`;

                resultsContainer.innerHTML = html;
                resultsContainer.classList.add('show');
            } catch (error) {
                console.error('Search error:', error);
            }
        }

        function selectSearchResult(section, id) {
            document.getElementById('searchResults').classList.remove('show');
            document.getElementById('globalSearch').value = '';
            showSection(section);
        }

        function filterCustomersByQuery(query) {
            setTimeout(() => {
                const searchInput = document.querySelector('#customers input[type="text"], #customers input[type="search"]');
                if (searchInput) {
                    searchInput.value = query;
                    searchInput.dispatchEvent(new Event('input', { bubbles: true }));
                }
            }, 100);
        }

        // Close search results when clicking outside
        document.addEventListener('click', function(e) {
            const searchBox = document.querySelector('.search-box');
            const resultsContainer = document.getElementById('searchResults');
            if (searchBox && resultsContainer && !searchBox.contains(e.target)) {
                resultsContainer.classList.remove('show');
            }
        });

        // ============================================
        // DASHBOARD
        // ============================================
        let revenueChartInstance = null;
        let servicesChartInstance = null;

        // Show dashboard alert
        function showDashboardAlert(message, type = 'error') {
            const alert = document.getElementById('dashboardAlert');
            if (alert) {
                alert.className = `dashboard-alert ${type}`;
                alert.innerHTML = `<span>${type === 'error' ? '⚠️' : type === 'warning' ? '⚡' : 'ℹ️'}</span> ${message}`;
                alert.style.display = 'flex';
            }
        }

        function hideDashboardAlert() {
            const alert = document.getElementById('dashboardAlert');
            if (alert) alert.style.display = 'none';
        }

        // Load dashboard stats
        async function loadDashboard() {
            // Set loading state
            const statCards = ['statCardRevenue', 'statCardBookings', 'statCardOrders', 'statCardCustomers'];
            statCards.forEach(id => {
                const card = document.getElementById(id);
                if (card) card.classList.add('loading');
            });

            try {
                const data = await apiCall('/admin/stats');
                const stats = data.stats;

                // Update stat cards with correct monthly metrics
                document.getElementById('statMonthRevenue').textContent = 'R' + (stats.monthRevenue || 0).toLocaleString();
                document.getElementById('statMonthBookings').textContent = stats.monthBookings || 0;
                document.getElementById('statMonthOrders').textContent = stats.monthOrders || 0;
                document.getElementById('statActiveCustomers').textContent = stats.activeCustomers || 0;

                // Remove loading state
                statCards.forEach(id => {
                    const card = document.getElementById(id);
                    if (card) card.classList.remove('loading', 'error');
                });

                hideDashboardAlert();
            } catch (error) {
                console.error('Dashboard stats load error:', error);

                // Show error state on cards
                statCards.forEach(id => {
                    const card = document.getElementById(id);
                    if (card) {
                        card.classList.remove('loading');
                        card.classList.add('error');
                    }
                });

                document.getElementById('statMonthRevenue').textContent = 'Error';
                document.getElementById('statMonthBookings').textContent = '-';
                document.getElementById('statMonthOrders').textContent = '-';
                document.getElementById('statActiveCustomers').textContent = '-';

                showDashboardAlert('Unable to load live stats. Please refresh the page.', 'error');
            }
        }

        // Load today's bookings for dashboard
        async function loadTodayBookings() {
            const tbody = document.getElementById('todayBookingsBody');
            if (!tbody) return;

            tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 30px; color: var(--gray-medium);">Loading...</td></tr>`;

            try {
                // Get today's date in YYYY-MM-DD format
                const today = new Date().toISOString().split('T')[0];
                const data = await apiCall(`/admin/bookings?date=${today}`);
                // Filter out cancelled bookings and sort by time
                const bookings = (data.bookings || [])
                    .filter(b => b.status !== 'cancelled')
                    .sort((a, b) => (a.time || '').localeCompare(b.time || ''))
                    .slice(0, 10); // Limit to 10 bookings

                if (bookings.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 30px; color: var(--gray-medium);">
                                📅 No bookings for today
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = bookings.map(b => {
                    const initials = (b.customerName || b.userName || 'G').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
                    const timeStr = b.time || b.confirmedTime || 'TBC';
                    // Format time to 12-hour format
                    let displayTime = timeStr;
                    if (timeStr.match(/^\d{2}:\d{2}$/)) {
                        const [h, m] = timeStr.split(':');
                        const hour = parseInt(h);
                        displayTime = `${hour > 12 ? hour - 12 : hour || 12}:${m} ${hour >= 12 ? 'PM' : 'AM'}`;
                    }

                    return `
                        <tr>
                            <td>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div class="avatar-placeholder">${initials}</div>
                                    ${b.customerName || b.userName || 'Guest'}
                                </div>
                            </td>
                            <td>${b.serviceName || '-'}</td>
                            <td>${b.stylistName || b.stylistId || 'Any'}</td>
                            <td>${displayTime}</td>
                            <td><span class="status-badge status-${b.status}">${b.status}</span></td>
                            <td class="action-btns">
                                ${b.status === 'REQUESTED' ? `
                                    <button class="btn btn-icon btn-outline booking-confirm-btn" data-booking-id="${b.id}" title="Confirm">✅</button>
                                ` : ''}
                                ${b.status === 'CONFIRMED' ? `
                                    <button class="btn btn-icon btn-outline booking-complete-btn" data-booking-id="${b.id}" title="Complete">✔️</button>
                                ` : ''}
                                <button class="btn btn-icon btn-outline" title="View" onclick="showSection('bookings')">👁️</button>
                            </td>
                        </tr>
                    `;
                }).join('');

                // Attach event listeners for today's bookings buttons
                setTimeout(() => attachTodayBookingsListeners(), 0);
            } catch (error) {
                console.error('Today bookings load error:', error);
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 30px; color: var(--danger);">
                            Failed to load today's bookings
                        </td>
                    </tr>
                `;
            }
        }

        function attachTodayBookingsListeners() {
            // Confirm buttons in Today's Bookings
            document.querySelectorAll('#todayBookingsBody .booking-confirm-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const bookingId = this.getAttribute('data-booking-id');
                    confirmBookingTime(bookingId);
                });
            });

            // Complete buttons in Today's Bookings
            document.querySelectorAll('#todayBookingsBody .booking-complete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const bookingId = this.getAttribute('data-booking-id');
                    completeBooking(bookingId);
                });
            });
        }

        // Quick action to view today's bookings in full section
        function viewTodayBookings() {
            showSection('bookings');
            // The bookings section will load all bookings; user can filter from there
        }

        // Load Revenue Chart
        async function loadRevenueChart() {
            const canvas = document.getElementById('revenueChart');
            const errorDiv = document.getElementById('revenueChartError');
            if (!canvas) return;

            const range = document.getElementById('revenueChartRange')?.value || '30d';

            try {
                const data = await apiCall(`/admin/revenue-trend?range=${range}`);

                // Destroy existing chart if any
                if (revenueChartInstance) {
                    revenueChartInstance.destroy();
                }

                // Format labels to show only day/month
                const formattedLabels = data.labels.map(d => {
                    const date = new Date(d);
                    return `${date.getDate()}/${date.getMonth() + 1}`;
                });

                revenueChartInstance = new Chart(canvas.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: formattedLabels,
                        datasets: [{
                            label: 'Revenue (R)',
                            data: data.values,
                            borderColor: '#F67599',
                            backgroundColor: 'rgba(246, 117, 153, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 2,
                            pointHoverRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: value => 'R' + value.toLocaleString()
                                }
                            }
                        }
                    }
                });

                if (errorDiv) errorDiv.style.display = 'none';
                canvas.style.display = 'block';
            } catch (error) {
                console.error('Revenue chart load error:', error);
                canvas.style.display = 'none';
                if (errorDiv) errorDiv.style.display = 'block';
            }
        }

        // Load Popular Services Chart
        async function loadPopularServicesChart() {
            const canvas = document.getElementById('servicesChart');
            const errorDiv = document.getElementById('servicesChartError');
            if (!canvas) return;

            try {
                const data = await apiCall('/admin/popular-services?range=30d');

                // Destroy existing chart if any
                if (servicesChartInstance) {
                    servicesChartInstance.destroy();
                }

                const colors = ['#F67599', '#414042', '#4CAF50', '#FF9800', '#2196F3'];

                servicesChartInstance = new Chart(canvas.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Bookings',
                            data: data.values,
                            backgroundColor: colors.slice(0, data.labels.length),
                            borderRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                ticks: { precision: 0 }
                            }
                        }
                    }
                });

                if (errorDiv) errorDiv.style.display = 'none';
                canvas.style.display = 'block';
            } catch (error) {
                console.error('Services chart load error:', error);
                canvas.style.display = 'none';
                if (errorDiv) errorDiv.style.display = 'block';
            }
        }

        // Initialize all dashboard components
        async function initDashboard() {
            await Promise.all([
                loadDashboard(),
                loadTodayBookings(),
                loadRevenueChart(),
                loadPopularServicesChart()
            ]);
        }

        // ============================================
        // BOOKINGS
        // ============================================
        let adminBookings = [];
        let allBookings = []; // Unfiltered list
        let currentStatusFilter = 'all';
        let bookingsCalendarMonthOffset = 0;
        let currentBookingsView = 'list';
        let adminBookingDataLoaded = false;
        let adminBookingServices = [];
        let adminBookingStylists = [];
        let adminBookingCustomers = [];

        async function ensureAdminBookingData() {
            if (adminBookingDataLoaded) return;

            const [hairServices, beautyServices, stylistsData, customersData] = await Promise.all([
                apiCall('/services/hair'),
                apiCall('/services/beauty'),
                apiCall('/stylists'),
                apiCall('/admin/customers')
            ]);

            adminBookingServices = [...(hairServices.services || []), ...(beautyServices.services || [])];
            adminBookingStylists = stylistsData.stylists || [];
            adminBookingCustomers = (customersData.customers || []).sort((a, b) => (a.name || '').localeCompare(b.name || ''));
            adminBookingDataLoaded = true;
            populateAdminBookingForm();
        }

        function populateAdminBookingForm() {
            const serviceSelect = document.getElementById('adminBookingService');
            if (serviceSelect) {
                serviceSelect.innerHTML = '<option value=\"\">Select service...</option>' +
                    adminBookingServices.map(s => `
                        <option value=\"${s.id}\" data-type=\"${s.service_type || s.serviceType || 'hair'}\">
                            ${s.name} - R${s.price}
                        </option>
                    `).join('');
            }

            const stylistSelect = document.getElementById('adminBookingStylist');
            if (stylistSelect) {
                stylistSelect.innerHTML = '<option value=\"\">Any available</option>' +
                    adminBookingStylists.map(s => `<option value=\"${s.id}\">${s.name}</option>`).join('');
            }

            const customerSelect = document.getElementById('adminBookingCustomer');
            if (customerSelect) {
                customerSelect.innerHTML = '<option value=\"\">Select customer...</option>' +
                    adminBookingCustomers.map(c => `<option value=\"${c.id}\">${c.name} (${c.email})</option>`).join('');
            }
        }

        async function openAdminBookingModal() {
            const errorEl = document.getElementById('adminBookingError');
            if (errorEl) errorEl.textContent = '';

            try {
                await ensureAdminBookingData();
                populateAdminBookingForm();
                document.getElementById('adminBookingDate').value = '';
                document.getElementById('adminBookingTime').value = '';
                document.getElementById('adminBookingDuration').value = '';
                document.getElementById('adminBookingNotes').value = '';
                document.getElementById('adminBookingCustomer').value = '';
                document.getElementById('adminBookingService').value = '';
                handleAdminBookingServiceChange();
                openModal('addBookingModal');
            } catch (err) {
                alert(`Failed to load booking data: ${err.message}`);
            }
        }

        function handleAdminBookingServiceChange() {
            const select = document.getElementById('adminBookingService');
            const selectedOption = select?.selectedOptions[0];
            const type = selectedOption?.dataset.type || 'hair';
            const duration = selectedOption?.dataset.duration || 60;
            const stylistGroup = document.getElementById('adminBookingStylistGroup');
            const durationInput = document.getElementById('adminBookingDuration');

            // Auto-fill duration from selected service
            if (durationInput && duration) {
                durationInput.value = duration;
            }

            // Show/hide stylist field based on booking type
            if (stylistGroup) {
                stylistGroup.style.display = type === 'hair' ? 'block' : 'none';
            }
        }

        // Bookings filter state
        let bookingsFilters = {
            search: '',
            status: 'all',
            stylistId: 'all',
            serviceId: 'all',
            timeOfDay: 'all',
            dateFrom: null,
            dateTo: null
        };

        // Search with debounce
        let bookingsSearchTimeout = null;
        function onBookingsSearchInput(value) {
            clearTimeout(bookingsSearchTimeout);
            bookingsSearchTimeout = setTimeout(() => {
                bookingsFilters.search = value.trim();
                loadBookings();
            }, 300);
        }

        // Filter change handlers
        function onBookingsFilterChange() {
            const rawStatus = document.getElementById('bookingsStatusFilter')?.value || 'all';
            bookingsFilters.status = rawStatus === 'all' ? 'all' : rawStatus.toUpperCase();
            bookingsFilters.stylistId = document.getElementById('bookingsStylistFilter')?.value || 'all';
            bookingsFilters.serviceId = document.getElementById('bookingsServiceFilter')?.value || 'all';
            const rawTime = document.getElementById('bookingsTimeFilter')?.value || 'all';
            bookingsFilters.timeOfDay = rawTime === 'all' ? 'all' : rawTime.toUpperCase();
            loadBookings();
        }

        function onBookingsDatePresetChange() {
            const preset = document.getElementById('bookingsDatePreset')?.value;
            const dateFromGroup = document.getElementById('bookingsDateFromGroup');
            const dateToGroup = document.getElementById('bookingsDateToGroup');
            const today = new Date();

            if (preset === 'custom') {
                if (dateFromGroup) dateFromGroup.style.display = 'block';
                if (dateToGroup) dateToGroup.style.display = 'block';
                return;
            } else {
                if (dateFromGroup) dateFromGroup.style.display = 'none';
                if (dateToGroup) dateToGroup.style.display = 'none';
            }

            let dateFrom = null;
            let dateTo = null;

            switch(preset) {
                case 'today':
                    dateFrom = dateTo = today.toISOString().split('T')[0];
                    break;
                case 'tomorrow':
                    const tomorrow = new Date(today);
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    dateFrom = dateTo = tomorrow.toISOString().split('T')[0];
                    break;
                case 'thisweek':
                    const startOfWeek = new Date(today);
                    startOfWeek.setDate(today.getDate() - today.getDay());
                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(startOfWeek.getDate() + 6);
                    dateFrom = startOfWeek.toISOString().split('T')[0];
                    dateTo = endOfWeek.toISOString().split('T')[0];
                    break;
                case 'next7days':
                    dateFrom = today.toISOString().split('T')[0];
                    const next7 = new Date(today);
                    next7.setDate(today.getDate() + 7);
                    dateTo = next7.toISOString().split('T')[0];
                    break;
            }

            bookingsFilters.dateFrom = dateFrom;
            bookingsFilters.dateTo = dateTo;
            loadBookings();
        }

        function onBookingsDateRangeChange() {
            const dateFrom = document.getElementById('bookingsDateFrom')?.value;
            const dateTo = document.getElementById('bookingsDateTo')?.value;
            bookingsFilters.dateFrom = dateFrom || null;
            bookingsFilters.dateTo = dateTo || null;
            loadBookings();
        }

        function clearAllBookingsFilters() {
            bookingsFilters = {
                search: '',
                status: 'all',
                stylistId: 'all',
                serviceId: 'all',
                timeOfDay: 'all',
                dateFrom: null,
                dateTo: null
            };

            // Reset UI
            const searchInput = document.getElementById('bookingsSearchInput');
            if (searchInput) searchInput.value = '';
            const statusFilter = document.getElementById('bookingsStatusFilter');
            if (statusFilter) statusFilter.value = 'all';
            const stylistFilter = document.getElementById('bookingsStylistFilter');
            if (stylistFilter) stylistFilter.value = 'all';
            const serviceFilter = document.getElementById('bookingsServiceFilter');
            if (serviceFilter) serviceFilter.value = 'all';
            const timeFilter = document.getElementById('bookingsTimeFilter');
            if (timeFilter) timeFilter.value = 'all';
            const datePreset = document.getElementById('bookingsDatePreset');
            if (datePreset) datePreset.value = 'all';
            const dateFrom = document.getElementById('bookingsDateFrom');
            if (dateFrom) dateFrom.value = '';
            const dateTo = document.getElementById('bookingsDateTo');
            if (dateTo) dateTo.value = '';

            loadBookings();
        }

        async function loadBookings() {
            try {
                // Build query parameters from filters
                const params = new URLSearchParams();

                if (bookingsFilters.search) {
                    params.append('search', bookingsFilters.search);
                }
                if (bookingsFilters.status && bookingsFilters.status !== 'all') {
                    params.append('status', bookingsFilters.status);
                }
                if (bookingsFilters.stylistId && bookingsFilters.stylistId !== 'all') {
                    params.append('stylistId', bookingsFilters.stylistId);
                }
                if (bookingsFilters.serviceId && bookingsFilters.serviceId !== 'all') {
                    params.append('serviceId', bookingsFilters.serviceId);
                }
                if (bookingsFilters.timeOfDay && bookingsFilters.timeOfDay !== 'all') {
                    params.append('timeOfDay', bookingsFilters.timeOfDay);
                }
                if (bookingsFilters.dateFrom) {
                    params.append('dateFrom', bookingsFilters.dateFrom);
                }
                if (bookingsFilters.dateTo) {
                    params.append('dateTo', bookingsFilters.dateTo);
                }

                const url = params.toString() ? `/admin/bookings?${params.toString()}` : '/admin/bookings';
                const data = await apiCall(url);
                allBookings = data.bookings || [];

                // Apply status filter
                applyStatusFilter();

                // Update total count
                const totalEl = document.getElementById('bookingsTotalCount');
                if (totalEl) {
                    if (data.pagination) {
                        totalEl.textContent = `${adminBookings.length} shown of ${data.pagination.total} total`;
                    } else {
                        totalEl.textContent = `${adminBookings.length} total bookings`;
                    }
                }

                // Update sidebar badge
                const badge = document.getElementById('bookingsNavBadge');
                if (badge) {
                    badge.textContent = allBookings.length;
                }

                // Update status filter counts
                updateStatusFilterCounts();

                // Render both views
                renderBookingsTable();
                renderBookingsCalendar();
            } catch (error) {
                console.log('Bookings load error:', error);
                document.getElementById('bookingsTableBody').innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px; color: var(--danger);">
                            Failed to load bookings: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        // Status filter functions
        function filterByStatus(status) {
            currentStatusFilter = status;
            applyStatusFilter();

            // Update active tab
            document.querySelectorAll('.status-filter-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('data-status') === status) {
                    tab.classList.add('active');
                }
            });

            renderBookingsTable();
            renderBookingsCalendar();
        }

        function applyStatusFilter() {
            if (currentStatusFilter === 'all') {
                adminBookings = [...allBookings];
            } else {
                adminBookings = allBookings.filter(b => {
                    const status = (b.status || '').toUpperCase();
                    return status === currentStatusFilter;
                });
            }
        }

        function updateStatusFilterCounts() {
            // Count bookings by status
            const counts = {
                all: allBookings.length,
                REQUESTED: 0,
                CONFIRMED: 0,
                COMPLETED: 0,
                CANCELLED: 0
            };

            allBookings.forEach(b => {
                const status = (b.status || '').toUpperCase();
                if (counts[status] !== undefined) {
                    counts[status]++;
                }
            });

            // Update count badges
            document.getElementById('count-all').textContent = counts.all;
            document.getElementById('count-requested').textContent = counts.REQUESTED;
            document.getElementById('count-confirmed').textContent = counts.CONFIRMED;
            document.getElementById('count-completed').textContent = counts.COMPLETED;
            document.getElementById('count-cancelled').textContent = counts.CANCELLED;
        }

        // ============================================
        // BOOKINGS: SORTING, PAGINATION, BULK ACTIONS
        // ============================================
        let bookingsSortField = 'date';
        let bookingsSortDirection = 'desc';
        let bookingsCurrentPage = 1;
        let bookingsPageSize = 50;
        let selectedBookingIds = new Set();
        let bookingsGroupByDate = false;

        function sortBookingsBy(field) {
            if (bookingsSortField === field) {
                // Toggle direction
                bookingsSortDirection = bookingsSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                bookingsSortField = field;
                bookingsSortDirection = 'asc';
            }

            // Update sort icons
            ['customer', 'service', 'stylist', 'date', 'status'].forEach(f => {
                const icon = document.getElementById(`sortIcon${f.charAt(0).toUpperCase() + f.slice(1)}`);
                if (icon) {
                    icon.textContent = f === field ? (bookingsSortDirection === 'asc' ? '↑' : '↓') : '↕';
                }
            });

            // Sort adminBookings
            adminBookings.sort((a, b) => {
                let valA, valB;
                switch (field) {
                    case 'customer':
                        valA = (a.customerName || '').toLowerCase();
                        valB = (b.customerName || '').toLowerCase();
                        break;
                    case 'service':
                        valA = (a.serviceName || '').toLowerCase();
                        valB = (b.serviceName || '').toLowerCase();
                        break;
                    case 'stylist':
                        valA = (a.stylistName || '').toLowerCase();
                        valB = (b.stylistName || '').toLowerCase();
                        break;
                    case 'date':
                        valA = a.requestedDate || a.date || '';
                        valB = b.requestedDate || b.date || '';
                        break;
                    case 'status':
                        valA = (a.status || '').toLowerCase();
                        valB = (b.status || '').toLowerCase();
                        break;
                    default:
                        valA = '';
                        valB = '';
                }

                if (valA < valB) return bookingsSortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return bookingsSortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            bookingsCurrentPage = 1;
            renderBookingsTable();
        }

        function goToBookingsPage(direction) {
            const totalPages = Math.ceil(adminBookings.length / bookingsPageSize);

            if (direction === 'prev' && bookingsCurrentPage > 1) {
                bookingsCurrentPage--;
            } else if (direction === 'next' && bookingsCurrentPage < totalPages) {
                bookingsCurrentPage++;
            } else if (typeof direction === 'number') {
                bookingsCurrentPage = direction;
            }

            renderBookingsTable();
            updateBookingsPagination();
        }

        function onBookingsPageSizeChange() {
            const select = document.getElementById('bookingsPageSize');
            if (select) {
                bookingsPageSize = parseInt(select.value) || 50;
                bookingsCurrentPage = 1;
                renderBookingsTable();
                updateBookingsPagination();
            }
        }

        function updateBookingsPagination() {
            const total = adminBookings.length;
            const totalPages = Math.ceil(total / bookingsPageSize);
            const start = (bookingsCurrentPage - 1) * bookingsPageSize + 1;
            const end = Math.min(bookingsCurrentPage * bookingsPageSize, total);

            const paginationEl = document.getElementById('bookingsPagination');
            if (paginationEl) {
                paginationEl.style.display = total > bookingsPageSize ? 'flex' : 'none';
            }

            const infoEl = document.getElementById('bookingsPaginationInfo');
            if (infoEl) {
                infoEl.textContent = `Showing ${start}-${end} of ${total}`;
            }

            const prevBtn = document.getElementById('bookingsPrevPage');
            const nextBtn = document.getElementById('bookingsNextPage');
            if (prevBtn) prevBtn.disabled = bookingsCurrentPage <= 1;
            if (nextBtn) nextBtn.disabled = bookingsCurrentPage >= totalPages;

            // Render page numbers
            const pagesEl = document.getElementById('bookingsPaginationPages');
            if (pagesEl && totalPages > 1) {
                let pagesHtml = '';
                for (let i = 1; i <= Math.min(totalPages, 5); i++) {
                    const isActive = i === bookingsCurrentPage;
                    pagesHtml += `<button class="btn btn-sm ${isActive ? '' : 'btn-outline'}"
                                   onclick="goToBookingsPage(${i})"
                                   style="${isActive ? 'background: var(--primary); color: white;' : ''}">${i}</button>`;
                }
                if (totalPages > 5) {
                    pagesHtml += `<span style="padding: 0 8px;">...</span>`;
                    pagesHtml += `<button class="btn btn-sm btn-outline" onclick="goToBookingsPage(${totalPages})">${totalPages}</button>`;
                }
                pagesEl.innerHTML = pagesHtml;
            }
        }

        function toggleSelectAllBookings() {
            const selectAllCheckbox = document.getElementById('bookingsSelectAll');
            const checkboxes = document.querySelectorAll('#bookingsTableBody input[type="checkbox"]');

            if (selectAllCheckbox && selectAllCheckbox.checked) {
                // Select all visible bookings
                const start = (bookingsCurrentPage - 1) * bookingsPageSize;
                const end = Math.min(start + bookingsPageSize, adminBookings.length);
                for (let i = start; i < end; i++) {
                    selectedBookingIds.add(adminBookings[i].id);
                }
                checkboxes.forEach(cb => cb.checked = true);
            } else {
                // Deselect all
                selectedBookingIds.clear();
                checkboxes.forEach(cb => cb.checked = false);
            }

            updateBulkActionsBar();
        }

        function toggleBookingSelection(bookingId) {
            if (selectedBookingIds.has(bookingId)) {
                selectedBookingIds.delete(bookingId);
            } else {
                selectedBookingIds.add(bookingId);
            }
            updateBulkActionsBar();
        }

        function deselectAllBookings() {
            selectedBookingIds.clear();
            document.querySelectorAll('#bookingsTableBody input[type="checkbox"]').forEach(cb => cb.checked = false);
            const selectAllCheckbox = document.getElementById('bookingsSelectAll');
            if (selectAllCheckbox) selectAllCheckbox.checked = false;
            updateBulkActionsBar();
        }

        function updateBulkActionsBar() {
            const bar = document.getElementById('bookingsBulkActionsBar');
            const countEl = document.getElementById('bookingsSelectedCount');

            if (bar) {
                bar.style.display = selectedBookingIds.size > 0 ? 'block' : 'none';
            }
            if (countEl) {
                countEl.textContent = `${selectedBookingIds.size} selected`;
            }
        }

        async function bulkConfirmBookings() {
            if (selectedBookingIds.size === 0) return;

            const confirmed = await openConfirmDialog({
                title: 'Confirm Bookings',
                message: `Are you sure you want to confirm ${selectedBookingIds.size} booking(s)?`,
                confirmText: 'Confirm All',
                tone: 'neutral'
            });

            if (!confirmed) return;

            let successCount = 0;
            for (const id of selectedBookingIds) {
                try {
                    await apiCall(`/admin/bookings/${id}`, {
                        method: 'PUT',
                        body: JSON.stringify({ status: 'CONFIRMED' })
                    });
                    successCount++;
                } catch (error) {
                    console.error(`Failed to confirm booking ${id}:`, error);
                }
            }

            showAdminToast(`${successCount} booking(s) confirmed`, 'success');
            deselectAllBookings();
            loadBookings();
        }

        async function bulkCompleteBookings() {
            if (selectedBookingIds.size === 0) return;

            const confirmed = await openConfirmDialog({
                title: 'Complete Bookings',
                message: `Are you sure you want to mark ${selectedBookingIds.size} booking(s) as completed?`,
                confirmText: 'Complete All',
                tone: 'neutral'
            });

            if (!confirmed) return;

            let successCount = 0;
            for (const id of selectedBookingIds) {
                try {
                    await apiCall(`/admin/bookings/${id}`, {
                        method: 'PUT',
                        body: JSON.stringify({ status: 'COMPLETED' })
                    });
                    successCount++;
                } catch (error) {
                    console.error(`Failed to complete booking ${id}:`, error);
                }
            }

            showAdminToast(`${successCount} booking(s) marked as completed`, 'success');
            deselectAllBookings();
            loadBookings();
        }

        async function bulkCancelBookings() {
            if (selectedBookingIds.size === 0) return;

            const confirmed = await openConfirmDialog({
                title: 'Cancel Bookings',
                message: `Are you sure you want to cancel ${selectedBookingIds.size} booking(s)? This cannot be undone.`,
                confirmText: 'Cancel All',
                tone: 'danger'
            });

            if (!confirmed) return;

            let successCount = 0;
            for (const id of selectedBookingIds) {
                try {
                    await apiCall(`/admin/bookings/${id}`, {
                        method: 'PUT',
                        body: JSON.stringify({ status: 'CANCELLED' })
                    });
                    successCount++;
                } catch (error) {
                    console.error(`Failed to cancel booking ${id}:`, error);
                }
            }

            showAdminToast(`${successCount} booking(s) cancelled`, 'success');
            deselectAllBookings();
            loadBookings();
        }

        function toggleBookingsGrouping() {
            const checkbox = document.getElementById('bookingsGroupByDate');
            bookingsGroupByDate = checkbox ? checkbox.checked : false;
            renderBookingsTable();
        }

        function exportBookingsToCSV() {
            if (adminBookings.length === 0) {
                showAdminToast('No bookings to export', 'error');
                return;
            }

            // Build CSV content
            const headers = ['ID', 'Customer', 'Email', 'Phone', 'Service', 'Stylist', 'Date', 'Time', 'Status', 'Notes'];
            const rows = adminBookings.map(b => [
                b.id,
                b.customerName || 'Guest',
                b.customerEmail || '',
                b.customerPhone || '',
                b.serviceName || '',
                b.stylistName || 'Any',
                b.requestedDate || b.date || '',
                b.assignedStartTime || b.confirmedTime || b.time || b.preferredTimeOfDay || '',
                b.status || '',
                (b.notes || '').replace(/"/g, '""')
            ]);

            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${cell}"`).join(',') + '\n';
            });

            // Download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `bookings-export-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showAdminToast(`Exported ${adminBookings.length} booking(s) to CSV`, 'success');
        }

        function renderBookingsTable() {
            const container = document.getElementById('bookingsTableBody');
            if (!container) return;

            if (adminBookings.length === 0) {
                container.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 40px; color: var(--gray-medium);">
                            No bookings found
                        </td>
                    </tr>
                `;
                updateBookingsPagination();
                return;
            }

            // Apply pagination
            const start = (bookingsCurrentPage - 1) * bookingsPageSize;
            const end = Math.min(start + bookingsPageSize, adminBookings.length);
            const paginatedBookings = adminBookings.slice(start, end);

            // Optional: Group by date
            let html = '';
            let lastDate = null;

            paginatedBookings.forEach(b => {
                // Use new schema fields with fallback to legacy
                const dateStr = formatDateDisplay(b.requestedDate || b.date);
                const rawDate = (b.requestedDate || b.date || '').split('T')[0];

                // Add date separator if grouping is enabled
                if (bookingsGroupByDate && rawDate !== lastDate) {
                    html += `
                        <tr style="background: var(--gray-light);">
                            <td colspan="9" style="padding: 10px 20px; font-weight: 600; color: var(--brand-charcoal);">
                                ${formatDateDisplay(rawDate + 'T00:00:00', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' })}
                            </td>
                        </tr>
                    `;
                    lastDate = rawDate;
                }

                // Format time display based on booking status
                let timeStr = 'TBC';
                if (b.status === 'CONFIRMED') {
                    timeStr = b.assignedStartTime || b.confirmedTime || b.time || 'TBC';
                } else if (b.status === 'REQUESTED') {
                    // Show time window for requested bookings
                    const timeWindow = window.BookingConstants?.getTimeWindow(b.requestedTimeWindow || b.preferredTimeOfDay);
                    timeStr = timeWindow ? `${timeWindow.icon} ${timeWindow.label}` : (b.preferredTimeOfDay || 'TBC');
                } else {
                    timeStr = b.confirmedTime || b.time || b.preferredTimeOfDay || 'TBC';
                }

                const shortId = b.id.substring(0, 8);
                const isSelected = selectedBookingIds.has(b.id);

                html += `
                    <tr${isSelected ? ' style="background: var(--primary-light);"' : ''}>
                        <td>
                            <input type="checkbox"
                                   data-booking-id="${b.id}"
                                   ${isSelected ? 'checked' : ''}
                                   onchange="toggleBookingSelection('${b.id}')"
                                   title="Select booking">
                        </td>
                        <td>
                            <code style="font-size: 11px; background: var(--gray-light); padding: 2px 6px; border-radius: 3px;" title="${b.id}">${shortId}</code>
                        </td>
                        <td>
                            <div style="font-weight: 500;">${b.customerName || 'Guest'}</div>
                            <div style="font-size: 12px; color: var(--gray-medium);">${b.customerEmail || ''}</div>
                        </td>
                        <td>${b.serviceName}</td>
                        <td>${b.stylistName || 'Any Available'}</td>
                        <td>${dateStr}</td>
                        <td>${timeStr}</td>
                        <td><span class="status-badge status-${b.status}">${b.status}</span></td>
                        <td>
                            ${(() => {
                                const paymentStatus = b.paymentStatus || b.payment_status || 'unpaid';
                                const paymentBadgeClass = paymentStatus === 'paid' ? 'status-paid' : (paymentStatus === 'pending' ? 'status-pending' : 'status-unpaid');
                                const paymentLabel = paymentStatus === 'paid' ? '✓ Paid' : (paymentStatus === 'pending' ? '⏳ Pending' : '○ Unpaid');
                                return `<span class="status-badge ${paymentBadgeClass}" style="font-size: 11px;">${paymentLabel}</span>`;
                            })()}
                            ${b.status === 'CONFIRMED' && (b.paymentStatus || b.payment_status || 'unpaid') !== 'paid' ? `
                                <div style="margin-top: 4px;">
                                    <button class="btn btn-sm booking-payment-btn" data-booking-id="${b.id}" title="Payment Options" style="font-size: 10px; padding: 2px 6px;">💳</button>
                                </div>
                            ` : ''}
                        </td>
                        <td class="action-btns">
                            ${b.status === 'REQUESTED' && !b.assignedStartTime ? `
                                <button class="btn btn-sm btn-primary booking-assign-btn" data-booking-id="${b.id}" title="Assign Time">⏰ Assign</button>
                            ` : `
                                <button class="btn btn-sm booking-edit-btn" data-booking-id="${b.id}" title="Edit booking">✏️</button>
                            `}
                            ${b.status === 'CONFIRMED' ? `
                                <button class="btn btn-sm booking-complete-btn" data-booking-id="${b.id}" title="Complete">✓</button>
                            ` : ''}
                            ${(b.status === 'REQUESTED' || b.status === 'CONFIRMED') ? `
                                <button class="btn btn-sm btn-outline booking-cancel-btn" data-booking-id="${b.id}" title="Cancel">✗</button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            });

            container.innerHTML = html;

            // Update pagination controls
            updateBookingsPagination();

            // Add event listeners for booking action buttons
            attachBookingActionListeners();
        }

        function attachBookingActionListeners() {
            // Assign Time buttons (for REQUESTED bookings)
            const assignBtns = document.querySelectorAll('.booking-assign-btn');
            console.log('🔧 Attaching event listeners to', assignBtns.length, 'assign buttons');
            assignBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const bookingId = this.getAttribute('data-booking-id');
                    console.log('🖱️ Assign button clicked for booking:', bookingId);
                    openAssignTimeModal(bookingId);
                });
            });

            // Edit buttons
            document.querySelectorAll('.booking-edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const bookingId = this.getAttribute('data-booking-id');
                    openEditBookingModal(bookingId);
                });
            });

            // Confirm buttons
            document.querySelectorAll('.booking-confirm-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const bookingId = this.getAttribute('data-booking-id');
                    confirmBookingTime(bookingId);
                });
            });

            // Complete buttons
            document.querySelectorAll('.booking-complete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const bookingId = this.getAttribute('data-booking-id');
                    completeBooking(bookingId);
                });
            });

            // Cancel buttons
            document.querySelectorAll('.booking-cancel-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const bookingId = this.getAttribute('data-booking-id');
                    cancelBooking(bookingId);
                });
            });

            // Payment buttons
            document.querySelectorAll('.booking-payment-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const bookingId = this.getAttribute('data-booking-id');
                    openPaymentModal(bookingId);
                });
            });
        }

        // ============================================
        // BOOKING PAYMENT FUNCTIONS
        // ============================================
        let currentPaymentBookingId = null;

        function openPaymentModal(bookingId) {
            currentPaymentBookingId = bookingId;
            const booking = adminBookings.find(b => b.id === bookingId);

            if (!booking) {
                showAdminToast('Booking not found', 'error');
                return;
            }

            // Populate booking info
            const infoEl = document.getElementById('bookingPaymentInfo');
            infoEl.innerHTML = `
                <div style="display: grid; gap: 8px;">
                    <div><strong>Customer:</strong> ${booking.customerName || 'Guest'}</div>
                    <div><strong>Service:</strong> ${booking.serviceName}</div>
                    <div><strong>Date:</strong> ${formatDateDisplay(booking.requestedDate || booking.date)}</div>
                    <div style="font-size: 18px; font-weight: bold; color: var(--brand-pink);">Amount: R${booking.servicePrice || booking.service_price}</div>
                </div>
            `;

            // Set default payment amount
            document.getElementById('paymentAmount').value = booking.servicePrice || booking.service_price || 0;
            document.getElementById('paymentMethod').value = 'cash';
            document.getElementById('paymentReference').value = '';
            document.getElementById('paymentNotes').value = '';

            // Hide error
            document.getElementById('paymentError').style.display = 'none';

            openModal('bookingPaymentModal');
        }

        async function sendPaymentLink() {
            if (!currentPaymentBookingId) return;

            try {
                const result = await apiCall(`/admin/bookings/${currentPaymentBookingId}/payment/send-link`, {
                    method: 'POST',
                    body: JSON.stringify({ sendMethod: 'email' })
                });

                showAdminToast(result.message || 'Payment link sent!', 'success');
                closeModal('bookingPaymentModal');
                loadBookings();
            } catch (error) {
                showAdminToast('Error: ' + (error.message || 'Failed to send payment link'), 'error');
            }
        }

        async function recordManualPayment() {
            if (!currentPaymentBookingId) return;

            const method = document.getElementById('paymentMethod').value;
            const amount = document.getElementById('paymentAmount').value;
            const reference = document.getElementById('paymentReference').value;
            const notes = document.getElementById('paymentNotes').value;

            if (!amount || parseFloat(amount) <= 0) {
                document.getElementById('paymentError').textContent = 'Please enter a valid amount';
                document.getElementById('paymentError').style.display = 'block';
                return;
            }

            try {
                const result = await apiCall(`/admin/bookings/${currentPaymentBookingId}/payment/record`, {
                    method: 'POST',
                    body: JSON.stringify({ method, amount, reference, notes })
                });

                showAdminToast(result.message || 'Payment recorded!', 'success');
                closeModal('bookingPaymentModal');
                loadBookings();
            } catch (error) {
                document.getElementById('paymentError').textContent = error.message || 'Failed to record payment';
                document.getElementById('paymentError').style.display = 'block';
            }
        }

        function renderBookingsCalendar() {
            const grid = document.getElementById('bookingsCalendarGrid');
            const label = document.getElementById('bookingsCalendarLabel');
            if (!grid) return;

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Calculate target month
            const targetDate = new Date(today.getFullYear(), today.getMonth() + bookingsCalendarMonthOffset, 1);
            const year = targetDate.getFullYear();
            const month = targetDate.getMonth();

            // Update month label
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
            if (label) label.textContent = `${monthNames[month]} ${year}`;

            // Group bookings by date (use requestedDate for new booking system, fallback to date for legacy)
            const bookingsByDate = {};
            adminBookings.forEach(b => {
                const bookingDate = b.requestedDate || b.date;
                if (!bookingDate) return;
                const dateKey = bookingDate.split('T')[0];
                if (!bookingsByDate[dateKey]) bookingsByDate[dateKey] = [];
                bookingsByDate[dateKey].push(b);
            });

            // Build calendar grid
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            let html = '';

            // Empty cells before first day
            for (let i = 0; i < firstDayOfMonth; i++) {
                html += '<div style="min-height: 100px; background: var(--gray-light); border-radius: 8px; opacity: 0.3;"></div>';
            }

            // Day cells
            for (let day = 1; day <= daysInMonth; day++) {
                const cellDate = new Date(year, month, day);
                // Fix timezone issue: format date as YYYY-MM-DD in local timezone, not UTC
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = cellDate.getTime() === today.getTime();
                const isPast = cellDate < today;
                const dayBookings = bookingsByDate[dateKey] || [];
                const hasBookings = dayBookings.length > 0;

                const requestedCount = dayBookings.filter(b => b.status === 'REQUESTED').length;
                const confirmedCount = dayBookings.filter(b => b.status === 'CONFIRMED').length;

                html += `
                    <div onclick="${hasBookings ? `showBookingsForDay('${dateKey}')` : ''}"
                         style="min-height: 100px; background: white; border-radius: 8px; padding: 10px; border: 1px solid ${isToday ? 'var(--primary)' : 'var(--gray-light)'}; ${isPast ? 'opacity: 0.5;' : ''} ${hasBookings ? 'cursor: pointer;' : ''} position: relative; ${isToday ? 'box-shadow: 0 0 0 2px var(--primary-light);' : ''}">
                        <div style="font-weight: 600; font-size: 14px; color: ${isToday ? 'var(--primary)' : 'var(--dark)'};">${day}</div>
                        ${hasBookings ? `
                            <div style="margin-top: 8px;">
                                <div style="font-size: 20px; font-weight: 700; color: var(--primary);">${dayBookings.length}</div>
                                <div style="font-size: 10px; color: var(--gray-medium);">booking${dayBookings.length > 1 ? 's' : ''}</div>
                            </div>
                            <div style="display: flex; gap: 4px; margin-top: 8px; flex-wrap: wrap;">
                                ${requestedCount > 0 ? `<span style="font-size: 9px; padding: 2px 6px; background: #fff3cd; color: #856404; border-radius: 10px;">${requestedCount} requested</span>` : ''}
                                ${confirmedCount > 0 ? `<span style="font-size: 9px; padding: 2px 6px; background: #d4edda; color: #155724; border-radius: 10px;">${confirmedCount} confirmed</span>` : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            grid.innerHTML = html;
        }

        function setBookingsView(view) {
            currentBookingsView = view;
            const listView = document.getElementById('bookingsListView');
            const calendarView = document.getElementById('bookingsCalendarView');
            const listBtn = document.getElementById('bookingsListViewBtn');
            const calendarBtn = document.getElementById('bookingsCalendarViewBtn');

            if (view === 'list') {
                listView.style.display = 'block';
                calendarView.style.display = 'none';
                listBtn.style.background = 'var(--primary)';
                listBtn.style.color = 'white';
                listBtn.classList.remove('btn-outline');
                calendarBtn.style.background = '';
                calendarBtn.style.color = '';
                calendarBtn.classList.add('btn-outline');
            } else {
                listView.style.display = 'none';
                calendarView.style.display = 'block';
                calendarBtn.style.background = 'var(--primary)';
                calendarBtn.style.color = 'white';
                calendarBtn.classList.remove('btn-outline');
                listBtn.style.background = '';
                listBtn.style.color = '';
                listBtn.classList.add('btn-outline');
                renderBookingsCalendar();
            }
        }

        function changeBookingsCalendarMonth(delta) {
            bookingsCalendarMonthOffset += delta;
            renderBookingsCalendar();
        }

        function goToBookingsCalendarToday() {
            bookingsCalendarMonthOffset = 0;
            renderBookingsCalendar();
        }

        function showBookingsForDay(dateKey) {
            const dayBookings = adminBookings.filter(b => (b.requestedDate || b.date).split('T')[0] === dateKey);
            const popup = document.getElementById('bookingsDayPopup');
            const title = document.getElementById('bookingsDayPopupTitle');
            const content = document.getElementById('bookingsDayPopupContent');

            const formattedDate = formatDateDisplay(dateKey + 'T00:00:00', {
                weekday: 'long'
            });
            title.textContent = `Bookings for ${formattedDate}`;

            if (dayBookings.length === 0) {
                content.innerHTML = '<p style="color: var(--gray-medium); text-align: center;">No bookings for this day</p>';
            } else {
                content.innerHTML = dayBookings.map(b => {
                    const timeStr = b.confirmedTime || b.time || b.preferredTimeOfDay || 'Time TBC';
                    return `
                        <div style="padding: 15px; border: 1px solid var(--gray-light); border-radius: 10px; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                                <div>
                                    <div style="font-weight: 600;">${b.customerName || 'Guest'}</div>
                                    <div style="font-size: 12px; color: var(--gray-medium);">${b.customerEmail || ''}</div>
                                </div>
                                <span class="status-badge status-${b.status}">${b.status}</span>
                            </div>
                            <div style="font-size: 14px; margin-bottom: 5px;"><strong>Service:</strong> ${b.serviceName}</div>
                            <div style="font-size: 14px; margin-bottom: 5px;"><strong>Time:</strong> ${timeStr}</div>
                            ${b.stylistName ? `<div style="font-size: 14px; margin-bottom: 5px;"><strong>Stylist:</strong> ${b.stylistName}</div>` : ''}
                            ${b.notes ? `<div style="font-size: 12px; color: var(--gray-medium); margin-top: 8px; padding: 8px; background: var(--gray-light); border-radius: 4px;"><strong>Notes:</strong> ${b.notes}</div>` : ''}
                            <div style="margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="btn btn-sm booking-edit-btn" data-booking-id="${b.id}">✏️ Edit</button>
                                ${b.status === 'REQUESTED' ? `
                                    <button class="btn btn-sm btn-primary booking-confirm-close-btn" data-booking-id="${b.id}">✓ Confirm</button>
                                ` : ''}
                                ${b.status === 'CONFIRMED' ? `
                                    <button class="btn btn-sm btn-primary booking-complete-close-btn" data-booking-id="${b.id}">✓ Complete</button>
                                ` : ''}
                                ${(b.status === 'REQUESTED' || b.status === 'CONFIRMED') ? `
                                    <button class="btn btn-sm btn-outline booking-cancel-close-btn" data-booking-id="${b.id}">✗ Cancel</button>
                                ` : ''}
                                <button class="btn btn-sm booking-delete-btn" data-booking-id="${b.id}" style="background: var(--danger); color: white; margin-left: auto;">🗑️ Delete</button>
                            </div>
                        </div>
                    `;
                }).join('');

                // Attach event listeners for popup buttons
                attachBookingPopupListeners();
            }

            popup.style.display = 'flex';
        }

        function attachBookingPopupListeners() {
            // Edit buttons
            document.querySelectorAll('.booking-edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const bookingId = this.getAttribute('data-booking-id');
                    openEditBookingModal(bookingId);
                });
            });

            // Confirm and close popup buttons
            document.querySelectorAll('.booking-confirm-close-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const bookingId = this.getAttribute('data-booking-id');
                    await confirmBookingTime(bookingId);
                    closeBookingsDayPopup();
                });
            });

            // Complete and close popup buttons
            document.querySelectorAll('.booking-complete-close-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const bookingId = this.getAttribute('data-booking-id');
                    await completeBooking(bookingId);
                    closeBookingsDayPopup();
                });
            });

            // Cancel and close popup buttons
            document.querySelectorAll('.booking-cancel-close-btn').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const bookingId = this.getAttribute('data-booking-id');
                    await cancelBooking(bookingId);
                    closeBookingsDayPopup();
                });
            });

            // Delete buttons
            document.querySelectorAll('.booking-delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const bookingId = this.getAttribute('data-booking-id');
                    deleteBooking(bookingId);
                });
            });
        }

        // Calendar view state
        let currentCalendarView = 'month'; // 'day', 'week', 'month'
        let calendarViewDate = new Date();

        function setCalendarView(view) {
            currentCalendarView = view;

            // Update button states
            ['Day', 'Week', 'Month'].forEach(v => {
                const btn = document.getElementById(`calendar${v}Btn`);
                if (v.toLowerCase() === view) {
                    btn.style.background = 'var(--primary)';
                    btn.style.color = 'white';
                    btn.classList.remove('btn-outline');
                } else {
                    btn.style.background = '';
                    btn.style.color = '';
                    btn.classList.add('btn-outline');
                }
            });

            // Show/hide appropriate views
            document.getElementById('calendarDayView').style.display = view === 'day' ? 'block' : 'none';
            document.getElementById('calendarWeekView').style.display = view === 'week' ? 'block' : 'none';
            document.getElementById('calendarMonthView').style.display = view === 'month' ? 'block' : 'none';

            // Render the appropriate view
            if (view === 'day') {
                renderDayView();
            } else if (view === 'week') {
                renderWeekView();
            } else {
                renderBookingsCalendar();
            }
        }

        function renderDayView() {
            const dateLabel = document.getElementById('dayViewDate');
            const grid = document.getElementById('dayViewGrid');
            const label = document.getElementById('bookingsCalendarLabel');

            const formattedDate = formatDateDisplay(calendarViewDate, {
                weekday: 'long'
            });
            dateLabel.textContent = formattedDate;
            label.textContent = formattedDate;

            const dateKey = calendarViewDate.toISOString().split('T')[0];
            const dayBookings = adminBookings.filter(b => b.date.split('T')[0] === dateKey);

            // Helper: Calculate duration in minutes from start/end times
            function calculateDuration(booking) {
                if (booking.assignedStartTime && booking.assignedEndTime) {
                    const [startH, startM] = booking.assignedStartTime.split(':').map(Number);
                    const [endH, endM] = booking.assignedEndTime.split(':').map(Number);
                    return (endH * 60 + endM) - (startH * 60 + startM);
                }
                return 60; // Default to 60 minutes if no end time
            }

            // Helper: Calculate position in minutes from start of day (6 AM)
            function calculatePosition(timeStr) {
                const [h, m] = timeStr.split(':').map(Number);
                return (h * 60 + m) - (6 * 60); // Offset from 6 AM
            }

            // Prepare bookings with calculated positions and durations
            const bookingsWithLayout = dayBookings.map(b => {
                const time = b.assignedStartTime || b.confirmedTime || b.time || '09:00';
                return {
                    ...b,
                    time,
                    position: calculatePosition(time),
                    duration: calculateDuration(b)
                };
            }).filter(b => b.position >= 0 && b.position < 960); // Only bookings between 6 AM and 10 PM

            // Sort by time
            bookingsWithLayout.sort((a, b) => a.position - b.position);

            // Group bookings that overlap horizontally
            const bookingGroups = [];
            bookingsWithLayout.forEach(booking => {
                // Find a group where this booking overlaps with any booking in the group
                let placed = false;
                for (let group of bookingGroups) {
                    const overlaps = group.some(gb => {
                        const gbEnd = gb.position + gb.duration;
                        const bEnd = booking.position + booking.duration;
                        return !(booking.position >= gbEnd || bEnd <= gb.position);
                    });
                    if (overlaps) {
                        group.push(booking);
                        placed = true;
                        break;
                    }
                }
                if (!placed) {
                    bookingGroups.push([booking]);
                }
            });

            // Calculate horizontal positions for overlapping bookings
            bookingsWithLayout.forEach(b => {
                b.column = 0;
                b.columnCount = 1;
            });

            bookingGroups.forEach(group => {
                if (group.length > 1) {
                    group.forEach((b, idx) => {
                        b.column = idx;
                        b.columnCount = group.length;
                    });
                }
            });

            const PIXELS_PER_MINUTE = 1; // 1px per minute means 60px per hour
            const START_HOUR = 6;
            const END_HOUR = 22;
            const TOTAL_HEIGHT = (END_HOUR - START_HOUR) * 60 * PIXELS_PER_MINUTE;

            let html = '<div style="display: grid; grid-template-columns: 80px 1fr;">';

            // Time slots from 6 AM to 10 PM
            for (let hour = START_HOUR; hour <= END_HOUR; hour++) {
                const displayTime = hour < 12 ? `${hour} AM` : hour === 12 ? '12 PM' : `${hour - 12} PM`;

                html += `
                    <div style="border-right: 1px solid var(--gray-light); border-bottom: 1px solid var(--gray-light); padding: 8px 10px; font-size: 11px; color: var(--gray-medium); text-align: right; height: ${60 * PIXELS_PER_MINUTE}px;">
                        ${displayTime}
                    </div>
                    <div style="border-bottom: 1px solid var(--gray-light); position: relative; height: ${60 * PIXELS_PER_MINUTE}px;">
                    </div>
                `;
            }

            html += '</div>';

            // Overlay bookings with absolute positioning
            html += '<div style="position: absolute; top: 0; left: 80px; right: 0; height: ' + TOTAL_HEIGHT + 'px; pointer-events: none;">';

            bookingsWithLayout.forEach(b => {
                const statusColors = {
                    'REQUESTED': 'background: #fff3cd; border-left: 3px solid #856404;',
                    'CONFIRMED': 'background: #d4edda; border-left: 3px solid #155724;',
                    'COMPLETED': 'background: #d1ecf1; border-left: 3px solid #0c5460;',
                    'CANCELLED': 'background: #f8d7da; border-left: 3px solid #721c24;'
                };

                const topPos = b.position * PIXELS_PER_MINUTE;
                const height = b.duration * PIXELS_PER_MINUTE;
                const leftPercent = (b.column / b.columnCount) * 100;
                const widthPercent = (1 / b.columnCount) * 100;

                html += `
                    <div class="calendar-booking-item" data-booking-id="${b.id}"
                         style="position: absolute;
                                top: ${topPos}px;
                                left: ${leftPercent}%;
                                width: calc(${widthPercent}% - 4px);
                                height: ${height}px;
                                min-height: 40px;
                                padding: 8px 10px;
                                border-radius: 4px;
                                ${statusColors[b.status] || statusColors['CONFIRMED']}
                                cursor: pointer;
                                pointer-events: auto;
                                overflow: hidden;
                                box-sizing: border-box;"
                         title="Click to edit booking">
                        <div style="font-weight: 600; font-size: 13px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${b.customerName || 'Guest'}</div>
                        <div style="font-size: 11px; margin-top: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${b.serviceName}</div>
                        <div style="font-size: 10px; color: var(--gray-medium); margin-top: 2px;">${b.time} (${b.duration}min)</div>
                        <div style="position: absolute; top: 5px; right: 5px; font-size: 10px; opacity: 0.7;">✏️</div>
                    </div>
                `;
            });

            html += '</div>';

            grid.innerHTML = html;
            grid.style.position = 'relative';

            // Attach event listeners to calendar booking items
            attachCalendarBookingListeners();
        }

        function attachCalendarBookingListeners() {
            const items = document.querySelectorAll('.calendar-booking-item');
            console.log('Attaching calendar booking listeners to', items.length, 'items');
            items.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const bookingId = this.getAttribute('data-booking-id');
                    console.log('Calendar booking clicked:', bookingId);
                    if (typeof openEditBookingModal === 'function') {
                        openEditBookingModal(bookingId);
                    } else {
                        console.error('openEditBookingModal function not found!');
                    }
                });
            });
        }

        function renderWeekView() {
            const label = document.getElementById('bookingsCalendarLabel');
            const grid = document.getElementById('weekViewGrid');

            // Get start of week (Sunday)
            const weekStart = new Date(calendarViewDate);
            weekStart.setDate(weekStart.getDate() - weekStart.getDay());

            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);

            label.textContent = `${formatDateDisplay(weekStart)} - ${formatDateDisplay(weekEnd)}`;

            let html = '';

            // Time slots from 6 AM to 10 PM
            for (let hour = 6; hour <= 22; hour++) {
                const displayTime = hour < 12 ? `${hour} AM` : hour === 12 ? '12 PM' : `${hour - 12} PM`;

                html += `<div style="border-right: 1px solid var(--gray-light); border-bottom: 1px solid var(--gray-light); padding: 8px 5px; font-size: 10px; color: var(--gray-medium); text-align: right;">${displayTime}</div>`;

                // For each day of the week
                for (let dayOffset = 0; dayOffset < 7; dayOffset++) {
                    const cellDate = new Date(weekStart);
                    cellDate.setDate(weekStart.getDate() + dayOffset);
                    const dateKey = cellDate.toISOString().split('T')[0];
                    const time = `${hour.toString().padStart(2, '0')}:00`;

                    const hourBookings = adminBookings.filter(b => {
                        if (b.date.split('T')[0] !== dateKey) return false;
                        const bookingTime = b.confirmedTime || b.time || '';
                        return bookingTime.startsWith(time.substring(0, 2));
                    });

                    const borderRight = dayOffset < 6 ? 'border-right: 1px solid var(--gray-light);' : '';
                    html += `<div style="${borderRight} border-bottom: 1px solid var(--gray-light); padding: 2px; min-height: 50px; font-size: 10px;">`;

                    hourBookings.forEach(b => {
                        const statusColors = {
                            'pending': 'background: #fff3cd;',
                            'confirmed': 'background: #d4edda;',
                            'completed': 'background: #d1ecf1;',
                            'cancelled': 'background: #f8d7da;'
                        };

                        html += `
                            <div class="calendar-booking-item" data-booking-id="${b.id}" style="margin: 1px 0; padding: 4px; border-radius: 3px; ${statusColors[b.status] || ''} cursor: pointer; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"
                                 title="Click to edit: ${b.customerName} - ${b.serviceName}">
                                ${b.customerName?.substring(0, 10) || 'Guest'}
                            </div>
                        `;
                    });

                    html += '</div>';
                }
            }

            grid.innerHTML = html;

            // Attach event listeners to calendar booking items
            attachCalendarBookingListeners();
        }

        function changeBookingsCalendarPeriod(delta) {
            if (currentCalendarView === 'day') {
                calendarViewDate.setDate(calendarViewDate.getDate() + delta);
                renderDayView();
            } else if (currentCalendarView === 'week') {
                calendarViewDate.setDate(calendarViewDate.getDate() + (delta * 7));
                renderWeekView();
            } else {
                bookingsCalendarMonthOffset += delta;
                renderBookingsCalendar();
            }
        }

        function goToCalendarToday() {
            calendarViewDate = new Date();
            bookingsCalendarMonthOffset = 0;

            if (currentCalendarView === 'day') {
                renderDayView();
            } else if (currentCalendarView === 'week') {
                renderWeekView();
            } else {
                renderBookingsCalendar();
            }
        }

        function closeBookingsDayPopup() {
            document.getElementById('bookingsDayPopup').style.display = 'none';
        }

        // Edit booking functionality
        let currentEditingBookingId = null;

        async function openEditBookingModal(bookingId) {
            currentEditingBookingId = bookingId;
            const booking = adminBookings.find(b => b.id === bookingId);

            if (!booking) {
                alert('Booking not found');
                return;
            }

            // Ensure data is loaded
            await ensureAdminBookingData();

            // Populate services dropdown
            const serviceSelect = document.getElementById('editBookingService');
            serviceSelect.innerHTML = adminBookingServices.map(s =>
                `<option value="${s.id}" ${s.id === booking.serviceId ? 'selected' : ''}>
                    ${s.name} - R${s.price}
                </option>`
            ).join('');

            // Populate stylists dropdown
            const stylistSelect = document.getElementById('editBookingStylist');
            stylistSelect.innerHTML = '<option value="">Any Available</option>' +
                adminBookingStylists.map(s =>
                    `<option value="${s.id}" ${s.id === booking.stylistId ? 'selected' : ''}>${s.name}</option>`
                ).join('');

            // Fill form with current booking data
            document.getElementById('editBookingCustomer').value = booking.customerName || 'Guest';
            document.getElementById('editBookingService').value = booking.serviceId || '';
            document.getElementById('editBookingStylist').value = booking.stylistId || '';
            document.getElementById('editBookingDate').value = booking.date.split('T')[0];
            document.getElementById('editBookingTime').value = booking.confirmedTime || booking.time || '';
            document.getElementById('editBookingDuration').value = booking.duration || 60;
            document.getElementById('editBookingStatus').value = booking.status;
            document.getElementById('editBookingCommissionRate').value = booking.commission_rate !== null && booking.commission_rate !== undefined
                ? (booking.commission_rate * 100).toFixed(0)
                : '';
            document.getElementById('editBookingNotes').value = booking.notes || '';

            // Clear error
            const errorEl = document.getElementById('editBookingError');
            if (errorEl) {
                errorEl.style.display = 'none';
                errorEl.textContent = '';
            }

            // Close day popup if open
            closeBookingsDayPopup();

            // Open edit modal
            openModal('editBookingModal');
        }

        async function saveBookingEdit() {
            const errorEl = document.getElementById('editBookingError');
            if (errorEl) {
                errorEl.style.display = 'none';
                errorEl.textContent = '';
            }

            try {
                const serviceId = document.getElementById('editBookingService').value;
                const stylistId = document.getElementById('editBookingStylist').value;
                const date = document.getElementById('editBookingDate').value;
                const time = document.getElementById('editBookingTime').value;
                const duration = document.getElementById('editBookingDuration').value;
                const status = document.getElementById('editBookingStatus').value;
                const notes = document.getElementById('editBookingNotes').value;
                const commissionRateInput = document.getElementById('editBookingCommissionRate').value.trim();

                if (!date) {
                    throw new Error('Date is required');
                }

                if (!serviceId) {
                    throw new Error('Service is required');
                }

                const service = adminBookingServices.find(s => s.id === serviceId);
                if (!service) {
                    throw new Error('Invalid service selected');
                }

                // Parse commission rate: convert from percentage to decimal, or null if empty
                const commissionRate = commissionRateInput !== '' ? parseFloat(commissionRateInput) / 100 : null;

                const updateData = {
                    serviceId: serviceId,
                    serviceName: service.name,
                    servicePrice: service.price,
                    stylistId: stylistId || null,
                    date: date,
                    confirmedTime: time || null,
                    time: time || null,
                    duration: duration ? parseInt(duration) : null,
                    status: status,
                    notes: notes || null,
                    commissionRate: commissionRate,
                    updatedAt: new Date().toISOString()
                };

                // If status is completed, add completed timestamp
                if (status === 'completed') {
                    updateData.completedAt = new Date().toISOString();
                }

                await apiCall(`/admin/bookings/${currentEditingBookingId}`, {
                    method: 'PATCH',
                    body: JSON.stringify(updateData)
                });

                showAdminToast('Booking updated successfully!', 'success');
                closeModal('editBookingModal');
                loadBookings();

            } catch (error) {
                if (errorEl) {
                    errorEl.style.display = 'block';
                    errorEl.textContent = error.message;
                } else {
                    showAdminToast('Error updating booking: ' + (error.message || ''), 'error');
                }
            }
        }

        async function deleteBooking(bookingId) {
            const proceed = await openConfirmDialog({
                title: 'Delete booking?',
                message: 'This action cannot be undone.',
                confirmText: 'Delete',
                tone: 'danger'
            });
            if (!proceed) return;

            try {
                await apiCall(`/admin/bookings/${bookingId}`, {
                    method: 'DELETE'
                });

                showAdminToast('Booking deleted successfully', 'success');
                closeBookingsDayPopup();
                closeModal('editBookingModal');
                loadBookings();

            } catch (error) {
                showAdminToast('Error deleting booking: ' + (error.message || ''), 'error');
            }
        }

        async function completeBooking(id) {
            const proceed = await openConfirmDialog({
                title: 'Complete booking?',
                message: 'Mark this booking as completed.',
                confirmText: 'Complete'
            });
            if (!proceed) return;
            try {
                await apiCall(`/admin/bookings/${id}/status`, {
                    method: 'PATCH',
                    body: JSON.stringify({ status: 'COMPLETED' })
                });
                showAdminToast('Booking marked as completed', 'success');
                loadBookings();
            } catch (error) {
                showAdminToast('Error completing booking: ' + (error.message || 'Database error'), 'error');
            }
        }

        async function confirmBookingTime(id) {
            const time = prompt('Enter confirmed time (e.g., 10:00):');
            if (time) {
                try {
                    await apiCall(`/admin/bookings/${id}/confirm`, {
                        method: 'PATCH',
                        body: JSON.stringify({ confirmedTime: time })
                    });
                    alert('Booking confirmed!');
                    loadBookings();
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            }
        }

        async function cancelBooking(id) {
            const proceed = await openConfirmDialog({
                title: 'Cancel booking?',
                message: 'This will cancel the booking and notify the customer if configured.',
                confirmText: 'Cancel Booking',
                tone: 'danger'
            });
            if (!proceed) return;
            try {
                await apiCall(`/admin/bookings/${id}/status`, {
                    method: 'PATCH',
                    body: JSON.stringify({ status: 'CANCELLED' })
                });
                showAdminToast('Booking cancelled', 'success');
                loadBookings();
            } catch (error) {
                showAdminToast('Error cancelling booking: ' + (error.message || 'Database error'), 'error');
            }
        }

        // ============================================
        // ASSIGN TIME MODAL (New Two-Step Booking Flow)
        // ============================================
        let currentAssignBookingId = null;
        let currentAssignBooking = null;
        let selectedTimeSlot = null;

        async function openAssignTimeModal(bookingId) {
            try {
                console.log('📋 openAssignTimeModal called with bookingId:', bookingId);
                console.log('📚 allBookings array has', allBookings.length, 'bookings');

                // Ensure we have stylists data loaded
                console.log('📝 Step 0: Ensuring admin booking data is loaded...');
                await ensureAdminBookingData();
                console.log('✅ Admin booking data loaded. Stylists:', adminBookingStylists.length);

                currentAssignBookingId = bookingId;
                currentAssignBooking = allBookings.find(b => b.id === bookingId);

                if (!currentAssignBooking) {
                    console.error('❌ Booking not found in allBookings array');
                    alert('Booking not found');
                    return;
                }
                console.log('✅ Found booking:', currentAssignBooking);

                // Populate booking details
                console.log('📝 Step 1: Setting customer name...');
                document.getElementById('assignTimeCustomer').textContent = currentAssignBooking.customerName || 'Guest';

                console.log('📝 Step 2: Setting requested date...');
                const requestedDate = new Date(currentAssignBooking.requestedDate || currentAssignBooking.date);
                document.getElementById('assignTimeRequestedDate').textContent = requestedDate.toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                console.log('📝 Step 3: Setting time window...');
                // Format time window
                const timeWindow = window.BookingConstants?.getTimeWindow(currentAssignBooking.requestedTimeWindow || currentAssignBooking.preferredTimeOfDay);
                document.getElementById('assignTimeWindow').textContent = timeWindow ?
                    `${timeWindow.icon} ${timeWindow.label} (${timeWindow.description})` :
                    (currentAssignBooking.requestedTimeWindow || currentAssignBooking.preferredTimeOfDay || 'Any');

                console.log('📝 Step 4: Loading services dropdown...');
                // Load services dropdown
                const serviceSelect = document.getElementById('assignTimeServiceSelect');
                if (adminBookingServices && adminBookingServices.length > 0) {
                    serviceSelect.innerHTML = '<option value="">Select service...</option>' +
                        adminBookingServices.map(s => `<option value="${s.id}" data-duration="${s.duration || 60}">${s.name} (${s.category || 'General'})</option>`).join('');
                    serviceSelect.value = currentAssignBooking.serviceId || '';
                }

                console.log('📝 Step 5: Pre-selecting stylist and date...');
                // Pre-select stylist and date
                document.getElementById('assignTimeStylist').value = currentAssignBooking.stylistId || '';
                document.getElementById('assignTimeDate').value = currentAssignBooking.requestedDate || currentAssignBooking.date;

                console.log('📝 Step 6: Loading stylists dropdown...');
                // Load stylists dropdown
                const stylistSelect = document.getElementById('assignTimeStylist');
                if (adminBookingStylists && adminBookingStylists.length > 0) {
                    stylistSelect.innerHTML = '<option value="">Select stylist...</option>' +
                        adminBookingStylists.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                    stylistSelect.value = currentAssignBooking.stylistId || '';
                }

                // Reset
                console.log('📝 Step 7: Resetting form...');
                selectedTimeSlot = null;
                document.getElementById('assignTimeError').style.display = 'none';

                // Load schedule if stylist and date are selected
                console.log('📝 Step 8: Checking if we need to load schedule...');
                if (currentAssignBooking.stylistId && (currentAssignBooking.requestedDate || currentAssignBooking.date)) {
                    console.log('📝 Step 9: Loading stylist schedule...');
                    await loadStylistSchedule();
                }

                console.log('📝 Step 10: Opening modal...');
                openModal('assignTimeModal');
                console.log('✅ Modal opened successfully!');
            } catch (error) {
                console.error('❌ Error in openAssignTimeModal:', error);
                console.error('Error stack:', error.stack);
                alert('Error opening assign modal: ' + error.message);
            }
        }

        function updateServiceDuration() {
            const serviceSelect = document.getElementById('assignTimeServiceSelect');
            const selectedOption = serviceSelect.options[serviceSelect.selectedIndex];
            const duration = selectedOption ? selectedOption.getAttribute('data-duration') : 60;
            document.getElementById('assignTimeDuration').value = duration || 60;
        }

        async function loadStylistSchedule() {
            const stylistId = document.getElementById('assignTimeStylist').value;
            const date = document.getElementById('assignTimeDate').value;
            const container = document.getElementById('timeSlotSchedule');

            if (!stylistId || !date) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--gray-medium);">Select a stylist and date to view available time slots</div>';
                return;
            }

            container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--gray-medium);">Loading schedule...</div>';

            // Generate time slots (8 AM to 8 PM, every 30 minutes)
            const timeSlots = [];
            for (let hour = 8; hour < 20; hour++) {
                for (let minute of [0, 30]) {
                    const timeStr = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                    timeSlots.push(timeStr);
                }
            }

            // Get booked slots for this stylist on this date
            const bookedSlots = allBookings
                .filter(b =>
                    b.stylistId === stylistId &&
                    (b.requestedDate || b.date) === date &&
                    b.status === 'CONFIRMED' &&
                    b.assignedStartTime
                )
                .map(b => b.assignedStartTime);

            // Render time slots
            container.innerHTML = '<div class="time-slots-grid">' +
                timeSlots.map(slot => {
                    const isBooked = bookedSlots.includes(slot);
                    return `<div class="time-slot ${isBooked ? 'booked' : ''}" data-time="${slot}">${slot}</div>`;
                }).join('') +
                '</div>';

            // Add click handlers
            document.querySelectorAll('.time-slot:not(.booked)').forEach(slot => {
                slot.addEventListener('click', function() {
                    // Remove selected from all
                    document.querySelectorAll('.time-slot').forEach(s => s.classList.remove('selected'));
                    // Add to clicked
                    this.classList.add('selected');
                    selectedTimeSlot = this.dataset.time;
                });
            });
        }

        async function confirmAssignTime() {
            const stylistId = document.getElementById('assignTimeStylist').value;
            const date = document.getElementById('assignTimeDate').value;
            const duration = parseInt(document.getElementById('assignTimeDuration').value) || 60;
            const errorDiv = document.getElementById('assignTimeError');

            errorDiv.style.display = 'none';

            if (!stylistId) {
                errorDiv.textContent = 'Please select a stylist';
                errorDiv.style.display = 'block';
                return;
            }

            if (!date) {
                errorDiv.textContent = 'Please select a date';
                errorDiv.style.display = 'block';
                return;
            }

            if (!selectedTimeSlot) {
                errorDiv.textContent = 'Please select a time slot';
                errorDiv.style.display = 'block';
                return;
            }

            // Calculate end time
            const [hours, minutes] = selectedTimeSlot.split(':').map(Number);
            const endMinutes = hours * 60 + minutes + duration;
            const endHours = Math.floor(endMinutes / 60);
            const endMins = endMinutes % 60;
            const assignedEndTime = `${endHours.toString().padStart(2, '0')}:${endMins.toString().padStart(2, '0')}`;

            try {
                await apiCall(`/admin/bookings/${currentAssignBookingId}/assign-time`, {
                    method: 'POST',
                    body: JSON.stringify({
                        stylistId,
                        assignedStartTime: selectedTimeSlot,
                        assignedEndTime
                    })
                });

                alert('✅ Time assigned successfully! Booking is now confirmed.');
                closeModal('assignTimeModal');
                loadBookings();
            } catch (error) {
                errorDiv.textContent = error.message || 'Failed to assign time';
                errorDiv.style.display = 'block';
            }
        }

        // ============================================
        // STAFF
        // ============================================
        async function loadStaff() {
            try {
                const data = await apiCall('/admin/staff');
                const container = document.querySelector('#staff .data-table tbody');
                if (container && data.staff.length > 0) {
                    container.innerHTML = data.staff.map(s => `
                        <tr>
                            <td><div style="display:flex;align-items:center;gap:10px;">
                                ${(s.imageUrl || s.image_url) ?
                                    `<img src="${s.imageUrl || s.image_url}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;" alt="${s.name}">` :
                                    `<div style="width:40px;height:40px;border-radius:50%;background:${s.color};display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;">${s.name.charAt(0)}</div>`
                                }
                                <div><strong>${s.name}</strong><br><small>${s.specialty}</small></div>
                            </div></td>
                            <td>${s.specialty}</td>
                            <td>${s.clientsCount || 'undefined'} clients</td>
                            <td><span class="status-badge status-${s.available ? 'confirmed' : 'cancelled'}">${s.available ? 'Active' : 'Inactive'}</span></td>
                            <td>
                                <button class="btn btn-sm" onclick="editStaff('${s.id}')">Edit</button>
                                <button class="btn btn-sm btn-outline" onclick="archiveStaff('${s.id}')" style="margin-left:6px;">Archive</button>
                                <button class="btn btn-sm btn-outline" onclick="deleteStaff('${s.id}')" style="margin-left:6px; color: var(--danger);">Delete</button>
                            </td>
                        </tr>
                    `).join('');
                } else if (container) {
                    container.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color: var(--text-subtle);">No staff members yet</td></tr>';
                }
            } catch (error) {
                console.log('Staff load error:', error);
            }
        }

        function handleStaffPhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                showAdminToast('Please select an image file', 'error');
                return;
            }

            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                showAdminToast('Image must be less than 5MB', 'error');
                return;
            }

            // Read file and convert to base64
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('staffPhotoPreview');
                const base64 = e.target.result;

                // Show preview
                preview.src = base64;
                preview.style.display = 'block';

                // Store the base64 data for saving
                preview.dataset.imageUrl = base64;
            };
            reader.onerror = function() {
                showAdminToast('Error reading file', 'error');
            };
            reader.readAsDataURL(file);
        }

        async function saveStaff() {
            const name = document.getElementById('staffName')?.value?.trim();
            const specialty = document.getElementById('staffRole')?.value;
            const tagline = document.getElementById('staffTagline')?.value?.trim();
            const yearsExperience = parseInt(document.getElementById('staffExperience')?.value) || 0;
            const instagram = document.getElementById('staffInstagram')?.value?.trim();
            const imageUrl = document.getElementById('staffPhotoPreview')?.dataset?.imageUrl || '';

            if (!name || !specialty) {
                showAdminToast('Name and specialty are required', 'error');
                return;
            }

            const staffData = { name, specialty, tagline, yearsExperience, instagram, imageUrl };

            try {
                if (editingStaffId) {
                    // Update existing staff
                    await apiCall(`/admin/staff/${editingStaffId}`, {
                        method: 'PATCH',
                        body: JSON.stringify(staffData)
                    });
                    showAdminToast('Staff member updated!', 'success');
                } else {
                    // Create new staff
                    await apiCall('/admin/staff', {
                        method: 'POST',
                        body: JSON.stringify(staffData)
                    });
                    showAdminToast('Staff member added!', 'success');
                }
                editingStaffId = null;
                staffListCache = []; // Clear cache
                closeModal('addStaffModal');
                loadStaff();
            } catch (error) {
                showAdminToast('Error saving staff: ' + (error.message || ''), 'error');
            }
        }

        // ============================================
        // CUSTOMERS
        // ============================================
        let editingCustomerId = null;

        async function loadCustomers() {
            try {
                const data = await apiCall('/admin/customers');
                const container = document.querySelector('#customers .data-table tbody');
                const countEl = document.getElementById('customersCount');
                if (countEl) countEl.textContent = `${data.customers.length} customers`;

                window.lastCustomersList = data.customers || [];

                if (container && data.customers.length > 0) {
                    container.innerHTML = data.customers.map(c => {
                        const initials = getInitials(c.name || c.email || '');
                        const lastVisit = c.createdAt ? formatDateDisplay(c.createdAt) : '-';
                        const tierLabel = (c.tier || 'bronze').charAt(0).toUpperCase() + (c.tier || 'bronze').slice(1);
                        return `
                            <tr>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <div class="avatar-placeholder" style="background: var(--brand-gradient); color: white;">${initials}</div>
                                        <div>
                                            <div style="font-weight: 600;">${c.name || '-'}</div>
                                        </div>
                                    </div>
                                </td>
                                <td>${c.email || '-'}</td>
                                <td>${c.phone || '-'}</td>
                                <td><span class="status-badge status-confirmed" style="text-transform: capitalize;">${tierLabel}</span></td>
                                <td>${(c.points || 0).toLocaleString()}</td>
                                <td>R${(c.totalSpent || 0).toLocaleString()}</td>
                                <td>${lastVisit}</td>
                                <td class="action-btns">
                                    <button class="btn btn-icon btn-outline" title="Edit" onclick="editCustomer('${c.id}')">✏️</button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                } else if (container) {
                    container.innerHTML = '<tr><td colspan=\"8\" style=\"text-align:center; padding:20px; color: var(--text-subtle);\">No customers yet</td></tr>';
                }
            } catch (error) {
                console.log('Customers load error:', error);
            }
        }

        // Flag to track if we're creating a customer from booking modal
        let creatingCustomerFromBooking = false;

        // Open new customer modal from booking flow
        function openNewCustomerFromBooking() {
            creatingCustomerFromBooking = true;
            // Don't close booking modal - just open customer modal on top
            openCustomerModal(null);
            // Add stacked class so customer modal appears above booking modal
            document.getElementById('customerModal').classList.add('stacked');
        }

        function openCustomerModal(customer = null) {
            editingCustomerId = customer?.id || null;
            document.getElementById('customerModalTitle').textContent = editingCustomerId ? 'Edit Customer' : 'Add Customer';
            document.getElementById('editingCustomerId').value = editingCustomerId || '';
            document.getElementById('customerName').value = customer?.name || '';
            document.getElementById('customerEmail').value = customer?.email || '';
            document.getElementById('customerPhone').value = customer?.phone || '';
            document.getElementById('customerTier').value = customer?.tier || 'bronze';
            document.getElementById('customerPoints').value = customer?.points ?? 0;
            document.getElementById('customerPassword').value = '';

            // Show/hide reset password section based on whether we're editing
            const resetSection = document.getElementById('resetPasswordSection');
            const resetResult = document.getElementById('resetPasswordResult');
            if (editingCustomerId) {
                resetSection.style.display = 'block';
                resetResult.style.display = 'none';
            } else {
                resetSection.style.display = 'none';
            }

            openModal('customerModal');
        }

        function closeCustomerModal() {
            editingCustomerId = null;
            creatingCustomerFromBooking = false; // Reset flag on close
            document.getElementById('customerModal').classList.remove('stacked'); // Remove stacked class
            closeModal('customerModal');
        }

        function editCustomer(customerId) {
            const rowData = window.lastCustomersList?.find(c => c.id === customerId);
            openCustomerModal(rowData || { id: customerId });
        }

        async function saveCustomer() {
            const name = document.getElementById('customerName').value.trim();
            const email = document.getElementById('customerEmail').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();
            const tier = document.getElementById('customerTier').value;
            const points = parseInt(document.getElementById('customerPoints').value, 10) || 0;
            const password = document.getElementById('customerPassword').value.trim();

            if (!name || !email) {
                alert('Name and email are required');
                return;
            }

            // Track if we came from booking flow
            const wasFromBookingFlow = creatingCustomerFromBooking;

            try {
                let newCustomerId = null;

                if (editingCustomerId) {
                    await apiCall(`/admin/customers/${editingCustomerId}`, {
                        method: 'PUT',
                        body: JSON.stringify({ name, phone, tier, points, password: password || undefined })
                    });
                    alert('Customer updated');
                } else {
                    const result = await apiCall('/admin/customers', {
                        method: 'POST',
                        body: JSON.stringify({ name, email, phone, tier, points, password: password || undefined })
                    });
                    newCustomerId = result.customerId || result.id;

                    if (wasFromBookingFlow) {
                        // Don't show alert, just close and update dropdown
                    } else {
                        alert('Customer added');
                    }
                }

                closeCustomerModal();
                await loadCustomers();

                // If we were creating from booking flow, update the booking customer dropdown and select new customer
                if (wasFromBookingFlow && newCustomerId) {
                    await refreshBookingCustomerDropdown(newCustomerId);
                }
            } catch (error) {
                alert('Error saving customer: ' + error.message);
            }
        }

        // Refresh the booking customer dropdown and optionally select a customer
        async function refreshBookingCustomerDropdown(selectCustomerId = null) {
            try {
                const data = await apiCall('/admin/customers');
                const customers = data.customers || [];
                const customerSelect = document.getElementById('adminBookingCustomer');

                customerSelect.innerHTML = '<option value="">Select customer...</option>' +
                    customers.map(c => `<option value="${c.id}">${c.name} (${c.email})</option>`).join('');

                // If a customer ID was provided, select them
                if (selectCustomerId) {
                    customerSelect.value = selectCustomerId;
                }
            } catch (error) {
                console.error('Error refreshing customer dropdown:', error);
            }
        }

        function openChatForCustomer(id, name, email) {
            alert(`Chat for ${name || email || id} coming soon`);
        }

        async function resetCustomerPassword() {
            if (!editingCustomerId) {
                alert('No customer selected');
                return;
            }

            const sendEmail = document.getElementById('sendResetEmail').checked;
            const resultEl = document.getElementById('resetPasswordResult');

            if (!confirm('Are you sure you want to reset this customer\'s password?')) {
                return;
            }

            try {
                resultEl.style.display = 'block';
                resultEl.style.background = '#fff3cd';
                resultEl.style.color = '#856404';
                resultEl.innerHTML = 'Resetting password...';

                const data = await apiCall(`/admin/customers/${editingCustomerId}/reset-password`, {
                    method: 'POST',
                    body: JSON.stringify({ sendEmail })
                });

                resultEl.style.background = '#d4edda';
                resultEl.style.color = '#155724';

                if (sendEmail) {
                    resultEl.innerHTML = `
                        <strong>Password reset successfully!</strong><br>
                        <span style="font-size: 12px;">Temporary password: <code style="background: #f8f9fa; padding: 2px 6px; border-radius: 4px;">${data.temporaryPassword}</code></span><br>
                        <span style="font-size: 12px;">Email sent to customer.</span>
                    `;
                } else {
                    resultEl.innerHTML = `
                        <strong>Password reset successfully!</strong><br>
                        <span style="font-size: 12px;">Temporary password: <code style="background: #f8f9fa; padding: 2px 6px; border-radius: 4px;">${data.temporaryPassword}</code></span><br>
                        <span style="font-size: 12px; color: #856404;">Please share this password with the customer manually.</span>
                    `;
                }
            } catch (error) {
                resultEl.style.background = '#f8d7da';
                resultEl.style.color = '#721c24';
                resultEl.innerHTML = `<strong>Error:</strong> ${error.message || 'Failed to reset password'}`;
            }
        }

        function getInitials(text) {
            return text.split(' ').filter(Boolean).map(t => t[0]).join('').slice(0, 2).toUpperCase() || '?';
        }

        // ============================================
        // PRODUCTS
        // ============================================
        async function loadProducts() {
            try {
                const data = await apiCall('/products');
                const rawProducts = data.products || [];

                const products = rawProducts.map(p => {
                    const salePrice = p.salePrice ?? p.sale_price ?? null;
                    const onSale = p.onSale ?? p.on_sale ?? !!salePrice;
                    const imageUrl = p.imageUrl || p.image_url || '';
                    return {
                        ...p,
                        name: p.name || 'Untitled product',
                        category: p.category || 'Uncategorized',
                        price: Number(p.price || 0),
                        salePrice: salePrice ? Number(salePrice) : null,
                        onSale: !!onSale,
                        stock: Number(p.stock || 0),
                        imageUrl,
                        sku: p.sku || ''
                    };
                });

                productListCache = products;

                // Calculate stats
                const totalCount = products.length;
                const lowStockThreshold = 10;
                const lowStockCount = products.filter(p => p.stock < lowStockThreshold).length;
                const inventoryValue = products.reduce((sum, p) => {
                    const effectivePrice = p.onSale && p.salePrice ? p.salePrice : p.price;
                    return sum + (effectivePrice * p.stock);
                }, 0);

                // Update stat cards
                document.getElementById('productsTotalCount').textContent = totalCount;
                document.getElementById('productsLowStockCount').textContent = lowStockCount;
                document.getElementById('productsInventoryValue').textContent = formatCurrencyZAR(inventoryValue);

                // Update product table
                const container = document.getElementById('productsTableBody');
                if (container) {
                    if (products.length > 0) {
                        container.innerHTML = products.map(p => {
                            const isLowStock = p.stock < lowStockThreshold;
                            const stockClass = isLowStock ? 'style="color: var(--danger); font-weight: 600;"' : '';
                            const stockBadge = isLowStock ? '<span style="background: rgba(244, 67, 54, 0.1); color: var(--danger); padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-left: 4px;">Low Stock</span>' : '';
                            const statusClass = p.stock > 0 ? 'status-confirmed' : 'cancelled';
                            const statusLabel = p.stock > 0 ? 'In Stock' : 'Out of Stock';
                            const thumb = p.imageUrl
                                ? `<img src="${p.imageUrl}" alt="${p.name}" style="width: 50px; height: 50px; object-fit: contain; background: var(--surface-muted); border-radius: 8px;">`
                                : `<div style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; background: var(--surface-muted); border-radius: 8px; color: var(--gray-medium); font-weight: 700;">${(p.name || '?').charAt(0)}</div>`;

                            const saleText = p.onSale && p.salePrice
                                ? `<span style="color: var(--danger); font-weight: 600;">${formatCurrencyZAR(p.salePrice)}</span>`
                                : '-';

                            return `
                                <tr>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            ${thumb}
                                            <div>
                                                <div style="font-weight: 600;">${p.name}</div>
                                                ${p.sku ? `<div style="font-size: 12px; color: var(--gray-medium);">SKU: ${p.sku}</div>` : ''}
                                            </div>
                                        </div>
                                    </td>
                                    <td>${p.category}</td>
                                    <td>${formatCurrencyZAR(p.price)}</td>
                                    <td>${saleText}</td>
                                    <td ${stockClass}>${p.stock}${stockBadge}</td>
                                    <td><span class="status-badge ${statusClass}">${statusLabel}</span></td>
                                    <td class="action-btns" style="gap: 6px;">
                                        <button class="btn btn-sm" onclick="editProduct('${p.id}')" title="Edit product">✏️ Edit</button>
                                        <button class="btn btn-sm" onclick="deleteProduct('${p.id}')" title="Delete product" style="color: var(--danger);">Delete</button>
                                    </td>
                                </tr>
                            `;
                        }).join('');
                    } else {
                        container.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--gray-medium);">No products yet. Add your first product!</td></tr>';
                    }
                }
            } catch (error) {
                console.log('Products load error:', error);
            }
        }

        function updateProductImagePreview(url = '') {
            const wrap = document.getElementById('productImagePreview');
            const img = wrap?.querySelector('img');
            if (!wrap || !img) return;
            if (url) {
                img.src = url;
                wrap.style.display = 'block';
            } else {
                wrap.style.display = 'none';
            }
        }

        async function saveProduct() {
            const name = document.getElementById('productName')?.value?.trim();
            const sku = document.getElementById('productSku')?.value?.trim();
            const description = document.getElementById('productDescription')?.value?.trim();
            const category = document.getElementById('productCategory')?.value;
            const price = parseFloat(document.getElementById('productPrice')?.value);
            const salePrice = parseFloat(document.getElementById('productSalePrice')?.value) || null;
            const stock = parseInt(document.getElementById('productStock')?.value) || 0;
            const imageUrl = document.getElementById('productImageUrl')?.value?.trim() || '';

            if (!name || !category || !price) {
                alert('Name, category, and price are required');
                return;
            }

            const productData = {
                name,
                sku,
                description,
                category,
                price,
                stock,
                onSale: salePrice ? true : false,
                salePrice: salePrice || null,
                imageUrl
            };

            try {
                if (editingProductId) {
                    // Update existing product
                    await apiCall(`/admin/products/${editingProductId}`, {
                        method: 'PATCH',
                        body: JSON.stringify(productData)
                    });
                    showAdminToast('Product updated!', 'success');
                } else {
                    // Create new product
                    await apiCall('/admin/products', {
                        method: 'POST',
                        body: JSON.stringify(productData)
                    });
                    showAdminToast('Product added!', 'success');
                }
                editingProductId = null;
                productListCache = []; // Clear cache
                closeModal('addProductModal');
                loadProducts();
            } catch (error) {
                showAdminToast('Error saving product: ' + (error.message || ''), 'error');
            }
        }

        // ============================================
        // ORDERS
        // ============================================
        let orderFiltersBound = false;

        function initOrderFilters() {
            if (orderFiltersBound) return;
            const statusSelect = document.getElementById('orderStatusFilter');
            const deliverySelect = document.getElementById('orderDeliveryFilter');
            const dateInput = document.getElementById('orderDateFilter');
            const clearBtn = document.getElementById('orderFiltersClear');

            [statusSelect, deliverySelect, dateInput].forEach(el => {
                if (el) {
                    el.addEventListener('change', () => loadOrders());
                }
            });

            if (clearBtn) {
                clearBtn.addEventListener('click', () => {
                    if (statusSelect) statusSelect.value = '';
                    if (deliverySelect) deliverySelect.value = '';
                    if (dateInput) dateInput.value = '';
                    loadOrders();
                });
            }

            orderFiltersBound = true;
        }

        const formatOrderStatusClass = (statusKey) => {
            const map = {
                pending: 'pending',
                processing: 'active',
                shipped: 'active',
                delivered: 'completed',
                paid: 'completed',
                cancelled: 'cancelled'
            };
            return map[statusKey] || 'pending';
        };

        const formatOrderStatusLabel = (statusKey) => {
            return (statusKey || 'pending')
                .replace(/_/g, ' ')
                .replace(/\b\w/g, (c) => c.toUpperCase());
        };

        const formatDeliveryLabel = (method) => {
            if (!method) return 'Pickup';
            return String(method)
                .split(' ')
                .map(part => part.charAt(0).toUpperCase() + part.slice(1))
                .join(' ');
        };

        // ========== PAYROLL MANAGEMENT ==========
        let payrollRecords = [];
        let stylistsPayData = [];

        function initPayrollYearSelector() {
            const yearSelect = document.getElementById('payrollYear');
            if (!yearSelect) return;

            const currentYear = new Date().getFullYear();
            yearSelect.innerHTML = '';
            for (let y = currentYear; y >= currentYear - 2; y--) {
                const opt = document.createElement('option');
                opt.value = y;
                opt.textContent = y;
                yearSelect.appendChild(opt);
            }
            yearSelect.value = currentYear;

            // Set current month
            const monthSelect = document.getElementById('payrollMonth');
            if (monthSelect) {
                monthSelect.value = new Date().getMonth() + 1;
            }
        }

        async function loadPayroll() {
            const year = document.getElementById('payrollYear')?.value;
            const month = document.getElementById('payrollMonth')?.value;
            const status = document.getElementById('payrollStatus')?.value;

            if (!year || !month) return;

            const tbody = document.getElementById('payrollTableBody');
            const countEl = document.getElementById('payrollRecordsCount');

            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px; color: var(--gray-medium);">Loading...</td></tr>';
            }

            try {
                const params = new URLSearchParams({ year, month });
                if (status) params.append('status', status);

                const data = await apiCall(`/admin/payroll?${params.toString()}`);
                payrollRecords = data.records || [];

                // Update summary cards
                let totalBasic = 0, totalCommission = 0, totalGross = 0;
                payrollRecords.forEach(r => {
                    totalBasic += r.basic_pay || 0;
                    totalCommission += r.commission_amount || 0;
                    totalGross += r.gross_pay || 0;
                });

                document.getElementById('payrollTotalBasic').textContent = formatCurrencyZAR(totalBasic);
                document.getElementById('payrollTotalCommission').textContent = formatCurrencyZAR(totalCommission);
                document.getElementById('payrollTotalGross').textContent = formatCurrencyZAR(totalGross);
                document.getElementById('payrollStylistCount').textContent = payrollRecords.length;

                if (countEl) {
                    countEl.textContent = `${payrollRecords.length} record${payrollRecords.length !== 1 ? 's' : ''}`;
                }

                if (!tbody) return;

                if (payrollRecords.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: var(--gray-medium);">No payroll records for this period. Click "Generate Payroll" to calculate.</td></tr>';
                    return;
                }

                tbody.innerHTML = payrollRecords.map(r => {
                    const statusClass = r.status === 'paid' ? 'status-confirmed' :
                                       r.status === 'finalized' ? 'status-pending' : 'status-draft';
                    const statusLabel = r.status.charAt(0).toUpperCase() + r.status.slice(1);

                    const actions = [];
                    if (r.status !== 'paid') {
                        actions.push(`<button class="btn btn-sm btn-outline" onclick="recalculatePayroll('${r.id}')" title="Recalculate">🔄</button>`);
                    }
                    if (r.status === 'draft') {
                        actions.push(`<button class="btn btn-sm" onclick="finalizePayroll('${r.id}')">Finalize</button>`);
                    }
                    if (r.status === 'finalized') {
                        actions.push(`<button class="btn btn-sm btn-primary" onclick="markPayrollPaid('${r.id}')">Mark Paid</button>`);
                    }
                    if (r.status !== 'paid') {
                        actions.push(`<button class="btn btn-sm btn-outline" onclick="deletePayroll('${r.id}')" style="color: var(--danger);" title="Delete">🗑️</button>`);
                    }

                    return `
                        <tr>
                            <td><strong>${r.stylistName || 'Unknown'}</strong></td>
                            <td>${formatCurrencyZAR(r.basic_pay)}</td>
                            <td>${((r.commission_rate || 0) * 100).toFixed(0)}%</td>
                            <td>${r.total_bookings || 0}</td>
                            <td>${formatCurrencyZAR(r.total_service_revenue_ex_vat)}</td>
                            <td>${formatCurrencyZAR(r.commission_amount)}</td>
                            <td><strong>${formatCurrencyZAR(r.gross_pay)}</strong></td>
                            <td><span class="status-badge ${statusClass}">${statusLabel}</span></td>
                            <td class="action-btns" style="gap: 4px;">${actions.join(' ')}</td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading payroll:', error);
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px; color: var(--danger);">Error loading payroll data</td></tr>';
                }
            }
        }

        async function loadStylistPaySettings() {
            const tbody = document.getElementById('stylistPaySettingsBody');
            if (!tbody) return;

            try {
                const data = await apiCall('/stylists');
                stylistsPayData = data.stylists || [];

                if (stylistsPayData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px; color: var(--gray-medium);">No stylists found</td></tr>';
                    return;
                }

                tbody.innerHTML = stylistsPayData.map(s => `
                    <tr>
                        <td><strong>${s.name}</strong></td>
                        <td>${formatCurrencyZAR(s.basic_monthly_pay || 0)}</td>
                        <td class="action-btns">
                            <button class="btn btn-sm btn-outline" onclick="openStylistPayModal('${s.id}')">Edit</button>
                        </td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error('Error loading stylist pay settings:', error);
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px; color: var(--danger);">Error loading data</td></tr>';
            }
        }

        function openStylistPayModal(stylistId) {
            const stylist = stylistsPayData.find(s => s.id === stylistId);
            if (!stylist) return;

            document.getElementById('stylistPayId').value = stylistId;
            document.getElementById('stylistPayName').value = stylist.name;
            document.getElementById('stylistPayNameHeader').textContent = stylist.name;
            document.getElementById('stylistBasicPay').value = stylist.basic_monthly_pay || 0;

            document.getElementById('stylistPayModal').classList.add('show');
        }

        async function saveStylistPay() {
            const stylistId = document.getElementById('stylistPayId').value;
            const basicMonthlyPay = parseFloat(document.getElementById('stylistBasicPay').value) || 0;

            try {
                await apiCall(`/admin/stylists/${stylistId}/pay`, {
                    method: 'PATCH',
                    body: JSON.stringify({ basicMonthlyPay })
                });

                closeModal('stylistPayModal');
                await loadStylistPaySettings();
                showToast('Salary updated successfully', 'success');
            } catch (error) {
                console.error('Error saving stylist pay:', error);
                showToast('Failed to save salary', 'error');
            }
        }

        async function generatePayroll() {
            const year = parseInt(document.getElementById('payrollYear')?.value);
            const month = parseInt(document.getElementById('payrollMonth')?.value);

            if (!year || !month) {
                showToast('Please select year and month', 'error');
                return;
            }

            const monthName = document.getElementById('payrollMonth')?.options[month - 1]?.text || month;
            const proceed = await openConfirmDialog({
                title: 'Generate Payroll?',
                message: `This will calculate payroll for all stylists for ${monthName} ${year}. Existing draft records will be updated.`,
                confirmText: 'Generate',
                tone: 'neutral'
            });

            if (!proceed) return;

            try {
                const data = await apiCall('/admin/payroll/generate', {
                    method: 'POST',
                    body: JSON.stringify({ year, month })
                });

                const successCount = data.results?.filter(r => r.success).length || 0;
                showToast(`Generated payroll for ${successCount} stylists`, 'success');
                await loadPayroll();
            } catch (error) {
                console.error('Error generating payroll:', error);
                showToast('Failed to generate payroll', 'error');
            }
        }

        async function recalculatePayroll(recordId) {
            try {
                await apiCall(`/admin/payroll/${recordId}/recalculate`, { method: 'POST' });
                showToast('Payroll recalculated', 'success');
                await loadPayroll();
            } catch (error) {
                console.error('Error recalculating payroll:', error);
                showToast(error.message || 'Failed to recalculate', 'error');
            }
        }

        async function finalizePayroll(recordId) {
            const proceed = await openConfirmDialog({
                title: 'Finalize Payroll?',
                message: 'This will mark the payroll as finalized. You can still recalculate it until marked as paid.',
                confirmText: 'Finalize',
                tone: 'neutral'
            });

            if (!proceed) return;

            try {
                await apiCall(`/admin/payroll/${recordId}/finalize`, { method: 'POST' });
                showToast('Payroll finalized', 'success');
                await loadPayroll();
            } catch (error) {
                console.error('Error finalizing payroll:', error);
                showToast(error.message || 'Failed to finalize', 'error');
            }
        }

        async function markPayrollPaid(recordId) {
            const proceed = await openConfirmDialog({
                title: 'Mark as Paid?',
                message: 'This will lock the payroll record. It cannot be modified after this.',
                confirmText: 'Mark Paid',
                tone: 'neutral'
            });

            if (!proceed) return;

            try {
                await apiCall(`/admin/payroll/${recordId}/pay`, { method: 'POST' });
                showToast('Payroll marked as paid', 'success');
                await loadPayroll();
            } catch (error) {
                console.error('Error marking payroll as paid:', error);
                showToast(error.message || 'Failed to mark as paid', 'error');
            }
        }

        async function deletePayroll(recordId) {
            const proceed = await openConfirmDialog({
                title: 'Delete Payroll Record?',
                message: 'This action cannot be undone.',
                confirmText: 'Delete',
                tone: 'danger'
            });

            if (!proceed) return;

            try {
                await apiCall(`/admin/payroll/${recordId}`, { method: 'DELETE' });
                showToast('Payroll record deleted', 'success');
                await loadPayroll();
            } catch (error) {
                console.error('Error deleting payroll:', error);
                showToast(error.message || 'Failed to delete', 'error');
            }
        }

        function exportPayrollCSV() {
            const year = document.getElementById('payrollYear')?.value;
            const month = document.getElementById('payrollMonth')?.value;

            let url = `${API_BASE}/admin/payroll/export/csv`;
            const params = new URLSearchParams();
            if (year) params.append('year', year);
            if (month) params.append('month', month);
            if (params.toString()) url += `?${params.toString()}`;

            // Add auth token
            const token = localStorage.getItem('flirtAdminToken');
            if (token) {
                url += (url.includes('?') ? '&' : '?') + `token=${token}`;
            }

            window.open(url, '_blank');
        }

        // ========== ORDERS MANAGEMENT ==========
        async function loadOrders() {
            initOrderFilters();
            const container = document.getElementById('ordersTableBody');
            const countText = document.getElementById('orderCountText');

            const status = document.getElementById('orderStatusFilter')?.value || '';
            const deliveryMethod = document.getElementById('orderDeliveryFilter')?.value || '';
            const date = document.getElementById('orderDateFilter')?.value || '';

            const params = new URLSearchParams();
            if (status) params.append('status', status);
            if (deliveryMethod) params.append('deliveryMethod', deliveryMethod);
            if (date) params.append('date', date);

            if (container) {
                container.innerHTML = `<tr><td colspan="7" style="text-align: center; color: var(--gray-medium); padding: 16px;">Loading orders.....</td></tr>`;
            }

            try {
                const data = await apiCall(`/admin/orders${params.toString() ? `?${params.toString()}` : ''}`);
                const orders = data.orders || [];

                if (countText) {
                    countText.textContent = orders.length
                        ? `${orders.length} order${orders.length === 1 ? '' : 's'}`
                        : 'No orders found';
                }

                if (!container) return;

                if (!orders.length) {
                    container.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 20px; color: var(--gray-medium);">No orders found for these filters.</td></tr>`;
                    return;
                }

                container.innerHTML = orders.map(o => {
                    const statusKey = String(o.status || 'pending').toLowerCase();
                    const statusLabel = formatOrderStatusLabel(statusKey);
                    const statusClass = formatOrderStatusClass(statusKey);
                    const itemCount = Array.isArray(o.items)
                        ? o.items.reduce((sum, item) => sum + (item.quantity || 0), 0)
                        : 0;
                    const total = formatCurrencyZAR(o.total || 0);
                    const delivery = formatDeliveryLabel(o.deliveryMethod || o.delivery_method || 'pickup');
                    const createdAt = formatDateDisplay(o.createdAt || o.created_at);
                    const idShort = o.id ? `#${o.id.substring(0, 8)}` : '—';

                    const actions = [];
                    if (statusKey !== 'processing' && statusKey !== 'cancelled' && statusKey !== 'delivered') {
                        actions.push(`<button class="btn btn-sm" onclick="updateOrderStatus('${o.id}', 'processing')">Process</button>`);
                    }
                    if (statusKey !== 'shipped' && statusKey !== 'cancelled' && statusKey !== 'delivered') {
                        actions.push(`<button class="btn btn-sm" onclick="updateOrderStatus('${o.id}', 'shipped')">Ship</button>`);
                    }
                    if (statusKey !== 'delivered') {
                        actions.push(`<button class="btn btn-sm btn-outline" onclick="updateOrderStatus('${o.id}', 'delivered')">Mark Delivered</button>`);
                    }
                    if (statusKey !== 'cancelled' && statusKey !== 'delivered') {
                        actions.push(`<button class="btn btn-sm btn-outline" style="color: var(--danger);" onclick="updateOrderStatus('${o.id}', 'cancelled')">Cancel</button>`);
                    }

                    return `
                        <tr>
                            <td title="${o.id || ''}">${idShort}</td>
                            <td>
                                <div style="font-weight: 600;">${o.customerName || o.customer_name || 'Guest'}</div>
                                ${o.customerEmail ? `<div style="color: var(--gray-medium); font-size: 12px;">${o.customerEmail}</div>` : ''}
                            </td>
                            <td>${itemCount || (Array.isArray(o.items) ? o.items.length : 0)} items</td>
                            <td>${total}</td>
                            <td>${delivery}${createdAt ? `<div style="color: var(--gray-medium); font-size: 12px;">${createdAt}</div>` : ''}</td>
                            <td><span class="status-badge ${statusClass}">${statusLabel}</span></td>
                            <td class="action-btns" style="gap: 6px;">${actions.join(' ') || '<span style="color: var(--gray-medium); font-size: 12px;">No actions</span>'}</td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.log('Orders load error:', error);
                if (container) {
                    container.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 20px; color: var(--danger);">Error Loading orders... Please try again.</td></tr>`;
                }
                if (countText) {
                    countText.textContent = 'Error loading orders';
                }
            }
        }

        async function updateOrderStatus(id, status) {
            const statusLabel = formatOrderStatusLabel(status);
            const proceed = await openConfirmDialog({
                title: 'Update order status?',
                message: `Change this order to ${statusLabel}?`,
                confirmText: 'Update',
                tone: status === 'cancelled' ? 'danger' : 'neutral'
            });
            if (!proceed) return;

            try {
                await apiCall(`/admin/orders/${id}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ status })
                });
                showAdminToast(`Order updated to ${statusLabel}`, 'success');
                loadOrders();
            } catch (error) {
                showAdminToast('Error updating order: ' + (error.message || ''), 'error');
            }
        }

        // ============================================
        // PROMOTIONS
        // ============================================
        async function loadPromos() {
            try {
                const data = await apiCall('/admin/promos');
                const promos = data.promos || [];

                // Calculate stats
                const activeCount = promos.filter(p => p.active).length;
                const totalUsed = promos.reduce((sum, p) => sum + (p.times_used || 0), 0);

                // Calculate total discounts given (this is an estimate based on orders table)
                // For now, we'll fetch from orders API
                let totalDiscounts = 0;
                try {
                    const ordersData = await apiCall('/admin/orders');
                    totalDiscounts = (ordersData.orders || []).reduce((sum, o) => sum + (o.discount || 0), 0);
                } catch (e) {
                    console.log('Could not fetch orders for discount calculation');
                }

                // Update stat cards
                document.getElementById('promoActiveCount').textContent = activeCount;
                document.getElementById('promoCodesUsed').textContent = totalUsed;
                document.getElementById('promoDiscountsGiven').textContent = 'R' + totalDiscounts.toLocaleString();

                // Update table
                const container = document.querySelector('#promotions .data-table tbody');
                if (container) {
                    if (promos.length > 0) {
                        container.innerHTML = promos.map(p => `
                            <tr>
                                <td><code style="background: var(--gray-light); padding: 4px 8px; border-radius: 4px;">${p.code}</code></td>
                                <td>
                                    <div style="font-weight: 500;">${p.title || p.description || '-'}</div>
                                    ${p.title && p.description ? `<div style="font-size: 12px; color: var(--gray-medium);">${p.description}</div>` : ''}
                                </td>
                                <td>${p.discount_type === 'percentage' ? p.discount_value + '%' : 'R' + p.discount_value}</td>
                                <td>${p.min_order ? 'R' + p.min_order : '-'}</td>
                                <td>${p.times_used || 0}${p.usage_limit ? '/' + p.usage_limit : ''}</td>
                                <td>
                                    ${p.highlighted
                                        ? `<span class="status-badge" style="background: var(--brand-pink); color: white;" title="${p.badge || 'SPECIAL'}: ${p.subtitle || ''}">Yes</span>`
                                        : '<span class="status-badge" style="background: var(--gray-light);">No</span>'
                                    }
                                </td>
                                <td><span class="status-badge status-${p.active ? 'confirmed' : 'cancelled'}">${p.active ? 'Active' : 'Inactive'}</span></td>
                                <td class="action-btns" style="display: flex; gap: 4px;">
                                    <button class="btn btn-sm" onclick="togglePromo('${p.id}', ${!p.active})">${p.active ? 'Disable' : 'Enable'}</button>
                                    <button class="btn btn-sm btn-outline" onclick="toggleHighlighted('${p.id}', ${!p.highlighted})" title="${p.highlighted ? 'Remove from' : 'Add to'} Special Offers">
                                        ${p.highlighted ? '⭐' : '☆'}
                                    </button>
                                    <button class="btn btn-sm btn-outline" onclick="editPromo('${p.id}')" title="Edit">✏️</button>
                                </td>
                            </tr>
                        `).join('');
                    } else {
                        container.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: var(--gray-medium);">No promotions found. Create your first promotion!</td></tr>';
                    }
                }
            } catch (error) {
                console.log('Promos load error:', error);
            }
        }

        // Setup toggle for Special Offer fields visibility
        document.addEventListener('DOMContentLoaded', () => {
            const highlightedCheckbox = document.getElementById('promoHighlighted');
            const specialOfferFields = document.getElementById('specialOfferFields');
            if (highlightedCheckbox && specialOfferFields) {
                highlightedCheckbox.addEventListener('change', () => {
                    specialOfferFields.style.display = highlightedCheckbox.checked ? 'block' : 'none';
                });
            }
        });

        function clearPromoForm() {
            const fields = ['promoCode', 'promoDescription', 'promoValue', 'promoMinOrder', 'promoUsageLimit', 'promoExpiresAt', 'promoTitle', 'promoBadge', 'promoSubtitle', 'promoPriority'];
            fields.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            const typeSelect = document.getElementById('promoType');
            if (typeSelect) typeSelect.value = 'percentage';
            const highlightedCheckbox = document.getElementById('promoHighlighted');
            if (highlightedCheckbox) highlightedCheckbox.checked = false;
            const specialOfferFields = document.getElementById('specialOfferFields');
            if (specialOfferFields) specialOfferFields.style.display = 'none';
        }

        async function savePromo() {
            const code = document.getElementById('promoCode')?.value?.trim();
            const discountType = document.getElementById('promoType')?.value;
            const discountValue = parseFloat(document.getElementById('promoValue')?.value);
            const description = document.getElementById('promoDescription')?.value?.trim() || '';
            const minOrder = parseFloat(document.getElementById('promoMinOrder')?.value) || 0;
            const usageLimit = parseInt(document.getElementById('promoUsageLimit')?.value) || null;
            const expiresAt = document.getElementById('promoExpiresAt')?.value ? new Date(document.getElementById('promoExpiresAt').value).toISOString() : null;

            // Special Offer fields
            const highlighted = document.getElementById('promoHighlighted')?.checked || false;
            const title = document.getElementById('promoTitle')?.value?.trim() || '';
            const badge = document.getElementById('promoBadge')?.value?.trim().toUpperCase() || '';
            const subtitle = document.getElementById('promoSubtitle')?.value?.trim() || '';
            const priority = parseInt(document.getElementById('promoPriority')?.value) || 0;

            // Shop Banner field
            const showInShopBanner = document.getElementById('promoShowInShopBanner')?.checked || false;

            if (!code || !discountType || !discountValue) {
                alert('Code, type, and value are required');
                return;
            }

            try {
                await apiCall('/admin/promos', {
                    method: 'POST',
                    body: JSON.stringify({
                        code, discountType, discountValue, description, minOrder, usageLimit, expiresAt,
                        highlighted, title, badge, subtitle, priority, showInShopBanner
                    })
                });
                alert('Promo created!');
                closeModal('addPromoModal');
                clearPromoForm();
                loadPromos();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function togglePromo(id, active) {
            try {
                await apiCall(`/admin/promos/${id}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ active })
                });
                loadPromos();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function toggleHighlighted(id, highlighted) {
            try {
                await apiCall(`/admin/promos/${id}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ highlighted })
                });
                loadPromos();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Placeholder for edit functionality - opens modal with promo data
        async function editPromo(id) {
            try {
                const data = await apiCall('/admin/promos');
                const promo = data.promos.find(p => p.id === id);
                if (!promo) {
                    alert('Promo not found');
                    return;
                }

                // Populate form
                document.getElementById('promoCode').value = promo.code;
                document.getElementById('promoDescription').value = promo.description || '';
                document.getElementById('promoType').value = promo.discountType;
                document.getElementById('promoValue').value = promo.discountValue;
                document.getElementById('promoMinOrder').value = promo.minOrder || '';
                document.getElementById('promoUsageLimit').value = promo.usageLimit || '';
                if (promo.expiresAt) {
                    const dt = new Date(promo.expiresAt);
                    document.getElementById('promoExpiresAt').value = dt.toISOString().slice(0, 16);
                }
                document.getElementById('promoHighlighted').checked = promo.highlighted || false;
                document.getElementById('promoTitle').value = promo.title || '';
                document.getElementById('promoBadge').value = promo.badge || '';
                document.getElementById('promoSubtitle').value = promo.subtitle || '';
                document.getElementById('promoPriority').value = promo.priority || '';
                document.getElementById('promoShowInShopBanner').checked = promo.show_in_shop_banner || false;

                // Show/hide special offer fields
                document.getElementById('specialOfferFields').style.display = promo.highlighted ? 'block' : 'none';

                // Change modal title and button
                document.querySelector('#addPromoModal .modal-title').textContent = 'Edit Promotion';
                const saveBtn = document.querySelector('#addPromoModal .btn-primary');
                saveBtn.textContent = 'Update Promotion';
                saveBtn.onclick = () => updatePromo(id);

                openModal('addPromoModal');
            } catch (error) {
                alert('Error loading promo: ' + error.message);
            }
        }

        async function updatePromo(id) {
            const discountType = document.getElementById('promoType')?.value;
            const discountValue = parseFloat(document.getElementById('promoValue')?.value);
            const description = document.getElementById('promoDescription')?.value?.trim() || '';
            const minOrder = parseFloat(document.getElementById('promoMinOrder')?.value) || 0;
            const usageLimit = parseInt(document.getElementById('promoUsageLimit')?.value) || null;
            const expiresAt = document.getElementById('promoExpiresAt')?.value ? new Date(document.getElementById('promoExpiresAt').value).toISOString() : null;

            // Special Offer fields
            const highlighted = document.getElementById('promoHighlighted')?.checked || false;
            const title = document.getElementById('promoTitle')?.value?.trim() || '';
            const badge = document.getElementById('promoBadge')?.value?.trim().toUpperCase() || '';
            const subtitle = document.getElementById('promoSubtitle')?.value?.trim() || '';
            const priority = parseInt(document.getElementById('promoPriority')?.value) || 0;

            // Shop Banner field
            const showInShopBanner = document.getElementById('promoShowInShopBanner')?.checked || false;

            try {
                await apiCall(`/admin/promos/${id}`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        discountType, discountValue, description, minOrder, usageLimit, expiresAt,
                        highlighted, title, badge, subtitle, priority, showInShopBanner
                    })
                });
                alert('Promo updated!');
                closeModal('addPromoModal');

                // Reset modal for create mode
                document.querySelector('#addPromoModal .modal-title').textContent = 'Create Promotion';
                const saveBtn = document.querySelector('#addPromoModal .btn-primary');
                saveBtn.textContent = 'Create Promotion';
                saveBtn.onclick = savePromo;
                clearPromoForm();

                loadPromos();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // ============================================
        // LOYALTY SETTINGS
        // ============================================
        let currentLoyaltyConfig = null;

        async function loadLoyaltySettings() {
            try {
                const data = await apiCall('/admin/loyalty');
                currentLoyaltyConfig = data;

                // Populate points rules
                document.getElementById('loyaltyBookingPoints').value = data.pointsRules.bookingPoints || 50;
                document.getElementById('loyaltySpendRand').value = data.pointsRules.spendRand || 10;
                document.getElementById('loyaltyReviewPoints').value = data.pointsRules.reviewPoints || 25;
                document.getElementById('loyaltyReferralPoints').value = data.pointsRules.referralPoints || 100;

                // Populate tier thresholds
                document.getElementById('loyaltyTierBronze').value = 0;
                document.getElementById('loyaltyTierSilver').value = data.tierThresholds.silver || 500;
                document.getElementById('loyaltyTierGold').value = data.tierThresholds.gold || 1500;
                document.getElementById('loyaltyTierPlatinum').value = data.tierThresholds.platinum || 5000;

                // Populate referral settings
                if (data.referral) {
                    document.getElementById('referralEnabled').checked = data.referral.enabled !== false;
                    document.getElementById('referralDiscountType').value = data.referral.discountType || 'percent';
                    document.getElementById('referralDiscountValue').value = data.referral.discountValue || 10;
                    document.getElementById('referralHeadline').value = data.referral.headline || '';
                    document.getElementById('referralSubheading').value = data.referral.subheading || '';
                    document.getElementById('referralShareMessage').value = data.referral.shareMessageTemplate || '';
                }

                // Populate earn rules editor
                renderEarnRulesEditor(data.earnRulesDisplay || [], data.pointsRules);

                // Update preview
                updateTierPreview();

                // Hide any previous messages
                document.getElementById('loyaltyErrors').style.display = 'none';
                document.getElementById('loyaltySuccess').style.display = 'none';

                // Add live preview listeners
                addLoyaltyPreviewListeners();

            } catch (error) {
                console.error('Error loading loyalty settings:', error);
                alert('Failed to load loyalty settings: ' + error.message);
            }
        }

        // Render the earn rules editor
        function renderEarnRulesEditor(rules, pointsRules) {
            const container = document.getElementById('earnRulesEditor');
            if (!container) return;

            const pointsKeys = Object.keys(pointsRules || {});

            container.innerHTML = rules.map((rule, index) => {
                const isSpend = rule.isSpendRule;
                const pointsValue = pointsRules[rule.pointsKey] || 0;
                const pointsDisplay = isSpend ? `+1 pt / R${pointsValue}` : `+${pointsValue} pts`;

                return `
                    <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 12px; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                        <div style="flex: 2;">
                            <input type="text" class="form-input earn-rule-label" data-index="${index}" value="${rule.label}" placeholder="Label">
                        </div>
                        <div style="flex: 1;">
                            <select class="form-input earn-rule-key" data-index="${index}">
                                ${pointsKeys.map(key => `<option value="${key}" ${key === rule.pointsKey ? 'selected' : ''}>${key}</option>`).join('')}
                            </select>
                        </div>
                        <div style="width: 100px; text-align: center;">
                            <span style="font-weight: 600; color: var(--primary);">${pointsDisplay}</span>
                        </div>
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 12px;">
                            <input type="checkbox" class="earn-rule-spend" data-index="${index}" ${isSpend ? 'checked' : ''}>
                            Spend rule
                        </label>
                    </div>
                `;
            }).join('');
        }

        function addLoyaltyPreviewListeners() {
            const tierInputs = ['loyaltyTierSilver', 'loyaltyTierGold', 'loyaltyTierPlatinum'];
            tierInputs.forEach(id => {
                const input = document.getElementById(id);
                input.removeEventListener('input', updateTierPreview);
                input.addEventListener('input', updateTierPreview);
            });
        }

        function updateTierPreview() {
            const silver = parseInt(document.getElementById('loyaltyTierSilver').value) || 500;
            const gold = parseInt(document.getElementById('loyaltyTierGold').value) || 1500;
            const platinum = parseInt(document.getElementById('loyaltyTierPlatinum').value) || 5000;

            // Update preview values
            document.getElementById('previewBronzeMax').textContent = (silver - 1).toLocaleString();
            document.getElementById('previewSilverMin').textContent = silver.toLocaleString();
            document.getElementById('previewSilverMax').textContent = (gold - 1).toLocaleString();
            document.getElementById('previewGoldMin').textContent = gold.toLocaleString();
            document.getElementById('previewGoldMax').textContent = (platinum - 1).toLocaleString();
            document.getElementById('previewPlatinumMin').textContent = platinum.toLocaleString();
        }

        function validateLoyaltySettings() {
            const errors = [];

            const bookingPoints = parseInt(document.getElementById('loyaltyBookingPoints').value);
            const spendRand = parseInt(document.getElementById('loyaltySpendRand').value);
            const reviewPoints = parseInt(document.getElementById('loyaltyReviewPoints').value);
            const referralPoints = parseInt(document.getElementById('loyaltyReferralPoints').value);
            const silver = parseInt(document.getElementById('loyaltyTierSilver').value);
            const gold = parseInt(document.getElementById('loyaltyTierGold').value);
            const platinum = parseInt(document.getElementById('loyaltyTierPlatinum').value);

            // Validate points rules
            if (isNaN(bookingPoints) || bookingPoints < 0) {
                errors.push('Booking points must be a positive number');
            }
            if (isNaN(spendRand) || spendRand < 1) {
                errors.push('Rands per point must be at least R1');
            }
            if (isNaN(reviewPoints) || reviewPoints < 0) {
                errors.push('Review points must be a positive number');
            }
            if (isNaN(referralPoints) || referralPoints < 0) {
                errors.push('Referral points must be a positive number');
            }

            // Validate tier thresholds
            if (isNaN(silver) || silver < 1) {
                errors.push('Silver threshold must be at least 1');
            }
            if (isNaN(gold) || gold < 1) {
                errors.push('Gold threshold must be at least 1');
            }
            if (isNaN(platinum) || platinum < 1) {
                errors.push('Platinum threshold must be at least 1');
            }
            if (silver >= gold) {
                errors.push('Gold threshold must be greater than Silver');
            }
            if (gold >= platinum) {
                errors.push('Platinum threshold must be greater than Gold');
            }

            return errors;
        }

        async function saveLoyaltySettings() {
            // Hide previous messages
            document.getElementById('loyaltyErrors').style.display = 'none';
            document.getElementById('loyaltySuccess').style.display = 'none';

            // Validate
            const errors = validateLoyaltySettings();
            if (errors.length > 0) {
                const errorList = document.getElementById('loyaltyErrorList');
                errorList.innerHTML = errors.map(e => `<li>${e}</li>`).join('');
                document.getElementById('loyaltyErrors').style.display = 'block';
                return;
            }

            // Collect earn rules from editor
            const earnRulesDisplay = [];
            document.querySelectorAll('.earn-rule-label').forEach((input, index) => {
                const label = input.value.trim();
                const keySelect = document.querySelector(`.earn-rule-key[data-index="${index}"]`);
                const spendCheck = document.querySelector(`.earn-rule-spend[data-index="${index}"]`);

                if (label && keySelect) {
                    earnRulesDisplay.push({
                        id: currentLoyaltyConfig?.earnRulesDisplay?.[index]?.id || `rule_${index}`,
                        label: label,
                        pointsKey: keySelect.value,
                        isSpendRule: spendCheck?.checked || false
                    });
                }
            });

            // Build config object
            const config = {
                pointsRules: {
                    bookingPoints: parseInt(document.getElementById('loyaltyBookingPoints').value),
                    spendRand: parseInt(document.getElementById('loyaltySpendRand').value),
                    reviewPoints: parseInt(document.getElementById('loyaltyReviewPoints').value),
                    referralPoints: parseInt(document.getElementById('loyaltyReferralPoints').value),
                    socialSharePoints: currentLoyaltyConfig?.pointsRules?.socialSharePoints || 10
                },
                tierThresholds: {
                    bronze: 0,
                    silver: parseInt(document.getElementById('loyaltyTierSilver').value),
                    gold: parseInt(document.getElementById('loyaltyTierGold').value),
                    platinum: parseInt(document.getElementById('loyaltyTierPlatinum').value)
                },
                referral: {
                    enabled: document.getElementById('referralEnabled').checked,
                    discountType: document.getElementById('referralDiscountType').value,
                    discountValue: parseInt(document.getElementById('referralDiscountValue').value) || 10,
                    headline: document.getElementById('referralHeadline').value.trim(),
                    subheading: document.getElementById('referralSubheading').value.trim(),
                    shareMessageTemplate: document.getElementById('referralShareMessage').value.trim()
                },
                earnRulesDisplay: earnRulesDisplay
            };

            try {
                const result = await apiCall('/admin/loyalty', {
                    method: 'PUT',
                    body: JSON.stringify(config)
                });

                if (result.success) {
                    currentLoyaltyConfig = result;
                    document.getElementById('loyaltySuccess').style.display = 'block';

                    // Show warnings if any
                    if (result.warnings && result.warnings.length > 0) {
                        console.warn('Loyalty settings warnings:', result.warnings);
                    }

                    setTimeout(() => {
                        document.getElementById('loyaltySuccess').style.display = 'none';
                    }, 3000);
                } else {
                    throw new Error(result.message || 'Failed to save');
                }
            } catch (error) {
                const errorList = document.getElementById('loyaltyErrorList');
                if (error.errors && Array.isArray(error.errors)) {
                    errorList.innerHTML = error.errors.map(e => `<li>${e}</li>`).join('');
                } else {
                    errorList.innerHTML = `<li>${error.message || 'Failed to save settings'}</li>`;
                }
                document.getElementById('loyaltyErrors').style.display = 'block';
            }
        }

        async function resetLoyaltySettings() {
            const proceed = await openConfirmDialog({
                title: 'Reset loyalty settings?',
                message: 'This will revert to defaults and cannot be undone.',
                confirmText: 'Reset',
                tone: 'danger'
            });
            if (!proceed) return;

            try {
                const result = await apiCall('/admin/loyalty/reset', {
                    method: 'POST'
                });

                if (result.success) {
                    // Reload settings with new values
                    loadLoyaltySettings();
                    showAdminToast('Loyalty settings reset to defaults!', 'success');
                } else {
                    throw new Error(result.message || 'Failed to reset');
                }
            } catch (error) {
                showAdminToast('Failed to reset settings: ' + (error.message || ''), 'error');
            }
        }

        // ============================================
        // REWARDS PROGRAMME SETTINGS
        // ============================================
        let rewardsConfig = null;

        async function loadRewardsSettings() {
            try {
                const result = await apiCall('/admin/rewards/config');
                if (result.success && result.config) {
                    rewardsConfig = result.config;
                    populateRewardsForm(result.config);
                }
                // Also load analytics
                loadRewardsAnalytics();
            } catch (error) {
                console.error('Error loading rewards settings:', error);
                showRewardsError('Failed to load rewards settings: ' + error.message);
            }
        }

        function populateRewardsForm(config) {
            // Programme status
            document.getElementById('rewardsProgrammeEnabled').checked = config.programme_enabled == 1;
            document.getElementById('rewardsProgrammeName').value = config.programme_name || 'Salon Rewards';

            // Nails track
            document.getElementById('rewardsNailsEnabled').checked = config.nails_enabled == 1;
            document.getElementById('rewardsNailsMilestone1Count').value = config.nails_milestone_1_count || 6;
            document.getElementById('rewardsNailsMilestone1Discount').value = config.nails_milestone_1_discount || 10;
            document.getElementById('rewardsNailsMilestone2Count').value = config.nails_milestone_2_count || 12;
            document.getElementById('rewardsNailsMilestone2Discount').value = config.nails_milestone_2_discount || 50;
            document.getElementById('rewardsNailsExpiryDays').value = config.nails_reward_expiry_days || 90;

            // Maintenance track
            document.getElementById('rewardsMaintenanceEnabled').checked = config.maintenance_enabled == 1;
            document.getElementById('rewardsMaintenanceMilestoneCount').value = config.maintenance_milestone_count || 6;
            document.getElementById('rewardsMaintenanceDiscount').value = config.maintenance_discount || 10;
            document.getElementById('rewardsMaintenanceExpiryDays').value = config.maintenance_reward_expiry_days || 90;

            // Spend track
            document.getElementById('rewardsSpendEnabled').checked = config.spend_enabled == 1;
            document.getElementById('rewardsSpendThreshold').value = config.spend_threshold || 10000;
            document.getElementById('rewardsSpendDiscount').value = config.spend_discount || 20;
            document.getElementById('rewardsSpendExpiryDays').value = config.spend_reward_expiry_days || 90;

            // Referral
            document.getElementById('rewardsReferralEnabled').checked = config.referral_enabled == 1;
            document.getElementById('rewardsReferralMinValue').value = config.referral_min_booking_value || 1000;
            document.getElementById('rewardsReferralDescription').value = config.referral_reward_description || 'Complimentary wash & blow-dry';

            // Packages
            document.getElementById('rewardsPackagesEnabled').checked = config.packages_enabled == 1;
            document.getElementById('rewardsPackageSessions').value = config.wash_blowdry_package_sessions || 4;
            document.getElementById('rewardsPackageDiscount').value = config.wash_blowdry_package_discount || 20;

            // Hide messages
            document.getElementById('rewardsErrors').style.display = 'none';
            document.getElementById('rewardsSuccess').style.display = 'none';
        }

        async function saveRewardsSettings() {
            try {
                const config = {
                    programme_enabled: document.getElementById('rewardsProgrammeEnabled').checked ? 1 : 0,
                    programme_name: document.getElementById('rewardsProgrammeName').value,

                    nails_enabled: document.getElementById('rewardsNailsEnabled').checked ? 1 : 0,
                    nails_milestone_1_count: parseInt(document.getElementById('rewardsNailsMilestone1Count').value) || 6,
                    nails_milestone_1_discount: parseFloat(document.getElementById('rewardsNailsMilestone1Discount').value) || 10,
                    nails_milestone_2_count: parseInt(document.getElementById('rewardsNailsMilestone2Count').value) || 12,
                    nails_milestone_2_discount: parseFloat(document.getElementById('rewardsNailsMilestone2Discount').value) || 50,
                    nails_reward_expiry_days: parseInt(document.getElementById('rewardsNailsExpiryDays').value) || 90,

                    maintenance_enabled: document.getElementById('rewardsMaintenanceEnabled').checked ? 1 : 0,
                    maintenance_milestone_count: parseInt(document.getElementById('rewardsMaintenanceMilestoneCount').value) || 6,
                    maintenance_discount: parseFloat(document.getElementById('rewardsMaintenanceDiscount').value) || 10,
                    maintenance_reward_expiry_days: parseInt(document.getElementById('rewardsMaintenanceExpiryDays').value) || 90,

                    spend_enabled: document.getElementById('rewardsSpendEnabled').checked ? 1 : 0,
                    spend_threshold: parseFloat(document.getElementById('rewardsSpendThreshold').value) || 10000,
                    spend_discount: parseFloat(document.getElementById('rewardsSpendDiscount').value) || 20,
                    spend_reward_expiry_days: parseInt(document.getElementById('rewardsSpendExpiryDays').value) || 90,

                    referral_enabled: document.getElementById('rewardsReferralEnabled').checked ? 1 : 0,
                    referral_min_booking_value: parseFloat(document.getElementById('rewardsReferralMinValue').value) || 1000,
                    referral_reward_description: document.getElementById('rewardsReferralDescription').value,

                    packages_enabled: document.getElementById('rewardsPackagesEnabled').checked ? 1 : 0,
                    wash_blowdry_package_sessions: parseInt(document.getElementById('rewardsPackageSessions').value) || 4,
                    wash_blowdry_package_discount: parseFloat(document.getElementById('rewardsPackageDiscount').value) || 20
                };

                const result = await apiCall('/admin/rewards/config', {
                    method: 'PUT',
                    body: JSON.stringify(config)
                });

                if (result.success) {
                    rewardsConfig = result.config;
                    showRewardsSuccess();
                    showAdminToast('Rewards settings saved successfully', 'success');
                } else {
                    showRewardsError(result.message || 'Failed to save settings');
                }
            } catch (error) {
                console.error('Error saving rewards settings:', error);
                showRewardsError('Failed to save settings: ' + error.message);
            }
        }

        async function loadRewardsAnalytics() {
            try {
                const result = await apiCall('/admin/rewards/analytics');
                if (result.success) {
                    document.getElementById('rewardsStatTotal').textContent = result.stats?.total_rewards || 0;
                    document.getElementById('rewardsStatActive').textContent = result.stats?.active_rewards || 0;
                    document.getElementById('rewardsStatRedeemed').textContent = result.stats?.redeemed_rewards || 0;
                    document.getElementById('rewardsStatUsers').textContent = result.stats?.users_with_rewards || 0;
                }
            } catch (error) {
                console.error('Error loading rewards analytics:', error);
            }
        }

        function showRewardsError(message) {
            const errorDiv = document.getElementById('rewardsErrors');
            document.getElementById('rewardsErrorMessage').textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('rewardsSuccess').style.display = 'none';
        }

        function showRewardsSuccess() {
            document.getElementById('rewardsSuccess').style.display = 'block';
            document.getElementById('rewardsErrors').style.display = 'none';
            setTimeout(() => {
                document.getElementById('rewardsSuccess').style.display = 'none';
            }, 3000);
        }

        // ============================================
        // HAIR TRACKER SETTINGS
        // ============================================
        let hairTrackerSettings = null;

        async function loadHairTrackerSettings() {
            try {
                const result = await apiCall('/admin/hair-tracker');

                if (result.success) {
                    hairTrackerSettings = result;

                    // Populate interval fields
                    document.getElementById('trackerDefaultMaintenance').value = result.defaultMaintenanceIntervalDays || 42;
                    document.getElementById('trackerWashFrequency').value = result.washFrequencyDays || 3;
                    document.getElementById('trackerDeepConditionFrequency').value = result.deepConditionFrequencyDays || 14;

                    // Populate health score fields
                    document.getElementById('trackerHealthBase').value = result.healthScore?.base || 100;
                    document.getElementById('trackerPenaltyMaintenance').value = result.healthScore?.penalties?.overMaintenanceByDay || 0.5;
                    document.getElementById('trackerPenaltyDeepCondition').value = result.healthScore?.penalties?.noDeepConditionOverDays || 0.3;
                    document.getElementById('trackerPenaltyWashes').value = result.healthScore?.penalties?.tooManyWashesPerWeek || 1.0;

                    // Populate copy fields
                    const copy = result.copy || {};
                    document.getElementById('trackerCopyTitle').value = copy.trackerTitle || '';
                    document.getElementById('trackerCopySubtitle').value = copy.trackerSubtitle || '';
                    document.getElementById('trackerCopyWash').value = copy.nextWashLabel || '';
                    document.getElementById('trackerCopyMaintenance').value = copy.maintenanceLabel || '';
                    document.getElementById('trackerCopyDeepCondition').value = copy.deepConditionLabel || '';
                    document.getElementById('trackerCopyNoInstall').value = copy.noInstallMessage || '';
                    document.getElementById('trackerCopySetupBtn').value = copy.setupButtonText || '';

                    // Render extension types editor
                    renderExtensionTypesEditor(result.extensionTypes || []);

                    // Render tips editor
                    renderTrackerTipsEditor(result.tips || []);
                }
            } catch (error) {
                console.error('Failed to load hair tracker settings:', error);
            }
        }

        function renderExtensionTypesEditor(extensionTypes) {
            const container = document.getElementById('extensionTypesEditor');
            if (!container) return;

            container.innerHTML = extensionTypes.map((et, index) => `
                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;" data-ext-index="${index}">
                    <input type="text" class="form-input ext-id" value="${et.id || ''}" placeholder="ID (e.g. tapes)" style="flex: 1;">
                    <input type="text" class="form-input ext-label" value="${et.label || ''}" placeholder="Label (e.g. Tape Extensions)" style="flex: 2;">
                    <input type="number" class="form-input ext-days" value="${et.maintenanceDays || 0}" placeholder="Days" min="0" style="width: 100px;">
                    <button class="btn btn-outline" onclick="removeExtensionType(${index})" style="padding: 8px 12px;">×</button>
                </div>
            `).join('');

            // Add button to add new extension type
            container.innerHTML += `
                <button class="btn btn-outline" onclick="addExtensionType()" style="margin-top: 10px;">
                    + Add Extension Type
                </button>
            `;
        }

        function addExtensionType() {
            const currentTypes = collectExtensionTypes();
            currentTypes.push({ id: '', label: '', maintenanceDays: 42 });
            renderExtensionTypesEditor(currentTypes);
        }

        function removeExtensionType(index) {
            const currentTypes = collectExtensionTypes();
            currentTypes.splice(index, 1);
            renderExtensionTypesEditor(currentTypes);
        }

        function collectExtensionTypes() {
            const container = document.getElementById('extensionTypesEditor');
            const rows = container.querySelectorAll('[data-ext-index]');
            return Array.from(rows).map(row => ({
                id: row.querySelector('.ext-id').value.trim(),
                label: row.querySelector('.ext-label').value.trim(),
                maintenanceDays: parseInt(row.querySelector('.ext-days').value) || 0
            })).filter(et => et.id && et.label);
        }

        function renderTrackerTipsEditor(tips) {
            const container = document.getElementById('trackerTipsEditor');
            if (!container) return;

            container.innerHTML = tips.map((tip, index) => `
                <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;" data-tip-index="${index}">
                    <input type="text" class="form-input tip-text" value="${tip}" placeholder="Enter care tip..." style="flex: 1;">
                    <button class="btn btn-outline" onclick="removeTrackerTip(${index})" style="padding: 8px 12px;">×</button>
                </div>
            `).join('');
        }

        function addTrackerTip() {
            const currentTips = collectTrackerTips();
            currentTips.push('');
            renderTrackerTipsEditor(currentTips);
        }

        function removeTrackerTip(index) {
            const currentTips = collectTrackerTips();
            currentTips.splice(index, 1);
            renderTrackerTipsEditor(currentTips);
        }

        function collectTrackerTips() {
            const container = document.getElementById('trackerTipsEditor');
            const rows = container.querySelectorAll('[data-tip-index]');
            return Array.from(rows)
                .map(row => row.querySelector('.tip-text').value.trim())
                .filter(tip => tip);
        }

        async function saveHairTrackerSettings() {
            // Hide previous messages
            document.getElementById('trackerSettingsError').style.display = 'none';
            document.getElementById('trackerSettingsSuccess').style.display = 'none';

            try {
                const settings = {
                    defaultMaintenanceIntervalDays: parseInt(document.getElementById('trackerDefaultMaintenance').value) || 42,
                    washFrequencyDays: parseInt(document.getElementById('trackerWashFrequency').value) || 3,
                    deepConditionFrequencyDays: parseInt(document.getElementById('trackerDeepConditionFrequency').value) || 14,
                    extensionTypes: collectExtensionTypes(),
                    healthScore: {
                        base: parseInt(document.getElementById('trackerHealthBase').value) || 100,
                        penalties: {
                            overMaintenanceByDay: parseFloat(document.getElementById('trackerPenaltyMaintenance').value) || 0.5,
                            noDeepConditionOverDays: parseFloat(document.getElementById('trackerPenaltyDeepCondition').value) || 0.3,
                            tooManyWashesPerWeek: parseFloat(document.getElementById('trackerPenaltyWashes').value) || 1.0
                        }
                    },
                    copy: {
                        trackerTitle: document.getElementById('trackerCopyTitle').value.trim() || 'Hair Care Journey',
                        trackerSubtitle: document.getElementById('trackerCopySubtitle').value.trim() || 'Keep your extensions healthy and on track',
                        nextWashLabel: document.getElementById('trackerCopyWash').value.trim() || 'Next Wash Day',
                        maintenanceLabel: document.getElementById('trackerCopyMaintenance').value.trim() || 'Maintenance Due',
                        deepConditionLabel: document.getElementById('trackerCopyDeepCondition').value.trim() || 'Deep Condition',
                        noInstallMessage: document.getElementById('trackerCopyNoInstall').value.trim() || 'Set up your hair tracker to get personalized care recommendations!',
                        setupButtonText: document.getElementById('trackerCopySetupBtn').value.trim() || 'Set Up Tracker'
                    },
                    tips: collectTrackerTips()
                };

                const result = await apiCall('/admin/hair-tracker', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });

                if (result.success) {
                    document.getElementById('trackerSettingsSuccess').style.display = 'block';
                    setTimeout(() => {
                        document.getElementById('trackerSettingsSuccess').style.display = 'none';
                    }, 3000);
                } else {
                    throw new Error(result.message || 'Failed to save settings');
                }
            } catch (error) {
                document.getElementById('trackerSettingsErrorText').textContent = error.message || 'Failed to save settings';
                document.getElementById('trackerSettingsError').style.display = 'block';
            }
        }

        async function resetHairTrackerSettings() {
            const proceed = await openConfirmDialog({
                title: 'Reset hair tracker?',
                message: 'This will revert to defaults and cannot be undone.',
                confirmText: 'Reset',
                tone: 'danger'
            });
            if (!proceed) return;

            try {
                const result = await apiCall('/admin/hair-tracker/reset', {
                    method: 'POST'
                });

                if (result.success) {
                    loadHairTrackerSettings();
                    showAdminToast('Hair tracker settings reset to defaults!', 'success');
                } else {
                    throw new Error(result.message || 'Failed to reset');
                }
            } catch (error) {
                showAdminToast('Failed to reset settings: ' + (error.message || ''), 'error');
            }
        }

        // ============================================
        // MODALS
        // ============================================
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('show');
                modal.style.display = 'flex';  // Override inline style
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('show');
                modal.style.display = 'none';  // Reset inline style
            }
        }

        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('show');
                    this.style.display = 'none';
                }
            });
        });

        // Reusable confirm dialog
        let confirmResolver = null;
        function openConfirmDialog({ title = 'Please confirm', message = '', confirmText = 'Confirm', cancelText = 'Cancel', tone = 'neutral' } = {}) {
            return new Promise(resolve => {
                confirmResolver = resolve;
                document.getElementById('confirmTitle').textContent = title;
                document.getElementById('confirmMessage').textContent = message;
                document.getElementById('confirmConfirmBtn').textContent = confirmText;
                document.getElementById('confirmCancelBtn').textContent = cancelText;
                const confirmBtn = document.getElementById('confirmConfirmBtn');
                if (tone === 'danger') {
                    confirmBtn.style.background = 'var(--danger)';
                } else {
                    confirmBtn.style.background = '';
                }
                document.getElementById('confirmModal').classList.add('show');
            });
        }

        function resolveConfirm(choice) {
            document.getElementById('confirmModal').classList.remove('show');
            if (confirmResolver) {
                confirmResolver(choice);
                confirmResolver = null;
            }
        }

        // Simple admin toast
        function showAdminToast(message, tone = 'info') {
            const container = document.getElementById('adminToastContainer');
            if (!container) return;
            const toast = document.createElement('div');
            toast.className = `admin-toast ${tone === 'error' ? 'error' : tone === 'success' ? 'success' : ''}`;
            toast.innerHTML = `
                <span>${message}</span>
                <button class="toast-close" aria-label="Close" onclick="this.closest('.admin-toast').remove()">×</button>
            `;
            container.appendChild(toast);
            setTimeout(() => {
                toast.classList.add('fade-out');
                setTimeout(() => toast.remove(), 300);
            }, 3500);
        }

        // State for editing staff/products
        let editingStaffId = null;
        let editingProductId = null;
        let staffListCache = [];
        let productListCache = [];

        async function editStaff(id) {
            editingStaffId = id;
            // Find staff in cached list or fetch
            let staff = staffListCache.find(s => s.id === id);
            if (!staff) {
                try {
                    const data = await apiCall('/admin/staff');
                    staffListCache = data.staff || [];
                    staff = staffListCache.find(s => s.id === id);
                } catch (error) {
                    alert('Error loading staff: ' + error.message);
                    return;
                }
            }

            if (!staff) {
                alert('Staff member not found');
                return;
            }

            // Prefill form fields
            document.getElementById('staffName').value = staff.name || '';
            document.getElementById('staffRole').value = staff.specialty || 'Stylist';
            document.getElementById('staffTagline').value = staff.tagline || '';
            document.getElementById('staffExperience').value = staff.yearsExperience || '';
            document.getElementById('staffInstagram').value = staff.instagram || '';
            const imageUrl = staff.imageUrl || staff.image_url;
            if (imageUrl) {
                const preview = document.getElementById('staffPhotoPreview');
                preview.src = imageUrl;
                preview.dataset.imageUrl = imageUrl;
                preview.style.display = 'block';
            }

            // Update modal title and button
            document.querySelector('#addStaffModal .modal-title').textContent = 'Edit Staff Member';
            document.getElementById('staffSaveBtn').textContent = 'Save Changes';

            openModal('addStaffModal');
        }

        async function archiveStaff(id) {
            const proceed = await openConfirmDialog({
                title: 'Archive staff member?',
                message: 'They will be marked inactive.',
                confirmText: 'Archive'
            });
            if (!proceed) return;
            try {
                await apiCall(`/admin/staff/${id}/archive`, { method: 'PATCH' });
                staffListCache = [];
                loadStaff();
                showAdminToast('Staff archived', 'success');
            } catch (error) {
                showAdminToast('Error archiving staff: ' + (error.message || ''), 'error');
            }
        }

        async function deleteStaff(id) {
            const proceed = await openConfirmDialog({
                title: 'Delete staff member?',
                message: 'This cannot be undone.',
                confirmText: 'Delete',
                tone: 'danger'
            });
            if (!proceed) return;
            try {
                await apiCall(`/admin/staff/${id}`, { method: 'DELETE' });
                staffListCache = [];
                loadStaff();
                showAdminToast('Staff deleted', 'success');
            } catch (error) {
                showAdminToast('Error deleting staff: ' + (error.message || ''), 'error');
            }
        }

        // ===== STAFF SERVICES MANAGEMENT FUNCTIONS =====
        let currentStaffIdForServices = null;
        let allAvailableServices = [];
        let staffCurrentServices = [];

        // Open staff services management modal
        async function openStaffServicesModal(staffId) {
            if (!staffId) {
                showAdminToast('Please save the staff member first', 'error');
                return;
            }

            currentStaffIdForServices = staffId;
            document.getElementById('staffServicesModal').style.display = 'flex';

            // Load all available services and staff's current services
            await Promise.all([
                loadAllAvailableServices(),
                loadStaffServices(staffId)
            ]);

            renderAvailableServices();
            renderStaffServices();
        }

        function closeStaffServicesModal() {
            document.getElementById('staffServicesModal').style.display = 'none';
            currentStaffIdForServices = null;
        }

        // Load all available services
        async function loadAllAvailableServices() {
            try {
                const data = await apiCall('/admin/services');
                allAvailableServices = data.services || [];

                // Populate category filter
                const categories = [...new Set(allAvailableServices.map(s => s.category))].sort();
                const filterSelect = document.getElementById('serviceCategoryFilter');
                filterSelect.innerHTML = '<option value="">All Categories</option>' +
                    categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            } catch (error) {
                console.error('Error loading services:', error);
            }
        }

        // Load staff's current services
        async function loadStaffServices(staffId) {
            try {
                const data = await apiCall(`/admin/staff/${staffId}/services`);
                staffCurrentServices = data.services || [];
            } catch (error) {
                console.error('Error loading staff services:', error);
            }
        }

        // Filter available services
        function filterAvailableServices() {
            renderAvailableServices();
        }

        // Render available services list
        function renderAvailableServices() {
            const searchTerm = document.getElementById('serviceSearchFilter').value.toLowerCase();
            const categoryFilter = document.getElementById('serviceCategoryFilter').value;

            // Filter out services already added to staff
            const staffServiceIds = staffCurrentServices.map(s => s.service_id);
            let filtered = allAvailableServices.filter(s => !staffServiceIds.includes(s.id));

            if (searchTerm) {
                filtered = filtered.filter(s =>
                    s.name.toLowerCase().includes(searchTerm) ||
                    (s.category && s.category.toLowerCase().includes(searchTerm))
                );
            }

            if (categoryFilter) {
                filtered = filtered.filter(s => s.category === categoryFilter);
            }

            const container = document.getElementById('availableServicesList');

            if (filtered.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-subtle);">No services available</div>';
                return;
            }

            container.innerHTML = filtered.map(service => `
                <div style="padding: 10px; border-bottom: 1px solid var(--border-soft); display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>${service.name}</strong><br>
                        <small style="color: var(--text-subtle);">${service.category} - R${service.price} - ${service.duration}min</small>
                    </div>
                    <button class="btn btn-sm btn-primary" onclick="addServiceToStaff('${service.id}')">Add</button>
                </div>
            `).join('');
        }

        // Render staff's services
        function renderStaffServices() {
            const container = document.getElementById('staffServicesList');

            if (staffCurrentServices.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-subtle);">No services added yet</div>';
                return;
            }

            container.innerHTML = staffCurrentServices.map(ss => `
                <div class="card" style="margin-bottom: 10px; padding: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                        <div>
                            <strong>${ss.service_name}</strong><br>
                            <small style="color: var(--text-subtle);">${ss.category}</small>
                        </div>
                        <button class="btn btn-sm btn-outline" onclick="removeServiceFromStaff('${ss.service_id}')"
                                style="color: var(--danger);">Remove</button>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label" style="font-size: 12px;">Custom Price (R)</label>
                            <input type="number" class="form-input"
                                   value="${ss.custom_price || ss.default_price}"
                                   placeholder="${ss.default_price}"
                                   onchange="updateStaffServicePrice('${ss.service_id}', this.value)"
                                   step="0.01" min="0">
                            <small style="color: var(--text-subtle);">Default: R${ss.default_price}</small>
                        </div>

                        <div class="form-group" style="margin: 0;">
                            <label class="form-label" style="font-size: 12px;">Custom Duration (min)</label>
                            <input type="number" class="form-input"
                                   value="${ss.custom_duration || ss.default_duration}"
                                   placeholder="${ss.default_duration}"
                                   onchange="updateStaffServiceDuration('${ss.service_id}', this.value)"
                                   step="15" min="0">
                            <small style="color: var(--text-subtle);">Default: ${ss.default_duration}min</small>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Add service to staff
        async function addServiceToStaff(serviceId) {
            try {
                await apiCall(`/admin/staff/${currentStaffIdForServices}/services`, {
                    method: 'POST',
                    body: JSON.stringify({ serviceId })
                });

                showAdminToast('Service added successfully', 'success');
                await loadStaffServices(currentStaffIdForServices);
                renderAvailableServices();
                renderStaffServices();
            } catch (error) {
                console.error('Error adding service:', error);
                showAdminToast(error.message || 'Failed to add service', 'error');
            }
        }

        // Remove service from staff
        async function removeServiceFromStaff(serviceId) {
            const proceed = await openConfirmDialog({
                title: 'Remove Service?',
                message: 'This will remove this service from the staff member\'s offerings.',
                confirmText: 'Remove',
                tone: 'danger'
            });

            if (!proceed) return;

            try {
                await apiCall(`/admin/staff/${currentStaffIdForServices}/services/${serviceId}`, {
                    method: 'DELETE'
                });

                showAdminToast('Service removed successfully', 'success');
                await loadStaffServices(currentStaffIdForServices);
                renderAvailableServices();
                renderStaffServices();
            } catch (error) {
                console.error('Error removing service:', error);
                showAdminToast(error.message || 'Failed to remove service', 'error');
            }
        }

        // Update staff service custom price
        async function updateStaffServicePrice(serviceId, price) {
            try {
                const customPrice = price ? parseFloat(price) : null;
                await apiCall(`/admin/staff/${currentStaffIdForServices}/services/${serviceId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ customPrice })
                });

                showAdminToast('Price updated', 'success');
                await loadStaffServices(currentStaffIdForServices);
            } catch (error) {
                console.error('Error updating price:', error);
                showAdminToast('Failed to update price', 'error');
            }
        }

        // Update staff service custom duration
        async function updateStaffServiceDuration(serviceId, duration) {
            try {
                const customDuration = duration ? parseInt(duration) : null;
                await apiCall(`/admin/staff/${currentStaffIdForServices}/services/${serviceId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ customDuration })
                });

                showAdminToast('Duration updated', 'success');
                await loadStaffServices(currentStaffIdForServices);
            } catch (error) {
                console.error('Error updating duration:', error);
                showAdminToast('Failed to update duration', 'error');
            }
        }

        // ===== SERVICE MANAGEMENT FUNCTIONS =====
        let allServices = [];
        let editingServiceId = null;

        async function loadServices() {
            try {
                const data = await apiCall('/admin/services');
                allServices = data.services || [];

                // Populate service type filter
                const typeFilter = document.getElementById('serviceTypeFilter');
                const types = [...new Set(allServices.map(s => s.service_type))];
                typeFilter.innerHTML = '<option value="">All Types</option>' +
                    types.map(type => `<option value="${type}">${type.charAt(0).toUpperCase() + type.slice(1)}</option>`).join('');

                renderServicesTable();
            } catch (error) {
                console.error('Error loading services:', error);
                showAdminToast('Error loading services', 'error');
            }
        }

        function filterServices() {
            const searchTerm = document.getElementById('serviceSearchInput').value.toLowerCase();
            const typeFilter = document.getElementById('serviceTypeFilter').value;
            const activeFilter = document.getElementById('serviceActiveFilter').value;

            let filtered = allServices;

            if (searchTerm) {
                filtered = filtered.filter(s =>
                    s.name.toLowerCase().includes(searchTerm) ||
                    (s.description && s.description.toLowerCase().includes(searchTerm)) ||
                    (s.category && s.category.toLowerCase().includes(searchTerm))
                );
            }

            if (typeFilter) {
                filtered = filtered.filter(s => s.service_type === typeFilter);
            }

            if (activeFilter !== '') {
                filtered = filtered.filter(s => s.active === parseInt(activeFilter));
            }

            renderServicesTable(filtered);
        }

        function renderServicesTable(services = allServices) {
            const tbody = document.getElementById('servicesTableBody');

            if (services.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: var(--text-subtle);">No services found</td></tr>';
                return;
            }

            tbody.innerHTML = services.map(service => `
                <tr>
                    <td>
                        ${service.image_url
                            ? `<img src="${service.image_url}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;" alt="${service.name}">`
                            : '<div style="width: 50px; height: 50px; background: var(--gray-light); border-radius: 4px; display: flex; align-items: center; justify-content: center; color: var(--text-subtle);">No image</div>'
                        }
                    </td>
                    <td><strong>${service.name}</strong></td>
                    <td><span class="badge" style="background: var(--primary-light); color: var(--primary); padding: 4px 8px; border-radius: 4px; font-size: 12px;">${service.service_type}</span></td>
                    <td>${service.category || '-'}</td>
                    <td><strong>R${service.price.toFixed(2)}</strong></td>
                    <td>${service.duration ? service.duration + ' min' : '-'}</td>
                    <td>
                        <span class="status-badge status-${service.active ? 'confirmed' : 'cancelled'}">
                            ${service.active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm" onclick="editService('${service.id}')">Edit</button>
                        <button class="btn btn-sm btn-outline" onclick="toggleServiceActive('${service.id}')" style="margin-left: 6px;">
                            ${service.active ? 'Deactivate' : 'Activate'}
                        </button>
                        <button class="btn btn-sm btn-outline" onclick="deleteService('${service.id}')" style="margin-left: 6px; color: var(--danger);">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function openServiceModal() {
            editingServiceId = null;
            document.getElementById('serviceModalTitle').textContent = 'Add New Service';
            document.getElementById('serviceForm').reset();
            document.getElementById('serviceId').value = '';
            document.getElementById('serviceDisplayOrder').value = '0';
            document.getElementById('serviceCommissionRate').value = '';
            document.getElementById('serviceActive').checked = true;
            document.getElementById('serviceImagePreview').style.display = 'none';
            document.getElementById('serviceModal').style.display = 'flex';
        }

        function closeServiceModal() {
            document.getElementById('serviceModal').style.display = 'none';
            document.getElementById('serviceImagePreview').style.display = 'none';
            editingServiceId = null;
        }

        // Update image preview when URL changes
        function updateServiceImagePreview() {
            const url = document.getElementById('serviceImageUrl').value.trim();
            const preview = document.getElementById('serviceImagePreview');
            const img = document.getElementById('serviceImagePreviewImg');
            const error = document.getElementById('serviceImagePreviewError');

            if (!url) {
                preview.style.display = 'none';
                return;
            }

            // Show preview container
            preview.style.display = 'block';
            error.style.display = 'none';

            // Test if image loads
            img.onload = () => {
                img.style.display = 'block';
                error.style.display = 'none';
            };
            img.onerror = () => {
                img.style.display = 'none';
                error.style.display = 'block';
            };
            img.src = url;
        }

        async function editService(id) {
            const service = allServices.find(s => s.id === id);
            if (!service) return;

            editingServiceId = id;
            document.getElementById('serviceModalTitle').textContent = 'Edit Service';
            document.getElementById('serviceId').value = service.id;
            document.getElementById('serviceName').value = service.name;
            document.getElementById('serviceDescription').value = service.description || '';
            document.getElementById('serviceType').value = service.service_type;
            document.getElementById('serviceCategory').value = service.category || '';
            document.getElementById('servicePrice').value = service.price;
            document.getElementById('serviceDuration').value = service.duration || '';
            document.getElementById('serviceImageUrl').value = service.image_url || '';
            document.getElementById('serviceDisplayOrder').value = service.display_order || 0;
            document.getElementById('serviceCommissionRate').value = service.commission_rate !== null && service.commission_rate !== undefined
                ? (service.commission_rate * 100).toFixed(0)
                : '';
            document.getElementById('serviceActive').checked = service.active === 1;

            // Update image preview
            updateServiceImagePreview();

            document.getElementById('serviceModal').style.display = 'flex';
        }

        async function saveService(event) {
            event.preventDefault();

            const commissionRateInput = document.getElementById('serviceCommissionRate').value.trim();
            const commissionRate = commissionRateInput !== '' ? parseFloat(commissionRateInput) / 100 : null;

            const serviceData = {
                name: document.getElementById('serviceName').value.trim(),
                description: document.getElementById('serviceDescription').value.trim() || null,
                service_type: document.getElementById('serviceType').value.trim(),
                category: document.getElementById('serviceCategory').value.trim() || null,
                price: parseFloat(document.getElementById('servicePrice').value),
                duration: parseInt(document.getElementById('serviceDuration').value) || null,
                image_url: document.getElementById('serviceImageUrl').value.trim() || null,
                display_order: parseInt(document.getElementById('serviceDisplayOrder').value) || 0,
                commission_rate: commissionRate,
                active: document.getElementById('serviceActive').checked ? 1 : 0
            };

            try {
                if (editingServiceId) {
                    await apiCall(`/admin/services/${editingServiceId}`, {
                        method: 'PUT',
                        body: JSON.stringify(serviceData)
                    });
                    showAdminToast('Service updated successfully', 'success');
                } else {
                    await apiCall('/admin/services', {
                        method: 'POST',
                        body: JSON.stringify(serviceData)
                    });
                    showAdminToast('Service created successfully', 'success');
                }

                closeServiceModal();
                loadServices();
            } catch (error) {
                console.error('Error saving service:', error);
                showAdminToast(error.message || 'Error saving service', 'error');
            }
        }

        async function toggleServiceActive(id) {
            try {
                await apiCall(`/admin/services/${id}/toggle`, {
                    method: 'PATCH'
                });
                showAdminToast('Service status updated', 'success');
                loadServices();
            } catch (error) {
                console.error('Error toggling service:', error);
                showAdminToast('Error updating service status', 'error');
            }
        }

        async function deleteService(id) {
            const proceed = await openConfirmDialog({
                title: 'Delete Service?',
                message: 'This service will be permanently deleted. Services used in bookings cannot be deleted.',
                confirmText: 'Delete',
                tone: 'danger'
            });

            if (!proceed) return;

            try {
                await apiCall(`/admin/services/${id}`, {
                    method: 'DELETE'
                });
                showAdminToast('Service deleted successfully', 'success');
                loadServices();
            } catch (error) {
                console.error('Error deleting service:', error);
                showAdminToast(error.message || 'Error deleting service', 'error');
            }
        }
        // ===== END SERVICE MANAGEMENT FUNCTIONS =====

        async function editProduct(id) {
            editingProductId = id;
            // Find product in cached list or fetch
            let product = productListCache.find(p => p.id === id);
            if (!product) {
                try {
                    const data = await apiCall('/products');
                    productListCache = data.products || [];
                    product = productListCache.find(p => p.id === id);
                } catch (error) {
                    alert('Error loading product: ' + error.message);
                    return;
                }
            }

            if (!product) {
                alert('Product not found');
                return;
            }

            // Prefill form fields
            document.getElementById('productName').value = product.name || '';
            document.getElementById('productSku').value = product.sku || '';
            document.getElementById('productDescription').value = product.description || '';
            document.getElementById('productCategory').value = product.category || 'Care Products';
            document.getElementById('productStock').value = product.stock || 0;
            document.getElementById('productPrice').value = product.price || '';
            document.getElementById('productSalePrice').value = product.salePrice || '';
            const imageUrl = product.imageUrl || product.image_url || '';
            const imageInput = document.getElementById('productImageUrl');
            if (imageInput) {
                imageInput.value = imageUrl;
                updateProductImagePreview(imageUrl);
            }

            // Update modal title and button
            document.querySelector('#addProductModal .modal-title').textContent = 'Edit Product';
            document.getElementById('productSaveBtn').textContent = 'Save Changes';

            openModal('addProductModal');
        }

        async function deleteProduct(id) {
            const proceed = await openConfirmDialog({
                title: 'Delete product?',
                message: 'This action cannot be undone.',
                confirmText: 'Delete',
                tone: 'danger'
            });
            if (!proceed) return;

            try {
                await apiCall(`/admin/products/${id}`, {
                    method: 'DELETE'
                });
                showAdminToast('Product deleted successfully!', 'success');
                productListCache = []; // Clear cache
                loadProducts();
            } catch (error) {
                showAdminToast('Error deleting product: ' + (error.message || ''), 'error');
            }
        }

        // Reset staff modal for adding new
        function openAddStaffModal() {
            editingStaffId = null;
            document.getElementById('staffName').value = '';
            document.getElementById('staffRole').value = 'Stylist';
            document.getElementById('staffTagline').value = '';
            document.getElementById('staffExperience').value = '';
            document.getElementById('staffInstagram').value = '';
            const preview = document.getElementById('staffPhotoPreview');
            if (preview) {
                preview.src = '';
                preview.dataset.imageUrl = '';
                preview.style.display = 'none';
            }
            document.querySelector('#addStaffModal .modal-title').textContent = 'Add Staff Member';
            document.getElementById('staffSaveBtn').textContent = 'Add Staff Member';
            openModal('addStaffModal');
        }

        // Reset product modal for adding new
        function openAddProductModal() {
            editingProductId = null;
            document.getElementById('productName').value = '';
            document.getElementById('productSku').value = '';
            document.getElementById('productDescription').value = '';
            document.getElementById('productCategory').value = 'Care Products';
            document.getElementById('productStock').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('productSalePrice').value = '';
            document.querySelector('#addProductModal .modal-title').textContent = 'Add Product';
            document.getElementById('productSaveBtn').textContent = 'Add Product';
            openModal('addProductModal');
        }

        async function saveBooking() {
            const errorEl = document.getElementById('adminBookingError');
            if (errorEl) errorEl.textContent = '';

            const customerId = document.getElementById('adminBookingCustomer').value;
            const serviceSelect = document.getElementById('adminBookingService');
            const serviceId = serviceSelect?.value;
            const bookingType = serviceSelect?.selectedOptions[0]?.dataset.type || 'hair';
            const stylistId = document.getElementById('adminBookingStylist').value;
            const date = document.getElementById('adminBookingDate').value;
            const time = document.getElementById('adminBookingTime').value;
            const duration = document.getElementById('adminBookingDuration').value;
            const notes = document.getElementById('adminBookingNotes').value.trim();

            if (!customerId || !serviceId || !date || !time) {
                if (errorEl) errorEl.textContent = 'Customer, service, date, and start time are required.';
                return;
            }
            if (bookingType === 'hair' && !stylistId) {
                if (errorEl) errorEl.textContent = 'Please choose a stylist for hair bookings.';
                return;
            }

            const payload = {
                userId: customerId,
                type: bookingType,
                serviceId,
                date,
                time,
                duration: duration ? parseInt(duration) : undefined,
                stylistId: stylistId || null,
                notes: notes || undefined
            };

            try {
                await apiCall('/admin/bookings', {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                closeModal('addBookingModal');
                await loadBookings();
                showToast({ type: 'success', title: 'Booking created', message: 'Booking saved and synced.' });
            } catch (error) {
                if (errorEl) errorEl.textContent = error.message || 'Failed to create booking.';
            }
        }

        // ============================================
        // PUSH NOTIFICATIONS
        // ============================================
        const notifIcons = {
            promo: `<svg viewBox="0 0 24 24" fill="none" stroke="#F67599" stroke-width="2" width="20" height="20">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
            </svg>`,
            info: `<svg viewBox="0 0 24 24" fill="none" stroke="#F67599" stroke-width="2" width="20" height="20">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>`,
            booking: `<svg viewBox="0 0 24 24" fill="none" stroke="#F67599" stroke-width="2" width="20" height="20">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>`,
            points: `<svg viewBox="0 0 24 24" fill="none" stroke="#F67599" stroke-width="2" width="20" height="20">
                <circle cx="12" cy="8" r="7"></circle>
                <polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline>
            </svg>`,
            gift: `<svg viewBox="0 0 24 24" fill="none" stroke="#F67599" stroke-width="2" width="20" height="20">
                <polyline points="20 12 20 22 4 22 4 12"></polyline>
                <rect x="2" y="7" width="20" height="5"></rect>
                <line x1="12" y1="22" x2="12" y2="7"></line>
                <path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"></path>
                <path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"></path>
            </svg>`,
            warning: `<svg viewBox="0 0 24 24" fill="none" stroke="#F67599" stroke-width="2" width="20" height="20">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                <line x1="12" y1="9" x2="12" y2="13"></line>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>`,
            success: `<svg viewBox="0 0 24 24" fill="none" stroke="#F67599" stroke-width="2" width="20" height="20">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>`,
            error: `<svg viewBox="0 0 24 24" fill="none" stroke="#F67599" stroke-width="2" width="20" height="20">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="15" y1="9" x2="9" y2="15"></line>
                <line x1="9" y1="9" x2="15" y2="15"></line>
            </svg>`,
            default: `<svg viewBox="0 0 24 24" fill="none" stroke="#F67599" stroke-width="2" width="20" height="20">
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
            </svg>`
        };

        async function loadNotifications() {
            try {
                const data = await apiCall('/notifications');
                renderNotifications(data.notifications || []);
            } catch (error) {
                document.getElementById('notificationsList').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--gray-medium);">
                        <p>No notifications yet. Create your first one!</p>
                    </div>
                `;
            }
        }

        function renderNotifications(notifications) {
            const container = document.getElementById('notificationsList');

            if (notifications.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--gray-medium);">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48" style="margin-bottom: 10px; opacity: 0.5;">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                        <p>No notifications yet. Create your first one!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = notifications.map(n => `
                <div class="notification-card" style="background: white; border: 1px solid var(--gray-light); border-radius: 12px; padding: 16px; margin-bottom: 12px; display: flex; gap: 14px; align-items: flex-start; ${!n.active ? 'opacity: 0.6;' : ''}">
                    <div style="width: 44px; height: 44px; border-radius: 10px; background: ${n.active ? 'rgba(246, 117, 153, 0.1)' : 'var(--gray-light)'}; display: flex; align-items: center; justify-content: center;">
                        ${notifIcons[n.type] || notifIcons.default}
                    </div>
                    <div style="flex: 1; min-width: 0;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px;">
                            <div style="font-weight: 600; color: var(--brand-charcoal);">${n.title}</div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <span style="font-size: 11px; padding: 3px 8px; border-radius: 4px; background: ${n.active ? 'rgba(76, 175, 80, 0.1)' : 'var(--gray-light)'}; color: ${n.active ? 'var(--success)' : 'var(--gray-medium)'};">
                                    ${n.active ? 'Active' : 'Inactive'}
                                </span>
                            </div>
                        </div>
                            <div style="font-size: 13px; color: var(--gray-medium); margin-bottom: 8px;">${n.message}</div>
                            <div style="display: flex; gap: 12px; font-size: 11px; color: var(--gray-medium);">
                                <span>Type: ${n.type}</span>
                                ${n.expiresAt ? `<span>Expires: ${formatDateDisplay(n.expiresAt)}</span>` : ''}
                                <span>Created: ${formatDateDisplay(n.createdAt)}</span>
                            </div>
                        </div>
                    <div style="display: flex; gap: 6px;">
                        <button onclick="toggleNotification('${n.id}')" class="btn btn-icon btn-outline" title="${n.active ? 'Deactivate' : 'Activate'}">
                            ${n.active ?
                                `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>` :
                                `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>`}
                        </button>
                        <button onclick="deleteNotification('${n.id}')" class="btn btn-icon btn-outline" title="Delete" style="color: var(--danger);">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function showCreateNotificationModal() {
            document.getElementById('createNotificationModal').classList.add('show');
            updateNotificationPreview();

            // Add event listeners for live preview
            document.getElementById('notifType').addEventListener('change', updateNotificationPreview);
            document.getElementById('notifTitle').addEventListener('input', updateNotificationPreview);
            document.getElementById('notifMessage').addEventListener('input', updateNotificationPreview);
        }

        function closeNotificationModal() {
            document.getElementById('createNotificationModal').classList.remove('show');
            // Clear form
            document.getElementById('notifTitle').value = '';
            document.getElementById('notifMessage').value = '';
            document.getElementById('notifActionText').value = '';
            document.getElementById('notifExpires').value = '';
            document.getElementById('notifType').value = 'promo';
        }

        function updateNotificationPreview() {
            const type = document.getElementById('notifType').value;
            const title = document.getElementById('notifTitle').value || 'Your Title Here';
            const message = document.getElementById('notifMessage').value || 'Your message will appear here...';

            document.getElementById('notifPreview').innerHTML = `
                <div style="width: 36px; height: 36px; border-radius: 8px; background: rgba(246, 117, 153, 0.1); display: flex; align-items: center; justify-content: center;">${notifIcons[type] || notifIcons.promo}</div>
                <div style="flex: 1;">
                    <div style="font-weight: 600; font-size: 13px; color: #414042;">${title}</div>
                    <div style="font-size: 12px; color: #6d6e70;">${message}</div>
                </div>
            `;
        }

        async function createNotification() {
            const title = document.getElementById('notifTitle').value.trim();
            const message = document.getElementById('notifMessage').value.trim();
            const type = document.getElementById('notifType').value;
            const actionText = document.getElementById('notifActionText').value.trim();
            const expiresAt = document.getElementById('notifExpires').value;

            if (!title || !message) {
                alert('Please enter a title and message');
                return;
            }

            try {
                await apiCall('/notifications', {
                    method: 'POST',
                    body: JSON.stringify({
                        title,
                        message,
                        type,
                        actionText: actionText || null,
                        expiresAt: expiresAt || null
                    })
                });

                closeNotificationModal();
                loadNotifications();
                alert('Notification created successfully! Users will see it when they open the app.');
            } catch (error) {
                alert('Error creating notification: ' + error.message);
            }
        }

        async function toggleNotification(id) {
            try {
                await apiCall(`/notifications/${id}/toggle`, { method: 'PATCH' });
                loadNotifications();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function deleteNotification(id) {
            const proceed = await openConfirmDialog({
                title: 'Delete notification?',
                message: 'This cannot be undone.',
                confirmText: 'Delete',
                tone: 'danger'
            });
            if (!proceed) return;

            try {
                await apiCall(`/notifications/${id}`, { method: 'DELETE' });
                loadNotifications();
            } catch (error) {
                showAdminToast('Error deleting notification: ' + (error.message || ''), 'error');
            }
        }

        // ============================================
        // CUSTOMER CHAT
        // ============================================
        let adminConversations = [];
        let selectedConversationId = null;
        let adminChatPollingInterval = null;

        async function loadAdminConversations() {
            try {
                const data = await apiCall('/admin/chat/conversations');
                adminConversations = data.conversations || [];
                renderAdminConversations();

                // Start polling for new messages
                startAdminChatPolling();

                // Update unread badge in nav
                updateUnreadBadge();
            } catch (error) {
                console.error('Error loading conversations:', error);
                document.getElementById('adminChatList').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--danger);">
                        Failed to load conversations: ${error.message}
                    </div>
                `;
            }
        }

        function renderAdminConversations() {
            const container = document.getElementById('adminChatList');

            if (adminConversations.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--gray-medium);">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48" style="margin-bottom: 15px; opacity: 0.5;">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                        <p>No conversations yet</p>
                        <p style="font-size: 12px; margin-top: 8px;">Customer messages will appear here</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = adminConversations.map(conv => {
                const isSelected = conv.id === selectedConversationId;
                const hasUnread = conv.unreadCount > 0;
                const lastMsgTime = conv.lastMessageAt ? formatChatTimeAdmin(new Date(conv.lastMessageAt)) : '';
                const statusClass = conv.status === 'closed' ? 'closed' : '';

                return `
                    <div class="chat-item ${isSelected ? 'active' : ''} ${hasUnread ? 'unread' : ''} ${statusClass}"
                         onclick="selectChat('${conv.id}')"
                         style="padding: 15px; border-bottom: 1px solid var(--gray-light); cursor: pointer; ${isSelected ? 'background: var(--primary-light);' : ''} ${hasUnread ? 'background: rgba(246, 117, 153, 0.12);' : ''}">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div class="chat-avatar" style="width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), #ff9cbc); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 16px;">
                                ${(conv.customerName || 'G').charAt(0).toUpperCase()}
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-weight: ${hasUnread ? '700' : '600'}; color: var(--dark);">${conv.customerName || 'Guest'}</span>
                                    <span style="font-size: 11px; color: var(--gray-medium);">${lastMsgTime}</span>
                                </div>
                                <div style="font-size: 13px; color: var(--gray-medium); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 4px;">
                                    ${conv.lastMessage || 'No messages yet'}
                                </div>
                                <div style="display: flex; gap: 8px; margin-top: 6px;">
                                    ${conv.status === 'closed' ? '<span style="font-size: 10px; padding: 2px 6px; background: var(--gray-light); border-radius: 10px; color: var(--gray-medium);">Closed</span>' : ''}
                                    ${hasUnread ? `<span style="font-size: 10px; padding: 2px 8px; background: var(--primary); border-radius: 10px; color: white;">${conv.unreadCount} new</span>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function formatChatTimeAdmin(date) {
            const now = new Date();
            const diff = now - date;
            const mins = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (mins < 1) return 'Just now';
            if (mins < 60) return mins + 'm ago';
            if (hours < 24) return hours + 'h ago';
            if (days < 7) return days + 'd ago';
            return formatDateDisplay(date);
        }

        async function selectChat(conversationId) {
            selectedConversationId = conversationId;

            // Update UI to show selected
            renderAdminConversations();

            try {
                const data = await apiCall(`/admin/chat/conversations/${conversationId}`);
                const conv = data.conversation;

                // Update header
                document.getElementById('selectedChatName').textContent = conv.customerName || 'Guest';
                document.getElementById('selectedChatStatus').textContent = conv.status === 'open' ? 'Active conversation' : 'Closed';
                document.getElementById('selectedChatAvatar').textContent = (conv.customerName || 'G').charAt(0).toUpperCase();
                document.getElementById('chatActions').style.display = conv.status === 'open' ? 'flex' : 'none';

                // Enable input if conversation is open
                const input = document.getElementById('adminChatInput');
                const sendBtn = document.getElementById('adminSendBtn');
                if (conv.status === 'open') {
                    input.disabled = false;
                    sendBtn.disabled = false;
                    input.placeholder = 'Type a message...';
                } else {
                    input.disabled = true;
                    sendBtn.disabled = true;
                    input.placeholder = 'This conversation is closed';
                }

                // Render messages
                renderAdminMessages(conv.messages || []);

                // Mark as read
                if (conv.unreadCount > 0) {
                    await apiCall(`/admin/chat/conversations/${conversationId}/read`, { method: 'PATCH' });
                    // Refresh conversation list to update unread counts
                    const listData = await apiCall('/admin/chat/conversations');
                    adminConversations = listData.conversations || [];
                    renderAdminConversations();
                    updateUnreadBadge();
                }

            } catch (error) {
                console.error('Error loading conversation:', error);
                document.getElementById('chatMessagesAdmin').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--danger);">
                        Failed to load conversation: ${error.message}
                    </div>
                `;
            }
        }

        function renderAdminMessages(messages) {
            const container = document.getElementById('chatMessagesAdmin');

            if (messages.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--gray-medium);">
                        No messages in this conversation yet
                    </div>
                `;
                return;
            }

            container.innerHTML = messages.map(msg => {
                const isAgent = msg.from === 'agent';
                const time = formatChatTimeAdmin(new Date(msg.timestamp));

                return `
                    <div style="display: flex; justify-content: ${isAgent ? 'flex-end' : 'flex-start'}; margin-bottom: 12px;">
                        <div style="max-width: 70%; padding: 12px 16px; border-radius: 18px; ${isAgent ?
                            'background: linear-gradient(135deg, var(--primary), #ff9cbc); color: white; border-bottom-right-radius: 4px;' :
                            'background: white; color: var(--dark); border-bottom-left-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.1);'}">
                            <div style="word-wrap: break-word;">${escapeHtmlAdmin(msg.text)}</div>
                            <div style="font-size: 10px; margin-top: 6px; opacity: 0.7; text-align: ${isAgent ? 'right' : 'left'};">
                                ${isAgent ? 'You' : 'Customer'} - ${time}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        function escapeHtmlAdmin(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function sendAdminChatMessage() {
            if (!selectedConversationId) return;

            const input = document.getElementById('adminChatInput');
            const message = input.value.trim();
            if (!message) return;

            input.value = '';
            input.disabled = true;
            document.getElementById('adminSendBtn').disabled = true;

            try {
                await apiCall('/admin/chat/message', {
                    method: 'POST',
                    body: JSON.stringify({
                        conversationId: selectedConversationId,
                        text: message
                    })
                });

                // Reload the conversation to show the new message
                await selectChat(selectedConversationId);

            } catch (error) {
                console.error('Error sending message:', error);
                alert('Failed to send message: ' + error.message);
            } finally {
                input.disabled = false;
                document.getElementById('adminSendBtn').disabled = false;
                input.focus();
            }
        }

        function handleAdminChatKeypress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendAdminChatMessage();
            }
        }

        async function closeConversation() {
            if (!selectedConversationId) return;

            const proceed = await openConfirmDialog({
                title: 'Close conversation?',
                message: 'The customer can start a new one if needed.',
                confirmText: 'Close Chat'
            });
            if (!proceed) return;

            try {
                await apiCall(`/admin/chat/conversations/${selectedConversationId}/status`, {
                    method: 'PATCH',
                    body: JSON.stringify({ status: 'closed' })
                });

                // Reload conversations and clear selection
                await loadAdminConversations();
                selectedConversationId = null;

                // Reset the chat panel
                document.getElementById('selectedChatName').textContent = 'Select a conversation';
                document.getElementById('selectedChatStatus').textContent = '';
                document.getElementById('selectedChatAvatar').textContent = '?';
                document.getElementById('chatActions').style.display = 'none';
                document.getElementById('adminChatInput').disabled = true;
                document.getElementById('adminSendBtn').disabled = true;
                document.getElementById('chatMessagesAdmin').innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: var(--gray-medium);">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48" style="margin-bottom: 15px; opacity: 0.5;">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                        <p>Select a conversation from the left to view messages</p>
                    </div>
                `;

            } catch (error) {
                console.error('Error closing conversation:', error);
                alert('Failed to close conversation: ' + error.message);
            }
        }

        function updateUnreadBadge() {
            const totalUnread = adminConversations.reduce((sum, c) => sum + (c.unreadCount || 0), 0);
            const badge = document.getElementById('totalUnreadBadge');
            const navBadge = document.querySelector('.nav-item[onclick*="chat"] .nav-badge');

            if (badge) {
                badge.textContent = totalUnread;
                badge.style.display = totalUnread > 0 ? 'inline-flex' : 'none';
            }

            if (navBadge) {
                navBadge.textContent = totalUnread;
                navBadge.style.display = totalUnread > 0 ? 'inline-flex' : 'none';
            }
        }

        function startAdminChatPolling() {
            stopAdminChatPolling();
            adminChatPollingInterval = setInterval(pollAdminChat, 10000); // Poll every 10 seconds
        }

        function stopAdminChatPolling() {
            if (adminChatPollingInterval) {
                clearInterval(adminChatPollingInterval);
                adminChatPollingInterval = null;
            }
        }

        async function pollAdminChat() {
            try {
                const data = await apiCall('/admin/chat/conversations');
                const newConversations = data.conversations || [];

                // Check if there are new messages in any conversation
                const hadNewMessages = newConversations.some((newConv, i) => {
                    const oldConv = adminConversations.find(c => c.id === newConv.id);
                    return !oldConv || newConv.messageCount > (oldConv.messageCount || 0);
                });

                adminConversations = newConversations;
                renderAdminConversations();
                updateUnreadBadge();

                // If the selected conversation has new messages, reload it
                if (selectedConversationId && hadNewMessages) {
                    const selectedConv = newConversations.find(c => c.id === selectedConversationId);
                    if (selectedConv) {
                        const convData = await apiCall(`/admin/chat/conversations/${selectedConversationId}`);
                        renderAdminMessages(convData.conversation.messages || []);
                    }
                }
            } catch (error) {
                console.error('Chat polling error:', error);
            }
        }

        // ============================================
        // HAIR TIPS MANAGEMENT
        // ============================================
        let hairTipsData = [];

        async function loadHairTips() {
            try {
                const data = await apiCall('/admin/hair-tips');
                hairTipsData = data.tips || [];
                renderHairTips();
            } catch (error) {
                console.error('Error loading hair tips:', error);
                document.getElementById('hairTipsList').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--danger);">
                        Failed to load tips: ${error.message}
                    </div>
                `;
            }
        }

        function renderHairTips() {
            const container = document.getElementById('hairTipsList');

            if (hairTipsData.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--gray-medium);">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48" style="margin-bottom: 15px; opacity: 0.5;">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                        </svg>
                        <p>No hair tips yet</p>
                        <p style="font-size: 12px; margin-top: 8px;">Click "+ Add Tip" to create your first tip</p>
                    </div>
                `;
                return;
            }

            const activeCount = hairTipsData.filter(t => t.active).length;
            const inactiveCount = hairTipsData.length - activeCount;

            container.innerHTML = `
                <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                    <div style="padding: 15px 20px; background: var(--success-light, #e8f5e9); border-radius: 8px; flex: 1;">
                        <div style="font-size: 24px; font-weight: 700; color: var(--success, #4caf50);">${activeCount}</div>
                        <div style="font-size: 12px; color: var(--gray-medium);">Active Tips</div>
                    </div>
                    <div style="padding: 15px 20px; background: var(--gray-light); border-radius: 8px; flex: 1;">
                        <div style="font-size: 24px; font-weight: 700; color: var(--gray-medium);">${inactiveCount}</div>
                        <div style="font-size: 12px; color: var(--gray-medium);">Inactive Tips</div>
                    </div>
                </div>
                ${hairTipsData.map(tip => `
                    <div style="display: flex; align-items: flex-start; gap: 15px; padding: 15px; background: ${tip.active ? 'white' : 'var(--gray-light)'}; border: 1px solid var(--gray-light); border-radius: 10px; ${!tip.active ? 'opacity: 0.7;' : ''}">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <span style="font-size: 10px; padding: 2px 8px; background: ${getCategoryColor(tip.category)}; border-radius: 10px; color: white; text-transform: uppercase;">${tip.category || 'general'}</span>
                                ${!tip.active ? '<span style="font-size: 10px; padding: 2px 8px; background: var(--gray-medium); border-radius: 10px; color: white;">INACTIVE</span>' : ''}
                            </div>
                            <p style="margin: 0; color: var(--dark); line-height: 1.5;">${escapeHtmlTips(tip.text)}</p>
                        </div>
                        <div style="display: flex; gap: 8px; flex-shrink: 0;">
                            <button class="btn btn-sm btn-outline" onclick="toggleHairTip('${tip.id}')" title="${tip.active ? 'Deactivate' : 'Activate'}">
                                ${tip.active ? '👁️' : '👁️‍🗨️'}
                            </button>
                            <button class="btn btn-sm btn-outline" onclick="editHairTip('${tip.id}')" title="Edit">
                                ✏️
                            </button>
                            <button class="btn btn-sm btn-outline" onclick="deleteHairTip('${tip.id}')" title="Delete" style="color: var(--danger);">
                                🗑️
                            </button>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function getCategoryColor(category) {
            const colors = {
                'general': '#9e9e9e',
                'extensions': '#FF6B9D',
                'styling': '#9c27b0',
                'care': '#4caf50',
                'maintenance': '#ff9800',
                'wash': '#2196F3',
                'treatment': '#7e57c2',
                'heat': '#f57c00',
                'detangle': '#26a69a',
                'scalp': '#6d4c41',
                'drying': '#00acc1',
                'protection': '#00897b',
                'lifestyle': '#8d6e63'
            };
            return colors[category] || colors.general;
        }

        function escapeHtmlTips(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function openHairTipModal(tipId = null) {
            document.getElementById('editHairTipId').value = tipId || '';
            document.getElementById('hairTipModalTitle').textContent = tipId ? 'Edit Hair Tip' : 'Add New Hair Tip';

            if (tipId) {
                const tip = hairTipsData.find(t => t.id === tipId);
                if (tip) {
                    document.getElementById('hairTipText').value = tip.text;
                    document.getElementById('hairTipCategory').value = tip.category || 'general';
                    document.getElementById('hairTipPriority').value = tip.priority || 1;
                }
            } else {
                document.getElementById('hairTipText').value = '';
                document.getElementById('hairTipCategory').value = 'general';
                document.getElementById('hairTipPriority').value = '1';
            }

            openModal('hairTipModal');
        }

        function closeHairTipModal() {
            closeModal('hairTipModal');
        }

        function editHairTip(tipId) {
            openHairTipModal(tipId);
        }

        async function saveHairTip() {
            const tipId = document.getElementById('editHairTipId').value;
            const text = document.getElementById('hairTipText').value.trim();
            const category = document.getElementById('hairTipCategory').value;
            const priority = parseInt(document.getElementById('hairTipPriority').value);

            if (!text) {
                alert('Please enter the tip text');
                return;
            }

            try {
                if (tipId) {
                    // Update existing tip
                    await apiCall(`/admin/hair-tips/${tipId}`, {
                        method: 'PUT',
                        body: JSON.stringify({ text, category, priority })
                    });
                } else {
                    // Create new tip
                    await apiCall('/admin/hair-tips', {
                        method: 'POST',
                        body: JSON.stringify({ text, category, priority })
                    });
                }

                closeHairTipModal();
                loadHairTips();
            } catch (error) {
                alert('Error saving tip: ' + error.message);
            }
        }

        async function toggleHairTip(tipId) {
            try {
                await apiCall(`/admin/hair-tips/${tipId}/toggle`, { method: 'PATCH' });
                loadHairTips();
            } catch (error) {
                alert('Error toggling tip: ' + error.message);
            }
        }

        async function deleteHairTip(tipId) {
            const proceed = await openConfirmDialog({
                title: 'Delete tip?',
                message: 'This cannot be undone.',
                confirmText: 'Delete',
                tone: 'danger'
            });
            if (!proceed) return;

            try {
                await apiCall(`/admin/hair-tips/${tipId}`, { method: 'DELETE' });
                loadHairTips();
            } catch (error) {
                showAdminToast('Error deleting tip: ' + (error.message || ''), 'error');
            }
        }

        // ============================================
        // GALLERY MANAGEMENT
        // ============================================

        let galleryImporting = false;

        async function importFlirthairGallery() {
            if (galleryImporting) return;
            const confirmed = confirm('Import the latest images from flirthair.co.za into the gallery? Existing Flirt images will be updated.');
            if (!confirmed) return;

            galleryImporting = true;
            showAdminToast('Importing gallery images...', 'info');
            try {
                const result = await apiCall('/admin/gallery/import/flirthair', { method: 'POST' });
                const created = result.created || 0;
                const updated = result.updated || 0;
                const skipped = result.skipped || 0;
                showAdminToast(`Import complete. ${created} added, ${updated} updated, ${skipped} skipped.`, 'success');
                loadGallery();
            } catch (error) {
                showAdminToast('Import failed: ' + error.message, 'error');
            } finally {
                galleryImporting = false;
            }
        }

        async function loadGallery() {
            try {
                const data = await apiCall('/admin/gallery');
                renderGallery(data.items || []);
                window.instagramConfig = data.instagram || null;

                const instaStatus = document.getElementById('instagramStatus');
                if (instaStatus) {
                    const insta = data.instagram;
                    if (insta && insta.username) {
                        instaStatus.textContent = `Connected to @${insta.username}`;
                        instaStatus.style.color = 'var(--success)';
                    } else {
                        instaStatus.textContent = 'Not configured';
                        instaStatus.style.color = 'var(--gray-medium)';
                    }
                }
            } catch (error) {
                console.error('Error loading gallery:', error);
                document.getElementById('galleryList').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--danger); grid-column: 1/-1;">
                        Failed to load gallery: ${error.message}
                    </div>
                `;
            }
        }

        function openInstagramModal() {
            const existing = window.instagramConfig || {};
            const username = prompt('Instagram handle (without @):', existing.username || '');
            if (username === null) return;
            const embedUrl = prompt('Custom embed URL (optional):', existing.embedUrl || '');
            saveInstagramConfig(username.trim(), embedUrl ? embedUrl.trim() : '');
        }

        async function saveInstagramConfig(username, embedUrl) {
            try {
                await apiCall('/admin/gallery/instagram', {
                    method: 'PUT',
                    body: JSON.stringify({ username, embedUrl })
                });
                alert('Instagram feed updated');
                loadGallery();
            } catch (error) {
                alert('Error saving Instagram config: ' + error.message);
            }
        }

        function renderGallery(items) {
            const container = document.getElementById('galleryList');

            if (items.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--gray-medium); grid-column: 1/-1;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48" style="margin-bottom: 10px; opacity: 0.5;">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                            <polyline points="21 15 16 10 5 21"></polyline>
                        </svg>
                        <p>No gallery images yet. Click "+ Add Image" to get started.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = items.map(item => `
                <div class="gallery-admin-item ${item.active ? '' : 'inactive'}" data-id="${item.id}">
                    <img src="${item.imageUrl}" alt="${item.altText || ''}" onerror="this.src='https://via.placeholder.com/300x300?text=Image+Not+Found'">
                    <div class="gallery-admin-overlay">
                        <div class="gallery-admin-label">${item.label || 'Untitled'}</div>
                        <div class="gallery-admin-category">${item.category || 'general'}</div>
                    </div>
                    <div class="gallery-admin-actions">
                        <button class="gallery-action-btn edit" onclick="editGalleryItem('${item.id}')" title="Edit">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </button>
                        <button class="gallery-action-btn toggle" onclick="toggleGalleryItem('${item.id}')" title="${item.active ? 'Hide' : 'Show'}">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                ${item.active ?
                                    '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>' :
                                    '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line>'
                                }
                            </svg>
                        </button>
                        <button class="gallery-action-btn delete" onclick="deleteGalleryItem('${item.id}')" title="Delete">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function showGalleryModal(item = null) {
            document.getElementById('galleryModalTitle').textContent = item ? 'Edit Gallery Image' : 'Add Gallery Image';
            document.getElementById('gallerySubmitBtn').textContent = item ? 'Update Image' : 'Add Image';
            document.getElementById('galleryEditId').value = item ? item.id : '';
            document.getElementById('galleryImageUrl').value = item ? item.imageUrl : '';
            document.getElementById('galleryLabel').value = item ? (item.label || '') : '';
            document.getElementById('galleryAltText').value = item ? (item.altText || '') : '';
            document.getElementById('galleryCategory').value = item ? (item.category || 'general') : 'general';

            // Update preview
            updateGalleryPreview(item ? item.imageUrl : '');

            document.getElementById('galleryModal').classList.add('active');
        }

        function closeGalleryModal() {
            document.getElementById('galleryModal').classList.remove('active');
        }

        function updateGalleryPreview(url) {
            const preview = document.getElementById('galleryImagePreview');
            if (url) {
                preview.innerHTML = `<img src="${url}" alt="Preview" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.parentElement.innerHTML='<span style=\\'color: var(--danger);\\'>Failed to load image</span>'">`;
            } else {
                preview.innerHTML = '<span style="color: var(--gray-medium);">Enter URL to preview</span>';
            }
        }

        // Add event listener for image URL preview
        document.addEventListener('DOMContentLoaded', function() {
            const urlInput = document.getElementById('galleryImageUrl');
            if (urlInput) {
                urlInput.addEventListener('input', function() {
                    updateGalleryPreview(this.value);
                });
            }
        });

        async function editGalleryItem(id) {
            try {
                const data = await apiCall('/admin/gallery');
                const item = data.items.find(i => i.id === id);
                if (item) {
                    showGalleryModal(item);
                }
            } catch (error) {
                alert('Error loading item: ' + error.message);
            }
        }

        async function submitGalleryItem() {
            const id = document.getElementById('galleryEditId').value;
            const imageUrl = document.getElementById('galleryImageUrl').value.trim();
            const label = document.getElementById('galleryLabel').value.trim();
            const altText = document.getElementById('galleryAltText').value.trim();
            const category = document.getElementById('galleryCategory').value;

            if (!imageUrl) {
                alert('Please enter an image URL');
                return;
            }

            try {
                if (id) {
                    // Update existing
                    await apiCall(`/admin/gallery/${id}`, {
                        method: 'PATCH',
                        body: JSON.stringify({ imageUrl, label, altText, category })
                    });
                } else {
                    // Create new
                    await apiCall('/admin/gallery', {
                        method: 'POST',
                        body: JSON.stringify({ imageUrl, label, altText, category })
                    });
                }

                closeGalleryModal();
                loadGallery();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function toggleGalleryItem(id) {
            try {
                await apiCall(`/admin/gallery/${id}/toggle`, { method: 'PATCH' });
                loadGallery();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function deleteGalleryItem(id) {
            const proceed = await openConfirmDialog({
                title: 'Delete gallery image?',
                message: 'This cannot be undone.',
                confirmText: 'Delete',
                tone: 'danger'
            });
            if (!proceed) return;

            try {
                await apiCall(`/admin/gallery/${id}`, { method: 'DELETE' });
                loadGallery();
            } catch (error) {
                showAdminToast('Error deleting image: ' + (error.message || ''), 'error');
            }
        }

        // ============================================
        // PAYMENT SETTINGS
        // ============================================
        async function loadPaymentSettings() {
            await refreshPaymentConfig();
        }

        async function refreshPaymentConfig() {
            try {
                const data = await apiCall('/admin/payment-config');
                const config = data.config;
                const stored = data.storedConfig || {};

                // Update App URL
                document.getElementById('paymentAppUrlDisplay').value = config.appUrl;

                populatePaymentForm(config, stored);

                // Update PayFast configuration
                updatePayFastUI(config.payfast);

                // Update Yoco configuration
                updateYocoUI(config.yoco);

            } catch (error) {
                console.error('Error loading payment config:', error);
                alert('Failed to load payment configuration: ' + error.message);
            }
        }

        function populatePaymentForm(config, stored) {
            document.getElementById('paymentAppUrl').value = stored.appUrl || config.appUrl || '';
            document.getElementById('paymentApiBaseUrl').value = stored.apiBaseUrl || config.apiBaseUrl || '';

            document.getElementById('payfastMerchantId').value = stored.payfast?.merchantId || '';
            document.getElementById('payfastMerchantKey').value = stored.payfast?.merchantKey || '';
            document.getElementById('payfastPassphrase').value = stored.payfast?.passphrase || '';
            const sandboxDefault = config.payfast.mode === 'sandbox';
            document.getElementById('payfastSandbox').checked = stored.payfast?.sandbox ?? sandboxDefault;

            document.getElementById('yocoSecretKey').value = stored.yoco?.secretKey || '';
            document.getElementById('yocoPublicKey').value = stored.yoco?.publicKey || '';
            document.getElementById('yocoWebhookSecret').value = stored.yoco?.webhookSecret || '';
        }

        async function savePaymentSettings() {
            const payload = {
                appUrl: document.getElementById('paymentAppUrl').value.trim(),
                apiBaseUrl: document.getElementById('paymentApiBaseUrl').value.trim(),
                payfast: {
                    merchantId: document.getElementById('payfastMerchantId').value.trim(),
                    merchantKey: document.getElementById('payfastMerchantKey').value.trim(),
                    passphrase: document.getElementById('payfastPassphrase').value.trim(),
                    sandbox: document.getElementById('payfastSandbox').checked
                },
                yoco: {
                    secretKey: document.getElementById('yocoSecretKey').value.trim(),
                    publicKey: document.getElementById('yocoPublicKey').value.trim(),
                    webhookSecret: document.getElementById('yocoWebhookSecret').value.trim()
                }
            };

            try {
                await apiCall('/admin/payment-config', {
                    method: 'PUT',
                    body: JSON.stringify(payload)
                });
                alert('Payment settings saved');
                await refreshPaymentConfig();
            } catch (error) {
                console.error('Error saving payment settings:', error);
                alert('Failed to save payment settings: ' + error.message);
            }
        }

        function updatePayFastUI(payfast) {
            // Status badge
            const statusBadge = document.getElementById('payfastStatusBadge');
            if (payfast.configured) {
                statusBadge.textContent = '✓ Configured';
                statusBadge.style.background = 'var(--success)';
                statusBadge.style.display = 'inline-block';
            } else {
                statusBadge.textContent = '⚠ Not Configured';
                statusBadge.style.background = 'var(--warning)';
                statusBadge.style.display = 'inline-block';
            }

            // Mode and URLs
            document.getElementById('payfastMode').value = payfast.mode;
            document.getElementById('payfastBaseUrl').value = payfast.baseUrl;
            document.getElementById('payfastNotifyUrl').value = payfast.notifyUrl;
            document.getElementById('payfastReturnUrl').value = payfast.returnUrl;
            document.getElementById('payfastCancelUrl').value = payfast.cancelUrl;

            // Passphrase indicator
            const passphraseIcon = document.getElementById('payfastPassphraseIcon');
            if (payfast.hasPassphrase) {
                passphraseIcon.innerHTML = '<span style="color: var(--success);">✓</span>';
            } else {
                passphraseIcon.innerHTML = '<span style="color: var(--gray-medium);">✗</span>';
            }

            // Missing vars
            const missingVarsDiv = document.getElementById('payfastMissingVars');
            const missingVarsList = document.getElementById('payfastMissingVarsList');

            if (payfast.missingEnvVars && payfast.missingEnvVars.length > 0) {
                missingVarsDiv.style.display = 'block';
                missingVarsList.innerHTML = payfast.missingEnvVars
                    .map(v => `<li><code style="background: white; padding: 2px 6px; border-radius: 4px;">${v}</code></li>`)
                    .join('');
            } else {
                missingVarsDiv.style.display = 'none';
            }
        }

        function updateYocoUI(yoco) {
            // Status badge
            const statusBadge = document.getElementById('yocoStatusBadge');
            if (yoco.configured) {
                statusBadge.textContent = '✓ Configured';
                statusBadge.style.background = 'var(--success)';
                statusBadge.style.display = 'inline-block';
            } else {
                statusBadge.textContent = '⚠ Not Configured';
                statusBadge.style.background = 'var(--warning)';
                statusBadge.style.display = 'inline-block';
            }

            // Base URL and webhook
            document.getElementById('yocoBaseUrl').value = yoco.baseUrl;
            document.getElementById('yocoWebhookUrl').value = yoco.webhookUrl;

            // Public key (truncated for security)
            document.getElementById('yocoPublicKeyDisplay').value = yoco.publicKey || 'Not configured';

            // Icons for configured items
            const publicKeyIcon = document.getElementById('yocoPublicKeyIcon');
            if (yoco.hasPublicKey) {
                publicKeyIcon.innerHTML = '<span style="color: var(--success);">✓</span>';
            } else {
                publicKeyIcon.innerHTML = '<span style="color: var(--gray-medium);">✗</span>';
            }

            const webhookSecretIcon = document.getElementById('yocoWebhookSecretIcon');
            if (yoco.hasWebhookSecret) {
                webhookSecretIcon.innerHTML = '<span style="color: var(--success);">✓</span>';
            } else {
                webhookSecretIcon.innerHTML = '<span style="color: var(--warning);">⚠</span>';
            }

            // Missing vars
            const missingVarsDiv = document.getElementById('yocoMissingVars');
            const missingVarsList = document.getElementById('yocoMissingVarsList');

            if (yoco.missingEnvVars && yoco.missingEnvVars.length > 0) {
                missingVarsDiv.style.display = 'block';
                missingVarsList.innerHTML = yoco.missingEnvVars
                    .map(v => `<li><code style="background: white; padding: 2px 6px; border-radius: 4px;">${v}</code></li>`)
                    .join('');
            } else {
                missingVarsDiv.style.display = 'none';
            }
        }

        // ============================================
        // BUSINESS & DELIVERY SETTINGS
        // ============================================

        let businessHours = {};

        async function loadSettingsPage() {
            await Promise.all([
                loadBusinessSettings(),
                loadDeliverySettings()
            ]);
        }

        async function loadBusinessSettings() {
            try {
                const data = await apiCall('/admin/business-settings');
                const settings = data.settings;

                document.getElementById('settingsBusinessName').value = settings.businessName || '';
                document.getElementById('settingsEmail').value = settings.email || '';
                document.getElementById('settingsPhone').value = settings.phone || '';
                document.getElementById('settingsAddress').value = settings.address || '';

                businessHours = settings.hours || {};
                renderBusinessHours();
            } catch (error) {
                console.error('Error loading business settings:', error);
                // If endpoint doesn't exist yet (table not created), show defaults
                renderBusinessHours();
            }
        }

        function renderBusinessHours() {
            const days = [
                { key: 'mon', label: 'MON' },
                { key: 'tue', label: 'TUE' },
                { key: 'wed', label: 'WED' },
                { key: 'thu', label: 'THU' },
                { key: 'fri', label: 'FRI' },
                { key: 'sat', label: 'SAT' },
                { key: 'sun', label: 'SUN' }
            ];

            const grid = document.getElementById('businessHoursGrid');
            grid.innerHTML = days.map(day => {
                const hours = businessHours[day.key];
                const isClosed = !hours;
                const displayText = isClosed ? 'Closed' : formatHoursDisplay(hours.open, hours.close);
                const opacity = isClosed ? 'opacity: 0.5;' : '';

                return `
                    <div style="text-align: center; padding: 10px; background: var(--gray-light); border-radius: 8px; cursor: pointer; ${opacity}"
                         onclick="editDayHours('${day.key}', '${day.label}')"
                         title="Click to edit">
                        <div style="font-weight: 600; font-size: 12px;">${day.label}</div>
                        <div style="font-size: 11px; color: var(--gray-medium);">${displayText}</div>
                    </div>
                `;
            }).join('');
        }

        function formatHoursDisplay(open, close) {
            const formatTime = (time) => {
                if (!time) return '';
                const [h, m] = time.split(':');
                const hour = parseInt(h);
                const ampm = hour >= 12 ? 'pm' : 'am';
                const hour12 = hour % 12 || 12;
                return `${hour12}${ampm}`;
            };
            return `${formatTime(open)}-${formatTime(close)}`;
        }

        function editDayHours(dayKey, dayLabel) {
            const hours = businessHours[dayKey];
            const isClosed = !hours;

            const html = `
                <div style="padding: 20px;">
                    <h3 style="margin-bottom: 20px;">Edit ${dayLabel} Hours</h3>
                    <div style="margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="dayClosedCheckbox" ${isClosed ? 'checked' : ''} onchange="toggleDayClosed()">
                            <span>Closed</span>
                        </label>
                    </div>
                    <div id="hoursInputs" style="${isClosed ? 'display: none;' : ''}">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Open</label>
                                <input type="time" class="form-input" id="dayOpenTime" value="${hours?.open || '08:00'}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Close</label>
                                <input type="time" class="form-input" id="dayCloseTime" value="${hours?.close || '18:00'}">
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="saveDayHours('${dayKey}')">Save</button>
                        <button class="btn btn-outline" onclick="closeModal('editHoursModal')">Cancel</button>
                    </div>
                </div>
            `;

            // Create modal if not exists
            let modal = document.getElementById('editHoursModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'editHoursModal';
                modal.className = 'modal-overlay';
                modal.innerHTML = '<div class="modal" style="max-width: 400px;"></div>';
                document.body.appendChild(modal);
            }

            modal.querySelector('.modal').innerHTML = html;
            modal.style.display = '';  // Clear inline style so CSS class can work
            modal.classList.add('show');
        }

        function toggleDayClosed() {
            const isClosed = document.getElementById('dayClosedCheckbox').checked;
            document.getElementById('hoursInputs').style.display = isClosed ? 'none' : '';
        }

        function saveDayHours(dayKey) {
            const isClosed = document.getElementById('dayClosedCheckbox').checked;

            if (isClosed) {
                businessHours[dayKey] = null;
            } else {
                businessHours[dayKey] = {
                    open: document.getElementById('dayOpenTime').value,
                    close: document.getElementById('dayCloseTime').value
                };
            }

            renderBusinessHours();
            closeModal('editHoursModal');
        }

        async function saveBusinessSettings() {
            const payload = {
                businessName: document.getElementById('settingsBusinessName').value.trim(),
                email: document.getElementById('settingsEmail').value.trim(),
                phone: document.getElementById('settingsPhone').value.trim(),
                address: document.getElementById('settingsAddress').value.trim(),
                hours: businessHours
            };

            // Validate email
            if (payload.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(payload.email)) {
                alert('Please enter a valid email address');
                return;
            }

            try {
                await apiCall('/admin/business-settings', {
                    method: 'PUT',
                    body: JSON.stringify(payload)
                });
                alert('Business settings saved successfully!');
            } catch (error) {
                console.error('Error saving business settings:', error);
                alert('Failed to save business settings: ' + error.message);
            }
        }

        async function loadDeliverySettings() {
            try {
                const data = await apiCall('/admin/delivery-config');
                const config = data.config;

                document.getElementById('deliveryStandardFee').value = config.standardFee || '';
                document.getElementById('deliveryExpressFee').value = config.expressFee || '';
                document.getElementById('deliveryFreeThreshold').value = config.freeThreshold || '';
            } catch (error) {
                console.error('Error loading delivery settings:', error);
            }
        }

        async function saveDeliverySettings() {
            const standardFee = parseFloat(document.getElementById('deliveryStandardFee').value) || 0;
            const expressFee = parseFloat(document.getElementById('deliveryExpressFee').value) || 0;
            const freeThreshold = parseFloat(document.getElementById('deliveryFreeThreshold').value) || 0;

            if (standardFee < 0 || expressFee < 0 || freeThreshold < 0) {
                alert('Fee values cannot be negative');
                return;
            }

            try {
                await apiCall('/admin/delivery-config', {
                    method: 'PUT',
                    body: JSON.stringify({ standardFee, expressFee, freeThreshold })
                });
                alert('Delivery settings saved successfully!');
            } catch (error) {
                console.error('Error saving delivery settings:', error);
                alert('Failed to save delivery settings: ' + error.message);
            }
        }

        function navigateToSection(sectionId) {
            showSection(sectionId);
        }

        document.addEventListener('DOMContentLoaded', async function() {
            const today = new Date().toISOString().split('T')[0];
            document.querySelectorAll('input[type="date"]').forEach(input => {
                if (!input.value) input.value = today;
            });

            const isAuthed = await checkAdminAuth();
            if (isAuthed) {
                initDashboard();
            }
        });
    </script>
</body>
</html>







