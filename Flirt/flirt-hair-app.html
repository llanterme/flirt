<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Runtime-configurable client settings (override by replacing content) -->
    <meta name="flirt-api-base" content="/api">
    <meta name="flirt-support-whatsapp" content="27821234567">
    <meta name="flirt-media-base" content="https://www.flirthair.co.za">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FL!RT - Premium Hair Extensions</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#F67599">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Flirt">
    <meta name="description" content="Book appointments, shop products, and earn rewards at Flirt Hair & Beauty Bar">

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Flirt Brand Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23F67599'/><text y='68' x='50' text-anchor='middle' font-size='36' font-family='Arial' font-weight='300' letter-spacing='2' fill='white'>FL<tspan fill='%23414042'>.</tspan>RT</text></svg>">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <!-- Google Fonts - Closest to Lulo Clean One & Humanist -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@300;400;600&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Flirt Brand Colors - from Style Guide */
            --brand-pink: #F67599;          /* Primary - Pantone 190 C */
            --brand-pink-dark: #e05a7f;     /* Darker pink for hover states */
            --brand-charcoal: #414042;      /* Secondary - Pantone Black 7 C */
            --brand-white: #ffffff;         /* Base color */

            /* Legacy variable mapping for compatibility */
            --primary-black: #414042;
            --primary-white: #ffffff;
            --accent-pink: #F67599;
            --accent-gold: #F67599;         /* Using pink instead of gold for brand consistency */
            --gray-dark: #414042;
            --gray-medium: #6d6e70;
            --gray-light: #f8f8f8;
            --success: #4CAF50;
            --warning: #FF9800;
            --danger: #e74c3c;
            --shadow: rgba(65, 64, 66, 0.1);
            --text-muted: rgba(65, 64, 66, 0.75);
            --text-subtle: rgba(65, 64, 66, 0.6);
            --border-soft: rgba(65, 64, 66, 0.16);
            --border-strong: rgba(65, 64, 66, 0.24);
            --surface-muted: #f4f4f4;
            --brand-gradient: linear-gradient(135deg, var(--brand-pink) 0%, var(--brand-pink-dark) 100%);
        }

        body {
            font-family: 'Open Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--gray-light);
            color: var(--brand-charcoal);
            line-height: 1.6;
        }

        /* Brand Typography */
        .logo, h1, h2, h3, .section-title {
            font-family: 'Josefin Sans', 'Helvetica Neue', Arial, sans-serif;
            letter-spacing: 0.15em;
            text-transform: uppercase;
        }

        /* App Container */
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .app-header {
            background: linear-gradient(135deg, var(--brand-charcoal) 0%, #2d2d2e 100%);
            color: white;
            padding: 0;
            display: flex;
            justify-content: space-between;
            align-items: stretch;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            min-height: 80px;
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 25px;
            background: var(--brand-pink);
            position: relative;
        }

        .logo::after {
            content: '';
            position: absolute;
            right: -30px;
            top: 0;
            bottom: 0;
            width: 60px;
            background: var(--brand-pink);
            clip-path: polygon(0 0, 50% 0, 100% 100%, 0 100%);
        }

        .logo img {
            height: 60px;
            width: auto;
            position: relative;
            z-index: 1;
        }

        .header-center {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 40px;
        }

        .header-tagline {
            font-family: 'Josefin Sans', Arial, sans-serif;
            font-size: 11px;
            letter-spacing: 0.3em;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.6);
            font-weight: 300;
        }

        .header-icons {
            display: flex;
            gap: 8px;
            align-items: center;
            padding: 0 20px;
        }

        .icon-btn {
            background: rgba(255, 255, 255, 0.08);
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-btn:hover {
            background: var(--brand-pink);
            transform: translateY(-2px);
        }

        .icon-btn svg {
            width: 22px;
            height: 22px;
        }

        .badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: var(--brand-pink);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 2px 6px rgba(246, 117, 153, 0.4);
        }

        .profile-btn {
            background: linear-gradient(135deg, var(--brand-pink) 0%, var(--brand-pink-dark) 100%);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .profile-btn:hover {
            background: linear-gradient(135deg, var(--brand-pink-dark) 0%, var(--brand-pink) 100%);
            border-color: rgba(255, 255, 255, 0.4);
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            background: white;
            border-bottom: 1px solid var(--gray-light);
            overflow-x: auto;
            position: sticky;
            top: 80px;
            z-index: 90;
        }

        .nav-tab {
            flex: 1;
            min-width: 80px;
            padding: 12px 10px;
            text-align: center;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 12px;
            color: var(--gray-medium);
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }

        .nav-icon {
            width: 22px;
            height: 22px;
            transition: all 0.3s;
        }

        .nav-tab:hover .nav-icon {
            transform: translateY(-2px);
        }

        .nav-tab.active {
            color: var(--brand-pink);
            border-bottom-color: var(--brand-pink);
            font-weight: 600;
        }

        .nav-tab.active .nav-icon {
            stroke-width: 2.5;
        }

        /* Content Area with Smooth Animations */
        .content-area {
            flex: 1;
            padding: 20px;
            display: none;
        }

        .content-area.active {
            display: block;
            animation: fadeInUp 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Staggered fade-in for cards */
        .card, .service-card, .stylist-card, .product-card {
            animation: fadeInScale 0.4s cubic-bezier(0.4, 0, 0.2, 1) backwards;
        }

        .service-grid .service-card:nth-child(1) { animation-delay: 0.05s; }
        .service-grid .service-card:nth-child(2) { animation-delay: 0.1s; }
        .service-grid .service-card:nth-child(3) { animation-delay: 0.15s; }
        .service-grid .service-card:nth-child(4) { animation-delay: 0.2s; }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Home Dashboard - Redesigned */
        .home-hero {
            background: linear-gradient(135deg, var(--brand-charcoal) 0%, #2d2d2e 50%, var(--brand-pink) 150%);
            color: white;
            padding: 28px 24px;
            border-radius: 20px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .home-hero::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(246, 117, 153, 0.3) 0%, transparent 70%);
            border-radius: 50%;
        }

        .home-hero::after {
            content: '';
            position: absolute;
            bottom: -30%;
            left: -10%;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            border-radius: 50%;
        }

        .home-hero-content {
            position: relative;
            z-index: 1;
        }

        .home-hero-greeting {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .home-hero-headline {
            font-family: 'Josefin Sans', sans-serif;
            font-size: 26px;
            font-weight: 400;
            letter-spacing: 0.02em;
            line-height: 1.2;
            margin-bottom: 10px;
        }

        .home-hero-headline .highlight {
            color: var(--brand-pink);
            font-weight: 600;
        }

        .home-hero-subtitle {
            font-size: 14px;
            opacity: 0.85;
            line-height: 1.5;
            margin-bottom: 20px;
            max-width: 320px;
        }

        .home-hero-cta {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: var(--brand-pink);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 30px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(246, 117, 153, 0.4);
        }

        .home-hero-cta:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(246, 117, 153, 0.5);
        }

        .home-hero-cta:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 0 2px 10px rgba(246, 117, 153, 0.4);
        }

        .home-hero-cta svg {
            transition: transform 0.2s ease;
        }

        .home-hero-cta:hover svg {
            transform: translateX(4px);
        }

        .home-hero-stats {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            position: relative;
            z-index: 1;
        }

        .home-hero-stat {
            display: flex;
            flex-direction: column;
        }

        .home-hero-stat-value {
            font-size: 22px;
            font-weight: 700;
            color: var(--brand-pink);
        }

        .home-hero-stat-label {
            font-size: 12px;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .home-hero-stat-divider {
            width: 1px;
            height: 35px;
            background: rgba(255, 255, 255, 0.2);
        }

        /* Three Action Cards Row */
        .home-actions-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .home-action-card {
            background: white;
            border-radius: 16px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid var(--border-soft);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .home-action-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .home-action-card:active {
            transform: scale(0.98);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }

        .home-action-icon-wrap {
            width: 48px;
            height: 48px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tracker-icon {
            background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
            color: #2E7D32;
        }

        .share-icon {
            background: linear-gradient(135deg, #FFF3E0 0%, #FFE0B2 100%);
            color: #E65100;
        }

        .shop-icon {
            background: linear-gradient(135deg, #FCE4EC 0%, #F8BBD9 100%);
            color: var(--brand-pink);
        }

        .home-action-title {
            font-weight: 700;
            font-size: 14px;
            color: var(--brand-charcoal);
        }

        .home-action-desc {
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.4;
            flex: 1;
        }

        .home-action-link {
            font-size: 12px;
            color: var(--brand-pink);
            font-weight: 600;
        }

        /* Quick Book Services Chips */
        .home-quick-book {
            margin-bottom: 24px;
        }

        .home-services-scroll {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 4px 0;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .home-services-scroll::-webkit-scrollbar {
            display: none;
        }

        .home-service-chip {
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
            border: 2px solid var(--border-soft);
            border-radius: 30px;
            padding: 10px 18px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .home-service-chip:hover {
            border-color: var(--brand-pink);
            background: rgba(246, 117, 153, 0.05);
        }

        .home-service-chip:active {
            transform: scale(0.95);
            background: rgba(246, 117, 153, 0.15);
            border-color: var(--brand-pink);
        }

        .home-service-emoji {
            font-size: 18px;
        }

        .home-service-chip span:last-child {
            font-size: 13px;
            font-weight: 500;
            color: var(--brand-charcoal);
        }

        /* Responsive for mobile */
        @media (max-width: 600px) {
            .home-actions-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .home-action-card {
                flex-direction: row;
                align-items: center;
                padding: 14px;
            }

            .home-action-icon-wrap {
                width: 44px;
                height: 44px;
                flex-shrink: 0;
            }

            .home-action-content {
                flex: 1;
                min-width: 0;
            }

            .home-action-desc {
                display: none;
            }

            .home-action-title {
                font-size: 15px;
            }

            .home-hero-headline {
                font-size: 22px;
            }

            .home-hero {
                padding: 22px 18px;
            }

            .home-hero-cta {
                padding: 12px 20px;
                font-size: 14px;
            }
        }

        /* Tablet/medium screens - 2 column layout */
        @media (min-width: 601px) and (max-width: 900px) {
            .home-actions-row {
                grid-template-columns: repeat(2, 1fr);
            }

            .home-action-card:last-child {
                grid-column: span 2;
            }
        }

        /* Legacy welcome-banner support */
        .welcome-banner {
            background: linear-gradient(135deg, var(--primary-black) 0%, var(--gray-dark) 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .welcome-banner::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 200px;
            height: 200px;
            background: url('https://www.flirthair.co.za/wp-content/uploads/2022/03/home-image-1.jpg') center/cover;
            opacity: 0.1;
            border-radius: 50%;
        }

        .welcome-title {
            font-size: 24px;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .points-display {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 10px;
            width: fit-content;
            position: relative;
            z-index: 1;
        }

        .points-icon {
            color: var(--brand-pink);
            font-size: 24px;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .action-card {
            background: white;
            border: 2px solid var(--gray-light);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .action-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--brand-pink) 0%, transparent 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .action-card:hover::before {
            opacity: 0.05;
        }

        .action-card:hover {
            border-color: var(--brand-pink);
            transform: translateY(-5px);
            box-shadow: 0 5px 15px var(--shadow);
        }

        .action-icon {
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 50px;
        }

        .action-title {
            font-weight: 600;
            font-size: 14px;
            position: relative;
            z-index: 1;
        }

        /* Section Headers */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary-black);
        }

        .view-all-btn {
            color: var(--brand-pink);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px var(--shadow);
        }

        .offer-card {
            background: linear-gradient(135deg, var(--brand-pink) 0%, var(--brand-pink-dark) 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .offer-card:hover {
            transform: scale(1.02);
        }

        .offer-badge {
            display: inline-block;
            background: rgba(255, 255, 255, 0.3);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .offer-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .offer-description {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Booking Section */
        .booking-type-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .booking-type-card {
            background: white;
            border: 3px solid var(--gray-light);
            border-radius: 20px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .booking-type-card:hover {
            border-color: var(--brand-pink);
            transform: translateY(-8px);
            box-shadow: 0 10px 30px var(--shadow);
        }

        .booking-type-image {
            width: 100%;
            height: 200px;
            background-size: cover;
            background-position: center;
            position: relative;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 15px;
        }

        .booking-type-overlay {
            background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0.3) 50%, transparent 100%);
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        .booking-type-content {
            padding: 25px 30px 30px;
        }

        .booking-type-icon {
            font-size: 80px;
            margin-bottom: 15px;
        }

        .booking-type-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--primary-black);
            margin-bottom: 10px;
        }

        .booking-type-description {
            font-size: 14px;
            color: var(--gray-medium);
            margin-bottom: 20px;
        }

        .booking-type-features {
            text-align: left;
            font-size: 14px;
            color: var(--gray-dark);
            line-height: 1.8;
            background: var(--gray-light);
            padding: 15px;
            border-radius: 10px;
        }

        .stylist-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stylist-card {
            background: white;
            border: 2px solid var(--gray-light);
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .stylist-card:hover {
            border-color: var(--brand-pink);
            transform: translateY(-5px);
            box-shadow: 0 8px 20px var(--shadow);
        }

        .stylist-card.selected {
            border-color: var(--brand-pink);
            background: linear-gradient(135deg, rgba(246, 117, 153, 0.03) 0%, rgba(246, 117, 153, 0.08) 100%);
            box-shadow: 0 8px 24px rgba(246, 117, 153, 0.25);
            transform: translateY(-4px) scale(1.02);
        }

        .stylist-card.favorite {
            border-color: var(--brand-pink);
            background: linear-gradient(135deg, rgba(246, 117, 153, 0.05) 0%, transparent 100%);
        }

        .favorite-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--brand-pink);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .stylist-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            color: white;
            margin: 0 auto 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .stylist-avatar-small {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            color: white;
            background: var(--brand-pink);
        }

        .stylist-info {
            text-align: center;
        }

        .stylist-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--primary-black);
        }

        .stylist-specialty {
            font-size: 13px;
            color: var(--gray-medium);
            margin-bottom: 10px;
        }

        .stylist-badges {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 10px 0;
        }

        .badge-specialty {
            background: var(--gray-light);
            color: var(--gray-dark);
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .stylist-rating {
            font-size: 14px;
            color: var(--gray-dark);
            margin: 8px 0;
        }

        .stylist-availability {
            font-size: 13px;
            color: var(--success);
            font-weight: 500;
        }

        /* Modern Progress Indicator with Connecting Lines */
        .booking-progress {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 35px;
            position: relative;
            padding: 0 20px;
        }

        .booking-progress::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 60px;
            right: 60px;
            height: 3px;
            background: linear-gradient(to right,
                var(--gray-light) 0%,
                var(--gray-light) 100%);
            z-index: 0;
        }

        .booking-progress.step-1::before {
            background: linear-gradient(to right,
                var(--brand-pink) 0%,
                var(--gray-light) 25%,
                var(--gray-light) 100%);
        }

        .booking-progress.step-2::before {
            background: linear-gradient(to right,
                var(--brand-pink) 0%,
                var(--brand-pink) 25%,
                var(--brand-pink) 50%,
                var(--gray-light) 50%,
                var(--gray-light) 100%);
        }

        .booking-progress.step-3::before {
            background: linear-gradient(to right,
                var(--brand-pink) 0%,
                var(--brand-pink) 75%,
                var(--gray-light) 75%,
                var(--gray-light) 100%);
        }

        .booking-progress.step-4::before {
            background: linear-gradient(to right,
                var(--brand-pink) 0%,
                var(--brand-pink) 100%);
        }

        .progress-step {
            flex: 1;
            text-align: center;
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .progress-step-circle {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: white;
            border: 3px solid var(--gray-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
            color: var(--gray-medium);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .progress-step-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--gray-medium);
            transition: all 0.3s;
        }

        .progress-step.active .progress-step-circle {
            background: var(--brand-gradient);
            border-color: var(--brand-pink);
            color: white;
            box-shadow: 0 4px 16px rgba(246, 117, 153, 0.4);
            transform: scale(1.1);
        }

        .progress-step.active .progress-step-label {
            color: var(--brand-pink);
            font-weight: 700;
        }

        .progress-step.completed .progress-step-circle {
            background: var(--brand-pink);
            border-color: var(--brand-pink);
            color: white;
        }

        .progress-step.completed .progress-step-label {
            color: var(--gray-dark);
        }

        .selected-stylist-banner {
            background: var(--gray-light);
            padding: 15px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .service-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .service-card {
            background: white;
            border: 2px solid transparent;
            border-radius: 16px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
            position: relative;
        }

        .service-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 16px;
            padding: 2px;
            background: linear-gradient(135deg, transparent 0%, transparent 100%);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0;
            transition: opacity 0.4s;
        }

        .service-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .service-content {
            padding: 18px;
        }

        .service-card.selected {
            border-color: var(--brand-pink);
            background: linear-gradient(135deg, rgba(246, 117, 153, 0.03) 0%, rgba(246, 117, 153, 0.08) 100%);
            box-shadow: 0 8px 24px rgba(246, 117, 153, 0.25);
            transform: translateY(-4px) scale(1.02);
        }

        .service-card.selected::before {
            opacity: 1;
            background: var(--brand-gradient);
        }

        .service-card.selected .service-image {
            transform: scale(1.05);
        }

        .service-card:hover {
            transform: translateY(-6px) scale(1.01);
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.12);
            border-color: var(--brand-pink);
        }

        .service-card:hover .service-image {
            transform: scale(1.08);
        }

        .service-name {
            font-weight: 600;
            margin-top: 10px;
            margin-bottom: 5px;
        }

        .service-duration {
            color: var(--gray-medium);
            font-size: 13px;
        }

        .service-price {
            color: var(--brand-pink);
            font-weight: 600;
            margin-top: 10px;
            font-size: 18px;
        }

        /* Calendar */
        .calendar-container {
            margin: 15px 0;
            max-width: 420px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 0 4px;
        }

        .calendar-month {
            font-weight: 600;
            font-size: 15px;
            color: var(--text-dark);
        }

        .calendar-nav {
            background: white;
            border: 1px solid var(--gray-light);
            padding: 5px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 16px;
            color: var(--text-dark);
        }

        .calendar-nav:hover {
            background: var(--gray-light);
            border-color: var(--gray-medium);
        }

        .calendar-nav:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px;
        }

        .calendar-day {
            min-height: 36px;
            max-height: 40px;
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            background: white;
        }

        .calendar-day.disabled {
            opacity: 0.25;
            cursor: not-allowed;
            background: transparent;
        }

        .calendar-day.selected {
            background: var(--brand-pink);
            color: white;
            font-weight: 600;
            border-color: var(--brand-pink);
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(246, 117, 153, 0.25);
        }

        .calendar-day:hover:not(.disabled):not(.selected) {
            background: rgba(246, 117, 153, 0.08);
            border-color: rgba(246, 117, 153, 0.3);
            transform: scale(1.02);
        }

        .time-slots {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .time-slot {
            padding: 14px 16px;
            border: 2px solid var(--border-soft);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 15px;
            font-weight: 600;
            background: white;
            position: relative;
            overflow: hidden;
        }

        .time-slot::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: var(--brand-gradient);
            transition: left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 0;
        }

        .time-slot span {
            position: relative;
            z-index: 1;
        }

        .time-slot.selected {
            background: var(--brand-gradient);
            color: white;
            border-color: var(--brand-pink);
            box-shadow: 0 4px 16px rgba(246, 117, 153, 0.3);
            transform: scale(1.05);
        }

        .time-slot.selected::before {
            left: 0;
        }

        .time-slot:hover:not(.selected):not(.unavailable) {
            border-color: var(--brand-pink);
            background: rgba(246, 117, 153, 0.05);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .time-slot.unavailable {
            background: var(--surface-muted);
            color: var(--gray-medium);
            border-color: var(--border-soft);
            cursor: not-allowed;
            opacity: 0.4;
            text-decoration: line-through;
        }

        .time-slot.unavailable:hover {
            transform: none;
            box-shadow: none;
        }

        /* Products */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .product-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 2px 10px var(--shadow);
            transition: transform 0.3s;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .product-card:hover {
            transform: translateY(-5px);
        }

        .product-image {
            width: 100%;
            height: 200px;
            object-fit: contain;
            background: white;
            padding: 20px;
        }

        .product-info {
            padding: 15px;
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .product-name {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 15px;
        }

        .product-description {
            color: var(--gray-medium);
            font-size: 13px;
            margin-bottom: 10px;
            flex: 1;
        }

        .product-price {
            font-size: 18px;
            font-weight: 600;
            color: var(--brand-pink);
            margin-bottom: 10px;
        }

        .product-rating {
            color: var(--brand-pink);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .product-rating svg {
            width: 14px;
            height: 14px;
            fill: var(--brand-pink);
            stroke: none;
        }

        /* Buttons - Brand Styled */
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 4px;
            font-family: 'Josefin Sans', Arial, sans-serif;
            font-size: 14px;
            font-weight: 400;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 10px;
        }

        .btn-primary {
            background: var(--brand-pink);
            color: white;
        }

        .btn-primary:hover {
            background: var(--brand-pink-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(246, 117, 153, 0.3);
        }

        .btn-secondary {
            background: var(--brand-charcoal);
            color: white;
        }

        .btn-secondary:hover {
            background: #2d2d2e;
            transform: translateY(-2px);
        }

        .btn-outline {
            background: transparent;
            color: var(--brand-charcoal);
            border: 2px solid var(--brand-charcoal);
        }

        .btn-outline:hover {
            background: var(--brand-charcoal);
            color: white;
        }

        .btn-pink-outline {
            background: transparent;
            color: var(--brand-pink);
            border: 2px solid var(--brand-pink);
        }

        .btn-pink-outline:hover {
            background: var(--brand-pink);
            color: white;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            width: auto;
        }

        /* Referral Section */
        .referral-code-box {
            background: linear-gradient(135deg, var(--brand-pink) 0%, var(--brand-pink-dark) 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
        }

        .referral-code {
            font-size: 32px;
            font-weight: bold;
            letter-spacing: 3px;
            margin: 20px 0;
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
        }

        .share-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .share-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid white;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .share-btn:hover {
            background: white;
            color: var(--brand-pink);
            transform: scale(1.1);
        }

        .referral-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: var(--brand-pink);
        }

        .stat-label {
            color: var(--gray-medium);
            font-size: 14px;
            margin-top: 5px;
        }

        /* Profile Section */
        .profile-header {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, var(--primary-black) 0%, var(--gray-dark) 100%);
            color: white;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: var(--brand-pink);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            margin: 0 auto 15px;
            border: 5px solid white;
        }

        .profile-name {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .profile-tier {
            color: var(--brand-pink);
            font-size: 16px;
        }

        .menu-list {
            list-style: none;
        }

        .menu-item {
            background: white;
            padding: 18px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .menu-item:hover {
            background: var(--gray-light);
            transform: translateX(5px);
        }

        .menu-item-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .menu-icon {
            color: var(--brand-pink);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
        }

        .menu-icon svg {
            width: 24px;
            height: 24px;
        }

        .menu-text {
            font-weight: 500;
        }

        /* Hair Tracker */
        .tracker-progress {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .progress-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: conic-gradient(var(--brand-pink) 0deg 252deg, var(--gray-light) 252deg 360deg);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            position: relative;
        }

        .progress-circle::before {
            content: '';
            position: absolute;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: white;
        }

        .progress-text {
            position: relative;
            z-index: 1;
            text-align: center;
        }

        .progress-days {
            font-size: 36px;
            font-weight: bold;
            color: var(--brand-pink);
        }

        .progress-label {
            font-size: 14px;
            color: var(--gray-medium);
        }

        .tracker-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .tracker-stat {
            padding: 15px;
            background: var(--gray-light);
            border-radius: 10px;
            text-align: center;
        }

        /* Notifications */
        .notification-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border: 1px solid var(--border-soft);
            cursor: default;
            transition: all 0.3s;
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .notification-item:hover {
            transform: translateX(4px);
            box-shadow: 0 3px 10px var(--shadow);
        }

        .notification-rail {
            width: 4px;
            border-radius: 4px;
            height: 100%;
        }

        .notification-content {
            flex: 1;
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .notification-title {
            font-weight: 600;
            font-size: 15px;
        }

        .notification-time {
            color: var(--gray-medium);
            font-size: 12px;
        }

        .notification-message {
            color: var(--gray-medium);
            font-size: 14px;
        }

        .notification-empty {
            text-align: center;
            color: var(--text-subtle);
            padding: 40px 0;
            font-size: 14px;
        }

        /* Appointment Card */
        .appointment-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            border-left: 5px solid var(--brand-pink);
        }

        .appointment-date {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-black);
            margin-bottom: 10px;
        }

        .appointment-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .appointment-info {
            flex: 1;
        }

        .appointment-service {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .appointment-time {
            color: var(--gray-medium);
            font-size: 14px;
        }

        .appointment-actions {
            display: flex;
            gap: 10px;
        }

        /* Modal */
        /* Toast Notifications - Brand Styled */
        .toast-container {
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 380px;
            width: calc(100% - 40px);
        }

        .toast {
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            padding: 0;
            display: flex;
            overflow: hidden;
            animation: toastSlideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            transform-origin: top right;
        }

        .toast.hiding {
            animation: toastSlideOut 0.3s ease forwards;
        }

        @keyframes toastSlideIn {
            from {
                transform: translateX(100%) scale(0.8);
                opacity: 0;
            }
            to {
                transform: translateX(0) scale(1);
                opacity: 1;
            }
        }

        @keyframes toastSlideOut {
            to {
                transform: translateX(100%) scale(0.8);
                opacity: 0;
            }
        }

        .toast-accent {
            width: 6px;
            flex-shrink: 0;
        }

        .toast-accent.success { background: linear-gradient(180deg, var(--success) 0%, #3b8e3d 100%); }
        .toast-accent.error { background: linear-gradient(180deg, var(--danger) 0%, #c0392b 100%); }
        .toast-accent.warning { background: linear-gradient(180deg, var(--warning) 0%, #f57c00 100%); }
        .toast-accent.info { background: var(--brand-gradient); }
        .toast-accent.promo { background: var(--brand-gradient); }

        .toast-body {
            flex: 1;
            padding: 16px;
            display: flex;
            gap: 14px;
            align-items: flex-start;
        }

        .toast-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .toast-icon.success { background: rgba(76, 175, 80, 0.1); }
        .toast-icon.error { background: rgba(244, 67, 54, 0.1); }
        .toast-icon.warning { background: rgba(255, 152, 0, 0.1); }
        .toast-icon.info { background: rgba(246, 117, 153, 0.1); }
        .toast-icon.promo { background: linear-gradient(135deg, rgba(246, 117, 153, 0.15) 0%, rgba(156, 39, 176, 0.15) 100%); }

        .toast-content {
            flex: 1;
            min-width: 0;
        }

        .toast-title {
            font-family: 'Josefin Sans', Arial, sans-serif;
            font-size: 14px;
            font-weight: 600;
            color: var(--brand-charcoal);
            margin-bottom: 4px;
            letter-spacing: 0.02em;
        }

        .toast-message {
            font-size: 13px;
            color: var(--gray-medium);
            line-height: 1.4;
        }

        .toast-action {
            margin-top: 10px;
        }

        .toast-action-btn {
            background: var(--brand-pink);
            color: white;
            border: none;
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toast-action-btn:hover {
            background: var(--brand-pink-dark);
            transform: translateY(-1px);
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--gray-medium);
            cursor: pointer;
            padding: 4px;
            font-size: 18px;
            line-height: 1;
            opacity: 0.5;
            transition: opacity 0.2s;
        }

        .toast-close:hover {
            opacity: 1;
        }

        .toast-progress {
            height: 3px;
            background: var(--gray-light);
            position: relative;
            overflow: hidden;
        }

        .toast-progress-bar {
            height: 100%;
            background: var(--brand-pink);
            animation: toastProgress 5s linear forwards;
        }

        @keyframes toastProgress {
            from { width: 100%; }
            to { width: 0%; }
        }

        /* Modal Styles - Brand Updated */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(65, 64, 66, 0.85);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(4px);
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideUp 0.3s ease;
        }

        @keyframes modalSlideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 22px;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--gray-medium);
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--gray-dark);
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--gray-light);
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--brand-pink);
        }


        /* Gallery Grid */
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .gallery-item {
            aspect-ratio: 1;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .gallery-item:hover {
            transform: scale(1.02);
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .gallery-label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.7));
            color: white;
            padding: 20px 10px 8px;
            font-size: 12px;
            font-weight: 500;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
            }

            .booking-type-cards {
                grid-template-columns: 1fr;
            }

            .booking-type-image {
                height: 180px;
            }

            .stylist-grid {
                grid-template-columns: 1fr;
            }

            .booking-progress {
                padding: 0 10px;
            }

            .booking-progress::before {
                left: 40px;
                right: 40px;
                top: 18px;
            }

            .progress-step-circle {
                width: 36px;
                height: 36px;
                font-size: 12px;
            }

            .progress-step-label {
                font-size: 10px;
            }

            .selected-stylist-banner {
                flex-direction: column;
                gap: 10px;
            }

            .service-grid {
                grid-template-columns: 1fr;
            }

            .product-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .referral-stats {
                grid-template-columns: 1fr;
            }

            .welcome-title {
                font-size: 20px;
            }

            .section-title {
                font-size: 18px;
            }

            .nav-tabs {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                top: auto;
                background: white;
                box-shadow: 0 -2px 10px var(--shadow);
                padding: 8px 0 5px 0;
                border-bottom: none;
                border-top: 1px solid var(--gray-light);
            }

            .nav-tab {
                padding: 8px 5px;
                font-size: 11px;
                gap: 4px;
                min-width: 60px;
                border-bottom: none;
            }

            .nav-icon {
                width: 20px;
                height: 20px;
            }

            .nav-tab.active {
                border-bottom: none;
                background: rgba(231, 84, 128, 0.05);
                border-radius: 8px;
            }

            .content-area {
                padding-bottom: 80px;
            }
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid var(--gray-light);
            border-top: 4px solid var(--brand-pink);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Staff Team Section */
        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .team-card {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 5px 20px var(--shadow);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
        }

        .team-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 15px 40px rgba(231, 84, 128, 0.2);
        }

        .team-photo {
            width: 100%;
            height: 280px;
            object-fit: cover;
            object-position: center top;
        }

        .team-info {
            padding: 25px;
            text-align: center;
            position: relative;
        }

        .team-avatar-overlay {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--brand-pink) 0%, var(--brand-pink-dark) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: white;
            margin: -60px auto 15px;
            border: 5px solid white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .team-name {
            font-size: 22px;
            font-weight: 700;
            color: var(--primary-black);
            margin-bottom: 5px;
        }

        .team-role {
            color: var(--brand-pink);
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .team-tagline {
            font-style: italic;
            color: var(--gray-medium);
            font-size: 15px;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .team-specialties {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .team-specialty-tag {
            background: linear-gradient(135deg, rgba(231, 84, 128, 0.1) 0%, rgba(212, 175, 55, 0.1) 100%);
            color: var(--brand-pink);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .team-stats {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--gray-light);
        }

        .team-stat {
            text-align: center;
        }

        .team-stat-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--brand-pink);
        }

        .team-stat-label {
            font-size: 11px;
            color: var(--gray-medium);
            text-transform: uppercase;
        }

        .team-socials {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }

        .team-social-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--gray-light);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            font-size: 16px;
        }

        .team-social-btn:hover {
            background: var(--brand-pink);
            color: white;
            transform: scale(1.1);
        }

        /* Sales & Flash Sales */
        .flash-sale-banner {
            background: var(--brand-gradient);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.4); }
            50% { box-shadow: 0 0 0 15px rgba(255, 107, 107, 0); }
        }

        .flash-sale-timer {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        .timer-block {
            background: rgba(255,255,255,0.2);
            padding: 10px 15px;
            border-radius: 10px;
            text-align: center;
            min-width: 60px;
        }

        .timer-value {
            font-size: 24px;
            font-weight: bold;
        }

        .timer-label {
            font-size: 10px;
            text-transform: uppercase;
            opacity: 0.8;
        }

        .sale-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--brand-pink);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .original-price {
            text-decoration: line-through;
            opacity: 0.6;
            font-size: 14px;
        }

        .sale-price {
            color: var(--brand-pink);
            font-weight: bold;
        }

        /* Quick View Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .quick-view-modal {
            background: white;
            border-radius: 12px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: slideUp 0.3s ease;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .quick-view-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: white;
            border: none;
            font-size: 32px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            color: var(--text-default);
        }

        .quick-view-close:hover {
            background: var(--brand-pink);
            color: white;
            transform: rotate(90deg);
        }

        .quick-view-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            padding: 30px;
        }

        .quick-view-image-section {
            position: relative;
        }

        .quick-view-image {
            width: 100%;
            height: auto;
            border-radius: 8px;
            object-fit: cover;
            max-height: 500px;
        }

        .quick-view-details-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .quick-view-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 15px;
        }

        .quick-view-title {
            font-size: 28px;
            font-weight: 600;
            margin: 0 0 5px 0;
            color: var(--text-default);
        }

        .quick-view-category {
            font-size: 14px;
            color: var(--text-subtle);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 0;
        }

        .wishlist-btn {
            background: none;
            border: 2px solid var(--border-soft);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
            color: var(--text-subtle);
        }

        .wishlist-btn:hover {
            border-color: var(--brand-pink);
            color: var(--brand-pink);
            transform: scale(1.1);
        }

        .wishlist-btn.active {
            background: var(--brand-pink);
            border-color: var(--brand-pink);
            color: white;
        }

        .quick-view-price-section {
            padding: 15px 0;
            border-top: 1px solid var(--border-soft);
            border-bottom: 1px solid var(--border-soft);
        }

        .quick-view-price-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .quick-view-price {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-default);
        }

        .quick-view-original-price {
            font-size: 20px;
            text-decoration: line-through;
            color: var(--text-subtle);
        }

        .discount-badge {
            background: var(--brand-pink);
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .stock-status {
            font-size: 14px;
        }

        .quick-view-description {
            color: var(--text-subtle);
            line-height: 1.6;
            font-size: 15px;
        }

        .quick-view-actions {
            margin-top: auto;
        }

        .quantity-selector {
            margin-bottom: 15px;
        }

        .qty-btn {
            background: var(--surface-elevated);
            border: 1px solid var(--border-soft);
            width: 40px;
            height: 40px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 20px;
            font-weight: 600;
            transition: all 0.2s ease;
            color: var(--text-default);
        }

        .qty-btn:hover {
            background: var(--brand-pink);
            border-color: var(--brand-pink);
            color: white;
        }

        .quick-view-meta {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 20px;
            background: var(--surface-elevated);
            border-radius: 8px;
            margin-top: 20px;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: var(--text-subtle);
        }

        .meta-item svg {
            flex-shrink: 0;
        }

        /* Responsive Quick View */
        @media (max-width: 768px) {
            .quick-view-content {
                grid-template-columns: 1fr;
                gap: 20px;
                padding: 20px;
            }

            .quick-view-title {
                font-size: 22px;
            }

            .quick-view-price {
                font-size: 26px;
            }

            .quick-view-image {
                max-height: 350px;
            }
        }

        /* Cart & Checkout */
        .cart-modal {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            max-width: 100%;
            height: 100%;
            background: white;
            z-index: 1001;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
            box-shadow: -5px 0 30px rgba(0,0,0,0.2);
        }

        .cart-modal.open {
            right: 0;
        }

        .cart-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .cart-overlay.show {
            display: block;
        }

        .cart-header {
            padding: 20px;
            background: var(--primary-black);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cart-items {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .cart-item {
            display: flex;
            gap: 15px;
            padding: 15px 0;
            border-bottom: 1px solid var(--gray-light);
        }

        .cart-item-image {
            width: 70px;
            height: 70px;
            border-radius: 10px;
            object-fit: cover;
            background: var(--gray-light);
        }

        .cart-item-details {
            flex: 1;
        }

        .cart-item-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .cart-item-price {
            color: var(--brand-pink);
            font-weight: 600;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .qty-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid var(--gray-light);
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.2s;
        }

        .qty-btn:hover {
            border-color: var(--brand-pink);
            color: var(--brand-pink);
        }

        .cart-footer {
            padding: 20px;
            background: var(--gray-light);
            border-top: 1px solid var(--border-soft);
        }

        .cart-subtotal {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .cart-total {
            display: flex;
            justify-content: space-between;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            padding-top: 10px;
            border-top: 2px solid var(--primary-black);
        }

        /* Checkout */
        .checkout-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px var(--shadow);
        }

        .checkout-section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .delivery-options {
            display: grid;
            gap: 15px;
        }

        .delivery-option {
            border: 2px solid var(--gray-light);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .delivery-option:hover {
            border-color: var(--brand-pink);
        }

        .delivery-option.selected {
            border-color: var(--brand-pink);
            background: rgba(231, 84, 128, 0.05);
        }

        .delivery-info h4 {
            margin-bottom: 5px;
        }

        .delivery-info p {
            font-size: 13px;
            color: var(--gray-medium);
        }

        .delivery-price {
            font-weight: 600;
            color: var(--brand-pink);
        }

        .invoice-preview {
            background: var(--gray-light);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .invoice-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed var(--border-soft);
        }

        .invoice-row:last-child {
            border-bottom: none;
            padding-top: 15px;
            font-weight: bold;
            font-size: 18px;
        }

        .price-adjust {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .price-input {
            width: 100px;
            padding: 8px;
            border: 2px solid var(--gray-light);
            border-radius: 8px;
            text-align: right;
            font-weight: 600;
        }

        /* Chat Feature */
        .chat-fab {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--brand-pink) 0%, var(--brand-pink-dark) 100%);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(231, 84, 128, 0.4);
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .chat-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 30px rgba(231, 84, 128, 0.5);
        }

        .chat-fab svg {
            width: 28px;
            height: 28px;
        }

        .chat-notification {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            background: var(--brand-pink);
            border-radius: 50%;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .chat-window {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 380px;
            max-width: calc(100% - 40px);
            height: 500px;
            max-height: 70vh;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-window.open {
            display: flex;
            animation: chatSlideUp 0.3s ease;
        }

        @keyframes chatSlideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chat-header {
            background: linear-gradient(135deg, var(--brand-pink) 0%, var(--brand-pink-dark) 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .chat-status {
            font-size: 12px;
            opacity: 0.9;
        }

        .chat-status::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            margin-right: 5px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: var(--gray-light);
        }

        .chat-message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }

        .chat-message.received {
            align-items: flex-start;
        }

        .chat-message.sent {
            align-items: flex-end;
        }

        .message-bubble {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.4;
        }

        .chat-message.received .message-bubble {
            background: white;
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .chat-message.sent .message-bubble {
            background: var(--brand-pink);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message-time {
            font-size: 11px;
            color: var(--gray-medium);
            margin-top: 5px;
        }

        .chat-input-area {
            padding: 15px;
            background: white;
            border-top: 1px solid var(--gray-light);
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--gray-light);
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        .chat-input:focus {
            border-color: var(--brand-pink);
        }

        .chat-send-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--brand-pink);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .chat-send-btn:hover {
            background: var(--brand-pink-dark);
            transform: scale(1.05);
        }

        /* Photo Upload Feature */
        .photo-upload-section {
            background: linear-gradient(135deg, rgba(231, 84, 128, 0.05) 0%, rgba(212, 175, 55, 0.05) 100%);
            border: 2px dashed var(--brand-pink);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .photo-upload-section:hover {
            border-color: var(--brand-pink);
            background: rgba(246, 117, 153, 0.1);
        }

        .upload-icon {
            font-size: 50px;
            margin-bottom: 15px;
        }

        .upload-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary-black);
        }

        .upload-subtitle {
            color: var(--gray-medium);
            font-size: 14px;
            margin-bottom: 15px;
        }

        .inspo-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .inspo-item {
            aspect-ratio: 1;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .inspo-item:hover {
            transform: scale(1.05);
        }

        .inspo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .inspo-item-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.3s;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding: 10px;
        }

        .inspo-item:hover .inspo-item-overlay {
            opacity: 1;
        }

        .inspo-label {
            color: white;
            font-size: 12px;
            font-weight: 600;
        }

        .upload-preview {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .preview-thumb {
            width: 80px;
            height: 80px;
            border-radius: 10px;
            object-fit: cover;
            border: 3px solid var(--brand-pink);
        }

        @media (max-width: 768px) {
            .team-grid {
                grid-template-columns: 1fr;
            }

            .cart-modal {
                width: 100%;
                right: -100%;
            }

            .chat-window {
                width: 100%;
                height: 100%;
                max-height: 100%;
                bottom: 0;
                right: 0;
                border-radius: 0;
            }

            .chat-fab {
                bottom: 80px;
            }
        }

        /* Auth Modal Styles */
        .auth-tabs {
            display: flex;
            border-bottom: 2px solid var(--gray-light);
            margin-bottom: 20px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: var(--gray-medium);
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .auth-tab.active {
            color: var(--brand-pink);
            border-bottom-color: var(--brand-pink);
            font-weight: 600;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .auth-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--gray-light);
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 15px;
            transition: border-color 0.3s;
        }

        .auth-input:focus {
            outline: none;
            border-color: var(--brand-pink);
        }

        .auth-btn {
            width: 100%;
            padding: 16px;
            background: var(--brand-pink);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .auth-btn:hover {
            background: var(--brand-pink-dark);
        }

        .auth-btn:disabled {
            background: var(--gray-medium);
            cursor: not-allowed;
        }

        .auth-error {
            color: var(--brand-pink);
            font-size: 14px;
            margin-bottom: 15px;
            display: none;
        }

        .auth-error.show {
            display: block;
        }

        .guest-link {
            text-align: center;
            margin-top: 15px;
            color: var(--gray-medium);
            cursor: pointer;
        }

        .guest-link:hover {
            color: var(--brand-pink);
        }

        /* Loading spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Logged in vs logged out states */
        .logged-out-only {
            display: block;
        }

        .logged-in-only {
            display: none;
        }

        body.logged-in .logged-out-only {
            display: none;
        }

        body.logged-in .logged-in-only {
            display: block;
        }

        /* Time Window Selector Chips */
        .time-window-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 8px;
        }

        .time-window-chip {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px 12px;
            border: 2px solid var(--gray-light);
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .time-window-chip:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(246, 117, 153, 0.2);
        }

        .time-window-chip.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(246, 117, 153, 0.1) 0%, rgba(246, 117, 153, 0.05) 100%);
            box-shadow: 0 4px 12px rgba(246, 117, 153, 0.3);
        }

        .time-window-chip .icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .time-window-chip .label {
            font-weight: 600;
            color: var(--gray-dark);
            margin-bottom: 4px;
        }

        .time-window-chip .time-range {
            font-size: 13px;
            color: var(--gray);
        }

        .time-window-chip.selected .label {
            color: var(--primary);
        }

        /* Auth Gate / Welcome Screen - Redesigned for conversion */
        .auth-gate {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(160deg, #F67599 0%, #e05a7f 40%, #c94b6d 70%, #414042 100%);
            z-index: 10000;
            display: flex;
            flex-direction: row;
            opacity: 1;
            transition: opacity 0.5s ease, visibility 0.5s ease;
            overflow: hidden;
        }

        .auth-gate.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        /* Gallery/Instagram Side - Hidden on mobile */
        .auth-gate-gallery {
            display: none;
            width: 50%;
            position: relative;
            overflow: hidden;
            background: #fafafa;
        }

        /* Instant CSS-only pattern - no images, loads immediately */
        .auth-gate-gallery-pattern {
            width: 100%;
            height: 100%;
            background:
                /* Animated gradient overlay */
                linear-gradient(135deg, rgba(246,117,153,0.15) 0%, transparent 50%, rgba(206,147,216,0.15) 100%),
                /* Grid pattern */
                repeating-linear-gradient(0deg, transparent, transparent 49.5%, rgba(255,255,255,0.3) 49.5%, rgba(255,255,255,0.3) 50.5%, transparent 50.5%, transparent 100%),
                repeating-linear-gradient(90deg, transparent, transparent 49.5%, rgba(255,255,255,0.3) 49.5%, rgba(255,255,255,0.3) 50.5%, transparent 50.5%, transparent 100%),
                /* Base gradient - pink to purple tones */
                linear-gradient(135deg,
                    #fce4ec 0%,
                    #f8bbd9 15%,
                    #f48fb1 30%,
                    #f3e5f5 45%,
                    #e1bee7 60%,
                    #ce93d8 75%,
                    #f8bbd9 90%,
                    #fce4ec 100%
                );
            background-size: 100% 100%, 50% 33.33%, 50% 33.33%, 400% 400%;
            animation: authGalleryShift 15s ease infinite;
        }

        @keyframes authGalleryShift {
            0%, 100% { background-position: 0% 0%, 0% 0%, 0% 0%, 0% 50%; }
            25% { background-position: 0% 0%, 0% 0%, 0% 0%, 50% 50%; }
            50% { background-position: 0% 0%, 0% 0%, 0% 0%, 100% 50%; }
            75% { background-position: 0% 0%, 0% 0%, 0% 0%, 50% 100%; }
        }

        /* Hair silhouette decorations */
        .auth-gate-gallery-pattern::before {
            content: '';
            position: absolute;
            font-size: 120px;
            opacity: 0.08;
            top: 20%;
            left: 15%;
            transform: rotate(-15deg);
        }

        .auth-gate-gallery-pattern::after {
            content: '';
            position: absolute;
            font-size: 80px;
            opacity: 0.1;
            bottom: 25%;
            right: 20%;
            animation: sparkle 2s ease-in-out infinite;
        }

        @keyframes sparkle {
            0%, 100% { opacity: 0.1; transform: scale(1); }
            50% { opacity: 0.2; transform: scale(1.1); }
        }

        .auth-gate-gallery-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 30px 25px;
            background: linear-gradient(to top, rgba(65,64,66,0.95) 0%, rgba(65,64,66,0.7) 50%, transparent 100%);
            z-index: 10;
        }

        .auth-gate-gallery-text {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .auth-gate-gallery-hashtag {
            color: #FFD700;
            font-family: 'Josefin Sans', sans-serif;
            font-size: 24px;
            font-weight: 600;
            letter-spacing: 0.05em;
            text-decoration: none;
            transition: color 0.2s;
        }

        .auth-gate-gallery-hashtag:hover {
            color: #FFA500;
        }

        .auth-gate-gallery-label {
            color: rgba(255,255,255,0.9);
            font-size: 12px;
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        /* Main Content Side */
        .auth-gate-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px 20px;
            overflow: hidden;
        }

        .auth-gate-content {
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        .auth-gate-logo {
            margin-bottom: 4px;
        }

        /* Text-based logo */
        .auth-gate-logo-text {
            font-family: 'Josefin Sans', sans-serif;
            font-size: 48px;
            font-weight: 300;
            letter-spacing: 0.15em;
            color: white;
            text-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .auth-gate-logo-dot {
            color: #FFD700;
            font-weight: 600;
        }

        /* Desktop: Show gallery and adjust layout */
        @media (min-width: 900px) {
            .auth-gate-gallery {
                display: block;
            }

            .auth-gate-main {
                width: 50%;
            }

            .auth-gate-logo-text {
                font-size: 52px;
            }
        }

        /* Large desktop */
        @media (min-width: 1200px) {
            .auth-gate-gallery {
                width: 55%;
            }

            .auth-gate-main {
                width: 45%;
            }

            .auth-gate-logo-text {
                font-size: 60px;
            }

            .auth-gate-content {
                max-width: 440px;
            }
        }

        .auth-gate-tagline {
            color: rgba(255,255,255,0.85);
            font-family: 'Josefin Sans', sans-serif;
            font-size: 10px;
            letter-spacing: 0.25em;
            text-transform: uppercase;
            margin-bottom: 12px;
        }

        /* Social proof banner */
        .auth-gate-social-proof {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-radius: 50px;
            padding: 6px 14px;
            margin-bottom: 12px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .auth-gate-avatars {
            display: flex;
            margin-right: 3px;
        }

        .auth-gate-avatars span {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.3);
            margin-right: -8px;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .auth-gate-social-text {
            color: white;
            font-size: 11px;
            font-weight: 500;
        }

        .auth-gate-social-text strong {
            color: #FFD700;
        }

        /* Hero section with emotional appeal */
        .auth-gate-hero {
            margin-bottom: 12px;
        }

        .auth-gate-hero h1 {
            color: white;
            font-family: 'Josefin Sans', sans-serif;
            font-size: 26px;
            font-weight: 300;
            letter-spacing: 0.05em;
            margin-bottom: 6px;
            line-height: 1.2;
        }

        .auth-gate-hero h1 .highlight {
            color: #FFD700;
            font-weight: 400;
        }

        .auth-gate-hero p {
            color: rgba(255,255,255,0.9);
            font-size: 13px;
            line-height: 1.5;
            margin-bottom: 0;
        }

        /* Benefits cards with specific value props */
        .auth-gate-benefits {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }

        .auth-gate-benefit {
            background: rgba(255,255,255,0.12);
            backdrop-filter: blur(5px);
            border-radius: 12px;
            padding: 10px 10px;
            text-align: left;
            border: 1px solid rgba(255,255,255,0.1);
            transition: transform 0.2s, background 0.2s;
        }

        .auth-gate-benefit:hover {
            transform: translateY(-2px);
            background: rgba(255,255,255,0.18);
        }

        .auth-gate-benefit-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .auth-gate-benefit-title {
            color: white;
            font-size: 12px;
            font-weight: 700;
            margin-bottom: 2px;
        }

        .auth-gate-benefit-desc {
            color: rgba(255,255,255,0.75);
            font-size: 10px;
            line-height: 1.3;
        }

        /* Limited time offer - urgency */
        .auth-gate-offer {
            background: linear-gradient(90deg, #FFD700, #FFA500);
            border-radius: 10px;
            padding: 10px 16px;
            margin-bottom: 12px;
            position: relative;
            overflow: hidden;
        }

        .auth-gate-offer::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            100% { left: 100%; }
        }

        .auth-gate-offer-text {
            color: #414042;
            font-size: 12px;
            font-weight: 700;
            position: relative;
            z-index: 1;
        }

        .auth-gate-offer-text .points {
            font-size: 14px;
            color: #c94b6d;
        }

        /* Testimonial */
        .auth-gate-testimonial {
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            padding: 10px 12px;
            margin-bottom: 12px;
            position: relative;
        }

        .auth-gate-testimonial::before {
            content: '"';
            position: absolute;
            top: 4px;
            left: 8px;
            font-size: 28px;
            color: rgba(255,255,255,0.2);
            font-family: Georgia, serif;
            line-height: 1;
        }

        .auth-gate-testimonial-text {
            color: rgba(255,255,255,0.95);
            font-size: 11px;
            font-style: italic;
            line-height: 1.4;
            margin-bottom: 6px;
            padding-left: 16px;
        }

        .auth-gate-testimonial-author {
            display: flex;
            align-items: center;
            gap: 8px;
            padding-left: 16px;
        }

        .auth-gate-testimonial-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .auth-gate-testimonial-info {
            text-align: left;
        }

        .auth-gate-testimonial-name {
            color: white;
            font-size: 11px;
            font-weight: 600;
        }

        .auth-gate-testimonial-detail {
            color: rgba(255,255,255,0.7);
            font-size: 9px;
        }

        .auth-gate-testimonial-stars {
            color: #FFD700;
            font-size: 10px;
            margin-left: auto;
        }

        /* CTA Buttons */
        .auth-gate-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 10px;
        }

        .auth-gate-btn {
            padding: 14px 24px;
            border-radius: 25px;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            position: relative;
            overflow: hidden;
        }

        .auth-gate-btn-primary {
            background: white;
            color: #c94b6d;
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }

        .auth-gate-btn-primary::after {
            content: ' ';
        }

        .auth-gate-btn-primary:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 35px rgba(0,0,0,0.25);
        }

        .auth-gate-btn-secondary {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 2px solid rgba(255,255,255,0.4);
        }

        .auth-gate-btn-secondary:hover {
            border-color: white;
            background: rgba(255,255,255,0.2);
        }

        /* Trust badges */
        .auth-gate-trust {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }

        .auth-gate-trust-item {
            display: flex;
            align-items: center;
            gap: 4px;
            color: rgba(255,255,255,0.7);
            font-size: 9px;
        }

        .auth-gate-trust-icon {
            font-size: 11px;
        }

        .auth-gate-footer {
            color: rgba(255,255,255,0.5);
            font-size: 9px;
        }

        .auth-gate-footer a {
            color: rgba(255,255,255,0.7);
            text-decoration: underline;
        }

        /* Floating elements for visual interest - only on main side */
        .auth-gate-main::after {
            content: '';
            position: absolute;
            top: 10%;
            right: -5%;
            width: 150px;
            height: 150px;
            background: radial-gradient(circle, rgba(255,215,0,0.1) 0%, transparent 70%);
            border-radius: 50%;
            pointer-events: none;
        }

        .auth-gate-main::before {
            content: '';
            position: absolute;
            bottom: 15%;
            left: -10%;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, transparent 70%);
            border-radius: 50%;
            pointer-events: none;
        }

        @media (max-width: 400px) {
            .auth-gate-benefits {
                grid-template-columns: 1fr;
            }
            .auth-gate-hero h1 {
                font-size: 22px;
            }
            .auth-gate-logo-text {
                font-size: 38px;
            }
        }
    </style>

    <!-- Booking Constants (shared with backend) -->
    <script src="/shared/booking-constants.js"></script>
</head>
<body>
    <!-- Auth Gate / Welcome Screen -->
    <div class="auth-gate" id="authGate">
        <!-- Gallery Side (Desktop Only) - Instant gradient pattern, no external images -->
        <div class="auth-gate-gallery">
            <div class="auth-gate-gallery-pattern" id="authGateGallery">
                <!-- Pure CSS pattern - loads instantly, no network requests -->
            </div>
            <div class="auth-gate-gallery-overlay">
                <div class="auth-gate-gallery-text">
                    <a href="https://www.instagram.com/flirthairsa/" target="_blank" class="auth-gate-gallery-hashtag">@flirthairsa</a>
                    <span class="auth-gate-gallery-label">Real Results from Real Clients</span>
                </div>
            </div>
        </div>

        <!-- Main Content Side -->
        <div class="auth-gate-main">
        <div class="auth-gate-content">
            <div class="auth-gate-logo">
                <span class="auth-gate-logo-text">FL<span class="auth-gate-logo-dot">!</span>RT</span>
            </div>
            <div class="auth-gate-tagline">Premium Hair Extensions</div>

            <!-- Social Proof Banner -->
            <div class="auth-gate-social-proof">
                <div class="auth-gate-avatars">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <div class="auth-gate-social-text">
                    <strong>2,500+</strong> happy clients this year
                </div>
            </div>

            <!-- Emotional Hero -->
            <div class="auth-gate-hero">
                <h1>Feel <span class="highlight">Confident</span> in Your Hair</h1>
                <p>Join thousands of women who've transformed their look with premium extensions & expert styling</p>
            </div>

            <!-- Value Proposition Benefits -->
            <div class="auth-gate-benefits">
                <div class="auth-gate-benefit">
                    <div class="auth-gate-benefit-icon"></div>
                    <div class="auth-gate-benefit-title">Book in 30 Seconds</div>
                    <div class="auth-gate-benefit-desc">Skip the phone calls. Book your perfect slot instantly</div>
                </div>
                <div class="auth-gate-benefit">
                    <div class="auth-gate-benefit-icon"></div>
                    <div class="auth-gate-benefit-title">Earn Free Services</div>
                    <div class="auth-gate-benefit-desc">Collect points with every visit & unlock rewards</div>
                </div>
                <div class="auth-gate-benefit">
                    <div class="auth-gate-benefit-icon"></div>
                    <div class="auth-gate-benefit-title">VIP Treatment</div>
                    <div class="auth-gate-benefit-desc">Members get priority booking & exclusive offers</div>
                </div>
                <div class="auth-gate-benefit">
                    <div class="auth-gate-benefit-icon"></div>
                    <div class="auth-gate-benefit-title">Track Your Journey</div>
                    <div class="auth-gate-benefit-desc">See your hair transformation over time</div>
                </div>
            </div>

            <!-- Urgency/FOMO Offer -->
            <div class="auth-gate-offer">
                <div class="auth-gate-offer-text">
                     Sign up today & get <span class="points">50 FREE points</span> towards your first reward!
                </div>
            </div>

            <!-- Social Proof Testimonial -->
            <div class="auth-gate-testimonial">
                <div class="auth-gate-testimonial-text">
                    Best decision ever! The app makes booking so easy, and I've already earned a free maintenance session from my points.
                </div>
                <div class="auth-gate-testimonial-author">
                    <div class="auth-gate-testimonial-avatar"></div>
                    <div class="auth-gate-testimonial-info">
                        <div class="auth-gate-testimonial-name">Thandi M.</div>
                        <div class="auth-gate-testimonial-detail">Gold Member  Pretoria</div>
                    </div>
                    <div class="auth-gate-testimonial-stars"></div>
                </div>
            </div>

            <!-- CTA Buttons -->
            <div class="auth-gate-buttons">
                <button class="auth-gate-btn auth-gate-btn-primary" onclick="showAuthGateSignup()">
                    Get Started Free
                </button>
                <button class="auth-gate-btn auth-gate-btn-secondary" onclick="showAuthGateLogin()">
                    I Have an Account
                </button>
            </div>

            <!-- Trust Signals -->
            <div class="auth-gate-trust">
                <div class="auth-gate-trust-item">
                    <span class="auth-gate-trust-icon"></span>
                    <span>Secure & Private</span>
                </div>
                <div class="auth-gate-trust-item">
                    <span class="auth-gate-trust-icon"></span>
                    <span>Takes 30 seconds</span>
                </div>
                <div class="auth-gate-trust-item">
                    <span class="auth-gate-trust-icon"></span>
                    <span>No card required</span>
                </div>
            </div>

            <div class="auth-gate-footer">
                <p>By continuing, you agree to our <a href="#">Terms</a> & <a href="#">Privacy Policy</a></p>
            </div>
        </div>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div class="toast-container" id="toastContainer"></div>

    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="logo"><img src="Flirt pink logo 2.jpeg" alt="FL!RT Hair & Beauty Bar"></div>
            <div class="header-center">
                <span class="header-tagline">Premium Hair Extensions</span>
            </div>
            <div class="header-icons">
                <button class="icon-btn" onclick="showNotifications()" title="Notifications">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                    </svg>
                    <span class="badge" id="notificationBadge" style="display: none;"></span>
                </button>
                <button class="icon-btn" onclick="showCart()" title="Shopping Cart">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="9" cy="21" r="1"></circle>
                        <circle cx="20" cy="21" r="1"></circle>
                        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                    </svg>
                    <span class="badge" id="cartCount">2</span>
                </button>
                <button class="icon-btn profile-btn" onclick="switchTab('profile')" title="My Profile">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                </button>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="nav-tabs">
            <button class="nav-tab active" data-tab="home" onclick="switchTab('home', event)">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
                <span>Home</span>
            </button>
            <button class="nav-tab" data-tab="booking" onclick="switchTab('booking', event)">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                <span>Book</span>
            </button>
            <button class="nav-tab" data-tab="shop" onclick="switchTab('shop', event)">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="9" cy="21" r="1"></circle>
                    <circle cx="20" cy="21" r="1"></circle>
                    <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                </svg>
                <span>Shop</span>
            </button>
            <button class="nav-tab" data-tab="rewards" onclick="switchTab('rewards', event)">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                </svg>
                <span>Rewards</span>
            </button>
            <button class="nav-tab" data-tab="team" onclick="switchTab('team', event)">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
                <span>Team</span>
            </button>
            <button class="nav-tab" data-tab="tracker" onclick="switchTab('tracker', event)">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path>
                    <path d="M22 12A10 10 0 0 0 12 2v10z"></path>
                </svg>
                <span>Tracker</span>
            </button>
            <button class="nav-tab" data-tab="profile" onclick="switchTab('profile', event)">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>
                <span>Profile</span>
            </button>
        </nav>

        <!-- Home Content -->
        <div id="home" class="content-area active">
            <!-- Hero Welcome Banner with CTA -->
            <div class="home-hero" id="welcomeBanner">
                <div class="home-hero-content">
                    <div class="home-hero-greeting" id="welcomeTitle">Welcome back! </div>
                    <h1 class="home-hero-headline">Ready for Your <span class="highlight">Hair Transformation</span>?</h1>
                    <p class="home-hero-subtitle" id="welcomeSubtitle">Book your next appointment and let our expert stylists work their magic</p>
                    <button class="home-hero-cta" onclick="navigateToSection('book')">
                        <span>Book Your Appointment</span>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                            <polyline points="12 5 19 12 12 19"></polyline>
                        </svg>
                    </button>
                </div>
                <div class="home-hero-stats" id="pointsDisplay" style="display: none;">
                    <div class="home-hero-stat">
                        <span class="home-hero-stat-value" id="bannerPoints">0</span>
                        <span class="home-hero-stat-label">Points</span>
                    </div>
                    <div class="home-hero-stat-divider"></div>
                    <div class="home-hero-stat">
                        <span class="home-hero-stat-value" id="bannerTier">Bronze</span>
                        <span class="home-hero-stat-label">Member</span>
                    </div>
                </div>
            </div>

            <!-- Three Key Actions Row -->
            <div class="home-actions-row">
                <!-- Hair Tracker Card -->
                <div class="home-action-card home-action-tracker" onclick="switchTab('tracker')">
                    <div class="home-action-icon-wrap tracker-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="28" height="28">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                    </div>
                    <div class="home-action-content">
                        <div class="home-action-title">Track Your Hair</div>
                        <div class="home-action-desc">Monitor your extension health & maintenance schedule</div>
                        <div class="home-action-link">View Tracker </div>
                    </div>
                </div>

                <!-- Share & Earn Card -->
                <div class="home-action-card home-action-share" onclick="switchTab('rewards')">
                    <div class="home-action-icon-wrap share-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="28" height="28">
                            <circle cx="18" cy="5" r="3"></circle>
                            <circle cx="6" cy="12" r="3"></circle>
                            <circle cx="18" cy="19" r="3"></circle>
                            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                        </svg>
                    </div>
                    <div class="home-action-content">
                        <div class="home-action-title">Share & Earn R100</div>
                        <div class="home-action-desc">Invite friends and both get rewarded!</div>
                        <div class="home-action-link">Get Your Code </div>
                    </div>
                </div>

                <!-- Shop Card -->
                <div class="home-action-card home-action-shop" onclick="switchTab('shop')">
                    <div class="home-action-icon-wrap shop-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="28" height="28">
                            <circle cx="9" cy="21" r="1"></circle>
                            <circle cx="20" cy="21" r="1"></circle>
                            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                        </svg>
                    </div>
                    <div class="home-action-content">
                        <div class="home-action-title">Shop Products</div>
                        <div class="home-action-desc">Premium hair care & extension products</div>
                        <div class="home-action-link">Browse Shop </div>
                    </div>
                </div>
            </div>

            <!-- Quick Book Services -->
            <div class="home-quick-book">
                <div class="section-header">
                    <h2 class="section-title">Quick Book</h2>
                    <a href="#" class="view-all-btn" onclick="navigateToSection('book'); return false;">View All Services</a>
                </div>
                <div class="home-services-scroll">
                    <div class="home-service-chip" onclick="quickBookService('hair')">
                        <span class="home-service-emoji"></span>
                        <span>Hair Extensions</span>
                    </div>
                    <div class="home-service-chip" onclick="quickBookService('nails')">
                        <span class="home-service-emoji"></span>
                        <span>Nails</span>
                    </div>
                    <div class="home-service-chip" onclick="quickBookService('lashes')">
                        <span class="home-service-emoji"></span>
                        <span>Lashes</span>
                    </div>
                    <div class="home-service-chip" onclick="quickBookService('makeup')">
                        <span class="home-service-emoji"></span>
                        <span>Makeup</span>
                    </div>
                    <div class="home-service-chip" onclick="quickBookService('facial')">
                        <span class="home-service-emoji"></span>
                        <span>Facials</span>
                    </div>
                </div>
            </div>

            <!-- Special Offers Section (dynamically loaded) -->
            <section id="specialOffersSection">
                <div class="section-header">
                    <h2 class="section-title">Special Offers</h2>
                    <a href="#" class="view-all-btn" id="viewAllOffersBtn">View All</a>
                </div>
                <div class="offers-list" id="specialOffersList">
                    <!-- Dynamic content injected by loadSpecialOffers() -->
                    <div class="offer-card" style="background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite;">
                        <div style="height: 14px; width: 60px; background: #ddd; border-radius: 4px; margin-bottom: 10px;"></div>
                        <div style="height: 18px; width: 120px; background: #ddd; border-radius: 4px; margin-bottom: 8px;"></div>
                        <div style="height: 12px; width: 100px; background: #ddd; border-radius: 4px;"></div>
                    </div>
                </div>
            </section>

            <div class="section-header">
                <h2 class="section-title">Upcoming Appointments</h2>
            </div>

            <!-- Dynamic Upcoming Appointments Container -->
            <div id="upcomingAppointmentsContainer">
                <!-- Loading state with skeleton animation -->
                <div class="appointment-card" style="background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite;">
                    <div style="height: 16px; width: 100px; background: #ddd; border-radius: 4px; margin-bottom: 8px;"></div>
                    <div style="height: 14px; width: 150px; background: #ddd; border-radius: 4px;"></div>
                </div>
            </div>
            <style>
                @keyframes shimmer {
                    0% { background-position: -200% 0; }
                    100% { background-position: 200% 0; }
                }
            </style>

            <div class="section-header">
                <h2 class="section-title">Gallery</h2>
            </div>

            <div class="gallery-grid" id="galleryGrid">
                <!-- Gallery items loaded dynamically -->
                <div class="gallery-item" style="display: flex; align-items: center; justify-content: center; background: var(--gray-light);">
                    <span style="color: var(--gray-medium);">Loading...</span>
                </div>
            </div>

            <!-- Instagram CTA Banner (fast, no embed) -->
            <div id="instagramFeedContainer" style="margin-top: 20px; display: none;">
                <a href="https://www.instagram.com/flirthairsa/" target="_blank" class="instagram-cta-banner" id="instagramBanner">
                    <div class="instagram-cta-icon">
                        <svg viewBox="0 0 24 24" width="32" height="32" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect>
                            <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path>
                            <line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line>
                        </svg>
                    </div>
                    <div class="instagram-cta-content">
                        <span class="instagram-cta-handle" id="instagramHandle">@flirthairsa</span>
                        <span class="instagram-cta-text">Follow us for daily hair inspiration</span>
                    </div>
                    <div class="instagram-cta-arrow"></div>
                </a>
            </div>
            <style>
                .instagram-cta-banner {
                    display: flex;
                    align-items: center;
                    gap: 16px;
                    padding: 16px 20px;
                    background: linear-gradient(135deg, #833AB4 0%, #FD1D1D 50%, #FCAF45 100%);
                    border-radius: 16px;
                    text-decoration: none;
                    color: white;
                    transition: transform 0.2s ease, box-shadow 0.2s ease;
                }
                .instagram-cta-banner:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 8px 25px rgba(131, 58, 180, 0.3);
                }
                .instagram-cta-banner:active {
                    transform: scale(0.98);
                }
                .instagram-cta-icon {
                    flex-shrink: 0;
                    opacity: 0.9;
                }
                .instagram-cta-content {
                    flex: 1;
                    display: flex;
                    flex-direction: column;
                    gap: 2px;
                }
                .instagram-cta-handle {
                    font-weight: 700;
                    font-size: 16px;
                }
                .instagram-cta-text {
                    font-size: 13px;
                    opacity: 0.9;
                }
                .instagram-cta-arrow {
                    font-size: 20px;
                    font-weight: 300;
                    opacity: 0.8;
                    transition: transform 0.2s ease;
                }
                .instagram-cta-banner:hover .instagram-cta-arrow {
                    transform: translateX(4px);
                }
            </style>

            <div class="section-header">
                <h2 class="section-title">Hair Care Tips</h2>
            </div>

            <div class="card" id="hairTipCard">
                <strong> Pro Tip:</strong>
                <p id="hairTipText" style="margin-top: 10px; color: var(--gray-medium);">
                    Loading...
                </p>
            </div>
        </div>

        <!-- Booking Content -->
        <div id="booking" class="content-area">
            <h2 class="section-title" style="margin-bottom: 20px;">Book Your Appointment</h2>

            <!-- Booking Type Selection -->
            <div id="bookingTypeSelection">
                <div class="booking-type-cards" id="bookingTypeCardsContainer">
                    <!-- Booking type cards will be dynamically loaded here -->
                    <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                        Loading available services...
                    </div>
                </div>
            </div>

            <!-- Step 1: Select Hair Service -->
            <div id="hairServiceSelection" style="display: none;">
                <div class="booking-progress step-1">
                    <div class="progress-step active">
                        <div class="progress-step-circle">1</div>
                        <div class="progress-step-label">Service</div>
                    </div>
                    <div class="progress-step">
                        <div class="progress-step-circle">2</div>
                        <div class="progress-step-label">Stylist</div>
                    </div>
                    <div class="progress-step">
                        <div class="progress-step-circle">3</div>
                        <div class="progress-step-label">Date</div>
                    </div>
                    <div class="progress-step">
                        <div class="progress-step-circle">4</div>
                        <div class="progress-step-label">Confirm</div>
                    </div>
                </div>

                <div class="section-header" style="margin-top: 20px;">
                    <h3 style="font-size: 18px;">Select Your Hair Service</h3>
                    <button class="btn btn-small btn-outline" onclick="changeBookingType()">Change Type</button>
                </div>

                <div class="service-grid" id="hairServicesGrid">
                    <!-- Dynamically populated from API -->
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--gray-medium);">
                        Loading services...
                    </div>
                </div>
            </div>

            <!-- Step 2: Select Stylist (After Service) -->
            <div id="stylistSelection" style="display: none;">
                <div class="booking-progress step-2">
                    <div class="progress-step completed">
                        <div class="progress-step-circle"></div>
                        <div class="progress-step-label">Service</div>
                    </div>
                    <div class="progress-step active">
                        <div class="progress-step-circle">2</div>
                        <div class="progress-step-label">Stylist</div>
                    </div>
                    <div class="progress-step">
                        <div class="progress-step-circle">3</div>
                        <div class="progress-step-label">Date</div>
                    </div>
                    <div class="progress-step">
                        <div class="progress-step-circle">4</div>
                        <div class="progress-step-label">Confirm</div>
                    </div>
                </div>

                <div style="background: var(--gray-light); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600;" id="selectedHairServiceNameBanner">Tape Extensions</div>
                            <div style="font-size: 13px; color: var(--gray-medium);" id="selectedHairServiceDetailsBanner">2-3 hours - R2,500</div>
                        </div>
                        <button class="btn btn-small btn-outline" onclick="goBackToHairService()">Change Service</button>
                    </div>
                </div>

                <div class="section-header">
                    <h3 style="font-size: 18px;">Choose Your Stylist</h3>
                    <div style="font-size: 13px; color: var(--gray-medium); margin-top: 5px;">Select the stylist you prefer to work with</div>
                </div>

                <div class="stylist-grid">
                    <div class="stylist-card" onclick="selectStylist('lisa')">
                        <div class="stylist-avatar" style="background: linear-gradient(135deg, #F67599 0%, #e05a7f 100%);">L</div>
                        <div class="stylist-info">
                            <div class="stylist-name">Lisa Thompson</div>
                            <div class="stylist-specialty">Senior Stylist  8 years exp</div>
                            <div class="stylist-badges">
                                <span class="badge-specialty">Tape Extensions</span>
                                <span class="badge-specialty">Weft</span>
                            </div>
                            <div class="stylist-rating"><svg viewBox="0 0 24 24" fill="#F67599" width="14" height="14"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg> 4.9 (127 reviews)</div>
                            <div class="stylist-availability"> Available this week</div>
                        </div>
                    </div>

                    <div class="stylist-card" onclick="selectStylist('emma')">
                        <div class="stylist-avatar" style="background: linear-gradient(135deg, var(--brand-pink) 0%, var(--brand-pink-dark) 100%);">E</div>
                        <div class="stylist-info">
                            <div class="stylist-name">Emma Williams</div>
                            <div class="stylist-specialty">Extension Specialist  6 years exp</div>
                            <div class="stylist-badges">
                                <span class="badge-specialty">Keratin Bonds</span>
                                <span class="badge-specialty">Volume</span>
                            </div>
                            <div class="stylist-rating"><svg viewBox="0 0 24 24" fill="#F67599" width="14" height="14"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg> 4.8 (94 reviews)</div>
                            <div class="stylist-availability"> Available this week</div>
                        </div>
                    </div>

                    <div class="stylist-card favorite" onclick="selectStylist('sarah')">
                        <div class="favorite-badge"><svg viewBox="0 0 24 24" fill="currentColor" width="12" height="12" style="margin-right: 4px;"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>Your Favorite</div>
                        <div class="stylist-avatar" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">S</div>
                        <div class="stylist-info">
                            <div class="stylist-name">Sarah Martinez</div>
                            <div class="stylist-specialty">Color Expert  10 years exp</div>
                            <div class="stylist-badges">
                                <span class="badge-specialty">Color Match</span>
                                <span class="badge-specialty">Balayage</span>
                            </div>
                            <div class="stylist-rating"><svg viewBox="0 0 24 24" fill="#F67599" width="14" height="14"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg> 5.0 (203 reviews)</div>
                            <div class="stylist-availability"> Available this week</div>
                        </div>
                    </div>

                    <div class="stylist-card" onclick="selectStylist('maya')">
                        <div class="stylist-avatar" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">M</div>
                        <div class="stylist-info">
                            <div class="stylist-name">Maya Johnson</div>
                            <div class="stylist-specialty">Maintenance Expert  5 years exp</div>
                            <div class="stylist-badges">
                                <span class="badge-specialty">Maintenance</span>
                                <span class="badge-specialty">Repair</span>
                            </div>
                            <div class="stylist-rating"><svg viewBox="0 0 24 24" fill="#F67599" width="14" height="14"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg> 4.9 (156 reviews)</div>
                            <div class="stylist-availability"> Available this week</div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Step 3: Select Date (Hair Extensions) -->
            <div class="card" id="bookingForm" style="display: none;">
                <div class="booking-progress step-3">
                    <div class="progress-step completed">
                        <div class="progress-step-circle"></div>
                        <div class="progress-step-label">Service</div>
                    </div>
                    <div class="progress-step completed">
                        <div class="progress-step-circle"></div>
                        <div class="progress-step-label">Stylist</div>
                    </div>
                    <div class="progress-step active">
                        <div class="progress-step-circle">3</div>
                        <div class="progress-step-label">Date</div>
                    </div>
                    <div class="progress-step">
                        <div class="progress-step-circle">4</div>
                        <div class="progress-step-label">Confirm</div>
                    </div>
                </div>

                <div class="selected-stylist-banner">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div class="stylist-avatar-small" id="selectedStylistAvatar2">S</div>
                        <div>
                            <div style="font-weight: 600;"><span id="selectedStylistName2">Sarah Martinez</span>'s Schedule</div>
                            <div style="font-size: 13px; color: var(--gray-medium);" id="selectedServiceName">Tape Extensions - R2,500</div>
                        </div>
                    </div>
                    <button class="btn btn-small btn-outline" onclick="goBackToStylist()">Change Stylist</button>
                </div>

                <div class="section-header" style="margin-top: 20px;">
                    <h3 style="font-size: 18px;">Select Preferred Date</h3>
                    <span style="font-size: 13px; color: var(--gray-medium);">Salon will confirm exact time</span>
                </div>

                <div class="calendar-container">
                    <div class="calendar-header">
                        <button class="calendar-nav" onclick="changeHairCalendarMonth(-1)"></button>
                        <div class="calendar-month" id="hairCalendarMonth">June 2024</div>
                        <button class="calendar-nav" onclick="changeHairCalendarMonth(1)"></button>
                    </div>
                    <div class="calendar-grid" id="calendarGrid">
                        <!-- Calendar will be generated by JS -->
                    </div>
                </div>

                <div class="card" style="background: linear-gradient(135deg, #fff5f8 0%, #ffe8ee 100%); border: 2px solid var(--brand-pink); margin: 20px 0;">
                    <div style="display: flex; gap: 15px; align-items: flex-start;">
                        <div style="font-size: 24px;"></div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: var(--primary-black); margin-bottom: 5px;">Time Confirmation</div>
                            <div style="font-size: 14px; color: var(--gray-dark);">
                                Our salon team will contact you within 24 hours to confirm the exact appointment time based on <span id="selectedStylistName3">Sarah</span>'s availability and your preferences.
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Preferred Time Window <span style="color: var(--primary);">*</span></label>
                    <div class="time-window-selector" id="timeWindowSelector">
                        <div class="time-window-chip" data-window="MORNING">
                            <div class="icon"></div>
                            <div class="label">Morning</div>
                            <div class="time-range">6:00 AM - 12:00 PM</div>
                        </div>
                        <div class="time-window-chip" data-window="AFTERNOON">
                            <div class="icon"></div>
                            <div class="label">Afternoon</div>
                            <div class="time-range">12:00 PM - 3:00 PM</div>
                        </div>
                        <div class="time-window-chip" data-window="LATE_AFTERNOON">
                            <div class="icon"></div>
                            <div class="label">Late Afternoon</div>
                            <div class="time-range">3:00 PM - 6:00 PM</div>
                        </div>
                        <div class="time-window-chip" data-window="EVENING">
                            <div class="icon"></div>
                            <div class="label">Evening</div>
                            <div class="time-range">6:00 PM - 10:00 PM</div>
                        </div>
                    </div>
                    <input type="hidden" id="requestedTimeWindow" value="">
                    <div style="font-size: 13px; color: var(--gray); margin-top: 8px;">
                        Select your preferred time window. We'll assign an exact time within 24 hours.
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Special Requests or Notes</label>
                    <textarea class="form-input" rows="3" placeholder="Any specific requirements, hair goals, time preferences, or questions for your stylist..."></textarea>
                </div>

                <button class="btn btn-primary" onclick="confirmBooking()">Submit Booking Request</button>
            </div>

            <!-- Beauty Salon Booking (No Stylist) -->
            <div id="beautyBooking" style="display: none;">
                <div class="booking-progress step-2">
                    <div class="progress-step completed">
                        <div class="progress-step-circle"></div>
                        <div class="progress-step-label">Type</div>
                    </div>
                    <div class="progress-step active">
                        <div class="progress-step-circle">2</div>
                        <div class="progress-step-label">Service</div>
                    </div>
                    <div class="progress-step">
                        <div class="progress-step-circle">3</div>
                        <div class="progress-step-label">Date & Time</div>
                    </div>
                    <div class="progress-step">
                        <div class="progress-step-circle">4</div>
                        <div class="progress-step-label">Confirm</div>
                    </div>
                </div>

                <div class="card" style="background: linear-gradient(135deg, rgba(231, 84, 128, 0.1) 0%, transparent 100%); margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600; margin-bottom: 5px;"> Beauty Salon Services</div>
                            <div style="font-size: 14px; color: var(--gray-medium);">Quick booking - no stylist selection needed</div>
                        </div>
                        <button class="btn btn-small btn-outline" onclick="changeBookingType()">Change Type</button>
                    </div>
                </div>

                <div class="section-header">
                    <h3 style="font-size: 18px;">Select Beauty Service</h3>
                    <input type="text" id="beautyServiceSearch" placeholder="Search services..."
                           style="max-width: 300px; padding: 8px 12px; border: 1px solid var(--gray-light); border-radius: 8px;"
                           oninput="filterBeautyServices()">
                </div>

                <div id="beautyCategoryFilter" style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; overflow-x: auto; padding-bottom: 10px;">
                    <!-- Category buttons will be generated dynamically -->
                </div>

                <div id="beautyServicesContainer">
                    <div style="text-align: center; padding: 40px; color: var(--gray-medium);">
                        Loading beauty services...
                    </div>
                </div>

                <div class="card" id="beautyBookingCalendar" style="display: none;">
                    <div class="booking-progress step-3">
                        <div class="progress-step completed">
                            <div class="progress-step-circle"></div>
                            <div class="progress-step-label">Type</div>
                        </div>
                        <div class="progress-step completed">
                            <div class="progress-step-circle"></div>
                            <div class="progress-step-label">Service</div>
                        </div>
                        <div class="progress-step active">
                            <div class="progress-step-circle">3</div>
                            <div class="progress-step-label">Date & Time</div>
                        </div>
                        <div class="progress-step">
                            <div class="progress-step-circle">4</div>
                            <div class="progress-step-label">Confirm</div>
                        </div>
                    </div>

                    <div style="background: var(--gray-light); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600;" id="selectedBeautyServiceName">Facial Treatment</div>
                                <div style="font-size: 13px; color: var(--gray-medium);" id="selectedBeautyServiceDetails">60 min - R450</div>
                            </div>
                            <button class="btn btn-small btn-outline" onclick="goBackToBeautyService()">Change Service</button>
                        </div>
                    </div>

                    <div class="section-header">
                        <h3 style="font-size: 18px;">Select Date</h3>
                    </div>

                    <div class="calendar-container">
                        <div class="calendar-header">
                            <button class="calendar-nav" onclick="changeBeautyCalendarMonth(-1)"></button>
                            <div class="calendar-month" id="beautyCalendarMonth">June 2024</div>
                            <button class="calendar-nav" onclick="changeBeautyCalendarMonth(1)"></button>
                        </div>
                        <div class="calendar-grid" id="beautyCalendarGrid">
                            <!-- Calendar will be generated by JS -->
                        </div>
                    </div>

                    <div class="section-header">
                        <h3 style="font-size: 18px;">Available Times</h3>
                        <span style="font-size: 13px; color: var(--gray-medium);">Next available therapist</span>
                    </div>

                    <div class="time-slots" id="beautyTimeSlots">
                        <div class="time-slot" onclick="selectBeautyTime(this)">08:00</div>
                        <div class="time-slot" onclick="selectBeautyTime(this)">09:00</div>
                        <div class="time-slot" onclick="selectBeautyTime(this)">10:00</div>
                        <div class="time-slot" onclick="selectBeautyTime(this)">11:00</div>
                        <div class="time-slot" onclick="selectBeautyTime(this)">12:00</div>
                        <div class="time-slot" onclick="selectBeautyTime(this)">13:00</div>
                        <div class="time-slot" onclick="selectBeautyTime(this)">14:00</div>
                        <div class="time-slot" onclick="selectBeautyTime(this)">15:00</div>
                        <div class="time-slot" onclick="selectBeautyTime(this)">16:00</div>
                        <div class="time-slot" onclick="selectBeautyTime(this)">17:00</div>
                        <div class="time-slot" onclick="selectBeautyTime(this)">18:00</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Special Requests or Notes</label>
                        <textarea class="form-input" rows="3" placeholder="Any specific requirements or preferences..."></textarea>
                    </div>

                    <button class="btn btn-primary" onclick="confirmBeautyBooking()">Confirm Booking</button>
                </div>
            </div>
        </div>

        <!-- Shop Content -->
        <div id="shop" class="content-area">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 class="section-title" style="margin: 0;">Shop Products</h2>
                <span id="productCount" style="color: var(--text-subtle); font-size: 14px;"></span>
            </div>

            <!-- Flash Sale Banner (Dynamic) -->
            <div id="flash-sale-banner" class="flash-sale-banner" style="display: none;"></div>

            <!-- Search & Sort Bar -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <div class="form-group" style="position: relative; flex: 1; margin: 0;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--gray-medium)" stroke-width="2" width="18" height="18" style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); pointer-events: none;">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    <input type="search" id="productSearchInput" class="form-input" placeholder="Search products..." style="padding-left: 42px;" oninput="searchProducts()">
                </div>
                <select id="sortProducts" class="form-control" style="width: auto; min-width: 150px;" onchange="sortProducts()">
                    <option value="featured">Featured</option>
                    <option value="price-low">Price: Low to High</option>
                    <option value="price-high">Price: High to Low</option>
                    <option value="name">Name: A-Z</option>
                    <option value="newest">Newest First</option>
                </select>
            </div>

            <!-- Product Count -->
            <div style="margin-bottom: 15px; color: var(--text-subtle); font-size: 14px;">
                <span id="productCount">Loading products...</span>
            </div>

            <!-- Category Filter Pills -->
            <div id="productCategoryFilters" style="display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px;">
                <!-- Dynamically populated from product categories -->
            </div>

            <!-- Sale Products Section -->
            <div id="saleProductsSection" class="section-header" style="display: none;">
                <h3 class="section-title" style="color: var(--brand-pink); display: flex; align-items: center; gap: 8px;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                    </svg>
                    Hot Deals
                </h3>
                <a href="#" class="view-all-btn" onclick="event.preventDefault(); filterProductsByCategory('sale')">View All Sales</a>
            </div>

            <div id="saleProductsGrid" class="product-grid" style="margin-bottom: 30px; display: none;">
                <!-- Sale products will be dynamically loaded here -->
            </div>

            <div class="section-header">
                <h3 class="section-title">All Products</h3>
            </div>

            <div id="allProductsGrid" class="product-grid">
                <!-- Products will be dynamically loaded here -->
                <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--text-subtle);">
                    Loading products...
                </div>
            </div>
        </div>

        <!-- Product Quick View Modal -->
        <div id="productQuickViewModal" class="modal-overlay" style="display: none;" onclick="closeQuickView(event)">
            <div class="quick-view-modal" onclick="event.stopPropagation()">
                <button class="quick-view-close" onclick="closeQuickView()">&times;</button>

                <div class="quick-view-content">
                    <!-- Left: Product Image -->
                    <div class="quick-view-image-section">
                        <img id="qv-image" src="" alt="" class="quick-view-image">
                        <div id="qv-badge-container" style="position: absolute; top: 15px; left: 15px;"></div>
                    </div>

                    <!-- Right: Product Details -->
                    <div class="quick-view-details-section">
                        <div class="quick-view-header">
                            <div>
                                <h2 id="qv-name" class="quick-view-title">Product Name</h2>
                                <p id="qv-category" class="quick-view-category">Category</p>
                            </div>
                            <button class="wishlist-btn" id="qv-wishlist-btn" onclick="toggleWishlistFromQuickView()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                                </svg>
                            </button>
                        </div>

                        <div class="quick-view-price-section">
                            <div class="quick-view-price-container">
                                <span id="qv-price" class="quick-view-price">R0</span>
                                <span id="qv-original-price" class="quick-view-original-price" style="display: none;">R0</span>
                                <span id="qv-discount-badge" class="discount-badge" style="display: none;">0% OFF</span>
                            </div>
                            <div id="qv-stock-status" class="stock-status"></div>
                        </div>

                        <div class="quick-view-description">
                            <p id="qv-description">Product description will appear here...</p>
                        </div>

                        <div class="quick-view-actions">
                            <div class="quantity-selector">
                                <label style="font-size: 14px; font-weight: 500; margin-bottom: 8px; display: block;">Quantity</label>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <button class="qty-btn" onclick="changeQuickViewQty(-1)">-</button>
                                    <input type="number" id="qv-quantity" value="1" min="1" readonly style="width: 60px; text-align: center; border: 1px solid var(--border-soft); border-radius: 4px; padding: 8px; font-size: 16px;">
                                    <button class="qty-btn" onclick="changeQuickViewQty(1)">+</button>
                                </div>
                            </div>

                            <button class="btn btn-primary btn-large" id="qv-add-to-cart-btn" onclick="addToCartFromQuickView()" style="width: 100%; margin-top: 15px; padding: 15px; font-size: 16px;">
                                Add to Cart
                            </button>

                            <button class="btn btn-outline btn-large" onclick="viewFullProductDetails()" style="width: 100%; margin-top: 10px; padding: 15px;">
                                View Full Details
                            </button>
                        </div>

                        <div class="quick-view-meta">
                            <div class="meta-item">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="12" cy="7" r="4"></circle>
                                </svg>
                                <span>Expert advice available</span>
                            </div>
                            <div class="meta-item">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                    <circle cx="12" cy="10" r="3"></circle>
                                </svg>
                                <span>Free delivery over R500</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rewards Content -->
        <div id="rewards" class="content-area">
            <h2 id="rewardsTitle" class="section-title" style="margin-bottom: 20px;">Rewards & Referrals</h2>

            <div class="referral-code-box">
                <div>Your Referral Code</div>
                <div class="referral-code" id="referralCodeDisplay"></div>
                <div id="referralSubheading" style="font-size: 14px; margin-top: 10px;">
                    Share with friends and you both save!
                </div>
                <div class="share-buttons">
                    <button class="share-btn" onclick="shareReferral('whatsapp')"></button>
                    <button class="share-btn" onclick="shareReferral('instagram')"></button>
                    <button class="share-btn" onclick="shareReferral('facebook')"></button>
                    <button class="share-btn" onclick="copyReferralCode()"></button>
                </div>
            </div>

            <div class="referral-stats">
                <div class="stat-card">
                    <div class="stat-number" id="referralCount">0</div>
                    <div class="stat-label">Referrals</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="referralEarned">R0</div>
                    <div class="stat-label">Earned</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="userPoints">0</div>
                    <div class="stat-label">Points</div>
                </div>
            </div>

            <div class="section-header" style="margin-top: 30px;">
                <h3 class="section-title">Loyalty Tiers</h3>
            </div>

            <div class="card" id="loyaltyTierCard">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div>
                        <strong style="color: var(--brand-pink);" id="userTierName"> Bronze Tier</strong>
                        <div style="font-size: 14px; color: var(--gray-medium);" id="userTierProgress">Loading...</div>
                    </div>
                    <div style="font-size: 12px; color: var(--gray-medium);" id="userTierLevel">Level 1 of 4</div>
                </div>
                <div style="background: var(--gray-light); height: 10px; border-radius: 10px; overflow: hidden;">
                    <div id="tierProgressBar" style="background: linear-gradient(90deg, var(--brand-pink-dark), var(--brand-pink)); height: 100%; width: 0%; transition: width 0.5s;"></div>
                </div>

                <div style="margin-top: 20px;">
                    <strong>Your Perks:</strong>
                    <ul id="tierPerksList" style="margin-top: 10px; padding-left: 20px;">
                        <li>Earn points on every visit</li>
                        <li>Birthday surprise</li>
                    </ul>
                </div>
            </div>

            <div class="section-header" style="margin-top: 30px;">
                <h3 class="section-title">Ways to Earn Points</h3>
            </div>

            <div class="card" id="earnRulesContainer">
                <!-- Dynamically populated from config -->
                <div style="text-align: center; padding: 20px; color: var(--gray-medium);">
                    Loading earn rules...
                </div>
            </div>

            <button class="btn btn-primary" onclick="showRedeemOptions()">Redeem Points</button>
        </div>

        <!-- Team Content -->
        <div id="team" class="content-area">
            <h2 class="section-title" style="margin-bottom: 10px;">Meet Our Dream Team</h2>
            <p style="color: var(--gray-medium); margin-bottom: 25px;">The talented stylists who'll make your hair goals a reality</p>

            <div class="team-grid" id="teamGrid">
                <!-- Team members loaded dynamically from database -->
            </div>

            <!-- Photo Upload Section for Inspo -->
            <div class="section-header" style="margin-top: 30px;">
                <h3 class="section-title">Share Your Hair Inspiration</h3>
            </div>

            <div class="photo-upload-section" onclick="openPhotoUpload()">
                <div class="upload-icon"></div>
                <div class="upload-title">Upload Your Inspo Photos</div>
                <div class="upload-subtitle">Share photos of your current hair or dream hairstyles with your stylist</div>
                <button class="btn btn-secondary btn-small" style="width: auto;">Choose Photos</button>
            </div>

            <div class="section-header">
                <h3 class="section-title">Your Uploaded Inspo</h3>
            </div>

            <div class="inspo-gallery" id="inspoGallery">
                <!-- Photos loaded dynamically from database -->
                <p style="text-align:center;padding:40px;color:var(--gray-medium);">Loading your inspiration photos...</p>
            </div>
        </div>

        <!-- Hair Tracker Content -->
        <div id="tracker" class="content-area">
            <h2 id="trackerTitle" class="section-title" style="margin-bottom: 20px;">Hair Care Journey</h2>
            <p id="trackerSubtitle" style="text-align: center; color: var(--gray-medium); margin-bottom: 20px; display: none;"></p>

            <!-- Setup prompt (shown when no tracker data) -->
            <div id="trackerSetupPrompt" class="card" style="text-align: center; padding: 30px; display: none;">
                <div style="font-size: 60px; margin-bottom: 15px;"></div>
                <h3 style="margin-bottom: 10px;">Set Up Your Hair Tracker</h3>
                <p id="trackerNoInstallMessage" style="color: var(--gray-medium); margin-bottom: 20px;">
                    Set up your hair tracker to get personalized care recommendations!
                </p>
                <button id="trackerSetupBtn" class="btn btn-primary" onclick="showTrackerSetupModal()">Set Up Tracker</button>
            </div>

            <!-- Main tracker content (shown when tracker is set up) -->
            <div id="trackerMainContent" style="display: none;">
                <!-- Maintenance Overdue Alert Banner -->
                <div id="trackerOverdueBanner" style="display: none; background: linear-gradient(135deg, #ff6b6b, #ee5a5a); color: white; padding: 15px 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(238, 90, 90, 0.3);">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="font-size: 28px;"></div>
                        <div style="flex: 1;">
                            <strong style="display: block; font-size: 16px;">Maintenance Overdue!</strong>
                            <span id="trackerOverdueText" style="font-size: 14px; opacity: 0.9;">Your extensions need attention</span>
                        </div>
                        <button class="btn" onclick="bookMaintenance()" style="background: white; color: #ee5a5a; font-weight: 600; padding: 8px 16px; border-radius: 8px;">Book Now</button>
                    </div>
                </div>

                <!-- Maintenance Due Soon Warning -->
                <div id="trackerWarningBanner" style="display: none; background: linear-gradient(135deg, #ffa726, #ff9800); color: white; padding: 15px 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="font-size: 28px;"></div>
                        <div style="flex: 1;">
                            <strong style="display: block; font-size: 16px;">Maintenance Coming Up</strong>
                            <span id="trackerWarningText" style="font-size: 14px; opacity: 0.9;">Schedule your appointment soon</span>
                        </div>
                        <button class="btn" onclick="bookMaintenance()" style="background: white; color: #ff9800; font-weight: 600; padding: 8px 16px; border-radius: 8px;">Book</button>
                    </div>
                </div>

                <div class="tracker-progress">
                    <div class="progress-circle" id="trackerProgressCircle">
                        <div class="progress-text">
                            <div class="progress-days" id="trackerDays"></div>
                            <div class="progress-label">Days</div>
                        </div>
                    </div>
                    <div style="text-align: center; color: var(--gray-medium);">
                        Since last installation
                    </div>
                    <div id="trackerExtensionType" style="text-align: center; color: var(--brand-pink); font-weight: 500; margin-top: 5px;"></div>
                </div>

                <div class="tracker-stats">
                    <div class="tracker-stat">
                        <div id="trackerWashes" style="font-size: 24px; font-weight: bold;">0</div>
                        <div style="font-size: 14px; color: var(--gray-medium);">Washes</div>
                    </div>
                    <div class="tracker-stat">
                        <div id="trackerDaysUntilMaintenance" style="font-size: 24px; font-weight: bold;"></div>
                        <div style="font-size: 14px; color: var(--gray-medium);">Days until maintenance</div>
                    </div>
                    <div class="tracker-stat" id="trackerHealthStatCard" style="position: relative;">
                        <div id="trackerHealthScore" style="font-size: 24px; font-weight: bold;"></div>
                        <div style="font-size: 14px; color: var(--gray-medium);">Health score</div>
                        <div id="trackerHealthIndicator" style="position: absolute; top: 8px; right: 8px; width: 12px; height: 12px; border-radius: 50%; background: var(--success);"></div>
                    </div>
                    <div class="tracker-stat">
                        <div id="trackerWashStreak" style="font-size: 24px; font-weight: bold;"></div>
                        <div style="font-size: 14px; color: var(--gray-medium);">Day streak</div>
                    </div>
                </div>

                <div class="section-header" style="margin-top: 30px;">
                    <h3 class="section-title">Care Schedule</h3>
                </div>

                <div class="card">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                        <div style="font-size: 30px;"></div>
                        <div style="flex: 1;">
                            <strong id="trackerNextWashTitle">Next Wash Day</strong>
                            <div id="trackerNextWashLabel" style="color: var(--gray-medium); font-size: 14px;">Based on your routine</div>
                        </div>
                        <button class="btn btn-small btn-outline" onclick="logWash()">Log Wash</button>
                    </div>
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                        <div style="font-size: 30px;"></div>
                        <div style="flex: 1;">
                            <strong id="trackerMaintenanceTitle">Maintenance Due</strong>
                            <div id="trackerMaintenanceLabel" style="color: var(--gray-medium); font-size: 14px;"></div>
                        </div>
                        <button class="btn btn-small btn-secondary" onclick="bookMaintenance()">Book Now</button>
                    </div>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="font-size: 30px;"></div>
                        <div style="flex: 1;">
                            <strong id="trackerDeepConditionTitle">Deep Condition</strong>
                            <div id="trackerDeepConditionLabel" style="color: var(--gray-medium); font-size: 14px;">Every 2 weeks</div>
                        </div>
                        <button class="btn btn-small btn-outline" onclick="logDeepCondition()">Done</button>
                    </div>
                </div>

                <!-- Progress Photos - Coming Soon (hidden until feature is implemented) -->
                <!--
                <div class="section-header" style="margin-top: 30px;">
                    <h3 class="section-title">Progress Photos</h3>
                </div>
                <div class="gallery-grid" id="trackerPhotosGrid">
                    <div style="aspect-ratio: 1; background: var(--gray-light); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 40px; cursor: pointer;" onclick="addProgressPhoto()"></div>
                </div>
                -->

                <div class="section-header" style="margin-top: 30px;">
                    <h3 class="section-title">Care Tips for You</h3>
                </div>

                <div class="card" id="trackerTipsCard">
                    <strong style="display: flex; align-items: center; gap: 8px;"><svg viewBox="0 0 24 24" fill="none" stroke="#F67599" stroke-width="2" width="18" height="18"><path d="M9 18h6"/><path d="M10 22h4"/><path d="M15.09 14c.18-.98.65-1.74 1.41-2.5A4.65 4.65 0 0 0 18 8 6 6 0 0 0 6 8c0 1 .23 2.23 1.5 3.5A4.61 4.61 0 0 1 8.91 14"/></svg>Personalized Recommendations</strong>
                    <ul id="trackerTipsList" style="margin-top: 10px; padding-left: 20px; color: var(--gray-medium);">
                        <li>Loading tips...</li>
                    </ul>
                </div>

                <!-- Edit tracker button -->
                <button class="btn btn-outline" style="margin-top: 20px; width: 100%;" onclick="showTrackerSetupModal()">
                    Edit Tracker Settings
                </button>
            </div>
        </div>

        <!-- Tracker Setup Modal -->
        <div id="trackerSetupModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Set Up Hair Tracker</h3>
                    <button class="close-btn" onclick="closeModal('trackerSetupModal')">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Extension Type</label>
                        <select id="trackerExtensionTypeSelect" class="form-input">
                            <option value="">Select extension type...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Last Installation Date</label>
                        <input type="date" id="trackerInstallDate" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Last Wash Date (optional)</label>
                        <input type="date" id="trackerLastWashDate" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Last Deep Condition Date (optional)</label>
                        <input type="date" id="trackerLastDeepConditionDate" class="form-input">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="closeModal('trackerSetupModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="saveTrackerSetup()">Save</button>
                </div>
            </div>
        </div>

        <!-- Log Activity Modal (for wash/deep condition with date picker) -->
        <div id="logActivityModal" class="modal">
            <div class="modal-content" style="max-width: 360px;">
                <div class="modal-header">
                    <h3 id="logActivityTitle">Log Activity</h3>
                    <button class="close-btn" onclick="closeModal('logActivityModal')">&times;</button>
                </div>
                <div class="modal-body">
                    <p id="logActivityDescription" style="color: var(--gray-medium); margin-bottom: 15px;"></p>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="logActivityDate" class="form-input">
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline" onclick="closeModal('logActivityModal')">Cancel</button>
                    <button class="btn btn-primary" id="logActivityConfirmBtn" onclick="confirmLogActivity()">Log</button>
                </div>
            </div>
        </div>

        <!-- Profile Content -->
        <div id="profile" class="content-area">
            <div class="profile-header">
                <div class="profile-avatar" id="profileAvatar">?</div>
                <div class="profile-name" id="profileName">Guest</div>
                <div class="profile-tier" id="profileTier" style="display: flex; align-items: center; justify-content: center; gap: 6px;"><svg viewBox="0 0 24 24" fill="#F67599" width="16" height="16"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg> <span id="profileTierText">Sign in to unlock rewards</span></div>
            </div>

            <ul class="menu-list">
                <li class="menu-item" onclick="editProfile()">
                    <div class="menu-item-content">
                        <span class="menu-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                        </span>
                        <span class="menu-text">Edit Profile</span>
                    </div>
                    <span></span>
                </li>
                <li class="menu-item" onclick="viewAppointments()">
                    <div class="menu-item-content">
                        <span class="menu-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                        </span>
                        <span class="menu-text">My Appointments</span>
                    </div>
                    <span></span>
                </li>
                <li class="menu-item" onclick="viewOrders()">
                    <div class="menu-item-content">
                        <span class="menu-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                                <line x1="16.5" y1="9.4" x2="7.5" y2="4.21"></line>
                                <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                                <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                                <line x1="12" y1="22.08" x2="12" y2="12"></line>
                            </svg>
                        </span>
                        <span class="menu-text">Order History</span>
                    </div>
                    <span></span>
                </li>
                <li class="menu-item" onclick="viewPayments()">
                    <div class="menu-item-content">
                        <span class="menu-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                                <line x1="1" y1="10" x2="23" y2="10"></line>
                            </svg>
                        </span>
                        <span class="menu-text">Payment Methods</span>
                    </div>
                    <span></span>
                </li>
                <li class="menu-item" onclick="hairProfile()">
                    <div class="menu-item-content">
                        <span class="menu-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                                <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3z"></path>
                                <path d="M12 12v10"></path>
                                <path d="M7 17c0-1.5 1-3 3-3s3 1.5 3 3"></path>
                                <path d="M12 22c-3 0-5-2-5-5"></path>
                                <path d="M12 22c3 0 5-2 5-5"></path>
                            </svg>
                        </span>
                        <span class="menu-text">Hair Profile</span>
                    </div>
                    <span></span>
                </li>
                <li class="menu-item" onclick="notificationSettings()">
                    <div class="menu-item-content">
                        <span class="menu-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                            </svg>
                        </span>
                        <span class="menu-text">Notifications</span>
                    </div>
                    <span></span>
                </li>
                <li class="menu-item" onclick="helpCenter()">
                    <div class="menu-item-content">
                        <span class="menu-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                <line x1="12" y1="17" x2="12.01" y2="17"></line>
                            </svg>
                        </span>
                        <span class="menu-text">Help Center</span>
                    </div>
                    <span></span>
                </li>
                <li class="menu-item" onclick="settings()">
                    <div class="menu-item-content">
                        <span class="menu-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                                <circle cx="12" cy="12" r="3"></circle>
                                <path d="M12 1v6m0 6v6m5.5-13v6m0 6v6m5.5-13v6m0 6v6"></path>
                                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                            </svg>
                        </span>
                        <span class="menu-text">Settings</span>
                    </div>
                    <span></span>
                </li>
            </ul>

            <button class="btn btn-outline" style="margin-top: 20px;" onclick="logout()">Logout</button>
        </div>
    </div>

    <!-- Modals -->
    <!-- Booking Confirmation Modal -->
    <div id="bookingConfirmationModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--brand-pink) 0%, #e05a7f 100%); color: white; padding: 30px 20px; text-align: center; border-radius: 15px 15px 0 0;">
                <div style="font-size: 48px; margin-bottom: 10px;"></div>
                <h2 style="margin: 0; font-size: 24px; font-weight: 600;">Booking Confirmed!</h2>
            </div>
            <div style="padding: 30px 20px;">
                <div id="bookingConfirmationContent" style="line-height: 1.8;"></div>

                <div style="background: linear-gradient(135deg, #fff5f8 0%, #ffe8ee 100%); padding: 20px; border-radius: 12px; margin: 25px 0; border-left: 4px solid var(--brand-pink);">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div style="font-size: 32px;"></div>
                        <div>
                            <div style="font-weight: 600; color: var(--text-dark); margin-bottom: 4px;">Loyalty Points Earned!</div>
                            <div style="font-size: 14px; color: var(--gray-dark);">
                                <span id="confirmationPoints" style="font-weight: 600; color: var(--brand-pink); font-size: 18px;">+50</span> points added to your account
                            </div>
                        </div>
                    </div>
                </div>

                <div style="background: var(--gray-light); padding: 15px; border-radius: 10px; font-size: 14px; color: var(--gray-dark); text-align: center;">
                     You will receive a confirmation email shortly
                </div>

                <button class="btn btn-primary" onclick="closeBookingConfirmation()" style="width: 100%; margin-top: 25px; padding: 14px;">
                    Got it, thanks!
                </button>
            </div>
        </div>
    </div>

    <div id="notificationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Notifications</h3>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <button class="btn btn-outline" style="padding: 6px 10px; font-size: 12px;" onclick="markAllNotificationsRead()">Mark all read</button>
                    <button class="close-btn" onclick="closeModal('notificationModal')">&times;</button>
                </div>
            </div>

            <div id="notificationList"></div>
        </div>
    </div>

    <!-- Cart Overlay & Modal -->
    <div class="cart-overlay" id="cartOverlay" onclick="closeCart()"></div>
    <div class="cart-modal" id="cartModal">
        <div class="cart-header">
            <h3>Shopping Cart</h3>
            <button class="close-btn" onclick="closeCart()" style="color: white;">&times;</button>
        </div>
        <div class="cart-items" id="cartItems">
            <!-- Cart items will be added dynamically -->
            <div class="cart-item">
                <img src="https://www.flirthair.co.za/wp-content/uploads/2022/03/KEVIN-MURPHY-Angel-300x300.png" class="cart-item-image" alt="Angel Wash">
                <div class="cart-item-details">
                    <div class="cart-item-name">Angel.Wash</div>
                    <div class="cart-item-price">R385</div>
                    <div class="quantity-control">
                        <button class="qty-btn" onclick="updateQty('angel-wash', -1)">-</button>
                        <span id="qty-angel-wash">1</span>
                        <button class="qty-btn" onclick="updateQty('angel-wash', 1)">+</button>
                        <button style="background: none; border: none; color: var(--brand-pink); cursor: pointer; margin-left: 10px;" onclick="removeFromCart('angel-wash')">Remove</button>
                    </div>
                </div>
            </div>
            <div class="cart-item">
                <img src="https://www.flirthair.co.za/wp-content/uploads/2022/03/KEVIN-MURPHY-09-300x300.png" class="cart-item-image" alt="Bedroom Hair">
                <div class="cart-item-details">
                    <div class="cart-item-name">Bedroom.Hair</div>
                    <div class="cart-item-price">R420</div>
                    <div class="quantity-control">
                        <button class="qty-btn" onclick="updateQty('bedroom-hair', -1)">-</button>
                        <span id="qty-bedroom-hair">1</span>
                        <button class="qty-btn" onclick="updateQty('bedroom-hair', 1)">+</button>
                        <button style="background: none; border: none; color: var(--brand-pink); cursor: pointer; margin-left: 10px;" onclick="removeFromCart('bedroom-hair')">Remove</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="cart-footer">
            <div class="cart-subtotal">
                <span>Subtotal</span>
                <span id="cartSubtotal">R805</span>
            </div>
            <div class="cart-subtotal">
                <span>Delivery</span>
                <span id="cartDelivery">Calculated at checkout</span>
            </div>
            <div class="cart-total">
                <span>Total</span>
                <span id="cartTotal">R805</span>
            </div>
            <button class="btn btn-primary" onclick="openCheckout()">Proceed to Checkout</button>
            <button class="btn btn-outline" onclick="closeCart()">Continue Shopping</button>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div id="checkoutModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">Checkout</h3>
                <button class="close-btn" onclick="closeModal('checkoutModal')">&times;</button>
            </div>

            <div class="checkout-section">
                <div class="checkout-section-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" style="vertical-align: middle; margin-right: 6px;">
                        <rect x="1" y="3" width="15" height="13"></rect>
                        <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>
                        <circle cx="5.5" cy="18.5" r="2.5"></circle>
                        <circle cx="18.5" cy="18.5" r="2.5"></circle>
                    </svg>
                    Delivery Method
                </div>
                <div class="delivery-options">
                    <div class="delivery-option selected" data-method="pickup" onclick="selectDelivery(this, 'pickup', 0)">
                        <div class="delivery-info">
                            <h4>Collect from Salon</h4>
                            <p>Ready in 24 hours - Free pickup at Flirt Hair salon</p>
                        </div>
                        <div class="delivery-price">FREE</div>
                    </div>
                    <div class="delivery-option" data-method="standard" onclick="selectDelivery(this, 'standard', 65)">
                        <div class="delivery-info">
                            <h4>Standard Courier</h4>
                            <p>3-5 business days delivery</p>
                        </div>
                        <div class="delivery-price">R65</div>
                    </div>
                    <div class="delivery-option" data-method="express" onclick="selectDelivery(this, 'express', 120)">
                        <div class="delivery-info">
                            <h4>Express Courier</h4>
                            <p>Next day delivery (order before 2pm)</p>
                        </div>
                        <div class="delivery-price">R120</div>
                    </div>
                </div>
            </div>

            <div class="checkout-section" id="deliveryAddressSection" style="display: none;">
                <div class="checkout-section-title">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18" style="vertical-align: middle; margin-right: 6px;">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                        <circle cx="12" cy="10" r="3"></circle>
                    </svg>
                    Delivery Address
                </div>
                <div class="form-group">
                    <label class="form-label">Street Address *</label>
                    <input type="text" id="deliveryStreet" class="form-input" placeholder="123 Main Street" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Suburb / Area</label>
                    <input type="text" id="deliverySuburb" class="form-input" placeholder="Gardens">
                </div>
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label class="form-label">City *</label>
                        <input type="text" id="deliveryCity" class="form-input" placeholder="Cape Town" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Postal Code *</label>
                        <input type="text" id="deliveryPostalCode" class="form-input" placeholder="8001" required>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Delivery Instructions (optional)</label>
                    <textarea id="deliveryInstructions" class="form-input" rows="2" placeholder="Gate code, building name, etc."></textarea>
                </div>
            </div>

            <div class="checkout-section">
                <div class="checkout-section-title"> Promo Code</div>
                <div style="display: flex; gap: 10px;">
                    <input type="text" class="form-input" id="promoCode" placeholder="Enter promo code" style="flex: 1;">
                    <button class="btn btn-outline btn-small" onclick="applyPromo()">Apply</button>
                </div>
                <div id="promoMessage" style="margin-top: 10px; color: var(--success); font-size: 14px;"></div>
            </div>

            <div class="checkout-section">
                <div class="checkout-section-title"> Order Summary</div>
                <div class="invoice-preview">
                    <div class="invoice-row">
                        <span>Angel.Wash x 1</span>
                        <span>R385</span>
                    </div>
                    <div class="invoice-row">
                        <span>Bedroom.Hair x 1</span>
                        <span>R420</span>
                    </div>
                    <div class="invoice-row">
                        <span>Subtotal</span>
                        <span>R805</span>
                    </div>
                    <div class="invoice-row">
                        <span>Delivery</span>
                        <span id="invoiceDelivery">FREE</span>
                    </div>
                    <div class="invoice-row" id="discountRow" style="display: none; color: var(--success);">
                        <span>Discount</span>
                        <span id="invoiceDiscount">-R0</span>
                    </div>
                    <div class="invoice-row">
                        <span>Total</span>
                        <span id="invoiceTotal">R805</span>
                    </div>
                </div>
            </div>

            <button class="btn btn-primary" onclick="processPayment()">Pay Now - R<span id="payAmount">805</span></button>
        </div>
    </div>

    <!-- Photo Upload Modal -->
    <div id="photoUploadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Upload Hair Inspo</h3>
                <button class="close-btn" onclick="closeModal('photoUploadModal')">&times;</button>
            </div>

            <div class="photo-upload-section" onclick="triggerFileUpload()">
                <div class="upload-icon"></div>
                <div class="upload-title">Choose Photos</div>
                <div class="upload-subtitle">Upload photos of your current hair or dream hairstyles</div>
                <input type="file" id="photoInput" multiple accept="image/*" style="display: none;" onchange="handlePhotoUpload(event)">
            </div>

            <div id="uploadPreviewContainer" class="upload-preview"></div>

            <div class="form-group">
                <label class="form-label">Add a note for your stylist</label>
                <textarea id="inspoNotes" class="form-input" rows="3" placeholder="e.g., 'I love this length!' or 'Can we achieve this color?'"></textarea>
            </div>

            <button class="btn btn-primary" onclick="saveInspoPhotos()">Save Photos</button>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="authModal" class="modal" onclick="closeAuthModalAndShowGate(event)">
        <div class="modal-content" style="max-width: 400px;" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 class="modal-title">Welcome to Flirt</h3>
                <button class="close-btn" onclick="closeAuthModalAndShowGate()">&times;</button>
            </div>

            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthTab('login')">Login</button>
                <button class="auth-tab" onclick="switchAuthTab('signup')">Sign Up</button>
            </div>

            <div id="authError" class="auth-error"></div>

            <!-- Login Form -->
            <div id="loginForm" class="auth-form active">
                <form id="loginFormElement" onsubmit="handleLogin(event)">
                    <input type="email" id="loginEmail" class="auth-input" placeholder="Email address" autocomplete="email">
                    <input type="password" id="loginPassword" class="auth-input" placeholder="Password" autocomplete="current-password">
                    <button type="submit" class="auth-btn" id="loginBtn">Login</button>
                </form>
            </div>

            <!-- Signup Form -->
            <div id="signupForm" class="auth-form">
                <form id="signupFormElement" onsubmit="handleSignup(event)">
                    <input type="text" id="signupName" class="auth-input" placeholder="Full name" autocomplete="name">
                    <input type="email" id="signupEmail" class="auth-input" placeholder="Email address" autocomplete="email">
                    <input type="tel" id="signupPhone" class="auth-input" placeholder="Phone number (optional)" autocomplete="tel">
                    <input type="password" id="signupPassword" class="auth-input" placeholder="Password (min 6 characters)" autocomplete="new-password">
                    <input type="password" id="signupPasswordConfirm" class="auth-input" placeholder="Confirm password" autocomplete="new-password">
                    <input type="text" id="signupReferral" class="auth-input" placeholder="Referral code (optional)">
                    <button type="submit" class="auth-btn" id="signupBtn">Create Account</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Chat Window -->
    <button class="chat-fab" id="chatFab" onclick="toggleChat()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
        <span class="chat-notification">1</span>
    </button>

    <div class="chat-window" id="chatWindow">
        <div class="chat-header">
            <div class="chat-header-info">
                <div class="chat-avatar"></div>
                <div>
                    <strong>Flirt Hair Support</strong>
                    <div class="chat-status">Online now</div>
                </div>
            </div>
            <button class="close-btn" onclick="toggleChat()" style="color: white;">&times;</button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="chat-message received">
                <div class="message-bubble">
                    Hey gorgeous!  Welcome to Flirt Hair! How can I help you with your hair journey today?
                </div>
                <div class="message-time">Just now</div>
            </div>
        </div>
        <div class="chat-input-area">
            <input type="text" class="chat-input" id="chatInput" placeholder="Type a message..." onkeypress="handleChatKeypress(event)">
            <button class="chat-send-btn" onclick="sendChatMessage()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
            </button>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div class="modal" id="editProfileModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">Edit Profile</h3>
                <button class="modal-close" onclick="closeEditProfileModal()">&times;</button>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--gray-dark);">Full Name</label>
                    <input type="text" id="editProfileName" class="form-input" style="width: 100%; padding: 12px; border: 1px solid var(--border-soft); border-radius: 10px; font-size: 16px;" placeholder="Your name">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--gray-dark);">Phone Number</label>
                    <input type="tel" id="editProfilePhone" class="form-input" style="width: 100%; padding: 12px; border: 1px solid var(--border-soft); border-radius: 10px; font-size: 16px;" placeholder="+27 82 123 4567">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--gray-dark);">Email (read-only)</label>
                    <input type="email" id="editProfileEmail" class="form-input" style="width: 100%; padding: 12px; border: 1px solid var(--border-soft); border-radius: 10px; font-size: 16px; background: var(--surface-muted);" readonly>
                </div>
                <div id="editProfileError" style="color: var(--danger); font-size: 14px; margin-bottom: 15px; display: none;"></div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-outline" onclick="closeEditProfileModal()" style="flex: 1;">Cancel</button>
                    <button class="btn btn-primary" onclick="saveProfile()" style="flex: 1; background: var(--brand-pink);">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- My Appointments Modal -->
    <div class="modal" id="appointmentsModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">My Appointments</h3>
                <button class="modal-close" onclick="closeAppointmentsModal()">&times;</button>
            </div>
            <div class="modal-body" id="appointmentsModalBody" style="padding: 20px; max-height: 400px; overflow-y: auto;">
                <!-- Appointments will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Order History Modal -->
    <div class="modal" id="ordersModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">Order History</h3>
                <button class="modal-close" onclick="closeOrdersModal()">&times;</button>
            </div>
            <div class="modal-body" id="ordersModalBody" style="padding: 20px; max-height: 400px; overflow-y: auto;">
                <!-- Orders will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Hair Profile Modal -->
    <div class="modal" id="hairProfileModal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h3 class="modal-title">Hair Profile</h3>
                <button class="modal-close" onclick="closeHairProfileModal()">&times;</button>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <p style="color: var(--text-muted); margin-bottom: 20px; font-size: 14px;">Help us personalize your experience by telling us about your hair.</p>
                <div id="hairProfileLoading" style="display: none; align-items: center; gap: 10px; color: var(--gray-medium); font-size: 14px; margin-bottom: 15px;">
                    <span class="loading-spinner"></span>
                    <span>Loading your hair profile...</span>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--gray-dark);">Hair Type</label>
                    <select id="hairProfileType" class="form-input" style="width: 100%; padding: 12px; border: 1px solid var(--border-soft); border-radius: 10px; font-size: 16px;">
                        <option value="">Select hair type...</option>
                        <option value="straight">Straight</option>
                        <option value="wavy">Wavy</option>
                        <option value="curly">Curly</option>
                        <option value="coily">Coily</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--gray-dark);">Extension Type</label>
                    <select id="hairProfileExtension" class="form-input" style="width: 100%; padding: 12px; border: 1px solid var(--border-soft); border-radius: 10px; font-size: 16px;">
                        <option value="">Select extension type...</option>
                        <option value="tape">Tape Extensions</option>
                        <option value="weft">Weft Extensions</option>
                        <option value="keratin">Keratin Bonds</option>
                        <option value="clip-in">Clip-In Extensions</option>
                        <option value="ponytail">Ponytails</option>
                        <option value="none">No Extensions Yet</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--gray-dark);">Preferred Stylist</label>
                    <select id="hairProfileStylist" class="form-input" style="width: 100%; padding: 12px; border: 1px solid var(--border-soft); border-radius: 10px; font-size: 16px;">
                        <option value="">No preference</option>
                        <!-- Stylists will be loaded dynamically -->
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--gray-dark);">Notes</label>
                    <textarea id="hairProfileNotes" class="form-input" rows="3" style="width: 100%; padding: 12px; border: 1px solid var(--border-soft); border-radius: 10px; font-size: 16px; resize: none;" placeholder="Any allergies, sensitivities, or preferences..."></textarea>
                </div>
                <div id="hairProfileError" style="color: var(--danger); font-size: 14px; margin-bottom: 15px; display: none;"></div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-outline" onclick="closeHairProfileModal()" style="flex: 1;">Cancel</button>
                    <button id="hairProfileSaveBtn" class="btn btn-primary" onclick="saveHairProfile()" style="flex: 1; background: var(--brand-pink);">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Methods Modal -->
    <div class="modal" id="paymentMethodsModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">Payment Methods</h3>
                <button class="modal-close" onclick="closePaymentMethodsModal()">&times;</button>
            </div>
            <div class="modal-body" style="padding: 20px; text-align: center;">
                <div style="font-size: 48px; margin-bottom: 15px;"></div>
                <div style="font-weight: 600; margin-bottom: 8px;">Saved Cards Coming Soon</div>
                <p style="color: var(--text-subtle); margin-bottom: 20px;">We're working on adding the ability to save your payment methods for faster checkout.</p>
                <p style="color: var(--text-muted); font-size: 14px;">For now, you can enter your card details during checkout.</p>
                <button class="btn btn-primary" onclick="closePaymentMethodsModal()" style="margin-top: 15px; background: var(--brand-pink);">Got it</button>
            </div>
        </div>
    </div>

    <!-- Notification Preferences Modal -->
    <div class="modal" id="notificationPrefsModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">Notification Settings</h3>
                <button class="modal-close" onclick="closeNotificationPrefsModal()">&times;</button>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <p style="color: var(--text-muted); margin-bottom: 20px; font-size: 14px;">Choose which notifications you'd like to receive.</p>
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                        <input type="checkbox" id="prefPromotions" style="width: 20px; height: 20px; accent-color: var(--brand-pink);">
                        <div>
                            <div style="font-weight: 500;">Promotions & Offers</div>
                            <div style="font-size: 13px; color: var(--text-subtle);">Special deals and discounts</div>
                        </div>
                    </label>
                    <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                        <input type="checkbox" id="prefAppointments" style="width: 20px; height: 20px; accent-color: var(--brand-pink);">
                        <div>
                            <div style="font-weight: 500;">Appointment Reminders</div>
                            <div style="font-size: 13px; color: var(--text-subtle);">Upcoming booking notifications</div>
                        </div>
                    </label>
                    <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                        <input type="checkbox" id="prefLoyalty" style="width: 20px; height: 20px; accent-color: var(--brand-pink);">
                        <div>
                            <div style="font-weight: 500;">Loyalty Updates</div>
                            <div style="font-size: 13px; color: var(--text-subtle);">Points earned and tier changes</div>
                        </div>
                    </label>
                </div>
                <div id="notifPrefsError" style="color: var(--danger); font-size: 14px; margin-top: 15px; display: none;"></div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-outline" onclick="closeNotificationPrefsModal()" style="flex: 1;">Cancel</button>
                    <button class="btn btn-primary" onclick="saveNotificationPrefs()" style="flex: 1; background: var(--brand-pink);">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Center Modal -->
    <div class="modal" id="helpCenterModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">Help Center</h3>
                <button class="modal-close" onclick="closeHelpCenterModal()">&times;</button>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <p style="color: var(--text-muted); margin-bottom: 20px; font-size: 14px;">Need help? We're here for you!</p>
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <a id="supportWhatsappLink" href="#" target="_blank" style="display: flex; align-items: center; gap: 12px; padding: 15px; background: var(--surface-muted); border-radius: 12px; text-decoration: none; color: inherit;">
                        <div style="width: 40px; height: 40px; background: #25D366; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px;"></div>
                        <div>
                            <div style="font-weight: 500;">WhatsApp</div>
                            <div style="font-size: 13px; color: var(--text-subtle);">+27 82 123 4567</div>
                        </div>
                    </a>
                    <a href="tel:+27111234567" style="display: flex; align-items: center; gap: 12px; padding: 15px; background: var(--surface-muted); border-radius: 12px; text-decoration: none; color: inherit;">
                        <div style="width: 40px; height: 40px; background: var(--brand-pink); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px;"></div>
                        <div>
                            <div style="font-weight: 500;">Call Us</div>
                            <div style="font-size: 13px; color: var(--text-subtle);">+27 11 123 4567</div>
                        </div>
                    </a>
                    <a href="#" onclick="showToast({type:'info',title:'FAQ',message:'FAQ page coming soon!'}); return false;" style="display: flex; align-items: center; gap: 12px; padding: 15px; background: var(--surface-muted); border-radius: 12px; text-decoration: none; color: inherit;">
                        <div style="width: 40px; height: 40px; background: #9B59B6; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px;"></div>
                        <div>
                            <div style="font-weight: 500;">FAQs</div>
                            <div style="font-size: 13px; color: var(--text-subtle);">Common questions answered</div>
                        </div>
                    </a>
                </div>
                <button class="btn btn-primary" onclick="closeHelpCenterModal()" style="width: 100%; margin-top: 20px; background: var(--brand-pink);">Close</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">Settings</h3>
                <button class="modal-close" onclick="closeSettingsModal()">&times;</button>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div style="padding: 15px; background: var(--surface-muted); border-radius: 12px;">
                        <div style="font-weight: 500; margin-bottom: 4px;">Account</div>
                        <div style="font-size: 13px; color: var(--text-subtle);" id="settingsEmail">-</div>
                    </div>
                    <button class="btn btn-outline" onclick="closeSettingsModal(); logout();" style="width: 100%; border-color: var(--danger); color: var(--danger);">
                        Log Out
                    </button>
                    <div style="text-align: center; padding: 15px; color: var(--text-subtle); font-size: 13px;">
                        Delete Account - Coming Soon
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reschedule Appointment Modal -->
    <div class="modal" id="rescheduleModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">Reschedule Appointment</h3>
                <button class="modal-close" onclick="closeRescheduleModal()">&times;</button>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <div id="rescheduleBookingInfo" style="background: var(--gray-light); padding: 12px; border-radius: 10px; margin-bottom: 20px;">
                    <!-- Current booking info will be shown here -->
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--gray-dark);">New Date</label>
                    <input type="date" id="rescheduleDate" class="form-input" style="width: 100%; padding: 12px; border: 1px solid var(--border-soft); border-radius: 10px; font-size: 16px;">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--gray-dark);">Preferred Time Window <span style="color: var(--primary);">*</span></label>
                    <div class="time-window-selector" id="rescheduleTimeWindowSelector" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        <div class="time-window-chip" data-window="MORNING">
                            <div class="icon"></div>
                            <div class="label">Morning</div>
                            <div class="time-range">6:00 AM - 12:00 PM</div>
                        </div>
                        <div class="time-window-chip" data-window="AFTERNOON">
                            <div class="icon"></div>
                            <div class="label">Afternoon</div>
                            <div class="time-range">12:00 PM - 3:00 PM</div>
                        </div>
                        <div class="time-window-chip" data-window="LATE_AFTERNOON">
                            <div class="icon"></div>
                            <div class="label">Late Afternoon</div>
                            <div class="time-range">3:00 PM - 6:00 PM</div>
                        </div>
                        <div class="time-window-chip" data-window="EVENING">
                            <div class="icon"></div>
                            <div class="label">Evening</div>
                            <div class="time-range">6:00 PM - 10:00 PM</div>
                        </div>
                    </div>
                    <input type="hidden" id="rescheduleRequestedTimeWindow" value="">
                    <div style="font-size: 13px; color: var(--gray); margin-top: 8px;">
                        Select your preferred time window. We'll assign an exact time within 24 hours.
                    </div>
                </div>
                <div id="rescheduleError" style="color: var(--danger); font-size: 14px; margin-bottom: 15px; display: none;"></div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-outline" onclick="closeRescheduleModal()" style="flex: 1;">Cancel</button>
                    <button class="btn btn-primary" onclick="submitReschedule()" style="flex: 1; background: var(--brand-pink);">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('%c FLIRT Hair & Beauty App Script Loaded', 'background: #f67599; color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold;');

        // ============================================
        // TOAST NOTIFICATION SYSTEM
        // ============================================
        const toastIcons = {
            success: `<svg viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2.5" width="20" height="20">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>`,
            error: `<svg viewBox="0 0 24 24" fill="none" stroke="var(--danger)" stroke-width="2.5" width="20" height="20">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="15" y1="9" x2="9" y2="15"></line>
                <line x1="9" y1="9" x2="15" y2="15"></line>
            </svg>`,
            warning: `<svg viewBox="0 0 24 24" fill="none" stroke="var(--warning)" stroke-width="2.5" width="20" height="20">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                <line x1="12" y1="9" x2="12" y2="13"></line>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>`,
            info: `<svg viewBox="0 0 24 24" fill="none" stroke="var(--brand-pink)" stroke-width="2.5" width="20" height="20">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>`,
            promo: `<svg viewBox="0 0 24 24" fill="none" stroke="var(--brand-pink)" stroke-width="2.5" width="20" height="20">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
            </svg>`,
            booking: `<svg viewBox="0 0 24 24" fill="none" stroke="var(--brand-pink)" stroke-width="2.5" width="20" height="20">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>`,
            points: `<svg viewBox="0 0 24 24" fill="none" stroke="var(--brand-pink)" stroke-width="2.5" width="20" height="20">
                <circle cx="12" cy="8" r="7"></circle>
                <polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline>
            </svg>`,
            gift: `<svg viewBox="0 0 24 24" fill="none" stroke="var(--brand-pink)" stroke-width="2.5" width="20" height="20">
                <polyline points="20 12 20 22 4 22 4 12"></polyline>
                <rect x="2" y="7" width="20" height="5"></rect>
                <line x1="12" y1="22" x2="12" y2="7"></line>
                <path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"></path>
                <path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"></path>
            </svg>`
        };

        const formatDateDisplay = (value, options = {}) => {
            if (!value) return '';
            const date = value instanceof Date ? value : new Date(value);
            if (isNaN(date)) return '';
            return new Intl.DateTimeFormat('en-GB', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                ...options
            }).format(date);
        };

        const formatDateWithTime = (value, timeText) => {
            const dateText = formatDateDisplay(value);
            if (!dateText) return '';
            return timeText ? `${dateText}${timeText.trim() ? ` at ${timeText}` : ''}` : dateText;
        };

        function showToast(options) {
            const {
                type = 'info',
                title = 'Notice',
                message = '',
                duration = 5000,
                action = null,
                actionText = 'View',
                icon = null
            } = options;

            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'toast';

            const safeTitle = title || 'Notification';
            const safeMessage = message || '';
            const displayIcon = icon || toastIcons[type] || toastIcons.info;

            toast.innerHTML = `
                <div class="toast-accent ${type}"></div>
                <div class="toast-body">
                    <div class="toast-icon ${type}">${displayIcon}</div>
                    <div class="toast-content">
                        <div class="toast-title">${safeTitle}</div>
                        ${safeMessage ? `<div class="toast-message">${safeMessage}</div>` : ''}
                        ${action ? `<div class="toast-action"><button class="toast-action-btn" onclick="${action}">${actionText}</button></div>` : ''}
                    </div>
                    <button class="toast-close" onclick="dismissToast(this)">&times;</button>
                </div>
                <div class="toast-progress"><div class="toast-progress-bar" style="animation-duration: ${duration}ms"></div></div>
            `;

            container.appendChild(toast);

            // Auto dismiss
            setTimeout(() => {
                dismissToast(toast.querySelector('.toast-close'));
            }, duration);

            return toast;
        }

        function dismissToast(closeBtn) {
            const toast = closeBtn.closest('.toast');
            if (toast && !toast.classList.contains('hiding')) {
                toast.classList.add('hiding');
                setTimeout(() => toast.remove(), 300);
            }
        }

        // Convenience functions
        function showSuccessToast(title, message, options = {}) {
            return showToast({ type: 'success', title, message, ...options });
        }

        function showErrorToast(title, message, options = {}) {
            return showToast({ type: 'error', title, message, ...options });
        }

        function showPromoToast(title, message, options = {}) {
            return showToast({ type: 'promo', title, message, duration: 8000, ...options });
        }

        // Notification center state
        const NOTIFICATION_SEEN_KEY = 'flirt_shown_notifications';
        let notificationCenterState = { items: [] };

        function getSeenNotifications() {
            try {
                return JSON.parse(localStorage.getItem(NOTIFICATION_SEEN_KEY) || '[]');
            } catch (e) {
                return [];
            }
        }

        function setSeenNotifications(ids) {
            localStorage.setItem(NOTIFICATION_SEEN_KEY, JSON.stringify(ids));
        }

        function updateNotificationBadge(count) {
            const badge = document.getElementById('notificationBadge');
            if (!badge) return;
            if (count > 0) {
                badge.textContent = count > 9 ? '9+' : count;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        function getNotificationIcon(type = 'promo') {
            const map = {
                promo: { emoji: '', color: 'var(--brand-pink)' },
                appointment: { emoji: '', color: '#2196F3' },
                points: { emoji: '', color: '#F2B705' },
                alert: { emoji: '', color: 'var(--danger)' },
                system: { emoji: '', color: 'var(--brand-charcoal)' }
            };
            return map[type] || map.promo;
        }

        function formatRelativeTime(dateString) {
            const date = new Date(dateString || Date.now());
            const diff = Date.now() - date.getTime();
            const minutes = Math.floor(diff / 60000);
            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            return `${days}d ago`;
        }

        // Check for admin-triggered notifications
        async function checkForNotifications() {
            try {
                const response = await fetch(`${API_BASE}/notifications/active`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.notifications && data.notifications.length > 0) {
                        const shownIds = getSeenNotifications();

                        data.notifications.forEach(notif => {
                            if (!shownIds.includes(notif.id)) {
                                showToast({
                                    type: notif.type || 'promo',
                                    title: notif.title,
                                    message: notif.message,
                                    duration: 8000,
                                    action: notif.action || null,
                                    actionText: notif.actionText || 'View'
                                });
                                shownIds.push(notif.id);
                            }
                        });

                        setSeenNotifications(shownIds);
                        notificationCenterState.items = data.notifications;
                        const unread = data.notifications.filter(n => !shownIds.includes(n.id)).length;
                        updateNotificationBadge(unread);
                    }
                }
            } catch (error) {
                console.log('Notification check skipped:', error.message);
            }
        }

        // ============================================
        // API CONFIGURATION
        // ============================================
        // Prefer meta-injected base; fallback to relative /api or localhost for dev
        const API_BASE = (() => {
            const meta = document.querySelector('meta[name="flirt-api-base"]');
            if (meta && meta.content) return meta.content;
            const origin = window.location.origin;
            const port = window.location.port;
            if (origin === 'null' || origin.startsWith('file://') || (port && port !== '3001')) {
                console.warn('Running in dev mode - using localhost:3001 for API.');
                return 'http://localhost:3001/api';
            }
            return '/api';
        })();

        // Client contact configuration (override via meta)
        const SUPPORT_WHATSAPP = (() => {
            const meta = document.querySelector('meta[name="flirt-support-whatsapp"]');
            return meta && meta.content ? meta.content : '27821234567';
        })();

        // Media base URL for static assets (override via meta if CDN changes)
        const MEDIA_BASE = (() => {
            const meta = document.querySelector('meta[name="flirt-media-base"]');
            return meta && meta.content ? meta.content.replace(/\/$/, '') : 'https://www.flirthair.co.za';
        })();

        // Get auth token from storage
        function getToken() {
            return localStorage.getItem('flirt_token');
        }

        // API connectivity status
        let apiConnected = true;

        // Show connection error banner
        function showConnectionError() {
            const existingBanner = document.getElementById('connectionError');
            if (existingBanner) return;

            const banner = document.createElement('div');
            banner.id = 'connectionError';
            banner.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; background: var(--danger); color: white; padding: 12px 20px; text-align: center; z-index: 10000; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 10px;';
            banner.innerHTML = `
                <span>Unable to connect to server. Some features may not work.</span>
                <button onclick="retryConnection()" style="background: white; color: var(--danger); border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: 600;">Retry</button>
            `;
            document.body.prepend(banner);
        }

        // Hide connection error banner
        function hideConnectionError() {
            const banner = document.getElementById('connectionError');
            if (banner) banner.remove();
        }

        // Retry API connection
        async function retryConnection() {
            try {
                await fetch(`${API_BASE}/health`, { method: 'GET' });
                apiConnected = true;
                hideConnectionError();
                location.reload();
            } catch (e) {
                alert('Still unable to connect. Please ensure the server is running.');
            }
        }

        // API helper function with graceful error handling
        async function apiCall(endpoint, options = {}) {
            const token = getToken();
            const headers = {
                'Content-Type': 'application/json',
                ...(token && { 'Authorization': `Bearer ${token}` })
            };

            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    ...options,
                    headers: { ...headers, ...options.headers }
                });
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'API request failed');
                }
                apiConnected = true;
                hideConnectionError();
                return data;
            } catch (error) {
                console.error('API Error:', error);
                // Detect network/connection errors
                if (error.message.includes('Failed to fetch') ||
                    error.message.includes('NetworkError') ||
                    error.name === 'TypeError') {
                    apiConnected = false;
                    showConnectionError();
                }
                throw error;
            }
        }

        // ============================================
        // AUTH STATE & FUNCTIONS
        // ============================================
        let currentUser = null;

        // Auth Gate Functions
        function showAuthGate() {
            document.getElementById('authGate').classList.remove('hidden');
        }

        function hideAuthGate() {
            document.getElementById('authGate').classList.add('hidden');
        }

        function showAuthGateLogin() {
            hideAuthGate();
            showAuthModal();
            switchAuthTab('login');
        }

        function showAuthGateSignup() {
            hideAuthGate();
            showAuthModal();
            switchAuthTab('signup');
        }

        function showAuthModal() {
            document.getElementById('authModal').classList.add('show');
        }

        function closeAuthModalAndShowGate(event) {
            // If called from click on modal background (not content), close and show gate
            // If called from X button (no event), also close and show gate
            if (!event || event.target === event.currentTarget) {
                closeModal('authModal');
                // Only show auth gate if user is not logged in
                if (!currentUser) {
                    showAuthGate();
                }
            }
        }

        function switchAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));

            if (tab === 'login') {
                document.querySelector('.auth-tab:first-child').classList.add('active');
                document.getElementById('loginForm').classList.add('active');
            } else {
                document.querySelector('.auth-tab:last-child').classList.add('active');
                document.getElementById('signupForm').classList.add('active');
            }
            clearAuthError();
        }

        function showAuthError(message) {
            const errorEl = document.getElementById('authError');
            errorEl.textContent = message;
            errorEl.classList.add('show');
        }

        function clearAuthError() {
            const errorEl = document.getElementById('authError');
            if (errorEl) {
                errorEl.textContent = '';
                errorEl.classList.remove('show');
            }
        }

        // Email validation regex
        const emailRegex = /^[^@\s]+@[^@\s]+\.[^@\s]+$/;

        async function handleLogin(event) {
            if (event) event.preventDefault();

            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const btn = document.getElementById('loginBtn');

            if (!email || !password) {
                showAuthError('Please enter email and password');
                return;
            }

            if (!emailRegex.test(email)) {
                showAuthError('Please enter a valid email address');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span>';

            try {
                const data = await apiCall('/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ email, password })
                });

                localStorage.setItem('flirt_token', data.token);
                currentUser = data.user;
                onLoginSuccess();
            } catch (error) {
                showAuthError(error.message || 'Something went wrong. Please try again.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Login';
            }
        }

        async function handleSignup(event) {
            if (event) event.preventDefault();

            const name = document.getElementById('signupName').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const phone = document.getElementById('signupPhone').value.trim();
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupPasswordConfirm').value;
            const referralCode = document.getElementById('signupReferral').value.trim();
            const btn = document.getElementById('signupBtn');

            if (!name) {
                showAuthError('Please enter your name');
                return;
            }

            if (!email) {
                showAuthError('Please enter your email address');
                return;
            }

            if (!emailRegex.test(email)) {
                showAuthError('Please enter a valid email address');
                return;
            }

            if (!password) {
                showAuthError('Please enter a password');
                return;
            }

            if (password.length < 6) {
                showAuthError('Password must be at least 6 characters');
                return;
            }

            if (password !== confirmPassword) {
                showAuthError('Passwords do not match');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span>';

            try {
                const data = await apiCall('/auth/signup', {
                    method: 'POST',
                    body: JSON.stringify({ name, email, phone, password })
                });

                localStorage.setItem('flirt_token', data.token);
                currentUser = data.user;

                // Apply referral code if provided
                if (referralCode) {
                    try {
                        await apiCall('/referrals/apply', {
                            method: 'POST',
                            body: JSON.stringify({ referralCode })
                        });
                    } catch (e) {
                        console.log('Referral code error:', e.message);
                    }
                }

                onLoginSuccess();
            } catch (error) {
                showAuthError(error.message || 'Something went wrong. Please try again.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Create Account';
            }
        }

        // Clear errors when user starts typing
        function setupAuthInputListeners() {
            const authInputs = [
                'loginEmail', 'loginPassword',
                'signupName', 'signupEmail', 'signupPhone',
                'signupPassword', 'signupPasswordConfirm', 'signupReferral'
            ];

            authInputs.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('input', clearAuthError);
                }
            });
        }

        function onLoginSuccess() {
            closeModal('authModal');
            hideAuthGate(); // Hide the auth gate on successful login
            document.body.classList.add('logged-in');
            updateUserUI();
            loadUserData();
            loadUpcomingAppointment();

            // Clear guest chat conversation so user gets a fresh conversation linked to their account
            localStorage.removeItem('flirt_conversation_id');
            localStorage.removeItem('flirt_guest_id');
            currentConversationId = null;
        }

        async function checkAuthStatus() {
            const token = getToken();
            if (!token) {
                // No token - show auth gate
                showAuthGate();
                return;
            }

            try {
                const data = await apiCall('/auth/me');
                currentUser = data.user;
                document.body.classList.add('logged-in');
                hideAuthGate(); // User is authenticated - hide the gate
                updateUserUI();
                await loadUserData();
                await loadUpcomingAppointment();
            } catch (error) {
                // Token was present but invalid/expired - clear it and show auth gate
                localStorage.removeItem('flirt_token');
                currentUser = null;
                document.body.classList.remove('logged-in');
                updateUserUI();
                showAuthGate();

                // Show non-intrusive feedback about session expiry
                showToast({
                    title: 'Session expired',
                    message: 'Please sign in again to view your profile and bookings.',
                    type: 'info'
                });
            }
        }

        // Dev-only auto-login when running locally without a token
        async function devAutoLoginIfNeeded() {
            const hasToken = !!getToken();
            const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            if (hasToken || !isLocalhost) return;
            try {
                const res = await fetch(`${API_BASE}/auth/dev-login`);
                if (!res.ok) return;
                const data = await res.json();
                if (data.token && data.user) {
                    localStorage.setItem('flirt_token', data.token);
                    currentUser = data.user;
                    document.body.classList.add('logged-in');
                    updateUserUI();
                    await loadUserData();
                    await loadUpcomingAppointment();
                }
            } catch (e) {
                console.warn('Dev auto-login failed:', e);
            }
        }

        function updateUserUI() {
            // Update profile section - handles both logged-in and guest states
            const avatar = document.getElementById('profileAvatar');
            const name = document.getElementById('profileName');
            const tierText = document.getElementById('profileTierText');

            // Update welcome banner
            const welcomeTitle = document.getElementById('welcomeTitle');
            const welcomeSubtitle = document.getElementById('welcomeSubtitle');
            const pointsDisplayBanner = document.getElementById('pointsDisplay');
            const bannerPoints = document.getElementById('bannerPoints');
            const bannerTier = document.getElementById('bannerTier');

            if (!currentUser) {
                // Guest state
                if (avatar) avatar.textContent = '?';
                if (name) name.textContent = 'Guest';
                if (tierText) tierText.textContent = 'Sign in to unlock rewards';

                // Welcome banner for guests
                if (welcomeTitle) welcomeTitle.textContent = 'Welcome to FL!RT ';
                if (welcomeSubtitle) welcomeSubtitle.textContent = 'Book your next appointment and let our expert stylists work their magic';
                if (pointsDisplayBanner) pointsDisplayBanner.style.display = 'none';
                return;
            }

            // Logged-in state
            if (avatar) avatar.textContent = currentUser.name?.charAt(0).toUpperCase() || 'U';
            if (name) name.textContent = currentUser.name || 'User';
            if (tierText) {
                const tier = currentUser.tier || 'bronze';
                const niceTier = tier.charAt(0).toUpperCase() + tier.slice(1);
                tierText.textContent = `${niceTier} Tier Member`;
            }

            // Welcome banner for logged-in users
            const firstName = currentUser.name?.split(' ')[0] || 'there';
            if (welcomeTitle) welcomeTitle.textContent = `Welcome back, ${firstName}! `;
            if (welcomeSubtitle) welcomeSubtitle.textContent = 'Book your next appointment and let our expert stylists work their magic';

            // Show points display
            if (pointsDisplayBanner) pointsDisplayBanner.style.display = 'flex';
            if (bannerPoints) bannerPoints.textContent = (currentUser.points ?? 0).toLocaleString();
            if (bannerTier) {
                const tier = currentUser.tier || 'bronze';
                const niceTier = tier.charAt(0).toUpperCase() + tier.slice(1);
                bannerTier.textContent = niceTier;
            }

            // Update rewards section - use #userPoints which has class .stat-number
            const pointsDisplay = document.getElementById('userPoints');
            if (pointsDisplay) pointsDisplay.textContent = (currentUser.points ?? 0).toLocaleString();

            const referralCode = document.querySelector('.referral-code');
            if (referralCode) referralCode.textContent = currentUser.referralCode || '';

            // Update tier display if loyalty config is loaded
            if (loyaltyConfig) {
                updateTierDisplay();
            }
        }

        async function loadUserData() {
            if (!currentUser) return;

            try {
                // Load loyalty balance
                const loyalty = await apiCall('/loyalty/balance');
                currentUser.points = loyalty.points;
                currentUser.tier = loyalty.tier;
                currentUser.referralCode = loyalty.referralCode || currentUser.referralCode;
                updateUserUI();
            } catch (error) {
                console.log('Error loading user data:', error);
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                // Clear auth token and user state
                localStorage.removeItem('flirt_token');
                currentUser = null;
                document.body.classList.remove('logged-in');

                // Update profile UI to show guest state immediately
                updateUserUI();

                // Show auth gate again
                showAuthGate();

                // Show confirmation toast
                showToast({ type: 'info', title: 'Logged Out', message: 'You have been logged out successfully.' });

                // Switch to home tab
                switchTab('home');
            }
        }

        // ============================================
        // TAB NAVIGATION
        // ============================================
        // switchTab handles both click events (from nav tabs) and programmatic calls (from JS)
        // When called from onclick, pass the event: switchTab('home', event)
        // When called programmatically, just pass the tab name: switchTab('home')
        function switchTab(tabName, evt) {
            const contentAreas = document.querySelectorAll('.content-area');
            contentAreas.forEach(area => area.classList.remove('active'));

            const targetContent = document.getElementById(tabName);
            if (targetContent) {
                targetContent.classList.add('active');
            }

            // Clear active state from all nav tabs
            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(tab => tab.classList.remove('active'));

            // Set active state on the appropriate nav tab
            if (evt && evt.target) {
                // Click event path: find the clicked nav-tab
                const clickedTab = evt.target.closest('.nav-tab');
                if (clickedTab) clickedTab.classList.add('active');
            } else {
                // Programmatic path: find nav-tab by data-tab attribute
                const targetTab = document.querySelector(`.nav-tab[data-tab="${tabName}"]`);
                if (targetTab) targetTab.classList.add('active');
            }

            // Load data for specific tabs
            if (tabName === 'rewards') {
                loadUserData();
                loadLoyaltyConfig();
            } else if (tabName === 'tracker') {
                loadHairTracker();
            } else if (tabName === 'team') {
                loadTeam();
            } else if (tabName === 'booking') {
                loadBookingTypes();
            } else if (tabName === 'shop') {
                if (allProducts.length === 0) {
                    loadProducts();
                }
            }
        }

        // Simple section navigator to booking tab or other anchors
        function navigateToSection(section) {
            if (section === 'book') {
            switchTab('booking');
            document.getElementById('booking')?.scrollIntoView({ behavior: 'smooth' });
            } else if (section === 'my-bookings') {
                switchTab('booking');
                document.getElementById('booking')?.scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Quick book a specific service type from home page
        function quickBookService(serviceType) {
            switchTab('booking');
            // Pre-select booking type based on service
            if (serviceType === 'hair' || serviceType === 'extensions') {
                selectBookingType('hair');
            } else if (serviceType === 'nails' || serviceType === 'beauty' || serviceType === 'facial' || serviceType === 'lashes' || serviceType === 'makeup') {
                selectBookingType('beauty');
            } else {
                // Default to hair for unknown types
                selectBookingType('hair');
            }
        }

        // ============================================
        // BOOKING STATE & DATA
        // ============================================
        let bookingType = null;
        let selectedStylist = null;
        let selectedService = null;
        let selectedServiceId = null;
        let selectedDate = null;
        let selectedTime = null;

        // Local cache for stylists/services (loaded from API)
        let stylists = {};
        let services = {};
        let beautyServices = {};
        let hairServicesRaw = []; // Raw service data from API
        let bookingDataLoaded = false;

        // Default images for services (fallback when no image_url)
        const defaultServiceImages = {
            'tape': 'https://www.flirthair.co.za/wp-content/uploads/2022/03/categories1.jpg',
            'weft': 'https://www.flirthair.co.za/wp-content/uploads/2022/03/categories3.jpg',
            'color': 'https://www.flirthair.co.za/wp-content/uploads/2022/03/categories5.jpg',
            'maintenance': 'https://www.flirthair.co.za/wp-content/uploads/2022/03/categories7.jpg',
            'default': 'https://www.flirthair.co.za/wp-content/uploads/2022/03/categories1.jpg'
        };

        // Format duration in minutes to human-readable string
        function formatDuration(minutes) {
            if (!minutes || minutes <= 0) return '';
            if (minutes < 60) return `${minutes} min`;
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            if (mins === 0) return `${hours}h`;
            return `${hours}h ${mins}min`;
        }

        // Format price for display
        function formatServicePrice(price) {
            if (price === 0 || price === null || price === undefined) return 'Free';
            return `R${price.toLocaleString()}`;
        }

        // Get service image URL with fallback
        function getServiceImage(service) {
            if (service.image_url) return service.image_url;
            const slug = (service.name || '').toLowerCase();
            if (slug.includes('tape')) return defaultServiceImages['tape'];
            if (slug.includes('weft')) return defaultServiceImages['weft'];
            if (slug.includes('color')) return defaultServiceImages['color'];
            if (slug.includes('maint')) return defaultServiceImages['maintenance'];
            return defaultServiceImages['default'];
        }

        // Render hair services grid from API data
        function renderHairServicesGrid() {
            const grid = document.getElementById('hairServicesGrid');
            if (!grid) return;

            if (hairServicesRaw.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--gray-medium);">
                        No hair services available at the moment.
                    </div>
                `;
                return;
            }

            grid.innerHTML = hairServicesRaw
                .filter(s => s.active !== 0) // Only show active services
                .sort((a, b) => (a.display_order || 0) - (b.display_order || 0))
                .map(service => {
                    const imageUrl = getServiceImage(service);
                    const durationText = formatDuration(service.duration);
                    const priceText = formatServicePrice(service.price);

                    return `
                        <div class="service-card" onclick="selectHairService('${service.id}', this)">
                            <img src="${imageUrl}" alt="${service.name}" class="service-image" onerror="this.src='${defaultServiceImages['default']}'">
                            <div class="service-content">
                                <div class="service-name">${service.name}</div>
                                ${durationText ? `<div class="service-duration">${durationText}</div>` : ''}
                                <div class="service-price">${priceText}</div>
                            </div>
                        </div>
                    `;
                }).join('');
        }

        // Load data from API on init
        async function loadBookingData() {
            try {
                // Load stylists
                const stylistsData = await apiCall('/stylists');
                stylistsData.stylists.forEach(s => {
                    const entry = {
                        name: s.name,
                        specialty: s.specialty,
                        avatar: s.name.charAt(0),
                        color: `linear-gradient(135deg, ${s.color} 0%, ${s.color}99 100%)`
                    };
                    // Store by full id and simple id (for legacy hardcoded cards like "lisa", "emma")
                    stylists[s.id] = entry;
                    const simpleId = s.id.replace(/^stylist_/, '').toLowerCase();
                    stylists[simpleId] = entry;
                });

                // Load hair services
                const hairData = await apiCall('/services/hair');
                hairServicesRaw = hairData.services || [];
                hairData.services.forEach(s => {
                    const entry = {
                        id: s.id,
                        name: s.name,
                        price: s.price === 0 ? 'Free' : `R${s.price.toLocaleString()}`,
                        duration: s.duration,
                        image_url: s.image_url
                    };
                    services[s.id] = entry;
                    const slug = s.name.toLowerCase().replace(/[^a-z0-9]/g, '');
                    services[slug] = entry;
                    if (slug.includes('tape')) services['tape'] = entry;
                    if (slug.includes('weft')) services['weft'] = entry;
                    if (slug.includes('color')) services['color'] = entry;
                    if (slug.includes('maint')) services['maintenance'] = entry;
                });

                // Render the hair services grid
                renderHairServicesGrid();

                // Load beauty services
                const beautyData = await apiCall('/services/beauty');
                beautyData.services.forEach(s => {
                    beautyServices[s.id] = {
                        id: s.id,
                        name: s.name,
                        duration: `${s.duration || 0} min`,
                        price: `R${s.price}`
                    };
                });
                bookingDataLoaded = true;
            } catch (error) {
                console.log('Using fallback data:', error);
                // Fallback to hardcoded data if API fails
                stylists = {
                    'lisa': { name: 'Lisa Thompson', specialty: 'Senior Stylist', avatar: 'L', color: 'linear-gradient(135deg, #F67599 0%, #e05a7f 100%)' },
                    'emma': { name: 'Emma Williams', specialty: 'Extension Specialist', avatar: 'E', color: 'linear-gradient(135deg, #F67599 0%, #e05a7f 100%)' },
                    'sarah': { name: 'Sarah Martinez', specialty: 'Color Expert', avatar: 'S', color: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' },
                    'maya': { name: 'Maya Johnson', specialty: 'Maintenance Expert', avatar: 'M', color: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)' }
                };
                services = {
                    'tape': { id: 'tape', name: 'Tape Extensions', price: 'R2,500', duration: 150 },
                    'weft': { id: 'weft', name: 'Weft Installation', price: 'R3,200', duration: 210 },
                    'color': { id: 'color', name: 'Color Matching', price: 'Free', duration: 30 },
                    'maintenance': { id: 'maintenance', name: 'Maintenance', price: 'R800', duration: 90 }
                };
                // Also populate hairServicesRaw for grid rendering
                hairServicesRaw = [
                    { id: 'tape', name: 'Tape Extensions', price: 2500, duration: 150, active: 1 },
                    { id: 'weft', name: 'Weft Installation', price: 3200, duration: 210, active: 1 },
                    { id: 'color', name: 'Color Matching', price: 0, duration: 30, active: 1 },
                    { id: 'maintenance', name: 'Maintenance', price: 800, duration: 90, active: 1 }
                ];
                renderHairServicesGrid();

                beautyServices = {
                    'facial': { name: 'Facial Treatment', duration: '60 min', price: 'R450' },
                    'manicure': { name: 'Manicure', duration: '45 min', price: 'R250' },
                    'pedicure': { name: 'Pedicure', duration: '60 min', price: 'R300' },
                    'waxing': { name: 'Waxing', duration: '30-60 min', price: 'From R150' },
                    'threading': { name: 'Eyebrow Threading', duration: '15 min', price: 'R80' },
                    'massage': { name: 'Massage Therapy', duration: '60 min', price: 'R500' }
                };
            }
        }

        // Load stylist-specific services
        async function loadStylistServices(stylistId, serviceType) {
            try {
                // Get the actual stylist ID (convert from simple id if needed)
                let actualStylistId = stylistId;

                // If it's a simple ID like 'lisa', try to find the full ID
                if (!stylistId.startsWith('stylist_')) {
                    // Try to find stylist in cache by iterating
                    const stylistsData = await apiCall('/stylists');
                    const matchingStylist = stylistsData.stylists.find(s => {
                        const simpleId = s.id.replace(/^stylist_/, '').toLowerCase();
                        return simpleId === stylistId.toLowerCase() || s.name.toLowerCase().includes(stylistId.toLowerCase());
                    });

                    if (matchingStylist) {
                        actualStylistId = matchingStylist.id;
                    }
                }

                // Fetch services for this specific stylist
                const response = await fetch(`/api/stylists/${actualStylistId}/services?type=${serviceType}`);
                const data = await response.json();

                if (data.success && data.services && data.services.length > 0) {
                    // Only clear the relevant service cache, not both
                    // Populate services based on type
                    data.services.forEach(s => {
                        const entry = {
                            id: s.id,
                            name: s.name,
                            price: s.price === 0 ? 'Free' : `R${s.price.toLocaleString()}`,
                            duration: s.duration,
                            image_url: s.image_url
                        };

                        if (serviceType === 'hair') {
                            services[s.id] = entry;
                            const slug = s.name.toLowerCase().replace(/[^a-z0-9]/g, '');
                            services[slug] = entry;
                            // Legacy mappings
                            if (slug.includes('tape')) services['tape'] = entry;
                            if (slug.includes('weft')) services['weft'] = entry;
                            if (slug.includes('color')) services['color'] = entry;
                            if (slug.includes('maint')) services['maintenance'] = entry;
                        } else if (serviceType === 'beauty') {
                            beautyServices[s.id] = {
                                id: s.id,
                                name: s.name,
                                duration: `${s.duration} min`,
                                price: `R${s.price}`
                            };
                        }
                    });

                    console.log(`Loaded ${data.services.length} ${serviceType} services for stylist ${stylistId}`);
                } else {
                    console.log('No services found for this stylist, using all services from cache');
                    // Don't reload all data - just use what's already cached
                    // This prevents clearing services when stylist has no specific services assigned
                }
            } catch (error) {
                console.error('Error loading stylist services:', error);
                // Fallback to loading all services
                await loadBookingData();
            }
        }

        // Load Dynamic Booking Type Cards
        async function loadBookingTypes() {
            try {
                const response = await fetch('/api/service-types');
                const data = await response.json();

                const container = document.getElementById('bookingTypeCardsContainer');

                if (!data.success || !data.types || data.types.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">No services available at this time</div>';
                    return;
                }

                // Default images for service types
                const defaultImages = {
                    'hair': 'https://www.flirthair.co.za/wp-content/uploads/2022/03/home-footer-images3.jpg',
                    'beauty': 'https://www.flirthair.co.za/wp-content/uploads/2022/03/home-footer-images2.jpg',
                    'spa': 'https://www.flirthair.co.za/wp-content/uploads/2022/03/categories7.jpg'
                };

                container.innerHTML = data.types.map(typeData => {
                    const type = typeData.type;
                    const serviceCount = typeData.count;
                    const services = typeData.services || [];

                    // Get the first service's image or use default
                    const imageUrl = services[0]?.image_url || defaultImages[type] || defaultImages['beauty'];

                    // Generate description based on service type
                    let description = '';
                    let features = '';

                    if (type === 'hair') {
                        description = 'Book with your favorite extension stylist';
                        features = services.slice(0, 3).map(s => ` ${s.name}`).join('<br>');
                    } else if (type === 'beauty') {
                        description = 'General beauty treatments - no stylist needed';
                        features = services.slice(0, 3).map(s => ` ${s.name}`).join('<br>');
                    } else {
                        description = `${serviceCount} service${serviceCount > 1 ? 's' : ''} available`;
                        features = services.slice(0, 3).map(s => ` ${s.name}`).join('<br>');
                    }

                    const title = type.charAt(0).toUpperCase() + type.slice(1) + (type === 'hair' ? ' Extensions' : type === 'beauty' ? ' Salon' : '');

                    return `
                        <div class="booking-type-card" onclick="selectBookingType('${type}')">
                            <div class="booking-type-image" style="background-image: url('${imageUrl}');">
                                <div class="booking-type-overlay"></div>
                            </div>
                            <div class="booking-type-content">
                                <div class="booking-type-title">${title}</div>
                                <div class="booking-type-description">${description}</div>
                                <div class="booking-type-features">
                                    ${features}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading booking types:', error);
                document.getElementById('bookingTypeCardsContainer').innerHTML =
                    '<div style="text-align: center; padding: 40px; color: var(--text-muted);">Error loading services. Please try again later.</div>';
            }
        }

        // Booking Type Selection
        async function selectBookingType(type) {
            bookingType = type;

            // Hide booking type selection
            document.getElementById('bookingTypeSelection').style.display = 'none';

            if (type === 'hair') {
                // NEW FLOW: Show hair service selection FIRST (not stylist)
                document.getElementById('hairServiceSelection').style.display = 'block';
            } else if (type === 'beauty') {
                // Show beauty service selection (no stylist needed)
                document.getElementById('beautyBooking').style.display = 'block';
                // Load beauty services dynamically
                await loadBeautyServicesForDisplay();
            }
        }

        // Change Booking Type
        function changeBookingType() {
            // Reset everything
            bookingType = null;
            selectedStylist = null;
            selectedService = null;
            selectedDate = null;
            selectedTime = null;

            // Hide all booking sections
            document.getElementById('hairServiceSelection').style.display = 'none';
            document.getElementById('stylistSelection').style.display = 'none';
            document.getElementById('bookingForm').style.display = 'none';
            document.getElementById('beautyBooking').style.display = 'none';
            document.getElementById('beautyBookingCalendar').style.display = 'none';

            // Show booking type selection
            document.getElementById('bookingTypeSelection').style.display = 'block';
        }

        // Hair Service Selection (NEW FLOW - Step 1)
        async function selectHairService(serviceType, el) {
            await ensureBookingData();

            // Construct the full service ID (e.g., 'tape' -> 'service_tape')
            const serviceId = `service_${serviceType}`;

            // Find service from cache or build from card DOM
            let service = services[serviceId] || services[serviceType];
            const targetCard = el ? el.closest('.service-card') : null;

            if (!service && targetCard) {
                const name = targetCard.querySelector('.service-name')?.textContent?.trim() || 'Selected Service';
                const duration = targetCard.querySelector('.service-duration')?.textContent?.trim() || '';
                const price = targetCard.querySelector('.service-price')?.textContent?.trim() || '';
                service = { id: serviceId, name, duration, price };
                services[serviceId] = service;
            }

            if (!service) {
                showToast({ type: 'error', title: 'Service unavailable', message: 'Please reload and try again.' });
                return;
            }

            selectedService = serviceType;
            selectedServiceId = serviceId;  // Use the full service ID for the API

            // Update selected state on cards
            const cards = document.querySelectorAll('#hairServiceSelection .service-card');
            cards.forEach(card => card.classList.remove('selected'));
            if (targetCard) targetCard.classList.add('selected');

            // Update banner in stylist selection section
            document.getElementById('selectedHairServiceNameBanner').textContent = service.name;
            document.getElementById('selectedHairServiceDetailsBanner').textContent = `${service.duration} - ${service.price}`;

            // Show stylist selection, hide hair service selection
            setTimeout(() => {
                document.getElementById('hairServiceSelection').style.display = 'none';
                document.getElementById('stylistSelection').style.display = 'block';
                document.getElementById('stylistSelection').scrollIntoView({ behavior: 'smooth' });
            }, 300);
        }

        // Go back to hair service selection
        function goBackToHairService() {
            document.getElementById('stylistSelection').style.display = 'none';
            document.getElementById('hairServiceSelection').style.display = 'block';
            document.getElementById('hairServiceSelection').scrollIntoView({ behavior: 'smooth' });
            selectedService = null;
            selectedServiceId = null;
        }

        // Go back to stylist selection (from date selection)
        function goBackToStylist() {
            document.getElementById('bookingForm').style.display = 'none';
            document.getElementById('stylistSelection').style.display = 'block';
            document.getElementById('stylistSelection').scrollIntoView({ behavior: 'smooth' });
            selectedStylist = null;
            selectedDate = null;
            selectedTime = null;
        }

        // Stylist Selection (UPDATED - Step 2 in new flow)
        async function selectStylist(stylistId) {
            selectedStylist = stylistId;
            const stylist = stylists[stylistId];

            // Update selected state on stylist cards
            const cards = document.querySelectorAll('#stylistSelection .stylist-card');
            cards.forEach(card => card.classList.remove('selected'));
            event?.target?.closest('.stylist-card')?.classList.add('selected');

            // Update selected stylist displays in booking form
            document.getElementById('selectedStylistName2').textContent = stylist.name;

            const avatars = document.querySelectorAll('.stylist-avatar-small');
            avatars.forEach(avatar => {
                avatar.textContent = stylist.avatar;
                avatar.style.background = stylist.color;
            });

            // Load stylist-specific services based on currently selected service type
            // Determine service type from the currently showing service selection
            const hairSection = document.getElementById('hairServiceSelection');
            const beautySection = document.getElementById('beautyServiceSelection');
            let serviceType = 'hair'; // default

            if (beautySection && beautySection.style.display !== 'none') {
                serviceType = 'beauty';
            } else if (hairSection && hairSection.style.display !== 'none') {
                serviceType = 'hair';
            }

            // Load this stylist's specific services
            await loadStylistServices(stylistId, serviceType);

            // Update the service name display in booking form banner
            if (selectedService && services[selectedService]) {
                const service = services[selectedService];
                document.getElementById('selectedServiceName').textContent = `${service.name} - ${service.price}`;
            }

            // NEW FLOW: Show date selection (bookingForm), hide stylist selection
            setTimeout(() => {
                document.getElementById('stylistSelection').style.display = 'none';
                document.getElementById('bookingForm').style.display = 'block';
                document.getElementById('bookingForm').scrollIntoView({ behavior: 'smooth' });

                // Generate calendar for date selection
                generateCalendar();
            }, 300);
        }

        // Change Stylist
        function changeStylist() {
            document.getElementById('stylistSelection').style.display = 'block';
            document.getElementById('serviceSelection').style.display = 'none';
            document.getElementById('bookingForm').style.display = 'none';
            selectedStylist = null;
            selectedService = null;
        }

        // Service Selection
        async function ensureBookingData() {
            if (bookingDataLoaded) return;
            try {
                await loadBookingData();
            } catch (e) {
                console.error('Failed to refresh booking data:', e);
            }
        }

        async function selectService(serviceType, el) {
            await ensureBookingData();
            // Find service from cache; if missing, build from the card DOM
            let service = services[serviceType];
            const targetCard = el ? el.closest('.service-card') : null;
            if (!service && targetCard) {
                const name = targetCard.querySelector('.service-name')?.textContent?.trim() || 'Selected Service';
                const price = targetCard.querySelector('.service-price')?.textContent?.trim() || '';
                service = { id: serviceType, name, price };
                services[serviceType] = service;
            }

            if (!service) {
                showToast({ type: 'error', title: 'Service unavailable', message: 'Please reload and try again.' });
                return;
            }

            selectedService = serviceType;
            selectedServiceId = service.id || serviceType;

            const cards = document.querySelectorAll('#serviceSelection .service-card');
            cards.forEach(card => card.classList.remove('selected'));
            if (targetCard) targetCard.classList.add('selected');

            // Update service name display
            document.getElementById('selectedServiceName').textContent = `${service.name} - ${service.price}`;

            // Show booking form
            setTimeout(() => {
                document.getElementById('bookingForm').style.display = 'block';
                document.getElementById('bookingForm').scrollIntoView({ behavior: 'smooth' });

                // Generate calendar
                generateCalendar();
            }, 300);
        }

        // Go back to service selection
        function goBackToService() {
            document.getElementById('serviceSelection').scrollIntoView({ behavior: 'smooth' });
            document.getElementById('bookingForm').style.display = 'none';
            selectedService = null;
        }

        // Compare Availability - Modal
        function compareAvailability() {
            alert('Compare Availability Feature:\n\nThis would show a side-by-side comparison of all stylists\' availability for the selected date and service, allowing you to see who else is available if your preferred stylist is fully booked.');
        }

        // Beauty Service Selection
        async function selectBeautyService(serviceType, el) {
            await ensureBookingData();
            selectedService = serviceType;
            const service = beautyServices[serviceType];

            const cards = document.querySelectorAll('#beautyBooking .service-card');
            cards.forEach(card => card.classList.remove('selected'));
            const targetCard = el ? el.closest('.service-card') : null;
            if (targetCard) targetCard.classList.add('selected');

            if (service) {
                selectedServiceId = service.id || serviceType;
                // Update service name display
                document.getElementById('selectedBeautyServiceName').textContent = service.name;
                document.getElementById('selectedBeautyServiceDetails').textContent = `${service.duration} - ${service.price}`;
            } else {
                selectedServiceId = serviceType;
            }

            // Show booking calendar
            setTimeout(() => {
                document.getElementById('beautyBookingCalendar').style.display = 'block';
                document.getElementById('beautyBookingCalendar').scrollIntoView({ behavior: 'smooth' });

                // Generate calendar for beauty
                generateBeautyCalendar();
            }, 300);
        }

        // Go back to beauty service selection
        function goBackToBeautyService() {
            document.getElementById('beautyBookingCalendar').style.display = 'none';
            selectedService = null;
            selectedDate = null;
            selectedTime = null;
        }

        // ========== DYNAMIC BEAUTY SERVICES RENDERING ==========
        let allBeautyServicesData = [];
        let currentBeautyCategory = 'all';

        // Category image mapping
        const categoryImages = {
            'Lash Extensions': 'https://images.unsplash.com/photo-1583001308095-72e91aeb8c94?w=400&h=300&fit=crop',
            'Dermaplaning': 'https://images.unsplash.com/photo-1570172619644-dfd03ed5d881?w=400&h=300&fit=crop',
            'Micro-Needling': 'https://images.unsplash.com/photo-1516975080664-ed2fc6a32937?w=400&h=300&fit=crop',
            'Facial Add-Ons': 'https://images.unsplash.com/photo-1560750588-73207b1ef5b8?w=400&h=300&fit=crop',
            'Brows & Lashes': 'https://images.unsplash.com/photo-1528459801416-a9e53bbf4e17?w=400&h=300&fit=crop',
            'Nails': 'https://images.unsplash.com/photo-1604654894610-df63bc536371?w=400&h=300&fit=crop',
            'Nails - Acrylic': 'https://images.unsplash.com/photo-1604654894610-df63bc536371?w=400&h=300&fit=crop',
            'Nails - Polygel': 'https://images.unsplash.com/photo-1604654894610-df63bc536371?w=400&h=300&fit=crop',
            'Pedicure': 'https://images.unsplash.com/photo-1519491050282-cf00c82424b4?w=400&h=300&fit=crop',
            'Male Grooming': 'https://images.unsplash.com/photo-1621605815971-fbc98d665033?w=400&h=300&fit=crop',
            'Waxing': 'https://images.unsplash.com/photo-1457972729786-0411a3b2b626?w=400&h=300&fit=crop'
        };

        async function loadBeautyServicesForDisplay() {
            try {
                const response = await fetch('/api/services/beauty');
                const data = await response.json();

                if (data.success && data.services) {
                    allBeautyServicesData = data.services;
                    renderBeautyCategoryFilters();
                    renderBeautyServices();
                } else {
                    throw new Error('Failed to load beauty services');
                }
            } catch (error) {
                console.error('Error loading beauty services:', error);
                document.getElementById('beautyServicesContainer').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--error-color);">
                        Failed to load beauty services. Please refresh the page.
                    </div>
                `;
            }
        }

        function renderBeautyCategoryFilters() {
            const categories = ['all', ...new Set(allBeautyServicesData.map(s => s.category).filter(Boolean))];
            const filterContainer = document.getElementById('beautyCategoryFilter');

            filterContainer.innerHTML = categories.map(cat => {
                const isActive = cat === currentBeautyCategory;
                const displayName = cat === 'all' ? 'All Services' : cat;
                const count = cat === 'all' ? allBeautyServicesData.length : allBeautyServicesData.filter(s => s.category === cat).length;

                return `
                    <button onclick="selectBeautyCategory('${cat}')"
                            style="padding: 8px 16px; border-radius: 20px; border: 1px solid ${isActive ? 'var(--primary-color)' : 'var(--gray-light)'};
                                   background: ${isActive ? 'var(--primary-color)' : 'white'}; color: ${isActive ? 'white' : 'var(--text-dark)'};
                                   cursor: pointer; font-size: 14px; white-space: nowrap; transition: all 0.2s;">
                        ${displayName} (${count})
                    </button>
                `;
            }).join('');
        }

        function selectBeautyCategory(category) {
            currentBeautyCategory = category;
            renderBeautyCategoryFilters();
            renderBeautyServices();
        }

        function filterBeautyServices() {
            renderBeautyServices();
        }

        function renderBeautyServices() {
            const searchTerm = document.getElementById('beautyServiceSearch')?.value.toLowerCase() || '';
            const container = document.getElementById('beautyServicesContainer');

            // Filter services
            let filteredServices = allBeautyServicesData;

            if (currentBeautyCategory !== 'all') {
                filteredServices = filteredServices.filter(s => s.category === currentBeautyCategory);
            }

            if (searchTerm) {
                filteredServices = filteredServices.filter(s =>
                    s.name.toLowerCase().includes(searchTerm) ||
                    (s.category && s.category.toLowerCase().includes(searchTerm))
                );
            }

            if (filteredServices.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--gray-medium);">
                        No services found matching your criteria.
                    </div>
                `;
                return;
            }

            // Group by category
            const grouped = {};
            filteredServices.forEach(service => {
                const cat = service.category || 'Other';
                if (!grouped[cat]) grouped[cat] = [];
                grouped[cat].push(service);
            });

            // Render grouped services
            let html = '';
            Object.keys(grouped).sort().forEach(category => {
                const services = grouped[category];

                html += `
                    <div style="margin-bottom: 30px;">
                        <h4 style="font-size: 16px; font-weight: 600; margin-bottom: 15px; color: var(--text-dark); border-bottom: 2px solid var(--primary-color); padding-bottom: 8px;">
                            ${category}
                        </h4>
                        <div class="service-grid">
                            ${services.map(service => {
                                const imageUrl = service.image_url || categoryImages[category] || 'https://images.unsplash.com/photo-1560750588-73207b1ef5b8?w=400&h=300&fit=crop';
                                return `
                                    <div class="service-card" onclick="selectBeautyService('${service.id}', this)">
                                        <img src="${imageUrl}" alt="${service.name}" class="service-image"
                                             onerror="this.src='https://images.unsplash.com/photo-1560750588-73207b1ef5b8?w=400&h=300&fit=crop'">
                                        <div class="service-content">
                                            <div class="service-name">${service.name}</div>
                                            <div class="service-duration">${service.duration || 0} min</div>
                                            <div class="service-price">R${service.price.toLocaleString()}</div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // ========== CALENDAR STATE ==========
        let hairCalendarMonthOffset = 0;
        let beautyCalendarMonthOffset = 0;
        let selectedDateStr = null; // Store as YYYY-MM-DD string

        // Reusable calendar renderer
        function renderCalendar(gridId, monthLabelId, monthOffset, calendarType) {
            const calendarGrid = document.getElementById(gridId);
            const monthLabel = document.getElementById(monthLabelId);
            calendarGrid.innerHTML = '';

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Calculate the target month
            const targetDate = new Date(today.getFullYear(), today.getMonth() + monthOffset, 1);
            const year = targetDate.getFullYear();
            const month = targetDate.getMonth();

            // Update month label
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
            monthLabel.textContent = `${monthNames[month]} ${year}`;

            // Days of week headers
            const days = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
            days.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.style.cssText = 'text-align: center; font-weight: 600; padding: 8px 4px; font-size: 11px; color: var(--gray-medium);';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });

            // First day of month (0 = Sunday)
            const firstDayOfMonth = new Date(year, month, 1).getDay();

            // Number of days in month
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Add empty cells for days before the first of the month
            for (let i = 0; i < firstDayOfMonth; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'calendar-day disabled';
                emptyCell.style.opacity = '0';
                calendarGrid.appendChild(emptyCell);
            }

            // Add day cells
            for (let day = 1; day <= daysInMonth; day++) {
                const cellDate = new Date(year, month, day);
                const dateStr = cellDate.toISOString().split('T')[0];
                const isPast = cellDate < today;
                const isToday = cellDate.getTime() === today.getTime();

                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                dayCell.textContent = day;
                dayCell.dataset.date = dateStr;

                if (isPast) {
                    dayCell.classList.add('disabled');
                    dayCell.style.opacity = '0.4';
                    dayCell.style.cursor = 'not-allowed';
                } else {
                    if (isToday) {
                        dayCell.style.border = '2px solid var(--brand-pink)';
                    }

                    // Check if this date is currently selected
                    if (selectedDateStr === dateStr) {
                        dayCell.classList.add('selected');
                    }

                    dayCell.onclick = function() {
                        // Clear selection from all calendars of this type
                        document.querySelectorAll(`#${gridId} .calendar-day`).forEach(d => d.classList.remove('selected'));
                        this.classList.add('selected');
                        selectedDateStr = dateStr;
                        selectedDate = day; // Keep for backward compatibility
                    };
                }

                calendarGrid.appendChild(dayCell);
            }
        }

        // Hair calendar navigation
        function changeHairCalendarMonth(delta) {
            // Don't allow going to past months
            if (hairCalendarMonthOffset + delta < 0) return;
            // Limit to 6 months ahead
            if (hairCalendarMonthOffset + delta > 6) return;

            hairCalendarMonthOffset += delta;
            generateCalendar();
        }

        // Beauty calendar navigation
        function changeBeautyCalendarMonth(delta) {
            // Don't allow going to past months
            if (beautyCalendarMonthOffset + delta < 0) return;
            // Limit to 6 months ahead
            if (beautyCalendarMonthOffset + delta > 6) return;

            beautyCalendarMonthOffset += delta;
            generateBeautyCalendar();
        }

        // Generate Beauty Calendar
        function generateBeautyCalendar() {
            renderCalendar('beautyCalendarGrid', 'beautyCalendarMonth', beautyCalendarMonthOffset, 'beauty');
        }

        // Beauty Time Slot Selection
        function selectBeautyTime(element) {
            document.querySelectorAll('#beautyTimeSlots .time-slot').forEach(slot => slot.classList.remove('selected'));
            element.classList.add('selected');
            selectedTime = element.textContent;
        }

        // Confirm Beauty Booking
        async function confirmBeautyBooking() {
            await ensureBookingData();
            if (!selectedService || !selectedDateStr || !selectedTime) {
                showToast({ type: 'error', title: 'Incomplete Booking', message: 'Please complete all booking steps' });
                return;
            }

            // Check if user is logged in
            if (!currentUser) {
                showAuthModal();
                return;
            }

            const service = beautyServices[selectedService];
            const bookingDate = new Date(selectedDateStr + 'T00:00:00');

            try {
                await apiCall('/bookings', {
                    method: 'POST',
                    body: JSON.stringify({
                        type: 'beauty',
                        serviceId: selectedServiceId || selectedService,
                        date: selectedDateStr,
                        time: selectedTime
                    })
                });

                showToast({ type: 'success', title: 'Booking Confirmed!', message: 'Your beauty appointment has been booked.' });

                // Show success modal
                setTimeout(() => {
                    showBookingConfirmation({
                        type: 'Beauty Salon',
                        service: service.name,
                        duration: service.duration,
                        price: service.price,
                        date: formatDateDisplay(bookingDate),
                        time: selectedTime || 'To be assigned',
                        therapist: 'Next available therapist will be assigned',
                        points: 50
                    });
                }, 100);

                // Reset booking state
                bookingType = null;
                selectedService = null;
                selectedServiceId = null;
                selectedDate = null;
                selectedDateStr = null;
                selectedTime = null;
                beautyCalendarMonthOffset = 0;

                // Reset UI
                document.getElementById('bookingTypeSelection').style.display = 'block';
                document.getElementById('beautyBooking').style.display = 'none';
                document.getElementById('beautyBookingCalendar').style.display = 'none';

                // Reload user data to update points
                loadUserData();
                switchTab('home');
            } catch (error) {
                showToast({ type: 'error', title: 'Booking Failed', message: error.message || 'Error creating booking' });
            }
        }

        // Calendar Generation for Hair Bookings
        function generateCalendar() {
            renderCalendar('calendarGrid', 'hairCalendarMonth', hairCalendarMonthOffset, 'hair');
        }

        // Time Slot Selection
        function selectTime(element) {
            if (element.classList.contains('unavailable')) {
                return;
            }
            document.querySelectorAll('.time-slot').forEach(slot => slot.classList.remove('selected'));
            element.classList.add('selected');
            selectedTime = element.textContent;
        }

        // Booking Confirmation
        async function confirmBooking() {
            await ensureBookingData();

            const requestedTimeWindow = document.getElementById('requestedTimeWindow').value;

            if (!selectedStylist || !selectedService || !selectedDateStr) {
                showToast({ type: 'error', title: 'Incomplete Booking', message: 'Please select a stylist, service, and preferred date' });
                return;
            }

            if (!requestedTimeWindow) {
                showToast({ type: 'error', title: 'Time Window Required', message: 'Please select a preferred time window' });
                return;
            }

            // Check if user is logged in
            if (!currentUser) {
                showAuthModal();
                return;
            }

            const stylist = stylists[selectedStylist];
            const service = services[selectedService];

            // Get time window details from BookingConstants
            const timeWindow = window.BookingConstants?.getTimeWindow(requestedTimeWindow);
            const timeWindowDisplay = timeWindow ? `${timeWindow.icon} ${timeWindow.label} (${timeWindow.description})` : requestedTimeWindow;

            const bookingDate = new Date(selectedDateStr + 'T00:00:00');
            const notes = document.querySelector('#bookingForm textarea')?.value || '';

            try {
                // Construct full IDs for database (e.g., 'lisa' -> 'stylist_lisa')
                const stylistId = selectedStylist.startsWith('stylist_') ? selectedStylist : `stylist_${selectedStylist}`;

                await apiCall('/bookings', {
                    method: 'POST',
                    body: JSON.stringify({
                        type: 'hair',
                        stylistId: stylistId,
                        serviceId: selectedServiceId || selectedService,
                        date: selectedDateStr,
                        requestedTimeWindow: requestedTimeWindow,
                        notes
                    })
                });

                showToast({ type: 'success', title: 'Request Submitted!', message: 'We will assign an exact time within 24 hours!' });

                // Show success modal
                setTimeout(() => {
                    alert(` Booking Request Submitted!\n\nStylist: ${stylist.name}\nService: ${service.name}\nPrice: ${service.price}\nPreferred Date: ${formatDateDisplay(bookingDate)}\nTime Window: ${timeWindowDisplay}\n\nOur salon team will assign an exact appointment time within 24 hours and notify you. You will also receive a confirmation email.\n\n+50 loyalty points earned! `);
                }, 100);

                // Reset booking state
                selectedStylist = null;
                selectedService = null;
                selectedServiceId = null;
                selectedDate = null;
                selectedDateStr = null;
                selectedTime = null;
                hairCalendarMonthOffset = 0;

                // Reset UI
                document.getElementById('stylistSelection').style.display = 'block';
                document.getElementById('serviceSelection').style.display = 'none';
                document.getElementById('bookingForm').style.display = 'none';

                // Reload user data to update points
                loadUserData();
                switchTab('home');
            } catch (error) {
                showToast({ type: 'error', title: 'Booking Failed', message: error.message || 'Error creating booking' });
            }
        }

        // Notification Center
        async function loadNotificationCenter() {
            try {
                const res = await fetch(`${API_BASE}/notifications/active`);
                if (res.ok) {
                    const data = await res.json();
                    notificationCenterState.items = data.notifications || [];
                    renderNotificationCenter(notificationCenterState.items);
                } else {
                    notificationCenterState.items = notificationCenterState.items || [];
                    renderNotificationCenter(notificationCenterState.items);
                }
            } catch (err) {
                console.error('Failed to load notifications', err);
                notificationCenterState.items = notificationCenterState.items || [];
                renderNotificationCenter(notificationCenterState.items);
            }
        }

function renderNotificationCenter(items = []) {
    const container = document.getElementById('notificationList');
    const seen = getSeenNotifications();
    if (!container) return;

    const unreadCount = items.filter(n => !seen.includes(n.id)).length;
    updateNotificationBadge(unreadCount);

    if (items.length === 0) {
        container.innerHTML = `<div class="notification-empty">No new notifications</div>`;
        return;
    }

    container.innerHTML = items.map(notif => {
        const icon = getNotificationIcon(notif.type);
        const isUnread = !seen.includes(notif.id);
        const railColor = icon.color;
        return `
            <div class="notification-item" data-id="${notif.id}">
                <div class="notification-rail" style="background:${railColor}; opacity:${isUnread ? 1 : 0.35};"></div>
                <div class="notification-content">
                    <div class="notification-header">
                        <div class="notification-title" style="display:flex; align-items:center; gap:8px;">
                            <span style="font-size:16px;">${icon.emoji}</span> ${notif.title || 'Notification'}
                        </div>
                        <div class="notification-time">${formatRelativeTime(notif.startsAt || notif.createdAt || notif.updatedAt)}</div>
                    </div>
                    <div class="notification-message">${notif.message || ''}</div>
                </div>
            </div>
        `;
    }).join('');
}

function markNotificationRead(id) {
    const seen = getSeenNotifications();
    if (!seen.includes(id)) {
        seen.push(id);
        setSeenNotifications(seen);
    }
}

function markAllNotificationsRead() {
    if (!notificationCenterState.items) notificationCenterState.items = [];
    const allIds = (notificationCenterState.items || []).map(n => n.id);
    setSeenNotifications(allIds);
    renderNotificationCenter(notificationCenterState.items || []);
}

// Modal Functions
async function showNotifications() {
    try {
        await loadNotificationCenter();
    } catch (e) {
        renderNotificationCenter(notificationCenterState.items || []);
    }
    const modal = document.getElementById('notificationModal');
    if (modal) modal.classList.add('show');
}

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.remove('show');
        }

        // ========== LOYALTY CONFIG ==========
        // Cached loyalty config loaded from API
        let loyaltyConfig = null;

        // Load loyalty configuration from API
        async function loadLoyaltyConfig() {
            if (loyaltyConfig) return loyaltyConfig;

            try {
                const response = await fetch(`${API_BASE}/loyalty/config`);
                const data = await response.json();

                if (data.success) {
                    loyaltyConfig = data;
                    renderRewardsSection();
                    return loyaltyConfig;
                }
            } catch (error) {
                console.error('Failed to load loyalty config:', error);
            }

            // Return fallback config if API fails
            return null;
        }

        // Render the rewards section from config
        function renderRewardsSection() {
            if (!loyaltyConfig) return;

            const { referral, pointsRules, earnRulesDisplay, tierThresholds } = loyaltyConfig;

            // Update title and subheading
            const titleEl = document.getElementById('rewardsTitle');
            if (titleEl && referral?.headline) {
                titleEl.textContent = referral.headline;
            }

            const subEl = document.getElementById('referralSubheading');
            if (subEl && referral?.subheading) {
                subEl.textContent = referral.subheading;
            }

            // Update referral code display
            if (currentUser?.referralCode) {
                const codeEl = document.getElementById('referralCodeDisplay');
                if (codeEl) codeEl.textContent = currentUser.referralCode;
            }

            // Update points display
            if (currentUser?.points !== undefined) {
                const pointsEl = document.getElementById('userPoints');
                if (pointsEl) pointsEl.textContent = currentUser.points.toLocaleString();
            }

            // Render Ways to Earn Points
            const earnContainer = document.getElementById('earnRulesContainer');
            if (earnContainer && Array.isArray(earnRulesDisplay)) {
                earnContainer.innerHTML = earnRulesDisplay.map((rule, index) => {
                    const key = rule.pointsKey;
                    let pointsLabel = '';

                    if (rule.isSpendRule) {
                        // e.g. Every R10 spent  +1 pt
                        pointsLabel = `+1 pt`;
                    } else {
                        const pts = pointsRules[key] || 0;
                        pointsLabel = `+${pts} pts`;
                    }

                    // Replace {spendRand} placeholder in label
                    const labelText = rule.label.replace('{spendRand}', pointsRules.spendRand || 10);
                    const isLast = index === earnRulesDisplay.length - 1;

                    return `
                        <div style="display: flex; justify-content: space-between; padding: 10px 0; ${isLast ? '' : 'border-bottom: 1px solid var(--gray-light);'}">
                            <span>${labelText}</span>
                            <strong style="color: var(--brand-pink);">${pointsLabel}</strong>
                        </div>
                    `;
                }).join('');
            }

            // Update tier display based on user's points
            updateTierDisplay();
        }

        // Update tier display based on current user's points
        function updateTierDisplay() {
            if (!loyaltyConfig || !currentUser) return;

            const { tierThresholds } = loyaltyConfig;
            const points = currentUser.points || 0;

            // Calculate current tier
            let currentTier = 'bronze';
            let tierLevel = 1;
            if (points >= tierThresholds.platinum) {
                currentTier = 'platinum';
                tierLevel = 4;
            } else if (points >= tierThresholds.gold) {
                currentTier = 'gold';
                tierLevel = 3;
            } else if (points >= tierThresholds.silver) {
                currentTier = 'silver';
                tierLevel = 2;
            }

            // Calculate progress to next tier
            const tierNames = ['bronze', 'silver', 'gold', 'platinum'];
            const tierEmojis = { bronze: '', silver: '', gold: '', platinum: '' };
            const nextTierIndex = Math.min(tierLevel, 3);
            const nextTier = tierNames[nextTierIndex];
            const nextThreshold = tierThresholds[nextTier] || tierThresholds.platinum;
            const currentThreshold = tierLevel === 1 ? 0 : tierThresholds[currentTier];

            const progressPercent = tierLevel === 4 ? 100 :
                Math.min(100, ((points - currentThreshold) / (nextThreshold - currentThreshold)) * 100);

            // Update UI
            const tierNameEl = document.getElementById('userTierName');
            if (tierNameEl) {
                tierNameEl.textContent = `${tierEmojis[currentTier]} ${currentTier.charAt(0).toUpperCase() + currentTier.slice(1)} Tier`;
            }

            const tierProgressEl = document.getElementById('userTierProgress');
            if (tierProgressEl) {
                if (tierLevel === 4) {
                    tierProgressEl.textContent = 'Maximum tier reached!';
                } else {
                    tierProgressEl.textContent = `${points.toLocaleString()} / ${nextThreshold.toLocaleString()} points to ${nextTier.charAt(0).toUpperCase() + nextTier.slice(1)}`;
                }
            }

            const tierLevelEl = document.getElementById('userTierLevel');
            if (tierLevelEl) {
                tierLevelEl.textContent = `Level ${tierLevel} of 4`;
            }

            const progressBar = document.getElementById('tierProgressBar');
            if (progressBar) {
                progressBar.style.width = `${progressPercent}%`;
            }

            // Update perks list
            const perks = getTierPerks(currentTier);
            const perksList = document.getElementById('tierPerksList');
            if (perksList && perks.length > 0) {
                perksList.innerHTML = perks.map(perk => `<li>${perk}</li>`).join('');
            }
        }

        // Get tier perks (fallback if not from API)
        function getTierPerks(tier) {
            const perks = {
                bronze: ['Earn points on every visit', 'Birthday surprise'],
                silver: ['5% off all services', 'Priority booking', 'Birthday surprise', 'Early access to sales'],
                gold: ['15% off all services', 'Free birthday blowout', 'Priority booking', 'Exclusive events', 'Free product samples'],
                platinum: ['20% off all services', 'Free monthly treatment', 'VIP parking', 'Personal stylist', 'Exclusive events', 'Complimentary refreshments']
            };
            return perks[tier] || perks.bronze;
        }

        // Get referral share message from config
        function getReferralShareMessage(code) {
            const referral = loyaltyConfig?.referral;
            let discountLabel = '10%'; // Default fallback

            if (referral) {
                if (referral.discountType === 'percent') {
                    discountLabel = `${referral.discountValue}%`;
                } else if (referral.discountType === 'amount') {
                    discountLabel = `R${referral.discountValue}`;
                }
            }

            const template = referral?.shareMessageTemplate ||
                'Check out Flirt Hair Extensions! Use my code {code} for {discount} off your first booking! ';

            return template
                .replace('{code}', code)
                .replace('{discount}', discountLabel);
        }

        // Referral Functions
        function shareReferral(platform) {
            const code = currentUser?.referralCode || 'FLIRT100';
            const message = getReferralShareMessage(code);

            switch(platform) {
                case 'whatsapp':
                    window.open(`https://wa.me/?text=${encodeURIComponent(message)}`);
                    break;
                case 'facebook':
                    alert('Copy this and share on Facebook:\n\n' + message);
                    break;
                case 'instagram':
                    alert('Copy this and share on Instagram:\n\n' + message);
                    break;
            }
        }

        function copyReferralCode() {
            const code = currentUser?.referralCode || 'FLIRT100';
            navigator.clipboard.writeText(code);
            showToast({ type: 'success', title: 'Copied!', message: 'Referral code copied to clipboard' });
        }

        // ========== HAIR TRACKER ==========
        let hairTrackerData = null;
        let hairTrackerConfig = null;

        // Load hair tracker data and config
        async function loadHairTracker() {
            if (!currentUser) {
                // Show setup prompt for non-logged in users
                document.getElementById('trackerSetupPrompt').style.display = 'block';
                document.getElementById('trackerMainContent').style.display = 'none';
                return;
            }

            try {
                const [trackerRes, configRes] = await Promise.all([
                    apiCall('/hair-tracker'),
                    fetch(`${API_BASE}/hair-tracker/config`).then(r => r.json())
                ]);

                if (trackerRes.success) {
                    hairTrackerData = trackerRes.data;
                }
                if (configRes.success) {
                    hairTrackerConfig = configRes.config;
                }

                renderHairTracker();
            } catch (error) {
                console.error('Failed to load hair tracker:', error);
                showToast({ type: 'error', title: 'Error', message: 'Failed to load hair tracker data' });
            }
        }

        // Render the hair tracker UI
        function renderHairTracker() {
            const data = hairTrackerData || {};
            const config = hairTrackerConfig || {};
            const copy = config.copy || {};

            // Update title and subtitle
            const titleEl = document.getElementById('trackerTitle');
            if (titleEl && copy.trackerTitle) {
                titleEl.textContent = copy.trackerTitle;
            }

            const subtitleEl = document.getElementById('trackerSubtitle');
            if (subtitleEl && copy.trackerSubtitle) {
                subtitleEl.textContent = copy.trackerSubtitle;
                subtitleEl.style.display = 'block';
            }

            // Check if tracker is set up
            if (!data.lastInstallDate) {
                // Show setup prompt
                document.getElementById('trackerSetupPrompt').style.display = 'block';
                document.getElementById('trackerMainContent').style.display = 'none';

                // Update copy for no-install message
                const noInstallMsg = document.getElementById('trackerNoInstallMessage');
                if (noInstallMsg && copy.noInstallMessage) {
                    noInstallMsg.textContent = copy.noInstallMessage;
                }
                const setupBtn = document.getElementById('trackerSetupBtn');
                if (setupBtn && copy.setupButtonText) {
                    setupBtn.textContent = copy.setupButtonText;
                }
                return;
            }

            // Show main content
            document.getElementById('trackerSetupPrompt').style.display = 'none';
            document.getElementById('trackerMainContent').style.display = 'block';

            // Helper to set text content
            const setText = (id, value) => {
                const el = document.getElementById(id);
                if (el && value !== undefined && value !== null) {
                    el.textContent = value;
                }
            };

            // Show/hide maintenance banners based on status
            const overdueBanner = document.getElementById('trackerOverdueBanner');
            const warningBanner = document.getElementById('trackerWarningBanner');

            if (overdueBanner && warningBanner) {
                // Hide both by default
                overdueBanner.style.display = 'none';
                warningBanner.style.display = 'none';

                if (data.daysUntilMaintenance !== null && data.daysUntilMaintenance !== undefined) {
                    if (data.daysUntilMaintenance <= 0) {
                        // Maintenance is overdue
                        const overdueDays = Math.abs(data.daysUntilMaintenance);
                        overdueBanner.style.display = 'block';
                        setText('trackerOverdueText', `Your maintenance is ${overdueDays} day${overdueDays !== 1 ? 's' : ''} overdue. Book now to protect your extensions!`);
                    } else if (data.daysUntilMaintenance <= 7) {
                        // Maintenance due within a week
                        warningBanner.style.display = 'block';
                        setText('trackerWarningText', `Maintenance due in ${data.daysUntilMaintenance} day${data.daysUntilMaintenance !== 1 ? 's' : ''}. Book your appointment soon!`);
                    } else if (data.daysUntilMaintenance <= 14) {
                        // Maintenance due within 2 weeks - subtle reminder
                        warningBanner.style.display = 'block';
                        setText('trackerWarningText', `Maintenance due in ${data.daysUntilMaintenance} days. Consider booking ahead!`);
                    }
                }
            }

            // Core stats
            setText('trackerDays', data.daysSinceInstall ?? '');
            setText('trackerWashes', data.washes ?? 0);
            setText('trackerDaysUntilMaintenance', data.daysUntilMaintenance ?? '');

            // Health score with color-coded indicator
            const healthScore = data.hairHealthScore ?? 0;
            setText('trackerHealthScore', healthScore + '%');

            // Update health indicator color and card styling
            const healthIndicator = document.getElementById('trackerHealthIndicator');
            const healthCard = document.getElementById('trackerHealthStatCard');
            const healthScoreEl = document.getElementById('trackerHealthScore');

            if (healthIndicator && healthScoreEl) {
                let indicatorColor, scoreColor;
                if (healthScore >= 80) {
                    indicatorColor = 'var(--success)'; // Green
                    scoreColor = '#4caf50';
                } else if (healthScore >= 60) {
                    indicatorColor = '#ffa726'; // Orange
                    scoreColor = '#ff9800';
                } else {
                    indicatorColor = 'var(--danger)'; // Red
                    scoreColor = '#f44336';
                }
                healthIndicator.style.background = indicatorColor;
                healthScoreEl.style.color = scoreColor;
            }

            // Show day streak (days since install or maintenance)
            setText('trackerWashStreak', data.daysSinceInstall ?? '');

            // Show extension type
            if (data.extensionType && config.extensionTypes) {
                const extType = config.extensionTypes.find(et => et.id === data.extensionType);
                setText('trackerExtensionType', extType?.label || data.extensionType);
            }

            // Update progress circle visual
            updateTrackerProgressCircle(data);

            // Care schedule labels
            setText('trackerNextWashTitle', copy.nextWashLabel || 'Next Wash Day');
            setText('trackerMaintenanceTitle', copy.maintenanceLabel || 'Maintenance Due');
            setText('trackerDeepConditionTitle', copy.deepConditionLabel || 'Deep Condition');

            // Next wash label
            if (data.nextWashDate && data.daysUntilWash !== null) {
                const dateText = formatDateShort(data.nextWashDate);
                if (data.daysUntilWash === 0) {
                    setText('trackerNextWashLabel', `Today - ${dateText}`);
                } else if (data.daysUntilWash === 1) {
                    setText('trackerNextWashLabel', `Tomorrow - ${dateText}`);
                } else {
                    setText('trackerNextWashLabel', `${dateText} (${data.daysUntilWash} days)`);
                }
            } else {
                setText('trackerNextWashLabel', 'Log your first wash to track');
            }

            // Maintenance label
            if (data.nextMaintenanceDate && data.daysUntilMaintenance !== null) {
                const dateText = formatDateShort(data.nextMaintenanceDate);
                setText('trackerMaintenanceLabel', `${dateText} (${data.daysUntilMaintenance} days)`);
            }

            // Deep condition label
            setText('trackerDeepConditionLabel', `Every ${data.deepConditionFrequencyDays || config.deepConditionFrequencyDays || 14} days`);

            // Render tips
            renderTrackerTips();
        }

        // Update the circular progress indicator
        function updateTrackerProgressCircle(data) {
            const { daysSinceInstall, maintenanceIntervalDays } = data;
            if (!daysSinceInstall || !maintenanceIntervalDays) return;

            const percent = Math.min(100, Math.round((daysSinceInstall / maintenanceIntervalDays) * 100));
            const circle = document.getElementById('trackerProgressCircle');

            if (circle) {
                // Calculate color based on progress
                let color = 'var(--brand-pink)'; // Normal
                if (percent >= 90) {
                    color = 'var(--danger)'; // Urgent - red
                } else if (percent >= 75) {
                    color = 'var(--warning)'; // Warning - orange
                }

                // Apply gradient based on progress
                circle.style.background = `conic-gradient(${color} ${percent * 3.6}deg, var(--gray-light) 0deg)`;
            }
        }

        // Render personalized tips based on tracker data
        function renderTrackerTips() {
            const tips = [];
            const data = hairTrackerData || {};
            const config = hairTrackerConfig || {};

            // Generate dynamic tips based on data
            if (data.hairHealthScore >= 90) {
                tips.push('Your extensions are at optimal health! Keep up the great care routine.');
            } else if (data.hairHealthScore < 70) {
                tips.push('Your hair health score is low. Consider deep conditioning more frequently.');
            }

            if (data.daysUntilMaintenance !== null) {
                if (data.daysUntilMaintenance <= 14 && data.daysUntilMaintenance > 0) {
                    tips.push(`Consider booking maintenance in the next ${data.daysUntilMaintenance} days for best results.`);
                } else if (data.daysUntilMaintenance <= 0) {
                    tips.push('Your maintenance is overdue! Book an appointment soon to protect your extensions.');
                }
            }

            if (data.daysUntilDeepCondition !== null && data.daysUntilDeepCondition <= 3) {
                tips.push("You're due for a deep conditioning treatment soon.");
            }

            // Add tips from config
            if (config.tips && config.tips.length > 0) {
                // Add a couple random tips from config
                const configTips = [...config.tips].sort(() => Math.random() - 0.5).slice(0, 2);
                tips.push(...configTips);
            }

            // Render tips
            const tipsList = document.getElementById('trackerTipsList');
            if (tipsList && tips.length > 0) {
                tipsList.innerHTML = tips.slice(0, 4).map(tip => `<li>${tip}</li>`).join('');
            }
        }

        // Format date for display
        function formatDateShort(iso) {
            if (!iso) return '';
            return formatDateDisplay(iso);
        }

        // Show tracker setup modal
        function showTrackerSetupModal() {
            if (!currentUser) {
                showAuthModal();
                return;
            }

            // Populate extension type dropdown
            const select = document.getElementById('trackerExtensionTypeSelect');
            const config = hairTrackerConfig || {};

            if (config.extensionTypes && select) {
                select.innerHTML = '<option value="">Select extension type...</option>';
                config.extensionTypes.forEach(et => {
                    const option = document.createElement('option');
                    option.value = et.id;
                    option.textContent = et.label + (et.maintenanceDays > 0 ? ` (${et.maintenanceDays} day cycle)` : '');
                    select.appendChild(option);
                });
            }

            // Pre-fill with existing data
            const data = hairTrackerData || {};
            if (data.extensionType) {
                select.value = data.extensionType;
            }
            if (data.lastInstallDate) {
                document.getElementById('trackerInstallDate').value = data.lastInstallDate.split('T')[0];
            }
            if (data.lastWashDate) {
                document.getElementById('trackerLastWashDate').value = data.lastWashDate.split('T')[0];
            }
            if (data.lastDeepConditionDate) {
                document.getElementById('trackerLastDeepConditionDate').value = data.lastDeepConditionDate.split('T')[0];
            }

            document.getElementById('trackerSetupModal').classList.add('show');
        }

        // Save tracker setup
        async function saveTrackerSetup() {
            const extensionType = document.getElementById('trackerExtensionTypeSelect').value;
            const installDate = document.getElementById('trackerInstallDate').value;
            const lastWashDate = document.getElementById('trackerLastWashDate').value;
            const lastDeepConditionDate = document.getElementById('trackerLastDeepConditionDate').value;

            if (!extensionType || !installDate) {
                showToast({ type: 'error', title: 'Error', message: 'Please select extension type and installation date' });
                return;
            }

            try {
                const updateData = {
                    extensionType,
                    lastInstallDate: new Date(installDate).toISOString()
                };

                if (lastDeepConditionDate) {
                    updateData.lastDeepConditionDate = new Date(lastDeepConditionDate).toISOString();
                }

                const res = await apiCall('/hair-tracker', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });

                // If last wash date provided, log it
                if (lastWashDate) {
                    await apiCall('/hair-tracker/log-wash', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ date: new Date(lastWashDate).toISOString() })
                    });
                }

                closeModal('trackerSetupModal');
                showToast({ type: 'success', title: 'Success', message: 'Hair tracker set up successfully!' });

                // Reload tracker data
                hairTrackerData = null; // Clear cache
                await loadHairTracker();

            } catch (error) {
                console.error('Error saving tracker setup:', error);
                showToast({ type: 'error', title: 'Error', message: 'Failed to save tracker settings' });
            }
        }

        // Current log activity type ('wash' or 'deep-condition')
        let currentLogActivityType = null;

        // Log a wash - show date picker modal
        function logWash() {
            if (!currentUser) {
                showAuthModal();
                return;
            }

            currentLogActivityType = 'wash';
            document.getElementById('logActivityTitle').textContent = 'Log Wash';
            document.getElementById('logActivityDescription').textContent = 'When did you wash your hair?';
            document.getElementById('logActivityConfirmBtn').textContent = 'Log Wash';

            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('logActivityDate').value = today;
            document.getElementById('logActivityDate').max = today; // Can't log future dates

            document.getElementById('logActivityModal').classList.add('show');
        }

        // Log deep condition - show date picker modal
        function logDeepCondition() {
            if (!currentUser) {
                showAuthModal();
                return;
            }

            currentLogActivityType = 'deep-condition';
            document.getElementById('logActivityTitle').textContent = 'Log Deep Condition';
            document.getElementById('logActivityDescription').textContent = 'When did you deep condition your hair?';
            document.getElementById('logActivityConfirmBtn').textContent = 'Log Treatment';

            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('logActivityDate').value = today;
            document.getElementById('logActivityDate').max = today; // Can't log future dates

            document.getElementById('logActivityModal').classList.add('show');
        }

        // Confirm and submit the logged activity
        async function confirmLogActivity() {
            const dateValue = document.getElementById('logActivityDate').value;
            if (!dateValue) {
                showToast({ type: 'error', title: 'Error', message: 'Please select a date' });
                return;
            }

            const date = new Date(dateValue).toISOString();
            const endpoint = currentLogActivityType === 'wash' ? '/hair-tracker/log-wash' : '/hair-tracker/log-deep-condition';
            const successMessage = currentLogActivityType === 'wash' ? 'Wash logged successfully' : 'Deep condition logged successfully';

            try {
                const res = await apiCall(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ date })
                });

                if (res.success) {
                    closeModal('logActivityModal');
                    showToast({ type: 'success', title: 'Logged!', message: successMessage });
                    // Refresh tracker data
                    hairTrackerData = null;
                    await loadHairTracker();
                }
            } catch (error) {
                console.error(`Error logging ${currentLogActivityType}:`, error);
                showToast({ type: 'error', title: 'Error', message: `Failed to log ${currentLogActivityType === 'wash' ? 'wash' : 'deep condition'}` });
            }
        }

        // Book maintenance appointment
        function bookMaintenance() {
            // Switch to booking tab
            switchTab('booking');

            // Optionally pre-select hair extensions service
            if (hairTrackerData?.extensionType) {
                // Select hair tab in booking
                const hairTab = document.querySelector('[onclick*="selectBookingType(\'hair\')"]');
                if (hairTab) hairTab.click();
            }
        }

        // Add progress photo (placeholder)
        function addProgressPhoto() {
            if (!currentUser) {
                showAuthModal();
                return;
            }
            showToast({ type: 'info', title: 'Coming Soon', message: 'Progress photos feature coming soon!' });
        }

        // Profile Actions
        function editProfile() {
            if (!currentUser) {
                showAuthModal();
                return;
            }
            // Prefill form with current user data
            document.getElementById('editProfileName').value = currentUser.name || '';
            document.getElementById('editProfilePhone').value = currentUser.phone || '';
            document.getElementById('editProfileEmail').value = currentUser.email || '';
            document.getElementById('editProfileError').style.display = 'none';
            document.getElementById('editProfileModal').classList.add('show');
        }

        function closeEditProfileModal() {
            document.getElementById('editProfileModal').classList.remove('show');
        }

        async function saveProfile() {
            const name = document.getElementById('editProfileName').value.trim();
            const phone = document.getElementById('editProfilePhone').value.trim();
            const errorEl = document.getElementById('editProfileError');

            if (!name) {
                errorEl.textContent = 'Name is required';
                errorEl.style.display = 'block';
                return;
            }

            try {
                const response = await apiCall('/auth/me', {
                    method: 'PATCH',
                    body: JSON.stringify({ name, phone })
                });
                currentUser = response.user;
                updateUserUI();
                closeEditProfileModal();
                showToast({ type: 'success', title: 'Profile Updated', message: 'Your profile has been saved.' });
            } catch (error) {
                errorEl.textContent = error.message || 'Failed to update profile';
                errorEl.style.display = 'block';
            }
        }

        async function viewAppointments() {
            if (!currentUser) {
                showAuthModal();
                return;
            }
            const modal = document.getElementById('appointmentsModal');
            const body = document.getElementById('appointmentsModalBody');
            body.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-subtle);">Loading...</div>';
            modal.classList.add('show');

            try {
                const data = await apiCall('/bookings');
                if (!data.bookings || data.bookings.length === 0) {
                    body.innerHTML = `
                        <div style="text-align: center; padding: 30px;">
                            <div style="font-size: 48px; margin-bottom: 15px;"></div>
                            <div style="font-weight: 600; margin-bottom: 8px;">No appointments yet</div>
                            <p style="color: var(--text-subtle); margin-bottom: 15px;">Book your first appointment today!</p>
                            <button class="btn btn-primary" onclick="closeAppointmentsModal(); switchTab('booking');" style="background: var(--brand-pink);">Book Now</button>
                        </div>
                    `;
                } else {
                    body.innerHTML = data.bookings.map(b => {
                        const date = new Date(b.date);
                        const statusColors = {
                            confirmed: 'var(--success)',
                            pending: 'var(--warning)',
                            completed: 'var(--brand-pink)',
                            cancelled: 'var(--danger)'
                        };
                        return `
                            <div style="background: var(--surface-muted); border-radius: 12px; padding: 15px; margin-bottom: 12px;">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div>
                                        <div style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">${b.serviceName}</div>
                                        <div style="color: var(--text-muted); font-size: 14px;">${formatDateWithTime(date, b.time || 'TBC')}</div>
                                        <div style="color: var(--text-subtle); font-size: 13px; margin-top: 4px;">with ${b.stylistName || 'Any stylist'}</div>
                                    </div>
                                    <span style="background: ${statusColors[b.status] || 'var(--brand-charcoal)'}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 500;">${b.status}</span>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                body.innerHTML = `<div style="text-align: center; color: var(--danger); padding: 20px;">Error loading appointments: ${error.message}</div>`;
            }
        }

        function closeAppointmentsModal() {
            document.getElementById('appointmentsModal').classList.remove('show');
        }

        async function viewOrders() {
            if (!currentUser) {
                showAuthModal();
                return;
            }
            const modal = document.getElementById('ordersModal');
            const body = document.getElementById('ordersModalBody');
            body.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-subtle);">Loading...</div>';
            modal.classList.add('show');

            try {
                const data = await apiCall('/orders');
                if (!data.orders || data.orders.length === 0) {
                    body.innerHTML = `
                        <div style="text-align: center; padding: 30px;">
                            <div style="font-size: 48px; margin-bottom: 15px;"></div>
                            <div style="font-weight: 600; margin-bottom: 8px;">No orders yet</div>
                            <p style="color: var(--text-subtle); margin-bottom: 15px;">Shop our extension care products!</p>
                            <button class="btn btn-primary" onclick="closeOrdersModal(); switchTab('shop');" style="background: var(--brand-pink);">Shop Now</button>
                        </div>
                    `;
                } else {
                    body.innerHTML = data.orders.map(o => {
                        const date = new Date(o.createdAt);
                        const statusColors = {
                            pending: 'var(--warning)',
                            processing: 'var(--brand-pink)',
                            shipped: 'var(--brand-pink)',
                            delivered: 'var(--success)',
                            cancelled: 'var(--danger)'
                        };
                        return `
                            <div style="background: var(--surface-muted); border-radius: 12px; padding: 15px; margin-bottom: 12px;">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div>
                                        <div style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">Order #${o.id.substring(0, 8)}</div>
                                        <div style="color: var(--text-muted); font-size: 14px;">${o.items?.length || 0} item(s) - R${o.total?.toLocaleString() || 0}</div>
                                        <div style="color: var(--text-subtle); font-size: 13px; margin-top: 4px;">${formatDateDisplay(date)}</div>
                                    </div>
                                    <span style="background: ${statusColors[o.status] || 'var(--brand-charcoal)'}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 500;">${o.status}</span>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                body.innerHTML = `<div style="text-align: center; color: var(--danger); padding: 20px;">Error loading orders: ${error.message}</div>`;
            }
        }

        function closeOrdersModal() {
            document.getElementById('ordersModal').classList.remove('show');
        }

        // Payment Methods Modal
        function viewPayments() {
            if (!currentUser) { showAuthModal(); return; }
            document.getElementById('paymentMethodsModal').classList.add('show');
        }
        function closePaymentMethodsModal() {
            document.getElementById('paymentMethodsModal').classList.remove('show');
        }

        // Hair Profile Modal
        async function hairProfile() {
            if (!currentUser) { showAuthModal(); return; }

            const modal = document.getElementById('hairProfileModal');
            const errorEl = document.getElementById('hairProfileError');
            const loadingEl = document.getElementById('hairProfileLoading');
            const saveBtn = document.getElementById('hairProfileSaveBtn');
            const formFields = [
                document.getElementById('hairProfileType'),
                document.getElementById('hairProfileExtension'),
                document.getElementById('hairProfileStylist'),
                document.getElementById('hairProfileNotes')
            ];

            const setLoadingState = (isLoading) => {
                formFields.forEach(field => { if (field) field.disabled = isLoading; });
                if (saveBtn) saveBtn.disabled = isLoading;
                if (loadingEl) loadingEl.style.display = isLoading ? 'flex' : 'none';
            };

            errorEl.style.display = 'none';
            errorEl.textContent = '';
            setLoadingState(true);
            modal.classList.add('show');

            // Load stylists into dropdown
            try {
                const stylistsData = await apiCall('/stylists');
                const select = document.getElementById('hairProfileStylist');
                select.innerHTML = '<option value="">No preference</option>';
                if (stylistsData.stylists) {
                    stylistsData.stylists.forEach(s => {
                        select.innerHTML += `<option value="${s.id}">${s.name}</option>`;
                    });
                }
            } catch (e) {
                const select = document.getElementById('hairProfileStylist');
                if (select) {
                    select.innerHTML = '<option value="">No preference</option>';
                }
                errorEl.textContent = e.message || 'Unable to load stylists right now. Please try again.';
                errorEl.style.display = 'block';
                formFields.forEach(field => { if (field) field.disabled = true; });
                if (saveBtn) saveBtn.disabled = true;
                if (loadingEl) loadingEl.style.display = 'none';
                return;
            }

            // Load current hair profile
            try {
                const data = await apiCall('/hair-profile');
                const hp = data.hairProfile || {};
                document.getElementById('hairProfileType').value = hp.hairType || '';
                document.getElementById('hairProfileExtension').value = hp.extensionType || '';
                document.getElementById('hairProfileStylist').value = hp.preferredStylist || '';
                document.getElementById('hairProfileNotes').value = hp.notes || '';
            } catch (e) {
                errorEl.textContent = e.message || 'Unable to load your hair profile right now. Please try again.';
                errorEl.style.display = 'block';
                formFields.forEach(field => { if (field) field.disabled = true; });
                if (saveBtn) saveBtn.disabled = true;
                if (loadingEl) loadingEl.style.display = 'none';
                return;
            }

            setLoadingState(false);
        }
        function closeHairProfileModal() {
            document.getElementById('hairProfileModal').classList.remove('show');
        }
        async function saveHairProfile() {
            const errorEl = document.getElementById('hairProfileError');
            const hairType = document.getElementById('hairProfileType').value;
            const extensionType = document.getElementById('hairProfileExtension').value;
            const preferredStylist = document.getElementById('hairProfileStylist').value;
            const notes = document.getElementById('hairProfileNotes').value.trim();

            errorEl.style.display = 'none';

            try {
                await apiCall('/hair-profile', {
                    method: 'PATCH',
                    body: JSON.stringify({ hairType, extensionType, preferredStylist, notes })
                });

                if (!currentUser) {
                    currentUser = {};
                }

                if (!currentUser.hairProfile) {
                    currentUser.hairProfile = {};
                }

                Object.assign(currentUser.hairProfile, {
                    hairType,
                    extensionType,
                    preferredStylist,
                    notes
                });
                closeHairProfileModal();
                showToast({ type: 'success', title: 'Saved', message: 'Your hair profile has been updated.' });
            } catch (error) {
                errorEl.textContent = error.message || 'Failed to save hair profile';
                errorEl.style.display = 'block';
            }
        }

        // Notification Preferences Modal
        async function notificationSettings() {
            if (!currentUser) { showAuthModal(); return; }

            const modal = document.getElementById('notificationPrefsModal');
            document.getElementById('notifPrefsError').style.display = 'none';

            // Load current preferences
            try {
                const data = await apiCall('/notification-prefs');
                const prefs = data.notificationPrefs || {};
                document.getElementById('prefPromotions').checked = prefs.promotions !== false;
                document.getElementById('prefAppointments').checked = prefs.appointmentReminders !== false;
                document.getElementById('prefLoyalty').checked = prefs.loyaltyUpdates !== false;
            } catch (e) {
                // Default to checked
                document.getElementById('prefPromotions').checked = true;
                document.getElementById('prefAppointments').checked = true;
                document.getElementById('prefLoyalty').checked = true;
            }

            modal.classList.add('show');
        }
        function closeNotificationPrefsModal() {
            document.getElementById('notificationPrefsModal').classList.remove('show');
        }
        async function saveNotificationPrefs() {
            const errorEl = document.getElementById('notifPrefsError');
            const promotions = document.getElementById('prefPromotions').checked;
            const appointmentReminders = document.getElementById('prefAppointments').checked;
            const loyaltyUpdates = document.getElementById('prefLoyalty').checked;

            try {
                await apiCall('/notification-prefs', {
                    method: 'PATCH',
                    body: JSON.stringify({ promotions, appointmentReminders, loyaltyUpdates })
                });
                closeNotificationPrefsModal();
                showToast({ type: 'success', title: 'Saved', message: 'Notification preferences updated.' });
            } catch (error) {
                errorEl.textContent = error.message || 'Failed to save preferences';
                errorEl.style.display = 'block';
            }
        }

        // Help Center Modal
        function helpCenter() {
            document.getElementById('helpCenterModal').classList.add('show');
        }
        function closeHelpCenterModal() {
            document.getElementById('helpCenterModal').classList.remove('show');
        }

        // Settings Modal
        function settings() {
            if (!currentUser) { showAuthModal(); return; }
            document.getElementById('settingsEmail').textContent = currentUser.email || '-';
            document.getElementById('settingsModal').classList.add('show');
        }
        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.remove('show');
        }

        // Other Functions
        function showProductDetails(product) { alert('Product details: ' + product); }

        // ========== UPCOMING APPOINTMENTS FUNCTIONALITY ==========
        let bookingToReschedule = null;
        let userBookingsData = [];

        async function loadUpcomingAppointment() {
            const container = document.getElementById('upcomingAppointmentsContainer');
            if (!container) return;

            const token = getToken();

            // If not logged in, show login prompt
            if (!token) {
                container.innerHTML = `
                    <div class="appointment-card" style="text-align: center; padding: 30px;">
                        <div style="font-size: 40px; margin-bottom: 15px;"></div>
                        <div style="font-weight: 600; margin-bottom: 8px;">Sign in to view appointments</div>
                        <p style="color: var(--gray-medium); margin-bottom: 15px;">Log in to see and manage your upcoming appointments.</p>
                        <button class="btn btn-primary" onclick="showAuthModal('login')" style="background: var(--brand-pink);">Sign In</button>
                    </div>
                `;
                return;
            }

            try {
                const data = await apiCall('/bookings');
                const bookings = data.bookings || [];
                userBookingsData = bookings;

                // Filter for future confirmed/requested/pending bookings (exclude cancelled and completed)
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const futureBookings = bookings.filter(b => {
                    const bookingDate = new Date(b.requestedDate || b.date);
                    const statusUpper = (b.status || '').toUpperCase();
                    const activeStatuses = ['REQUESTED', 'CONFIRMED', 'PENDING'];
                    return bookingDate >= today && activeStatuses.includes(statusUpper);
                });

                // Sort by date (soonest first)
                futureBookings.sort((a, b) => new Date(a.requestedDate || a.date) - new Date(b.requestedDate || b.date));

                if (futureBookings.length === 0) {
                    container.innerHTML = `
                        <div class="appointment-card" style="text-align: center; padding: 30px;">
                            <div style="font-size: 40px; margin-bottom: 15px;"></div>
                            <div style="font-weight: 600; margin-bottom: 8px;">No upcoming appointments</div>
                            <p style="color: var(--gray-medium); margin-bottom: 15px;">Book your next hair or beauty appointment!</p>
                            <button class="btn btn-primary" onclick="navigateToSection('book')" style="background: var(--brand-pink);">Book Now</button>
                        </div>
                    `;
                    return;
                }

                // Show all upcoming appointments (up to 3)
                const appointmentsToShow = futureBookings.slice(0, 3);
                container.innerHTML = appointmentsToShow.map(booking => {
                    const bookingDate = new Date(booking.requestedDate || booking.date);
                    const formattedDate = formatDateDisplay(bookingDate, {
                        weekday: 'long'
                    });

                    // Format time display with new two-step booking logic
                    let timeDisplay = 'TBC';
                    const statusUpper = (booking.status || '').toUpperCase();
                    if (statusUpper === 'CONFIRMED') {
                        // Confirmed bookings have exact time
                        timeDisplay = booking.assignedStartTime || booking.confirmedTime || booking.time || 'TBC';
                    } else if (statusUpper === 'REQUESTED') {
                        // Requested bookings show time window
                        const timeWindow = window.BookingConstants?.getTimeWindow(booking.requestedTimeWindow || booking.preferredTimeOfDay);
                        if (timeWindow) {
                            timeDisplay = `${timeWindow.icon} ${timeWindow.label}`;
                        } else if (booking.preferredTimeOfDay) {
                            // Legacy fallback
                            if (booking.preferredTimeOfDay === 'morning') timeDisplay = 'Morning (9AM-12PM)';
                            else if (booking.preferredTimeOfDay === 'afternoon') timeDisplay = 'Afternoon (12PM-4PM)';
                            else if (booking.preferredTimeOfDay === 'evening') timeDisplay = 'Evening (4PM-7PM)';
                        }
                    }

                    // Get stylist name if available
                    const stylistName = booking.stylistName || 'Our team';

                    // Status badge with new statuses
                    let statusBadge = '';
                    if (statusUpper === 'CONFIRMED') {
                        statusBadge = '<span style="background: var(--success); color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 8px;"> Confirmed</span>';
                    } else if (statusUpper === 'REQUESTED') {
                        statusBadge = '<span style="background: #FFC107; color: var(--brand-charcoal); padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 8px;"> Pending Time</span>';
                    } else {
                        statusBadge = '<span style="background: var(--warning); color: var(--brand-charcoal); padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 8px;">Pending</span>';
                    }

                    return `
                        <div class="appointment-card" data-booking-id="${booking.id}">
                            <div class="appointment-date">${formattedDate}${statusBadge}</div>
                            <div class="appointment-details">
                                <div class="appointment-info">
                                    <div class="appointment-service">${booking.serviceName}</div>
                                    <div class="appointment-time"> ${timeDisplay} with ${stylistName}</div>
                                </div>
                                <div class="appointment-actions">
                                    <button class="btn btn-small btn-outline" onclick="openRescheduleModal('${booking.id}')">Reschedule</button>
                                    <button class="btn btn-small" onclick="cancelBooking('${booking.id}')" style="background: none; color: var(--danger); border: 1px solid #e74c3c;">Cancel</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                // Add "view all" link if there are more bookings
                if (futureBookings.length > 3) {
                    container.innerHTML += `
                        <div style="text-align: center; margin-top: 10px;">
                            <a href="#" onclick="navigateToSection('my-bookings'); return false;" style="color: var(--brand-pink); text-decoration: none;">
                                View all ${futureBookings.length} appointments 
                            </a>
                        </div>
                    `;
                }

            } catch (error) {
                console.error('Failed to load appointments:', error);
                container.innerHTML = `
                    <div class="appointment-card" style="text-align: center; padding: 30px;">
                        <div style="font-size: 40px; margin-bottom: 15px;"></div>
                        <div style="font-weight: 600; margin-bottom: 8px;">Unable to load appointments</div>
                        <p style="color: var(--gray-medium); margin-bottom: 15px;">Please try again later.</p>
                        <button class="btn btn-outline" onclick="loadUpcomingAppointment()">Retry</button>
                    </div>
                `;
            }
        }

        function openRescheduleModal(bookingId) {
            const booking = userBookingsData.find(b => b.id === bookingId);
            if (!booking) {
                showToast({ type: 'error', title: 'Booking not found', message: 'Please refresh and try again.' });
                return;
            }

            bookingToReschedule = booking;

            // Show current booking info
            const bookingDate = new Date(booking.date);
            const formattedDate = formatDateDisplay(bookingDate, {
                weekday: 'short'
            });

            document.getElementById('rescheduleBookingInfo').innerHTML = `
                <div style="font-weight: 600;">${booking.serviceName}</div>
                <div style="font-size: 14px; color: var(--text-muted);">Currently: ${formattedDate}</div>
            `;

            // Set minimum date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const minDate = tomorrow.toISOString().split('T')[0];
            document.getElementById('rescheduleDate').min = minDate;
            document.getElementById('rescheduleDate').value = '';

            // Reset time window selection
            document.querySelectorAll('#rescheduleTimeWindowSelector .time-window-chip').forEach(chip => {
                chip.classList.remove('selected');
            });
            document.getElementById('rescheduleRequestedTimeWindow').value = '';

            // Initialize time window chip click handlers
            document.querySelectorAll('#rescheduleTimeWindowSelector .time-window-chip').forEach(chip => {
                chip.addEventListener('click', function() {
                    document.querySelectorAll('#rescheduleTimeWindowSelector .time-window-chip').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    document.getElementById('rescheduleRequestedTimeWindow').value = this.dataset.window;
                });
            });

            // Hide any previous errors
            document.getElementById('rescheduleError').style.display = 'none';

            // Show modal
            document.getElementById('rescheduleModal').classList.add('show');
        }

        function closeRescheduleModal() {
            document.getElementById('rescheduleModal').classList.remove('show');
            bookingToReschedule = null;
        }

        async function submitReschedule() {
            const newDate = document.getElementById('rescheduleDate').value;
            const requestedTimeWindow = document.getElementById('rescheduleRequestedTimeWindow').value;
            const errorDiv = document.getElementById('rescheduleError');

            // Validation
            if (!newDate) {
                errorDiv.textContent = 'Please select a new date.';
                errorDiv.style.display = 'block';
                return;
            }

            const selectedDate = new Date(newDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (selectedDate <= today) {
                errorDiv.textContent = 'Please select a future date.';
                errorDiv.style.display = 'block';
                return;
            }

            if (!requestedTimeWindow) {
                errorDiv.textContent = 'Please select a time window.';
                errorDiv.style.display = 'block';
                return;
            }

            if (!bookingToReschedule) {
                errorDiv.textContent = 'No booking selected.';
                errorDiv.style.display = 'block';
                return;
            }

            errorDiv.style.display = 'none';

            try {
                const result = await apiCall(`/bookings/${bookingToReschedule.id}`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        requestedDate: newDate,
                        requestedTimeWindow: requestedTimeWindow,
                        status: 'REQUESTED', // Reset to REQUESTED since admin needs to assign new time
                        assignedStartTime: null, // Clear assigned time
                        assignedEndTime: null
                    })
                });

                if (!result.success) throw new Error(result.message || 'Failed to reschedule');

                showToast({ type: 'success', title: 'Rescheduled', message: 'We will assign an exact time within 24 hours and notify you!' });
                closeRescheduleModal();
                await loadUpcomingAppointment(); // Refresh the appointments list
            } catch (error) {
                console.error('Reschedule error:', error);
                errorDiv.textContent = error.message || 'Failed to reschedule. Please try again.';
                errorDiv.style.display = 'block';
            }
        }

        async function cancelBooking(bookingId) {
            if (!confirm('Are you sure you want to cancel this appointment?')) {
                return;
            }

            try {
                const result = await apiCall(`/bookings/${bookingId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ status: 'CANCELLED' })
                });

                if (result.success) {
                    showToast('Appointment cancelled', 'success');
                    await loadUpcomingAppointment(); // Refresh the list
                } else {
                    throw new Error(result.message || 'Failed to cancel');
                }
            } catch (error) {
                console.error('Cancel error:', error);
                showToast('Failed to cancel appointment', 'error');
            }
        }

        // ========== SPECIAL OFFERS FUNCTIONALITY ==========
        let specialOffersData = [];

        async function loadSpecialOffers() {
            const container = document.getElementById('specialOffersList');
            if (!container) return;

            try {
                const data = await apiCall('/promos/highlighted');
                const promos = data.promos || [];
                specialOffersData = promos;

                if (!promos.length) {
                    // Hide the entire section if no offers
                    const section = document.getElementById('specialOffersSection');
                    if (section) section.style.display = 'none';
                    return;
                }

                container.innerHTML = promos.map(p => `
                    <div class="offer-card" data-code="${p.code}">
                        <span class="offer-badge">${p.badge || 'SPECIAL'}</span>
                        <div class="offer-title">${p.title || p.code}</div>
                        <div class="offer-description">${p.subtitle || p.description || ''}</div>
                    </div>
                `).join('');

                // Attach click handlers
                container.querySelectorAll('.offer-card').forEach(card => {
                    card.addEventListener('click', () => {
                        const code = card.getAttribute('data-code');
                        handleOfferClick(code);
                    });
                });

                // Setup View All button
                setupViewAllOffers();

            } catch (error) {
                console.error('Failed to load special offers:', error);
                // Hide section on error instead of showing error message
                const section = document.getElementById('specialOffersSection');
                if (section) section.style.display = 'none';
            }
        }

        function handleOfferClick(code) {
            // Find the promo details
            const promo = specialOffersData.find(p => p.code === code);

            // If user has items in cart or is on shop page, apply to cart
            const promoInput = document.getElementById('promoCodeInput');
            if (promoInput) {
                promoInput.value = code;
                // Show cart and trigger promo apply
                showCart();
                setTimeout(() => {
                    applyPromoCode();
                }, 300);
            } else {
                // Show offer details in a modal/alert
                const discountText = promo
                    ? (promo.discountType === 'percentage' ? `${promo.discountValue}% off` : `R${promo.discountValue} off`)
                    : '';
                const minOrderText = promo && promo.minOrder > 0 ? `\nMinimum order: R${promo.minOrder}` : '';

                alert(`Special Offer: ${promo?.title || code}\n\nUse code: ${code}\nDiscount: ${discountText}${minOrderText}\n\nAdd items to your cart and apply this code at checkout!`);
            }
        }

        function setupViewAllOffers() {
            const viewAllBtn = document.getElementById('viewAllOffersBtn');
            if (viewAllBtn) {
                viewAllBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    showAllOffersModal();
                });
            }
        }

        function showAllOffersModal() {
            if (!specialOffersData.length) {
                alert('No special offers available right now. Check back soon!');
                return;
            }

            // Create modal content
            const modalContent = specialOffersData.map(p => {
                const discountText = p.discountType === 'percentage' ? `${p.discountValue}% off` : `R${p.discountValue} off`;
                const minOrderText = p.minOrder > 0 ? `Min. order R${p.minOrder}` : 'No minimum';
                const expiresText = p.expiresAt ? `Expires: ${formatDateDisplay(p.expiresAt)}` : 'No expiry';

                return `
                    <div class="offer-modal-item" onclick="handleOfferClick('${p.code}'); closeModal('offersModal');" style="padding: 15px; border-bottom: 1px solid var(--border-soft); cursor: pointer;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <span style="background: var(--brand-pink); color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; text-transform: uppercase;">${p.badge || 'SPECIAL'}</span>
                                <div style="font-weight: 600; margin: 8px 0 4px;">${p.title || p.code}</div>
                                <div style="font-size: 13px; color: var(--text-muted);">${p.subtitle || p.description || ''}</div>
                            </div>
                            <div style="text-align: right; font-size: 12px; color: var(--text-subtle);">
                                <div style="font-weight: 600; color: var(--brand-pink);">${discountText}</div>
                                <div>${minOrderText}</div>
                            </div>
                        </div>
                        <div style="font-size: 11px; color: var(--text-subtle); margin-top: 8px;">Code: <strong>${p.code}</strong>  ${expiresText}</div>
                    </div>
                `;
            }).join('');

            // Check if modal already exists
            let modal = document.getElementById('offersModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'offersModal';
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal" style="max-width: 500px; max-height: 80vh; overflow: hidden;">
                        <div class="modal-header" style="padding: 20px; border-bottom: 1px solid var(--border-soft); display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="margin: 0;">All Special Offers</h3>
                            <button onclick="closeModal('offersModal')" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                        </div>
                        <div id="offersModalContent" style="max-height: 60vh; overflow-y: auto;">
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            document.getElementById('offersModalContent').innerHTML = modalContent;
            modal.classList.add('active');
            modal.style.display = 'flex';
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
                modal.style.display = 'none';
            }
        }

        // Booking Confirmation Modal
        function showBookingConfirmation(booking) {
            const modal = document.getElementById('bookingConfirmationModal');
            const content = document.getElementById('bookingConfirmationContent');
            const pointsEl = document.getElementById('confirmationPoints');

            let html = `
                <div style="margin-bottom: 25px;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr style="border-bottom: 1px solid var(--gray-light);">
                            <td style="padding: 12px 0; font-weight: 600; color: var(--gray-dark);">Booking Type:</td>
                            <td style="padding: 12px 0; text-align: right; color: var(--text-dark);">${booking.type}</td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--gray-light);">
                            <td style="padding: 12px 0; font-weight: 600; color: var(--gray-dark);">Service:</td>
                            <td style="padding: 12px 0; text-align: right; color: var(--text-dark);">${booking.service}</td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--gray-light);">
                            <td style="padding: 12px 0; font-weight: 600; color: var(--gray-dark);">Duration:</td>
                            <td style="padding: 12px 0; text-align: right; color: var(--text-dark);">${booking.duration}</td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--gray-light);">
                            <td style="padding: 12px 0; font-weight: 600; color: var(--gray-dark);">Price:</td>
                            <td style="padding: 12px 0; text-align: right; color: var(--brand-pink); font-weight: 600; font-size: 16px;">${booking.price}</td>
                        </tr>
                        <tr style="border-bottom: 1px solid var(--gray-light);">
                            <td style="padding: 12px 0; font-weight: 600; color: var(--gray-dark);">Date:</td>
                            <td style="padding: 12px 0; text-align: right; color: var(--text-dark);">${booking.date}</td>
                        </tr>
            `;

            if (booking.time && booking.time !== 'To be assigned') {
                html += `
                        <tr style="border-bottom: 1px solid var(--gray-light);">
                            <td style="padding: 12px 0; font-weight: 600; color: var(--gray-dark);">Time:</td>
                            <td style="padding: 12px 0; text-align: right; color: var(--text-dark);">${booking.time}</td>
                        </tr>
                `;
            }

            if (booking.therapist) {
                html += `
                        <tr>
                            <td colspan="2" style="padding: 12px 0; color: var(--gray-medium); font-size: 14px; text-align: center;">
                                ${booking.therapist}
                            </td>
                        </tr>
                `;
            }

            html += `
                    </table>
                </div>
            `;

            content.innerHTML = html;
            pointsEl.textContent = `+${booking.points}`;
            modal.style.display = 'flex';

            // Add fade-in animation
            setTimeout(() => {
                modal.classList.add('active');
            }, 10);
        }

        function closeBookingConfirmation() {
            const modal = document.getElementById('bookingConfirmationModal');
            modal.classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }

        function showRedeemOptions() { alert('Redeem points options'); }
        function addProgressPhoto() { openPhotoUpload(); }

        // ========== GALLERY FUNCTIONALITY ==========
        async function loadGallery() {
            const container = document.getElementById('galleryGrid');
            if (!container) return;

            try {
                const response = await fetch(`${API_BASE}/gallery`);
                if (!response.ok) throw new Error('Failed to load gallery');

                const data = await response.json();
                const items = data.items || [];

                if (!items.length) {
                    container.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 40px 20px; background: linear-gradient(135deg, #fef5f8 0%, #fff 100%); border-radius: 15px; border: 2px dashed var(--brand-pink);">
                            <div style="font-size: 60px; margin-bottom: 15px;"></div>
                            <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 10px; color: var(--brand-charcoal);">Our Gallery is Coming Soon!</h3>
                            <p style="color: var(--gray-medium); margin-bottom: 20px; max-width: 400px; margin-left: auto; margin-right: auto;">
                                We're building an amazing collection of transformation photos. In the meantime, check out our services!
                            </p>
                            <button class="btn btn-primary" onclick="navigateToSection('book')" style="background: var(--brand-pink); border: none; padding: 12px 30px; border-radius: 25px; cursor: pointer; font-weight: 600;">
                                Explore Our Services
                            </button>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = items.map(item => `
                    <div class="gallery-item" onclick="openGalleryLightbox('${item.id}')">
                        <img src="${item.imageUrl}" alt="${item.altText || 'Gallery Image'}" onerror="this.src='https://via.placeholder.com/300x300?text=Image'">
                        ${item.label ? `<div class="gallery-label">${item.label}</div>` : ''}
                    </div>
                `).join('');

                // Store items for lightbox
                window.galleryItems = items;

                // Show Instagram CTA banner (fast, no embed)
                const instagram = data.instagram;
                const instaContainer = document.getElementById('instagramFeedContainer');
                const instaBanner = document.getElementById('instagramBanner');
                const instaHandle = document.getElementById('instagramHandle');

                if (instaContainer && instagram?.username) {
                    instaContainer.style.display = 'block';
                    if (instaBanner) {
                        instaBanner.href = `https://www.instagram.com/${instagram.username}/`;
                    }
                    if (instaHandle) {
                        instaHandle.textContent = `@${instagram.username}`;
                    }
                }

            } catch (error) {
                console.error('Failed to load gallery:', error);
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px 20px; background: linear-gradient(135deg, #fef5f8 0%, #fff 100%); border-radius: 15px; border: 2px dashed var(--brand-pink);">
                        <div style="font-size: 60px; margin-bottom: 15px;"></div>
                        <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 10px; color: var(--brand-charcoal);">Our Gallery is Coming Soon!</h3>
                        <p style="color: var(--gray-medium); margin-bottom: 20px; max-width: 400px; margin-left: auto; margin-right: auto;">
                            We're building an amazing collection of transformation photos. In the meantime, check out our services!
                        </p>
                        <button class="btn btn-primary" onclick="navigateToSection('book')" style="background: var(--brand-pink); border: none; padding: 12px 30px; border-radius: 25px; cursor: pointer; font-weight: 600;">
                            Explore Our Services
                        </button>
                    </div>
                `;
            }
        }

        function openInstagramConfigPrompt() {
            const username = prompt('Follow us on Instagram! Enter handle to open profile:', 'flirthair');
            if (username) {
                const clean = username.replace('@','').trim();
                window.open(`https://www.instagram.com/${clean}/`, '_blank');
            }
        }

        function openGalleryLightbox(itemId) {
            const items = window.galleryItems || [];
            const item = items.find(i => i.id === itemId);
            if (!item) return;

            // Create lightbox if not exists
            let lightbox = document.getElementById('galleryLightbox');
            if (!lightbox) {
                lightbox = document.createElement('div');
                lightbox.id = 'galleryLightbox';
                lightbox.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 9999; display: none; align-items: center; justify-content: center; padding: 20px;';
                lightbox.innerHTML = `
                    <button onclick="closeGalleryLightbox()" style="position: absolute; top: 20px; right: 20px; background: none; border: none; color: white; font-size: 32px; cursor: pointer; z-index: 10001;">&times;</button>
                    <div style="max-width: 90%; max-height: 90%; text-align: center;">
                        <img id="lightboxImage" src="" alt="" style="max-width: 100%; max-height: 80vh; object-fit: contain; border-radius: 8px;">
                        <div id="lightboxCaption" style="color: white; margin-top: 15px; font-size: 16px;"></div>
                    </div>
                `;
                document.body.appendChild(lightbox);

                // Close on background click
                lightbox.addEventListener('click', (e) => {
                    if (e.target === lightbox) closeGalleryLightbox();
                });
            }

            document.getElementById('lightboxImage').src = item.imageUrl;
            document.getElementById('lightboxCaption').textContent = item.label || '';
            lightbox.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeGalleryLightbox() {
            const lightbox = document.getElementById('galleryLightbox');
            if (lightbox) {
                lightbox.style.display = 'none';
                document.body.style.overflow = '';
            }
        }

        // ========== HAIR TIPS FUNCTIONALITY ==========
        const defaultHairTips = [
            'Use a silk pillowcase to prevent tangling and maintain your extensions while you sleep. ',
            'Avoid washing your hair in very hot water - lukewarm water helps preserve your extension bonds. ',
            'Brush your extensions from bottom to top using a loop brush to prevent shedding. ',
            'Apply hair oil or serum to the mid-lengths and ends daily to keep extensions smooth and shiny. ',
            'Book regular maintenance appointments every 6-8 weeks to keep your extensions looking fresh. '
        ];

        async function loadHairTip() {
            const tipElement = document.getElementById('hairTipText');
            const tipCard = document.getElementById('hairTipCard');
            if (!tipElement || !tipCard) return;

            try {
                const response = await fetch(`${API_BASE}/hair-tips/random`);
                if (!response.ok) throw new Error('Failed to load hair tip');

                const data = await response.json();
                if (data.tip && data.tip.text) {
                    tipElement.textContent = data.tip.text;
                } else {
                    // Show random default tip
                    const randomTip = defaultHairTips[Math.floor(Math.random() * defaultHairTips.length)];
                    tipElement.textContent = randomTip;
                }
            } catch (error) {
                console.error('Failed to load hair tip:', error);
                // Show random default tip on error
                const randomTip = defaultHairTips[Math.floor(Math.random() * defaultHairTips.length)];
                tipElement.textContent = randomTip;
            }
        }

        // ========== CART FUNCTIONALITY ==========
        const CART_STORAGE_KEY = 'flirt_cart';

        // Load cart from localStorage or use empty array
        function loadCartFromStorage() {
            try {
                const stored = localStorage.getItem(CART_STORAGE_KEY);
                return stored ? JSON.parse(stored) : [];
            } catch (e) {
                console.error('Error loading cart from storage:', e);
                return [];
            }
        }

        // Save cart to localStorage
        function saveCartToStorage() {
            try {
                localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(cart));
            } catch (e) {
                console.error('Error saving cart to storage:', e);
            }
        }

        // Clear cart from localStorage
        function clearCartStorage() {
            try {
                localStorage.removeItem(CART_STORAGE_KEY);
            } catch (e) {
                console.error('Error clearing cart storage:', e);
            }
        }

        // Initialize cart from storage
        let cart = loadCartFromStorage();
        let deliveryFee = 0;
        let discount = 0;

        function showCart() {
            document.getElementById('cartModal').classList.add('open');
            document.getElementById('cartOverlay').classList.add('show');
            updateCartDisplay();
        }

        function closeCart() {
            document.getElementById('cartModal').classList.remove('open');
            document.getElementById('cartOverlay').classList.remove('show');
        }

        // ========== PRODUCT LOADING & FILTERING ==========
        let allProducts = [];
        let filteredProducts = [];
        let currentCategory = 'all';
        let currentSearchTerm = '';
        let shopBannerCountdownInterval = null;

        // Load and display shop banner
        async function loadShopBanner() {
            try {
                const data = await apiCall('/promo/shop-banner');
                if (data.success && data.promo) {
                    renderShopBanner(data.promo);
                } else {
                    // Hide banner if no active promo
                    document.getElementById('flash-sale-banner').style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading shop banner:', error);
                document.getElementById('flash-sale-banner').style.display = 'none';
            }
        }

        // Render shop banner with countdown
        function renderShopBanner(promo) {
            const banner = document.getElementById('flash-sale-banner');
            if (!banner) return;

            const badge = promo.badge || 'Flash Sale';
            const title = promo.title || `${promo.discountValue}${promo.discountType === 'percentage' ? '%' : ' R'} OFF!`;
            const subtitle = promo.subtitle || `Use code: ${promo.code} at checkout`;

            banner.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 12px; text-transform: uppercase; letter-spacing: 2px; opacity: 0.9;">${badge}</div>
                    <div style="font-size: 24px; font-weight: bold; margin: 10px 0;">${title}</div>
                    <div style="font-size: 14px;">${subtitle}</div>
                </div>
                <div class="flash-sale-timer" id="shop-banner-timer">
                    <div class="timer-block">
                        <div class="timer-value" id="shop-hours">00</div>
                        <div class="timer-label">Hours</div>
                    </div>
                    <div class="timer-block">
                        <div class="timer-value" id="shop-minutes">00</div>
                        <div class="timer-label">Mins</div>
                    </div>
                    <div class="timer-block">
                        <div class="timer-value" id="shop-seconds">00</div>
                        <div class="timer-label">Secs</div>
                    </div>
                </div>
            `;

            banner.style.display = 'flex';

            // Start countdown if there's an expiry date
            if (promo.expiresAt) {
                startShopBannerCountdown(promo.expiresAt);
            } else {
                // Hide timer if no expiry
                document.getElementById('shop-banner-timer').style.display = 'none';
            }
        }

        // Countdown timer for shop banner
        function startShopBannerCountdown(expiresAt) {
            // Clear any existing interval
            if (shopBannerCountdownInterval) {
                clearInterval(shopBannerCountdownInterval);
            }

            const updateTimer = () => {
                const now = new Date().getTime();
                const expiry = new Date(expiresAt).getTime();
                const distance = expiry - now;

                if (distance < 0) {
                    clearInterval(shopBannerCountdownInterval);
                    document.getElementById('flash-sale-banner').style.display = 'none';
                    return;
                }

                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                document.getElementById('shop-hours').textContent = String(hours).padStart(2, '0');
                document.getElementById('shop-minutes').textContent = String(minutes).padStart(2, '0');
                document.getElementById('shop-seconds').textContent = String(seconds).padStart(2, '0');
            };

            // Update immediately
            updateTimer();

            // Update every second
            shopBannerCountdownInterval = setInterval(updateTimer, 1000);
        }

        async function loadProducts() {
            try {
                const data = await apiCall('/products');
                if (data.success) {
                    allProducts = data.products || [];
                    filteredProducts = [...allProducts];

                    // Generate dynamic category filters
                    renderCategoryFilters();

                    // Load flash sale banner
                    loadShopBanner();

                    renderProducts();
                } else {
                    console.error('Failed to load products');
                    document.getElementById('allProductsGrid').innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--danger);">Failed to load products</div>';
                }
            } catch (error) {
                console.error('Error loading products:', error);
                document.getElementById('allProductsGrid').innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--danger);">Error loading products</div>';
            }
        }

        function renderCategoryFilters() {
            // Extract unique categories from products
            const categories = [...new Set(allProducts.map(p => p.category).filter(Boolean))].sort();

            const filterContainer = document.getElementById('productCategoryFilters');
            if (!filterContainer) return;

            // Build filter buttons HTML
            let filtersHTML = `
                <button class="btn btn-small btn-primary" data-filter="all" onclick="filterProductsByCategory('all')" style="white-space: nowrap;">
                    All Products
                </button>
                <button class="btn btn-small btn-outline" data-filter="sale" onclick="filterProductsByCategory('sale')" style="white-space: nowrap;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14" style="vertical-align: middle; margin-right: 4px;">
                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                    </svg>
                    On Sale
                </button>
            `;

            // Add dynamic category buttons
            categories.forEach(category => {
                filtersHTML += `
                    <button class="btn btn-small btn-outline" data-filter="${category}" onclick="filterProductsByCategory('${category}')" style="white-space: nowrap;">
                        ${category}
                    </button>
                `;
            });

            filterContainer.innerHTML = filtersHTML;
        }

        function filterProductsByCategory(category) {
            currentCategory = category;

            // Update button states
            document.querySelectorAll('[data-filter]').forEach(btn => {
                if (btn.getAttribute('data-filter') === category) {
                    btn.classList.remove('btn-outline');
                    btn.classList.add('btn-primary');
                } else {
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-outline');
                }
            });

            applyFilters();
        }

        function searchProducts() {
            currentSearchTerm = document.getElementById('productSearchInput').value.toLowerCase();
            applyFilters();
        }

        function sortProducts() {
            applyFilters(); // Re-apply filters which will also trigger render with new sort
        }

        function applyFilters() {
            let products = [...allProducts];

            // Apply category filter
            if (currentCategory === 'sale') {
                products = products.filter(p => p.sale_price || p.salePrice);
            } else if (currentCategory !== 'all') {
                products = products.filter(p => p.category === currentCategory);
            }

            // Apply search filter
            if (currentSearchTerm) {
                products = products.filter(p =>
                    (p.name || '').toLowerCase().includes(currentSearchTerm) ||
                    (p.description || '').toLowerCase().includes(currentSearchTerm) ||
                    (p.category || '').toLowerCase().includes(currentSearchTerm)
                );
            }

            filteredProducts = products;
            renderProducts();
        }

        function renderProducts() {
            let productsToDisplay = [...filteredProducts];

            // Apply sorting
            const sortBy = document.getElementById('sortProducts')?.value || 'featured';

            switch (sortBy) {
                case 'price-low':
                    productsToDisplay.sort((a, b) => {
                        const priceA = a.sale_price || a.salePrice || a.price;
                        const priceB = b.sale_price || b.salePrice || b.price;
                        return priceA - priceB;
                    });
                    break;
                case 'price-high':
                    productsToDisplay.sort((a, b) => {
                        const priceA = a.sale_price || a.salePrice || a.price;
                        const priceB = b.sale_price || b.salePrice || b.price;
                        return priceB - priceA;
                    });
                    break;
                case 'name':
                    productsToDisplay.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                    break;
                case 'newest':
                    productsToDisplay.sort((a, b) => {
                        const dateA = new Date(a.created_at || a.createdAt || 0);
                        const dateB = new Date(b.created_at || b.createdAt || 0);
                        return dateB - dateA;
                    });
                    break;
                default: // 'featured'
                    // Keep original order or sort by active status, then sale items first
                    productsToDisplay.sort((a, b) => {
                        const hasDiscountA = (a.sale_price || a.salePrice) && (a.sale_price || a.salePrice) < a.price;
                        const hasDiscountB = (b.sale_price || b.salePrice) && (b.sale_price || b.salePrice) < b.price;
                        if (hasDiscountA && !hasDiscountB) return -1;
                        if (!hasDiscountA && hasDiscountB) return 1;
                        return 0;
                    });
            }

            const saleProducts = productsToDisplay.filter(p => p.sale_price || p.salePrice);
            const regularProducts = currentCategory === 'sale' ? saleProducts : productsToDisplay;

            // Show/hide sale section
            const saleSection = document.getElementById('saleProductsSection');
            const saleGrid = document.getElementById('saleProductsGrid');

            if (saleProducts.length > 0 && currentCategory === 'all') {
                saleSection.style.display = 'flex';
                saleGrid.style.display = 'grid';
                saleGrid.innerHTML = saleProducts.slice(0, 4).map(product => renderProductCard(product, true)).join('');
            } else {
                saleSection.style.display = 'none';
                saleGrid.style.display = 'none';
            }

            // Update product count
            const productCountEl = document.getElementById('productCount');
            if (productCountEl) {
                productCountEl.textContent = `${regularProducts.length} product${regularProducts.length !== 1 ? 's' : ''}`;
            }

            // Render main products grid
            const allProductsGrid = document.getElementById('allProductsGrid');
            if (regularProducts.length === 0) {
                allProductsGrid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--text-subtle);">No products found</div>';
            } else {
                allProductsGrid.innerHTML = regularProducts.map(product => renderProductCard(product, false)).join('');
            }
        }

        function renderProductCard(product, isSale) {
            const price = product.sale_price || product.salePrice || product.price;
            const originalPrice = product.price;
            const hasDiscount = price < originalPrice;
            const discountPercent = hasDiscount ? Math.round(((originalPrice - price) / originalPrice) * 100) : 0;
            const imageUrl = product.image_url || product.imageUrl || 'https://www.flirthair.co.za/wp-content/uploads/2022/03/KEVIN-MURPHY-Angel-300x300.png';

            // Truncate description to 80 characters
            const description = product.description || '';
            const maxLength = 80;
            const truncatedDesc = description.length > maxLength
                ? description.substring(0, maxLength).trim() + '...'
                : description;

            return `
                <div class="product-card" onclick="showProductDetails('${product.id}')" style="position: relative; cursor: pointer;">
                    ${hasDiscount ? `<span class="sale-badge">-${discountPercent}%</span>` : ''}
                    <img src="${imageUrl}" alt="${product.name}" class="product-image" onerror="this.src='https://www.flirthair.co.za/wp-content/uploads/2022/03/KEVIN-MURPHY-Angel-300x300.png'">
                    <div class="product-info">
                        <div class="product-name">${product.name}</div>
                        <div class="product-description" style="min-height: 60px;">
                            ${truncatedDesc}
                            ${description.length > maxLength ? '<span style="color: var(--brand-pink); font-weight: 500; cursor: pointer;"> Read More</span>' : ''}
                        </div>
                        <div class="product-price">
                            ${hasDiscount ? `<span class="original-price">R${originalPrice}</span>` : ''}
                            <span class="${hasDiscount ? 'sale-price' : ''}">R${price}</span>
                        </div>
                        <button class="btn btn-secondary btn-small" onclick="event.stopPropagation(); addToCartFromProduct('${product.id}', '${product.name.replace(/'/g, "\\'")}', ${price}, ${originalPrice}, '${imageUrl.replace(/'/g, "\\'")}')">Add to Cart</button>
                    </div>
                </div>
            `;
        }

        // ========== QUICK VIEW MODAL ==========
        let currentQuickViewProduct = null;

        function showProductDetails(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) {
                console.error('Product not found:', productId);
                return;
            }

            currentQuickViewProduct = product;

            // Populate modal with product data
            const price = product.sale_price || product.salePrice || product.price;
            const originalPrice = product.price;
            const hasDiscount = price < originalPrice;
            const discountPercent = hasDiscount ? Math.round(((originalPrice - price) / originalPrice) * 100) : 0;
            const imageUrl = product.image_url || product.imageUrl || 'https://www.flirthair.co.za/wp-content/uploads/2022/03/KEVIN-MURPHY-Angel-300x300.png';
            const stock = product.stock || 0;

            // Update image
            document.getElementById('qv-image').src = imageUrl;
            document.getElementById('qv-image').alt = product.name;

            // Update badge
            const badgeContainer = document.getElementById('qv-badge-container');
            if (hasDiscount) {
                badgeContainer.innerHTML = `<span class="sale-badge">-${discountPercent}%</span>`;
            } else {
                badgeContainer.innerHTML = '';
            }

            // Update product details
            document.getElementById('qv-name').textContent = product.name;
            document.getElementById('qv-category').textContent = product.category || 'Hair Products';
            document.getElementById('qv-description').textContent = product.description || 'Premium hair care product from Flirt Hair & Beauty.';

            // Update price
            document.getElementById('qv-price').textContent = `R${price}`;
            if (hasDiscount) {
                document.getElementById('qv-original-price').textContent = `R${originalPrice}`;
                document.getElementById('qv-original-price').style.display = 'inline';
                document.getElementById('qv-discount-badge').textContent = `${discountPercent}% OFF`;
                document.getElementById('qv-discount-badge').style.display = 'inline';
            } else {
                document.getElementById('qv-original-price').style.display = 'none';
                document.getElementById('qv-discount-badge').style.display = 'none';
            }

            // Update stock status
            const stockStatus = document.getElementById('qv-stock-status');
            if (stock === 0) {
                stockStatus.innerHTML = '<span style="color: var(--danger); font-weight: 500;">Out of Stock</span>';
                document.getElementById('qv-add-to-cart-btn').disabled = true;
                document.getElementById('qv-add-to-cart-btn').textContent = 'Out of Stock';
            } else if (stock < 10) {
                stockStatus.innerHTML = `<span style="color: var(--warning); font-weight: 500;">Only ${stock} left in stock!</span>`;
                document.getElementById('qv-add-to-cart-btn').disabled = false;
                document.getElementById('qv-add-to-cart-btn').textContent = 'Add to Cart';
            } else {
                stockStatus.innerHTML = '<span style="color: var(--success); font-weight: 500;">In Stock</span>';
                document.getElementById('qv-add-to-cart-btn').disabled = false;
                document.getElementById('qv-add-to-cart-btn').textContent = 'Add to Cart';
            }

            // Reset quantity
            document.getElementById('qv-quantity').value = 1;

            // Update wishlist button state
            updateWishlistButtonState();

            // Show modal
            document.getElementById('productQuickViewModal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeQuickView(event) {
            // Only close if clicking overlay or close button
            if (event && event.target.className !== 'modal-overlay') {
                return;
            }

            document.getElementById('productQuickViewModal').style.display = 'none';
            document.body.style.overflow = '';
            currentQuickViewProduct = null;
        }

        function changeQuickViewQty(delta) {
            const qtyInput = document.getElementById('qv-quantity');
            const currentQty = parseInt(qtyInput.value) || 1;
            const newQty = Math.max(1, currentQty + delta);
            const stock = currentQuickViewProduct?.stock || 100;

            if (newQty <= stock) {
                qtyInput.value = newQty;
            } else {
                showToast({
                    type: 'warning',
                    title: 'Stock Limit',
                    message: `Only ${stock} available in stock`,
                    duration: 3000
                });
            }
        }

        function addToCartFromQuickView() {
            if (!currentQuickViewProduct) return;

            const quantity = parseInt(document.getElementById('qv-quantity').value) || 1;
            const price = currentQuickViewProduct.sale_price || currentQuickViewProduct.salePrice || currentQuickViewProduct.price;
            const originalPrice = currentQuickViewProduct.price;
            const imageUrl = currentQuickViewProduct.image_url || currentQuickViewProduct.imageUrl || 'https://www.flirthair.co.za/wp-content/uploads/2022/03/KEVIN-MURPHY-Angel-300x300.png';

            const existingItem = cart.find(item => item.id === currentQuickViewProduct.id);
            if (existingItem) {
                existingItem.qty += quantity;
            } else {
                cart.push({
                    id: currentQuickViewProduct.id,
                    name: currentQuickViewProduct.name,
                    price: price,
                    originalPrice: originalPrice,
                    qty: quantity,
                    image: imageUrl
                });
            }

            saveCartToStorage();
            updateCartCount();

            showToast({
                type: 'success',
                title: 'Added to Cart',
                message: `${quantity}x ${currentQuickViewProduct.name} added to cart`,
                duration: 3000
            });

            // Close modal after adding
            closeQuickView();
        }

        function viewFullProductDetails() {
            // TODO: Navigate to dedicated product detail page
            showToast({
                type: 'info',
                title: 'Coming Soon',
                message: 'Full product details page coming soon!',
                duration: 3000
            });
        }

        // ========== WISHLIST FUNCTIONALITY ==========
        let wishlist = JSON.parse(localStorage.getItem('flirt_wishlist') || '[]');

        function toggleWishlistFromQuickView() {
            if (!currentQuickViewProduct) return;

            const productId = currentQuickViewProduct.id;
            const index = wishlist.indexOf(productId);

            if (index > -1) {
                wishlist.splice(index, 1);
                showToast({
                    type: 'info',
                    title: 'Removed from Wishlist',
                    message: `${currentQuickViewProduct.name} removed from wishlist`,
                    duration: 2000
                });
            } else {
                wishlist.push(productId);
                showToast({
                    type: 'success',
                    title: 'Added to Wishlist',
                    message: `${currentQuickViewProduct.name} saved for later`,
                    duration: 2000
                });
            }

            localStorage.setItem('flirt_wishlist', JSON.stringify(wishlist));
            updateWishlistButtonState();
        }

        function updateWishlistButtonState() {
            if (!currentQuickViewProduct) return;

            const btn = document.getElementById('qv-wishlist-btn');
            const isInWishlist = wishlist.includes(currentQuickViewProduct.id);

            if (isInWishlist) {
                btn.classList.add('active');
                btn.querySelector('svg').setAttribute('fill', 'currentColor');
            } else {
                btn.classList.remove('active');
                btn.querySelector('svg').setAttribute('fill', 'none');
            }
        }

        function addToCartFromProduct(id, name, price, originalPrice, imageUrl) {
            const existingItem = cart.find(item => item.id === id);
            if (existingItem) {
                existingItem.qty++;
            } else {
                cart.push({
                    id: id,
                    name: name,
                    price: price,
                    originalPrice: originalPrice,
                    qty: 1,
                    image: imageUrl
                });
            }
            saveCartToStorage();
            updateCartCount();
            showToast({ type: 'success', title: 'Added to Cart', message: `${name} has been added to your cart`, duration: 3000 });
        }

        function addToCart(id, name, price, originalPrice) {
            const existingItem = cart.find(item => item.id === id);
            if (existingItem) {
                existingItem.qty++;
            } else {
                cart.push({
                    id: id,
                    name: name,
                    price: price,
                    originalPrice: originalPrice,
                    qty: 1,
                image: 'https://www.flirthair.co.za/wp-content/uploads/2022/03/KEVIN-MURPHY-Angel-300x300.png'
                });
            }
            saveCartToStorage(); // Persist cart
            updateCartCount();
            showToast({ type: 'success', title: 'Added to Cart', message: `${name} has been added to your cart`, duration: 3000 });
        }

        function updateQty(id, change) {
            const item = cart.find(i => i.id === id);
            if (item) {
                item.qty = Math.max(1, item.qty + change);
                document.getElementById(`qty-${id}`).textContent = item.qty;
                saveCartToStorage(); // Persist cart
                updateCartTotals();
            }
        }

        function removeFromCart(id) {
            cart = cart.filter(item => item.id !== id);
            saveCartToStorage(); // Persist cart
            updateCartDisplay();
            updateCartCount();
        }

        function updateCartCount() {
            const count = cart.reduce((sum, item) => sum + item.qty, 0);
            document.getElementById('cartCount').textContent = count;
        }

        function updateCartDisplay() {
            const cartItemsContainer = document.getElementById('cartItems');
            if (cart.length === 0) {
                cartItemsContainer.innerHTML = '<p style="text-align: center; color: var(--gray-medium); padding: 40px;">Your cart is empty</p>';
            } else {
                cartItemsContainer.innerHTML = cart.map(item => `
                    <div class="cart-item">
                        <img src="${item.image}" class="cart-item-image" alt="${item.name}">
                        <div class="cart-item-details">
                            <div class="cart-item-name">${item.name}</div>
                            <div class="cart-item-price">R${item.price}</div>
                            <div class="quantity-control">
                                <button class="qty-btn" onclick="updateQty('${item.id}', -1)">-</button>
                                <span id="qty-${item.id}">${item.qty}</span>
                                <button class="qty-btn" onclick="updateQty('${item.id}', 1)">+</button>
                                <button style="background: none; border: none; color: var(--brand-pink); cursor: pointer; margin-left: 10px;" onclick="removeFromCart('${item.id}')">Remove</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            updateCartTotals();
        }

        function updateCartTotals() {
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            const total = subtotal + deliveryFee - discount;
            document.getElementById('cartSubtotal').textContent = `R${subtotal}`;
            document.getElementById('cartTotal').textContent = `R${total}`;
        }

        // ========== CHECKOUT FUNCTIONALITY ==========
        function openCheckout() {
            closeCart();
            document.getElementById('checkoutModal').classList.add('show');
        }

        function selectDelivery(element, method, fee) {
            document.querySelectorAll('.delivery-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            deliveryFee = fee;

            // Show/hide address section
            const addressSection = document.getElementById('deliveryAddressSection');
            if (method === 'pickup') {
                addressSection.style.display = 'none';
                document.getElementById('invoiceDelivery').textContent = 'FREE';
            } else {
                addressSection.style.display = 'block';
                document.getElementById('invoiceDelivery').textContent = `R${fee}`;
            }
            updateCheckoutTotal();
        }

        let appliedPromoCode = null;

        async function applyPromo() {
            const code = document.getElementById('promoCode').value.trim();
            const messageEl = document.getElementById('promoMessage');

            if (!code) {
                discount = 0;
                appliedPromoCode = null;
                messageEl.textContent = '';
                document.getElementById('discountRow').style.display = 'none';
                updateCheckoutTotal();
                return;
            }

            try {
                const data = await apiCall('/promo/validate', {
                    method: 'POST',
                    body: JSON.stringify({ code, subtotal: getSubtotal() })
                });

                discount = data.promo.calculatedDiscount;
                appliedPromoCode = data.promo.code;
                messageEl.textContent = ` ${data.promo.description}! You save R${discount}`;
                messageEl.style.color = 'var(--success)';
                document.getElementById('discountRow').style.display = 'flex';
                document.getElementById('invoiceDiscount').textContent = `-R${discount}`;
            } catch (error) {
                discount = 0;
                appliedPromoCode = null;
                messageEl.textContent = error.message || 'Invalid promo code';
                messageEl.style.color = 'var(--danger)';
                document.getElementById('discountRow').style.display = 'none';
            }
            updateCheckoutTotal();
        }

        function getSubtotal() {
            return cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
        }

        function updateCheckoutTotal() {
            const subtotal = getSubtotal();
            const total = subtotal + deliveryFee - discount;
            document.getElementById('invoiceTotal').textContent = `R${total}`;
            document.getElementById('payAmount').textContent = total;
        }

        // Helper function to build delivery address from form fields
        function getDeliveryAddress() {
            const street = document.getElementById('deliveryStreet')?.value?.trim() || '';
            const suburb = document.getElementById('deliverySuburb')?.value?.trim() || '';
            const city = document.getElementById('deliveryCity')?.value?.trim() || '';
            const postalCode = document.getElementById('deliveryPostalCode')?.value?.trim() || '';
            const instructions = document.getElementById('deliveryInstructions')?.value?.trim() || '';

            // Build address string
            const parts = [street];
            if (suburb) parts.push(suburb);
            parts.push(city);
            parts.push(postalCode);

            return {
                formatted: parts.filter(p => p).join(', '),
                street,
                suburb,
                city,
                postalCode,
                instructions
            };
        }

        // Validate delivery address fields
        function validateDeliveryAddress() {
            const street = document.getElementById('deliveryStreet')?.value?.trim();
            const city = document.getElementById('deliveryCity')?.value?.trim();
            const postalCode = document.getElementById('deliveryPostalCode')?.value?.trim();

            const errors = [];
            if (!street) errors.push('Street address is required');
            if (!city) errors.push('City is required');
            if (!postalCode) errors.push('Postal code is required');

            return errors;
        }

        async function processPayment() {
            // Check if user is logged in
            if (!currentUser) {
                showAuthModal();
                return;
            }

            if (cart.length === 0) {
                alert('Your cart is empty!');
                return;
            }

            // Get delivery info
            const selectedDelivery = document.querySelector('.delivery-option.selected');
            const deliveryMethod = selectedDelivery?.dataset?.method || 'pickup';

            // Get and validate delivery address for non-pickup orders
            let deliveryAddress = null;
            if (deliveryMethod !== 'pickup') {
                const addressErrors = validateDeliveryAddress();
                if (addressErrors.length > 0) {
                    alert('Please complete your delivery address:\n\n' + addressErrors.join('\n'));
                    return;
                }
                deliveryAddress = getDeliveryAddress();
            }

            if (deliveryMethod !== 'pickup' && !deliveryAddress) {
                alert('Please enter your delivery address');
                return;
            }

            try {
                const orderData = {
                    items: cart.map(item => ({
                        productId: item.id,
                        quantity: item.qty
                    })),
                    deliveryMethod,
                    deliveryAddress: deliveryMethod !== 'pickup' ? deliveryAddress : null,
                    promoCode: appliedPromoCode
                };

                const data = await apiCall('/orders', {
                    method: 'POST',
                    body: JSON.stringify(orderData)
                });

                // Choose provider: prefer PayFast if configured, else Yoco
                const preferredProvider = window.paymentConfig?.payfast?.configured ? 'payfast' : 'yoco';

                const paymentInit = await apiCall('/payments/initiate', {
                    method: 'POST',
                    body: JSON.stringify({
                        provider: preferredProvider,
                        orderId: data.order.id
                    })
                });

                if (paymentInit.payment?.provider === 'payfast') {
                    const form = document.createElement('form');
                    form.action = paymentInit.payment.formAction;
                    form.method = 'POST';
                    form.style.display = 'none';

                    Object.entries(paymentInit.payment.formData || {}).forEach(([name, value]) => {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = name;
                        input.value = value;
                        form.appendChild(input);
                    });

                    document.body.appendChild(form);
                    form.submit();
                } else if (paymentInit.payment?.provider === 'yoco' && paymentInit.payment.redirectUrl) {
                    window.location.href = paymentInit.payment.redirectUrl;
                } else {
                    alert('Payment created, but no redirect URL returned. Please contact support.');
                }

                // Clear cart after redirect is triggered
                closeModal('checkoutModal');
                cart = [];
                clearCartStorage(); // Clear persisted cart
                discount = 0;
                appliedPromoCode = null;
                updateCartCount();
            } catch (error) {
                alert('Error processing order: ' + error.message);
            }
        }
        // ========== CHAT FUNCTIONALITY ==========
        let chatOpen = false;

        // ========== REAL-TIME CHAT SYSTEM ==========
        let currentConversationId = null;
        let chatPollingInterval = null;
        let lastRenderedMessageCount = 0;

        // Load saved conversationId (if any) for persistence across reloads
        (function loadSavedConversationId() {
            const savedId = localStorage.getItem('flirt_conversation_id');
            if (savedId) {
                currentConversationId = savedId;
            }
        })();

        function getGuestId() {
            let id = localStorage.getItem('flirt_guest_id');
            if (!id) {
                id = 'guest_' + Math.random().toString(36).slice(2);
                localStorage.setItem('flirt_guest_id', id);
            }
            return id;
        }

        function toggleChat() {
            chatOpen = !chatOpen;
            const chatWindow = document.getElementById('chatWindow');
            const chatFab = document.getElementById('chatFab');

            if (chatOpen) {
                chatWindow.classList.add('open');
                chatFab.style.display = 'none';
                document.querySelector('.chat-notification').style.display = 'none';
                // Load existing conversation when chat opens
                loadExistingConversation();
                // Start polling for new messages
                startChatPolling();
            } else {
                chatWindow.classList.remove('open');
                chatFab.style.display = 'flex';
                // Stop polling when chat closes
                stopChatPolling();
            }
        }

        async function loadExistingConversation() {
            try {
                let url = '/chat/my-latest';
                if (!currentUser) {
                    url += '?guestId=' + encodeURIComponent(getGuestId());
                }
                if (currentConversationId) {
                    url = `/chat/conversation/${currentConversationId}`;
                    if (!currentUser) {
                        url += '?guestId=' + encodeURIComponent(getGuestId());
                    }
                }

                const data = await apiCall(url);

                if (data.conversation) {
                    currentConversationId = data.conversation.id;
                    localStorage.setItem('flirt_conversation_id', currentConversationId);
                    renderConversation(data.conversation);
                } else {
                    // No existing conversation, show welcome message
                    const messagesContainer = document.getElementById('chatMessages');
                    messagesContainer.innerHTML = '';
                    appendChatMessage('received', 'Hey gorgeous!  Welcome to Flirt Hair! How can I help you with your hair journey today?', new Date());
                    lastRenderedMessageCount = 0;
                }
            } catch (error) {
                console.error('Failed to load conversation:', error);
            }
        }

        function renderConversation(conversation) {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = '';

            if (conversation.messages && conversation.messages.length > 0) {
                conversation.messages.forEach(msg => {
                    const fromType = msg.from === 'user' ? 'sent' : 'received';
                    appendChatMessage(fromType, msg.text, new Date(msg.createdAt));
                });
                lastRenderedMessageCount = conversation.messages.length;
            }
        }

        function appendChatMessage(fromType, text, date) {
            const messagesContainer = document.getElementById('chatMessages');
            const wrapper = document.createElement('div');
            wrapper.className = 'chat-message ' + fromType;

            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.textContent = text; // Safe: uses textContent, not innerHTML

            const time = document.createElement('div');
            time.className = 'message-time';
            time.textContent = date ? formatChatTime(date) : '';

            wrapper.appendChild(bubble);
            wrapper.appendChild(time);
            messagesContainer.appendChild(wrapper);

            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function formatChatTime(date) {
            const now = new Date();
            const diff = now - date;

            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
            if (diff < 86400000) return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            return formatDateDisplay(date);
        }

        function handleChatKeypress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();

            if (!text) return;

            // Optimistic render of user message
            appendChatMessage('sent', text, new Date());
            input.value = '';

            try {
                const body = {
                    conversationId: currentConversationId,
                    text,
                    source: 'app'
                };

                if (!currentUser) {
                    body.guestId = getGuestId();
                }

                const data = await apiCall('/chat/message', {
                    method: 'POST',
                    body: JSON.stringify(body)
                });

                if (!currentConversationId && data.conversation) {
                    currentConversationId = data.conversation.id;
                    // Store in localStorage for persistence
                    localStorage.setItem('flirt_conversation_id', currentConversationId);
                }

                // If it's a new conversation, we may have received a system welcome message
                if (data.isNewConversation) {
                    // Reload to get the welcome message
                    await pollForNewMessages();
                }

                lastRenderedMessageCount++;

            } catch (error) {
                console.error('Chat send error:', error);
                // Show error indication
                appendChatMessage('received', 'Sorry, there was an error sending your message. Please try again.', new Date());
            }
        }

        function startChatPolling() {
            if (chatPollingInterval) return;

            chatPollingInterval = setInterval(async () => {
                if (currentConversationId && chatOpen) {
                    await pollForNewMessages();
                }
            }, 10000); // Poll every 10 seconds
        }

        function stopChatPolling() {
            if (chatPollingInterval) {
                clearInterval(chatPollingInterval);
                chatPollingInterval = null;
            }
        }

        async function pollForNewMessages() {
            if (!currentConversationId) return;

            try {
                let url = `/chat/conversation/${currentConversationId}`;
                if (!currentUser) {
                    url += '?guestId=' + encodeURIComponent(getGuestId());
                }

                const data = await apiCall(url);

                if (data.conversation && data.conversation.messages) {
                    const messages = data.conversation.messages;

                    // Check if there are new messages
                    if (messages.length > lastRenderedMessageCount) {
                        // Render only new messages
                        const newMessages = messages.slice(lastRenderedMessageCount);
                        newMessages.forEach(msg => {
                            // Only render agent/system messages (user messages already rendered optimistically)
                            if (msg.from !== 'user') {
                                appendChatMessage('received', msg.text, new Date(msg.createdAt));
                            }
                        });
                        lastRenderedMessageCount = messages.length;
                    }
                }
            } catch (error) {
                console.error('Error polling messages:', error);
            }
        }

        // ========== PHOTO UPLOAD FUNCTIONALITY ==========
        let uploadedPhotosData = [];

        async function openPhotoUpload() {
            uploadedPhotosData = [];
            document.getElementById('uploadPreviewContainer').innerHTML = '';
            document.getElementById('inspoNotes').value = '';
            document.getElementById('photoInput').value = '';
            document.getElementById('photoUploadModal').classList.add('show');
        }

        function triggerFileUpload() {
            document.getElementById('photoInput').click();
        }

        async function handlePhotoUpload(event) {
            const files = Array.from(event.target.files);
            const previewContainer = document.getElementById('uploadPreviewContainer');

            // Check total count
            const currentCount = await getInspoPhotosCount();
            const totalAfterUpload = currentCount + files.length;

            if (totalAfterUpload > 5) {
                alert(`You can only upload ${5 - currentCount} more photo(s). Maximum of 5 photos allowed.`);
                event.target.value = '';
                return;
            }

            previewContainer.innerHTML = '';
            uploadedPhotosData = [];

            for (let file of files) {
                if (!file.type.startsWith('image/')) {
                    continue;
                }

                // Check file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert(`${file.name} is too large. Maximum size is 5MB.`);
                    continue;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64Data = e.target.result;
                    uploadedPhotosData.push(base64Data);
                    previewContainer.innerHTML += `<img src="${base64Data}" class="preview-thumb" alt="Upload preview">`;
                };
                reader.readAsDataURL(file);
            }
        }

        async function getInspoPhotosCount() {
            try {
                const token = getToken();
                const headers = {
                    'Content-Type': 'application/json',
                    ...(token && { 'Authorization': `Bearer ${token}` })
                };

                const response = await fetch(`${API_BASE}/inspo-photos`, { headers });
                if (!response.ok) return 0;

                const data = await response.json();
                return data.count || 0;
            } catch (error) {
                console.error('Error getting photo count:', error);
                return 0;
            }
        }

        async function saveInspoPhotos() {
            if (uploadedPhotosData.length === 0) {
                alert('Please select at least one photo to upload.');
                return;
            }

            const notes = document.getElementById('inspoNotes').value.trim();
            const token = getToken();
            const headers = {
                'Content-Type': 'application/json',
                ...(token && { 'Authorization': `Bearer ${token}` })
            };

            try {
                for (const imageData of uploadedPhotosData) {
                    const response = await fetch(`${API_BASE}/inspo-photos`, {
                        method: 'POST',
                        headers,
                        body: JSON.stringify({ imageData, notes })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        alert(error.message || 'Failed to save photo');
                        return;
                    }
                }

                alert(' Photos saved to your Inspo Board!\n\nYour stylist will be able to see these during your next consultation.');
                closeModal('photoUploadModal');
                loadInspoGallery(); // Reload gallery
            } catch (error) {
                console.error('Error saving photos:', error);
                alert('Failed to save photos. Please try again.');
            }
        }

        async function loadInspoGallery() {
            const gallery = document.getElementById('inspoGallery');
            if (!gallery) return;

            try {
                const token = getToken();
                const headers = {
                    'Content-Type': 'application/json',
                    ...(token && { 'Authorization': `Bearer ${token}` })
                };

                const response = await fetch(`${API_BASE}/inspo-photos`, { headers });
                if (!response.ok) {
                    gallery.innerHTML = '<p style="text-align:center;padding:40px;">Failed to load photos</p>';
                    return;
                }

                const data = await response.json();
                const photos = data.photos || [];

                if (photos.length === 0) {
                    gallery.innerHTML = `
                        <div class="card" style="text-align: center; padding: 40px; background: linear-gradient(135deg, var(--pink-light) 0%, var(--pink) 100%); border: none; color: white;">
                            <div style="font-size: 48px; margin-bottom: 15px;"></div>
                            <h3 style="margin-bottom: 10px; color: white;">No Inspiration Photos Yet</h3>
                            <p style="color: rgba(255,255,255,0.9); margin-bottom: 0;">
                                Click "Choose Photos" above to share your dream hairstyles with your stylist!
                            </p>
                        </div>
                    `;
                    return;
                }

                let galleryHTML = '';

                // Load full image data for each photo
                for (const photo of photos) {
                    const fullPhotoResponse = await fetch(`${API_BASE}/inspo-photos/${photo.id}`, { headers });
                    if (fullPhotoResponse.ok) {
                        const fullPhoto = await fullPhotoResponse.json();
                        const photoData = fullPhoto.photo || {};

                        galleryHTML += `
                            <div class="inspo-item">
                                <img src="${photoData.image_data || photoData.imageData}" alt="${photoData.label || 'Inspo'}">
                                <div class="inspo-item-overlay">
                                    <span class="inspo-label">${photoData.label || photoData.notes || 'My Inspo'}</span>
                                    <button class="btn-icon-delete" onclick="deleteInspoPhoto('${photo.id}')" style="position:absolute;top:10px;right:10px;background:rgba(255,255,255,0.9);border:none;border-radius:50%;width:30px;height:30px;cursor:pointer;"></button>
                                </div>
                            </div>
                        `;
                    }
                }

                gallery.innerHTML = galleryHTML;
            } catch (error) {
                console.error('Error loading inspo gallery:', error);
                gallery.innerHTML = `
                    <div class="card" style="text-align: center; padding: 40px; background: var(--gray-light); border: 2px dashed var(--gray-medium);">
                        <div style="font-size: 48px; margin-bottom: 15px;"></div>
                        <h3 style="margin-bottom: 10px; color: var(--gray-dark);">Couldn't Load Photos</h3>
                        <p style="color: var(--gray-medium); margin-bottom: 15px;">
                            There was an error loading your inspiration photos.
                        </p>
                        <button class="btn btn-secondary btn-small" onclick="loadInspoGallery()">Try Again</button>
                    </div>
                `;
            }
        }

        async function deleteInspoPhoto(photoId) {
            if (!confirm('Delete this photo?')) return;

            try {
                const token = getToken();
                const headers = {
                    'Content-Type': 'application/json',
                    ...(token && { 'Authorization': `Bearer ${token}` })
                };

                const response = await fetch(`${API_BASE}/inspo-photos/${photoId}`, {
                    method: 'DELETE',
                    headers
                });

                if (!response.ok) {
                    alert('Failed to delete photo');
                    return;
                }

                loadInspoGallery(); // Reload gallery
            } catch (error) {
                console.error('Error deleting photo:', error);
                alert('Failed to delete photo. Please try again.');
            }
        }

        // ========== TEAM FUNCTIONALITY ==========
        async function loadTeam() {
            const teamGrid = document.getElementById('teamGrid');
            if (!teamGrid) return;

            try {
                const token = getToken();
                const headers = {
                    'Content-Type': 'application/json',
                    ...(token && { 'Authorization': `Bearer ${token}` })
                };

                const response = await fetch(`${API_BASE}/stylists`, {
                    headers: headers
                });

                if (!response.ok) {
                    throw new Error('Failed to load team');
                }

                const data = await response.json();
                const availableStylists = data.stylists.filter(s => s.available);

                if (availableStylists.length === 0) {
                    teamGrid.innerHTML = '<p style="text-align:center;color:var(--gray-medium);padding:40px;">No stylists available at the moment.</p>';
                    return;
                }

                teamGrid.innerHTML = availableStylists.map(stylist => {
                    const imageUrl = stylist.imageUrl || stylist.image_url;
                    const specialty = stylist.specialty || 'Hair Stylist';
                    const tagline = stylist.tagline || 'Passionate about creating beautiful hair!';
                    const yearsExp = stylist.yearsExperience || stylist.years_experience || 0;
                    const rating = stylist.rating || 0;
                    const reviewCount = stylist.reviewCount || stylist.review_count || 0;
                    const instagram = stylist.instagram || '';
                    const color = stylist.color || '#F67599';
                    const initial = stylist.name.charAt(0).toUpperCase();

                    // Parse specialty tags
                    const specialtyTags = specialty.split(',').map(s => s.trim()).filter(s => s);
                    const specialtyTagsHtml = specialtyTags.map(tag =>
                        `<span class="team-specialty-tag">${tag}</span>`
                    ).join('');

                    return `
                        <div class="team-card">
                            ${imageUrl ?
                                `<img src="${imageUrl}" alt="${stylist.name}" class="team-photo">` :
                                `<div class="team-photo" style="background: linear-gradient(135deg, ${color} 0%, ${adjustColor(color, -20)} 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 48px; font-weight: bold;">${initial}</div>`
                            }
                            <div class="team-info">
                                <div class="team-avatar-overlay" style="background: linear-gradient(135deg, ${color} 0%, ${adjustColor(color, -20)} 100%);">${initial}</div>
                                <div class="team-name">${stylist.name}</div>
                                <div class="team-role">${specialty}</div>
                                <div class="team-tagline">${tagline}</div>
                                <div class="team-specialties">
                                    ${specialtyTagsHtml || '<span class="team-specialty-tag">Hair Extensions</span>'}
                                </div>
                                <div class="team-stats">
                                    <div class="team-stat">
                                        <div class="team-stat-value">${yearsExp}</div>
                                        <div class="team-stat-label">Years Exp</div>
                                    </div>
                                    <div class="team-stat">
                                        <div class="team-stat-value">${rating.toFixed(1)}</div>
                                        <div class="team-stat-label">Rating</div>
                                    </div>
                                    <div class="team-stat">
                                        <div class="team-stat-value">${reviewCount}</div>
                                        <div class="team-stat-label">Reviews</div>
                                    </div>
                                </div>
                                <div class="team-socials">
                                    ${instagram ? `<button class="team-social-btn" onclick="window.open('https://instagram.com/${instagram.replace('@', '')}', '_blank')"></button>` : ''}
                                    <button class="team-social-btn" onclick="bookWithStylist('${stylist.id}')"></button>
                                    <button class="team-social-btn" onclick="chatWithStylist('${stylist.id}', '${stylist.name}')"></button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading team:', error);
                teamGrid.innerHTML = '<p style="text-align:center;color:var(--error);padding:40px;">Failed to load team. Please try again later.</p>';
            }
        }

        // Helper function to adjust color brightness
        function adjustColor(color, percent) {
            const num = parseInt(color.replace('#', ''), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return '#' + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                (B < 255 ? B < 1 ? 0 : B : 255))
                .toString(16).slice(1);
        }

        function openStylistInsta(stylist) {
            alert(`Opening ${stylists[stylist].name}'s Instagram portfolio... `);
        }

        function bookWithStylist(stylistId) {
            selectStylist(stylistId);
            switchTab('booking');
        }

        function chatWithStylist(stylistId, stylistName) {
            toggleChat();
            setTimeout(() => {
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.innerHTML += `
                    <div class="chat-message received">
                        <div class="message-bubble">Hi! You've requested to chat with ${stylistName || 'our team'}. They'll be notified and will respond soon! </div>
                        <div class="message-time">Just now</div>
                    </div>
                `;
            }, 500);
        }

        // ========== FLASH SALE TIMER ==========
        function updateFlashSaleTimer() {
            const hoursEl = document.getElementById('hours');
            const minutesEl = document.getElementById('minutes');
            const secondsEl = document.getElementById('seconds');

            // Only run if timer elements exist (user is on shop tab)
            if (!hoursEl || !minutesEl || !secondsEl) return;

            let hours = parseInt(hoursEl.textContent);
            let minutes = parseInt(minutesEl.textContent);
            let seconds = parseInt(secondsEl.textContent);

            seconds--;
            if (seconds < 0) {
                seconds = 59;
                minutes--;
                if (minutes < 0) {
                    minutes = 59;
                    hours--;
                    if (hours < 0) {
                        hours = 5;
                        minutes = 32;
                        seconds = 48;
                    }
                }
            }

            hoursEl.textContent = hours.toString().padStart(2, '0');
            minutesEl.textContent = minutes.toString().padStart(2, '0');
            secondsEl.textContent = seconds.toString().padStart(2, '0');
        }

        setInterval(updateFlashSaleTimer, 1000);

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('show');
            }
        }

        // ============================================
        // INITIALIZATION
        // ============================================

        // Register Service Worker for PWA
        async function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('/sw.js');
                    console.log('[PWA] Service Worker registered:', registration.scope);

                    // Listen for updates
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // New version available
                                if (confirm('A new version of the app is available. Reload to update?')) {
                                    newWorker.postMessage('skipWaiting');
                                    window.location.reload();
                                }
                            }
                        });
                    });
                } catch (error) {
                    console.log('[PWA] Service Worker registration failed:', error);
                }
            }
        }

        async function initApp() {
            console.log(' Initializing Flirt Hair & Beauty App...');
            console.log('API_BASE:', API_BASE);

            // Dev auto-login for localhost
            await devAutoLoginIfNeeded();

            // Register service worker
            registerServiceWorker();
            // Wire support WhatsApp link
            const whatsappLink = document.getElementById('supportWhatsappLink');
            if (whatsappLink) {
                whatsappLink.href = `https://wa.me/${SUPPORT_WHATSAPP}`;
            }

            // Setup auth input listeners for clearing errors
            setupAuthInputListeners();

            // Initialize UI for guest state first, then check auth
            updateUserUI();

            // Check if user is already logged in (will update UI if logged in)
            console.log('Checking auth status...');
            await checkAuthStatus();

            // Load all data independently - errors in one section won't block others
            console.log('Loading booking data...');
            try {
                await loadBookingData();
            } catch (e) {
                console.error('Booking data load failed:', e);
            }

            console.log('Loading special offers...');
            try {
                await loadSpecialOffers();
            } catch (e) {
                console.error('Special offers load failed:', e);
            }

            console.log('Loading gallery...');
            try {
                await loadGallery();
                console.log(' Gallery loaded');
            } catch (e) {
                console.error('Gallery load failed:', e);
            }

            console.log('Loading inspo gallery...');
            try {
                await loadInspoGallery();
                console.log(' Inspo gallery loaded');
            } catch (e) {
                console.error('Inspo gallery load failed:', e);
            }

            console.log('Loading hair tip...');
            try {
                await loadHairTip();
                console.log(' Hair tip loaded');
            } catch (e) {
                console.error('Hair tip load failed:', e);
            }

            console.log('Loading upcoming appointments...');
            try {
                await loadUpcomingAppointment();
                console.log(' Upcoming appointments loaded');
            } catch (e) {
                console.error('Upcoming appointments load failed:', e);
            }

            // Initialize cart from localStorage (cart is already loaded at declaration)
            // Just update the display
            updateCartCount();

            // Check for admin-triggered notifications after a short delay
            setTimeout(() => {
                checkForNotifications();
            }, 2000);

            console.log('Flirt Hair & Beauty App initialized');
            if (cart.length > 0) {
                console.log(`Cart restored with ${cart.length} item(s)`);
            }

            // Initialize time window selector
            initTimeWindowSelector();
        }

        // Initialize time window selector chips
        function initTimeWindowSelector() {
            const chips = document.querySelectorAll('.time-window-chip');
            const hiddenInput = document.getElementById('requestedTimeWindow');

            chips.forEach(chip => {
                chip.addEventListener('click', function() {
                    // Remove selected from all chips
                    chips.forEach(c => c.classList.remove('selected'));
                    // Add selected to clicked chip
                    this.classList.add('selected');
                    // Update hidden input
                    hiddenInput.value = this.dataset.window;
                });
            });
        }

        // Run on page load
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

</body>
</html>
